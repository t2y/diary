---
title: "集中のち寝不足"
date: "2023-02-06T09:21:43+09:00"
dates: [2023/02]
cover: ""
tags: [gitlab, ci/cd, go]
showFullContent: true
---

1時に帰ってきてそのまま寝ないで6時10分の新幹線に乗ってから2時間半ほど寝た。これはこれで時間の使い方が有意義な気がする。午前中は翌日の定例会議の準備を着々と進めて、ci/cd 環境の改善、午後からリファクタリングなどをやっていた。15時をまわると眠くなってきて散歩したりして気分転換しつつも体調悪いなと思って17時半にお仕事を終えてホテルへ戻って2-3時間ほど寝てた。その後、晩ご飯食べるかなと出掛けたものの、あまり食欲もなくて、2時間ほど付近を散歩して運動していた。たまにはそういうのもいいか。飲食店が多い地域なので外から眺めているだけでもわりと楽しい。

## ssh 経由のデプロイ

これまで ci/cd でテストして docker イメージをビルドしてコンテナレジストリに登録するところまでやっていた。実際にテスト環境にデプロイするときは、テスト環境にログインして更新用のスクリプトを私が手動実行していた。そんなに頻繁にテスト環境を更新する必要がなかったのでそれでも十分ではあるものの、ci/cd の完成形を目指すなら自動化すべきという考え方もあってデプロイの部分を作ることにした。

もっとも簡単な方法として [Using SSH keys with GitLab CI/CD](https://docs.gitlab.com/ee/ci/ssh_keys/) をみながら、ssh でテスト環境にデプロイすることにした。すでに更新用のスクリプトがあって、テスト環境にログインして実行すればできる状態なので ssh さえ使えればすぐに移行できるという話しでもある。openssh-client を使うためにベースイメージを alpine から ubuntu にしてパッケージをインストールしないといけない。実行時間がややかかるというコスト以外には気にならないかな。ssh の秘密鍵を `file` 種別でもつのか通常の環境変数でもつのかで扱いが異なって、それに少しはまったぐらいですぐできた。今後は docker イメージのビルド単位に自動的にデプロイされるようになる。

## interface{} の型エイリアスとしての any

go のコードをリファクタリングしていて json.Marshal の引数が `any` となっていることに気付いた。

```go
func Marshal(v any) ([]byte, error) {
    ...
}
```

go 1.18 以降で `interface{}` の型エイリアスとして `any` が定義されているらしい。任意の型を扱えるシグネチャとして、メソッドの振る舞いのみを規定する `interface{}` を使うというのは型システムとしては正しい。他言語でいえば object に相当するものが go はオブジェクト指向言語ではないのでそれがない。そういう間違っていないけど、わかりにくいなと思っていたものに `any` という名前の型エイリアスが導入されてとてもしっくりきた。プログラミングしていて、実務的にどうかというところをちゃんと改善していくところがみえるのは楽しい。

```go
type any = interface{}
```

* [Go 1.18 で interface{} の代わりに any が使えるようになる話](https://zenn.dev/syumai/articles/c6q5un1j0msim0aj0ca0)
