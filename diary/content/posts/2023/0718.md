---
title: "1行のミスによる1行の修正"
date: "2023-07-18T08:18:51+09:00"
dates: [2023/07]
cover: ""
tags: [operation, debug]
showFullContent: true
---

0時に寝て何度か起きて6時半に起きた。朝から外はめっちゃ暑い。冷房をつけっぱなしのオフィスも朝からやっぱり暑い。根本的な空調の問題。

## agent アプリケーションのメモリリーク正体

[先週のメモリリーク調査]({{< ref "posts/2023/0714.md#agent-アプリケーションのメモリリーク調査" >}}) の続き。本当は週末にやればよかったんだけど、遊んでたりさぼってたりして放置してた。先週時点でリークしているのは [go-zeromq/zmq4](https://github.com/go-zeromq/zmq4) 側だというのはわかっていたが、何が原因でリークしているのかは分からなかった。一通りソースも読んでみたけど、いまひとつよく分からない。仕方ないから動的デバッグでソースコードに手を入れながら調査していて、すぐにみつけた。socket 構造体が保持しているコネクションの map がどんどん肥大化していく。なにも使っていない map にコネクションの値を保持して解放する処理がないことに気付いた。

```go
sck.ids[uuid] = c
```

修正するかと思ってリポジトリの最新ブランチをみてもそのコードが見当たらない。すると次の pr で4月に修正されていた。まだリリースされていないからうちらのアプリケーションで使っているリビジョンにはその修正が含まれていなかった。

* [Deal with empty Identity for ROUTER socket #140](https://github.com/go-zeromq/zmq4/pull/140)

> Additionally, remove sck.ids, which is unused and leaks \*Conn.

メモリリークの調査を始めたときに github issues/pr を leak で検索して一通りチェックしているので、先週もこの pr をみかけているはずだが見逃してしまった。タイトルが全然違うし、ほんの1行の typo に近いミスなので修正内容をみて気付かなかったのだと思う。自分の観察力の無さに気付いた。leak で検索ヒットしているのだから、それが自分たちのアプリケーションで使っているコードに入っているのかどうか、その内容をもっと注意して調べるべきだった。そうすればこの調査時間を数時間は短縮できた。これは私のミスだと認めて `Postmortem` のラベルを付けた。次回の定例会議でふりかえりに使う。
