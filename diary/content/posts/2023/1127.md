---
title: "sveltekit/vite アプリケーションの調査を再開"
date: "2023-11-27T18:50:24+09:00"
dates: [2023/11]
cover: ""
tags: [svelte, vite, debug, founding, tax]
showFullContent: true
---

1時に寝て起きたか起きてないか覚えてない感じで6時に起きた。起きてちょっとゲームして気付いたら7時だった。

## kit/vite アプリケーションのデバッグ

[先週公開したテックブログ]({{< ref "posts/2023/1124.md#テックブログ公開" >}}) の続き。

[vite アプリケーションのバックエンドインテグレーション](https://ja.vitejs.dev/guide/backend-integration.html) の詳細を調査している。丸1日デバッグしていていくつか振る舞いがわかってきて、designer アプリケーションを作りたいという要件に対して、こうすればできるんじゃないかという仮説も立てられるようになった。いまやりたい要件は kit の ssr アプリケーションを埋め込みたい。これは要件に満たないが、kit の ssg アプリケーションならば static ディレクトリに置くだけで参照できるし、インポートパスさえ書き換えてやれば別の kit アプリに埋め込むこともできるのを確認した。意図した通りの振る舞い。

vite アプリケーションはビルドオプションで manifest.json を出力し、エントリーポイントやどのファイルがどのファイルをインポートしているかといった情報を管理している。sveltekit はこれらの manifest.json から rollup でバンドルするために manifest.js を生成している。厳密には、sveltekit では production ビルド向けのチューニングをしたビルドツールを [adapter](https://kit.svelte.dev/docs/adapters) と呼び、vite のビルドをフックする場所に1つになっている。node.js サーバー向けに production ビルドするときは [adapter-node](https://kit.svelte.dev/docs/adapter-node) を使う。この実装を読んでみると、vite がビルドした成果物に対して、再度 rollup でバンドルして成果物を作り直すといったことをしている。そして、vite の成果物 (manifest.json も含む) を抽象化したものが [Builder](https://kit.svelte.dev/docs/types#public-types-builder) となる。adapter は Builder のインスタンスを使ってビルドの成果物を制御できる。先の manifest.js もこのときに生成していて、rollup でバンドルするためのパラメーターの1つとして使っているようにみえる。しかし、rollup のドキュメントをみても直接的に manifest.js の説明はなく、rollup の拡張の仕組みで manifest.js を作っているというよりは、sveltekit の要件によるもののようにもみえる。ここの背景はまだよくわからない。

私はフロントエンドのことが全然わからないのでライブラリのソースコードを読みながら、ドキュメントとあわせて調べて、1つずつ理解を深めていくというアプローチで進めている。こういった調査のやり方もメンバーへ伝えていければと考えている。

## 小規模企業共済オンライン手続きポータル

[2021年度から小規模企業共済]({{< ref "posts/2022/0206.md#2021年度の個人の確定申告" >}}) に加入している。今年から掛け金を7万円/月に変更した。年間で84万円の所得控除となる。ちょうど2023年9月1日からポータルサイトが作成されたらしい。いずれマイナポータルと紐付くのかもしれない。

* [「オンライン手続きポータル」を公開しました](https://www.smrj.go.jp/org/info/press/2023/ool3bn000000kxx5-att/20230901_press01.pdf)

利用登録しようと思って、メールアドレスを登録しようとしたら会社のメールアドレスはなぜかバリデーションエラーになって gmail のアドレスなら登録できた。その後も氏名の半角カナ入力を強制されたりしながら、マイナンバーカードを読み取って認証チェックして利用登録の申請はできた。しかし、自動で本登録されるわけではなく、おそらく申請内容が先方に届いてなんらかの運用があって本登録されるみたい。オンラインポータルのホームでも半角カナを使っていたり、`<title>` タグには「マイナ手続きポータル」とあったり、申請しただけでいくつも不備がわかるようなひどいサイトになっている。2023年にまともな開発者が作ったサイトとは思えない。デジタル庁に作り直してもらった方がよいと思う。

* [小規模企業共済ｵﾝﾗｲﾝ手続きﾎﾟｰﾀﾙ](https://portal.e-shishobako.ne.jp/dp_apl/pw-usr/#/portal/landing?riyoCd=RGO0226000)
