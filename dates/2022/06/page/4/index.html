<!doctype html><html lang=en><head><title>2022/06 :: forest nook</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/dates/2022/06/><link rel=stylesheet href=/diary/assets/style.css><link rel=stylesheet href=/diary/assets/green.css><link rel=stylesheet href=/diary/style.css><link rel=apple-touch-icon href=/diary/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="2022/06"><meta property="og:description" content><meta property="og:url" content="/diary/dates/2022/06/"><meta property="og:site_name" content="forest nook"><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><link href=/diary/dates/2022/06/index.xml rel=alternate type=application/rss+xml title="forest nook"></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><div class=posts><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0628/>設計のリファクタリング</a></h1><div class=post-meta><span class=post-date>2022-06-28</span></div><span class=post-tags>#<a href=/diary/tags/java/>java</a>&nbsp;</span><div class=post-content><p>23時に寝て4時に起きた。その後もだらだらしていて変な寝方した。</p><h2 id=型定義のリファクタリング>型定義のリファクタリング</h2><p>開発が佳境でサービスイン前なのと機能開発は完了しているのでリスクのある作業やリファクタリングなどを主にやっている。別の開発者が作った機能の型定義が曖昧なところをまとめてリファクタリングしていた。若い開発者だから仕方ないことだけど、ジェネリクスとポリモーフィズムを正しく理解できていない。effective java で言うところの抽象骨格実装という設計手法になる。あと ide のリファクタリング機能を使ってコードを書いているのか？public な api の設計がおかしかった。人間が考えてメソッド分割したようには思えない oop らしからぬ手続き的な api になっていた。後から oop としてジェネリックな型定義に落とし込むのがなかなか難しくて丸1日ぐらいやってた。私がドメイン知識をもっていないのもある。以前にもそのコードの pr をレビューしていてよくないコードだとはわかっていたけど、私はドメイン知識がないためにやりたいことがわからないから最低限の品質でマージした後に私がリファクタリングすればいいかと考えていた。若い開発者にプログラミングの設計やコーディングを教えるのは時間を要するのでお手伝いという立場だとなかなか難しい。だから私が直してしまえばいいやというノリで勝手に直した。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0627/>openapi generator の設定</a></h1><div class=post-meta><span class=post-date>2022-06-27</span></div><span class=post-tags>#<a href=/diary/tags/java/>java</a>&nbsp;
#<a href=/diary/tags/openapi/>openapi</a>&nbsp;</span><div class=post-content><p>3時に寝て6時半に起きた。昨日は夕方に昼寝したので夜は眠れなかった。</p><h2 id=openapi-generator-の-x-implements-機能>openapi generator の x-implements 機能</h2><p>外部ベンダーの api client の wrapper を実装していて、api client が扱うリクエストやレスポンスを型 (インターフェース) で抽象化できるとよさそうと思って openapi generator の設定を調べていた。maven-plugin の設定と openapi-generator の設定の2つがあるので両方のドキュメントを確認しないといけない。</p><ul><li><a href=https://github.com/OpenAPITools/openapi-generator/tree/master/modules/openapi-generator-maven-plugin>https://github.com/OpenAPITools/openapi-generator/tree/master/modules/openapi-generator-maven-plugin</a></li><li><a href=https://openapi-generator.tech/docs/generators/java/>https://openapi-generator.tech/docs/generators/java/</a></li></ul><p>そんなに都合よくインターフェースを指定できるような仕組みがなければ、最悪は <a href=https://mustache.github.io/>mustache</a> テンプレートをカスタマイズするしかないかなぁとか考えていた。テンプレートを操作すると、今後の保守コストが上がってしまうのでそのメリット・デメリットを比較して考えないといけない。諦めかけていたときに so でこの issue をみつけた。</p><ul><li><a href=https://github.com/OpenAPITools/openapi-generator/issues/11636>Feature x-implements is not supported #11636</a></li></ul><p>ちょうどこの5月末にリリースされたばかりの 6.0.0 に <code>x-implements</code> と指定すれば、任意のインターフェースを implements できる機能が追加された。これはスキーマに対する設定なのでテンプレートをカスタマイズするよりずっと保守コストは小さくて済む。</p><p>例えば、openapi schema の json で設定すると、コード生成したときにそんな風にインターフェースが付く。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>       &#34;SomethingApiResponse&#34;: {
</span></span><span style=display:flex><span><span style=color:#a6e22e>+        &#34;x-implements&#34;: &#34;com.example.app.MyResponse&#34;,
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>         &#34;title&#34;: &#34;SomethingApiResponse&#34;,
</span></span><span style=display:flex><span>         &#34;type&#34;: &#34;object&#34;,
</span></span><span style=display:flex><span>         &#34;properties&#34;: {
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span><span style=color:#f92672>-public class SomethingApiResponse {
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+public class SomethingApiResponse implements com.example.app.MyResponse {
</span></span></span></code></pre></div><p>あまりにも意図していた機能をみつけて嬉しくてツィートしてしまった。</p><blockquote class=twitter-tweet><p lang=ja dir=ltr>openapi generator で生成するコードに任意の interface を指定するのはテンプレートをカスタマイズするしかないかなぁと思っていたら、最新の 6.0.0 でスキーマ定義に x-implements で指定できるようになっている。これはすごい。<a href=https://t.co/bT0fQxSrGz>https://t.co/bT0fQxSrGz</a></p>&mdash; Tetsuya Morimoto (@t2y) <a href="https://twitter.com/t2y/status/1541238905953226753?ref_src=twsrc%5Etfw">June 27, 2022</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0626/>法人税の修正申告</a></h1><div class=post-meta><span class=post-date>2022-06-26</span></div><span class=post-tags>#<a href=/diary/tags/tax/>tax</a>&nbsp;
#<a href=/diary/tags/founding/>founding</a>&nbsp;</span><div class=post-content><p>1時に寝て7時に起きた。</p><h2 id=源泉所得税の納付>源泉所得税の納付</h2><p>ちょうど給料日を過ぎたので所得税徴収高計算書 (納期特例分) の申請を行った。これまでも e-tax で電子申請して振り込みしていたのだけれど、e-tax ソフト (web版) でブラウザから申請していた。今回は windows マシンにインストールされている e-tax ソフトから申請してみることにした。e-tax ソフトは起動時に「追加インストール」という機能があって、申請に必要なモジュールのみをダウンロードしてインストールできるようになっている。20年前で言うところの saas はこうだった。「源泉所得税関係」というモジュールをインストールしないと、所得税徴収高計算書の申請ができない (e-tax ソフトに帳票がインストールされない) 。モジュールを追加インストールすれば、「源泉所得税」という税目から「所得税徴収高計算書 (納期特例分) 」という帳票を選択して、あとは数字を記入して送信するだけ。この申請に電子署名は不要。</p><figure><img src=/diary/img/2022/0626_e-tax.png></figure><h2 id=法人税の修正申告と欠損金の繰り戻し還付の訂正依頼>法人税の修正申告と欠損金の繰り戻し還付の訂正依頼</h2><p><a href=/diary/posts/2022/0620/#欠損金の繰り戻し還付の申請の誤り>国税局の職員さんからの指摘</a> で提出した書類が誤っていることに気付いた。いくつか訂正箇所を書いておく。</p><ul><li>欠損金額とは<ul><li>正: 税引き後の欠損金額 = 別表1の1の数字をそのまま使えばよい</li><li>誤: 税引き前の所得 (税務上は負の所得を欠損金と呼ぶ) を使っていた</li></ul></li><li>法人税と地方法人税の計算は別<ul><li>欠損金の繰り戻し還付の申請は法人税のみの還付金を算出</li><li>↑で求めた還付金に対して(令和元年以降は)10.3%を地方法人税の還付金とする<ul><li>この手続きは不要で別表一に算出した数字を記載すればよい</li></ul></li></ul></li></ul><p>まずこの申請書の誤りを修正して訂正依頼とする。</p><p>さらにこの欠損金の繰り戻し還付の申請の数字を別表1に記載しなければならない。それらが漏れているのと還付申請のためには別表七も提出しないといけない。あと細かい数字の記入漏れの指摘もあった。法人税の確定申告に対して次の5つの書類を修正申告として提出する。</p><ul><li>別表一</li><li>別表一 次葉</li><li>別表四</li><li>別表五 (一)</li><li>別表七 (一)</li></ul><p>税務署の職員さんが訂正する数字を書いてくれていたので、それをみながら e-tax ソフトで数字を修正して紙に印刷してそれを再提出する。おかげで赤字のときの別表書類の書き方もわかった。大半は欠損金の繰り返し還付に関する数字の記入漏れなので今後も赤字の年度があったときにこの内容を踏襲しながら申告すればよい。また1つ行政手続きのノウハウを得ることができた。税務署の職員さんに感謝。</p><h2 id=企業サイトの更新>企業サイトの更新</h2><p>企業サイトを作成してから3年近く経つのでそろそろ初期の頃に書いた内容が現状とあわなくなってきた。あちこち現状とあっていない内容を更新した。本当はデザインを刷新したいと思っている。デザイン刷新のためのチケットを作ったのが2021年7月28日 20:04なのでもうすぐ1年経とうとしている。どんどん時間が過ぎるな。今日のところは、主には <a href=https://kazamori.jp/about/>企業情報</a> の構成を作り直した。それと同時に過去に働いていた会社での業務外発表を除去した。今後は自社の発表のみを掲載する。これには会社としてマーケティング活動をやっていくという意気込みと過去との決別の意味合いもある。トップページに news を5件表示しているところがビルドするタイミングによってそうならないときがあって、実行タイミングによってページングがされたりされなかったりする現象に悩まされている。ワークアラウンドとしては、何回かビルドをやり直せばページングされるときもあるのでそれを待つみたいな、どうしようもないやり方でこの場は凌いでいる。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0625/>k8s のアップグレードをやってみた</a></h1><div class=post-meta><span class=post-date>2022-06-25</span></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/kubernetes/>kubernetes</a>&nbsp;
#<a href=/diary/tags/event/>event</a>&nbsp;</span><div class=post-content><p>0時に寝て6時半に起きた。起きてから1時間ほどだらだらしてた。</p><h2 id=ストレッチ>ストレッチ</h2><p>今日の開脚幅は開始前161cmで、ストレッチ後163cmだった。先週と同じなので現状維持とも言えるし、よい状態を維持しているとも言えるかもしれない。もう1年以上通っているせいか、なにかポイントが溜まっていて使わないといけないという話しで今日は20分延長でやってくれた。とは言っても、基本的なストレッチ項目が変わるわけではなく、いつもより伸ばす時間や手順が少し増えているぐらいだった気がする。今週はとくに腰の負荷もあまり感じなかったせいか、いつもの右腰の張りもなかったように思う。トレーナーさんに聞くと、暑くなると筋肉は伸びやすくなるので季節要因でストレッチをしたときの伸び具合が変わるのは普通とのこと。調子がよくなってきたのでこのまま好調を維持したい。</p><h2 id=eks-k8s-のアップグレード>eks (k8s) のアップグレード</h2><p>お手伝い先のお仕事がもうすぐサービスインなのでそれまでにリスクのある作業をやっとこうみたいな状況にある。たまたま eks (k8s) のバージョンを 1.21 から 1.22 にあげようと思い立って、木曜日に提案したら、どんな障害が起きるかわからないので他メンバーがテスト環境を使っていない時間帯で作業した方がよいだろうという話になって土日にやることにした。</p><ul><li><a href=https://docs.aws.amazon.com/eks/latest/userguide/update-cluster.html>Updating an Amazon EKS cluster Kubernetes version</a></li></ul><p>何が起きるか分からなくても、土曜日から始めて致命的なトラブルに見舞われても1日もあれば解決できるだろうという見通しで作業を始めた。その見通しも「私がやれば」という前提に成り立っている。良くも悪くも私がやろうと言ったことに反対されることはほとんどないが、それは私が言ったことは一定時間に私がすべてやり切るという信頼に基づいている。本当の意味でできるかどうか分からないことを必要以上に抱え込んでしまうときもあるのでバランス感覚は必要かもしれない。言わばサービス休日出勤だし、なぜ私がやっているかと言うと、システムの運用や保守の展望を考えたら、サービスインの前にインフラのバージョンを上げておく方が将来の保守コストを下げることに繋がるという1点のみに重要性を見い出していて、それをもっとも強く主張しているのが私だからという理由。</p><p>結論から言って2時間でアップグレード作業を完了した。1つ手順漏れがあって、アプリケーションの pod がすべてエラーになるというトラブルに見舞われたものの、すぐ手順漏れに気付いて難なく復旧できた。今日はテスト環境のアップグレードをしたわけだけど、また後日、本番向けの作業手順書を作れば、ほぼタウンタイムなしで1時間もあればアップグレード作業を完了できそうな見通しではある。</p><p>実際はミスもあったので次の順番でやったわけではないが、おそらくこの手順でやれば正しいはず。</p><ol><li>aws cli と eksctl コマンドのインストール</li><li>aws のアップグレードドキュメンを読む</li><li>cert-manager のアップグレード (1.1.1 から 1.5.4)</li><li>aws-load-balancer-controller のアップグレード (2.2.0 から 2.4.2)</li><li>k8s control plane のアップグレード (1.21 から 1.22)</li><li>(オプション: 不要) autoscaler のアップグレード</li><li>(オプション: 不要) gpu サポートノードのアップグレード</li><li>vpc cni プラグインのアップグレード (1.7.5 から 1.11.2)</li><li>coredns プラグインのアップグレード (1.8.4 から 1.8.7)</li><li>kube-proxy のアップグレード (1.21.2 から 1.22.6)</li><li>k8s nodegroup のアップグレード (1.21 から 1.22)<ul><li>k8s ノードが存在する nodegroup をアップグレードするとそのインスタンスが再作成されて pod が再デプロイされる</li></ul></li></ol><p>細かい手順は aws のドキュメントの指示に従いながらやったらできた。add-on と self-managed add-on の種別の違いがあったり、helm と k8s manifest の手順が別々だったり、どのバージョンからのアップグレードかで作業手順が異なったりと、ドキュメントをちゃんと読まないと正しい作業手順がわからない。基本的にはドキュメント通りの作業で完了できた。</p><h2 id=もくもく会>もくもく会</h2><p>アップグレード作業を終えてから1時間ほど残っていたので16時から <a href=https://kobe-sannomiya-dev.connpass.com/event/251117/>【三宮.dev ＆ KELab 共催】もくもく会</a> に参加した。今回は <a href=https://kobe-engr-lab.studio.site/>Kobe Engineers Lab</a> さんと共催ということで <a href=https://120workplace.jp/>120 WORKPLACE KOBE</a> で開催された。Kobe Engineers Lab の主催者の会社が 120 workplace でオフィスを借りているため、会議室を5時間/月まで無料で借りられるという。私も過去に何度か 120 workplace のコワーキングスペースで作業したこともあった。久しぶりに行ってよい場所だとは思う。会議室は初めて入ったけど、10人ぐらいは余裕で作業できる大きなテーブルがあって広くてよかった。終わってからわたなべさんと3時間ほど立ち呑みしてた。</p><h2 id=はんなりビジネス>はんなりビジネス</h2><p>21時から <a href=https://hannari-python.connpass.com/event/250916/>はんなりビジネス #0</a> に参加した。おがわさんがまた新しいことやるんだなと思って興味本位で参加してみた。現実の課題に対してコミュニティの有志を募ってチームで取り組んでみたら、問題解決能力も身についてプログラミングの知識を活かしてより実践的なスキルが身に着いてよいのではないかといったところから始まった企画らしい。今日は初回だったので参加者でどういう取り組みがよいのかを雑談してた。まだまだこの先どうなるかわからないけど、私はあまりこの手の取り組みには懐疑的かなぁ。自分たちにとってちょうどよい課題レベルの対象をみつけるのは難しいし、誰でも参加できるオープンなビジネスコンテストやアイディアソンが本当に大事な問題を扱っているかも怪しい。現実の課題はお仕事でいくらでもあるので、それをコミュニティでやろうと思うとニッチな何かになるか、価値があるかどうかよりも本人がやりたいかどうかの目的になってしまうような気もする。とはいえ、私自身、ビジネス力はまったくないのでなにかしらやっているうちに価値に気付くこともあるかもしれない。もうしばらく様子をみてみる。</p><ul><li><a href=https://chomoku.notion.site/6872dcf2ba8d4f6887cb16f71879f4ca>https://chomoku.notion.site/6872dcf2ba8d4f6887cb16f71879f4ca</a></li></ul></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0624/>余白談義</a></h1><div class=post-meta><span class=post-date>2022-06-24</span></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/founding/>founding</a>&nbsp;
#<a href=/diary/tags/issue-tracking-system/>issue tracking system</a>&nbsp;</span><div class=post-content><p>0時に寝て6時に起きた。だいぶ復調してきて朝起きれるようになってきた。</p><h2 id=歯科検診>歯科検診</h2><p>3ヶ月ごとの定期検診。<a href=posts/2022/0325.md#%E6%AD%AF%E7%A7%91%E6%A4%9C%E8%A8%BA>前回</a> は2年ぶりにレントゲンをとったので新しい歯のレントゲン写真をみせていただいた。とくに変わりなく、親知らずにゴミが溜まるスポットがあるから、親知らずを抜いた方がいいのはいいけど、下側の親知らずを抜くのは大変だから痛くなってからでもよいかも？みたいな話しをした。いま3ヶ月ごとに定期検診して親知らずのゴミスポットの掃除をしてもらっているからそれでもしかしたら大丈夫なのかもしれない。あと1箇所だけ銀の詰めものと歯が精密に一致していないところがあって、その隙間にゴミが溜まりやすいとのこと。急がなくてもよいけど、いずれ付け直した方がよいらしい。</p><h2 id=隔週の雑談>隔週の雑談</h2><p>顧問のはらさんと隔週の打ち合わせ。今日の議題は次の3つ。</p><ul><li>お手伝い先の契約更新についての話題</li><li>カフーツさんとワーケーションの話題</li><li>jjug ccc 2022 spring ふりかえり</li></ul><p><a href=/diary/posts/2022/0618/#カフーツさん訪問>先日の記事</a> でも「余白」という概念が個人的にはまったのであちこちで余白談義をしている。デザインで言うところの余白とは何かをはらさんに聞いてみたところ、次のようなものだという。</p><ul><li>空白というコンテンツである</li><li>他に使ってはいけない領域である</li></ul><p>開発における余裕とかゆとりのことを余白と言ってしまうと、デザインの文脈とは一致しないという話しになった。ワーケーションの文脈では予定調和じゃない時間を指すといとうさんは仰っていた。何かをやるための計画を立てた時間ではない。何もしなくてもよいし、思いつきで何かをしてもよい。先日の記事で、課題管理の文脈でメタ課題の抽出や他人のチケットにコメントしたりするのも余白の1つではないかと私が書いたのはその行動が必須というわけではない。誰かから指示されてやっているわけでもないという行動が、ワーケーションにおける予定調和じゃない行動と共通点があるのではないかと考えたから。</p><p>私が開発における余白を余裕やゆとりのように解釈して発言したので余っているものというニュアンスになってしまったけど、その時間は余っているものではなく、明示的に明けておくべき時間のように捉えたらデザインの文脈で言う余白にも近い概念になるかもしれない。開発だと想定外の追加作業や要件漏れなどのために確保しておく時間をバッファと呼んだりもする。例えば、開発の作業時間を1日8時間、1週間(5日間)で40時間と見積もるから余白がなくなってしまうであって、仮に1週間の余白を3時間と先に確保してしまって、37時間を開発の作業時間としてしまえば余白がなくなるということない。その余白時間に業務に関係ない勉強会をやってもいいし、自分の調べたいことに費やしてもいいかもしれない。私が金曜日を非稼働日として業務委託の作業をやらずに雑談していることにも通じる。</p><p>その後、余白談義からスクラムの課題や展望の話しなどにも発散して盛り上がった。スクラムには余白がないから。まだまだ私自身、余白の言語化に曖昧なところがあるので今後も意識しながら概念や価値を言語化していくように努めたい。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0623/>assertj を使ってみた</a></h1><div class=post-meta><span class=post-date>2022-06-23</span></div><span class=post-tags>#<a href=/diary/tags/java/>java</a>&nbsp;
#<a href=/diary/tags/testing/>testing</a>&nbsp;</span><div class=post-content><p>0時に寝て6時に起きた。</p><h2 id=assertdeepequals-を作った>assertDeepEquals を作った</h2><p><a href=https://assertj.github.io/doc/>AssertJ</a> というアサーションライブラリを使って <code>assertDeepEquals</code> を実装した。</p><p>junit4 では hamcrest という matcher が使われていて、それが <code>assertDeepEquals</code> 相当の機能を提供していたが、それが junit5 では提供されなくなったので自分で実装するか、アサーションライブラリを別途使う必要がある。</p><blockquote><p>現時点でJUnit5ではHamcrestのMatcherは提供せず、使用者が自由に選択する方針で進んでいます。そうなった場合、標準でサポートされるassertTrueやassertEquelsなどだけでは、ちょっと頼りなく車輪の再発明になりそうなので、候補になりそうなHamcrestとAssertJのよく使いそうなメソッド比較表を作りました。</p><p><a href=https://qiita.com/disc99/items/31fa7abb724f63602dc9>JUnitのアサーションライブラリHamcrest,AssertJ比較</a></p></blockquote><p><a href=https://junit.org/junit5/docs/snapshot/user-guide/#writing-tests-assertions-third-party>2.4.2. Third-party Assertion Libraries</a> によると、junit は基本的なアサーション機能を提供し、より強力なアサーションはサードパーティ製の好きなライブラリを使ってくれみたいなことが書いてある。軽く github でソースコード検索しても、みんな自前で作っているんやなということも分かる。</p><ul><li><a href="https://github.com/search?l=Java&q=assertDeepEquals&type=Code">https://github.com/search?l=Java&q=assertDeepEquals&type=Code</a></li></ul><p>hamcrest はもう保守されていないようにみえるので assertj を使うことにした。assertj の機能を使うと <code>assertDeepEquals</code> を次のように実装できる。直接 assertj を使ってもよいのだけど、assertXxx という名前で使えた方が junit ベースのテストのアサートの統合性があるし、いまお手伝い先では myapp-test のような、テスト向けの共通ライブラリを提供していて、すべてのプロジェクトで既に使っているので assertj の依存関係を追加しなくてもすぐに使えるというぐらいの利便性を提供するだけのユーティリティになる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Assertions</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>assertDeepEquals</span><span style=color:#f92672>(</span>Object expected<span style=color:#f92672>,</span> Object actual<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        assertThat<span style=color:#f92672>(</span>expected<span style=color:#f92672>).</span><span style=color:#a6e22e>usingRecursiveComparison</span><span style=color:#f92672>().</span><span style=color:#a6e22e>isEqualTo</span><span style=color:#f92672>(</span>actual<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>assertDeepEquals</span><span style=color:#f92672>(</span>Object expected<span style=color:#f92672>,</span> Object actual<span style=color:#f92672>,</span> String<span style=color:#f92672>...</span> fields<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        assertThat<span style=color:#f92672>(</span>expected<span style=color:#f92672>).</span><span style=color:#a6e22e>usingRecursiveComparison</span><span style=color:#f92672>().</span><span style=color:#a6e22e>comparingOnlyFields</span><span style=color:#f92672>(</span>fields<span style=color:#f92672>).</span><span style=color:#a6e22e>isEqualTo</span><span style=color:#f92672>(</span>actual<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>assertDeepEqualsIgnoringFields</span><span style=color:#f92672>(</span>Object expected<span style=color:#f92672>,</span> Object actual<span style=color:#f92672>,</span> String<span style=color:#f92672>...</span> fields<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        assertThat<span style=color:#f92672>(</span>expected<span style=color:#f92672>).</span><span style=color:#a6e22e>usingRecursiveComparison</span><span style=color:#f92672>().</span><span style=color:#a6e22e>ignoringFields</span><span style=color:#f92672>(</span>fields<span style=color:#f92672>).</span><span style=color:#a6e22e>isEqualTo</span><span style=color:#f92672>(</span>actual<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0622/>k8s の cronjob を検証中</a></h1><div class=post-meta><span class=post-date>2022-06-22</span></div><span class=post-tags>#<a href=/diary/tags/kubernetes/>kubernetes</a>&nbsp;
#<a href=/diary/tags/cli/>cli</a>&nbsp;</span><div class=post-content><p>0時に寝て6時に起きた。寝不足を解消して体調が戻ってきた。</p><h2 id=k8s-の-cronjob>k8s の cronjob</h2><p>バッチ処理を <a href=https://kubernetes.io/docs/concepts/workloads/controllers/cron-jobs/>Kubernetes: CronJob</a> で作る。一通り設定して minikube で検証して eks 上でも動くようになった。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>batch/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>CronJob</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>my-app-hourly-job</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>schedule</span>: <span style=color:#e6db74>&#34;5 */1 * * *&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>concurrencyPolicy</span>: <span style=color:#ae81ff>Forbid</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>startingDeadlineSeconds</span>: <span style=color:#ae81ff>600</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>jobTemplate</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>backoffLimit</span>: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>app</span>: <span style=color:#ae81ff>my-app-hourly</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>annotations</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>dapr.io/enabled</span>: <span style=color:#e6db74>&#34;true&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>dapr.io/app-id</span>: <span style=color:#e6db74>&#34;my-app-hourly&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>          - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>my-app-hourly-job</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>image</span>: <span style=color:#ae81ff>my-app-image</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>imagePullPolicy</span>: <span style=color:#ae81ff>Always</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>env</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>BATCH_ENV</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#34;dev&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>command</span>:
</span></span><span style=display:flex><span>            - <span style=color:#e6db74>&#34;/bin/sh&#34;</span>
</span></span><span style=display:flex><span>            - <span style=color:#e6db74>&#34;/app/scripts/my-app.sh&#34;</span>
</span></span><span style=display:flex><span>            - <span style=color:#e6db74>&#34;param1&#34;</span>
</span></span><span style=display:flex><span>            - <span style=color:#e6db74>&#34;param2&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>restartPolicy</span>: <span style=color:#ae81ff>Never</span>
</span></span></code></pre></div><p>command の設定がわかりにくい。さらに k8s のドキュメントのサンプル設定も誤解を招くような例になっている。どうも実行できるのは1つの cli だけで、複数コマンドを指定できるわけではない。シェルスクリプトを docker イメージに含めて、そこで任意のスクリプトを実装した方がよいだろう。</p><ul><li>&ldquo;/bin/sh&rdquo;</li><li>&ldquo;/app/scripts/my-app.sh&rdquo;</li><li>&ldquo;param1&rdquo;</li><li>&ldquo;param2&rdquo;</li></ul><p>この設定は次の cli として実行される。</p><blockquote><p>/bin/sh /app/scripts/my-app.sh param1 param2</p></blockquote><p><a href=https://stackoverflow.com/questions/51657105/how-to-ensure-kubernetes-cronjob-does-not-restart-on-failure>How to ensure kubernetes cronjob does not restart on failure</a> によると、バッチ処理が失敗したときに再実行したくないときは次の3つの設定をする。</p><ul><li>concurrencyPolicy: Forbid</li><li>backoffLimit: 0</li><li>restartPolicy: Never</li></ul><p>restartPolicy が Never 以外だと、エラーが発生すると永遠に再実行されてしまうので障害時に2次被害を増やしてしまう懸念があったような気がする。</p><p>あと、うちの環境は dapr 経由で他の pod サービスと通信しているので dapr を有効にしないと pod 間通信ができない。dapr はデーモンでずっと起動しているからバッチ処理の終了時に daprd も shutdown してやらないといけない。<a href=https://docs.dapr.io/operations/hosting/kubernetes/kubernetes-job/>Running Dapr with a Kubernetes Job</a> にその方法が書いてある。daprd を shutdown しないと、pod のステータスが NotReady のままで Completed にならない。</p><p>まだまだよくわかってないので <a href=https://kubernetes.io/docs/concepts/workloads/controllers/job/>Jobs</a> のドキュメントに一通り目を通そうと思っている。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0621/>maven で executable jar を作る</a></h1><div class=post-meta><span class=post-date>2022-06-21</span></div><span class=post-tags>#<a href=/diary/tags/cli/>cli</a>&nbsp;
#<a href=/diary/tags/maven/>maven</a>&nbsp;
#<a href=/diary/tags/java/>java</a>&nbsp;</span><div class=post-content><p>4時に寝て7時に起きた。</p><h2 id=maven-での-executable-jar-の作り方>maven での executable jar の作り方</h2><p>gradle では作ったことがあったけど、maven では初めてなので要領がわかっていない。</p><ul><li><a href=https://www.baeldung.com/executable-jar-with-maven>How to Create an Executable JAR with Maven</a></li><li><a href=https://stackoverflow.com/questions/574594/how-can-i-create-an-executable-jar-with-dependencies-using-maven>How can I create an executable JAR with dependencies using Maven?</a></li></ul><p>これらの記事を読むと、<a href=https://maven.apache.org/plugins/maven-assembly-plugin/>maven-assembly-plugin</a> を使えばいいのかな？とまずはこのプラグインで検証を始めた。古くからあるプラグインなので実績は十分なのだけど、もうあまり保守されていないのか、他プラグインから jar のマニフェストに書き込んで git のリビジョン番号が連携できてなかったり、通常の jar の生成処理を置き換えられなかったりと、あまり使い勝手のよいものではなかった。あと log4j2 と相性が悪くて意図したように設定ファイルを読み込んで初期化ができない。</p><pre tabindex=0><code>main ERROR Error processing element EcsLayout: CLASS_NOT_FOUND
main ERROR Unable to locate plugin type for EcsLayout
main ERROR Unable to locate plugin for EcsLayout
main ERROR Could not create plugin of type class org.apache.logging.log4j.core.appender.ConsoleAppender for element Console:
  java.lang.NullPointerException: Cannot invoke &#34;org.apache.logging.log4j.core.config.plugins.util.PluginType.getElementName()&#34;
  because &#34;childType&#34; is null java.lang.NullPointerException:
    Cannot invoke &#34;org.apache.logging.log4j.core.config.plugins.util.PluginType.getElementName()&#34; because &#34;childType&#34; is null
</code></pre><p>この厄介な問題をデバッグするよりも、すでにうまくいくことがわかっている <a href=https://docs.spring.io/spring-boot/docs/current/maven-plugin/reference/htmlsingle/>spring-boot-maven-plugin</a> を使った方が簡単そうだったのでそうすることにした。不要な spring boot 関連の jar なども executable jar や docker イメージに含まれてしまうことだけがデメリット。そこだけ目を瞑れば log4j2 の初期化エラーも起きず、正常に動作した。やっぱり最近のアプリケーションで使われているプラグインはちゃんとしてるねみたいな話しにしておく。次の設定だけでうまくいった。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;plugin&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>spring-boot-maven-plugin<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;configuration&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;mainClass&gt;</span>com.example.myapp.Main<span style=color:#f92672>&lt;/mainClass&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/configuration&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;executions&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;execution&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;goals&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;goal&gt;</span>repackage<span style=color:#f92672>&lt;/goal&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;/goals&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;/execution&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/executions&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/plugin&gt;</span>
</span></span></code></pre></div></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0620/>log4j2 の設定ファイルの動的な読み込み</a></h1><div class=post-meta><span class=post-date>2022-06-20</span></div><span class=post-tags>#<a href=/diary/tags/java/>java</a>&nbsp;
#<a href=/diary/tags/cli/>cli</a>&nbsp;
#<a href=/diary/tags/logging/>logging</a>&nbsp;
#<a href=/diary/tags/tax/>tax</a>&nbsp;</span><div class=post-content><p>0時に寝て7時に起きた。</p><h2 id=バッチ処理モジュール>バッチ処理モジュール</h2><p>cli でバッチ処理モジュールを作った。コマンドラインの引数パーサーと yml のパーサーを使うことにした。</p><ul><li><a href=https://picocli.info/>picocli</a></li><li><a href=https://bitbucket.org/snakeyaml/>snakeyaml</a></li></ul><p>ロガー実装に <a href=https://logging.apache.org/log4j/2.x/>log4j2</a> を使っているので設定ファイルはアプリケーションの設定ファイルと log4j2 の設定ファイルの2つになる。それぞれ環境ごとに用意してエントリーポイントから起動したタイミングで明示的に設定ファイルを読み込むようにした。</p><p>log4j2 の yml 設定ファイルを動的にどうやって設定するかはドキュメントにもとくに書いてなかった気がする。log4j2 のソースコードやテストコードを読みながら次のようにしたら反映された。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> Config <span style=color:#a6e22e>load</span><span style=color:#f92672>(</span>BatchEnvironment env<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    var path <span style=color:#f92672>=</span> String<span style=color:#f92672>.</span><span style=color:#a6e22e>format</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;config-%s.yml&#34;</span><span style=color:#f92672>,</span> env<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    var inputStream <span style=color:#f92672>=</span> ConfigUtil<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getClassLoader</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getResourceAsStream</span><span style=color:#f92672>(</span>path<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    var yaml <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Yaml<span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> Constructor<span style=color:#f92672>(</span>Config<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> yaml<span style=color:#f92672>.</span><span style=color:#a6e22e>load</span><span style=color:#f92672>(</span>inputStream<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>アプリケーションの設定は yml 設定に対応する <code>Config</code> クラスを定義しておいて次のようにして読み込む。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>initializeLogSettings</span><span style=color:#f92672>(</span>BatchEnvironment env<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    var path <span style=color:#f92672>=</span> String<span style=color:#f92672>.</span><span style=color:#a6e22e>format</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;log4j2-%s.yml&#34;</span><span style=color:#f92672>,</span> env<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    var inputStream <span style=color:#f92672>=</span> ConfigUtil<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getClassLoader</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getResourceAsStream</span><span style=color:#f92672>(</span>path<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    var source <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ConfigurationSource<span style=color:#f92672>(</span>inputStream<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    var configuration <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> YamlConfigurationFactory<span style=color:#f92672>().</span><span style=color:#a6e22e>getConfiguration</span><span style=color:#f92672>(</span><span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> source<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    Configurator<span style=color:#f92672>.</span><span style=color:#a6e22e>initialize</span><span style=color:#f92672>(</span>configuration<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>ちょっとした cli を作るときにちょっとしたライブラリがあると楽でよい。</p><h2 id=欠損金の繰り戻し還付の申請の誤り>欠損金の繰り戻し還付の申請の誤り</h2><p>国税局から電話がかかってきた。初めて提出した欠損金の繰り戻し還付の申請があちこち間違ってますよと。申請書類と一緒に法人税の申告書もみてもらっていて、還付申請した金額も申告の別表1に記入する必要があって、それも一緒に修正してねという話し。法人税の修正申告と還付の訂正依頼の2つが必要とのこと。税務署の人たちは本当に丁寧で親切にあれが間違っている、これが間違っていると教えてくれる。素人が法人決算やっているので初めて行う手続きの間違いはつきものだけど、税務署の人たちが教えてくれるので本当に助かる。感謝。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0619/>jjug ccc 2022 spring 参加</a></h1><div class=post-meta><span class=post-date>2022-06-19</span></div><span class=post-tags>#<a href=/diary/tags/java/>java</a>&nbsp;
#<a href=/diary/tags/event/>event</a>&nbsp;</span><div class=post-content><p>1時に寝て7時に起きた。前日、お酒飲んでたくさん雑談したので疲れ果てて寝てた。</p><h2 id=jjug-ccc-2022-spring>jjug ccc 2022 spring</h2><p>私の発表は朝10:25からだったけれど、その1つ前が同僚の発表なので見とこうと思って9時前にはオフィスに着いてたと思う。twitter のハッシュタグを開いたり、スライド資料のツィートの文面を用意したり、発表者用のTシャツを着たりなど、いろいろ発表前にできそうな準備をしておいた。zoom と youtube live の両方で配信しているせいか、zoom でのやり取りと youtube live のチャット欄でのやり取りが混ざって、発表者も運営も混乱していたように思う。jjug のスタッフさんも当日にあれこれ指示を出していたりもして配信プラットフォームが複数になるとややこしいよなとか思いながら眺めてた。</p><p>Track C の発表を午前中いっぱい、私のも含めて3つみてたんだけど、おそらく関係者以外で発表を聴いている人はかなり少なかったのではないかと推測する。まず twitter のハッシュタグも youtube live のチャット欄もほとんど書き込みはなく、質問もないから jjug のスタッフさんが質問するという、予想していた通りの展開になった。同僚と私の発表はぽっと出の発表なので視聴者が少なくてもわかるんだけど、その後のてらだよしおさんの発表もクラスメソッドさんのレポートを書いている人しかコメントしてなかったように思う。</p><ul><li><a href=https://dev.classmethod.jp/articles/jjug-ccc-2022-spring-azure-container-apps/>【レポート】k8s 疲れの方へ送る、k8s ベースのらくらくマイクロサービス動作基盤のご紹介 #jjug_ccc #jjug_ccc_c</a></li></ul><p>オンラインイベントだからリアルタイムに視聴しないのか、日曜日または朝だから少ないのか、また機会があれば中の人にも聞いてみる。昨日の疲れもあって、会社ブログの記事を書いたら眠くなってきたので、午後から帰って寝てた。</p><ul><li><a href=https://kazamori.jp/blogs/2022/06/19/custom-github-actions-by-java/>Java で作るカスタム GitHub Actions</a></li></ul></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0618/>ワーケーションの定義を教えてもらった</a></h1><div class=post-meta><span class=post-date>2022-06-18</span></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/event/>event</a>&nbsp;
#<a href=/diary/tags/workcation/>workcation</a>&nbsp;
#<a href=/diary/tags/issue-tracking-system/>issue tracking system</a>&nbsp;</span><div class=post-content><p>0時に寝て7時に起きた。前日は移動による運動量が多かったせいか、なぜかよく眠れた。</p><h2 id=ストレッチ>ストレッチ</h2><p>今日は朝から調子よいなと思っていた通り、開脚幅は開始前161cmで、ストレッチ後163cmだった。ここ数週間は162cmが上限になっていたので久しぶりに163cmにになった。先週末に休息の時間を多めに取ったせいか、腰の張りもいつもよりは小さかったように思う。</p><h2 id=カフーツさん訪問>カフーツさん訪問</h2><p>ストレッチを終えてから神戸駅の近くのカフーツさんに行ってきた。<a href=/diary/posts/2021/1106/#神戸のコワーキングスペースの半歩先の未来を考える>コワーキングスペースのあるイベント</a> でみかけた縁で <a href=https://www.facebook.com/events/5230405317039250>ブログJelly Vol.120</a> に参加した。イベントの趣旨としてはブログを書いて、参加者に共有して、ブログの内容について参加者同士でコメントしあうといったもの。参加者は3人だったので必然的に濃いコミュニケーションになった。</p><p>私は、明日の jjug ccc 2022 の参加報告ブログの下書きを書いたものの、まだ公開はできないのでリポジトリにコミットした markdown を共有しつつ、既に公開済みのワーケーションの記事をイベントの参加者に共有してみた。いとうさんはワーケーションにも詳しい方なのでワーケーションの定義を間違えているよと教えてくれた。その間違いは私だけでなく、一般的 (日本？) にもよく誤解されているという。まず2泊3日のような短期の滞在をワーケーションとは呼ばない。</p><blockquote><p>日本の「ワーケーション」という言葉の使い方は間違ってて、冒頭、お書きのように、海外で言うところのワーケーションは1ヶ月〜3ヶ月、そこに滞在して地元に溶け込んで観光ではなくて「余白」を作って楽しむ、というものなんですよね。バケーションなので。会社員はムリですが（はっきり言いますけど）、デジタルノマドなリモートワーカーは自分の時間と仕事をコントロールできるので全然OKなわけで、なのでみんな会社員やめたらいいのにと思ってます。</p><p>ぼくらの解釈は「余白」はあらかじめなにも予定しない時間、ということです。行った先の成り行きでやることを決める、そのための余剰の時間ですね。だから普段やらないことをやってもいいし、本読んで内省してもいいし、ボ〜っと一日過ごしてもいいし。でも、行った先の地元の人たちとつながる、そこに余白を使うことが望ましいと思います。でもそれも出会い頭が面白いですね。</p></blockquote><p>ワーケーションについてなんやらかんやら雑談しているうちに、いとうさんもテンション上がってきて有料記事をプレゼントするからこれ読めってノリで記事を紹介していただいた。</p><ul><li><a href=https://note.com/kanzan10to9/n/nddd349a1a82c>106ヶ国からの入国許可と『絶対行くべき世界のコワーキング＆コリビングBEST20』が指し示すこれからのローカルコワーキング〜国内企業社員より海外のデジタルノマドにフォーカスしたコリビングのすすめ〜小さなコワーキングの作り方＃2</a></li></ul><p>いとうさんと <strong>「余白」</strong> という概念について議論していて、ずっと自分の中にあった言語化できていなかった概念とも紐付いた。本当によいキーワードを知ることができた。ワーケーション中にはらさんと話していたときに <a href=/diary/posts/2022/0604/#わたなべさん合流>時間をかければできるものじゃないことをやった方がいい</a> と感じことに言葉を割り当ててくれた。昔の開発と比べて、いまの開発は余裕やゆとりが全然ないと私は思っていて、開発者が自由に調査したり開発したりできなくなっているように感じている。それは「リーン」という概念が幅をきかせていて無駄を減らし、効率を上げることばかりを邁進した結果として「余白」もなくしてしまっているように思う。開発に限らず課題管理の文脈でも、メタ課題の抽出や分類・整理も、他人のチケットにコメントをすることも「余白」の1つと言えるかもしれない。</p><p>13時に訪問して、ブログを書き終わったのが15時過ぎで、それから17時過ぎまで適当に作業をやって、その後ビールを飲みながら3人で雑談していて、気付いたら23時20分になっていた。基本的に私は人見知りなので初対面の人たちとそんな長く話すこととかないんだけど、なぜか意気投合していろんな雑談をしていた。コワーキングやワーケーションという分野と課題管理の分野は交錯する点や共通点がいくつかあって、私が課題管理の文脈からこうじゃないか？と言うと、異なる視点からいとうさんが答えるみたいなやり取りになって盛り上がっていた。別分野の経験豊富な方と話すことで多くの気付きを得られるのも「余白」がもたらす価値と言えるのかもしれない。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0617/>接待もどき</a></h1><div class=post-meta><span class=post-date>2022-06-17</span></div><span class=post-tags>#<a href=/diary/tags/hospitality/>hospitality</a>&nbsp;
#<a href=/diary/tags/infrastructure/>infrastructure</a>&nbsp;</span><div class=post-content><h2 id=親戚と親の来訪>親戚と親の来訪</h2><p>姪が体調悪くて病院で検査を受けるという話しで姉夫婦が車で神戸にやってきて、それに便乗して親もやってきた。朝から道案内したりとかしてた。お昼ご飯は <a href=https://hisimitu.thebase.in/>ヒシミツ醤油</a> というお店に行った。週末とか前を通ると10人は並んでいる。なんでこんなに人気があるんだろう？とずっと不思議に思ってた。どうやら醤油も売っているんだけど、醤油によくあう和食の定食も食べられる飲食店らしい。ご飯が8種類あってお替り自由なのでバリエーションの広さを楽しめる。普通のランチよりちょっと贅沢な雰囲気がするので接待などにも向きそう。但し、ランチのピーク時間外さないと並ばないといけない。</p><figure><img src=/diary/img/2022/0617_lunch.jpg></figure><p>その後、親戚のお土産に <a href=https://www.kameido.co.jp/tonowa-index.html>亀井堂総本店のバターサンド</a> を買ってきた。西元町にあるお店で、4年ほど前にたまたまお店の前の通りかかったきっかけで買ってみたらおいしかったのでそれからずっと印象に残っていて、4年ぶりに買ってみた。老舗のお菓子なので接待のお土産にはちょうどよさそうな気がする。たまたま親戚がきたから接待モードになってお店とお土産を開拓してた。</p><h2 id=バッチ処理のプラットフォーム検討>バッチ処理のプラットフォーム検討</h2><p>昨日の続き。aws batch の機能説明や faq を読んでいたらよさそうなので触ってみた。事前に次の3つのリソースを設定しないといけない。</p><ul><li>コンピューティング環境</li><li>ジョブキュー</li><li>ジョブ定義</li></ul><p>これらの設定をした後、ジョブというリソースを発行することでジョブ定義の処理が実行される。ecs, fargate, ec2, ec2 spot instace から環境を選べる。ec2 spot instance を使えば安くていいかと思っていたんだけど、セキュリティを考慮すると外部のよく分からんインスタンスでバッチ処理を実行するのは懸念があるなぁと思い始めてやめることにした。aws lambda の代わりに aws batch を使うのはセキュリティの懸念さえなければ悪くはないんだけど、インフラの面倒さはどっちも同じぐらいで immutable infrastructure でバッチ処理のようなものを作るのはなかなか面倒くさい。</p><p>チームメンバーと3つの選択肢について議論した。</p><ul><li>aws batch を使う</li><li>eks (k8s) を使う</li><li>github actions を使う</li></ul><p>github actions の self-hosted runner に ec2 spot instance を使う記事もみかけた。これもいいかなと思ったんだけど、aws batch 同様、セキュリティの懸念は払拭できないのでダメだと断念した。</p><ul><li><a href=https://www.incredibuild.com/blog/extra-ci-flexibility-with-github-runner-on-aws-spot-instances>Extra CI flexibility with Github Runner on AWS Spot Instances</a></li></ul><p>消去法で eks (k8s) でやることにした。<a href=https://kubernetes.io/docs/concepts/workloads/controllers/cron-jobs/>CronJob</a> を使って実装していくことになりそう。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0616/>バッチ処理のインフラ構築に着手</a></h1><div class=post-meta><span class=post-date>2022-06-16</span></div><span class=post-tags>#<a href=/diary/tags/infrastructure/>infrastructure</a>&nbsp;
#<a href=/diary/tags/event/>event</a>&nbsp;</span><div class=post-content><p>0時に寝て5時に起きた。なんか体調がいまいちな雰囲気。</p><h2 id=ブログ記事のレビュー>ブログ記事のレビュー</h2><p>昨日の続き。会社ブログの担当者にもレビューも通って体裁を整えて会社ブログにも転記された。あとは情シスグループのリーダーレビューが最終チェックになるみたい。</p><h2 id=aws-batch>aws batch</h2><p>バッチ処理のインフラを構築しようと考えていて、これまで aws lambda で作られているのが非効率だなと思うようになってきた。<a href=https://aws.amazon.com/jp/batch/>aws batch</a> を使えないかを検討している。いまバッチ処理のための web api のエンドポイントを実装するスタイルになっていて、この流れでやっていくと将来的にバッチ処理が api サーバーに増えていく。たまたま負荷の高いバッチ処理と通常のリクエストがスパイクするとサーバーを過負荷にして通常業務に影響を及ぼす懸念がある。ec2 を作って cron でバッチ処理動かせばいいやんという気もするけど、せっかく cdk を使っているのでフルマネージドな仕組みで構築できればカッコいいなとも思ったりする。</p><h2 id=インフレ研究会>インフレ研究会</h2><p>たまたまみかけたので <a href=https://fin-py.connpass.com/>fin-py</a> のインフレ研究会に参加した。前は twitter spaces でやっていて、私はスマホに twitter アプリが入っていないから参加しにくくて微妙だった。最近は <a href=https://brave.com/ja/talk/>brave talk</a> でやっているのでパソコンからも参加しやすくなった。物価、金利、中央銀行の金融政策などの話しを私はまったくわからないのでほとんど聞いているだけ。聞いているうちに世の中のお金の流れが少しずつわかってくればいいかな。国債の値段が下がれば金利が上がるみたいなそういう話しを聞いてそうなんだという感じ。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0615/>設計談義は楽しい</a></h1><div class=post-meta><span class=post-date>2022-06-15</span></div><span class=post-tags>#<a href=/diary/tags/event/>event</a>&nbsp;
#<a href=/diary/tags/communication/>communication</a>&nbsp;</span><div class=post-content><p>0時に寝て4時半に起きてだらだらして2度寝して8時に起きた。</p><h2 id=jjug-のセッションの紹介>jjug のセッションの紹介</h2><p>jjug の公式アカウントがランダムにセッションのページを紹介している。私のセッションのリンクが今日ツィートされた。この日記を書いている時点で3つの「いいね」が付いている (1つは私なので除く) 。大して人気の出るような内容ではないし、なにかを期待しているわけでもないけど、誰からも関心を持たれなかったらそれはそれで発表者として寂しいなという気持ちもあって、ついつい見てしまった。ほんの2-3人でもいいから当日は発表を聴いてくれると嬉しい。そして、その流れで質問をしてくれればと考えている。もし当日、誰も聴いてくれなかったらスタッフの人が質問してくれるんやろか？</p><blockquote class=twitter-tweet><p lang=ja dir=ltr>JJUG CCC 2022 Spring 6月19日開催<br>[Track C] 10:25- <a href="https://twitter.com/hashtag/jjug_ccc_c?src=hash&ref_src=twsrc%5Etfw">#jjug_ccc_c</a><a href="https://twitter.com/hashtag/jjug_ccc?src=hash&ref_src=twsrc%5Etfw">#jjug_ccc</a><br>Java で作るカスタム GitHub Actions<a href=https://t.co/cwpuR7dPmJ>https://t.co/cwpuR7dPmJ</a></p>&mdash; JJUG (@JJUG) <a href="https://twitter.com/JJUG/status/1536868086938099715?ref_src=twsrc%5Etfw">June 15, 2022</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script><h2 id=ブログ記事のレビュー>ブログ記事のレビュー</h2><p>朝一で昨日書いた記事を読み返しながら推敲した。やっぱり一晩寝ると、文章の粗が目立ってみえて細かい表現をあちこち直していた。その後に身近な人たちに記事のレビューをお願いして、概ね問題なさそうなので会社ブログの担当者にもレビュー依頼した。その返事はまだ返ってきていない。</p><h2 id=設計ミーティング>設計ミーティング</h2><p>先週から始めた <a href=/diary/posts/2022/0608/#開発チームで設計の話し>設計ミーティング</a> の2回目。時間は2時間も抑えられていて話題がなければ解散するといったやり方。今日もなんだかんだで2時間丸々話していた。うちらの開発チームは開発者で共有すべき開発情報や設計の考え方などの情報共有が不足しているんだなと、多くの時間を割いても話題が尽きないことからも実感した。私は設計を練るのが好きなのでそれ自体も楽しい。スクラムイベントで会議の時間が多い上にこのミーティングは追加で実務の時間を奪うという懸念が大いにある。しかし、2-3ヶ月やったらアプリケーションの設計や品質に何かしらよい影響を与えそうな雰囲気はしている。代わりに他のスクラムイベントを削ることはできないだろうか。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0614/>ゴーストライター</a></h1><div class=post-meta><span class=post-date>2022-06-14</span></div><span class=post-tags>#<a href=/diary/tags/writing/>writing</a>&nbsp;
#<a href=/diary/tags/event/>event</a>&nbsp;</span><div class=post-content><p>0時に寝て6時に起きた。夜になにか作業をしようと考えていたけど、帰って晩ご飯食べたらだらだらしてた。</p><h2 id=ブログ記事の執筆>ブログ記事の執筆</h2><p>今度の jjug ccc にチームの同僚と一緒に登壇する。同僚の発表スライドをみていて15分で話すには詳細を説明できないことに気付いた。せっかくイベントで発表して、よいプラクティスもできたのにもったいないとか思い始めて、発表の補足資料となるブログ記事を書きたいと私が言い始めた。先方ものってきてくれて、会社ブログを管理している社内の担当者を紹介してくれてそこに技術記事を書こうという打ち合わせをした。聞くところによると会社のテックブログはまだなく、技術記事も1つもないという話し。今回が初めての技術記事を公開する試みになるらしい。それはともかく、<a href=https://note.com/info/n/nfa4a65bd08ea>note の新エディタ</a> が使えるようになっていたので初めて試してみた。新エディタの紹介記事を眺めてて画像のキャプションも入れられるようになったのにも気付いた。箇条書きの機能が増えたところはよいけど、勝手に段落がフォーマットされる感じが私の好みではない。エディタが勝手にフォーマットするのではなく、書き手が明示的に指示したときだけフォーマットされるような仕組みを私は好む。とはいえ、一般人は自動的によしなにやってくれる方がよいのかもしれない。半日ぐらいあーでもない、こーでもないと試行錯誤しながら一通りアウトラインに沿った草稿を書き上げた。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0613/>データベースを介したテストではまった話し</a></h1><div class=post-meta><span class=post-date>2022-06-13</span></div><span class=post-tags>#<a href=/diary/tags/spring-boot/>spring boot</a>&nbsp;
#<a href=/diary/tags/testing/>testing</a>&nbsp;</span><div class=post-content><p>1時に寝て7時に起きた。帰りにふらっと仲のよい焼き鳥屋さんに寄ったらちょっとしたハプニングがあって長居してしまった。他に来ていたお客さんのカップルが別れ話を始め、こじれてややこしい状況になって、この騒動が一段落しないと席を立てない空気になってしまって終わるのを待ってた。マスターの知り合いらしくて、そのお客さんが帰ってから当事者たちの背景を聞いたりしてた。人生いろいろあるよなぁ。</p><h2 id=spring-の-transactional-アノテーション>spring の Transactional アノテーション</h2><p>spring フレームワークには <a href=https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/transaction/annotation/Transactional.html>Transactional</a> というアノテーションがある。<a href=https://docs.spring.io/spring-boot/docs/current/api/org/springframework/boot/test/context/SpringBootTest.html>SpringBootTest</a> を使ったテストのときに使うと、テストメソッドの終了時に自動的にデータベースへの書き込みがロールバックされて便利なことを <a href=/diary/posts/2022/0208/#テストコードのリファクタリング>テストコードのリファクタリング</a> をしていたときに気付いた。</p><p>スレッドプールを使ってマルチスレッドで並行実行する処理を書いてそのテストを書いてみたら意図した結果にならない。なんでだろう？と2時間ほどはまってデバッグしていた。テストデータの書き込みが、実際にはデータベースにコミットされていないので、テストを実行しているスレッド以外のワーカースレッドからデータベースにアクセスしてもテストデータを参照できないからだと気付いた。データベースのトランザクションに細工すると、こういうはまりどころがあるなぁと気付いて Transactional を使わずに普通にテストを書いた。その分、自分でテストメソッドが呼ばれてコミットされたテストデータを削除する必要がある。調べていたときに他にも副作用がいろいろあるよという記事もみつけた。</p><ul><li><a href=https://dev.to/henrykeys/don-t-use-transactional-in-tests-40eb>Don’t Use @Transactional in Tests</a></li></ul></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0612/>オーディオコンテンツにお金を払う</a></h1><div class=post-meta><span class=post-date>2022-06-12</span></div><span class=post-tags>#<a href=/diary/tags/workcation/>workcation</a>&nbsp;
#<a href=/diary/tags/podcast/>podcast</a>&nbsp;</span><div class=post-content><p>前日の夕方から寝たり起きたりでたくさん寝て7時に起きた。体力を回復した。</p><h2 id=ワーケーション記事の執筆>ワーケーション記事の執筆</h2><p>せっかくの機会なので会社ブログにもワーケーションのふりかえりを書いた。</p><ul><li><a href=https://kazamori.jp/blogs/2022/06/12/workcation-kinosaki/>ワーケーション -城崎温泉-</a></li></ul><p>いまのところ、会社のサイトをみてお仕事が来るような会社でもないんだけど、今後のマーケティングをしていく中でどんな会社なのかをみられることも増えていくと思う。そのときに会社という法人の人となりがわかるようなコンテンツがたくさんあるとよいのではないかとも考えている。基本的には技術記事をメインにするつもりだけど、たまにはそうじゃない記事もあるのはよいだろう。最近はお仕事ばかりで全然、技術記事を書けていない。私は書くのが遅いので、書けることや書きたいことに対して10分の1ぐらいしか書けず、コンテンツがまったく育たない。今後のマーケティングの課題でもあるなぁ。</p><h2 id=プレミアムリスナーになってみた>プレミアムリスナーになってみた</h2><p>いつからかな？2016年か2017年と思ってバックナンバーを遡って最初の放送を調べたら2017年5月30日が初回の放送だった。おそらく初期の時期から聴き始めたように思う。<a href=https://voicy.jp/channel/32>ベンチャーニュースで言いたい放題</a> というオーディオコンテンツがある。パーソナリティの話しがおもしろくて2-3年は聴いていた。起業した前後で余裕がなくて聴いていない時期が1年ほどあるけど、最近また余裕をもてるようになったので聴き始めた。5年前からずっと続いているし、いまも私が聴きたいと思うコンテンツを提供していることのすごさを実感する。そういった敬意も含めて <a href=https://service.voicy.jp/premium-listener>プレミアムリスナー</a> になることにした。購入はアプリ経由だと1480円、web 経由だと1000円になる。プラットフォームの制約があるのだろうけど、こんなことして apple に怒られないのかな？と心配になる。web 経由の方がお得ですよと普通に書いてある。プレミアムリスナーになると、プレミアムコンテンツを聴けるようになるが、おそらく配信されたばかりは期間限定で誰でも聴けて、時間が経ったらプレミアムリスナーしか聴けなくなるようなコンテンツにみえる。いままで何年も聴いてきたのと、今後も続けてほしいという願いも込めての料金支払いなので私はとくに不満はない。</p><p>私はいろんな仕事やプロジェクトを転々としてきたのもあり、何年も同じことをずっと続けていることそのものに尊敬の念がある。ベンチャーニュースで言いたい放題は5年継続していることになる。5年も続くとコンテンツそのものの価値や信頼、それに関するスキルもすごく上達すると思う。これまで私はプログラミングという文脈ではスキルを磨いてきたが、コンテンツを作っていくというところは素人なのでそういうところを見習いたいと考えている。そんなことも考えながら、気に入っているオーディオコンテンツにお金を払うことに決めた。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0611/>ワーケーションの精算</a></h1><div class=post-meta><span class=post-date>2022-06-11</span></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/workcation/>workcation</a>&nbsp;</span><div class=post-content><p>1時に寝て7時に起きた。ふとんなしで寝ても寒くない季節になった。天気も悪かったので15時ぐらいから帰って、ドラクエタクトしたり、読み溜めてた LINE マンガ読んだり、疲れたら寝たりして普通に休んでた。</p><h2 id=ストレッチ>ストレッチ</h2><p>今週はバテバテになっていて、先週から引き続き、右股関節や右腰に張りが強い。右側が少し前に出たような形状になっているらしく、姿勢か癖かで右側に負荷が偏るなにかになっているみたい。今日の開脚幅は開始前159cmで、ストレッチ後161cmだった。現状維持といったところ。今週末は休もうと思っている。参考がてらトレーナーさんに休むときにどうするかを聞いてみた。ジムへ行って運動した後、それから考えるらしい。私の場合、起きたらひとまずオフィスへ行ってなんか調べものして過ごすことが多い。サードプレイスへ出掛けるのはわりと多くの人に共通する行動なのかなとか思えた。</p><h2 id=ワーケーションの精算>ワーケーションの精算</h2><p>今週はバタバタしていてまったく余裕がなかった。ワーケーションのお金の精算をした。同行者からも料金の一部を徴収しているのでこの金額すべてが経費ではない。食費や入浴料金、お土産を除くと次になる。</p><ul><li>宿泊費 (県民割引を適用後)<ul><li>1泊目: 26,000 (3人)</li><li>2泊目: 27,000 (4人)</li></ul></li><li>交通費<ul><li>レンタカー: 23,760</li><li>ガソリン代: 2,424</li><li>高速道路代: 5,230</li><li>駐車場代: 800</li></ul></li><li>接待<ul><li>居酒屋: 9,200</li></ul></li><li>合計: 94,414</li></ul><p>入浴料金を会社の経費にできるかどうかは福利厚生費ならできるらしい。但し、うちは社員がいないので福利厚生費を計上できない。原則として役員には福利厚生費を適用できない。福利厚生とは社員の生活や仕事の充実や向上を目的とするため、役員はそれを提供する側になる。とはいえ、役員と社員が一緒に利用する妥当な金額の福利厚生費なら認められるらしい。</p><ul><li><a href=https://www.reloclub.jp/relotimes/article/14803>役員に福利厚生は存在しない？迷いやすいポイントを解説</a></li></ul><p>高速道路の料金を etc の利用履歴から取得できないかな？と考えてググると、<a href=https://www.etc-meisai.jp/index.html>ETC利用照会サービス</a> というのをみつけた。初期登録するにはカード番号と直近の利用履歴、車両番号と車載器管理番号が必要になる。レンタカーの領収書には車載器管理番号までは記載されていなかったので店舗に電話して尋ねると快く教えてくれた。これでETC利用照会サービスに登録できたものの、登録後に利用明細が表示されるまで4時間かかるという。バッチ処理のタイミングなのか、なにかわからないけど、4時間は長過ぎでしょとか思いながら待った。待った甲斐があって明細は csv と pdf 出力できた。記録としてデータを残す上でダウンロード機能はありがたい。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0610/>リファクタリングとオブジェクト指向プログラミング</a></h1><div class=post-meta><span class=post-date>2022-06-10</span></div><span class=post-tags>#<a href=/diary/tags/refactoring/>refactoring</a>&nbsp;</span><div class=post-content><p>0時に寝て8時に起きた。先週末の疲れが溜まってバテバテ。直近の1週間で睡眠時間が短いときは3-4時間しか寝てないのでなんか朝起きれなくて調子悪いなと思ったら単純に睡眠不足よね。なんか安心した。</p><h2 id=既存ロジックのリファクタリング>既存ロジックのリファクタリング</h2><p>ちょっと前にタイムラインで「値オブジェクト」の定義の話題で盛り上がっていた。私は詳しくないのでどちらが正しいのかの白黒を付けられないが、値オブジェクトがどういうものかの定義を知らなくても、オブジェクト指向プログラミングとしてデータ + メソッドでカプセル化していくモジュールの概念からすると普通のことであって、それの特殊ケースに名前が付いている・付いていないという議論だったのではないかと思う。</p><p>今日たまたま既存のある処理に機能を拡張するため、既存のコードを読んでいて、ロジックを扱うコンポーネントが肥大化していて、ここに手を入れていくとさらにコードの見通しが悪くなるように思えた。そのロジックコンポーネントの半分は出力用の DTO を生成する処理が占めていて、DTO を生成する処理をオブジェクトとして切り出すことでロジックコンポーネントを半分に分割できることに気付いた。パラメーターとして7つの値をそのオブジェクトの入力として、そのオブジェクトの内部であれこれやって、最終的に必要な DTO を出力できればよい。1つのコンポーネントを2つのコンポーネントに分割したことで、それぞれのコンポーネントのスコープにおけるメソッドが半分になったというだけの話し。一般的なカプセル化の話し。難しい話しをしなくても設計やオブジェクト指向プログラミングの基本的な考え方などをメンバーに教えていければいいんだけど、私はあくまで協力会社のお手伝いなので、教える業務は担っていない。次の契約更新のときにインフラやプログラミングを経験の浅い人たちに教えましょうか？みたいな話しもしたいと考えている。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0609/>コンテンツは狙ってバズらない</a></h1><div class=post-meta><span class=post-date>2022-06-09</span></div><span class=post-tags>#<a href=/diary/tags/scrum/>scrum</a>&nbsp;
#<a href=/diary/tags/cdk/>cdk</a>&nbsp;
#<a href=/diary/tags/infrastructure/>infrastructure</a>&nbsp;
#<a href=/diary/tags/podcast/>podcast</a>&nbsp;
#<a href=/diary/tags/marketing/>marketing</a>&nbsp;</span><div class=post-content><p>1時に寝て8時に起きた。昨晩はたくさん話してテンション上がって眠れなくてバテ気味。</p><h2 id=serverless-framework-から-cdk-移行の背景>serverless framework から cdk 移行の背景</h2><p>木曜日はスプリントレビューがある。ステークホルダーが出席する唯一のスプリントイベントなので、大半はステークホルダーとの情報共有や質疑応答、プロジェクトにとっての大きい括りでの現状の共有になる。大半はお手伝い先の社員さん同士のやり取りで、協力会社の開発者は詳細が必要になったときだけ説明するといったイベント。前スプリントで <a href=/diary/posts/2022/0601/#mvpminimum-viable-productで対応した>既存の lambda 関数を serverless framework から cdk へ移行</a> した。プロジェクトメンバーではないのだけど、業務のリーダークラスの方が cdk に関心をもって質問してくれた。聞くところによると、他プロジェクトでも cdk を使うようになってきているらしく、なぜいま移行しているのか？という質問だった。普段インフラ作業を孤独にやっているのもあって、業務の人が関心を示してくれたのが嬉しくて、変なスイッチが入っていろいろ説明した。serverless framework は2015年10月リリース、cdk は2018年7月リリースで、歴史的に serverless framework が普及して、その後に cdk が台頭してきたので実績や機能性から serverless framework が広く利用されている。但し、いま aws のインフラ管理をするのであれば、cdk は serverless framework 以上の管理ができることから cdk に一元管理した方がツールの学習コストを減らし、保守コストを下げることにつながるといった話しを丁寧に説明した。相手がそこまでの回答を求めていたかはわからないけど、関心を示してくれたことそのもので私が救われた気がした。</p><h2 id=terapyon-channel-のコンテンツ公開>terapyon channel のコンテンツ公開</h2><p>昨日の今日で公開された。ほとんど無編集だったのかな。web サイトのコンテンツ紹介の内容も手伝って夕方には公開された。</p><blockquote class=twitter-tweet><p lang=ja dir=ltr>Podcast terapyon channel 「#58 もりもとさんの年1ゲスト会 マイクロ法人と開発ワークフローのカイゼン話ほか」を共有 <a href=https://t.co/aQfbuA6XrO>https://t.co/aQfbuA6XrO</a> <a href="https://twitter.com/hashtag/terapyon_channel?src=hash&ref_src=twsrc%5Etfw">#terapyon_channel</a></p>&mdash; terapyon (@terapyon) <a href="https://twitter.com/terapyon/status/1534817292080451584?ref_src=twsrc%5Etfw">June 9, 2022</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script><p>私の中ではいろんな話題を楽しく話せて充実感があった。一部にだけ関心をもつ人にも聞きたいところだけ聞けていいんじゃないかと思えた。基本的に自分の podcast を聞き直すことはないんだけど、今回は自分が充実感をもって話せたせいか、2回ほど聞き直しておもしろい話だなぁと自画自賛してた (笑) 。自分がよいものは周りもそう思うはずだと、ついつい先入観で考えがちだけど、全然そうじゃなかった。全くいいねがつかなかったので周りからみたら私の自己満足のコンテンツでしかなかった (笑) 。コンテンツあるあるだけど、狙ってコンテンツをバズらせるのは難しい。ブログでもがんばって書いた記事が全く読まれないことはあるし、手間暇かけずに軽く書いた記事がめっちゃバズったこともある。コンテンツがバズるかどうかは、最初にみた人たちが拡散するかにも依ってくる。いずれにしても、他者が関心をもつようなコンテンツかどうかは本人ではわからないというのは確かかな。</p><p>今期から会社のマーケティングも少しずつやっていく予定になる。自分がよいと思ったコンテンツに全く関心を示されないことは今後も多々あるだろう。作ったコンテンツを多くの人に見聞きしてもらおうと思ったらやることは1つだけで、当たるまでひたすら作り続けて、いつか当たるのを気長に待つという戦略しか、いまのところ思いつかない。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0608/>書いた後に話して</a></h1><div class=post-meta><span class=post-date>2022-06-08</span></div><span class=post-tags>#<a href=/diary/tags/scrum/>scrum</a>&nbsp;
#<a href=/diary/tags/podcast/>podcast</a>&nbsp;</span><div class=post-content><p>3時に寝て7時に起きた。ワーケーションの記事まとめで1時ぐらいまでオフィスにいたので帰ってきてから寝るのが遅くなった。</p><h2 id=開発チームで設計の話し>開発チームで設計の話し</h2><p>昨日のスクラムイベントのふりかえりでスプリントゴール未達の話題があった。うちのチームはスプリントが1週間と短いのもあるけど、スプリントゴールが未達になることがままある。というか、メンバーも本当の意味でスプリントゴールを守ろうとしていない。守れそうにないと分かっても残業も延期もせずに最終日を迎えて未達で終わるだけでしかない。それはともかく、ゴールに含めるタスクの見積もりの精度が悪いのではないかという話題が出たときに、私の周りではプランニングにもっと時間を割いてがっつり設計までやるという話しを聞くので、うちらのプランニングはチケットを選択して適当に割り当てたストーリーポイントで曖昧な見積もりをしているのでそれが悪いのではないかという意見を上げた。そしたら開発者だけで設計のミーティングをやろうという話しになって、今日から毎週やっていくのかな。会議が増えて実務をやる時間が減るというデメリットはあるものの、チームとして学ぶ時間が少ないとは前から思っていたので、チームとして学びの時間を使ってメンバーのスキルを高めていくきっかけの1つとしてはよいかもしれないと思った。あるチケットで議論していて、本質的にはどうなるべき？という議論をして、直近のマイルストーンでは実装できないが将来的に対応するときのためにチケットを作っておいたりした。そういう1つずつの積み重ねが将来の品質をあげていく糧になる。開発者だけで設計という枠組で話すこと自体は大事な時間だとは思えた。</p><h2 id=terapyon-channel-の収録>terapyon channel の収録</h2><p>21時過ぎから <a href=https://podcast.terapyon.net/>terapyon channel</a> の収録を行った。たまたまだけど、私は年に1回出演していて、今後もそのペースがいいなという思えた。6月は法人決算を終えて気楽になっているし、1年に1回なら近況報告として話題もたくさんある。前回からのツールのアップグレードとして <a href=https://iris.fm/>iris</a> というツールで収録した。これまではローカルで音声ファイルを録音して、終わった後に寺田さんへその録音ファイルを送信していた。iris を使うと、ブラウザだけでそれをやってくれるのでゲスト側の作業が減ってお手軽になる。ホスト側もゲスト側で録音に失敗するという最悪の事態のリスクを軽減できるので望ましいという。iris のホスト側の画面にはゲスト側の音声が録音されていることを表すインジケーターもみえるらしい。それが安心感を与えているとのこと。久しぶりに寺田さんと話して、podcast の収録というよりも寺田さんと普通に近況の雑談をしたぐらいの感覚でしかない。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0607/>変哲もない1日</a></h1><div class=post-meta><span class=post-date>2022-06-07</span></div><div class=post-content><p>0時に寝て7時に起きた。もうバテバテ。</p><h2 id=開発の隙間>開発の隙間</h2><p>インフラタスクも一段落したのでアプリケーション開発の手伝いをしている。言うてももうすぐ feature freeze で大半の機能は fix しているのでサービスインに向けての運用系のタスクを先行して取っているだけ。簡単なサーバーサイドの修正を行い、割り当てられたタスクの内容を確認したり、スクラムイベントのふりかえりをしたり、ドキュメントを書いたりしたら1日が終わってしまった。ワーケーションへ行ってきた疲れが残っているのか、インフラタスクが落ち着いて次のタスクへの切り替わりのせいか、あまり集中できなかった。6月の週末はちょっと休んでもいいかもしれない。</p><h2 id=ワーケーションのまとめ>ワーケーションのまとめ</h2><p>3日目のワーケーションの記事を書き終えた。明日 podcast の収録があるからそれまでに終えようと思って無理して書き上げた。日が変わるぐらいまでは作業してたと思う。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0606/>aws sns を介した pubsub</a></h1><div class=post-meta><span class=post-date>2022-06-06</span></div><span class=post-tags>#<a href=/diary/tags/cdk/>cdk</a>&nbsp;
#<a href=/diary/tags/infrastructure/>infrastructure</a>&nbsp;</span><div class=post-content><p>0時に寝て4時半に起きた。21時頃からオフィスで作業してたらそのまま寝落ちした。朝の掃除機をかける音で目覚めて、始業までワーケーションのふりかえりをしていた。</p><h2 id=lambda-関数と-sns-の連携>lambda 関数と sns の連携</h2><p>定期実行で数百程度の web api 呼び出しを行いたい。これまで定期実行を lambda 関数で実装してきたが、負荷分散を考慮して作ってほしいと言われたので sns を使ってメッセージ分割した上で1つ1つの lambda 関数は sns のメッセージを受け取って実行されるように構成した。lambda 関数を使って pubsub するときは sns を使えばよいらしい。sns はあまり使ったことがないので私自身ノウハウをもっていないし、運用の勘所もよくわかっていない。ドキュメントをいくつか読みながら cdk のコードを書いてた。producer と consumer を lambda 関数で作成し、sns を介してリクエストの負荷分散を図る。lambda 関数は同時並行数を設定できるのでこれがスロットル制限のような役割にもなる。インフラやスクリプトのコードはすぐに実装できたが、lambda 関数の destroy にやたら時間がかかる。権限周りでいくつか設定を試すために destroy しながら検証をしたかった。destroy するのに20分はかかるので deploy や設定の手作業などをやっていると1つの設定を試すのに平気で1時間ぐらいかかってしまう。3回ぐらいやって疲れて検証作業はやや妥協した。</p><ul><li><a href=https://docs.aws.amazon.com/ja_jp/lambda/latest/dg/with-sns.html>Amazon SNS でのAWS Lambdaの使用</a></li><li><a href=https://docs.aws.amazon.com/lambda/latest/dg/configuration-concurrency.html>Managing Lambda reserved concurrency</a></li><li><a href=https://docs.aws.amazon.com/sns/latest/dg/sns-security-best-practices.html>Amazon SNS security best practices</a></li></ul></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0605/>ワーケーション 3日目</a></h1><div class=post-meta><span class=post-date>2022-06-05</span></div><span class=post-tags>#<a href=/diary/tags/founding/>founding</a>&nbsp;
#<a href=/diary/tags/workcation/>workcation</a>&nbsp;
#<a href=/diary/tags/life/>life</a>&nbsp;</span><div class=post-content><p>3時に寝て6時前に起きた。起きて作業しようと思って階下に降りた (寝室は2階) ものの、なんかバテてて、畳の部屋で寝転がっていた。涼しくて気持ちよかった。2度寝もしてたかもしれない。起きてからは帰りの高速道路のサービスエリアを調べたり、丹波篠山市か、六甲山天覧台に寄り道するならどういうルートになるかシミュレーションしたりした。</p><h2 id=朝風呂とモーニング>朝風呂とモーニング</h2><p>昨日と同じように7時を過ぎてから朝風呂に出掛けていく。今日は「地蔵湯」に入った。子ども向けの浅いお風呂と大きなお風呂があった。座椅子でやや腰に負担がかかっていたのでジャグジーで腰の療養をした。昨日3時まで雑談して疲れていたせいか、2泊を終えてバーンアウトしてしまったのか、3日目の旅程の考えがうまくまとまらなくて、お風呂に入りながらぼーっとしていた。喫茶店の <a href=https://tabelog.com/hyogo/A2808/A280801/28014933/>萠阿 (のあ)</a> さんでモーニングを食べた。</p><figure><img src=/diary/img/2022/0605_morning1.jpg></figure><p>事前に作成しておいた旅のしおりでは、チェックアウトは11時にして、13時に城崎温泉を出発する旅程になっていた。意図としては観光したい人向けに余裕をもったスケジュールにしていたつもりだった。しかし、周りも疲れているようにみえて、11時に城崎温泉を出てもいいかなという空気にはなっていた。とはいえ、11時から帰り始めると2時間半で神戸に着いてしまう。はらさんの帰りの飛行機の時間が19時だったのであまり早くても持て余してしまう。車で行ける付近の場所を観光してもいいかなと思いつつも具体的なアイディアが出てこない。疲れると想定外の状況に対していくつかの仮説を並行してシミュレーションできなくなっていた感じ。お昼ご飯どうする？という話題に、城崎温泉で食べるか、よそで食べるかもまとまらない。誰かが出石そばを食べに行こうと言い始めて「あっ、よさそう」と思えた。近くのパーキングエリアで出石そばを食べたらいいんじゃない？という案もあったが、出石の城下街へ行こうと押し切った。はまらないパズルのピースがはまった。学生の頃にツーリングで出石に行ったことがあったので私はどんな場所かを知っていて、お昼ご飯も食べられて少し観光もできてちょうどいいと思えた。</p><h2 id=チェックアウト>チェックアウト</h2><p>11時に管理人さんが来られ、チェックアウトの手続きはすぐに済み、みんなで記念写真を撮って帰り始める。管理人さんは城崎温泉のことを質問すると、あれやこれやと教えてくれていた。すみよしさんが「出石そばのお薦めのお店知っています？」と管理人さんに尋ねた。私がそれは流石に知らんやろと横で聞いていたら「ちょっと待ってください」と即答で2店舗を教えてくれた。この管理人さんは何でも知っているんやなと感心して笑ってしまった。管理人さんは本当に親切でよい人だった。</p><p>このときの集合写真はきのいえのインスタグラムで公開されている。</p><ul><li><a href=https://www.instagram.com/p/CeatOWvLNMs/>お宿で勉強会！</a></li></ul><h2 id=出石そばと城下町散策>出石そばと城下町散策</h2><p>11時に城崎温泉を出て出石の城下町へ向かう。40分ほどで着く。きのいえの管理人さんに教えてもらった <a href=https://tabelog.com/hyogo/A2808/A280801/28006603/>官兵衛</a> さんに訪問。お昼前で少し早かったせいか、ちょうど待たずに入れた。うちらがお店を出たときは2組ほど並んでいた。出石そばのシステムがわからなくて、注文するときに店員さんに尋ねると、大人男性ならだいたい10-15皿だという。ひとまず10皿を頼んで足りなかったらまた注文すればいいとのこと。まずはそばだけ食べて、その後に薬味を使って、卵は後半の方がよいと教えてくれた。私は、最初の2皿をそばだけを食べて、次にわさび、その後に葱や大根おろしを試し、とろろも入れ、8皿目ぐらいに卵をつかってみた。ちょっとした味のバリエーションにもなっていておもしろかった。私は10皿で満足した。</p><p><figure><img src=/diary/img/2022/0605_soba1.jpg></figure><figure><img src=/diary/img/2022/0605_soba2.jpg></figure></p><p>余談だが、まったく値段を知らずに入ったので、お会計のときにこれはいくらなんだろう？思いながら勘定をした。1人あたり薬味150円と皿そばが170円 * 10皿で合計すると1,850円 (税込) だった。おいしかったし、皿そばという名物を食べるという雰囲気も味わえてよかったのでまったく不満はない。純粋にそばだけだからそんなに高くないのかな？という先入観から想像以上だったので少し驚いた感じ。はらさんが「外国人を連れてきたらすごく喜ぶと思いますよ。」と2回ぐらい言ってた気がするので、これは大事なことなんだと思って、外国人を連れてきたらいいと私の記憶に残った。</p><figure><img src=/diary/img/2022/0605_izushi1.jpg></figure><p>その後、せっかく出石に来たから城跡も行ってみることにした。城跡には行ったことがなかった。城跡だから原っぱみたいな場所をみるだけかな？と考えていたら、石垣がしっかり残っていて3段目ぐらいまで登って街並みを展望できた。さらにもっと山を登っていけるようで、頂上までいくとそれなりの山登りハイキングができる場所になっているみたい。</p><p><figure><img src=/diary/img/2022/0605_izushi2.jpg></figure><figure><img src=/diary/img/2022/0605_izushi4.jpg></figure></p><p>私はまったく出石城のことを知らなくて、もともとのお殿様ではないが、なんやらかんやらで <a href=https://ja.wikipedia.org/wiki/%E4%BB%99%E7%9F%B3%E7%A7%80%E4%B9%85>仙石秀久</a> が城主になったらしい。<a href=https://www.sunrise-pub.co.jp/duet-vol93/>センゴク</a> の漫画の主人公。城跡に上る鳥居の裏に作者の宮下英樹さんの名前もあった。<a href=https://xn--y8jwb3fsa0346bwq3atxzab5s.com/saiko/sengoku-hidehisa/>仙石秀久：鈴鳴り武者、またの名を蕎麦の伝道師…、あんたはいったい何者だ!?</a> の記事によると、出石そばも仙石秀久が信州から出石へ転封したときに一緒に付いてきた信濃のそば職人が発祥になっているらしい。はーん。</p><figure><img src=/diary/img/2022/0605_izushi3.jpg></figure><h2 id=西紀サービスエリア>西紀サービスエリア</h2><p><a href=/diary/posts/2022/0603/#三ノ宮から城崎温泉への移動>ワーケーション1日目の反省点</a> にも書いたが、車の移動で行きはどこで休憩するかを決めていなかった。そうすると、どのタイミングでどこのサービスエリアに入っていいかがわからなくなってしまった。帰りは下調べして、休憩によさそうな設備があって中間の適切な位置として、舞鶴若狭自動車道の西紀サービスエリアがよさそうと調べていた。そして最初からナビの目的地をサービスエリアにしてしまうことで走り過ぎや休憩までのペースなども走りながら考える必要がない。当たり前のことなんだけど、自分で運転してみて初日はうまく段取りできなかったのでこれも大事な事前準備だと気付いた。</p><figure><img src=/diary/img/2022/0605_sa1.jpg></figure><h2 id=小さなふりかえりと神戸空港>小さなふりかえりと神戸空港</h2><p>神戸に戻ってきてから雨がぱらぱらし始めた。天候も何とかもってちょうどよかった。1時間ほどドトールさんで休憩しながら軽いふりかえりみたいになった。</p><ul><li>朝と夜に温泉入るのは疲れる<ul><li>7つの外湯があり、パスポートを購入していても連続でお風呂に入る人はいなかった</li></ul></li><li>開発合宿は2泊3日が限界<ul><li>非日常の慣れない生活は楽しさととも緊張もあるので疲労も大きい</li></ul></li><li>実際にやってみることから得られる経験や体験はとても大きい<ul><li>城崎温泉がどういう場所か、その文化や歴史の一端を垣間見えた</li><li>主催としてやらなければならない段取りや準備の経験を大きく積めた<ul><li>今回の経験をベースにして今後も課題管理システムに積み重なっていく</li></ul></li></ul></li><li>今後の開発合宿イベントの展望<ul><li>オープン版は三ノ宮.devでやりそうなのでそこに便乗する</li><li>うちの会社の関係者や知人に声をかけてクローズドなイベントを1回/年でやる<ul><li>(当面は) bizpy ではやらないかなぁ</li></ul></li></ul></li></ul><p>その後、解散してはらさんを神戸空港まで送っていった。空港の場所は知っていたけど、実際に行ったことなかったので車で空港への行き方がわかってよかった。これで飛行機で神戸に来る人がいても送迎ができる。18時半にレンタカーを返却した。今回は日産 NOTE e-Power というハイブリッド車を初めて運転した。今回の旅程で約350km走って消費したガソリンは約15リットルだった。燃費は23.3/リットルだった。レンタカーを返して家に着いたらやり終えたなって感じで気分がよかった。</p><h2 id=ストレッチ>ストレッチ</h2><p>いつもは土曜日の10時に通っているストレッチを、ワーケーションがあったので日曜日の19時半に変更してもらっていた。温泉に入った後に多少はストレッチをしたものの、運転疲れで体が硬くなってしまっていた。今日の開脚幅は開始前155cmで、ストレッチ後160cmだった。ワーケーションへ行ってきて疲れた後にストレッチを受けられるのは、疲弊した箇所がわかってとてもよかった。外湯に入るために普段より歩いたのものあって腰とふくらはぎの張りが強かった。その上で座椅子や車の運転なども相乗効果があって疲れが溜まっていた感じ。トレーナーさんと旅のふりかえりを雑談しながらストレッチを受けていて、週末どこかへ行ってきた後にストレッチを受けるのはすごくいいと思ってしまった。この場合、私の中ではストレッチがマッサージに置き換わってしまっている。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0604/>ワーケーション 2日目</a></h1><div class=post-meta><span class=post-date>2022-06-04</span></div><span class=post-tags>#<a href=/diary/tags/founding/>founding</a>&nbsp;
#<a href=/diary/tags/workcation/>workcation</a>&nbsp;</span><div class=post-content><p>0時に寝て5時半に起きた。軽く作業をしてから朝風呂を入りに行くことにした。</p><h2 id=朝風呂とモーニング>朝風呂とモーニング</h2><p><a href=https://kinosaki-spa.gr.jp/about/spa/7onsen/>7つの外湯</a> のうち、朝7時からあいているところは次の4つ。</p><ul><li>地蔵湯</li><li>一の湯</li><li>御所の湯</li><li>鴻の湯</li></ul><p>朝風呂を入るために浴衣姿で外を出歩く。城崎温泉のよいところとして、浴衣姿でその辺を散歩していても変な人に思われない文化を意図的に作っている。浴衣のまま出歩けるというのは、温泉が外湯なので出掛けるために着替えないといけないという手間を軽減するとともに、日本的くつろぎの雰囲気も醸し出している。実利と文化の両面から城崎温泉というコンテンツに付加価値を与えているおもしろい文化だと思えた。街が一体となってそういう文化を作ってきたんだなという歴史の重みも感じた。</p><p>「一の湯」に入ることにした。外へつながる扉に「洞窟」と書いてあって、露天風呂があるんだろうと思いながら外に出たら本当に洞窟があった。洞窟の温泉というのに入ったことがなかったのでびっくりした。後から入ってきたはらさんをみていて、なにこれ？みたいな表情をしたのがおもしろくて、初見ならびっくりするよなと私も入ったときにそんな顔をしていたのだろうとおもしろかった。入り終えてからから街並みをぶらぶらしながら <a href=https://tabelog.com/hyogo/A2808/A280801/28028485/>カフェこやま</a> さんでモーニングを食べた。懐かしい雰囲気。その後、さらに街並みを20-30分ほどぶらぶら散歩して戻ってきた。朝から徒歩で出かけてお風呂に入って2時間ほど時間が経っていた。</p><figure><img src=/diary/img/2022/0604_food1.jpg></figure><h2 id=わたなべさん合流>わたなべさん合流</h2><p>宿に戻ってきて10-12時まで作業をしていた。12時半にわたなべさんが来られるので城崎温泉駅で出迎えて一緒にお昼ご飯を食べた。この時点で4人の全参加者が揃った。駅前でカニとろろ丼を食べておいしかった。</p><figure><img src=/diary/img/2022/0604_food2.jpg></figure><p>宿に戻ってきて13-15時まで私は雑談していた。今回の合宿の一番の私の収穫として次のことを学んだ。はらさんと話していたときにふとこんなことを聞いた。</p><blockquote><p>作業は自宅やオフィスで黙々と時間をかければできるけど、そうじゃないもの、なにを作るかがそもそも明確ではないものを考えるときは移動しながら考えていることが多い。</p></blockquote><p>はらさんはデザインのお仕事をされているので、ひらめきが必要なお仕事も多いのだろうと推測する。その話しを聞いてから、私も神戸に戻ってできる作業は後回しにして、普段やらないことや課題が曖昧なことの考えごとに取り組もうと姿勢を改めた。書きものをしながら、主には他のメンバーと雑談していた気がする。</p><h2 id=晩ご飯の買い出し>晩ご飯の買い出し</h2><p>一棟貸しの宿を借りたのでせっかくだから自炊してみんなで鍋をやろうと考えた。城崎温泉の注意点としてお店が早く閉まる。市場は17時、他のお土産屋さんや喫茶店も18時にはほぼ閉まっていたように思える。もしかしたら、6月は閑散期らしく観光客も少なかったためにそうしていたのかもしれない。そのため、15時半から買い出しに出掛ける。</p><p><a href=https://www.okesyo.com/>おけしょう鮮魚</a> さんで海のものを購入する。店員さんに話しかけると、陳列していないお魚をいろいろ紹介してくれた。残念ながら、いまはカニの季節ではなく、松葉ガニは3月末に、紅ズワイガニ (香住ガニ) は5月末に漁が終わっているという。紅ズワイガニのゆでたものだけ置いてあったが、ゆでてあるカニを鍋にすると味が薄くなるだけと話されていた。いまは漁の季節ではないから生のカニが手に入らなくてカニ鍋をするにはむかないと教えてくれた。方針を転換して、真鱈と地元の魚を選んで切り身を見繕ってもらった。このときにお魚やさんに「骨を取って」と伝える方がよかったことを学んだ。私は滅多に魚を買わないのでそういう機微を知らなかった。あと1つ400円ぐらいの地元で取れたはまぐりを4つ購入した。魚屋さんが言うには、中国産の安いものもあるからそれでも味はそんなに変わらないよと気遣ってくれたけど、せっかく来たので地元のものを食べたいと思って値段の高い地元のはまぐりを買うことに決めた。魚を捌くのに15分ほどかかるので次の買い出しへ向かう。<a href=https://kinosaki-spa.gr.jp/directory/wada-ya/>和田屋</a> さんで鍋に入れる野菜やきのこ、糸こんにゃくを買う。白飯も置いてた。お惣菜も少し売っている。<a href=https://kinosaki-spa.gr.jp/directory/okamoto/>岡本酒店</a> さんで店長おすすめのそのお店オリジナルの日本酒を購入した。最後に <a href=https://www.ekiten.jp/shop_5101588/>ミニフレッシュ</a> で足りないもの、お茶などを購入した。ここは普通のスーパーになる。</p><p>1時間ほどで買い出しを完了した。温泉街の中心地にある宿の立地がよいので徒歩で十分に買い出しできた。車であちこち行くのかと想像していたのでとても楽だった。</p><h2 id=夜風呂と海鮮鍋>夜風呂と海鮮鍋</h2><p>買い出しを終えてから少し作業をして17時半ぐらいから「御所の湯」へ出掛ける。目の前に小さい川 (滝) を眺めながらお風呂に入れてよかった。「一の湯」の洞窟と匹敵する自然の風情を活かしたお風呂になっていた。その帰りに <a href=https://kinosaki-spa.gr.jp/directory/center-yugijo/>センター遊技場</a> が開いてたので入ってみた。昔ながらの射的があってやっているのを眺めてた。</p><figure><img src=/diary/img/2022/0604_shooting1.jpg></figure><p>お風呂から宿に戻って海鮮鍋を作り始めた。19時前後かな。アラで取った出汁と購入した出汁を組み合わせ、あとは野菜やきのこ、魚を入れて煮込むだけ。調理は簡単だったし、すぐにできた。食べながら魚を追加で入れたり、最後に白飯を入れて雑炊を作ったりして、みんなでわいわい作る楽しさもあって、やや不格好だったものの味はおいしかったと思う。一応、はまぐりの砂抜きも2-3時間ほどやってみて、砂が抜けたかどうかよくわからなかったけど、食べてみて砂を感じなかったので大丈夫だったと思う。もしかしたら魚屋さんでやっていたのかもしれない。和田家さんでポン酢も買っておいたけれど、出汁だけでそのまま食べてもおいしかったので、ポン酢はあまり使われなかった。岡本酒店さんの限定日本酒も甘口で奥深さのあるおいしい日本酒だった。お土産にもよさそうかな。鍋にもあっていたと思う。</p><p><figure><img src=/diary/img/2022/0604_food3.jpg></figure><figure><img src=/diary/img/2022/0604_food4.jpg></figure><figure><img src=/diary/img/2022/0604_food5.jpg></figure><figure><img src=/diary/img/2022/0604_food6.jpg></figure></p><h2 id=夜散歩>夜散歩</h2><p>21時過ぎにお茶がなくなったので買い出しも兼ねて夜散歩してきた。温泉街の中心地を川が流れていて、その左右に柳とライトアップが見栄えよく、きれいだという話しを聞いたのでみんなで散歩しながら眺めてきた。6月という季節は、暑くも寒くもなくてちょうどよかったと思う。城崎温泉は徒歩で行ける街並みの景観がよいので老若男女誰でも楽しめる場所のように思えた。たぶん温泉街ってそういうものかな。</p><p><figure><img src=/diary/img/2022/0604_view1.jpg></figure><figure><img src=/diary/img/2022/0604_view2.jpg></figure><figure><img src=/diary/img/2022/0604_view3.jpg></figure></p><h2 id=プレゼン大会と出前ラーメン>プレゼン大会と出前ラーメン</h2><p>22時から親睦も兼ねてのプレゼン大会。みんなに何か話すネタを作ってきてとお願いしていたのでみんなちゃんと作ってきてくれてた。はらさんはこの合宿で取り組んだ <a href=https://www.oreilly.co.jp/books/9784873119342/>スマートコントラクト入門</a> の話し、すみよしさんは <a href=https://sannomiya.dev/>三ノ宮.dev</a> を3年以上、運営してきてわかった話し、わたなべさんはやってきた研究と貿易統計からみる日本の経済動向の話し、それぞれが個性や特性を出していて、とてもおもしろかった。少ない人数でやると深い質疑応答のやり取りも出来たりしてよい。全然違うバックボーンをもった参加者同士が、自由に発表していたのでみんな違う話しでとてもよかったと思う。私は最近デザイナーさんに作ってもらったスライドマスターを使って、会社紹介を作りつつ、課題管理をビジネスとしてやってみたいという話しをした。話題がちょっと堅かったかもしれないなとも思えたが、プレゼン大会が終わってからその夜にわたなべさんと3時まで課題管理がどうのこうとか、ビジネスの展開について雑談していた。その後の雑談ネタにもなってよかったのかもしれない。</p><p><figure><img src=/diary/img/2022/0604_presentation1.jpg></figure><figure><img src=/diary/img/2022/0604_presentation2.jpg></figure></p><p>プレゼン大会の途中で wifi の調子が悪くなって、プロジェクターとラップトップの接続がうまくいかなかったりもした。午後からネットワークも不安定で繋がらないときもあったりしたのでルーターの再起動をできるとよかったのかもしれない。次回があれば、管理人さんにそういった状況を想定して、ルーターの場所を聞いておいて、うちらが再起動してもいいかどうかを確認しておいてもよかったのかもしれない。</p><p>余談だけど、プレゼン大会の途中で <a href=https://tabelog.com/hyogo/A2808/A280801/28011388/>宮政ラーメン</a> という宅配ラーメン？で出前をとったりもした。電話で注文すると、宿まで来てくれて、その場で屋台ラーメンを作ってくれる。この店主は37年やっているらしい。みんな油そばを頼んでいておいしかったみたい。私はお腹いっぱいだったし、この時間 (0時) に食べると次の日に胃もたれで辛そうかなと思って今回は断念した。営業時間は21時から翌1時。もうちょっと早い時間に気付いて注文すればよかったかもしれない。</p><p><figure><img src=/diary/img/2022/0604_food7.jpg></figure><figure><img src=/diary/img/2022/0604_food8.jpg></figure></p><p>プレゼン大会を終えてから海鮮鍋の片付けをした。0時回っていてちょっと疲れたなという印象もあったのでもうちょっと時間の配分や段取りをうまくできればよかったと思う。次回への反省点かな。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0603/>ワーケーション 1日目</a></h1><div class=post-meta><span class=post-date>2022-06-03</span></div><span class=post-tags>#<a href=/diary/tags/founding/>founding</a>&nbsp;
#<a href=/diary/tags/workcation/>workcation</a>&nbsp;</span><div class=post-content><p>23時に寝て6時に起きた。</p><h2 id=三ノ宮から城崎温泉への移動>三ノ宮から城崎温泉への移動</h2><p>8時前にレンタカーを借り、途中で同乗者のすみよしさんを拾ってから城崎温泉へと向かう。途中、丹羽市の氷上というパーキングエリアで15分ほど休憩した。よく知らない道を運転しているとどこのパーキングエリアで休憩していいかわからなくなる。事前に休憩する場所を調べておく必要があったことに気付いた。もともとかなり余裕をもったスケジュールで運転していたものの、普通に高速道路を運転していると10時半ぐらいには城崎温泉の近くまで着いていた。宿の管理人さんには12時前後と伝えていたのでかなり早過ぎる。寄り道しようということで近くの玄武洞に行ってみることにした。残念ながら展示している岸壁の工事をしていてあまり景観はよくなかったけど、軽いハイキングのような感覚で玄武洞周りの公園を歩いたり、ミュージアム (というよりはお土産さんみたい印象) で様々な石をみたりもできた。</p><p><figure><img src=/diary/img/2022/0603_genbudo1.jpg></figure><figure><img src=/diary/img/2022/0603_genbudo2.jpg></figure><figure><img src=/diary/img/2022/0603_genbudo3.jpg></figure></p><h2 id=きのいえのチェックイン>きのいえのチェックイン</h2><p>30分強ほど玄武洞で時間を潰して11時半頃に城崎温泉の <a href=https://kinosaki-kinoie.com/index.html>きのいえ</a> に辿り着いた。何度か道を間違えてうろうろしたりもした。初めて行く場所は道を間違えることも計算に入れて少し早めに行くぐらいでちょうどよい時間帯になるのかもしれない。2泊3日で城崎温泉唯一の一棟貸しの宿を借りた。本来のチェックインは15時からになるものの、管理人さんの計らいで特別に12時にチェックインの手続きをしてくれた。宿に到着して電話すると15分ぐらいでやってきて、宿泊者のワクチン摂取確認と本人確認を行い、その後に宿泊料を私がクレジットカードで一括で支払った。これは <a href=https://www.hyogo-tourism.jp/furusato-ouen/>ひょうごを旅しようキャンペーン＋(プラス)</a> で割引を受けるためにワクチン摂取証明と本人確認が厳しいという背景。事務手続きを終えて施設の説明を一通り受ける。管理人さんは見た目30歳前後の若い方で、普段はカーテン職人として働きながら週末だけきのいえの管理人をやっているという。週末起業みたいなものかもしれない。とても親切な方で丁寧に設備の説明をしてくれて、付近のおすすめのお店や城崎温泉での過ごし方なども教えてくれた。</p><p><figure><img src=/diary/img/2022/0603_hotel1.jpg></figure><figure><img src=/diary/img/2022/0603_hotel2.jpg></figure></p><h2 id=はらさん合流と午後の作業>はらさん合流と午後の作業</h2><p>13時前に千葉から来られたはらさんを城崎温泉駅で出迎えて一緒にお昼ご飯を食べた。但馬牛の牛すじ丼とうどんを食べた。おいしろかった。宿に戻っていたらお手伝い先のミーティングが入っていることに気付く。1時間ほどテレビ会議でややこしい内容の方向性の議論をして、その後もチケットの作業をしていた。17時ぐらいから sns でシェアするときの ogp 画像のデザインについてはらさんに相談にのってもらった。これまでは、私が求めていたデザインに近いものを最初から提供してくれていたデザイナーさんだったが、今回は苦戦していて、最初のものは全然違うって感じでボツにして再作成してもらった。いくつかやり取りして、ある程度、近いものに修正してくれて、微調整をはらさんと一緒にしていた。はらさんのアドバイスは的確で、こうした方がよいと言われた内容をデザイナーさんに伝えて、修正してもらって、再アップロードしてもらった画像をみると、ちょっとした違いでうける印象も変わったりしてよくなった。デザイナー視点における &ldquo;見る&rdquo; ポイントがあるんだなぁと、素人の私にはわからない視点を見抜かれていたようだ。</p><figure><img src=/diary/img/2022/0603_food1.jpg></figure><h2 id=外湯めぐりと晩ご飯>外湯めぐりと晩ご飯</h2><p>17時過ぎからみんなの作業も終わったところで温泉に入りにいくことにした。<a href=https://kinosaki-spa.gr.jp/about/spa/7onsen/>7つの外湯</a> があり、まずは駅の近くの「さとの湯」に入った。2Fと3Fにお風呂があって、3種類のお風呂と3種類のサウナ (高温、中温、ミスト)、露天風呂があって、1つずつはそんなに特筆するものはないものの、いろいろ入ってみて楽しめたのでよかったと思う。すべての温泉に付属しているかは確認していないが、私が入った4つの温泉はどこも隣に足湯があって憩いの場になっていた。</p><figure><img src=/diary/img/2022/0605_footspa1.jpg></figure><p>温泉に入ってから定番のコーヒーを飲み、宿の管理人さんに紹介してもらった居酒屋 <a href=https://tabelog.com/hyogo/A2808/A280801/28017042/>ふくとみ</a> さんに行ってきた。3人で適当に見繕ってくださいという適当なオーダーでおでんとお刺身を頼んで十分な量が出てきたのでよかった。他にもおすすめはいくつかあったけれど、食べきれないので何度か通うようなお店みたい。</p><figure><img src=/diary/img/2022/0603_food2.jpg></figure><h2 id=就寝前>就寝前</h2><p>22時前には宿に戻ってきて今日の出来事をまとめていた。座椅子で低足の机に向かってラップトップを使うのは腰にくるというのを数時間で悟って、私はタイニングテーブルと椅子で作業することにした。翌日の旅程のチェックや補足事項の調査、細々したことをやっていた。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0602/>draw.io で描いたインフラ構成図</a></h1><div class=post-meta><span class=post-date>2022-06-02</span></div><span class=post-tags>#<a href=/diary/tags/diagram/>diagram</a>&nbsp;
#<a href=/diary/tags/vscode/>vscode</a>&nbsp;
#<a href=/diary/tags/infrastructure/>infrastructure</a>&nbsp;</span><div class=post-content><p>0時に寝て4時に起きて7時までだらだらしてた。なんか調子悪い。</p><h2 id=drawio-を描いてみた>draw.io を描いてみた</h2><p>先日、<a href=/diary/posts/2022/0523/>draw.io で aws 構成図を描く調査</a> をした。割り込みの作業をやっていてシステム構成図の作成を先延ばししていた。だいたいの調査は終わっていたのであとは根を詰めて描くだけ。次のサンプル構成図をみながら同じように描いていく。</p><ul><li><a href=https://aws.amazon.com/jp/builders-flash/202204/way-to-draw-architecture/>AWS のアーキテクチャ図を描きたい ! でもどうすれば良いの ?</a></li></ul><p>2つの環境があって、そのうちの1つを作成した。新規構築した環境でスクラッチから描いたものの、インフラリソースの構成要素が少なかったのでサンプル構成図を参考にしながらすぐに描けた。半角スペースで文字位置を調整したりすると、github 上で svg 表示したときに文字の位置がずれたりするのでそういうやり方はダメだとわかった。あと draw.io の振る舞いなのか、vscode のプラグインのせいなのかわからないけど、オブジェクトの配置の前後関係をうまく調整できなくてコピペし直したり、なにかの操作をしたタイミングでインフラリソースのアイコンが後ろに隠蔽されていたりもした。リソース間の接続のための線も自動的に繋がるときもあって便利なのだが、誤動作して変な位置にレイアウトされることもあって制御が難しい。私の感覚では、多少の利便性のために自動化されるよりも、自分で思い通りに制御出来る方を好む。draw.io の自動調整機能の制御が難しいなと思った。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0601/>手抜き</a></h1><div class=post-meta><span class=post-date>2022-06-01</span></div><span class=post-tags>#<a href=/diary/tags/scrum/>scrum</a>&nbsp;
#<a href=/diary/tags/information-exchange/>information exchange</a>&nbsp;
#<a href=/diary/tags/issue-tracking-system/>issue tracking system</a>&nbsp;</span><div class=post-content><p>2時に寝て6時に起きた。疲れていたからよく眠れた。</p><h2 id=mvpminimum-viable-productで対応した>mvp（minimum viable product）で対応した</h2><p>スクラムに限った話しではないと思うが、プロダクト開発をしていると mvp（minimum viable product）という言葉を聞くことがままある。昔ながらのイテレーション開発よりも、アジャイル開発の文脈でよく使われるように思う。というのは、短い開発期間でプロトタイプを作ったり、最低限の動く機能を作ったりすることをよしとする考え方があるから。昔ながらのやり方だと、イテレーション期間の中でそういった段階的な開発はするものの、外部からみたとき (もしくはマイルストーン) においてはそこそこの機能が提供されているので mvp といった言い方をすることはなかった。もしかしたらアルファとかベータとか呼んでいたかもしれない。最近ある lambda 関数の移行作業を行った。serverless framework でデプロイしていたリソースを cdk で一元管理する。その過程で既存のコードを読むと、ある id をハードコーディングで指定して <em>FIXME</em> がこんな感じに書いてあった。この id が指すリソースはその後なくなっており、本番環境で不要な処理が定期実行でずっと動き続けていたのと、本来は複数の id リソースに対して行うべき処理を実行していなかった。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># FIXME 対象 id 一覧を取得する。(Phase2までに対応します)</span>
</span></span><span style=display:flex><span>id <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;ABC001&#39;</span>
</span></span></code></pre></div><p>チームの開発リーダーはその存在を全く忘れていたし、このスクリプトを実装したさらに上位の開発リーダーからはこの処理の要否はよくわからないからチームで確認してという曖昧な返事が返ってきた。チームで確認したところ、この処理は必要だとわかり、この機に複数の id リソースに対して対応するようにした。何も知らない私が修正しても5分で対応を完了した。</p><blockquote><p>mvp で対応したんで</p></blockquote><p>このように実装者は話していたが、本当なのだろうか？と思えた。さらにこのスクリプトのエラーログのログストリームを監視して slack 通知する lambda 関数も移行対象で、コードの検証をしていたところ、slack 通知をするための lambda 関数が別途あり、その動作検証をしていたところ、その lambda 関数を呼び出す権限 <em>lambda:InvokeFunction</em> が足りないことに気付いた。これも実装者に問い合わせたところ、動作検証はやっていないし、過去に1度も slack 通知は発生していないという。状況証拠から考えると、権限が足りないために正常に動作していなかったと推測される。結果的に mvp で対応したという2つの lambda 関数は実運用で半年間、無駄にリソースを浪費して何の役にも立っていなかった。当然、引き継ぎも、課題管理システムのチケットも、ドキュメントも何ら残されていなかった。mvp で対応したという表現に開発で大事なものを誤魔化してはいないだろうか。</p></div></div><div class=pagination><div class=pagination__buttons><span class="button previous"><a href=/diary/dates/2022/06/page/3/><span class=button__icon>←</span>
<span class=button__text>最近の日記</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>© 2021 Tetsuya Morimoto</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=/diary/assets/main.js></script>
<script src=/diary/assets/prism.js></script></div></body></html>