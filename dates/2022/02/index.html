<!doctype html><html lang=en>
<head>
<title>2022/02 :: forest nook</title>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content>
<meta name=keywords content>
<meta name=robots content="noodp">
<link rel=canonical href=/diary/dates/2022/02/>
<link rel=stylesheet href=/diary/assets/style.css>
<link rel=stylesheet href=/diary/assets/green.css>
<link rel=stylesheet href=/diary/style.css>
<link rel=apple-touch-icon href=/diary/img/apple-touch-icon-192x192.png>
<link rel="shortcut icon" href=/diary/favicon.ico>
<meta name=twitter:card content="summary">
<meta name=twitter:site content="t2y">
<meta name=twitter:creator content>
<meta property="og:locale" content="en">
<meta property="og:type" content="website">
<meta property="og:title" content="2022/02">
<meta property="og:description" content>
<meta property="og:url" content="/diary/dates/2022/02/">
<meta property="og:site_name" content="forest nook">
<meta property="og:image" content="/diary/favicon.ico">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">
<link href=/diary/dates/2022/02/index.xml rel=alternate type=application/rss+xml title="forest nook">
</head>
<body class=green>
<div class="container full headings--one-size">
<header class=header>
<div class=header__inner>
<div class=header__logo>
<a href=/diary>
<div class=logo>
forest nook
</div>
</a>
</div>
<div class=menu-trigger>menu</div>
</div>
<nav class=menu>
<ul class="menu__inner menu__inner--desktop">
<li><a href=/diary/about>自己紹介</a></li>
<li><a href=/diary/dates>月別一覧</a></li>
<li><a href=/diary/tags>タグ一覧</a></li>
</ul>
<ul class="menu__inner menu__inner--mobile">
<li><a href=/diary/about>自己紹介</a></li>
<li><a href=/diary/dates>月別一覧</a></li>
<li><a href=/diary/tags>タグ一覧</a></li>
</ul>
</nav>
</header>
<div class=content>
<div class=posts>
<div class="post on-list">
<h1 class=post-title>
<a href=/diary/posts/2022/0218/>予算作り</a>
</h1>
<div class=post-meta>
<span class=post-date>
2022-02-18
</span>
</div>
<span class=post-tags>
#<a href=/diary/tags/scrum/>scrum</a>&nbsp;
#<a href=/diary/tags/founding/>founding</a>&nbsp;
</span>
<div class=post-content>
<p>23時に寝て1時半に起きてそのまま断続的に寝て起きての繰り返しで6時に起きた。本当は非稼働日だけど、昨日作った pr の機能を検証するための環境を用意してもらったのでそれを動かしたら要件漏れに気付いてその改修をやってた。</p>
<h2 id=隔週の雑談>隔週の雑談</h2>
<p>顧問のはらさんと隔週の打ち合わせの日。今日の議題は2つ。</p>
<h3 id=見積もりの雑談>見積もりの雑談</h3>
<p>先日、見積もりについての <a href=/diary/posts/2022/0213/#見積もりのまとめ>私の考え</a> を整理した。それについて第3者の意見も聞いてみたいと考えた。</p>
<p>いろいろ雑談したけど、結論としてはバーンダウンチャートもストーリーポイントも運用が形骸化したら役に立たないという当たり前の話しになった。従来の期限や工数を見積もる方法と比較して得られるメリットはそう多くないという私の印象である。ストーリーポイントが優れている唯一の点は、タスクの見積もりについて話し合う場ができるという、その機会そのものがあげられる。その機会を使ってメンバーとの情報共有や教育の場にもできるという点がある。それ以外のところでストーリーポイントのメリットはさしてないと私は感じた。</p>
<blockquote class=twitter-tweet><p lang=ja dir=ltr>ストーリーポイント(以下SP)について雑談していて、あるチームでは事前に見積もったSPをタスク完了後に実績ベースで上書きする運用をしていたという。その理由は見積もったSPに対して進捗や実績が悪いと偉い人からお叱りを受けるため、SPが正しくなかったという解釈で実績から変更しているという。</p>&mdash; Tetsuya Morimoto (@t2y) <a href="https://twitter.com/t2y/status/1494511584378769408?ref_src=twsrc%5Etfw">February 18, 2022</a></blockquote>
<script async src=https://platform.twitter.com/widgets.js></script>
<h3 id=来期の予算策定>来期の予算策定</h3>
<p>ざっくり試算すると来期は少し赤字になる。経営者として赤字にならないようの対策を講じる。私が予め用意した施策は次の3つ。</p>
<ol>
<li>既存顧客のお仕事の単価をあげる</li>
<li>赤字分の売上を別のお仕事で稼ぐ</li>
<li>赤字分の経費を削減する</li>
</ol>
<p>はらさんから役員報酬を下げてはどうか？という提案もあったけど、これは却下しようと思う。もともと役員報酬は高くないし、役員報酬を下げると必然的に健康保険や社会保険の再計算やそれらに関連する事務手続きが発生する。いま私は会計士も税理士も雇わず自分ですべてやっているのだけど、専門家に依頼するにしろ、自分でやるにしろ、経費を下げるために別の経費を発生させてしまう。これは本末転倒な気がしてやりたくない。</p>
<p>したがって、お仕事の単価をあげる交渉からまず始めることにする。私はずっと開発者で働いてきたから交渉ごとはほとんど経験がない。交渉の経験を積むという側面でも自分のキャリアにとって新しい取り組みになってよいと考えている。次の契約更新は3月末になるのでそれまでに交渉のための準備を進めていく。</p>
</div>
</div>
<div class="post on-list">
<h1 class=post-title>
<a href=/diary/posts/2022/0217/>Mockito を触ってみた</a>
</h1>
<div class=post-meta>
<span class=post-date>
2022-02-17
</span>
</div>
<span class=post-tags>
#<a href=/diary/tags/java/>java</a>&nbsp;
#<a href=/diary/tags/mock/>mock</a>&nbsp;
#<a href=/diary/tags/testing/>testing</a>&nbsp;
</span>
<div class=post-content>
<p>0時に寝て4時に起きて6時に起きた。6時過ぎに slack でインフラ担当者から作業の報告があってその対応してた。</p>
<h2 id=mockito-のモック作成>Mockito のモック作成</h2>
<p><a href=https://www.baeldung.com/spring-5-webclient>Spring 5 WebClient</a> のテストコードを書いてみた。<a href=https://site.mockito.org/>Mockito</a> というモックライブラリを使っているのをみかけたのでそれを使うことにした。当初は WebClient そのもののモックを用意して、どんなメソッドを呼び出しても Null オブジェクトのように無視すればいいんじゃないかと思ってたんだけど、Mockito はそういう用途に使うものではなく、それぞれのメソッドごとにモックを返すような設定ができる。次のような WebClient のメソッドチェーンでリクエストするようなモックを考える。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>var response <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>client</span>
        <span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>()</span>
        <span style=color:#f92672>.</span><span style=color:#a6e22e>uri</span><span style=color:#f92672>(</span>uriBuilder <span style=color:#f92672>-&gt;</span> uriBuilder
                <span style=color:#f92672>.</span><span style=color:#a6e22e>path</span><span style=color:#f92672>(</span>path<span style=color:#f92672>)</span>
                <span style=color:#f92672>.</span><span style=color:#a6e22e>queryParam</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;param&#34;</span><span style=color:#f92672>,</span> param<span style=color:#f92672>)</span>
                <span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>())</span>
        <span style=color:#f92672>.</span><span style=color:#a6e22e>retrieve</span><span style=color:#f92672>()</span>
        <span style=color:#f92672>.</span><span style=color:#a6e22e>bodyToMono</span><span style=color:#f92672>(</span>MyResponse<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span>
        <span style=color:#f92672>.</span><span style=color:#a6e22e>block</span><span style=color:#f92672>();</span>
</code></pre></div><p>他にもっとよいやり方があるかもしれないけど、私がよくわかってなくてこんなやり方しかできなかった。最終的には <code>block()</code> を呼び出したときに任意のレスポンスを取得できればよいのだけど、メソッド単位にモックを呼び出していかないと型チェックやら実行時エラーやらで意図したようにテストできなかった。これだけをみたらメソッドチェーンのモック作りは面倒にみえる。Mockito がどうやってこれを実現しているのかわからないけど、すごい仕組みだなとは思った。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#a6e22e>@MockBean</span>
    WebClient client<span style=color:#f92672>;</span>
    <span style=color:#a6e22e>@Mock</span>
    WebClient<span style=color:#f92672>.</span><span style=color:#a6e22e>RequestHeadersUriSpec</span> requestHeadersUriSpec<span style=color:#f92672>;</span>
    <span style=color:#a6e22e>@Mock</span>
    WebClient<span style=color:#f92672>.</span><span style=color:#a6e22e>RequestHeadersSpec</span> requestHeadersSpec<span style=color:#f92672>;</span>
    <span style=color:#a6e22e>@Mock</span>
    WebClient<span style=color:#f92672>.</span><span style=color:#a6e22e>ResponseSpec</span> responseSpec<span style=color:#f92672>;</span>
    <span style=color:#a6e22e>@Mock</span>
    Mono<span style=color:#f92672>&lt;</span>MyResponse<span style=color:#f92672>&gt;</span> mono<span style=color:#f92672>;</span>

    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>mockWebClientMethodChain</span><span style=color:#f92672>(</span>MyResponse response<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        Mockito<span style=color:#f92672>.</span><span style=color:#a6e22e>when</span><span style=color:#f92672>(</span>client<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>()).</span><span style=color:#a6e22e>thenReturn</span><span style=color:#f92672>(</span>requestHeadersUriSpec<span style=color:#f92672>);</span>
        Mockito<span style=color:#f92672>.</span><span style=color:#a6e22e>when</span><span style=color:#f92672>(</span>requestHeadersUriSpec<span style=color:#f92672>.</span><span style=color:#a6e22e>uri</span><span style=color:#f92672>((</span>Function<span style=color:#f92672>&lt;</span>UriBuilder<span style=color:#f92672>,</span> URI<span style=color:#f92672>&gt;)</span> Mockito<span style=color:#f92672>.</span><span style=color:#a6e22e>any</span><span style=color:#f92672>())).</span><span style=color:#a6e22e>thenReturn</span><span style=color:#f92672>(</span>requestHeadersSpec<span style=color:#f92672>);</span>
        Mockito<span style=color:#f92672>.</span><span style=color:#a6e22e>when</span><span style=color:#f92672>(</span>requestHeadersSpec<span style=color:#f92672>.</span><span style=color:#a6e22e>retrieve</span><span style=color:#f92672>()).</span><span style=color:#a6e22e>thenReturn</span><span style=color:#f92672>(</span>responseSpec<span style=color:#f92672>);</span>
        Mockito<span style=color:#f92672>.</span><span style=color:#a6e22e>when</span><span style=color:#f92672>(</span>responseSpec<span style=color:#f92672>.</span><span style=color:#a6e22e>bodyToMono</span><span style=color:#f92672>(</span>MyResponse<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)).</span><span style=color:#a6e22e>thenReturn</span><span style=color:#f92672>(</span>mono<span style=color:#f92672>);</span>
        Mockito<span style=color:#f92672>.</span><span style=color:#a6e22e>when</span><span style=color:#f92672>(</span>mono<span style=color:#f92672>.</span><span style=color:#a6e22e>block</span><span style=color:#f92672>()).</span><span style=color:#a6e22e>thenReturn</span><span style=color:#f92672>(</span>response<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>
</code></pre></div>
</div>
</div>
<div class="post on-list">
<h1 class=post-title>
<a href=/diary/posts/2022/0216/>ふりかえりとプランニング</a>
</h1>
<div class=post-meta>
<span class=post-date>
2022-02-16
</span>
</div>
<span class=post-tags>
#<a href=/diary/tags/scrum/>scrum</a>&nbsp;
#<a href=/diary/tags/ssue-tracking-system/>ssue tracking system</a>&nbsp;
</span>
<div class=post-content>
<p>1時に寝て3時過ぎに起きて6時半に起きた。</p>
<h2 id=ふりかえり>ふりかえり</h2>
<p>今日はスクラムのふりかえりとプランニングの日。1週間が終わり始まる。ふりかえりをしていて、2週連続でスプリントゴールが未達になって、原因を追究する空気になって、最終的にはリーダーを糾弾するみたいな雰囲気になった。昔の私だったら論理的に問題を掘り起こそうとがんばったかもしれないけど、いまはもう歳をとってスラムダンクの安西先生みたいになったのか、もしくは外部パートナーとしてのお手伝いだから真剣ではないのか、その両方かもしれないが、一歩引いたところからできなかったもんしゃーないんちゃう？みたいな心境で見守っていた。うまくできない人や状況に「なぜできなかった？」みたいに迫ると「努力が足りなかった」とか「もっとがんばります」みたいなやり取りしかならないので不毛にみえる。経営者のくせにこんなことを言うと怒られるかもしれないが、仕事なんてやりたい人やできる人が楽しめるように好き勝手やって、そうじゃない人は最低限やるとか、邪魔しないように配慮するとか、もうそれでいいんじゃないとか思ったりもしている。もう人類は会社の半分ぐらいの社員が遊んでても暮らしていけるぐらいの生産性を手に入れたと思うよ。半分は言い過ぎか。いずれにしても私はもう無理なく自分のペースで働きたいと思うようになった感じ。</p>
<h2 id=backlog-の管理者権限>backlog の管理者権限</h2>
<p>お手伝い先で <a href=https://backlog.com/ja/>backlog</a> を課題管理システムに使っている。私は課題管理システムのスペシャリストとして、ああしたい、こうしたいといくつも注文を付けて、チームの開発やワークフローを改善している。これまでは管理者権限がなかったのでもっている人に依頼するしかなかったけど、そろそろ私の相手をするのが面倒くさくなってきたのか、私にも backlog の設定を変更する管理者権限をもらえた。さっそくカスタム属性をいくつか作って実験的な検証をしていた。カスタム属性は backlog のフリープランでは使えない機能なので、お手伝い先の実地で用途や振る舞いを検証するしかない。同じプロジェクトでも種別ごとにカスタム属性の設定有無を切り分けられる機能があって、この機能は他の課題管理システムでみたことがない実用的で珍しい機能だと思った。チケットに PR とコミットのカスタム属性を追加して、github actions でコミットや PR のタイミングでそれらの属性に URL を追加すれば github 連携もできそうな気がしてきたところ。週末に時間があったら作ってみる。</p>
</div>
</div>
<div class="post on-list">
<h1 class=post-title>
<a href=/diary/posts/2022/0215/>担々麺がおいしい</a>
</h1>
<div class=post-meta>
<span class=post-date>
2022-02-15
</span>
</div>
<span class=post-tags>
#<a href=/diary/tags/food/>food</a>&nbsp;
</span>
<div class=post-content>
<p>0時に寝て4時に起きて6時半に起きた。今回のスプリントは1つの機能拡張のチケットに専念していてとても疲れた。</p>
<h2 id=担々麺>担々麺</h2>
<p>オフィスの近くに <a href=https://tabelog.com/hyogo/A2801/A280102/28061761/>珠しっぴん</a> という坦々麺専門店ができているのに気付いた。半年ぐらい前にオープンしたらしい。あまり通らない場所だったせいか、全然気付いてなくて試しに入ってみたら私の好みの味でとてもおいしかった。食わず嫌いだったのか何なのか、昨年ぐらいまで担々麺はほとんど食べたことなかったんだけど、近所においしい担々麺のお店がいくつかできて、担々麺そのものも好きになってきた。新しい担々麺のお店をみかけるととりあえず入ってみるようになった。</p>
<h4 id=珠辛担々麺>珠辛担々麺</h4>
<figure><img src=/diary/img/2022/0215_noodle1.jpg>
</figure>
<h4 id=汁なし担々麺>汁なし担々麺</h4>
<figure><img src=/diary/img/2022/0215_noodle2.jpg>
</figure>
</div>
</div>
<div class="post on-list">
<h1 class=post-title>
<a href=/diary/posts/2022/0214/>取材商法というビジネス</a>
</h1>
<div class=post-meta>
<span class=post-date>
2022-02-14
</span>
</div>
<span class=post-tags>
#<a href=/diary/tags/business/>business</a>&nbsp;
</span>
<div class=post-content>
<p>1時半に寝て5時半に起きた。いよいよ眠れなくなった感じだな。</p>
<h2 id=取材商法の営業>取材商法の営業</h2>
<p>会社の問い合わせのメールアドレスに取材させてほしいといった問い合わせが届いた。うちみたいな無名の零細会社になんの前触れもなく届く問い合わせの大半は営業に関するもの。</p>
<blockquote>
<p>※撮影・インタビュー記事の掲載にあたりまして、費用等は一切発生しませんので、ご安心くださいませ。</p>
<p>WEBにて、お写真と記事でご紹介させていただきたいと考えております。</p>
</blockquote>
<p>こんな感じで取材の費用はいりませんと言っている。<a href=https://marketing.idegene.com/%E8%A8%98%E4%BA%8B%E5%BA%83%E5%91%8A_%E5%8F%96%E6%9D%90%E5%95%86%E6%B3%95_%E9%9B%91%E8%AA%8C%E6%8E%B2%E8%BC%89%E3%81%AF%E5%8A%B9%E6%9E%9C%E7%9A%84>記事広告と取材商法(タレントインタビュー)で雑誌掲載の効果は？</a> によると、取材は無料かもしれないが、メディアや雑誌といった媒体に掲載するのに料金を請求するらしい。まさにこの記事で書かれている会社からのメールだ。取材して記事ができてしまうとサンクコストが気になって掲載料を支払ってしまうような心理を利用しているのだと推測する。</p>
<p>いろんなビジネスがあるなぁと世の中の勉強になった。</p>
</div>
</div>
<div class="post on-list">
<h1 class=post-title>
<a href=/diary/posts/2022/0213/>java のコードレビューサービス</a>
</h1>
<div class=post-meta>
<span class=post-date>
2022-02-13
</span>
</div>
<span class=post-tags>
#<a href=/diary/tags/java/>java</a>&nbsp;
#<a href=/diary/tags/refactoring/>refactoring</a>&nbsp;
#<a href=/diary/tags/scrum/>scrum</a>&nbsp;
#<a href=/diary/tags/issue-tracking-system/>issue tracking system</a>&nbsp;
</span>
<div class=post-content>
<p>22時に寝て0時に起きて5時に起きて7時に起きた。なんか体調が微妙。</p>
<h2 id=リファクタリングのチケット作成>リファクタリングのチケット作成</h2>
<p>これまでは業務に関係しないところの機能拡張をしていたので新規にコードを書くことが多かった。いま業務の開発にも着手し始め、その過程で既存のコードを読むことも多くなった。私からみたらコードの品質が著しく低くて、ただ動いているだけで堅牢でもないし、設計の意図も伝わらないコードが多い。そういうのを自分が変更するときに少しずつ出来る範囲でリファクタリングしたりしている。今日もコードを読んでいて enum の扱いについてチケットを作成した。</p>
<p>前に手伝っていた会社の契約を終了するときに java のコードレビューだけなんらかの契約で依頼できないかという話しはあった。そのときは別件のお仕事が火の車だったので断ってしまった。いまお手伝いしている java のコードをみても、java に慣れていない開発者の書く java のコードはたいていひどい。なぜひどくなるかというと、java は言語仕様が複雑で難しいからだと思う。java の経験が少ないと Effective Java を読んでも理解できないぐらいには java の設計は難しい。その結果として java で開発しているのに設計を練っておらず「動けばいい」コードが散見される。java で開発するなら「これ以外に動かない」コードを書いた方がよいと私は考えている。その意図が伝わるからドキュメントなんか読まなくても「動かすにはこう書けばいい」とわかる。さらにインターフェースが明確であれば、責務や拡張方法も明示的になる。</p>
<p>前から考えてはいたけど、sier や内製始めたばかりの事業会社向けに java のコードレビューのサービスを提供することも考えている。私1人だとたくさん受けられないし、コードレビューサービスのようなものは会社の信頼関係の方が重要なのでビジネスにするのはちょっと難しいかもなぁ。</p>
<h2 id=見積もりのまとめ>見積もりのまとめ</h2>
<p>先日 <a href=/diary/posts/2022/0205/##見積もりとは>見積もりについて考察した</a> 。もともとは社内向けに書こうと書き始めたが、内容の大半は社内に閉じたものではなかったので一般論の記事として書き直した。最終的には1万文字ぐらい書いた。</p>
<ul>
<li><a href=https://t2y.hatenablog.jp/entry/2022/02/13/191235>見積もりをがんばらない</a></li>
</ul>
</div>
</div>
<div class="post on-list">
<h1 class=post-title>
<a href=/diary/posts/2022/0212/>mysql のデータ移行</a>
</h1>
<div class=post-meta>
<span class=post-date>
2022-02-12
</span>
</div>
<span class=post-tags>
#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/docker/>docker</a>&nbsp;
#<a href=/diary/tags/mysql/>mysql</a>&nbsp;
#<a href=/diary/tags/event/>event</a>&nbsp;
</span>
<div class=post-content>
<p>23時に寝て2時前に起きて5時に起きて8時に起きた。あんまり眠れなくなってきた。</p>
<h2 id=もくもく会>もくもく会</h2>
<p><a href=https://kobe-sannomiya-dev.connpass.com/event/235747/>【三宮.dev】もくもく会</a> に参加した。もともとオフラインの予定だったけど、オミクロン株の流行でオンラインに変更された。</p>
<p>お仕事である開発環境の構築をしていて docker-compose を使って mysql の環境構築や共有の開発環境にある db2 に接続するために <a href="https://www.ibm.com/docs/en/db2/10.5?topic=commands-command-line-processor-plus-clpplus">clpplus</a> のインストール方法などを wiki にまとめてた。コンテナにある mysqldump や mysql コマンドを使ってこんな風にデータ移行もできた。</p>
<p>共有の開発環境からデータをエクスポート。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ docker-compose exec -T mydb mysqldump -h $DB_HOST -C --set-gtid-purged<span style=color:#f92672>=</span>OFF --skip-triggers $DB &gt; dump.sql
</code></pre></div><p>ローカルの mysql にデータをインポート。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ docker-compose exec -T mydb mysql -h localhost -u root -proot $DB &lt; dump.sql
</code></pre></div><blockquote class=twitter-tweet><p lang=ja dir=ltr>コンテナにある mysqldump と mysql コマンドを使ってデータのインポートするには -T を指定すればいいみたい。そうしないと WARNING とかの文字列が sql ファイルに含まれてしまってインポートできない。<a href=https://t.co/JGeDNsWjhx>https://t.co/JGeDNsWjhx</a></p>&mdash; Tetsuya Morimoto (@t2y) <a href="https://twitter.com/t2y/status/1492391598612959234?ref_src=twsrc%5Etfw">February 12, 2022</a></blockquote>
<script async src=https://platform.twitter.com/widgets.js></script>
<h2 id=ストレッチ>ストレッチ</h2>
<p>いつもは11時からなんやけど、今日は17時40分からだった。カレンダーの予定を変更し忘れてて11時に行って間違えた。今週は2日間ぐらいストレッチしたかな。今日の開脚幅は開始前164cmで、ストレッチ後168cmだった。いつも時間帯が違うので数値も変わる。今日は右太ももの内転筋や内側やらがすごく張ってた。あまり調子はよくない。</p>
</div>
</div>
<div class="post on-list">
<h1 class=post-title>
<a href=/diary/posts/2022/0211/>docker の勉強</a>
</h1>
<div class=post-meta>
<span class=post-date>
2022-02-11
</span>
</div>
<span class=post-tags>
#<a href=/diary/tags/docker/>docker</a>&nbsp;
#<a href=/diary/tags/founding/>founding</a>&nbsp;
</span>
<div class=post-content>
<p>0時に寝て2時過ぎに起きて5時に起きて6時に起きた。珍しく3回ぐらい起きた。</p>
<h2 id=docker-のマルチステージビルド>docker のマルチステージビルド</h2>
<p>これまで docker を使った開発を主導してこなかったので私はあまり docker についての知識をもっていない。いま k8s クラスターで java アプリケーションの運用をしていて、リリース作業の改善には docker イメージのビルドも改善する必要性が迫られてきた。いくつかプラクティスの記事を読んでいると <a href=https://matsuand.github.io/docs.docker.jp.onthefly/develop/develop-images/multistage-build/>マルチステージビルドの利用</a> を推奨している記事が多い。マルチステージビルドをうまく活用することで、docker イメージサイズの削減と日々の ci やビルド時間の短縮の2つを図れるようにみえる。docker の仕組みを学ぶちょうどよい機会なので主導的な立場でこの改善に着手しようと考えている。</p>
<h2 id=オフィス内覧>オフィス内覧</h2>
<p>オフィスの引っ越し調査のために <a href=https://www.erinserve.com/>エリンサーブ</a> に行ってきた。駅近でもなく市街でもなくちょっと辺鄙な海外沿いにあるせいか、他のレンタルオフィスと比べて全体的に広さに対する家賃は安く設定されている。案内をしてくれた代表の方が「狭い部屋で働かせたくない」といった想いを話されていたので、意図的に窮屈なスペースにならないように広めに設計されているらしい。</p>
<p>オープンスペースでそれぞれの席が別会社という作りは斬新な考えとも言えるし、お互いの信頼関係で成り立っているとも言える。例えば、パソコンのモニターや資料とか、近くを通ったらみえてしまうわけだし。そういったセキュリティも考慮して、一見さんのドロップインには対応していないという。利用者はお互いに面識のある一定の信頼関係を築ける人たちで構成されているらしい。なにか審査があるのかどうかわからないが、人間関係が苦手な人には向かないスペースにもみえる。私は1日のうちにテレビ会議を何度もやるのでオープンスペースだと顧客の情報を守る義務があるのと、そうじゃなくても周りにも迷惑がかかるので、1日のうちの何度も場所を変えてテレビ会議できる部屋に移動しないといけない。それがボトルネックだなと思えた。個室もいくつかみせてもらって、2人向けの窓のある個室があってよさそうにみえた。そこはテレビ会議しても問題ないとのこと。家賃も予算にあうものだった。</p>
<p>Dタイプ(3F)</p>
<ul>
<li>月額利用料: 66,000円</li>
</ul>
<p>Eタイプ(3F)</p>
<ul>
<li>デスクは2つ</li>
<li>月額利用料: 76,000円</li>
</ul>
<p>いまは他の会社が借りている状態だけど、空きが出たら教えてもらえるようにお願いして帰ってきた。</p>
</div>
</div>
<div class="post on-list">
<h1 class=post-title>
<a href=/diary/posts/2022/0210/>スクラムの窮屈さ</a>
</h1>
<div class=post-meta>
<span class=post-date>
2022-02-10
</span>
</div>
<span class=post-tags>
#<a href=/diary/tags/scrum/>scrum</a>&nbsp;
</span>
<div class=post-content>
<p>0時に寝て5時に起きてちょっとだらだらして7時ぐらいにはオフィスにいた。</p>
<h2 id=スプリントの期間とプランニング>スプリントの期間とプランニング</h2>
<p>いまスクラムのスプリントを1週間で運用している。スクラムのスプリントレビューをやっていて、今回のスプリントはスプリントゴールが未達となったという事実がありつつも、ある開発者が本来のスプリント計画にはなかった課題を少し工数を使ってやってしまってたという話題が出た。それはある機能開発の調査の過程でこういうツールがあると業務メンバーの作業効率が上がりそうだとわかって、それをヒアリングしていた開発者が PoC も兼ねてプロトタイプを作っているうちにすぐ運用で使えそうなベータレベルまで作ってしまったという話し。言うても2日ぐらいで作ったと思うのだけど、5日しかないスプリントで2日は40%という大きな工数を占める。スクラムマスターも否定はしなかったけど「スプリントの計画にないタスクに工数を割くのはよくないと、スクラムマスターの立場からはお小言を言わざるを得ない」と言及した。</p>
<p>先日、私も直接はスプリントの計画達成に直接寄与しない <a href=/diary/posts/2022/0208/#テストコードのリファクタリング>リファクタリングに半日を費やした</a> ので、ツールを作ってしまった開発者の気持ちはわかるなと無言で聞いていた。それと同時にスクラムのスプリントは、運用によっては開発者のモチベーションを削ぐことも実感した。やる気の有無で仕事をするのはよくないと一般論では言うけど、実際のところ、人間のモチベーションは制御が難しいのと、知識労働はモチベーションが生産性に大きな影響を与える。開発者のモチベーションが高いときにそのタスクをやるのは理に叶うという側面もある。非開発者は次のプランニングで承認を得て来週のスプリントでやればいいじゃないかと思うかもしれない。でも、違うのだ。いまやってみたいという気持ちが大きいときにいまやるのと来週やるのではモチベーションが異なる可能性がある。この気持ちは開発者にしかわからないと思う。</p>
<p>その開発者がデイリースクラムでツール開発をやることを相談しなかったかの理由も理解できて、合理的に考えたら相談しても承認を得るのは難しいので、黙ってやってしまったのだろうと思う。そして、今回のスプリントのスプリントゴールが未達になったとしても、なにか業務に影響が出るというわけでもないことをメンバーが知っているというのもある。スプリントは全力でやるものだけど、全力でやらなくてゴールが未達になっても、なんら業務に支障がでない事実がスプリントの目的を減衰させている。</p>
<p>そういう業務と実情があっていない現実、ルールに則るとお小言を言わざるを得ない牽制機構、たった2日すら自由に時間を使えない開発者、なんかスクラムって窮屈だなと直観的に感じた。</p>
</div>
</div>
<div class="post on-list">
<h1 class=post-title>
<a href=/diary/posts/2022/0209/>リリース作業の改善</a>
</h1>
<div class=post-meta>
<span class=post-date>
2022-02-09
</span>
</div>
<span class=post-tags>
#<a href=/diary/tags/refactoring/>refactoring</a>&nbsp;
</span>
<div class=post-content>
<p>1時に寝て6時前には起きてた。昨日がんばったから今日は早めにお仕事を切り上げた。</p>
<h2 id=リリース作業を柔軟に効率的に>リリース作業を柔軟に、効率的に</h2>
<p>以前から認識していた開発の課題にリリース作業のコストが大きいことがあった。具体的には人間が手動で進捗をみながら処理を実行していて、さらに1つずつの処理に数分かかるので順番に実行していくだけでも確認を含めて30分から1時間ぐらいかかる。リリース後に変更したところの動作確認とかを開発者が集まってやってたらだいたい2-3時間はかかる。だらだら？やっているとリリース作業に開発者全員がハドルに入って半日ぐらいやってたりする。最初のうちは雑談しながらリリース作業のやり方がわかってよかったんだけど、何度か繰り返したらこれを毎週やるのは非効率だわと思うようにはなっていた。</p>
<p>そんな開発側の事情もあったんだけど、スクラムマスターからもいまのリリース作業は柔軟性がないみたいな指摘が入って、その改善のチケットが切られた。開発者も全員それは認識していた。改善するならスプリントを1つ使うぐらいの工数がかかるという背景を説明するために、私が「ぼくのかんがえたさいきょうのりりーすさぎょう」を考えていくつかのタスクをチケットに作った。いま GitHub Actions の無料枠におさまるようにリソース制限を運用で調整しているのもあって予算確保できるなら戦略も変わってくる。それらも含めて然るべき改善の道筋を示したい。</p>
</div>
</div>
<div class="post on-list">
<h1 class=post-title>
<a href=/diary/posts/2022/0208/>テストコードのリファクタリング</a>
</h1>
<div class=post-meta>
<span class=post-date>
2022-02-08
</span>
</div>
<span class=post-tags>
#<a href=/diary/tags/java/>java</a>&nbsp;
#<a href=/diary/tags/testing/>testing</a>&nbsp;
</span>
<div class=post-content>
<p>0時に寝て6時に起きた。今日は7時半から23時過ぎまで集中してコードを書いてた。最近は19-20時には帰って、晩ご飯食べて、ドラクエタクトやったり漫画読んだりだらだらしている。そんな暇あったら積ん読の本読めって感じだ。</p>
<h2 id=テストコードのリファクタリング>テストコードのリファクタリング</h2>
<p>業務機能の開発をするにあたって、既存のテストコードをみていて、<code>@BeforeEach</code> というテストメソッド単位に呼ばれるメソッドでテストデータの削除と postgresql の sequence のリセット処理をしていた。こんなの共通処理ですべてのテーブルの truncate と sequence のリセット処理をすればいいやんとか思って、いろいろ調べて2つのリファクタリングの PR を作成した。先日 <a href=/diary/posts/2022/0116/>JUnit5 の拡張</a> を調べたばかりだから、テストの共通化のノウハウが溜まっている。<a href=https://www.testcontainers.org/modules/databases/postgres/>Testcontainers Postgres Module</a> と連携して、postgresql コンテナに接続して sequence のリセット処理を汎用のテスト拡張として実装した。テストを実装する開発者は、次のように <code>@ExtendWith(DatabaseInitializer.class)</code> をアノテーションに付与すれば、自分で sequence のリセット処理を <code>@BeforeEach</code> のメソッドに実装する必要がなくなる。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a6e22e>@SpringBootTest</span>
<span style=color:#a6e22e>@Transactional</span>
<span style=color:#a6e22e>@ExtendWith</span><span style=color:#f92672>(</span>SetupDatabaseContainer<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span>
<span style=color:#a6e22e>@ExtendWith</span><span style=color:#f92672>(</span>DatabaseInitializer<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span>
<span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyTest</span> <span style=color:#f92672>{</span>
    <span style=color:#f92672>...</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>この作業の過程で spring boot の <a href=https://spring.pleiades.io/spring-framework/docs/current/reference/html/testing.html#testcontext-tx-enabling-transactions>@Transactional</a> はデフォルトでテストメソッドの実行後にロールバックする機能が提供されていて、いままで <code>@BeforeEach</code> のメソッドで明示的にテーブルのデータを削除する必要はなかったんやと気付いた。じゃあ、なぜ削除するコードを書いてたかと言うと、テストの外部で初期データを作成する仕組みがあるから、初期データを削除する目的でそうしていたことが判明した。そして、一部のコードはそこで作った外部の初期データに依存して実装されていた。テストコードの一部が外部のデータに依存しつつ、テストメソッドでは外部のデータに依存しないように削除のコードが書いてある。書いていて何を言っているのかわからないと思うけど、私も調べてて訳がわからんくて、PR に「いまの状況はかなりややこしい」と前置きしつつ、無駄なコードや仕組みを取り除くための修正を行った。本当は機能開発やらないといけないのにテストコードのリファクタリングするのに大きな時間をかけるわけにはいかないだろうという意図で、半日掛けてリファクタリングして23時過ぎまで作業して、既存のテストコードも含めて全部直した。このリファクタリングで数十のテストケースの約300行ぐらいの初期化コードをなくせた。</p>
</div>
</div>
<div class="post on-list">
<h1 class=post-title>
<a href=/diary/posts/2022/0207/>確定申告書類の印刷</a>
</h1>
<div class=post-meta>
<span class=post-date>
2022-02-07
</span>
</div>
<span class=post-tags>
#<a href=/diary/tags/tax/>tax</a>&nbsp;
</span>
<div class=post-content>
<p>1時に寝て7時に起きた。</p>
<h2 id=確定申告書類の印刷>確定申告書類の印刷</h2>
<p>最近は遅くても8時、速かったら7時過ぎからお仕事している。ちょうど仕事の谷間で手持ちのタスクを終えてしまっていて、今日から別のタスクに着手する予定が、昨日から障害が発生していたらしく、朝忙しそうだったから11時まで確定申告の作業をしていた。昨日、データ入力は終えていたので総勘定元帳をみながら変な数字になっていないかをチェックしたり、源泉徴収税の還付金の計算があうかどうかを検算したりしていた。あとすでに廃棄した固定資産が残っていることに気付いた。耐用年数が過ぎた固定資産の価値は1円として管理される。これを備忘価格と呼ぶらしい。除却の手続きもした。ついでに <a href=https://advisors-freee.jp/article/category/cat-big-03/cat-small-06/12956/>固定資産売却益（損）とは</a> の会計手続きも調べたりしていた。</p>
<p>オフィスのプリンタで一通り書類を印刷した。あとは提出するだけ。昨年から住んでいるところの徒歩圏内に申告できる場所ができて、散歩のついでに確定申告する程度の手間しかかからない。このまま電子申告してもよいのだけど、寄付金控除のための領収書を写真か PDF ファイルなどで取り込む必要があって、それだけ面倒なので放置している。このまま今年も紙で提出してくるかなぁ。</p>
<h2 id=業務システムの開発>業務システムの開発</h2>
<p>twitter のタイムラインで業務システムの開発者は「業務系エンジニア」と呼ぶとか言っている人をみかけた。そっか、私は web エンジニアから業務系エンジニアになったんだー、web アプリケーション開発しているけどな、とか思いながら、今週からいよいよお手伝い先の業務システムの開発に着手する。いままでインフラやサーバーサイドのシステム寄りの保守や機能開発のみをしていた。さっそく DB スキーマの定義やドキュメントの書き方、作業の進め方などを確認していた。ひとまず1週間のスプリントで終えられそうなタスクなのでがんばってやりたい。</p>
</div>
</div>
<div class="post on-list">
<h1 class=post-title>
<a href=/diary/posts/2022/0206/>確定申告の準備</a>
</h1>
<div class=post-meta>
<span class=post-date>
2022-02-06
</span>
</div>
<span class=post-tags>
#<a href=/diary/tags/founding/>founding</a>&nbsp;
#<a href=/diary/tags/tax/>tax</a>&nbsp;
</span>
<div class=post-content>
<p>1時に寝て8時に起きた。朝から洗濯と掃除をしてた。姪の大学進学で下宿先を探しに来ると姉が言うからなんか手伝う必要あるのかなと午後は時間をあけてたけど、そうでもなかった。</p>
<h2 id=2021年度の個人の確定申告>2021年度の個人の確定申告</h2>
<p>夕方から確定申告の作業を始めた。毎年 freee で1ヶ月だけ契約して確定申告の書類を作っている。データ入力の作業は次の2つだけ。</p>
<ul>
<li>印税の源泉徴収税の明細作成</li>
<li>寄付金の明細作成</li>
</ul>
<p>書籍の印税収入が定期的に振り込まれる。印税収入は源泉徴収済みとなる。銀行 (出版社) からの明細取り込みに対して、印税と源泉徴収税の明細に分割する必要がある。今年は3社から印税があって、それぞれ数件程度の明細を作成した。クレジットカードで寄付金を支払っているものは明細連携できていないので12ヶ月分の明細を手入力することになる。言うても、それは1団体だけなので12個の明細だけ。会社を作る前は技術書の購入や勉強会の参加費や交通費 (新幹線とか) などにかかった経費なども明細登録していたけど、いまは会社の経費ですべて計上しているので個人で計上するものはなくなった。会社の経費はクレジットカード連携できているし、日々のお仕事で会計処理しているから、確定申告のタイミングでまとめて作業する必要はなくなった。</p>
<p>あと2021年度から <a href=https://www.smrj.go.jp/kyosai/skyosai/>小規模企業共済</a> に入った。最小1000円/月から最大7万円/月の掛け金を選択する。いくらぐらいが妥当かわからなかったのでひとまず4万円/月で運用している。もちろん掛け金は変更できるが、基本的に20年とか掛け続けるもので、支払った金額は戻ってこないので、あるとき大きなお金が必要となっても融通できない貯金があるみたいものになってしまう。その分のメリットとして、所得控除の対象となる。<a href=https://www.smrj.go.jp/kyosai/skyosai/entry/simulation/index.html>加入シミュレーション</a> があるので、自分の条件にあわせてやってみるとおもしろい。例えば、納付月数240ヶ月、掛け金7万円/月、課税所得400万円で算出すると24万円/年の節税となる。課税所得が減るので所得税だけでなく住民税も節税となる。</p>
</div>
</div>
<div class="post on-list">
<h1 class=post-title>
<a href=/diary/posts/2022/0205/>見積もりの考察</a>
</h1>
<div class=post-meta>
<span class=post-date>
2022-02-05
</span>
</div>
<span class=post-tags>
#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/issue-tracking-system/>issue tracking system</a>&nbsp;
</span>
<div class=post-content>
<p>23時に寝て8時半に起きた。夜中に胃酸が逆流してむせてしんどかった。</p>
<h2 id=ストレッチ>ストレッチ</h2>
<p>先週の日曜日に自転車でこけて胸を強打してまだ治りきっていない。トレーナーさんに伝えたら主に足のストレッチを重点にしてくれた。今週は2日間ストレッチをやったんだけど、今日の開脚幅は開始前166cmで、ストレッチ後169cmだった。先週と同じなので現状維持といったところ。悪くない数字ではある。今日は左のお尻の後ろの筋肉の張りと右太ももの後ろの筋肉の張りが強かった。</p>
<h2 id=見積もりとは>見積もりとは</h2>
<p>昨日の <a href=/diary/posts/2022/0204/>バーンダウンしないチャート</a> に関連して「見積もりとはなにか」というタイトルでつらつらと書き始めたら6000文字ほど書いてた。当初はお手伝い先の wiki に書こうと思って書き始めたものの、アウトラインと言いたいことをまとめたら、とくに機密情報はほとんどないことに気付いて、自分のブログのどこかにまとめ直そうと思った。社内向けに書こうとすると、実務の具体例をベースにして自分の論理や考察を展開し、最終的には提案の説得力を高めようと構成する。一方で社外向けに書こうとすると、社内の関係者に対してハラスメントにならないように配慮して書くのをやめた内容を一般論という立て付けで構成できる。文章を書くときに誰向けに書くかは、内容が同じでも話の展開や構成に影響を与えるということにふと気付いた。また数日以内にはどこかのブログに書き直す。</p>
</div>
</div>
<div class="post on-list">
<h1 class=post-title>
<a href=/diary/posts/2022/0204/>バーンダウンしないチャート</a>
</h1>
<div class=post-meta>
<span class=post-date>
2022-02-04
</span>
</div>
<span class=post-tags>
#<a href=/diary/tags/scrum/>scrum</a>&nbsp;
</span>
<div class=post-content>
<p>0時に寝て4時に起きてドラクエタクトしたり twtter 眺めたりして金朝ツメトギで <a href=https://www.ipa.go.jp/files/000094497.pdf>DX 実践手引書</a> を読んでた。</p>
<h2 id=スプリントの残チケット>スプリントの残チケット</h2>
<p>スクラム開発でバックログのバーンダウンチャートを表示させるために、スプリントに対して、同じ期間のマイルストーンを設定するように運用が変わった。運用変更に伴い、バーンダウンチャートも表示されるようになり、スプリントの進捗状況の見える化が進められた。そのバーンダウンチャートの運用について SM と話していて、私の過去の開発とスプリントの考え方の大きな違いを発見した。</p>
<p>私がこれまでやってきた開発はマイルストーンの日には残チケットがゼロになるように開発していた。開発が遅延してそのマイルストーンで完了しそうにないチケットはどこかのタイミングで次のマイルストーンに先送りさせることで、いまやっているマイルストーンの開発が計画通りに完了するよう調整していた。作業が期限までに間に合わないチケットは早めに検知して報告して対応を検討する。一般論として、遅延したときは期限を延期するか、次のマイルストーンに先送りするかのどちらかしかない。</p>
<p>スクラムの場合、PO はスプリントを中止する権限をもっているが、基本的にスプリントの計画は変更しない。スプリント内でマイルストーンに間に合わないチケットがわかっていても、マイルストーンは変更せず、次のスプリントプランニングまで放置して、次のスプリントプランニングで遅れたチケットの作業を中止するか、引き続きやるかを検討するという。このやり方だと、スプリント終了日 (マイルストーンの日) に遅延して完了できないとわかっているチケットがすべて残ってしまう。当然バーンダウンチャートはバーンダウンしない。</p>
<p>一方でこれまでマイルストーンこそ設定していなかったものの、様々な理由でスプリントでやる予定だったチケットが遅延することは度々あった。それはデイリースクラムで遅れますとか、予想外のタスクが出てきましたとか、そういう報告をもって実運用では次のスプリントに持ち越ししていた。実運用では持ち越ししているのに、マイルストーンを変えるのは計画の変更だからやってはいけないという話しになって、見える化したのにバーンダウンしないチャートがあって、この運用に何の意味があるのだろう？わからなくなった。</p>
</div>
</div>
<div class="post on-list">
<h1 class=post-title>
<a href=/diary/posts/2022/0203/>開発の谷間</a>
</h1>
<div class=post-meta>
<span class=post-date>
2022-02-03
</span>
</div>
<span class=post-tags>
#<a href=/diary/tags/writing/>writing</a>&nbsp;
</span>
<div class=post-content>
<p>0時に寝て6時半に起きた。</p>
<h2 id=ドキュメント作成>ドキュメント作成</h2>
<p>今週はあまり開発せず、バックログの wiki にドキュメントを書いてた。バックログの wiki は慣れると書きやすいし、<a href="https://chrome.google.com/webstore/detail/backlog-power-ups/oknjgkbkglfeeobjojelkbhfpjkgcndb?hl=ja">Backlog Power Ups</a> の chrome 拡張をインストールすると <a href=https://plantuml.com/ja/>PlantUML</a> で UML もレンダリングできる。ドキュメントの階層化はタイトルに <code>/</code> で区切ってグルーピングするというちょっと変なやり方。wiki のタグはフィルター条件として使いやすいように思えた。添付画像のサイズ指定ができないか調べてたら、ヌーラボコミュニティがあることに気付いた。せっかくなので <a href=https://ja.community.nulab.com/u/tetsuyamorimoto-5hx/activity>改善要望</a> を投稿しておいたけど、過疎っててあまり意味がないかもしれない。</p>
</div>
</div>
<div class="post on-list">
<h1 class=post-title>
<a href=/diary/posts/2022/0202/>情熱の考察</a>
</h1>
<div class=post-meta>
<span class=post-date>
2022-02-02
</span>
</div>
<span class=post-tags>
#<a href=/diary/tags/issue-tracking-system/>issue tracking system</a>&nbsp;
</span>
<div class=post-content>
<p>0時に寝て4時半に起きてドラクエタクトを1時間ほどやって寝て7時半に起きた。</p>
<h2 id=課題管理の情熱>課題管理の情熱</h2>
<p>先日、行った <a href=/diary/posts/2022/0130/#3ヶ月フィードバック完了>3ヶ月フィードバック</a> はスクラムマスターには好評だったらしく、他にも3人ほど読んでくれた人たちがいたようだ。いま課題管理のボードの整理をしたり、wiki のドキュメント階層を整理したり、情報共有や書く文化の重要性を説いたり、チームに私のやり方を見本のように示している。チームにも、私のチケットはコメントの量が大幅に違うということは認識され、それを見様見真似でやり始める開発者も現れ始めている。誰もが最初はお手本を模倣しながら学ぶ。いままで課題管理と情報共有というコンテキストで見本を示せる開発者がいなかっただけという話だ。</p>
<p>ふと、なぜ私はここまで課題管理やドキュメントなどを整理したがるのか、自分で考えてもよくわからない。強いて言うと、自分が働く環境やツールに関心をもっていて、それをいまよりもより良く改善したいという気持ちが他人よりも強いのかもしれない。働くからにはよいものを作りたい、ひいてはよい環境があればよいものを作れる、よい環境を作るための投資は惜しまないという姿勢から、課題管理のワークフローと情報共有の最適化を常に考えながら実践している気がする。もっと端的には言えば、仕事がどうこうというのは全く関係なく、日々の活動に関心をもっていると言えるのかもしれないなと思ったりした。採用における特性をみるときの1つの指標として生きていることに関心をもっているか、どういう行動を取っているかとかをヒアリングしてもおもしろいのかもしれない。</p>
</div>
</div>
<div class="post on-list">
<h1 class=post-title>
<a href=/diary/posts/2022/0201/>wiki のドキュメント整理</a>
</h1>
<div class=post-meta>
<span class=post-date>
2022-02-01
</span>
</div>
<span class=post-tags>
#<a href=/diary/tags/datadog/>datadog</a>&nbsp;
#<a href=/diary/tags/kubernetes/>kubernetes</a>&nbsp;
</span>
<div class=post-content>
<p>23時に寝て4時半に起きた。昨日の帰りに自転車でこけて胸を強打してひたすら痛い。起き上がるのも痛い。安静にしてた。</p>
<h2 id=kubernetes-のログ管理と-datadog-agent-のログ連携不具合>kubernetes のログ管理と datadog-agent のログ連携不具合</h2>
<p>先日、<a href=/diary/posts/2022/0127/#ログ連携の不具合調査>datadog にログ連携されていない不具合</a> が発生していて、その1次調査を終えたことについて書いた。緊急対応としては datadog-agent を再起動することで改善することはわかっていたので、その後、kubernetes のログ管理と datadog-agent がどうやって kubernetes クラスター上で実行されているアプリケーションのログを収集しているかを調査していた。今日は wiki に調査してわかったことなどをまとめていた。</p>
<p>kubernetes クラスターはコンテナランタイムに docker を使っていて、アプリケーションの stdout/stderr を docker の logging driver にリダイレクトし、JSON Lines に設定された logging driver が kubernetes ノード上にログファイルとして出力する。datadog-agent は autodiscovery 機能で pod の情報を常にポーリングしていて、pod が新たにデプロイされたらログファイルを pod 内にマウントして、そのマウントしたログファイルを読み込んでログ収集していると思われる。datadog-agent から pod の情報を取得するには kubernetes のサービスアカウントを使っていて、その credential が projected volume としてマウントされて pod 内から利用できる。その credential を使って kubelet api にリクエストすることで pod の情報を取得している。</p>
<p>文章で書けばたったこれだけのことなんだけど、たったこれだけのことを理解するのに次のドキュメントを読んだ。実際の調査のときはわからなかったのでもっと多くのドキュメントを読んでいる。いま書いたことを理解するならこのドキュメントを読めば理解できるはず。</p>
<ul>
<li><a href=https://kubernetes.io/docs/concepts/overview/components/>https://kubernetes.io/docs/concepts/overview/components/</a></li>
<li><a href=https://kubernetes.io/docs/concepts/architecture/control-plane-node-communication/>https://kubernetes.io/docs/concepts/architecture/control-plane-node-communication/</a></li>
<li><a href=https://kubernetes.io/docs/concepts/cluster-administration/logging/>https://kubernetes.io/docs/concepts/cluster-administration/logging/</a></li>
<li><a href=https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/>https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/</a></li>
<li><a href=https://kubernetes.io/docs/concepts/storage/projected-volumes/>https://kubernetes.io/docs/concepts/storage/projected-volumes/</a></li>
<li><a href="https://docs.datadoghq.com/agent/kubernetes/log/?tab=helm">https://docs.datadoghq.com/agent/kubernetes/log/?tab=helm</a></li>
<li><a href="https://docs.datadoghq.com/getting_started/agent/autodiscovery/?tab=kubernetes">https://docs.datadoghq.com/getting_started/agent/autodiscovery/?tab=kubernetes</a></li>
</ul>
<p>ドキュメントに書いてあることを深く理解するために、kubernetes と datadog-agent のソースコードも読んだ。どちらも go 言語で実装されている。</p>
<ul>
<li><a href=https://github.com/kubernetes/kubernetes>https://github.com/kubernetes/kubernetes</a></li>
<li><a href=https://github.com/DataDog/datadog-agent>https://github.com/DataDog/datadog-agent</a></li>
</ul>
<p><code>kubectl logs</code> の振る舞いを確認するだけでも、ソースコードからは実際のログファイルを open してストリームを返しているところはわからなかった。api 呼び出しが連携されて抽象化されていて、コンポーネントの役割分担があって、何も知らずにコードを読んでいてもわからなかった。Kubernetes の低レイヤーのところは Container Runtime Interface (CRI) という標準化を行い、1.20 から docker は非推奨となり、将来的に CRI を提供する実装に置き換わるらしい。ログファイルを open する役割は CRI の実装が担うんじゃないかと思うけど、そこまでは調べきれなかった。また機会があれば CRI の実装も読んでみる。</p>
<figure><img src=/diary/img/2022/0201_kubectl-logs.png>
</figure>
</div>
</div>
<div class=pagination>
<div class=pagination__buttons>
<span class="button next">
<a href=/diary/dates/2022/02/page/2/>
<span class=button__text>過去の日記</span>
<span class=button__icon>→</span>
</a>
</span>
</div>
</div>
</div>
</div>
<footer class=footer>
<div class=footer__inner>
<div class="copyright copyright--user">
<span>© 2021 Tetsuya Morimoto</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span>
</div>
</div>
</footer>
<script src=/diary/assets/main.js></script>
<script src=/diary/assets/prism.js></script>
</div>
</body>
</html>