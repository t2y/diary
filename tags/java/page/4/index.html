<!doctype html><html lang=en><head><title>Java :: </title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/tags/java/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="Java"><meta property="og:description" content><meta property="og:url" content="/diary/tags/java/"><meta property="og:site_name" content><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/tags/java/index.xml rel=alternate type=application/rss+xml title></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><h1>Posts for: #Java</h1><div class=posts><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0116/>JUnit5 のテスト拡張</a></h1><div class=post-meta><time class=post-date>2022-01-16</time></div><span class=post-tags>#<a href=/diary/tags/java/>java</a>&nbsp;
#<a href=/diary/tags/testing/>testing</a>&nbsp;</span><div class=post-content><p>1時に寝て5時に起きて2度寝して9時に起きた。前日呑んでたのであまり眠れなくて体調よくない。</p><h2 id=junit5-的なロガーのテスト>JUnit5 的なロガーのテスト</h2><p>お仕事でログ管理の機能開発をしている。カスタムロガーを使って出力するメッセージを加工している。設計が固まってきて機能も作り込むようになってきたので出力内容が意図した構造化ログになっているかをテストしたい。JUnit5 の機能と log4j の機能を組み合わせてカスタムロガーのテストの仕組みを作ってみた。</p><p>まずログ出力した内容を取得するオブジェクトを特定するためのアノテーションを定義する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Documented</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Target</span>(ElementType.<span style=color:#a6e22e>FIELD</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Retention</span>(RetentionPolicy.<span style=color:#a6e22e>RUNTIME</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#a6e22e>@interface</span> LoggerTestWriter {
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>JUnit5 の <a href=https://junit.org/junit5/docs/current/user-guide/#extensions-registration-declarative>Declarative Extension Registration</a> の仕組みを使って、テストケース非依存な setup/teadown のメソッドを定義する。<a href=https://junit.org/junit5/docs/current/api/org.junit.jupiter.api/org/junit/jupiter/api/extension/ExtensionContext.html>ExtensionContext</a> から拡張するテストケースのインスタンスを取得できる。テストケースインスタンスに定義されている <code>@LoggerTestWriter</code> アノテーションがついたオブジェクトを lgo4j の Appender としてインジェクションするようなコードを setup/teardown (beforeEach/afterEach メソッド) で定義する。Appender のインジェクション周りは <a href=https://qiita.com/kazurof/items/abbd42f11bfc125f3190>Log4j 2でログ出力をテストするサンプルソース</a> の記事を参考にした。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SetupLogAppender</span> <span style=color:#66d9ef>implements</span> BeforeEachCallback, AfterEachCallback {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> String APPENDER_NAME <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;logger-test-appender&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Optional<span style=color:#f92672>&lt;</span>Writer<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getWriter</span>(ExtensionContext context) <span style=color:#66d9ef>throws</span> IllegalAccessException {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> testInstance <span style=color:#f92672>=</span> context.<span style=color:#a6e22e>getRequiredTestInstance</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>var</span> field : testInstance.<span style=color:#a6e22e>getClass</span>().<span style=color:#a6e22e>getDeclaredFields</span>()) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (field.<span style=color:#a6e22e>isAnnotationPresent</span>(LoggerTestWriter.<span style=color:#a6e22e>class</span>)) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> Optional.<span style=color:#a6e22e>of</span>((Writer) field.<span style=color:#a6e22e>get</span>(testInstance));
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> Optional.<span style=color:#a6e22e>empty</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>beforeEach</span>(ExtensionContext context) <span style=color:#66d9ef>throws</span> Exception {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> writer <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getWriter</span>(context).<span style=color:#a6e22e>orElseThrow</span>(() <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>new</span> IllegalStateException(<span style=color:#e6db74>&#34;@LoggerTestWriter のアノテーションをもつ Writer を定義してください&#34;</span>));
</span></span><span style=display:flex><span>        addAppender(writer, APPENDER_NAME);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>afterEach</span>(ExtensionContext context) <span style=color:#66d9ef>throws</span> Exception {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> writer <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getWriter</span>(context).<span style=color:#a6e22e>orElseThrow</span>(IllegalStateException::<span style=color:#66d9ef>new</span>);
</span></span><span style=display:flex><span>        removeAppender(APPENDER_NAME);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (writer <span style=color:#66d9ef>instanceof</span> StringWriter) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>var</span> stringWriter <span style=color:#f92672>=</span> (StringWriter) writer;
</span></span><span style=display:flex><span>            stringWriter.<span style=color:#a6e22e>getBuffer</span>().<span style=color:#a6e22e>delete</span>(0, stringWriter.<span style=color:#a6e22e>getBuffer</span>().<span style=color:#a6e22e>length</span>());
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>実際にテストを書くテストクラスは次のようになる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@ExtendWith</span>(SetupLogAppender.<span style=color:#a6e22e>class</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyLoggerTest</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> MyLogger logger <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> MyLogger(MyLoggerTest.<span style=color:#a6e22e>class</span>.<span style=color:#a6e22e>getName</span>());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@LoggerTestWriter</span>
</span></span><span style=display:flex><span>    StringWriter writer <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> StringWriter();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>testDebugMap</span>() {
</span></span><span style=display:flex><span>        logger.<span style=color:#a6e22e>debug</span>(<span style=color:#e6db74>&#34;my-message&#34;</span>)
</span></span><span style=display:flex><span>        assertEquals(<span style=color:#e6db74>&#34;my-message&#34;</span> writer.<span style=color:#a6e22e>toString</span>());
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p><code>@ExtendWith</code> で指定した <code>SetupLogAppender</code> クラスの beforeEach や afterEach がそれぞれのテストメソッドごとに呼ばれて、Appender のインジェクションが <code>@LoggerTestWriter</code> のアノテーションをもつ writer を使って行われる。この writer にはログ出力した文字列が記録されるようになる。これで、テストメソッドで logger に対して出力したメッセージを writer から取得できるので意図したメッセージが出力されていることをテストできる。カスタムロガーのテストケースごとに再利用可能な拡張をきれいに実装できた。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0111/>log4j2 の yml 設定</a></h1><div class=post-meta><time class=post-date>2022-01-11</time></div><span class=post-tags>#<a href=/diary/tags/java/>java</a>&nbsp;</span><div class=post-content><p>0時半に寝て6時半に起きた。だいぶ開発に集中してきて朝も起きれるようになってきた。</p><h2 id=log4j2yml-を読み込む>log4j2.yml を読み込む</h2><p>log4j2 のログ設定を整理していて設定ファイルを読み込む順番は次のようにドキュメントに記載されている。java ライブラリのこういった手厚いルールはややうんざりするところもあるけど、是非はともかく、ファイルフォーマットの違い、ファイル名の違いで読み込む優先順位がある。歴史のあるライブラリだから要求を聞いているうちにこんな感じになったんだろうと推測する。</p><blockquote><ol><li>Log4j will inspect the &ldquo;log4j2.configurationFile&rdquo; system property and, if set, will attempt to load the configuration using the ConfigurationFactory that matches the file extension. Note that this is not restricted to a location on the local file system and may contain a URL.</li><li>If no system property is set the properties ConfigurationFactory will look for log4j2-test.properties in the classpath.</li><li>If no such file is found the YAML ConfigurationFactory will look for log4j2-test.yaml or log4j2-test.yml in the classpath.</li><li>If no such file is found the JSON ConfigurationFactory will look for log4j2-test.json or log4j2-test.jsn in the classpath.</li><li>If no such file is found the XML ConfigurationFactory will look for log4j2-test.xml in the classpath.</li><li>If a test file cannot be located the properties ConfigurationFactory will look for log4j2.properties on the classpath.</li><li>If a properties file cannot be located the YAML ConfigurationFactory will look for log4j2.yaml or log4j2.yml on the classpath.</li><li>If a YAML file cannot be located the JSON ConfigurationFactory will look for log4j2.json or log4j2.jsn on the classpath.</li><li>If a JSON file cannot be located the XML ConfigurationFactory will try to locate log4j2.xml on the classpath.</li><li>If no configuration file could be located the DefaultConfiguration will be used. This will cause logging output to go to the console.</li></ol><p><a href=https://logging.apache.org/log4j/2.x/manual/configuration.html#AutomaticConfiguration>log4j2 Automatic Configuration</a></p></blockquote><p>普通 java は xml で設定を書くけど、この設定ファイルの読み込みルールをみたら yml にも対応しているならその方がよさそうとか思うやん。log4j2.xml から log4j2.yml に書き換えて試してみると、ログ設定が有効にならない。どうも log4j2.yml を読み込んでいないようにみえる。ググっていると <code>jackson-dataformat-yaml</code> を依存関係に追加しろといった内容をみつかるけど、どういう理屈でそういう仕様になっているのか、まったく理解できない。なによりも読み飛ばしたというログが出力されないから設定ファイルを読んでいるのかどうかすら気付けない。これは知ってないとはまるポイントの1つ。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>com.fasterxml.jackson.dataformat<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>jackson-dataformat-yaml<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span></code></pre></div></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2021/1223/>maven のバージョンチェック処理の振る舞い</a></h1><div class=post-meta><time class=post-date>2021-12-23</time></div><span class=post-tags>#<a href=/diary/tags/java/>java</a>&nbsp;
#<a href=/diary/tags/maven/>maven</a>&nbsp;</span><div class=post-content><p>23時に寝て1時に起きてまた寝て6時半に起きた。変なライフサイクルになってきた。</p><h2 id=maven-のアップデートポリシー>maven のアップデートポリシー</h2><p>maven が依存解決するとき、例えばバージョンの範囲を指定して最新バージョンを取得するといった設定ができる。実行していると、新しいバージョンをチェックしにいくときとそうじゃないときがあって、どういう仕組みで動いているのかよくわからなかったのでデバッグした。言うても DEBUG ログを出力させて、ログの内容をソースで grep しながら関連するところを読んだだけ。</p><p><a href=https://github.com/apache/maven/blob/maven-3.6.3/maven-compat/src/main/java/org/apache/maven/repository/legacy/DefaultUpdateCheckManager.java#L110>DefaultUpdateCheckManager.isUpdateRequired</a> の中でポリシーが最終チェック日付を確認していいる。ここから辿っていくと <a href=https://github.com/apache/maven/blob/maven-3.6.3/maven-artifact/src/main/java/org/apache/maven/artifact/repository/ArtifactRepositoryPolicy.java#L115>ArtifactRepositoryPolicy</a> という仕組みがある。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>return</span> ( lastCheckDate <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> ) <span style=color:#f92672>||</span> policy.<span style=color:#a6e22e>checkOutOfDate</span>( lastCheckDate );
</span></span></code></pre></div><p>ドキュメントでそれっぽい内容を調べると <code>updatePolicy</code> を設定できるようになっている。デフォルトは <code>daily</code> なので日次でチェックしにいくような振る舞いをする。バージョンチェックするときとしないときの何が違うのか、よくわかっていなかった振る舞いを理解できた。これはビルドキャッシュの有無に関係ないのでキャッシュがあるからバージョンチェック処理をスキップできるわけではない。もちろん、更新をチェックさせたくないのであれば <code>never</code> に設定してもいいのかもしれない。</p><blockquote><p>updatePolicy</p><p>The frequency for downloading updates - can be &ldquo;always&rdquo;, &ldquo;daily&rdquo; (default), &ldquo;interval:XXX&rdquo; (in minutes) or &ldquo;never&rdquo; (only if it doesn&rsquo;t exist locally).</p><p><a href=https://maven.apache.org/ref/3.6.3/maven-settings/settings.html>https://maven.apache.org/ref/3.6.3/maven-settings/settings.html</a></p></blockquote></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2021/1216/>traceparent の生成</a></h1><div class=post-meta><time class=post-date>2021-12-16</time></div><span class=post-tags>#<a href=/diary/tags/dapr/>dapr</a>&nbsp;
#<a href=/diary/tags/java/>java</a>&nbsp;
#<a href=/diary/tags/event/>event</a>&nbsp;</span><div class=post-content><p>1時半に寝て7時半に起きた。ちょっと疲れてて寝坊した。</p><h2 id=w3c-trace-context-の-traceparent-ヘッダーの生成>W3C Trace Context の traceparent ヘッダーの生成</h2><p>前にお仕事で <a href=/diary/posts/2021/1209/#dapr-の分散トレーシングと-w3c-trace-context>dapr の分散トレーシングを検証している</a> ことについて書いた。</p><p>dapr の分散トレーシングは <a href=https://www.w3.org/TR/trace-context/>W3C Trace Context</a> に準拠していて、dapr 経由のリクエストは自動的にこの情報が付与されるが、そうじゃないリクエストもトレーシングできるようにするためには http ヘッダーの <code>traceparent</code> をセットしないといけない。試しにサーバー側に <code>traceparent</code> を生成するのはどうやるのかを調べてみた。<a href=https://github.com/w3c/trace-context/blob/main/implementations.md>Implementations of Trace Context</a> にある java ライブラリを調べていて、Jaeger クライアントは OpenTelemetry に移行したと書いてあって、OpenTracing と OpenCensus は OpenTelemetry に統合されたと書いてあって、どうやら OpenTelemetry を使うのがよさそうだとわかった。</p><p>やりたいことは <code>traceparent</code> を生成したいだけだが、OpenTelemetry の <a href=https://opentelemetry.io/docs/instrumentation/java/manual_instrumentation/>Manual Instrumentation</a> を読んでも直接的なやり方は書いてなくて、<a href=https://github.com/open-telemetry/opentelemetry-java>open-telemetry/opentelemetry-java</a> のテストコードなどもみながら実装した。細かいところの仕様をまだ理解できていないけど、ひとまずこれで生成できたので検証はできると思う。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>W3cContextUtil</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String TRACE_PARENT_VERSION <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;00&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> OpenTelemetrySdk openTelemetry <span style=color:#f92672>=</span> OpenTelemetrySdk.<span style=color:#a6e22e>builder</span>()
</span></span><span style=display:flex><span>            .<span style=color:#a6e22e>setTracerProvider</span>(SdkTracerProvider.<span style=color:#a6e22e>builder</span>().<span style=color:#a6e22e>build</span>())
</span></span><span style=display:flex><span>            .<span style=color:#a6e22e>setPropagators</span>(ContextPropagators.<span style=color:#a6e22e>create</span>(W3CTraceContextPropagator.<span style=color:#a6e22e>getInstance</span>()))
</span></span><span style=display:flex><span>            .<span style=color:#a6e22e>buildAndRegisterGlobal</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> Tracer tracer <span style=color:#f92672>=</span> openTelemetry.<span style=color:#a6e22e>getTracer</span>(
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;my-tracer&#34;</span>, <span style=color:#e6db74>&#34;1.0.0&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> String <span style=color:#a6e22e>generateTraceParent</span>() {
</span></span><span style=display:flex><span>        Span span <span style=color:#f92672>=</span> tracer.<span style=color:#a6e22e>spanBuilder</span>(<span style=color:#e6db74>&#34;parent&#34;</span>).<span style=color:#a6e22e>startSpan</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            SpanContext sc <span style=color:#f92672>=</span> span.<span style=color:#a6e22e>getSpanContext</span>();
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> String.<span style=color:#a6e22e>format</span>(<span style=color:#e6db74>&#34;%s-%s-%s-%s&#34;</span>,
</span></span><span style=display:flex><span>                    TRACE_PARENT_VERSION,
</span></span><span style=display:flex><span>                    sc.<span style=color:#a6e22e>getTraceId</span>(),
</span></span><span style=display:flex><span>                    sc.<span style=color:#a6e22e>getSpanId</span>(),
</span></span><span style=display:flex><span>                    sc.<span style=color:#a6e22e>getTraceFlags</span>().<span style=color:#a6e22e>asHex</span>());
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>finally</span> {
</span></span><span style=display:flex><span>            span.<span style=color:#a6e22e>end</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=大阪python-もくもく会>大阪Python もくもく会</h2><p><a href=https://osakapython.connpass.com/event/233460/>大阪Python もくもく会 #66</a> にオンライン参加した。コロナ禍前に大阪へ通勤していた頃はオフライン勉強会に何回か参加したことがある。主催者のやぎさんは一度 bizpy に参加してくれたこともある。11月からオフライン勉強会を再開したとのこと。久しぶりに参加してやぎさんと話していたら <a href=https://neos.com/>neosvr</a> にも関心をもっているとのこと。私も少し前に oculus quest 2 を購入して触ってみた程度なのでメタバース関連で一緒に勉強会をしてもよいかもしれない。もくもく会では「アジャイル開発とスクラム 第2版」を読んでいて昨日の日記の記事がまさにその成果物。せっかくなので成果発表でこの本の紹介などをした。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2021/1213/>log4j2 セキュリティ対応</a></h1><div class=post-meta><time class=post-date>2021-12-13</time></div><span class=post-tags>#<a href=/diary/tags/java/>java</a>&nbsp;
#<a href=/diary/tags/security/>security</a>&nbsp;
#<a href=/diary/tags/founding/>founding</a>&nbsp;
#<a href=/diary/tags/stone/>stone</a>&nbsp;
</span><img src=/diary/img/2021/1213-turquoise.jpg class=post-cover alt="log4j2 セキュリティ対応" title="Cover Image"><div class=post-content><p>23時に寝て5時に起きたが、だらだらしているうちに2度寝して6時半に起きた。</p><h2 id=log4j2-セキュリティ対応>log4j2 セキュリティ対応</h2><p><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-44228">CVE-2021-44228</a> が金曜日のお昼から私のタイムラインを賑わしている。私がお手伝いしているお仕事はイントラのシステムなのでやや余裕をもって情報を眺めていた。<a href=https://github.com/apache/logging-log4j2/pull/608#issuecomment-990494126>issue のコメント</a> をみても log4j 1.x にも影響があると書かれて、その後に実際には影響ないと書かれて、さらにその後に条件付きだけど影響はあると二転三転してた。自分で実際に試してなくて世の中の開発者の情報をみているだけ。そのため、公式の情報を信頼するといったポジションでしかない。関係者の方々には敬意を払いたい。私は spring の公式ブログで公開されている <a href=https://spring.io/blog/2021/12/10/log4j2-vulnerability-and-spring-boot>Log4J2 Vulnerability and Spring Boot</a> を読みながら対応した。</p><h2 id=ターコイズ>ターコイズ</h2><p>ふとしたきっかけで <a href=https://www.fu-stone.com/blog/turquoise/>ターコイズ</a> の記事を読んだ。12月の誕生石らしく、それでいまの時期に紹介されることも多いのだと推測する。別の記事でターコイズは喉によいと書かれていて、以前 <a href=/diary/posts/2021/1114/#傾斜枕>喉に違和感がある</a> ことを書いた。日常生活に困るほどではないけど、もうこの歳だから体調が良くなることはなく悪くなる一方だろうという見通しも含めて験担ぎのような感覚で喉というキーワードでつながったから購入してみた。</p><p>近所の原石屋さんに行って尋ねてみたら1-2cmぐらいのサイズ1個240円ほどで売っていたので3個買って、近所のダイソーで入れものを買って、それっぽくオフィスに置いておくことにした。うちのコーポレートカラーはグリーンとブルーなんだけど、ターコイズも <a href=https://www.colordic.org/colorscheme/4115>ターコイズグリーン</a> と <a href=https://www.colordic.org/colorscheme/4129>ターコイズブルー</a> の2種類の色がある。創業も12月なので誕生石としても合致する。共通点があって相性がよさそうなのでうちのコーポレートストーン (そんな言葉ない) はターコイズでいいや。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2021/1207/>クロスデフォルト</a></h1><div class=post-meta><time class=post-date>2021-12-07</time></div><span class=post-tags>#<a href=/diary/tags/economy/>economy</a>&nbsp;
#<a href=/diary/tags/java/>java</a>&nbsp;
#<a href=/diary/tags/logging/>logging</a>&nbsp;</span><div class=post-content><p>0時に寝て6時半に起きた。5時台には起きているんだけど、起き上がるところまではなかなかいけない。</p><h2 id=恒大集団のデフォルト>恒大集団のデフォルト</h2><p>11月から利払の期日の日はチェックしていて、支払うときは2-3日前には支払いを完了したというニュースが出ていたように思う。今日の支払いは前日に支払いしたというニュースが出ないからダメなんだろうなと様子をみていた。</p><ul><li><a href=https://jp.reuters.com/article/evergrande-idJPKBN2IM0F0>中国恒大、猶予期間終了までにオフショア債利払いできず＝関係筋</a></li></ul><p>1つの債務がデフォルトした場合、残りの債務も一括返済しないといけないことを <a href=https://www.ifinance.ne.jp/glossary/loan/loa259.html>クロスデフォルト</a> と呼ぶらしい。契約書にクロスデフォルト条項として書いてあるらしい。記事によると、クロスデフォルトによって約190億ドル (約2.1兆円) のオフショア債の返済を一括でしないといけないらしい。リーマンショックのようなことは起きないという見通しだけど、うちみたいな零細企業は世の中の影響を諸に受けるのでお仕事に影響がでなければいいなぁといったところ。</p><h2 id=アプリケーションログの調査>アプリケーションログの調査</h2><p>昨日の続き。ecs-logging-java で JSON Lines でログを制御するところで spring-boot の設定で tomcat のアクセスログの設定ができる。tomcat のアクセスログを log4j のレイアウトの仕組みを使って ecs-logging-java が提供する EcsLayout に変更できないかを3時間ほど調査して、どうもできないようだというのを教えてもらった。tomcat は apache のログを出力するという目的で実装されているから log4j の柔軟なログに対応していないという理屈。</p><p>じゃあ、どうやって apache のアクセスログを JSON Lines にするかというと、PatternLayout のパターンに json のフォーマットを直書きしてしまうというやり方がある。なんかプログラミングでスマートに解決したいところだけど、その仕組みがないなら仕方ないかって感じでこれでやろうと思う。</p><ul><li><a href=https://ogugu.hateblo.jp/entry/2018/08/03/153930>apacheのaccess_logをjson化しtd-agentで集約サーバへ収集する</a></li></ul></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2021/1206/>アプリケーションログの調査</a></h1><div class=post-meta><time class=post-date>2021-12-06</time></div><span class=post-tags>#<a href=/diary/tags/java/>java</a>&nbsp;
#<a href=/diary/tags/logging/>logging</a>&nbsp;</span><div class=post-content><p>1時に寝て7時に起きた。</p><h2 id=アプリケーションログの調査>アプリケーションログの調査</h2><p>お仕事でログの整理をやろうとしていて、そのためのライブラリとして ecs-logging-java を調べてた。</p><ul><li><a href=https://www.elastic.co/guide/en/ecs-logging/java/current/setup.html>ECS Logging Java Reference 1.x » Get started</a></li><li><a href=https://speakerdeck.com/shibadog/ecs-logging-javatukatutemita>ecs-logging-javaつかってみた</a></li></ul><p>一番のモチベーションは <a href=https://jsonlines.org/>JSON Lines</a> でログを管理したいというところ。この手の実装や読み込んでログ分析したりとかはあちこちでやってきたので親近感はある。既存のログからの移行も含めていろいろ設計していかないといけない。私の感覚だとアプリケーションの開発初期にログの設計や出力周りを作り込むものだけど、そうじゃない文化の開発もあるんだなという印象。あとからログ設計するとか、移行や既存のコードに手を入れたり、開発初期に作り込むより手間暇かかる気がするんだけど、そんな時間もなく開発してたってことなのかなぁ。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2021/1125/>コーディングスタイルの共通化</a></h1><div class=post-meta><time class=post-date>2021-11-25</time></div><span class=post-tags>#<a href=/diary/tags/java/>java</a>&nbsp;
#<a href=/diary/tags/ide/>ide</a>&nbsp;</span><div class=post-content><p>1時半に寝て6時に起きた</p><h2 id=ソースコードのフォーマッター>ソースコードのフォーマッター</h2><p>go 言語の <a href=https://pkg.go.dev/cmd/gofmt>gofmt</a> が成功をおさめたことからどんなプログラミング言語でもコーディングスタイルはツールで自動整形するのがよいという雰囲気が醸成され、とくに業務の開発においては統一すべしというルールを設けている組織が多いと思う。java はこの領域では後塵を拝していると言ってよいと思う。歴史的に java の言語仕様と ide は相性がよかったため、ide がコーディングスタイルを自動整形していた結果、ide ごとに互換性のない異なるコーディングスタイルが使われるようになってしまった。私がアリエルで開発していた頃、開発者はみんな eclipse しか使ってなかったので問題にならなかった。しかし、いまや私が知っている ide だけでも次のものがある。</p><ul><li><a href=https://www.eclipse.org/>eclipse</a></li><li><a href=https://www.jetbrains.com/idea/>intellij idea</a></li><li><a href=https://netbeans.apache.org/>netbeans</a></li><li><a href=https://code.visualstudio.com/>vscode</a></li></ul><p>この問題を解決するツールとして最もメジャーなのは <a href=https://github.com/google/google-java-format>google-java-format</a> で、当初はこのツールを導入しようと考えていた。しかし、開発チームのテックリードから google-java-format のコーディングスタイルはひどい、一番優れているのは intellij idea だというお気持ちを表明された。導入を止めろと言われたわけではないが、チームに入ったばかりの私はテックリードのお気持ちに忖度して google-java-format の導入を断念した。代わりに intellij idea のデフォルトフォーマットをどうやって他の ide を共有するかを調べたところ、<a href=https://www.jetbrains.com/help/idea/configuring-code-style.html#editorconfig>Manage code style on a directory level with EditorConfig</a> で <a href=https://editorconfig.org/>EditorConfig</a> の設定 (<code>.editorconfig</code>) を intellij idea で再利用できることがわかった。</p><p>うちの開発チームのメンバーは intellij idea と vscode しか使っていないため、現状はこれで解決できるように思えた。intellij idea にはデフォルトで EditorConfig プラグインがバンドルされていて有効になっている。リポジトリのルートディレクトリに <code>.editorconfig</code> があれば自動的にそれを読み込んでくれる。そこで intellij idea のデフォルト設定を <code>.editorconfig</code> 形式でエクスポートして、それをリポジトリのルートディレクトリに配置することでコーディングスタイルのフォーマッターを共通化できた。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2021/1117/>Testcontainers を触ってみた</a></h1><div class=post-meta><time class=post-date>2021-11-17</time></div><span class=post-tags>#<a href=/diary/tags/morning-activity/>morning activity</a>&nbsp;
#<a href=/diary/tags/event/>event</a>&nbsp;
#<a href=/diary/tags/java/>java</a>&nbsp;</span><div class=post-content><p>23時頃に寝て3時に起きて、そこから寝たり起きたりしながら6時に半に起きた。怖い夢をみて眠れなくなって中途半端に寝てた。</p><h2 id=朝活-雑談>朝活: 雑談</h2><p><a href=https://kobe-sannomiya-dev.connpass.com/event/231078/>【三宮.dev オンライン】リモート朝活もくもく会</a> に参加した。寝坊、、、というよりは起きてたけど、イベントを忘れていて6時45分ぐらいから参加して主催者しかいなかったのでそのまま7時半まで雑談してた。始めが悪いとだらだらしてしまう。気をつけねば。</p><p>三宮.dev の主催者や参加者の常連さんたちとはだいぶ身近に話すにようになってきた。コミュニティって人間関係だと思っていて、話したり顔をあわせたりする回数が増えるに従って身近な知人になっていって、それ自体が価値の1つだったりすると思う。いま忘年会の企画を三宮.dev でも行っているが、bizpy と合同でやっていいんじゃないかと考えている。</p><h2 id=testcontainers>Testcontainers</h2><p>DB を使ったユニットテストのために <a href=https://www.testcontainers.org/modules/databases/postgres/>Testcontainers Postgres Module</a> を使ってみた。docker hub からイメージを取得して JUnit のテストプロセスの中からアクセスできるようにするためのライブラリになる。コンテナの扱いをテストコードから管理したいときなどに便利。ちょっと調べて簡単に設定できたのでまた時間のあるときに会社のブログに記事を書こうと思う。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2021/0929/>読書とイベント参加</a></h1><div class=post-meta><time class=post-date>2021-09-29</time></div><span class=post-tags>#<a href=/diary/tags/book/>book</a>&nbsp;
#<a href=/diary/tags/java/>java</a>&nbsp;
</span><img src=/diary/img/2021/0929_temperature.jpg class=post-cover alt=読書とイベント参加 title="Cover Image"><div class=post-content><p>0時頃に寝て8時ぐらいに起きる。やや発熱して疲れてたせいか、久しぶりに早く寝付けた。一日を通して体温は平均36.7℃なのでもう副反応は過ぎたみたい。体調もまったく悪くない。</p><h2 id=joel-on-software>Joel on Software</h2><p>過去に働いていた会社での課題管理のやり方や開発方法論について、当時の上司と雑談したところ <a href=https://en.wikipedia.org/wiki/Joel_Spolsky>Joel Spolsky</a> に由来するということを聞いた。そこで今更ながらに <a href=https://www.shoeisha.co.jp/book/detail/9784798118925>More Joel on Software</a> を読むことにした。2000年代に書かれた記事の内容なのでいまとなっては古典に分類される本かもしれない。だいたい半分ぐらい読んだ。技術の詳細に言及した内容は古くなっていてあまり有用ではないものも多いけど、マネジメントや優秀なプログラマーの特性などはいまでも通用する内容に思えた。あとで私が関心をもった内容をブログでまとめることにする。</p><p>第10章コンピュータサイエンスの学生へのアドバイスで「卒業するまでにミクロ経済学を学ぶこと」という節がある。著者がミクロ経済学を推奨する理由を引用するとこれら。</p><blockquote><p>ミクロ経済学はビジネスで重要な理論すべての基礎となっている。需要と供給とか、競争優位とか、NPV とか割り引きとか限界効能について知らなければ、ビジネスの仕組みが全然理解できないからだ。</p><p>マクロ経済学は、当たっているよりもはずれていることの方が多い。スキップしてよい。それ以降はただ悪くなっていく一方。</p><p>ビジネスの基礎を理解しているプログラマは、理解していないプログラマよりもビジネスにおいてずっと価値が高いからだ。</p></blockquote><p>学んだことがなかったので簡単そうな <a href=https://www.iwanami.co.jp/book/b285381.html>ミクロ経済学入門の入門</a> を購入した。</p><p>読んでて気づきを得てふとツィートした。</p><blockquote class=twitter-tweet><p lang=ja dir=ltr>なので、システムのコンポーネントに関しての意思決定をするとき、必ずしも上位の意思決定者の判断が正しいわけではなく、現場のメンバーに判断を委ねる状況が最適な場合もある。一方向じゃなく、双方向の情報の非対称性を解消する取り組みが大事。</p>&mdash; Tetsuya Morimoto (@t2y) <a href="https://twitter.com/t2y/status/1443024587944464388?ref_src=twsrc%5Etfw">September 29, 2021</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script><h2 id=java-17-リリースイベント>Java 17 リリースイベント</h2><p><a href=https://jjug.doorkeeper.jp/events/127204>【オンライン】 JJUGナイトセミナー「Java 17 リリース記念イベント with Foojay」9/29(水) 開催</a> に参加した。Java の LTS はいま過渡期でややこしいことになって、8, 11, 17 になる。リリースされたばかりの Java 17 は LTS で重要なバージョンになる。<a href=https://www.oracle.com/jp/java/technologies/java-se-support-roadmap.html>Oracle Java SE Supportロードマップ</a> から Premier Support 期限が次になる。</p><ul><li>8: 2022年3月</li><li>11: 2023年9月</li><li>17: 2026年9月</li></ul><p>いま 11 を使っている組織はいいが、8 を使っている組織もまだまだ多いと推測する。8 と 11 の Premier Support 期限が近いことから 8 を使っている組織は 17 に一気にバージョンアップすることが想定される。どこかのタイミングで Java 17 を前提した開発に切り替わっていくだろうと思われる。</p><p>最初の発表は Pattern Matching & Sealed Classes に特化した内容。これまでは instanceof と共に使う機能だった。switch 構文とパターンマッチングを組み合わせると、コードが簡潔になって <a href=https://en.wikipedia.org/wiki/Cognitive_complexity>Cognitive complexity</a> を下げるという。発表者が Type Guard という呼び方をしていた。Type Guard をググると TypeScript の記事がヒットする。<a href=https://openjdk.java.net/jeps/406>JEP 406: Pattern Matching for switch (Preview)</a> ではこれを <em>guarded pattern</em> と呼んでいる。まだあまり一般的な用語ではないのかもしれない。あとは Sealed クラスと組み合わせた switch 構文のコード例では、すべてのパターンが網羅されていることをコンパイラが検出して <em>default</em> 句が不要になるコード例も紹介されててよさそうにみえた。但し、switch 構文のパターンマッチングは preview なので実際には 17 ではまだ使われないのかもしれない。今後もさらに switch 構文とパターンマッチングの機能拡張が行われる展望らしい。</p><p>2番目の発表は Java 17 の全体的な話し。fix した issues のツリーマップで contributor の分布を紹介していた。oracle, redhat, independent の順番に多い。oracle が過半数以上。日本だと ntt data が一番貢献してた。spring フレームワークの次期バージョンは Java 17 がベースラインになる。java のアップグレードを促す要因の1つにはなるはず。lts なのになぜ preview や incubator があるのか？openjdk 開発側は6ヶ月というリリースサイクルを守っている。lts にするか否かは開発者が決めているらしい。graalvm のリリースサイクルは java とは異なる。こちらは年3回のリリースなので次のリリースで出てくるはず？いくつか jep の内容を紹介してた。jep の概要は <a href=https://qiita.com/ReiTsukikazu/items/407d61cb66fa4f562bf9>Java17の新機能をざっくり紹介</a> にまとまっている。さくらばさんがパッケージの api レベルでの変更を <a href=http://www.javainthebox.com/2021/09/jepjava-17.html>JEPでは語れないJava 17</a> にまとめている。ざっと目を通して興味があるものがあればみとくぐらい。8 から 17 への移行の記事やドキュメントなども紹介されてた。移行について基本は <a href=https://docs.oracle.com/en/java/javase/17/migrate/getting-started.html>Oracle JDK Migration Guide</a> を読めとのこと。8 から 17 の移行せずにその次の 23 を待つと作り直しになってしまいますよと 17 への移行を推奨してた。</p></div></article><div class=pagination><div class=pagination__buttons><a href=/diary/tags/java/page/3/ class="button previous"><span class=button__icon>←</span>
<span class=button__text>最近の日記</span></a></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2025 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>