<!doctype html><html lang=en><head><title>java :: forest nook</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/tags/java/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="java"><meta property="og:description" content><meta property="og:url" content="/diary/tags/java/"><meta property="og:site_name" content="forest nook"><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/tags/java/index.xml rel=alternate type=application/rss+xml title="forest nook"></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><div class=posts><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0924/>quarkus のビルド環境に手間取った</a></h1><div class=post-meta><time class=post-date>2022-09-24 (Sat.) ::</time></div><span class=post-tags>#<a href=/diary/tags/java/>java</a>&nbsp;
#<a href=/diary/tags/quarkus/>quarkus</a>&nbsp;</span><div class=post-content><p>1時に寝て7時に起きた。休みだとやっぱりだらだらしてしまうな。</p><h2 id=bolt-for-java-on-quarkus>bolt for java on quarkus</h2><p>昨日の続き。スクラッチから quarkus のアプリケーションの設定を gradle で行う。quarkus の上で slack apps としてのコマンドとイベントの振る舞いだけ確認した。</p><ul><li><a href=https://github.com/t2y/bolt-java-sample>https://github.com/t2y/bolt-java-sample</a></li></ul><p>私は新規に開発する java アプリケーションは <a href=https://gradle.org/>gradle</a> を使うようにしている。これは java のよくないところだろうけれど、言語コミュニティが提供するパッケージマネージャやビルドツールがないから複数のツールが乱立している。maven から gradle に緩やかに移行していくのかな？と私は考えていたけれど、昔からあるライブラリのビルドツールを変更するのは労力に見合うメリットがないのか、maven も依然としてずっと使われ続けていくのかもしれない。maven と gradle の両対応という保守コストは、この先しばらく java コミュニティが抱えていく保守コストと言えるのかもしれない。quarkus はさらに独自の <a href=https://quarkus.io/guides/cli-tooling>Quarkus CLI</a> というビルドツールを提供している。そのため、ビルドのための設定だけで quarkus cli, maven, gradle の3つの方法があり、ドキュメントにもそれぞれの設定方法が書いてある。これを保守する方も使う方もややこしくて大変だなぁという印象を受けた。</p><p><a href=https://quarkus.io/guides/gradle-tooling>BUILDING QUARKUS APPS WITH GRADLE</a> をみながら次の maven cli で作った gradle プロジェクトのテンプレートをみながら build.gradle の設定をした。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ mvn io.quarkus.platform:quarkus-maven-plugin:2.12.3.Final:create <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -DprojectGroupId<span style=color:#f92672>=</span>my-groupId <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -DprojectArtifactId<span style=color:#f92672>=</span>my-artifactId <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -Dextensions<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;resteasy-reactive,resteasy-reactive-jackson&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -DbuildTool<span style=color:#f92672>=</span>gradle
</span></span></code></pre></div><p>あと私は設定ファイルを yaml で管理したいので次の拡張も追加した。gradle タスクでも定義されていて次のように実行する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./gradlew addExtension --extensions<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;quarkus-config-yaml&#34;</span>
</span></span></code></pre></div><p>この cli がやっていることは基本的に dependencies に次の1行を追加するだけ。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=display:flex><span>dependencies <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  implementation <span style=color:#e6db74>&#39;io.quarkus:quarkus-config-yaml&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>設定ファイルを yaml から読み込めるようになると初期設定は次のようになる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ vi app/src/main/resources/application.yaml 
</span></span><span style=display:flex><span>quarkus:
</span></span><span style=display:flex><span>  http:
</span></span><span style=display:flex><span>    port: <span style=color:#ae81ff>3000</span>
</span></span><span style=display:flex><span>  log:
</span></span><span style=display:flex><span>    level: INFO
</span></span><span style=display:flex><span>    category:
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;com.slack.api&#34;</span>:
</span></span><span style=display:flex><span>        level: DEBUG
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;tutorial.bolt.sample&#34;</span>:
</span></span><span style=display:flex><span>        level: DEBUG
</span></span><span style=display:flex><span>  package:
</span></span><span style=display:flex><span>    type: uber-jar
</span></span></code></pre></div><p>開発サーバーは次のようにして起動する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ./gradlew quarkusDev
</span></span></code></pre></div><blockquote><p>quarkusDev enables hot deployment with background compilation, which means that when you modify your Java files or your resource files and refresh your browser these changes will automatically take effect. This works too for resource files like the configuration property file. The act of refreshing the browser triggers a scan of the workspace, and if any changes are detected the Java files are compiled, and the application is redeployed, then your request is serviced by the redeployed application. If there are any issues with compilation or deployment an error page will let you know.</p><p><a href=https://quarkus.io/guides/gradle-tooling#dev-mode>https://quarkus.io/guides/gradle-tooling#dev-mode</a></p></blockquote><p>hot deployment 機能のおかげでソースや設定ファイルを変更すると自動的に反映される。他の言語なら普通の機能かもしれないけど、java でもそういう仕組みが普通になったんだなと思って感心した。変化に付いていけない開発者のような気持ちになった。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0923/>slack apps 開発に着手</a></h1><div class=post-meta><time class=post-date>2022-09-23 (Fri.) ::</time></div><span class=post-tags>#<a href=/diary/tags/java/>java</a>&nbsp;
#<a href=/diary/tags/slack/>slack</a>&nbsp;
#<a href=/diary/tags/quarkus/>quarkus</a>&nbsp;</span><div class=post-content><p>0時に寝て6時に起きた。あまりうまく眠れなかった。</p><h2 id=bolt-for-java>bolt for java</h2><p>slack apps を開発するためのフレームワークとして <em>bolt</em> と呼ばれる高レベルのフレームワークが提供されている。このフレームワークは <em>slack sdk</em> を使って作られていて、slack apps の開発が簡単になるようにユーティリティが提供されている。<a href=https://api.slack.com/tools/bolt>The Bolt family of SDKs</a> によると、javascript, python, java 向けに提供されている。以前 bizpy でも slack アプリ開発のチュートリアルの勉強会をしたことがある。そのときは bolot for python を使っていた。</p><ul><li><a href=https://github.com/t2y/python-study/tree/master/BizPy/slack>python-study/BizPy/slack</a></li></ul><p>一度触ったことがあったので <em>bolt</em> がどういうものかはすでに知っている。その java 版を使って slack apps を作ってみようと取り組み始めた。まずはチュートリアルを一通りやってみようと次のリポジトリでやってみた。</p><ul><li><a href=https://github.com/t2y/bolt-java-sample>https://github.com/t2y/bolt-java-sample</a></li></ul><p>チュートリアルの内容を動かすだけならすぐできた。次に java の waf は何を使おうかを調べてた。<a href=https://slack.dev/java-slack-sdk/guides/supported-web-frameworks>Supported Web Frameworks</a> によると、次の4つがある。</p><ul><li>spring boot</li><li>micronaut</li><li>quarkus undertow</li><li>helidon se</li></ul><p>さらに <a href=https://github.com/slackapi/java-slack-sdk#modules>slackapi/java-slack-sdk#modules</a> をみると、次の2つも追加されている。どちらも kotlin 向けのフレームワークらしい。</p><ul><li>http4k</li><li>ktor</li></ul><p>それぞれのフレームワークの説明を読んだり、この機に kotlin をやってみることも検討してみた。長期間の保守を前提にすると、一時的に触るだけの言語を使うのもどうかな？と思うところはあってやはり java でやることにした。spring boot はお仕事でよく使っていてどういうものかを理解しているので選択するなら他の3つのどれか。</p><blockquote><p>Quarkus was created to enable Java developers to create applications for a modern, cloud-native world. Quarkus is a Kubernetes-native Java framework tailored for GraalVM and HotSpot, crafted from best-of-breed Java libraries and standards. The goal is to make Java the leading platform in Kubernetes and serverless environments while offering developers a framework to address a wider range of distributed application architectures.</p><p><a href=https://quarkus.io/about/>https://quarkus.io/about/</a></p></blockquote><p>いま kubernetes に好印象をもっていることもあり、この説明を読んで <a href=https://quarkus.io/>quarkus</a> を選択することに決めた。そんなことをつぶやいていたら、せらさんからいくつかアドバイスをいただけた。slack について何かをつぶやくと100%返信がくる (ソースは私の経験) 。感謝。</p><p><blockquote class=twitter-tweet><p lang=ja dir=ltr>そうですね。App クラス側は servlet やその他のライタイム含め、何にも依存していないので標準でアダプターがない場合にも自分で書けば任意の Web フレークワークで動かせます。 <a href="https://twitter.com/hashtag/SlackDevJP?src=hash&ref_src=twsrc%5Etfw">#SlackDevJP</a></p>&mdash; Kazuhiro Sera (瀬良) (@seratch_ja) <a href="https://twitter.com/seratch_ja/status/1573205191071240192?ref_src=twsrc%5Etfw">September 23, 2022</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script><blockquote class=twitter-tweet><p lang=ja dir=ltr>Quarkus いいですよ！ただ、GraalVM については少なくとも短期的にはサポート予定ありません。 <a href=https://t.co/0cVGgohLez>https://t.co/0cVGgohLez</a> <a href="https://twitter.com/hashtag/SlackDevJP?src=hash&ref_src=twsrc%5Etfw">#SlackDevJP</a></p>&mdash; Kazuhiro Sera (瀬良) (@seratch_ja) <a href="https://twitter.com/seratch_ja/status/1573205502808686598?ref_src=twsrc%5Etfw">September 23, 2022</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script></p><p>java アプリケーションを実行可能なバイナリにコンパイルする機能を <a href=https://www.graalvm.org/>graalvm</a> が提供している。graalvm ではこのバイナリのことを <a href=https://www.graalvm.org/22.1/reference-manual/native-image/>native image</a> と呼んでいる。quarkus は java の web アプリケーションフレームワークであり、graalvm を使って native image を作ることも考慮して設計されている。コンテナでデプロイすることを想定したフレームワークと言える。残念ながら slack sdk が使っているライブラリである gson はリフレクションを多用していて、それが graalvm とは相性が悪いだろうという話しで現時点では native image 化は難しいみたい。たしか native image でリフレクションを使うには使っている箇所を設定にすべて列挙しないといけなかった気がする。リフレクションのような動的に用いるものと静的な設定は相性が悪く、がんばれば特定のバージョンで動くものは設定できるかもしれないけど、ライブラリのようなものでバージョンアップに追随するのはしんどいという話しなのかなと思う。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0921/>最近の java の勉強</a></h1><div class=post-meta><time class=post-date>2022-09-21 (Wed.) ::</time></div><span class=post-tags>#<a href=/diary/tags/java/>java</a>&nbsp;
#<a href=/diary/tags/event/>event</a>&nbsp;</span><div class=post-content><p>0時に寝て7時に起きた。</p><h2 id=運用対応>運用対応</h2><p>ある施設のサービスインのシステム切り替えでほぼ1日を終えた。昨日のロガーの要件を詰めようと思っていたけど、なんの話しもできないまま1日が過ぎた。トラブルの運用対応に開発リーダーが忙しくて、他の外部開発者は遊休中。自分の時間を無駄遣いしているようで辛い。あと1ヶ月の辛抱。</p><h2 id=java-勉強会>java 勉強会</h2><p>たまたま <a href=https://www.publickey1.jp/blog/22/java_19risc-v1java_21lts.html>Java 19が正式リリース。より軽量な仮想スレッド、RISC-Vへの移植など新機能。1年後のJava 21が次のLTS版に</a> をみかけた。今後は java の lts リリースが3年から2年に変わるらしい。他の言語では軽量プロセスと呼ばれる仕組みを java では Virtual Threads (仮想スレッド：<a href=https://openjdk.org/jeps/425>JEP 425</a>) と呼ぶらしい。まだプレビュー版だけど、次の lts には使えるようになっていると思う。サーバー用途で言えば仮想スレッドを使ったサーバーが主流になれば java の運用時のメモリ使用量がいくらか減ることになって嬉しい状況はあるのかもしれない。</p><p>その記事と同時にタイムラインで <a href=https://jjug.doorkeeper.jp/events/142958>Java仕様勉強会「Java SEの動向 2022夏」</a> をみかけたので気付いたタイミングで参加した。現在の java の機能拡張をしている様々なプロジェクトの紹介がされていた。半分は知ってたけど、半分ぐらいは知らないものもあって勉強にはなった。プロジェクトが多過ぎてだんだん聞いていて飽きてくるのもあったので勉強会のやり方を見直してもいいかもしれないとも思った。</p><iframe class=speakerdeck-iframe frameborder=0 src=https://speakerdeck.com/player/5174987a33c3400091288cfc1ed598e0 title="Java SEの動向 2022夏版" allowfullscreen mozallowfullscreen=true webkitallowfullscreen=true style="border:0;background:padding-box padding-box rgba(0,0,0,.1);margin:0;padding:0;border-radius:6px;box-shadow:rgba(0,0,0,.2)0 5px 40px;width:560px;height:314px" data-ratio=1.78343949044586></iframe><p>その後にきしださんが java 19 の紹介をされていたのでそのまま視聴した。switch 式やパターンマッチングとの親和性あたりは私も期待していた内容の通りに拡張されているようにみえてよさそうの思う。次の lts はまだ先だけど、そのときに java を書くのが楽しみになるぐらいの機能拡張だとは思う。仮想スレッドの説明もデモしていた。他の言語で軽量プロセスを扱っている人にとっては意図した内容なので目新しくはないが、java でフレームワークを作っている開発者にとってはパフォーマンスを向上できる可能性があるので関心の高い機能だとも思う。</p><div class=video-container><iframe src=https://www.youtube.com/embed/-5zlmBnxmCU allowfullscreen title="Java 19新機能まとめ"></iframe></div></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0818/>spring boot におけるプロキシ実装</a></h1><div class=post-meta><time class=post-date>2022-08-18 (Thu.) ::</time></div><span class=post-tags>#<a href=/diary/tags/java/>java</a>&nbsp;
#<a href=/diary/tags/spring-boot/>spring boot</a>&nbsp;</span><div class=post-content><p>0時に寝て7時に起きた。</p><h2 id=spring-boot-における簡易的なミドルウェアの実装>spring boot における簡易的なミドルウェアの実装</h2><p>bff (backend for frontend) の web api サーバーから別の web api サーバーのエンドポイントを呼び出す処理を書いていてただプロキシする処理のためだけに <a href=https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#getting-started.first-application.code.mvc-annotations>controller</a> を書くのも面倒だなと気付いた。controller よりも低いレイヤで raw request を扱うにはどうしたらいいかを調べてみたら spring の <em>Filter</em> を使うのが最も簡単そうにみえた。その spring の Filter の1つである <em>OncePerRequestFilter</em> を使って簡易的なプロキシの処理を実装してみた。OncePerRequestFilter はリクエストに対して1度だけ呼ばれることが保証された Filter になる。これらのドキュメントがどこにあるかわからなかったので baeldung のチュートリアル <a href=https://www.baeldung.com/spring-onceperrequestfilter>What Is OncePerRequestFilter?</a> をみた方が早いかもしれない。</p><p>Filter が複数あるときは実行順序を指定したいときは <a href=https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#web.servlet.embedded-container.servlets-filters-listeners.beans>Order</a> というアノテーションで制御できる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Component</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Order</span><span style=color:#f92672>(</span><span style=color:#ae81ff>30</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyFilter</span> <span style=color:#66d9ef>extends</span> OncePerRequestFilter <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>OncePerRequestFilter の <em>doFilterInternal</em> メソッドをオーバーライドすれば任意のミドルウェアっぽい処理を実装できる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>doFilterInternal</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>        HttpServletRequest request<span style=color:#f92672>,</span> HttpServletResponse response<span style=color:#f92672>,</span> FilterChain filterChain<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throws</span> ServletException<span style=color:#f92672>,</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ここに任意の前処理を実装する
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        filterChain<span style=color:#f92672>.</span><span style=color:#a6e22e>doFilter</span><span style=color:#f92672>(</span>request<span style=color:#f92672>,</span> response<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ここに任意の後処理を実装する
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>あとは HttpServletRequest と HttpServletResponse を直接操作してリクエストから必要な情報を取り出して、クライアントでリクエストして返ってきたレスポンスをそのまま返してあげればよい。簡単に実装したものが次になる。クライアントには <a href=/diary/posts/2022/0722/>以前に少し調べたことを書いた WebClient</a> を使っている。WebClient じゃなければ、もう少しシンプルに書ける気もする。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Component</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Order</span><span style=color:#f92672>(</span><span style=color:#ae81ff>30</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RequestForwardFilter</span> <span style=color:#66d9ef>extends</span> OncePerRequestFilter <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> List<span style=color:#f92672>&lt;</span>RequestForwardMatcher<span style=color:#f92672>&gt;</span> matchers<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>doFilterInternal</span><span style=color:#f92672>(</span>HttpServletRequest request<span style=color:#f92672>,</span> HttpServletResponse response<span style=color:#f92672>,</span> FilterChain filterChain<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> ServletException<span style=color:#f92672>,</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        var matcher <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getMatcher</span><span style=color:#f92672>(</span>request<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>matcher<span style=color:#f92672>.</span><span style=color:#a6e22e>isEmpty</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            filterChain<span style=color:#f92672>.</span><span style=color:#a6e22e>doFilter</span><span style=color:#f92672>(</span>request<span style=color:#f92672>,</span> response<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        writeResponse<span style=color:#f92672>(</span>response<span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>forwardRequest</span><span style=color:#f92672>(</span>request<span style=color:#f92672>,</span> matcher<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getWebClient</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Optional<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>[]&gt;</span> <span style=color:#a6e22e>forwardRequest</span><span style=color:#f92672>(</span>HttpServletRequest request<span style=color:#f92672>,</span> WebClient webClient<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        var method <span style=color:#f92672>=</span> HttpMethod<span style=color:#f92672>.</span><span style=color:#a6e22e>resolve</span><span style=color:#f92672>(</span>request<span style=color:#f92672>.</span><span style=color:#a6e22e>getMethod</span><span style=color:#f92672>().</span><span style=color:#a6e22e>toUpperCase</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        var originalUri <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span><span style=color:#a6e22e>getRequestURI</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        var uri <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getUri</span><span style=color:#f92672>(</span>originalUri<span style=color:#f92672>,</span> request<span style=color:#f92672>.</span><span style=color:#a6e22e>getQueryString</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        var spec <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getSpec</span><span style=color:#f92672>(</span>method<span style=color:#f92672>,</span> webClient<span style=color:#f92672>,</span> uri<span style=color:#f92672>,</span> request<span style=color:#f92672>.</span><span style=color:#a6e22e>getReader</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> spec<span style=color:#f92672>.</span><span style=color:#a6e22e>retrieve</span><span style=color:#f92672>().</span><span style=color:#a6e22e>bodyToMono</span><span style=color:#f92672>(</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>[].</span><span style=color:#a6e22e>class</span><span style=color:#f92672>).</span><span style=color:#a6e22e>blockOptional</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>writeResponse</span><span style=color:#f92672>(</span>HttpServletResponse response<span style=color:#f92672>,</span> Optional<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>[]&gt;</span> bytes<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>bytes<span style=color:#f92672>.</span><span style=color:#a6e22e>isEmpty</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        var stream <span style=color:#f92672>=</span> response<span style=color:#f92672>.</span><span style=color:#a6e22e>getOutputStream</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        stream<span style=color:#f92672>.</span><span style=color:#a6e22e>write</span><span style=color:#f92672>(</span>bytes<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        stream<span style=color:#f92672>.</span><span style=color:#a6e22e>flush</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        stream<span style=color:#f92672>.</span><span style=color:#a6e22e>close</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> <span style=color:#a6e22e>getRequestBody</span><span style=color:#f92672>(</span>BufferedReader reader<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> reader<span style=color:#f92672>.</span><span style=color:#a6e22e>lines</span><span style=color:#f92672>().</span><span style=color:#a6e22e>collect</span><span style=color:#f92672>(</span>Collectors<span style=color:#f92672>.</span><span style=color:#a6e22e>joining</span><span style=color:#f92672>()).</span><span style=color:#a6e22e>getBytes</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String <span style=color:#a6e22e>getUri</span><span style=color:#f92672>(</span>String originalUri<span style=color:#f92672>,</span> String queryString<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        var path <span style=color:#f92672>=</span> originalUri<span style=color:#f92672>.</span><span style=color:#a6e22e>replace</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/api&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>StringUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>hasLength</span><span style=color:#f92672>(</span>queryString<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> String<span style=color:#f92672>.</span><span style=color:#a6e22e>format</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;%s?%s&#34;</span><span style=color:#f92672>,</span> path<span style=color:#f92672>,</span> queryString<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> path<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> WebClient<span style=color:#f92672>.</span><span style=color:#a6e22e>RequestHeadersSpec</span><span style=color:#f92672>&lt;?&gt;</span> getSpec<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>            HttpMethod method<span style=color:#f92672>,</span> WebClient webClient<span style=color:#f92672>,</span> String uri<span style=color:#f92672>,</span> BufferedReader reader<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>switch</span> <span style=color:#f92672>(</span>method<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> GET<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> webClient<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>().</span><span style=color:#a6e22e>uri</span><span style=color:#f92672>(</span>uri<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> POST<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> webClient<span style=color:#f92672>.</span><span style=color:#a6e22e>post</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>.</span><span style=color:#a6e22e>uri</span><span style=color:#f92672>(</span>uri<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>.</span><span style=color:#a6e22e>header</span><span style=color:#f92672>(</span>HttpHeaders<span style=color:#f92672>.</span><span style=color:#a6e22e>CONTENT_TYPE</span><span style=color:#f92672>,</span> MediaType<span style=color:#f92672>.</span><span style=color:#a6e22e>APPLICATION_JSON_VALUE</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>.</span><span style=color:#a6e22e>bodyValue</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getRequestBody</span><span style=color:#f92672>(</span>reader<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> PUT<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> webClient<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>.</span><span style=color:#a6e22e>uri</span><span style=color:#f92672>(</span>uri<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>.</span><span style=color:#a6e22e>header</span><span style=color:#f92672>(</span>HttpHeaders<span style=color:#f92672>.</span><span style=color:#a6e22e>CONTENT_TYPE</span><span style=color:#f92672>,</span> MediaType<span style=color:#f92672>.</span><span style=color:#a6e22e>APPLICATION_JSON_VALUE</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>.</span><span style=color:#a6e22e>bodyValue</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getRequestBody</span><span style=color:#f92672>(</span>reader<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> DELETE<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> webClient<span style=color:#f92672>.</span><span style=color:#a6e22e>delete</span><span style=color:#f92672>().</span><span style=color:#a6e22e>uri</span><span style=color:#f92672>(</span>uri<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span>String<span style=color:#f92672>.</span><span style=color:#a6e22e>format</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Unsupported HTTP method: %s&#34;</span><span style=color:#f92672>,</span> method<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Optional<span style=color:#f92672>&lt;</span>RequestForwardMatcher<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getMatcher</span><span style=color:#f92672>(</span>HttpServletRequest request<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>var matcher <span style=color:#f92672>:</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>matchers</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>matcher<span style=color:#f92672>.</span><span style=color:#a6e22e>match</span><span style=color:#f92672>(</span>request<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> Optional<span style=color:#f92672>.</span><span style=color:#a6e22e>of</span><span style=color:#f92672>(</span>matcher<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> Optional<span style=color:#f92672>.</span><span style=color:#a6e22e>empty</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>matcher のサンプル実装。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RequestForwardMatcher</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String ASTERISK <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;*&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Pattern pattern<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> List<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> methods<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> WebClient webClient<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>RequestForwardMatcher</span><span style=color:#f92672>(</span>String pattern<span style=color:#f92672>,</span> List<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> methods<span style=color:#f92672>,</span> WebClient webClient<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>pattern</span> <span style=color:#f92672>=</span> Pattern<span style=color:#f92672>.</span><span style=color:#a6e22e>compile</span><span style=color:#f92672>(</span>pattern<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>methods</span> <span style=color:#f92672>=</span> methods<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>webClient</span> <span style=color:#f92672>=</span> webClient<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>matchMethod</span><span style=color:#f92672>(</span>String method<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>methods</span><span style=color:#f92672>.</span><span style=color:#a6e22e>contains</span><span style=color:#f92672>(</span>ASTERISK<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>methods</span><span style=color:#f92672>.</span><span style=color:#a6e22e>contains</span><span style=color:#f92672>(</span>method<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>match</span><span style=color:#f92672>(</span>HttpServletRequest request<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>matchMethod<span style=color:#f92672>(</span>request<span style=color:#f92672>.</span><span style=color:#a6e22e>getMethod</span><span style=color:#f92672>()))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>pattern</span><span style=color:#f92672>.</span><span style=color:#a6e22e>matcher</span><span style=color:#f92672>(</span>request<span style=color:#f92672>.</span><span style=color:#a6e22e>getRequestURI</span><span style=color:#f92672>()).</span><span style=color:#a6e22e>matches</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> WebClient <span style=color:#a6e22e>getWebClient</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>webClient</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0812/>dto に対するリフレクションの是非</a></h1><div class=post-meta><time class=post-date>2022-08-12 (Fri.) ::</time></div><span class=post-tags>#<a href=/diary/tags/game/>game</a>&nbsp;
#<a href=/diary/tags/java/>java</a>&nbsp;</span><div class=post-content><p>1時に寝て7時に起きた。</p><h2 id=ドラクエタクトのリアルタイム対戦>ドラクエタクトのリアルタイム対戦</h2><p>もう2年間もずっとゲームし続けている。最近 <a href=https://game8.jp/dqtact/462546>リアルタイム対戦</a> モードがリリースされた。全然やる気なかったんやけど、リアルタイム対戦で得たコインでもらえるアイテムが魅力的なのでやることにした。そして、実際にアルタイム対戦をやってみるとはまる。運営の手の平でゲームさせられている。</p><ul><li>人間が相手で狡猾な戦略で負けると悔しい</li><li>人間が相手の戦略の方が創意工夫があって学びになる</li><li>実際にやり始めるとおもしろくなってきてずっとやってしまう</li></ul><p>できる時間を制限しているというのもうまいやり方だなと思っている。朝・昼・晩の7-9時、12-14時、19-22時に制限している。そこまでしてリアルタイムに人間同士をマッチングしてゲームさせる必要があるのか？という素朴な疑問に私は辿りつくが、おそらくゲーム開発者からみたらそうじゃない大事なユーザー体験があるのだろうと推測する。あと不思議なことが1つ。マッチングしていると、たまにわざと負けてくれる人がマッチングされる。チームのメンバーが1人で向こうが先行なら戦いを辞退 (こちらの勝ちになる) するし、こちらが先行でもすぐにやっつけられる。ちゃんと統計をとってないけど、20回に1回ぐらいの頻度でわざと負けてくれる人とマッチングする。あの人たちは一体どういう理由でわざと負けているんだろう？</p><h2 id=リフレクションのユーティリティを作った>リフレクションのユーティリティを作った</h2><p>いまお手伝いで開発している api サーバーは外界と内部のデータの境界を明確にわけていて、外向けのオブジェクト定義と内部向けのオブジェクト定義が異なる。ほとんど同じデータであっても dto を介して値を受け渡ししないといけない。そうすると、次のような dto と他のオブジェクトとの値渡しのための処理が型ごとにあちこちに実装されている。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> MyRecord <span style=color:#a6e22e>toMyRecord</span><span style=color:#f92672>(</span>MyDataInput in<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    var record <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> MyRecord<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    record<span style=color:#f92672>.</span><span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> in<span style=color:#f92672>.</span><span style=color:#a6e22e>id</span>
</span></span><span style=display:flex><span>    record<span style=color:#f92672>.</span><span style=color:#a6e22e>name</span> <span style=color:#f92672>=</span> in<span style=color:#f92672>.</span><span style=color:#a6e22e>name</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    record<span style=color:#f92672>.</span><span style=color:#a6e22e>someId1</span> <span style=color:#f92672>=</span> in<span style=color:#f92672>.</span><span style=color:#a6e22e>someId1</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    record<span style=color:#f92672>.</span><span style=color:#a6e22e>someId2</span> <span style=color:#f92672>=</span> in<span style=color:#f92672>.</span><span style=color:#a6e22e>someId2</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    record<span style=color:#f92672>.</span><span style=color:#a6e22e>someId3</span> <span style=color:#f92672>=</span> in<span style=color:#f92672>.</span><span style=color:#a6e22e>someId3</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    record<span style=color:#f92672>.</span><span style=color:#a6e22e>sortOrder</span> <span style=color:#f92672>=</span> in<span style=color:#f92672>.</span><span style=color:#a6e22e>sortOrder</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    record<span style=color:#f92672>.</span><span style=color:#a6e22e>createUser</span> <span style=color:#f92672>=</span> in<span style=color:#f92672>.</span><span style=color:#a6e22e>createUser</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    record<span style=color:#f92672>.</span><span style=color:#a6e22e>updateUser</span> <span style=color:#f92672>=</span> in<span style=color:#f92672>.</span><span style=color:#a6e22e>updateUser</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>メンバー数が20-30ぐらいあると、たまに値のセット忘れがあったり、あとから追加したメンバーの保守ができてないとか、たまにトラブルが起きる。これ自体は間違っているわけじゃなくて境界を明確にわけるメリットもあるのでプログラミングの煩雑さとトレードオフと言える。</p><p>最近、私が管理系の web api のエンドポイントを作る機会が多いせいか、dto と外部向けのオブジェクトを明確にわける必要のない要件もあったりする。試しにリフレクションを使って同名のフィールド間の値の受け渡しは自動でやってみたらどんな感じかな？と思って作ってみた。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ReflectionUtil</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>ReflectionUtil</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> AssertionError<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;ReflectionUtil is a utility class&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> Field <span style=color:#a6e22e>getField</span><span style=color:#f92672>(</span>Class<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> klass<span style=color:#f92672>,</span> String fieldName<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> klass<span style=color:#f92672>.</span><span style=color:#a6e22e>getDeclaredField</span><span style=color:#f92672>(</span>fieldName<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>NoSuchFieldException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#f92672>&lt;</span>T1<span style=color:#f92672>,</span> T2<span style=color:#f92672>&gt;</span> T2 <span style=color:#a6e22e>mapFieldValues</span><span style=color:#f92672>(</span>T1 fromInstance<span style=color:#f92672>,</span> T2 toInstance<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        var fromClass <span style=color:#f92672>=</span> fromInstance<span style=color:#f92672>.</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>var toField <span style=color:#f92672>:</span> toInstance<span style=color:#f92672>.</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getDeclaredFields</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            toField<span style=color:#f92672>.</span><span style=color:#a6e22e>setAccessible</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            var fromField <span style=color:#f92672>=</span> getField<span style=color:#f92672>(</span>fromClass<span style=color:#f92672>,</span> toField<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>fromField <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                fromField<span style=color:#f92672>.</span><span style=color:#a6e22e>setAccessible</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    toField<span style=color:#f92672>.</span><span style=color:#a6e22e>set</span><span style=color:#f92672>(</span>toInstance<span style=color:#f92672>,</span> fromField<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>fromInstance<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IllegalAccessException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span>e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> toInstance<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>これを使うと、先のコードがこれだけで済む。煩わしい値の受け渡しだけのコードを削減できる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>var record <span style=color:#f92672>=</span> ReflectionUtil<span style=color:#f92672>.</span><span style=color:#a6e22e>mapFieldValues</span><span style=color:#f92672>(</span>in<span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> MyRecord<span style=color:#f92672>());</span>
</span></span></code></pre></div><p>こんなことやると、セキュリティ的によくないとか反論されるかな？と思いながら pr を出してみたら思いの外、好評だったのでちょっと使ってみようと思う。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0807/>wiremock を使った kubernetes モックサーバーのテスト拡張</a></h1><div class=post-meta><time class=post-date>2022-08-07 (Sun.) ::</time></div><span class=post-tags>#<a href=/diary/tags/kubernetes/>kubernetes</a>&nbsp;
#<a href=/diary/tags/java/>java</a>&nbsp;
#<a href=/diary/tags/testing/>testing</a>&nbsp;</span><div class=post-content><p>2時に寝て7時に起きて9時までだらだらしてた。</p><h2 id=kubernetes-clients-のライブラリ実装>Kubernetes Clients のライブラリ実装</h2><p><a href=/diary/posts/2022/0806/#kubernetes-clients-のサンプル実装>昨日の続き</a> 。ある程度、クライアントの振る舞いを確認できたので自前のライブラリを作ることにした。ライブラリなのでテストをちゃんと書きたいと思って単体テストのやり方を調べてたら Kubernetes Clients のリポジトリにも単体テストはほとんどなくて、どうも e2e テストの方を重視しているようにもみえた。github issues を検索してみたら次の issue をみつけた。</p><ul><li><a href=https://github.com/apache/submarine/issues/956>[DESIGN] Add k8s mock client and server test case #956</a></li></ul><p>なにかしら単体テストの仕組みを作った方がいいんじゃないかという提案と一緒に issue の作者？かどうかはわからんけど、<a href=https://wiremock.org/>wiremock</a> を使ったテストのサンプルコードをあげていた。名前だけは聞いたことがあったけど、過去に使ったこともなく、どういうものか全くわかってない。ドキュメントを軽く読んでみたら http モックサーバーらしい。issue の内容を参考にしながら wiremock のドキュメントをみて junit5 のテスト拡張を書いてみた。これが適切な実装かはあまり自信がないけど、こんな感じでモックサーバーとモッククライアントの junit5 のテスト拡張を実装した。これは static なモックサーバーの設定になるので wiremock 自体の起動コストは速く感じた。ライブラリのテストとしては申し分ない。いまのところは自画自賛。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Documented</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Target</span><span style=color:#f92672>(</span>ElementType<span style=color:#f92672>.</span><span style=color:#a6e22e>FIELD</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Retention</span><span style=color:#f92672>(</span>RetentionPolicy<span style=color:#f92672>.</span><span style=color:#a6e22e>RUNTIME</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#a6e22e>@interface</span> KubernetesApiClient <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SetupKubernetesWireMock</span> <span style=color:#66d9ef>implements</span> BeforeAllCallback<span style=color:#f92672>,</span> BeforeEachCallback<span style=color:#f92672>,</span> ExtensionContext<span style=color:#f92672>.</span><span style=color:#a6e22e>Store</span><span style=color:#f92672>.</span><span style=color:#a6e22e>CloseableResource</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> Logger logger <span style=color:#f92672>=</span> LogManager<span style=color:#f92672>.</span><span style=color:#a6e22e>getLogger</span><span style=color:#f92672>(</span>SetupKubernetesWireMock<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> PORT <span style=color:#f92672>=</span> <span style=color:#ae81ff>8384</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> WireMockServer wireMockServer <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> WireMockServer<span style=color:#f92672>(</span>options<span style=color:#f92672>().</span><span style=color:#a6e22e>port</span><span style=color:#f92672>(</span>PORT<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>boolean</span> started <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> ApiClient apiClient<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>beforeAll</span><span style=color:#f92672>(</span>ExtensionContext context<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> Exception <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>started<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            wireMockServer<span style=color:#f92672>.</span><span style=color:#a6e22e>start</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            started <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>configureMockClient</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            var basePath <span style=color:#f92672>=</span> String<span style=color:#f92672>.</span><span style=color:#a6e22e>format</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;http://localhost:%d&#34;</span><span style=color:#f92672>,</span> wireMockServer<span style=color:#f92672>.</span><span style=color:#a6e22e>port</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>apiClient</span> <span style=color:#f92672>=</span> ClientBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>standard</span><span style=color:#f92672>().</span><span style=color:#a6e22e>setBasePath</span><span style=color:#f92672>(</span>basePath<span style=color:#f92672>).</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            logger<span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;started kubernetes wiremock: {}&#34;</span><span style=color:#f92672>,</span> basePath<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            context<span style=color:#f92672>.</span><span style=color:#a6e22e>getRoot</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getStore</span><span style=color:#f92672>(</span>GLOBAL<span style=color:#f92672>).</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;SetupKubernetesWireMock&#34;</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>beforeEach</span><span style=color:#f92672>(</span>ExtensionContext context<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> Exception <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>var instance <span style=color:#f92672>:</span> context<span style=color:#f92672>.</span><span style=color:#a6e22e>getRequiredTestInstances</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getAllInstances</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>var field <span style=color:#f92672>:</span> instance<span style=color:#f92672>.</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getDeclaredFields</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>field<span style=color:#f92672>.</span><span style=color:#a6e22e>isAnnotationPresent</span><span style=color:#f92672>(</span>KubernetesApiClient<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    field<span style=color:#f92672>.</span><span style=color:#a6e22e>setAccessible</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    field<span style=color:#f92672>.</span><span style=color:#a6e22e>set</span><span style=color:#f92672>(</span>instance<span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>apiClient</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>close</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> Throwable <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        wireMockServer<span style=color:#f92672>.</span><span style=color:#a6e22e>stop</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>configureMockClient</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// add static stubs for mock client
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        configureFor<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;localhost&#34;</span><span style=color:#f92672>,</span> PORT<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>stubForBatchGetCronjobs</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>stubForBatchGetSingleCronJob</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;my-job1&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>stubForBatchGetSingleCronJob</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;my-job2&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>stubForBatchGetSingleCronJob</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;my-job3&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>stubForBatchPostJob</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>stubForBatchGetJob</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> <span style=color:#a6e22e>getContents</span><span style=color:#f92672>(</span>String name<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        var json <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> File<span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getResource</span><span style=color:#f92672>(</span>name<span style=color:#f92672>).</span><span style=color:#a6e22e>getPath</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> Files<span style=color:#f92672>.</span><span style=color:#a6e22e>readAllBytes</span><span style=color:#f92672>(</span>Paths<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>json<span style=color:#f92672>.</span><span style=color:#a6e22e>getPath</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>stubForBatchGetCronjobs</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        var contents <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getContents</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/fixtures/kubernetes/batch/cronjobs.json&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        var path <span style=color:#f92672>=</span> urlPathEqualTo<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/apis/batch/v1/namespaces/default/cronjobs&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        stubFor<span style=color:#f92672>(</span>get<span style=color:#f92672>(</span>path<span style=color:#f92672>).</span><span style=color:#a6e22e>willReturn</span><span style=color:#f92672>(</span>aResponse<span style=color:#f92672>().</span><span style=color:#a6e22e>withStatus</span><span style=color:#f92672>(</span><span style=color:#ae81ff>200</span><span style=color:#f92672>).</span><span style=color:#a6e22e>withBody</span><span style=color:#f92672>(</span>contents<span style=color:#f92672>)));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>stubForBatchGetSingleCronJob</span><span style=color:#f92672>(</span>String jobName<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        var contents <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getContents</span><span style=color:#f92672>(</span>String<span style=color:#f92672>.</span><span style=color:#a6e22e>format</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/fixtures/kubernetes/batch/%s.json&#34;</span><span style=color:#f92672>,</span> jobName<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        var url <span style=color:#f92672>=</span> String<span style=color:#f92672>.</span><span style=color:#a6e22e>format</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/apis/batch/v1/namespaces/default/cronjobs/%s&#34;</span><span style=color:#f92672>,</span> jobName<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        var path <span style=color:#f92672>=</span> urlPathEqualTo<span style=color:#f92672>(</span>url<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        stubFor<span style=color:#f92672>(</span>get<span style=color:#f92672>(</span>path<span style=color:#f92672>).</span><span style=color:#a6e22e>willReturn</span><span style=color:#f92672>(</span>aResponse<span style=color:#f92672>().</span><span style=color:#a6e22e>withStatus</span><span style=color:#f92672>(</span><span style=color:#ae81ff>200</span><span style=color:#f92672>).</span><span style=color:#a6e22e>withBody</span><span style=color:#f92672>(</span>contents<span style=color:#f92672>)));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>stubForBatchPostJob</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        var name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/fixtures/kubernetes/batch/post-my-job.json&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        var contents <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getContents</span><span style=color:#f92672>(</span>name<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        var url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/apis/batch/v1/namespaces/default/jobs&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        var path <span style=color:#f92672>=</span> urlPathEqualTo<span style=color:#f92672>(</span>url<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        stubFor<span style=color:#f92672>(</span>post<span style=color:#f92672>(</span>path<span style=color:#f92672>).</span><span style=color:#a6e22e>willReturn</span><span style=color:#f92672>(</span>aResponse<span style=color:#f92672>().</span><span style=color:#a6e22e>withStatus</span><span style=color:#f92672>(</span><span style=color:#ae81ff>200</span><span style=color:#f92672>).</span><span style=color:#a6e22e>withBody</span><span style=color:#f92672>(</span>contents<span style=color:#f92672>)));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>stubForBatchGetJob</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        var name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/fixtures/kubernetes/batch/get-my-job.json&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        var contents <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getContents</span><span style=color:#f92672>(</span>name<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        var url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/apis/batch/v1/namespaces/default/jobs/my-job&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        var path <span style=color:#f92672>=</span> urlPathEqualTo<span style=color:#f92672>(</span>url<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        stubFor<span style=color:#f92672>(</span>get<span style=color:#f92672>(</span>urlPathEqualTo<span style=color:#f92672>(</span>url<span style=color:#f92672>)).</span><span style=color:#a6e22e>willReturn</span><span style=color:#f92672>(</span>aResponse<span style=color:#f92672>().</span><span style=color:#a6e22e>withStatus</span><span style=color:#f92672>(</span><span style=color:#ae81ff>200</span><span style=color:#f92672>).</span><span style=color:#a6e22e>withBody</span><span style=color:#f92672>(</span>contents<span style=color:#f92672>)));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0722/>リアクティブプログラミングと WebClient</a></h1><div class=post-meta><time class=post-date>2022-07-22 (Fri.) ::</time></div><span class=post-tags>#<a href=/diary/tags/java/>java</a>&nbsp;
#<a href=/diary/tags/spring-boot/>spring boot</a>&nbsp;</span><div class=post-content><p>0時に寝て6時に起きた。金曜日は非稼働日だけど、今週は月曜日が祝日だったから普通に働いてた。</p><h2 id=spring-webflux-とプロキシ>spring-webflux とプロキシ</h2><p>たまたま api client 周りを触っている。それらは spring の <em>WebClient</em> で実装されている。WebClient は spring-webflux プロジェクトが提供している http リクエストを扱うためのクライアントでリアクティブプログラミングを用いた設計になっている。リアクティブという言葉がピンとこなければ非同期フレームワークを用いた http クライアントと言い換えても大枠ではあっているのではないかと思う。spring-webflux プロジェクトそのものはノンブロッキング、バックプレッシャーといった機能をサポートする web アプリケーションフレームワークを提供するもの。</p><ul><li><a href=https://docs.spring.io/spring-framework/docs/current/reference/html/web-reactive.html>Web on Reactive Stack</a></li></ul><p><a href=https://github.com/reactor/reactor>Reactor</a> というコアライブラリを使って spring-webflux のフレームワークは実装されている。このデータ構造の1つに <em>Mono</em> と <em>Flux</em> が出てくる。初見の開発者はこの名前のデータ構造がよくわからんというところから始まる。私がそうだった。ドキュメントの説明によると、Mono は0から1、Flux は0からNまでのデータ列の概念を扱うという。おそらく json のようなレスポンスを返す場合は Mono を使い、ストリームを返すレスポンスは Flux を使えばいいんじゃないかと思う。</p><blockquote><p>Reactor is the reactive library of choice for Spring WebFlux. It provides the Mono and Flux API types to work on data sequences of 0..1 (Mono) and 0..N (Flux) through a rich set of operators aligned with the ReactiveX vocabulary of operators. Reactor is a Reactive Streams library and, therefore, all of its operators support non-blocking back pressure. Reactor has a strong focus on server-side Java. It is developed in close collaboration with Spring.</p><p>WebFlux requires Reactor as a core dependency but it is interoperable with other reactive libraries via Reactive Streams. As a general rule, a WebFlux API accepts a plain Publisher as input, adapts it to a Reactor type internally, uses that, and returns either a Flux or a Mono as output. So, you can pass any Publisher as input and you can apply operations on the output, but you need to adapt the output for use with another reactive library. Whenever feasible (for example, annotated controllers), WebFlux adapts transparently to the use of RxJava or another reactive library. See Reactive Libraries for more details.</p><p><a href=https://docs.spring.io/spring-framework/docs/current/reference/html/web-reactive.html#webflux-reactive-api>https://docs.spring.io/spring-framework/docs/current/reference/html/web-reactive.html#webflux-reactive-api</a></p></blockquote><p>いまローカルの開発環境では vpn 接続をしてプロキシ経由でアクセスするサーバーがいる。WebClient のプロキシ経由で通信できないという問題があることを同僚から教えてもらった。プロキシ経由でアクセスしようとすると認可エラーになってしまう。なにかしらプロキシ経由の接続に問題がある。</p><pre tabindex=0><code>Caused by: io.netty.handler.proxy.HttpProxyHandler$HttpProxyConnectException: http, none, /10.100.101.10:8080 =&gt; /192.168.201.35:18980, status: 403 Forbidden
</code></pre><p>同僚は WebClient のデフォルトでは http の <a href=https://developer.mozilla.org/ja/docs/Web/HTTP/Methods/CONNECT>CONNECT</a> メソッドを使って通信しようとするが、それを <a href=http://www.squid-cache.org/>squid</a> がサポートしていないか、設定を変更しないとダメなんじゃないかと話していた。その内容が正しいかどうか、私は未検証だけどデフォルト設定では通信できないことがわかった。ここで WebClient の設定の1つに <a href=https://docs.spring.io/spring-framework/docs/current/reference/html/web-reactive.html#webflux-client-builder>ClientHttpConnector</a> があり、任意の http client ライブラリに置き換えられる。ソースをみると次の4つの ClientHttpConnector が使えるらしい。デフォルトが ReactorClientHttpConnector になる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>  <span style=color:#66d9ef>private</span> ClientHttpConnector <span style=color:#a6e22e>initConnector</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>reactorClientPresent<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ReactorClientHttpConnector<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>jettyClientPresent<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> JettyClientHttpConnector<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>httpComponentsClientPresent<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> HttpComponentsClientHttpConnector<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> JdkClientHttpConnector<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>試しに <a href=https://github.com/jetty-project/jetty-reactive-httpclient>jetty-reactive-httpclient</a> を使って JettyClientHttpConnector に置き換えてみたところ、プロキシサーバー経由のアクセスができるようになった。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> WebClient <span style=color:#a6e22e>create</span><span style=color:#f92672>(</span>String proxyIp<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> proxyPort<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    var httpClient <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HttpClient<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    httpClient<span style=color:#f92672>.</span><span style=color:#a6e22e>setFollowRedirects</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    httpClient<span style=color:#f92672>.</span><span style=color:#a6e22e>getProxyConfiguration</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getProxies</span><span style=color:#f92672>().</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> HttpProxy<span style=color:#f92672>(</span>proxyIp<span style=color:#f92672>,</span> proxyPort<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    var connector <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> JettyClientHttpConnector<span style=color:#f92672>(</span>httpClient<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> WebClient<span style=color:#f92672>.</span><span style=color:#a6e22e>builder</span><span style=color:#f92672>().</span><span style=color:#a6e22e>clientConnector</span><span style=color:#f92672>(</span>connector<span style=color:#f92672>).</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div></div></article><div class=pagination><div class=pagination__buttons><a href=/diary/tags/java/ class="button previous"><span class=button__icon>←</span>
<span class=button__text>最近の日記</span></a>
<a href=/diary/tags/java/page/3/ class="button next"><span class=button__text>過去の日記</span>
<span class=button__icon>→</span></a></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>© 2021 Tetsuya Morimoto</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>