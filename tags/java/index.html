<!doctype html><html lang=en><head><title>java :: forest nook</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/tags/java/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="java"><meta property="og:description" content><meta property="og:url" content="/diary/tags/java/"><meta property="og:site_name" content="forest nook"><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/tags/java/index.xml rel=alternate type=application/rss+xml title="forest nook"></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><div class=posts><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0117/>今年はしばらく svelte に注目</a></h1><div class=post-meta><time class=post-date>2023-01-17 (Tue.) ::</time></div><span class=post-tags>#<a href=/diary/tags/java/>java</a>&nbsp;
#<a href=/diary/tags/frontend/>frontend</a>&nbsp;
#<a href=/diary/tags/tech-selection/>tech selection</a>&nbsp;</span><div class=post-content><p>1時に寝て7時に起きた。なんか朝うまく起きれなくなってきた。なんでだろう？</p><h2 id=svelte-アプリの開発に着手>svelte アプリの開発に着手</h2><p>12月の1週間分ぐらいの工数をかけて行っていた <a href=/diary/posts/2022/1214/#フロントエンドの技術選定の調査>フロントエンドの技術選定</a> の意志決定をした、というよりはしてもらった。私は調査結果をまとめ、react を選択しても svelte を選択しても開発視点ではどちらも同じという判断を下した。あとはお手伝い先の会社にとってどちらの技術に取り組みたいかという視点しかないなと考えて CTO に最終決断を委ねた。その結果 svelte を採用することに決まった。この調査や意志決定についていずれテックブログに書きたい。私がどのぐらい開発に参加するかはまだ未定だけど、初期のリポジトリの整理ぐらいはしておこうと svelte アプリ開発に着手した。初めて関わる技術はなんにせよおもしろい。お仕事で学びがあれば個人でもなにかしら svelte アプリを作ってみたい。</p><h2 id=java-の-ldap-クライアント>java の ldap クライアント</h2><p>昨日のコードリーディングの続き。いま使っているライブラリは <a href=https://directory.apache.org/api/>Apache Directory LDAP API</a> というものだけど、このライブラリの設計があまりイケてない。古い java の考え方で設計されているライブラリのような印象を受けた。他にも java の ldap クライアントはないのかな？と調べたら so でちょうど議論されていた。</p><ul><li><a href=https://stackoverflow.com/questions/15619147/java-api-to-query-ldap>Java API to query LDAP</a></li></ul><p>この so によると、<a href=https://ldap.com/unboundid-ldap-sdk-for-java/>UnboundID LDAP SDK for Java</a> がベストアンサーになっている。また機会があれば触ってみようかなと思った。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/1019/>イベントはしご</a></h1><div class=post-meta><time class=post-date>2022-10-19 (Wed.) ::</time></div><span class=post-tags>#<a href=/diary/tags/java/>java</a>&nbsp;
#<a href=/diary/tags/event/>event</a>&nbsp;
#<a href=/diary/tags/management/>management</a>&nbsp;</span><div class=post-content><p>1時に寝て4時に起きて6時に起きた。</p><h2 id=jackson-の-tips>jackson の tips</h2><p>jackson で調べているとググったときに stackoverflow に書いてある内容が、機能的には正しいけれど、deprecated になっているアノテーションが多々ある。そのときに新しいやり方はどう設定していいか分からないということがある。今日たまたま実装した処理に2つアノテーションが出てきたので備忘録として書いておく。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@JsonNaming</span><span style=color:#f92672>(</span>PropertyNamingStrategies<span style=color:#f92672>.</span><span style=color:#a6e22e>SnakeCaseStrategy</span><span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span>
</span></span></code></pre></div><ul><li>デシリアライズするときに <code>my_field</code> のようなスネークケースのフィールド名を <code>myField</code> のメンバーにマッピングする</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@JsonIgnoreProperties</span><span style=color:#f92672>(</span>ignoreUnknown <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>)</span>
</span></span></code></pre></div><ul><li>デシリアライズするときに json に存在してクラスに存在しないフィールドを無視する</li><li>データ構造の移行時にエラーを出さないとか、不要なフィールドがあるときに設定するとよい</li></ul><h2 id=上司道-リーダーはレジリエンスを高める自己肯定感を学ぼう>上司道 リーダーはレジリエンスを高める自己肯定感を学ぼう</h2><p>以前 <a href=/diary/posts/2022/1005/#SECI-モデルのワークショップ>SECI モデルのワークショップ</a> に参加して、同じチームにおられた方が <a href=https://tomoaki2222ok.wixsite.com/mysite>上司道</a> という勉強会コミュニティを運営しているのでお誘いを受けた。せっかくの縁だと思ったのでコミュニティに参加した。その勉強会で <a href=https://self-esteem.or.jp/>日本セルフエスティーム普及協会</a> の工藤氏による自己肯定感の紹介イベントがあったので試しに参加してみた。</p><p>軽く私の自己肯定感をチェックしてみると普通。低くも高くもない。私はどこかのタイミングで他人と比較するのをやめた。それは自己肯定感を高めるためにはよい慣習らしい。そのおかげで私は自己肯定感が低くはないようにみえる。自己肯定感には社会的と絶対的の2つの構成概念がある。</p><ul><li>社会的自己肯定感</li><li>絶対的自己肯定感</li></ul><p>重要なのは絶対的の方になるらしいが、多くの人は社会的の方が割合として大きいらしい。社会的に頼っていると、キャリア戦略に失敗したり、会社でリストラされたりすると自尊心が傷つきやすくなる。私もこのタイプだと思う。近い将来リストラされることを想定して自分の会社を作ったという背景もある。自分の会社があると、自分で自分をリストラしない限りは集団に帰属しているという社会的欲求を満たせる。それが社会的自己肯定感と関係があるように思える。いまの私の環境は自尊心が傷つきやすい状況ではないため、あまりセミナーの内容には関心をもてなかった。それよりも参加者が共有していた自尊心を脅かされる状況の経験談にひどいものが多くて、それらと比べると私の環境は恵まれていて世の中に感謝する気持ちになった。</p><h2 id=後藤達也さんのオンラインミーティング>後藤達也さんのオンラインミーティング</h2><p>たまたま21時半からコアメンバー向けの zoom ミーティングを行うという投稿をみかけたので参加してみた。2時間ぐらいやってたのかな？軽く聞いて帰ろうと思っていたものの、なんだかんだで最後まで参加していた。</p><ul><li><a href=https://note.com/goto_finance/n/nc4140548387a>【募集停止します】月980円プラン</a></li></ul><p>軽く計算すると note のメンバーシップだけで約774万円/月の売上になる。すごい。</p><blockquote><p>(500 * 9577) + (3016 * 980) = 7,744,180</p></blockquote><p>こんな儲かっているサブスクリプションの新規募集を停止する背景として、これ以上コアメンバーが増えてもコミュニティとしての運営が難しくなるからやりたくないのだという。例えば、すでに3000人いるが、この人数でオフ会を開催することはできない。月々の料金を高くしてメンバー数を減らすというのが経済学的な解であることは理解しているが、後藤さん1人で提供しているようなサービスに月980円を超える料金をとることに抵抗感があるから値段をあげたくないと話されていた。とても謙虚な人だと思う。コミュニティ運営を難しくせず料金もあげないという戦略からコアメンバーをこれ以上増やさないという判断をしたそうだ。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/1013/>サイトコントローラーの障害は大変そう</a></h1><div class=post-meta><time class=post-date>2022-10-13 (Thu.) ::</time></div><span class=post-tags>#<a href=/diary/tags/infrastructure/>infrastructure</a>&nbsp;
#<a href=/diary/tags/java/>java</a>&nbsp;
#<a href=/diary/tags/life/>life</a>&nbsp;</span><div class=post-content><p>0時に寝て3時に起きて6時半に起きた。だいぶよく眠れるようになってきた。</p><h2 id=サイトコントローラーの障害>サイトコントローラーの障害</h2><p>お手伝いしている宿泊業のシステムでトラブルが発生している。厳密には外部サービスになるのだが、複数のオンライン予約サイトの違いを吸収して単一のインターフェースを提供する宿泊業のハブシステムのような存在をサイトコントローラーと呼ぶらしい。週明けから全国旅行支援という新しいGoToトラベルが開始されて、その予約が想定以上のトラフィックになっていてサイトコントローラーがダウンしてしまった。web 開発者向けに例えれば aws の s3 が落ちて大半のサービスに影響が出てなんもできないみたいな状況かな。</p><ul><li><a href=https://www.traicy.com/posts/20221012252499/>宿泊施設向け予約・販売管理システム「TL-リンカーン」、復旧目処立たず　約5,100施設に影響</a></li></ul><p>全国レベルのニュースになるぐらいの障害規模が大きいらしい。それだけユーザーが多いシステム／事業者なんだろうとは思う。システムと向き合う上で障害が発生するのは仕方ないが、フォールトトレランスは常に意識して設計・運用しないといけないことを、今回の障害を傍からみていて感じた。</p><h2 id=java-のちょっとした小技>java のちょっとした小技</h2><p>java で1つのリストを複数のリストに分割したいときに <a href=https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/List.html#subList(int,int)>List.subList</a> というメソッドがある。複数の値を並行処理するときなど入力を分割するのに便利そう。使い方は次の通り。toIndex を超えると IndexOutOfBoundsException が投げられるのでそこだけ注意かな。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>var total <span style=color:#f92672>=</span> myList<span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>var step <span style=color:#f92672>=</span> <span style=color:#ae81ff>20</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> total<span style=color:#f92672>;</span> i <span style=color:#f92672>+=</span> step<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    var toIndex <span style=color:#f92672>=</span> i <span style=color:#f92672>+</span> step<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>toIndex <span style=color:#f92672>&gt;</span> total<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        toIndex <span style=color:#f92672>=</span> total<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    var subList <span style=color:#f92672>=</span> myList<span style=color:#f92672>.</span><span style=color:#a6e22e>subList</span><span style=color:#f92672>(</span>i<span style=color:#f92672>,</span> toIndex<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// do something
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=シャンプー>シャンプー</h2><p>散髪屋さんのマスターからシャンプーを変えた方がいいんじゃないかとアドバイスされた。髪は油分と水分のバランスが大事らしく、シャンプーによって変わることもあるらしい。いつからか記憶にないけど、少なくとも学生時代から私はずっと <a href=https://www.kao.co.jp/merit/products/norinse/>メリット リンスのいらないシャンプー</a> を使っている。20年ぐらい？こだわりがあるわけでもないし、このシャンプーを使っていて懸念があったことは一度もない。マスターから <a href=https://hscare.jp/shop-products/men/all-collections>h&s scalp</a> がよいとお勧めされた。せっかくの機会だから試してみようかなと思う。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0928/>url エンコーディングと uri の仕様</a></h1><div class=post-meta><time class=post-date>2022-09-28 (Wed.) ::</time></div><span class=post-tags>#<a href=/diary/tags/java/>java</a>&nbsp;
#<a href=/diary/tags/spring-boot/>spring boot</a>&nbsp;
#<a href=/diary/tags/medium/>medium</a>&nbsp;</span><div class=post-content><p>1時に寝ようとして、寝てたか起きてたかわからない時間を過ごして7時に起きた。</p><h2 id=webclient-と-query-string-のエンコーディング>WebClient と query string のエンコーディング</h2><p>以前にも <a href=/diary/posts/2022/0722/#spring-webflux-とプロキシ>WebClient の基本</a> について少し書いた。<code>data={"x": 1, "y": 2}</code> のような json 文字列を query string でリクエストしようとしたときに少しはまったので書いておく。java 標準ライブラリの URLEncoder を使ってエンコードするとスペースが <code>+</code> になる。これは html の仕様として正しいが、uri の仕様としては不正になる。そのため <code>+</code> を <code>%20</code> に置き換える必要がある。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> String <span style=color:#a6e22e>encode</span><span style=color:#f92672>(</span>String data<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> UnsupportedEncodingException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// NOTE: the URI doesn&#39;t allow &#39;+&#39; character
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> URLEncoder<span style=color:#f92672>.</span><span style=color:#a6e22e>encode</span><span style=color:#f92672>(</span>data<span style=color:#f92672>,</span> StandardCharsets<span style=color:#f92672>.</span><span style=color:#a6e22e>UTF_8</span><span style=color:#f92672>).</span><span style=color:#a6e22e>replace</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;+&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;%20&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>このロジックで <code>{"x": 1, "y": 2}</code> を url エンコードすると次の文字列になる。</p><pre tabindex=0><code>%7B%22x%22%3A%201%2C%20%22y%22%3A%202%7D
</code></pre><p>あらかじめ url エンコーディングした文字列を渡すと、今度は WebClient が <code>%</code> を <code>%25</code> にさらにエンコーディングしてしまう。<a href=https://www.baeldung.com/webflux-webclient-parameters#encoding-mode>Spring WebClient Requests with Parameters 6.Encoding Mode</a> によると、次の4つのエンコーディングモードをカスタマイズできる。デフォルトは <em>TEMPLATE_AND_VALUES</em> らしい。</p><ul><li>TEMPLATE_AND_VALUES: Pre-encode the URI template and strictly encode URI variables when expanded</li><li>VALUES_ONLY: Do not encode the URI template, but strictly encode URI variables after expanding them into the template</li><li>URI_COMPONENTS: Encode URI component value after expending URI variables</li><li>NONE: No encoding will be applied</li></ul><p>もとの url エンコード済みの文字列が次のようなものになってしまう。</p><pre tabindex=0><code>%257B%2522x%2522%253A%25...
</code></pre><p>既存の実装をあまり変えたくもなくてやや力技で実装した。局所的な変更だからまぁいっか。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>webClient<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>().</span><span style=color:#a6e22e>uri</span><span style=color:#f92672>(</span>uriBuilder <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  var uriObj <span style=color:#f92672>=</span> uriBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>path</span><span style=color:#f92672>(</span>getControllerBasePath<span style=color:#f92672>()</span> <span style=color:#f92672>+</span> path<span style=color:#f92672>).</span><span style=color:#a6e22e>queryParams</span><span style=color:#f92672>(</span>query<span style=color:#f92672>).</span><span style=color:#a6e22e>build</span><span style=color:#f92672>(</span>pathParams<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>encodedData <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      var uri <span style=color:#f92672>=</span> uriObj<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      var connector <span style=color:#f92672>=</span> uri<span style=color:#f92672>.</span><span style=color:#a6e22e>contains</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;?&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;&amp;&#34;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;?&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      uriObj <span style=color:#f92672>=</span> URI<span style=color:#f92672>.</span><span style=color:#a6e22e>create</span><span style=color:#f92672>(</span>String<span style=color:#f92672>.</span><span style=color:#a6e22e>format</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;%s%sdata=%s&#34;</span><span style=color:#f92672>,</span> uri<span style=color:#f92672>,</span> connector<span style=color:#f92672>,</span> encodedData<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> uriObj<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}).</span><span style=color:#a6e22e>retrieve</span><span style=color:#f92672>()</span>
</span></span></code></pre></div><h2 id=よいエラーメッセージわるいエラーメッセージ>よいエラーメッセージ、わるいエラーメッセージ</h2><p>タイトルに惹かれてちょっと期待外れ。<em>art</em> というと日本人は芸術と高度なものを期待しがちだけど、<em>the art of</em> だと技術の体系といった意味合いもあるのでちょとしたノウハウを解説する技術ブログのようなものでも誤っていない。</p><ul><li><a href=https://medium.com/s/user-friendly/the-art-of-the-error-message-9f878d0bff80>The Art of the Error Message</a></li></ul><p>ユーザー体験をよくするためのエラーメッセージのコツとして次の3つを提案している。</p><ul><li>何が起きたのか、なぜ起きたのかを説明する</li><li>次のステップを提案する</li><li>適切なトーンで書く</li></ul><p>この3つの具体例としてどのようなものかを説明している。私にとってはそう目新しいものではないが、エラーメッセージにトーンという概念はなかったので最近の流行りなのかなと思った。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0926/>postgresql の json データ型</a></h1><div class=post-meta><time class=post-date>2022-09-26 (Mon.) ::</time></div><span class=post-tags>#<a href=/diary/tags/postgresql/>postgresql</a>&nbsp;
#<a href=/diary/tags/java/>java</a>&nbsp;
#<a href=/diary/tags/cli/>cli</a>&nbsp;</span><div class=post-content><p>1時に寝て6時半に起きた。連休中に夜更ししてたから生活が乱れた。</p><h2 id=ロガー向けのログ保存-api-の開発>ロガー向けのログ保存 API の開発</h2><p>先週の休暇前にやっていた作業の開発に着手。一通り web api のエンドポイントの実装は終えてテストをあらかた書いたところ。いまのプロジェクトとしても、過去の私の経験としてもやったことのない新しい挑戦の1つとして postgresql の <a href=https://www.postgresql.jp/document/13/html/datatype-json.html>JSONデータ型</a> を使う。具体的には json 型と jsonb 型の2つがある。前者はテキストで保持する型で、後者は内部的にバイナリに変換されてインデックスも使える。バイナリに変換してインデックスを作る分、insert 時にテキストで保存するよりは少し余分なオーバーヘッドを要する。json のデータを参照用途で使うのか、検索するのかでこれらの型を使い分ければいいのかな。</p><p>実際の sql で json データの条件指定は次のようになる。<code>@></code> というみたこともない気持ち悪い演算子を使う。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>select</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> mytable <span style=color:#66d9ef>where</span> <span style=color:#66d9ef>data</span>  <span style=color:#f92672>@&gt;</span> <span style=color:#e6db74>&#39;{&#34;x&#34;: 1, &#34;y&#34;: 2}&#39;</span>;
</span></span></code></pre></div><p>java の jdbc で扱うには <em>PGobject</em> という型に変換して扱う必要がある。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> PGobject <span style=color:#a6e22e>convertData</span><span style=color:#f92672>(</span>String value<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> SQLException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    var data <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> PGobject<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    data<span style=color:#f92672>.</span><span style=color:#a6e22e>setType</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;jsonb&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    data<span style=color:#f92672>.</span><span style=color:#a6e22e>setValue</span><span style=color:#f92672>(</span>value<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> data<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>余談だけど、curl で json 文字列を query string としてリクエストするには url encode しないといけない。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -s --get --data-urlencode <span style=color:#e6db74>&#39;data={&#34;x&#34;: 1, &#34;y&#34;: 2}&#39;</span> http://localhost/path | jq .
</span></span></code></pre></div></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0925/>quarkus のアプリ開発が楽しくなってきた</a></h1><div class=post-meta><time class=post-date>2022-09-25 (Sun.) ::</time></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/java/>java</a>&nbsp;
#<a href=/diary/tags/quarkus/>quarkus</a>&nbsp;
#<a href=/diary/tags/backlog/>backlog</a>&nbsp;</span><div class=post-content><p>4時に寝て8時に起きた。昨日は久しぶりに夜更しして quarkus の調べものをしてた。新しいものを学ぶのはおもしろい。</p><h2 id=ストレッチ>ストレッチ</h2><p>今週末は本当は実家に帰る予定だったのが、台風による雨で田んぼのコンディションがよくないので断念した。日曜日の夜、田んぼ仕事を終えて筋肉痛のところにストレッチしてもらう予定は変わってしまった。今日の開脚幅は開始前155cmで、ストレッチ後160cmだった。いつもは朝測っているのが夜になるので数値はよくなかった。とはいえ、あまり規則正しく寝てないわりには体調がよい。気候が涼しいせいかな。トレーナーさんに来週はもう10月ですよと言われて9月は過ぎさるのが早いと改めて思った。</p><h2 id=quarkus-アプリケーションと認可フロー>quarkus アプリケーションと認可フロー</h2><p>昨日の続き。お昼前ぐらいからずっと quarkus のアプリケーション開発をしていた。なんやらかんやらで3日間ずっと bolt や quarkus のソースやドキュメントを読んでいた。徐々に理解度が増えてきて、できることも増えてきて楽しくなってきた。web 系だと di に <a href=https://github.com/google/guice>google/guice</a> を使うものも多いけど、エンタープライズ系だと <a href=https://quarkus.io/guides/cdi>cdi</a> なのかなぁとか思ってた。わからんけど。以前にも cdi のドキュメントを読んで関心があった。cdi は本当によく出来ていると思う。一方で難し過ぎて、そこまでコンテキストを厳密に管理する必要があるアプリケーションもそうないのかもなぁとは思ってた。今日 quarkus でアプリケーション開発していてドキュメントを読みながらやってみたところが次になる。</p><ul><li><a href=https://quarkus.io/guides/cdi-reference>CONTEXTS AND DEPENDENCY INJECTION</a></li><li><a href=https://quarkus.io/guides/rest-client>USING THE REST CLIENT</a></li><li><a href=https://quarkus.io/guides/rest-json>WRITING JSON REST SERVICES</a></li></ul><p>だいたい雰囲気は理解できてきたので backlog の <a href=https://developer.nulab.com/docs/backlog/auth/>Authentication & Authorization</a> に書いてある oauth2 の <em>Authorization Code Grant</em> のフローを実装していた。access token の取得と refresh はできたのでこれを db に保存するのを明日以降にやってみる。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0924/>quarkus のビルド環境に手間取った</a></h1><div class=post-meta><time class=post-date>2022-09-24 (Sat.) ::</time></div><span class=post-tags>#<a href=/diary/tags/java/>java</a>&nbsp;
#<a href=/diary/tags/quarkus/>quarkus</a>&nbsp;</span><div class=post-content><p>1時に寝て7時に起きた。休みだとやっぱりだらだらしてしまうな。</p><h2 id=bolt-for-java-on-quarkus>bolt for java on quarkus</h2><p>昨日の続き。スクラッチから quarkus のアプリケーションの設定を gradle で行う。quarkus の上で slack apps としてのコマンドとイベントの振る舞いだけ確認した。</p><ul><li><a href=https://github.com/t2y/bolt-java-sample>https://github.com/t2y/bolt-java-sample</a></li></ul><p>私は新規に開発する java アプリケーションは <a href=https://gradle.org/>gradle</a> を使うようにしている。これは java のよくないところだろうけれど、言語コミュニティが提供するパッケージマネージャやビルドツールがないから複数のツールが乱立している。maven から gradle に緩やかに移行していくのかな？と私は考えていたけれど、昔からあるライブラリのビルドツールを変更するのは労力に見合うメリットがないのか、maven も依然としてずっと使われ続けていくのかもしれない。maven と gradle の両対応という保守コストは、この先しばらく java コミュニティが抱えていく保守コストと言えるのかもしれない。quarkus はさらに独自の <a href=https://quarkus.io/guides/cli-tooling>Quarkus CLI</a> というビルドツールを提供している。そのため、ビルドのための設定だけで quarkus cli, maven, gradle の3つの方法があり、ドキュメントにもそれぞれの設定方法が書いてある。これを保守する方も使う方もややこしくて大変だなぁという印象を受けた。</p><p><a href=https://quarkus.io/guides/gradle-tooling>BUILDING QUARKUS APPS WITH GRADLE</a> をみながら次の maven cli で作った gradle プロジェクトのテンプレートをみながら build.gradle の設定をした。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ mvn io.quarkus.platform:quarkus-maven-plugin:2.12.3.Final:create <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -DprojectGroupId<span style=color:#f92672>=</span>my-groupId <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -DprojectArtifactId<span style=color:#f92672>=</span>my-artifactId <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -Dextensions<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;resteasy-reactive,resteasy-reactive-jackson&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -DbuildTool<span style=color:#f92672>=</span>gradle
</span></span></code></pre></div><p>あと私は設定ファイルを yaml で管理したいので次の拡張も追加した。gradle タスクでも定義されていて次のように実行する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./gradlew addExtension --extensions<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;quarkus-config-yaml&#34;</span>
</span></span></code></pre></div><p>この cli がやっていることは基本的に dependencies に次の1行を追加するだけ。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=display:flex><span>dependencies <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  implementation <span style=color:#e6db74>&#39;io.quarkus:quarkus-config-yaml&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>設定ファイルを yaml から読み込めるようになると初期設定は次のようになる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ vi app/src/main/resources/application.yaml 
</span></span><span style=display:flex><span>quarkus:
</span></span><span style=display:flex><span>  http:
</span></span><span style=display:flex><span>    port: <span style=color:#ae81ff>3000</span>
</span></span><span style=display:flex><span>  log:
</span></span><span style=display:flex><span>    level: INFO
</span></span><span style=display:flex><span>    category:
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;com.slack.api&#34;</span>:
</span></span><span style=display:flex><span>        level: DEBUG
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;tutorial.bolt.sample&#34;</span>:
</span></span><span style=display:flex><span>        level: DEBUG
</span></span><span style=display:flex><span>  package:
</span></span><span style=display:flex><span>    type: uber-jar
</span></span></code></pre></div><p>開発サーバーは次のようにして起動する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ./gradlew quarkusDev
</span></span></code></pre></div><blockquote><p>quarkusDev enables hot deployment with background compilation, which means that when you modify your Java files or your resource files and refresh your browser these changes will automatically take effect. This works too for resource files like the configuration property file. The act of refreshing the browser triggers a scan of the workspace, and if any changes are detected the Java files are compiled, and the application is redeployed, then your request is serviced by the redeployed application. If there are any issues with compilation or deployment an error page will let you know.</p><p><a href=https://quarkus.io/guides/gradle-tooling#dev-mode>https://quarkus.io/guides/gradle-tooling#dev-mode</a></p></blockquote><p>hot deployment 機能のおかげでソースや設定ファイルを変更すると自動的に反映される。他の言語なら普通の機能かもしれないけど、java でもそういう仕組みが普通になったんだなと思って感心した。変化に付いていけない開発者のような気持ちになった。</p></div></article><div class=pagination><div class=pagination__buttons><a href=/diary/tags/java/page/2/ class="button next"><span class=button__text>過去の日記</span>
<span class=button__icon>→</span></a></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>© 2021 Tetsuya Morimoto</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>