<!doctype html><html lang=en><head><title>gitlab :: forest nook</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/tags/gitlab/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="gitlab"><meta property="og:description" content><meta property="og:url" content="/diary/tags/gitlab/"><meta property="og:site_name" content="forest nook"><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/tags/gitlab/index.xml rel=alternate type=application/rss+xml title="forest nook"></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><div class=posts><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1218/>gitlab ci/cd のローカルデバッグ</a></h1><div class=post-meta><time class=post-date>2023-12-18 (Mon.) ::</time></div><span class=post-tags>#<a href=/diary/tags/gitlab/>gitlab</a>&nbsp;
#<a href=/diary/tags/ci/cd/>ci/cd</a>&nbsp;
#<a href=/diary/tags/debug/>debug</a>&nbsp;</span><div class=post-content><p>23時頃から寝始めて3時に起きて5時半に起きて8時過ぎに起きた。久しぶりに寝坊した。</p><h2 id=gitlab-runner-のデバッグ>gitlab-runner のデバッグ</h2><p>mongodb のレプリカセット対応して、ローカルでは結合テストが動くものの、gitlab ci/cd 環境では動かなくなった。gitlab ci/cd は <a href=https://docs.gitlab.com/runner/>GitLab Runner</a> によって提供されている。そのデバッグのため、ローカルに gitlab-runner をインストールして調査した。</p><p><a href=https://docs.gitlab.com/runner/install/>GitLab Runner のインストール</a> ドキュメントにそれぞれの OS 向けのドキュメントがある。Debian/Ubuntu/Mint 向けのインストール手順を行う。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -L <span style=color:#e6db74>&#34;https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.deb.sh&#34;</span> | sudo bash
</span></span><span style=display:flex><span>$ sudo apt-get install gitlab-runner
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ gitlab-runner --version
</span></span><span style=display:flex><span>Version:      16.6.1
</span></span><span style=display:flex><span>Git revision: f5da3c5a
</span></span><span style=display:flex><span>Git branch:   16-6-stable
</span></span><span style=display:flex><span>GO version:   go1.20.10
</span></span><span style=display:flex><span>Built:        2023-11-24T21:11:36+0000
</span></span><span style=display:flex><span>OS/Arch:      linux/amd64
</span></span></code></pre></div><p>.gitlab-ci.yml があるディレクトリへ移動して、ジョブを指定して実行する。ローカルでの変更内容を検証するときはブランチにコミットしないといけない。コミットしていないと次のワーニングが表示される。</p><pre tabindex=0><code>WARNING: You most probably have uncommitted changes. 
WARNING: These changes will not be tested.         
</code></pre><p>dind なジョブを実行するときは <code>--docker-privileged</code> で特権を付けて実行する。環境変数は <code>--env KEY=VALUE</code> で渡せるが、<code>CI_JOB_TOKEN</code> のような組み込みの環境変数は上書きできない。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cd path/to/repo
</span></span><span style=display:flex><span>$ gitlab-runner exec docker --docker-privileged <span style=color:#e6db74>${</span>ジョブ名<span style=color:#e6db74>}</span>
</span></span></code></pre></div></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0914/>資料作りの一日</a></h1><div class=post-meta><time class=post-date>2023-09-14 (Thu.) ::</time></div><span class=post-tags>#<a href=/diary/tags/project-management/>project management</a>&nbsp;
#<a href=/diary/tags/issue-management/>issue management</a>&nbsp;
#<a href=/diary/tags/issue-tracking-system/>issue tracking system</a>&nbsp;
#<a href=/diary/tags/gitlab/>gitlab</a>&nbsp;
#<a href=/diary/tags/mongodb/>mongodb</a>&nbsp;</span><div class=post-content><p>23時に寝て何度か起きて6時に起きた。疲労も溜まっているのでなるべく早く寝るように努めている。旅行中ずっと早起きしていたから早起きするのは苦にならない。</p><h2 id=今開発の大きなふりかえりの資料作り>今開発の大きなふりかえりの資料作り</h2><p>ふりかえりのために課題管理システムの issue 情報から統計的な数値を取得する。</p><p>gitlab の <a href=https://gitlab.com/gitlab-org/cli>cli</a> ツールを使って issue 情報を取得して mongodb にインポートする。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ glab api --paginate <span style=color:#e6db74>&#34;groups/product%2Funicorncidm/issues?milestone=2023-09-05&amp;not[labels]=Duplicate,Invalid,Wontfix&#34;</span> | jq -c <span style=color:#e6db74>&#39;.[]&#39;</span> &gt; 2023-09-05-issues.json
</span></span><span style=display:flex><span>$ mongoimport --authenticationDatabase<span style=color:#f92672>=</span>admin --uri <span style=color:#e6db74>&#34;mongodb://root:secret@localhost:27017&#34;</span> --db gitlab --collection issues 2023-09-05-issues.json
</span></span></code></pre></div><p>mongodb で aggregation (sql で言うところの group by 句に相当する) するときはパイプライン処理を実装する。例えば、最初にデータをフィルターして、次にグルーピングして、最後にソートするのは次のようなパラメーターになる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ mongosh --username root --password secret
</span></span><span style=display:flex><span>test&gt; use gitlab
</span></span><span style=display:flex><span>gitlab&gt; db.issues.aggregate<span style=color:#f92672>([</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>{</span> $match: <span style=color:#f92672>{</span> $or: <span style=color:#f92672>[</span> <span style=color:#f92672>{</span> <span style=color:#e6db74>&#34;milestone.title&#34;</span>: <span style=color:#e6db74>&#34;2023-09-05&#34;</span> <span style=color:#f92672>}</span>,<span style=color:#f92672>{</span> <span style=color:#e6db74>&#34;milestone.title&#34;</span>: <span style=color:#e6db74>&#34;2023-09-19&#34;</span> <span style=color:#f92672>}</span> <span style=color:#f92672>]</span> <span style=color:#f92672>}</span> <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>{</span> $group: <span style=color:#f92672>{</span> <span style=color:#e6db74>&#34;_id&#34;</span>: <span style=color:#f92672>{</span> milestone: <span style=color:#e6db74>&#34;</span>$milestone<span style=color:#e6db74>.title&#34;</span> , author: <span style=color:#e6db74>&#34;</span>$author<span style=color:#e6db74>.username&#34;</span> <span style=color:#f92672>}</span>, councount: <span style=color:#f92672>{</span> <span style=color:#e6db74>&#34;</span>$sum<span style=color:#e6db74>&#34;</span>: <span style=color:#ae81ff>1</span> <span style=color:#f92672>}</span> <span style=color:#f92672>}</span> <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>{</span> $sort: <span style=color:#f92672>{</span> _id: <span style=color:#ae81ff>1</span> <span style=color:#f92672>}</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>])</span>
</span></span></code></pre></div><p>これで前回の開発のときに取得した数値と今回の開発の数値を比較してみると、いろいろわかることもあって、メンバーが成長していることも伺えて、課題管理をしながら開発を進めることのメリットを実感できる開発になったのではないかと思う。gitlab のアクティビティ図 (草生え図) をみても前回の開発よりも草がたくさん生えているので課題管理に習熟している様子が伺える。これをあと2-3年ぐらいすれば、課題管理を使いこなせる一般の開発者になるのではないかと思う。課題管理 + イテレーション開発でチームビルディングしていくところの、地盤のようなものはできたようにみえる。</p><p>この草生え図を匿名化して利用許可をもらって、うちの会社でいうところの課題管理ができるようになると、メンバーの働き方はこうなるというサンプルとして紹介させてもらうつもり。また来週メンバーにもその許諾を取ろうと思う。</p><h2 id=次開発の要件打ち合わせの資料作り>次開発の要件打ち合わせの資料作り</h2><p>今開発を始めるときに洗い出した要件の未対応のものと、今開発でやり残した非機能要件の開発課題を資料にまとめてたたき台とした。それだけでも3-4ヶ月分の開発課題になりそうだし、アーキテクチャとして大きな意思決定も1つある。私自身、7割型は決まっているが、考え方や要件によってはもう1つの案でいくのもよいかもしれない。機能要件は実際にお客さん先へ導入するときにもいくつか出てくるだろうけれど、非機能要件の運用に影響を与える懸念のところはなるべく早く改善しておきたい。次の開発期間にそこだけ対応すれば、一定の安心をもってお客さんへ提供できるようになると思う。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0511/>gitlab issues と mongodb による分析</a></h1><div class=post-meta><time class=post-date>2023-05-11 (Thu.) ::</time></div><span class=post-tags>#<a href=/diary/tags/gitlab/>gitlab</a>&nbsp;
#<a href=/diary/tags/mongodb/>mongodb</a>&nbsp;
#<a href=/diary/tags/cli/>cli</a>&nbsp;</span><div class=post-content><p>0時に寝て何度か起きて7時に起きた。今日も一日資料作りをしていた。</p><h2 id=gitlab-issues-の解析>gitlab issues の解析</h2><p>ふりかえりの資料を作っていて gitlab issues の解析を始めた。gitlab にも分析系機能は提供されているが、大半が有償機能で free では使えない。実質 free で役に立ちそうなレポートを私はみつけられなかった。</p><ul><li><a href=https://docs.gitlab.com/ee/user/analytics/>Analyze GitLab usage</a></li></ul><p>gitlab は <a href=https://gitlab.com/gitlab-org/cli>glab cli</a> というツールを提供している。試しに glab を使って issues の解析ができないかとやってみたが、グループ単位ではなくプロジェクト単位でしか操作できないようにみえた。そこで rest api を呼び出すための便利ツールとして使うことにした。要は rest api で任意のデータを取得してそれを使ってローカルで解析することにした。例えば、次のようにして特定ラベルを除外した特定グループのマイルストーンごとの issues をすべて取得できる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ mygrpid<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;xxx&#34;</span>
</span></span><span style=display:flex><span>$ milestones<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;2022-11 2022-12 2023-01 2023-02 2023-03 2023-04&#34;</span>
</span></span><span style=display:flex><span>$ <span style=color:#66d9ef>for</span> i in $milestones; <span style=color:#66d9ef>do</span> echo $i; glab api --paginate <span style=color:#e6db74>&#34;groups/</span><span style=color:#e6db74>${</span>mygrpid<span style=color:#e6db74>}</span><span style=color:#e6db74>/issues?milestone=</span><span style=color:#e6db74>${</span>i<span style=color:#e6db74>}</span><span style=color:#e6db74>&amp;not[labels]=Duplicate,Invalid,Wontfix&#34;</span> | jq -c <span style=color:#e6db74>&#39;.[]&#39;</span> &gt; <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>i<span style=color:#e6db74>}</span><span style=color:#e6db74>-issues.json&#34;</span>; <span style=color:#66d9ef>done</span>
</span></span></code></pre></div><p>あとはこの json データをそのまま分析のためのデータベースに取り込む。今回は mongodb にインポートしてみた。mongodb だとスキーマを定義しなくても json データをそのままインポートできてアドホックな分析に便利そうに思えた。オブジェクトの入れ子構造をもつ json データのようなものを rdbms にインポートするのはひと工夫必要なことから json データをそのままインポートできるドキュメントデータベースの有効性を理解できた。インポートしたら <a href=https://www.mongodb.com/products/shell>MongoDB Shell</a> を使うとてっとり早い。例えば、マイルストーンごとの issues の件数などは次のようにして集計できる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gitlab&gt; db.issues.aggregate<span style=color:#f92672>([{</span> $group: <span style=color:#f92672>{</span> <span style=color:#e6db74>&#34;_id&#34;</span>: <span style=color:#e6db74>&#34;</span>$milestone<span style=color:#e6db74>.title&#34;</span>, count: <span style=color:#f92672>{</span> <span style=color:#e6db74>&#34;</span>$sum<span style=color:#e6db74>&#34;</span>: <span style=color:#ae81ff>1</span> <span style=color:#f92672>}</span> <span style=color:#f92672>}</span> <span style=color:#f92672>}</span>, <span style=color:#f92672>{</span> $sort: <span style=color:#f92672>{</span> _id: <span style=color:#ae81ff>1</span> <span style=color:#f92672>}}])</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>{</span> _id: <span style=color:#e6db74>&#39;2022-11&#39;</span>, count: <span style=color:#ae81ff>348</span> <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>{</span> _id: <span style=color:#e6db74>&#39;2022-12&#39;</span>, count: <span style=color:#ae81ff>346</span> <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>{</span> _id: <span style=color:#e6db74>&#39;2023-01&#39;</span>, count: <span style=color:#ae81ff>338</span> <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>{</span> _id: <span style=color:#e6db74>&#39;2023-02&#39;</span>, count: <span style=color:#ae81ff>357</span> <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>{</span> _id: <span style=color:#e6db74>&#39;2023-03&#39;</span>, count: <span style=color:#ae81ff>347</span> <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>{</span> _id: <span style=color:#e6db74>&#39;2023-04&#39;</span>, count: <span style=color:#ae81ff>336</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>]</span>
</span></span></code></pre></div><p>担当者別に <code>Enhance</code> ラベルが付いた issues の件数を数えるときには次のようになる。sql を使えないというデメリットを json データをそのままインポートできるメリットの方が上回るときは mongodb のクエリを学ぶ機会になる。私も mongodb の aggregation の実行方法をドキュメントみながらやってた。全然わからないので慣れが必要になる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gitlab&gt; db.issues.aggregate<span style=color:#f92672>([{</span> $group: <span style=color:#f92672>{</span> <span style=color:#e6db74>&#34;_id&#34;</span>: <span style=color:#f92672>{</span> assignee: <span style=color:#e6db74>&#34;</span>$assignee<span style=color:#e6db74>.username&#34;</span>, enhance: <span style=color:#f92672>{</span>$in: <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;Enhance&#34;</span>, <span style=color:#e6db74>&#34;</span>$labels<span style=color:#e6db74>&#34;</span><span style=color:#f92672>]}</span> <span style=color:#f92672>}</span>, count: <span style=color:#f92672>{</span> <span style=color:#e6db74>&#34;</span>$sum<span style=color:#e6db74>&#34;</span>: <span style=color:#ae81ff>1</span> <span style=color:#f92672>}</span> <span style=color:#f92672>}</span> <span style=color:#f92672>}</span>, <span style=color:#f92672>{</span>$match: <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;_id.enhance&#34;</span>: true<span style=color:#f92672>}}</span>, <span style=color:#f92672>{</span> $sort: <span style=color:#f92672>{</span> _id: <span style=color:#ae81ff>1</span> <span style=color:#f92672>}}])</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>{</span> _id: <span style=color:#f92672>{</span> assignee: <span style=color:#e6db74>&#39;bob&#39;</span>, enhance: true <span style=color:#f92672>}</span>, count: <span style=color:#ae81ff>84</span> <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>{</span> _id: <span style=color:#f92672>{</span> assignee: <span style=color:#e6db74>&#39;john&#39;</span>, enhance: true <span style=color:#f92672>}</span>, count: <span style=color:#ae81ff>143</span> <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>{</span> _id: <span style=color:#f92672>{</span> assignee: <span style=color:#e6db74>&#39;mary&#39;</span>, enhance: true <span style=color:#f92672>}</span>, count: <span style=color:#ae81ff>53</span> <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>{</span> _id: <span style=color:#f92672>{</span> assignee: <span style=color:#e6db74>&#39;parks&#39;</span>, enhance: true <span style=color:#f92672>}</span>, count: <span style=color:#ae81ff>78</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>]</span>
</span></span></code></pre></div></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0329/>gitlab packages api の使い方</a></h1><div class=post-meta><time class=post-date>2023-03-29 (Wed.) ::</time></div><span class=post-tags>#<a href=/diary/tags/gitlab/>gitlab</a>&nbsp;
#<a href=/diary/tags/ci/cd/>ci/cd</a>&nbsp;
#<a href=/diary/tags/packaging/>packaging</a>&nbsp;</span><div class=post-content><p>0時に寝て何度か起きて6時半に起きた。先週より少し早く起きれるようになってきた。</p><h2 id=gitlab-cicd-で別プロジェクト-リポジトリ-の成果物を取得する>gitlab ci/cd で別プロジェクト (リポジトリ) の成果物を取得する</h2><p>gitlab では複数のパッケージリポジトリに対応しているが、それらに当てはまらない汎用の成果物向けに <a href=https://docs.gitlab.com/ee/user/packages/generic_packages/>GitLab Generic Packages Repository</a> というものがある。zip でもバイナリファイルでも何でも置くためのリポジトリと言える。但し、同じパッケージ名でバージョン管理するといった作りにはなっていなくて、同じパッケージ名でアップロードしても別のパッケージ id が割り当てられて管理される。他バージョンとの紐付け自体はできているので、おそらく歴史的経緯でそういう仕様なのだと思う。そのために、あるパッケージの最新のバージョンを取得したいときは作成日の降順でソートして最初のパッケージを取得するといったコードを書かないといけない。それは <a href=https://docs.gitlab.com/ee/api/packages.html>Packages API</a> を駆使して簡単なスクリプトを書くことになる。</p><p>もう1つ分からないことにトークンの使い分けがある。なるべく ci/cd での処理は <a href=https://docs.gitlab.com/ee/ci/jobs/ci_job_token.html>GitLab CI/CD job token</a> を使いたいところだが、どうも Packages API の呼び出しはできなくて別途プロジェクトでアクセストークンを作成して呼び出すようにしている。これはもしかしたら別の設定で CI/CD job token でも呼び出しできるかもしれない。rest api への呼び出し権限そのものがないのかもしれない。</p><p>最終的には次のようなスクリプトで任意のプロジェクトの generic リポジトリの最新の成果物を取得できた。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>rm -rf <span style=color:#e6db74>${</span>TARGET_DIR<span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span>mkdir -p <span style=color:#e6db74>${</span>TARGET_DIR<span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> project in $PROJECTS
</span></span><span style=display:flex><span><span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  prj<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>echo <span style=color:#e6db74>&#34;</span>$project<span style=color:#e6db74>&#34;</span> | jq -Rr @uri<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>  base<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>CI_API_V4_URL<span style=color:#e6db74>}</span><span style=color:#e6db74>/projects/</span><span style=color:#e6db74>${</span>prj<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>  pkg<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>curl -s -H <span style=color:#e6db74>&#34;PRIVATE-TOKEN: </span>$PROJECT_ACCESS_TOKEN<span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>base<span style=color:#e6db74>}</span><span style=color:#e6db74>/packages?order_by=created_at&amp;sort=desc&amp;per_page=1&#34;</span> | jq <span style=color:#e6db74>&#39;.[0]&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>  pkg_id<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>echo $pkg | jq -r .id<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>  pkg_name<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>echo $pkg | jq -r .name<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>  pkg_version<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>echo $pkg | jq -r .version<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>  file_names<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>curl -s -H <span style=color:#e6db74>&#34;PRIVATE-TOKEN: </span>$PROJECT_ACCESS_TOKEN<span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>base<span style=color:#e6db74>}</span><span style=color:#e6db74>/packages/</span><span style=color:#e6db74>${</span>pkg_id<span style=color:#e6db74>}</span><span style=color:#e6db74>/package_files&#34;</span> | jq -r <span style=color:#e6db74>&#39;.[].file_name&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> file_name in $file_names
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    dw_endpoint<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>base<span style=color:#e6db74>}</span><span style=color:#e6db74>/packages/generic/</span><span style=color:#e6db74>${</span>pkg_name<span style=color:#e6db74>}</span><span style=color:#e6db74>/</span><span style=color:#e6db74>${</span>pkg_version<span style=color:#e6db74>}</span><span style=color:#e6db74>/</span><span style=color:#e6db74>${</span>file_name<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    curl -s -H <span style=color:#e6db74>&#34;PRIVATE-TOKEN: </span>$PROJECT_ACCESS_TOKEN<span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>dw_endpoint<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> -o <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>TARGET_DIR<span style=color:#e6db74>}</span><span style=color:#e6db74>/</span><span style=color:#e6db74>${</span>file_name<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>find <span style=color:#e6db74>${</span>TARGET_DIR<span style=color:#e6db74>}</span> -type f
</span></span></code></pre></div></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0206/>集中のち寝不足</a></h1><div class=post-meta><time class=post-date>2023-02-06 (Mon.) ::</time></div><span class=post-tags>#<a href=/diary/tags/gitlab/>gitlab</a>&nbsp;
#<a href=/diary/tags/ci/cd/>ci/cd</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;</span><div class=post-content><p>1時に帰ってきてそのまま寝ないで6時10分の新幹線に乗ってから2時間半ほど寝た。これはこれで時間の使い方が有意義な気がする。午前中は翌日の定例会議の準備を着々と進めて、ci/cd 環境の改善、午後からリファクタリングなどをやっていた。15時をまわると眠くなってきて散歩したりして気分転換しつつも体調悪いなと思って17時半にお仕事を終えてホテルへ戻って2-3時間ほど寝てた。その後、晩ご飯食べるかなと出掛けたものの、あまり食欲もなくて、2時間ほど付近を散歩して運動していた。たまにはそういうのもいいか。飲食店が多い地域なので外から眺めているだけでもわりと楽しい。</p><h2 id=ssh-経由のデプロイ>ssh 経由のデプロイ</h2><p>これまで ci/cd でテストして docker イメージをビルドしてコンテナレジストリに登録するところまでやっていた。実際にテスト環境にデプロイするときは、テスト環境にログインして更新用のスクリプトを私が手動実行していた。そんなに頻繁にテスト環境を更新する必要がなかったのでそれでも十分ではあるものの、ci/cd の完成形を目指すなら自動化すべきという考え方もあってデプロイの部分を作ることにした。</p><p>もっとも簡単な方法として <a href=https://docs.gitlab.com/ee/ci/ssh_keys/>Using SSH keys with GitLab CI/CD</a> をみながら、ssh でテスト環境にデプロイすることにした。すでに更新用のスクリプトがあって、テスト環境にログインして実行すればできる状態なので ssh さえ使えればすぐに移行できるという話しでもある。openssh-client を使うためにベースイメージを alpine から ubuntu にしてパッケージをインストールしないといけない。実行時間がややかかるというコスト以外には気にならないかな。ssh の秘密鍵を <code>file</code> 種別でもつのか通常の環境変数でもつのかで扱いが異なって、それに少しはまったぐらいですぐできた。今後は docker イメージのビルド単位に自動的にデプロイされるようになる。</p><h2 id=interface-の型エイリアスとしての-any>interface{} の型エイリアスとしての any</h2><p>go のコードをリファクタリングしていて json.Marshal の引数が <code>any</code> となっていることに気付いた。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Marshal</span>(<span style=color:#a6e22e>v</span> <span style=color:#a6e22e>any</span>) ([]<span style=color:#66d9ef>byte</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>go 1.18 以降で <code>interface{}</code> の型エイリアスとして <code>any</code> が定義されているらしい。任意の型を扱えるシグネチャとして、メソッドの振る舞いのみを規定する <code>interface{}</code> を使うというのは型システムとしては正しい。他言語でいえば object に相当するものが go はオブジェクト指向言語ではないのでそれがない。そういう間違っていないけど、わかりにくいなと思っていたものに <code>any</code> という名前の型エイリアスが導入されてとてもしっくりきた。プログラミングしていて、実務的にどうかというところをちゃんと改善していくところがみえるのは楽しい。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>any</span> = <span style=color:#66d9ef>interface</span>{}
</span></span></code></pre></div><ul><li><a href=https://zenn.dev/syumai/articles/c6q5un1j0msim0aj0ca0>Go 1.18 で interface{} の代わりに any が使えるようになる話</a></li></ul></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/1219/>dind をやってみた</a></h1><div class=post-meta><time class=post-date>2022-12-19 (Mon.) ::</time></div><span class=post-tags>#<a href=/diary/tags/gitlab/>gitlab</a>&nbsp;
#<a href=/diary/tags/ci/cd/>ci/cd</a>&nbsp;
#<a href=/diary/tags/docker/>docker</a>&nbsp;
#<a href=/diary/tags/testing/>testing</a>&nbsp;</span><div class=post-content><p>3時に寝て7時半に起きた。最後なのでワールドカップの決勝戦をみてた。接戦で試合もおもしろかったしよかったと思う。</p><h2 id=gitlab-cicd-で-docker-in-docker>gitlab ci/cd で docker in docker</h2><p>ミドルウェアを伴う結合テストは <a href=https://github.com/ory/dockertest>dockertest</a> というツールを使って docker でミドルウェアを起動して実行している。デフォルトで作成した gitlab runner で docker を使おうとすると失敗する。これは gitlab runner が ci/cd ジョブを docker で動かすため docker in docker (これを <em>dind</em> と呼ぶらしい) のための設定が必要になる。大雑把に言えば gitlab runner にそのための権限を設定する必要がある。gitlab の次のドキュメントに詳細が書いてある。</p><ul><li><a href=https://docs.gitlab.com/ee/ci/docker/using_docker_build.html#use-docker-in-docker>Use Docker-in-Docker</a></li></ul><p>gitlab runner に権限を設定したら次のような job が動けば docker in docker は成功と言える。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>hello-dind</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>stage</span>: <span style=color:#ae81ff>test</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>image</span>: <span style=color:#ae81ff>docker:20.10.21</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>variables</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>DOCKER_HOST</span>: <span style=color:#ae81ff>tcp://docker:2375</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>DOCKER_TLS_CERTDIR</span>: <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>docker:20.10.21-dind</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>allow_failure</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>before_script</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>docker info</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>script</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>docker run hello-world</span>
</span></span></code></pre></div><p>あとになって気付いたことだけど、dockertest の README にも <a href=https://github.com/ory/dockertest#running-dockertest-in-gitlab-ci>Running dockertest in Gitlab CI</a> としていくつか tips が紹介されている。dockertest で作成したリソースからホスト名とポート番号を取得するには次のようなユーティリティを使う必要がある。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>getHostPort</span>(<span style=color:#a6e22e>resource</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>dockertest</span>.<span style=color:#a6e22e>Resource</span>, <span style=color:#a6e22e>id</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>dockerURL</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Getenv</span>(<span style=color:#e6db74>&#34;DOCKER_HOST&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>dockerURL</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>resource</span>.<span style=color:#a6e22e>GetHostPort</span>(<span style=color:#a6e22e>id</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>u</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>url</span>.<span style=color:#a6e22e>Parse</span>(<span style=color:#a6e22e>dockerURL</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>Hostname</span>() <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;:&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>resource</span>.<span style=color:#a6e22e>GetPort</span>(<span style=color:#a6e22e>id</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/1212/>docker compose に期待しない</a></h1><div class=post-meta><time class=post-date>2022-12-12 (Mon.) ::</time></div><span class=post-tags>#<a href=/diary/tags/gitlab/>gitlab</a>&nbsp;
#<a href=/diary/tags/docker/>docker</a>&nbsp;
#<a href=/diary/tags/infrastructure/>infrastructure</a>&nbsp;
#<a href=/diary/tags/founding/>founding</a>&nbsp;</span><div class=post-content><p>0時に寝て5時に起きて7時に起きた。起きたら冷やしたのかお腹痛かったが、まぁまぁ眠れたと思う。</p><h2 id=テスト環境の構築>テスト環境の構築</h2><p><a href=https://docs.gitlab.com/ee/ci/>GitLab CI/CD</a> にだいぶ慣れてきてジョブを追加したり改善したりしながらようやくアプリケーションの docker image もコンテナレジストリに push されるようになった。それを pull してきて、テスト環境を <a href=https://docs.docker.com/compose/>docker compose</a> で構築する。<a href=https://docs.docker.com/compose/production/>Use Compose in production</a> とドキュメントでは威勢がよいが、これが全然イケてない。複数の compose.yml で項目によっては変更したいところを置き換えるといった振る舞いになっていない。例えば、ポート番号などを dev と prod で置き換えたいといった運用の要件を考える。</p><ul><li>dev.yml</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>myapp</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>18080</span>:<span style=color:#ae81ff>8080</span>
</span></span></code></pre></div><ul><li>prod.yml</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>myapp</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>8080</span>:<span style=color:#ae81ff>8080</span>
</span></span></code></pre></div><p>これを次のように指定すると、</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ docker compose -f dev.yml -f prod.yml up -d
</span></span></code></pre></div><p>実際のサービスは次のように振る舞う。全然あかん。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>myapp</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>18080</span>:<span style=color:#ae81ff>8080</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>8080</span>:<span style=color:#ae81ff>8080</span>
</span></span></code></pre></div><p>他にもそれぞれの yml ファイルで読み込む environment file のマージなどもよくわからない振る舞いをしていて複数の compose.yml で制御するのは断念した。dry の原則に反して設定は重複するけど、それぞれの環境を個別に compose.yml として管理した方が保守コストは小さくなると私は判断した。複数の compose.yml の使い分けのデバッグを1-2日やった後に諦めてテスト環境の構築は完了した。</p><h2 id=年金事務所の住所変更手続き>年金事務所の住所変更手続き</h2><p>先週 <a href=/diary/posts/2022/1205/#法務局で法人登記の変更申請>法務局で法人登記の変更申請</a> をしていて、そのときに問題がなければ今日から登記事項証明書を取得できると案内をもらっていた。決定書が漏れていて再提出というトラブルはあったものの、最小限の損失で留めたせいか、問題なく登記事項証明書を発行できた。住所の変更だけわかればよいので履歴事項証明書ではなく現在事項証明書を発行してみた。この書類もおもしろくて1つ前の住所といまの住所の2つを確認できる。法務局へ行った帰りに年金事務所へ立ち寄って社会保険の住所変更の手続きを行った。次の3つの書類をもって窓口へ。</p><ul><li>登記事項証明書: 番地まで記載されている</li><li>オフィスの一時使用契約書: ビル名はあるがこのビル名は来月に改名</li><li>ビル名変更の証明書類: ビル名の変更のみが記載されている</li></ul><p>この3つの書類で完全に指定された住所 (Fully Qualified Address: 造語) を丁寧に説明したところ担当者に納得してもらえて事なきを得た。</p></div></article><div class=pagination><div class=pagination__buttons><a href=/diary/tags/gitlab/page/2/ class="button next"><span class=button__text>過去の日記</span>
<span class=button__icon>→</span></a></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>© 2021 Tetsuya Morimoto</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>