<!doctype html><html lang=en><head><title>ci/cd :: forest nook</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/tags/ci/cd/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="ci/cd"><meta property="og:description" content><meta property="og:url" content="/diary/tags/ci/cd/"><meta property="og:site_name" content="forest nook"><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/tags/ci/cd/index.xml rel=alternate type=application/rss+xml title="forest nook"></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><div class=posts><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0206/>集中のち寝不足</a></h1><div class=post-meta><time class=post-date>2023-02-06 (Mon.) ::</time></div><span class=post-tags>#<a href=/diary/tags/gitlab/>gitlab</a>&nbsp;
#<a href=/diary/tags/ci/cd/>ci/cd</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;</span><div class=post-content><p>1時に帰ってきてそのまま寝ないで6時10分の新幹線に乗ってから2時間半ほど寝た。これはこれで時間の使い方が有意義な気がする。午前中は翌日の定例会議の準備を着々と進めて、ci/cd 環境の改善、午後からリファクタリングなどをやっていた。15時をまわると眠くなってきて散歩したりして気分転換しつつも体調悪いなと思って17時半にお仕事を終えてホテルへ戻って2-3時間ほど寝てた。その後、晩ご飯食べるかなと出掛けたものの、あまり食欲もなくて、2時間ほど付近を散歩して運動していた。たまにはそういうのもいいか。飲食店が多い地域なので外から眺めているだけでもわりと楽しい。</p><h2 id=ssh-経由のデプロイ>ssh 経由のデプロイ</h2><p>これまで ci/cd でテストして docker イメージをビルドしてコンテナレジストリに登録するところまでやっていた。実際にテスト環境にデプロイするときは、テスト環境にログインして更新用のスクリプトを私が手動実行していた。そんなに頻繁にテスト環境を更新する必要がなかったのでそれでも十分ではあるものの、ci/cd の完成形を目指すなら自動化すべきという考え方もあってデプロイの部分を作ることにした。</p><p>もっとも簡単な方法として <a href=https://docs.gitlab.com/ee/ci/ssh_keys/>Using SSH keys with GitLab CI/CD</a> をみながら、ssh でテスト環境にデプロイすることにした。すでに更新用のスクリプトがあって、テスト環境にログインして実行すればできる状態なので ssh さえ使えればすぐに移行できるという話しでもある。openssh-client を使うためにベースイメージを alpine から ubuntu にしてパッケージをインストールしないといけない。実行時間がややかかるというコスト以外には気にならないかな。ssh の秘密鍵を <code>file</code> 種別でもつのか通常の環境変数でもつのかで扱いが異なって、それに少しはまったぐらいですぐできた。今後は docker イメージのビルド単位に自動的にデプロイされるようになる。</p><h2 id=interface-の型エイリアスとしての-any>interface{} の型エイリアスとしての any</h2><p>go のコードをリファクタリングしていて json.Marshal の引数が <code>any</code> となっていることに気付いた。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Marshal</span>(<span style=color:#a6e22e>v</span> <span style=color:#a6e22e>any</span>) ([]<span style=color:#66d9ef>byte</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>go 1.18 以降で <code>interface{}</code> の型エイリアスとして <code>any</code> が定義されているらしい。任意の型を扱えるシグネチャとして、メソッドの振る舞いのみを規定する <code>interface{}</code> を使うというのは型システムとしては正しい。他言語でいえば object に相当するものが go はオブジェクト指向言語ではないのでそれがない。そういう間違っていないけど、わかりにくいなと思っていたものに <code>any</code> という名前の型エイリアスが導入されてとてもしっくりきた。プログラミングしていて、実務的にどうかというところをちゃんと改善していくところがみえるのは楽しい。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>any</span> = <span style=color:#66d9ef>interface</span>{}
</span></span></code></pre></div><ul><li><a href=https://zenn.dev/syumai/articles/c6q5un1j0msim0aj0ca0>Go 1.18 で interface{} の代わりに any が使えるようになる話</a></li></ul></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0130/>思い立ったらドキュメントを公開</a></h1><div class=post-meta><time class=post-date>2023-01-30 (Mon.) ::</time></div><span class=post-tags>#<a href=/diary/tags/document/>document</a>&nbsp;
#<a href=/diary/tags/ci/cd/>ci/cd</a>&nbsp;
#<a href=/diary/tags/docker/>docker</a>&nbsp;</span><div class=post-content><p>23時に寝て2時頃に少し吐いて起きた。夜遅めに日本酒飲んでいい気分で寝たものの、もう夜に食べたらダメな体になりつつある。4時ぐらいまで起きててそれから寝て7時に起きた。</p><h2 id=echo-の静的ファイルの扱い>echo の静的ファイルの扱い</h2><p>web api のドキュメントは <a href=/diary/posts/2022/1216/#openapi-勉強会>openapi スキーマを使って生成</a> している。本当はこのドキュメントを gitlab pages で公開させたいのだけど、まだそのインフラ構築ができていなくて先送りになっている。いつもローカルで gitlab ci/cd がビルドしたドキュメントをみていたのだけど、ある機能開発をするときにローカルで web api ドキュメントみるの飽きたなと思って、web api サーバーに同梱してしまえと思い立った。テスト環境の web api サーバーは常に動いているのだから、そこに web api のドキュメントが同梱されていて、なんの不都合があろうか？ (いや、なにもない) 。</p><p>次のドキュメントに echo で静的ファイルを扱う方法が書いてある。</p><ul><li><a href=https://echo.labstack.com/guide/static-files/>Static Files</a></li></ul><p>ミドルウェアで実装されているようで簡単に静的ファイルを返せる。指定したパスのディレクトリ配下を扱えるのが <code>Static</code> で、指定したパスのファイルを扱うのが <code>File</code> になる。web api ドキュメントのようなものならキャッシュしてもいいなとは思ったものの、次の issue によると v4 ではミドルウェアで自前実装しないといけないらしい。v5 ではその仕組みが echo の機能として入るかもしれない。</p><ul><li><a href=https://github.com/labstack/echo/issues/1902>TTL (Cache-Control header in response) for static files #1902</a></li></ul><p>その後、gitlab ci/cd で web api サーバーのビルド後、openapi.yml からドキュメント生成をして、任意の static ディレクトリに配置するように設定した。docker のマルチステージビルドを使うと簡単にできる。バックエンドやっていて、サーバーとインフラの両方に手を入れて機能を作っていくときの、うまくできると利便性と達成感の両方を得られるのが楽しい。web api サーバーがドキュメントを提供することは、要件に含まれるわけでも、誰かに指示されたわけでもない。私が勝手にローカルでドキュメントみるの飽きたと思って、勝手に作って、勝手に動くようにしただけ。こういう開発の遊びのゆとりや権限をチームのメンバーにも与えられるようにしていきたい。開発が楽しくて悪いことはなにもないと思うんよね。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/1219/>dind をやってみた</a></h1><div class=post-meta><time class=post-date>2022-12-19 (Mon.) ::</time></div><span class=post-tags>#<a href=/diary/tags/gitlab/>gitlab</a>&nbsp;
#<a href=/diary/tags/ci/cd/>ci/cd</a>&nbsp;
#<a href=/diary/tags/docker/>docker</a>&nbsp;
#<a href=/diary/tags/testing/>testing</a>&nbsp;</span><div class=post-content><p>3時に寝て7時半に起きた。最後なのでワールドカップの決勝戦をみてた。接戦で試合もおもしろかったしよかったと思う。</p><h2 id=gitlab-cicd-で-docker-in-docker>gitlab ci/cd で docker in docker</h2><p>ミドルウェアを伴う結合テストは <a href=https://github.com/ory/dockertest>dockertest</a> というツールを使って docker でミドルウェアを起動して実行している。デフォルトで作成した gitlab runner で docker を使おうとすると失敗する。これは gitlab runner が ci/cd ジョブを docker で動かすため docker in docker (これを <em>dind</em> と呼ぶらしい) のための設定が必要になる。大雑把に言えば gitlab runner にそのための権限を設定する必要がある。gitlab の次のドキュメントに詳細が書いてある。</p><ul><li><a href=https://docs.gitlab.com/ee/ci/docker/using_docker_build.html#use-docker-in-docker>Use Docker-in-Docker</a></li></ul><p>gitlab runner に権限を設定したら次のような job が動けば docker in docker は成功と言える。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>hello-dind</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>stage</span>: <span style=color:#ae81ff>test</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>image</span>: <span style=color:#ae81ff>docker:20.10.21</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>variables</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>DOCKER_HOST</span>: <span style=color:#ae81ff>tcp://docker:2375</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>DOCKER_TLS_CERTDIR</span>: <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>docker:20.10.21-dind</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>allow_failure</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>before_script</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>docker info</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>script</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>docker run hello-world</span>
</span></span></code></pre></div><p>あとになって気付いたことだけど、dockertest の README にも <a href=https://github.com/ory/dockertest#running-dockertest-in-gitlab-ci>Running dockertest in Gitlab CI</a> としていくつか tips が紹介されている。dockertest で作成したリソースからホスト名とポート番号を取得するには次のようなユーティリティを使う必要がある。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>getHostPort</span>(<span style=color:#a6e22e>resource</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>dockertest</span>.<span style=color:#a6e22e>Resource</span>, <span style=color:#a6e22e>id</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>dockerURL</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Getenv</span>(<span style=color:#e6db74>&#34;DOCKER_HOST&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>dockerURL</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>resource</span>.<span style=color:#a6e22e>GetHostPort</span>(<span style=color:#a6e22e>id</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>u</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>url</span>.<span style=color:#a6e22e>Parse</span>(<span style=color:#a6e22e>dockerURL</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>Hostname</span>() <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;:&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>resource</span>.<span style=color:#a6e22e>GetPort</span>(<span style=color:#a6e22e>id</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/1210/>openapi-ext-tools をまた使う日がきた</a></h1><div class=post-meta><time class=post-date>2022-12-10 (Sat.) ::</time></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/gitlab/>gitlab</a>&nbsp;
#<a href=/diary/tags/ci/cd/>ci/cd</a>&nbsp;
#<a href=/diary/tags/openapi/>openapi</a>&nbsp;
#<a href=/diary/tags/python/>python</a>&nbsp;</span><div class=post-content><p>0時に寝て4時に起きて7時に起きた。わりとよく眠れた。</p><h2 id=ストレッチ>ストレッチ</h2><p>トレーナーさんと月曜日の日本対クロアチア戦の感想を話したりしていた。今日の開脚幅は開始前153cmで、ストレッチ後156cmだった。先週は疲弊と疲労で散々な数値になっていたものが復調してきつつある。今週も毎日8-22時はオフィスで缶詰め状態だった。たくさん座っている (同じ体勢でいる) 時間が増えると筋肉にはよくない。まだまだ右腰と右太もも周りの張りは強く復調にはもう少し時間がかかるようにみえる。一方で忙しさのピークを越したと思うので今週以降は少しペースダウンしながら体作りをしていく。いまお手伝いしている開発は12月にすべての集中力を費やしてもよいと考えている。残りは期間はメンバーに委譲するような体制になるとベストかもしれない。そのための体力づくりは重要。</p><h2 id=openapi-ext-tools-再び>openapi-ext-tools 再び</h2><p>github pages ならぬ <a href=https://docs.gitlab.com/ee/user/project/pages/>gitlab pages</a> がある。ふと web api のドキュメントを作るために openapi のスキーマを定義したら gitlab の ci/cd と連携できていいんじゃないかと思い付いた。スキーマがあればフロントエンドのクライアント生成や e2e テストコードの自動生成などに使えるかもしれないし。過去に作った <a href=https://pypi.org/project/openapi-ext-tools/>openapi-ext-tools</a> を oss にしておいたからいまも使える。oss 万歳。先のことはわからない。<a href=https://github.com/Redocly/redoc>redoc</a> を使ってちゃっちゃと実装した。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>pages</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>only</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>changes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>schema/*</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>stage</span>: <span style=color:#ae81ff>deploy</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>image</span>: <span style=color:#ae81ff>alpine:latest</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>before_script</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>apk --no-cache add python3 nodejs npm</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>python --version</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>python -m ensurepip</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>pip3 --version</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>node --version</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>npm --version</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>npm install --global redoc-cli</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>redoc-cli --version</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>pip3 install openapi-ext-tools</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>pip3 freeze openapi-ext-tools | grep openapi</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>script</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>openapi-spec-cli --spec-path schema/openapi.yml</span>
</span></span><span style=display:flex><span>    - |+<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      redoc-cli bundle bundled_openapi.yaml \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        --output index.html \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        --options.expandResponses=all \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        --options.requiredPropsFirst=true \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        --options.jsonSampleExpandLevel=10 \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        --options.hideLoading=true \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        --options.pathInMiddlePanel=true</span>      
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>mkdir -p public</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>mv index.html public/</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>artifacts</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>paths</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>public</span>
</span></span></code></pre></div><p>久しぶりに触ったら openapi-ext-tools が依存ライブラリの変更で動かなくなっていたので直した。</p><ul><li><a href=https://github.com/t2y/openapi-ext-tools/issues/1>cannot import name &lsquo;ValidationError&rsquo; from &lsquo;openapi_spec_validator.exceptions&rsquo; #1</a></li></ul></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/1207/>gitlab の ci/cd 入門</a></h1><div class=post-meta><time class=post-date>2022-12-07 (Wed.) ::</time></div><span class=post-tags>#<a href=/diary/tags/gitlab/>gitlab</a>&nbsp;
#<a href=/diary/tags/ci/cd/>ci/cd</a>&nbsp;</span><div class=post-content><p>0時に寝て3時に起きてそのまま眠れずにいたら6時になって7時過ぎから準備してオフィス行ってお仕事を始めた。</p><h2 id=gitlab-の-cicd-の調査>gitlab の ci/cd の調査</h2><p>初めて <a href=https://docs.gitlab.com/ee/ci/>GitLab CI/CD</a> を触っている。まだ触り始めたばかりだが、感覚的には github actions 相当の機能はあるようにみえる。ソースコードリポジトリやパッケージリポジトリ／コンテナレジストリと ci/cd がセットになっているととても便利だ。これはすごいことだと最近思うようになってきた。もはやソースコードリポジトリのみのホスティングビジネスは成り立たない。なぜなら github や gitlab のような ci/cd が当たり前になってしまうと、その機能がない場合、デメリットを上回るメリットがないとそんなソースコードリポジトリを選択しない。</p><p>docker image をビルドして push する仕組みは既にメンバーが作ってくれていたのでその後始末の処理を作った。<a href=https://docs.gitlab.com/ee/api/container_registry.html>Container Registry API</a> を使うと、不要な docker image を削除できる。</p><ul><li><a href=https://docs.gitlab.com/ee/api/container_registry.html#delete-registry-repository-tags-in-bulk>Delete registry repository tags in bulk</a></li></ul><p>削除向けに便利な api 設計になっている。こういう細かい配慮は嬉しい。<code>keep_n</code> で最低限残すイメージ数を指定して <code>older_than</code> で過去何日より古いイメージを削除対象とするといったよくある運用の設定ができる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -s -H <span style=color:#e6db74>&#34;PRIVATE-TOKEN: </span>$PROJECT_ACCESS_TOKEN<span style=color:#e6db74>&#34;</span> -X DELETE <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>endpoint<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --data <span style=color:#e6db74>&#34;name_regex_delete=.*&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --data <span style=color:#e6db74>&#34;keep_n=</span><span style=color:#e6db74>${</span>KEEP_N<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --data <span style=color:#e6db74>&#34;older_than=</span><span style=color:#e6db74>${</span>OLDER_THAN<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span></code></pre></div><p>あとは認証のトークンを指定する方法として私が調べた限りだと2通りある。</p><ul><li>(<code>ci_job_token_scope</code> の feature flag を有効にして) <code>$CI_JOB_TOKEN</code> を使う<ul><li>こっちの方が一時トークンなのでよりセキュアなはず</li><li>この場合はヘッダーに JOB-TOKEN を指定する</li></ul></li><li><a href=https://docs.gitlab.com/ee/user/project/settings/project_access_tokens.html>プロジェクトレベルのアクセストークン</a> を発行して ci/cd の variables に登録する<ul><li>トークンが漏洩したときにプロジェクトレベルで被害が発生する</li><li>この場合はヘッダーに PRIVATE-TOKEN を指定する</li></ul></li></ul><p>使うトークンによってヘッダーが変わるというのがちょっと変な認証の設計にもみえるけど、まぁそれぐらいしか気にはならない。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0731/>久しぶりにブログを書いた</a></h1><div class=post-meta><time class=post-date>2022-07-31 (Sun.) ::</time></div><span class=post-tags>#<a href=/diary/tags/book/>book</a>&nbsp;
#<a href=/diary/tags/github/>github</a>&nbsp;
#<a href=/diary/tags/ci/cd/>ci/cd</a>&nbsp;</span><div class=post-content><p>2時過ぎに寝て7時に起きて9時まで寝てた。</p><h2 id=もてなしだけではもう食えない>もてなしだけではもう食えない</h2><p>読み進めておもしろかったし学びにもなったので書評を書いた。</p><ul><li><a href=https://note.com/t2y1979/n/nc5c156ae529e>もてなしだけではもう食えない -ホテル経営学の本質と実践-</a></li></ul><h2 id=backlog-github-integration-action-v101-リリース>backlog-github-integration-action v1.0.1 リリース</h2><p><a href=/diary/posts/2022/0710/#backlog-github-integration-action-のバグ修正>backlog-github-integration-action のバグ修正</a> した変更を v1.0.1 としてリリースした。2週間ほど検証環境でリグレッションがないかをみていた。問題なさそうなので v1 ブランチにマージして docker イメージを push して v1.0.1 タグを付けてリリース成果物を作成した。久しぶりにやると手順を忘れていてドキュメントを書かないといけないなとか思ったりした。</p><ul><li><a href=https://github.com/marketplace/actions/backlog-github-integration-action>backlog-github-integration-action</a></li></ul></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0714/>意図がわかる設計とリファクタリング</a></h1><div class=post-meta><time class=post-date>2022-07-14 (Thu.) ::</time></div><span class=post-tags>#<a href=/diary/tags/github/>github</a>&nbsp;
#<a href=/diary/tags/ci/cd/>ci/cd</a>&nbsp;
#<a href=/diary/tags/refactoring/>refactoring</a>&nbsp;</span><div class=post-content><p>1時に寝て7時に起きた。久しぶりに <a href=https://www.nbcuni.co.jp/rondorobe/anime/hellsing/>HELLSING</a> をみてた。アレクサンド・アンデルセンの狂信者ノリが好き。</p><h2 id=煩雑な保守>煩雑な保守</h2><p>昨日から着手した s3 とやり取りするアプリケーションの保守をしている。一通り機能は実装できたが、このアプリケーションの保守を今後どうやっていけばいいのかが私からはみえない。要件が変わる度に継ぎ接ぎで拡張してきて、意図をもった設計があるわけではないようにみえる。このまま保守することはできるかもしれないが、このロジックの説明もテストも検証もすべてが難しい。私がみても難しいのだから、経験の浅い開発者がみるともっと難しいのではないかと思う。</p><p>これを直すにはまず単体テストを直さないといけない。単体テストの大半がモックベースなので実際の振る舞いと異なる可能性がある。とくに s3 とやり取りするところの検証ができない。<a href=https://www.testcontainers.org/modules/localstack/>testcontainers の localstack</a> があるので単体テストはモックからこのモジュールを使うように代替できそう。まずはそこからやるべきだが、2-3日はかかると見込まれるのでチームで承認を得られるかどうか、ちょっと聞いてみてから考える。</p><h2 id=job-summary-を使ってみた>Job Summary を使ってみた</h2><p>ちょっと前に github actions のワークフローの実行画面にサマリを出力できるようになったという記事をみた。</p><ul><li><a href=https://github.blog/2022-05-09-supercharging-github-actions-with-job-summaries/>Supercharging GitHub Actions with Job Summaries</a></li></ul><p>自動でよさげなサマリを出力してくれるわけではなく、自分でサマリを作らないといけないので面倒だなと思ってそのまま放置していた。先週末に <a href=/diary/posts/2022/0709/#github-actions-の-push-イベントワークフロー改善>モジュール別のビルド・デプロイのワークフロー改善</a> を行った。ふとワークフローの実行結果をみていて、選択したモジュール名が表示されているとわかりやすくていいなと思えた。それを出力する手段としてサマリがちょうどいいやということに気付いた。inputs などで動的に変更するパラメーターをワークフローの実行画面で確認できるといちいちログ確認する手間が省けてよいという場面が他の用途でもある気がしてきた。もっと積極的にサマリを使っていこうと思えた瞬間だった。</p></div></article><div class=pagination><div class=pagination__buttons><a href=/diary/tags/ci/cd/page/2/ class="button next"><span class=button__text>過去の日記</span>
<span class=button__icon>→</span></a></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>© 2021 Tetsuya Morimoto</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>