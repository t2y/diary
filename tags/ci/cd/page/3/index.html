<!doctype html><html lang=en><head><title>ci/cd :: forest nook</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/tags/ci/cd/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="ci/cd"><meta property="og:description" content><meta property="og:url" content="/diary/tags/ci/cd/"><meta property="og:site_name" content="forest nook"><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/tags/ci/cd/index.xml rel=alternate type=application/rss+xml title="forest nook"></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><div class=posts><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0328/>backlog-github-integration-action を運用し始めた</a></h1><div class=post-meta><time class=post-date>2022-03-28 (Mon.) ::</time></div><span class=post-tags>#<a href=/diary/tags/github/>github</a>&nbsp;
#<a href=/diary/tags/ci/cd/>ci/cd</a>&nbsp;</span><div class=post-content><p>2時に寝て6時半に起きた。</p><h2 id=backlog-と-github-のインテグレーション-action-の試験運用>backlog と github のインテグレーション action の試験運用</h2><p>昨日作った backlog-github-integration-action を早速お手伝い先の github リポジトリと backlog に導入した。いま暇な時期というのもあって、誰からもクレームが出なかった。この閑散とした間隙を「乗るしかない、このビッグウェーブに」というノリで導入して運用して既成事実を作る。ses でお手伝いに行って課題管理のツールを作っているというのは頭おかしいと思うけど、周りからクレームが出る前に電光石火で運用にのせてしまう。実際に運用で使うといくつかバグがあって、いま latest の docker イメージを使ってカスタム action が動いている。バグがあったら修正して、<code>./gradlew jib</code> (docker push) で新しい docker イメージを gihtub packages に push して、不具合があった pr のジョブを再実行すれば再現環境でテストもできる。いくつかバグ修正をした。実際の運用のデータを使うとばらばらとバグがみつかる。運用で実際に使われていないツールはダメ、絶対。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0327/>backlog-github-integration-action を作った</a></h1><div class=post-meta><time class=post-date>2022-03-27 (Sun.) ::</time></div><span class=post-tags>#<a href=/diary/tags/java/>java</a>&nbsp;
#<a href=/diary/tags/github/>github</a>&nbsp;
#<a href=/diary/tags/ci/cd/>ci/cd</a>&nbsp;</span><div class=post-content><p>0時に寝て7時に起きた。丸一日開発していた。構想1ヶ月、実装2日といったところか。</p><h2 id=backlog-と-github-のインテグレーション-action>backlog と github のインテグレーション action</h2><p>お手伝い先が <a href=https://backlog.com/ja/>backlog</a> を課題管理システムとして使っている。backlog は <a href=https://support-ja.backlog.com/hc/ja/sections/360005425774-Git>git 連携</a> の機能をもっているが、これは nulab 社のクラウド上に git リポジトリを構築したものと連携する機能であって、github と連携する機能ではない。そこで github と backlog と連携するためのカスタム github action を作った。</p><ul><li><a href=https://github.com/kazamori/backlog-github-integration-action>https://github.com/kazamori/backlog-github-integration-action</a></li></ul><p>カスタム github action を java で開発するのは普通にはやらないと思うが、いくつか理由があってお手伝い先が java しかできないというのと、nulab 社が提供している公式クライアント <a href=https://github.com/nulab/backlog4j>nulab/backlog4j</a> が java しかないから。最初は go で実装しようと思って go のクライアントを試したんだけど、サンプルコードをかいたら一部の処理でエラーになって、そのエラーがよくわからなくてやる気がなくなってしまった。最新の rest api の仕様にそってメンテナンスされていないのかな？と思って、やっぱり公式クライアントしかないなと。他にも次のライブラリを使っている。</p><ul><li>設定ファイル: <a href=https://github.com/lightbend/config>https://github.com/lightbend/config</a></li><li>コマンドライン解析: <a href=https://github.com/remkop/picocli>https://github.com/remkop/picocli</a></li><li>github クライアント: <a href=https://github.com/hub4j/github-api>https://github.com/hub4j/github-api</a></li></ul><p>これまでは commons-cli を使ってきたけど、サブコマンドの機能を提供していない。もうメンテされてないかも？サブコマンドの機能をもつ argument parser がほしくて picocli を選択した。初めて使っていて、実装してみたらわりと私の好みでよく出来ていると思う。今後は cli ライブラリとして picocli を使っていこうと思う。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0321/>github actions の課金金額</a></h1><div class=post-meta><time class=post-date>2022-03-21 (Mon.) ::</time></div><span class=post-tags>#<a href=/diary/tags/github/>github</a>&nbsp;
#<a href=/diary/tags/ci/cd/>ci/cd</a>&nbsp;</span><div class=post-content><p>2時に寝て何度か起きてだらだらしながら10時に起きた。</p><h2 id=gihtub-api-tools-のリファクタリングとデータ分析>gihtub-api-tools のリファクタリングとデータ分析</h2><p>実際に使ってみながらリファクタリングしたり、足りない機能を追加したりした。ツールに拡張した機能が使えるかどうかの検証のため、お仕事のプライベートリポジトリのデータを使って分析をし始めて、気付いたら分析ならびに分析結果の資料まで作ってしまった。軽く半日ぐらいのお仕事をやってしまっていた。過去5ヶ月分の課金時間の合計を算出し、単体テストの実行を github actions に追加することで増える課金時間の見積もりと金額を算出した。月間でいまより3時間30分、全体の課金時間に対して20%弱程度の追加が見込まれる。それによる課金金額を算出すると 210 * $0.008 = $1.68 になる。いままで無料枠を超えないように運用してきたわけだが、こんな200円程度の金額を節約するために github actions 上でテスト実行しないといった判断がくだされていた。開発者は誰も実際の課金金額を知らなかったし、課金金額を算出するとあほらしくなった。あと github actions はめちゃくちゃ安い。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0320/>gihtub-api-tools の拡張</a></h1><div class=post-meta><time class=post-date>2022-03-20 (Sun.) ::</time></div><span class=post-tags>#<a href=/diary/tags/github/>github</a>&nbsp;
#<a href=/diary/tags/ci/cd/>ci/cd</a>&nbsp;
#<a href=/diary/tags/python/>python</a>&nbsp;</span><div class=post-content><p>5時に寝て9時過ぎに起きた。昨日は久しぶりに夜更ししてコードを書いてた。</p><h2 id=github-actions-のいろいろな時間の算出>github actions のいろいろな時間の算出</h2><p>以前作った github-api-tools を拡張して github actions の実行履歴の分析するための機能を作っている。</p><ul><li><a href=https://github.com/kazamori/github-api-tools/issues/2>Add actions statistics</a></li><li><a href=https://github.com/kazamori/github-api-tools/pull/4>Add gh-cli-actions command for Actions API</a></li></ul><p>ひとまずワークフローの実行履歴からジョブのステップの実行時間を積み上げた時間を算出してみた。いくつか API を調べているうちに課金時間は直接 API から取得できることに気付いた。この3つの時間は全然別の意味をもっていて、それぞれの時間は一致しない。</p><ul><li>ステップ実行時間: ジョブのそれぞれのステップの実行時間の合計</li><li>課金時間: 課金対象として数えられている時間の合計</li><li>ワークフロー実行時間: アクションのワークフローの実行にかかった時間</li></ul><p>github actions は public リポジトリに関しては課金対象ではないんやね。private リポジトリ且つ github-hosted ランナーを使っている場合のみ課金対象となるみたい。</p><ul><li><a href=https://docs.github.com/en/actions/monitoring-and-troubleshooting-workflows/viewing-job-execution-time>Viewing job execution time</a></li><li><a href=https://docs.github.com/en/billing/managing-billing-for-github-actions/about-billing-for-github-actions>About billing for GitHub Actions</a></li></ul></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0318/>github actions の改善</a></h1><div class=post-meta><time class=post-date>2022-03-18 (Fri.) ::</time></div><span class=post-tags>#<a href=/diary/tags/github/>github</a>&nbsp;
#<a href=/diary/tags/ci/cd/>ci/cd</a>&nbsp;
#<a href=/diary/tags/book/>book</a>&nbsp;</span><div class=post-content><p>0時に寝て3時に起きて6時に起きた。</p><h2 id=失敗したジョブの再実行>失敗したジョブの再実行</h2><p>せらさんのツィートをみかけて調べたら2日ほど前に失敗したジョブからの再実行の改善が行われたらしい。</p><blockquote class=twitter-tweet><p lang=ja dir=ltr>GitHub Action で失敗したジョブだけ実行できる様になってる。今まで失敗しやすいものは再実行を小さくするために設定を分けたりとかしていたんだけど、そういうことをしなくてもよくなった。</p>&mdash; Kazuhiro Sera (瀬良) (@seratch_ja) <a href="https://twitter.com/seratch_ja/status/1504664461483085826?ref_src=twsrc%5Etfw">March 18, 2022</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script><ul><li><a href=https://github.blog/2022-03-16-save-time-partial-re-runs-github-actions/>Save time with partial re-runs in GitHub Actions</a></li></ul><p>たまにだけど、i/o エラーみたいな内容で github actions のワークフロー実行が異常終了することがある。そんなときに途中から再実行できるといいなぁとは思っていた。これはステップ単位ではなく、ジョブ単位の実行みたいだけど、それでも途中から再実行できればワークフローの自由度や効率は上がると思う。github actions がどんどん強力になっていくのが楽しみ。あとやぎさんから教えてもらった <a href=https://miyajan.booth.pm/items/1865906>GitHub Actions 実践入門</a> も購入した。ある程度触ったところで雰囲気は掴めてきたので体系的に学んでみる。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0314/>平穏な一日</a></h1><div class=post-meta><time class=post-date>2022-03-14 (Mon.) ::</time></div><span class=post-tags>#<a href=/diary/tags/github/>github</a>&nbsp;
#<a href=/diary/tags/ci/cd/>ci/cd</a>&nbsp;</span><div class=post-content><p>0時に寝て5時半に起きた。一仕事を終えて淡々と前の作業の続きのリファクタリングなどをしていた。</p><h2 id=デプロイ改善のタスク完了報告>デプロイ改善のタスク完了報告</h2><p>週末にパイプライン処理の検証やロールバック処理の実装を行った。ドキュメントも一通り書いた。チームの開発者にそれらを説明して3スプリント(3週間)に渡った改善が完了したことを報告した。チケットにすると26、そのうち私が担当したのが22なので、私がイニシアティブをとって完遂させた。github actions を始めとする、github のサービスの理解が深まってそれなりに学びがあった。自分でもいくつかカスタム action を作ってみようと思う。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0312/>デプロイ改善の残作業</a></h1><div class=post-meta><time class=post-date>2022-03-12 (Sat.) ::</time></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/github/>github</a>&nbsp;
#<a href=/diary/tags/ci/cd/>ci/cd</a>&nbsp;</span><div class=post-content><p>23時に寝て2時に起きて4時ぐらいまでだらだらして寝て6時に起きた。</p><h2 id=ストレッチ>ストレッチ</h2><p>これまで11時からストレッチを受けていたが、今週から dr.stretch さんの土日の開店時間が10時になったのにあわせる形で時間変更した。朝に予定が入っているとその時間にあわせて起きて身支度して1日が始まるので家で中途半端にだらだらしなくてよい。いつもは11時にあわせて家を出掛けるのが、10時にあわせて出掛けるようになったのでいつもより1時間早く活動できるようになった。私はなんか予定がないとだらだらしてしまって怠惰に過ごしてしまう。そういう怠ける自分の性格もわかっているので適度に予定を入れて怠けないように注意している。</p><p>今日の開脚幅は開始前163cmで、ストレッチ後165cmだった。先週とほぼ同じ。今週もお仕事が忙しくて全くできなかったので現状維持といったところ。</p><h2 id=デプロイのパイプライン処理>デプロイのパイプライン処理</h2><p>github deployment から workflow dispatch に移行したおかげでせっかく deployments ベースで作ったパイプライン処理のツールを workflow dispatch 向けに移行する必要があった。言うても基本的に同じパラメーターを処理するだけなので大半は再利用できる。ツールのちょっとしたリファクタリングをやってパイプライン処理が動くかどうかの検証をして、ドキュメントを wiki にまとめた。あとはロールバックを自動化するための仕組みを作るだけ。基本的には k8s の kubectl を実行するワークフローを作るだけという想定。</p></div></article><div class=pagination><div class=pagination__buttons><a href=/diary/tags/ci/cd/page/2/ class="button previous"><span class=button__icon>←</span>
<span class=button__text>最近の日記</span></a>
<a href=/diary/tags/ci/cd/page/4/ class="button next"><span class=button__text>過去の日記</span>
<span class=button__icon>→</span></a></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>© 2021 Tetsuya Morimoto</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>