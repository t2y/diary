<!doctype html><html lang=en><head><title>Go :: </title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/tags/go/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="Go"><meta property="og:description" content><meta property="og:url" content="/diary/tags/go/"><meta property="og:site_name" content><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/tags/go/index.xml rel=alternate type=application/rss+xml title></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><h1>Posts for: #Go</h1><div class=posts><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0309/>キャンセルが続くような日</a></h1><div class=post-meta><time class=post-date>2024-03-09</time></div><span class=post-tags>#<a href=/diary/tags/event/>event</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;
#<a href=/diary/tags/health/>health</a>&nbsp;</span><div class=post-content><p>3時半に寝て7時前に起きた。昨日はコーディングに集中していた。</p><p>今日の運動は腹筋ローラー,腕立て,スクワット,散歩をした。統計を <a href="https://docs.google.com/spreadsheets/d/1bg85QtM-LciUgey8I79uI7vW2PEwsP6TVdeIRVkACBg/edit?usp=sharing">運動の記録</a> にまとめる。</p><h2 id=明石海峡大橋海上ウォークのキャンセル>明石海峡大橋海上ウォークのキャンセル</h2><p><a href=/diary/posts/2024/0118/#明石海峡大橋海上ウォーク>明石海峡大橋海上ウォーク</a> の当日。こみやさんが関東からわざわざ来るというので私も付き添いで参加することにしてした。朝起きて準備して元町駅から8時半頃の電車に乗って舞子駅へ向かう。途中で slack に一報したらこみやさんから今日は中止だよと連絡が入る。新長田駅で折り返して三ノ宮に返ってきた。当日6時に強風予報のため中止になっていたらしい。普通に晴れているのに。橋の上を歩くイベントは強風で当日中止とかになるんやということを学んだ。</p><blockquote class=twitter-tweet><p lang=ja dir=ltr>【中止】明石海峡大橋海上ウォーク<br><br>受付にいったら【強風のため中止】って…ガーン😱<br><br>6時にホームページで発表してたらしい…<br><br>晴れてるからてっきり開催されてるかと思って確認してなかった😣<br><br>2024年3月9日(土)<a href="https://twitter.com/hashtag/%E6%98%8E%E7%9F%B3%E6%B5%B7%E5%B3%A1%E5%A4%A7%E6%A9%8B?src=hash&amp;ref_src=twsrc%5Etfw">#明石海峡大橋</a><a href="https://twitter.com/hashtag/%E6%B5%B7%E4%B8%8A%E3%82%A6%E3%82%A9%E3%83%BC%E3%82%AF?src=hash&amp;ref_src=twsrc%5Etfw">#海上ウォーク</a><a href="https://twitter.com/hashtag/%E6%B5%B7%E4%B8%8A%E3%82%A6%E3%82%A9%E3%83%BC%E3%82%AF%E4%B8%AD%E6%AD%A2?src=hash&amp;ref_src=twsrc%5Etfw">#海上ウォーク中止</a> <a href=https://t.co/N1ABzTez3W>pic.twitter.com/N1ABzTez3W</a></p>&mdash; pino hana-kotori (@pinohanakotori) <a href="https://twitter.com/pinohanakotori/status/1766278487231644153?ref_src=twsrc%5Etfw">March 9, 2024</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script><h2 id=雑談会のキャンセル>雑談会のキャンセル</h2><p>毎年行っているある大学の先生との雑談会を13日に予定していた。大阪のバーで飲むイベントだったのだけど、家族全員がコロナにかかってしまったという話しで周りへの感染予防のためには飲みに行くわけにはいかないという連絡がきた。それでお店の予約をキャンセルした。早めに連絡をいただいたのでキャンセル料を支払う必要はなかった。感謝。私も開発合宿と出張の移動疲れで疲労困憊になっているのでこれはこれでよかったのかもしれないと思えた。</p><h2 id=ordered-map-の開発の続き>ordered map の開発の続き</h2><blockquote><p>複雑なデータ構造のときに map (json で言えばオブジェクト) のキーの順序を保持できないことにもテストを書いていて気付いた。そこの部分も作り直さないといけないとデバッグしたり設計をやり直したりしていた。</p><p><a href=/diary/posts/2024/0308/#ordered-map-の開発>昨日の続き</a></p></blockquote><p>json を自前でパースしないといけないという判断を下し、json パーサーを探してみて <a href=https://github.com/iOliverNguyen/ujson>ujson</a> というパーサーを使ってみることにした。今日は ujson を使った json のデシリアライズの処理を設計したり実装したりして試行錯誤していた。こういうシンプルなライブラリは私のやりたいことを邪魔しないので好み。</p><h2 id=ストレッチ>ストレッチ</h2><p>本当は午前中に明石海峡大橋海上ウォークへ行くつもりだったからストレッチは夜の時間帯に変更していた。先週は開発合宿でお休みしたので2週間ぶり。散歩する機会が多くなったせいか、右足の太ももが筋肉痛であることは自覚症状があった。今日の開脚幅は開始前150cmで、ストレッチ後155cmだった。トレーナーさんのストレッチを受けて、足は左右とも前も後ろもあちこち痛かった。トレーナーさんからもあちこち張りがあるという指摘があった。運動の成果というのか、散歩をたくさんするようになって足に負荷がかかっているのは間違いないようだ。こういうときこそプールを使うべきなんだけど、なぜか夜に予定が入りまくっていてなかなかスケジュール調整ができない。土曜日が一番時間の調整しやすいのにプールの制約によって利用できない。カラダが疲労していると脂肪燃焼の効率が悪くない。カラダを休めるのも必要なことかもしれない。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0308/>ordered map 開発のきっかけ</a></h1><div class=post-meta><time class=post-date>2024-03-08</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;
#<a href=/diary/tags/debug/>debug</a>&nbsp;</span><div class=post-content><p>0時に寝て6時半に起きた。神戸に戻ってきてようやく落ち着けた。</p><p>今日の運動はスクワットをした。統計を <a href="https://docs.google.com/spreadsheets/d/1bg85QtM-LciUgey8I79uI7vW2PEwsP6TVdeIRVkACBg/edit?usp=sharing">運動の記録</a> にまとめる。</p><h2 id=ordered-map-の開発>ordered map の開発</h2><p>金曜日は打ち合わせが何もない曜日の1つ。疲労困憊で神戸に戻ってきたので今日はずっとコーディングに集中していた。本当はお仕事終えてからプールへ行こうと思っていたものの、逆にコードを書くのに集中し過ぎて晩ご飯に一旦帰って食べた後も、もう一度オフィスに来て、さらに1時ぐらいまでコードを書いてた。</p><p>go の map をイテレートすると意図的にランダムに key-value を返す仕様になっている。これは開発者がキーの順序に依存した実装をしてしまって潜在的バグを混入させてしまう懸念を取り除くため。その設計思想は理解できるものの、go の map を json で返すときに ux の視点からキーの順序を保証したい場面がある。そんなときに ordered map のようなものが必要になる。go のコード内で ordered map を実装しているライブラリはいくつかあるものの、json のシリアライズ／デシリアライズも考慮してキーの順序を保証するライブラリはあまりみつけられなかった。それを考慮しているライブラリの1つに <a href=https://github.com/ake-persson/mapslice-json>mapslice-json</a> がある。しかし、このライブラリの実装はイケてなくて致命的なバグを1つみつけて PR を送ったものの、おそらく3年ぐらい保守されていない。あとジェネリクスを使うと使い勝手がよくなるからコードを書き換えたい。</p><ul><li><a href=https://github.com/ake-persson/mapslice-json/pull/5>fix DATA RACE when it calls nextIndex() #5</a></li></ul><p>結局このライブラリからアイディアだけもらって自分で再実装することにした。そして、array や map が入れ子になるような、複雑なデータ構造のときに map (json で言えばオブジェクト) のキーの順序を保持できないことにもテストを書いていて気付いた。そこの部分も作り直さないといけないとデバッグしたり設計をやり直したりしていた。これは会社の oss ライブラリとして作ってもよいかもしれない。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0212/>ホットクックのレシピを upnote で書く</a></h1><div class=post-meta><time class=post-date>2024-02-12</time></div><span class=post-tags>#<a href=/diary/tags/founding/>founding</a>&nbsp;
#<a href=/diary/tags/recipe/>recipe</a>&nbsp;
#<a href=/diary/tags/health/>health</a>&nbsp;
#<a href=/diary/tags/upnote/>upnote</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/ldap/>ldap</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;</span><div class=post-content><p>2時半に寝て５時過ぎに起きた。それから二度寝して7時に起きた。</p><p>今日の運動はレッグレイズ(椅子),腹筋ローラー,腕立て,散歩をした。統計を <a href="https://docs.google.com/spreadsheets/d/1bg85QtM-LciUgey8I79uI7vW2PEwsP6TVdeIRVkACBg/edit?usp=sharing">運動の記録</a> にまとめる。</p><h2 id=トランクルームの契約>トランクルームの契約</h2><p>家電を購入すると大きな箱が付いてきて物理的にその置き場所がない。箱を捨てるという戦略もあるが、オリジナルの箱があると引っ越しや売買／処分するときに便利なのでできれば残しておきたい。これまでデスクトップマシンの箱やオフィス備え付けの椅子などをマンションの部屋に保管したりしていたけど、家電の箱が増えてくると邪魔になってきて、トランクルームを借りることにした。面倒なのであまり調べていないが、<a href=https://spalab-chintai.uk-corp.co.jp/>スペラボ</a> というサービスの屋内型トランクルームをレンタルすることにした。0.7畳で6,450円/月(税込)になる。会社の経費だしこのぐらいの金額ならいいかと思って、朝から内見に行って問題なさそうなので即決した。</p><h2 id=ホットクックレシピの公開>ホットクックレシピの公開</h2><p>ホットクックのレシピをどこかに整理したい。スマホ上でも調理しながら簡単に確認したいとなると web よりもアプリの方がよい。そこで <a href=/diary/posts/2024/0108/#upnote-への移行>evernote から移行した upnote</a> に書くことにした。実際に調理してみて、デスクトップマシンでレシピを編集・整理して、写真はスマホアプリからアップロードするといった使い方ができる。<a href=https://help.getupnote.com/import-export-share-and-print/share-notes-via-web-link#view-shared-notes>View shared notes</a> によると、ノート単位で web 公開もできる。試しに次のレシピを公開してみた。ノートブック単位で公開設定して一覧ページがあるともっとよいが、その機能はないみたい。公開リンクを作成する一手間はあるけれど、そんなにレシピノートを書くわけでもないから気にはならない。</p><ul><li><a href=https://getupnote.com/share/notes/3ztcTpBat7RA2IpEjuoFzq1JKMf2/49d1c703-60b0-4a27-b379-0b9da98c4a8f>野菜スープ</a></li><li><a href=https://getupnote.com/share/notes/3ztcTpBat7RA2IpEjuoFzq1JKMf2/8b321682-006e-4408-ae03-2aaf112a76cc>玄米ごはん</a></li><li><a href=https://getupnote.com/share/notes/3ztcTpBat7RA2IpEjuoFzq1JKMf2/96b9c543-a134-4773-8b1e-25cd2969f2f6>豚肉のトマト煮こみ</a></li></ul><p>ホットクック調理は材料入れてボタン押したら終わりではないか？と思うかもしれない。いや、そうでもないようだ。たしかに材料を内鍋に入れてボタン押したら人間ができることは何もない。だからこそ、ボタンを押す前の過程が大事になってくる。どんな切り方をするのか、素材のサイズはどうか、初期配置はどうか。例えば、豚ロース肉の生姜焼き用を買ってきて、適当に切って3枚4枚重なった状態で投入したらそのままの状態で出来上がった。かき混ぜ棒があるからうまいこと豚肉もバラけるだろうと期待したが、ぴったりくっついているようなお肉をバラかすほどのパワーはないようだ。人間が最初からバラかした状態で内鍋に投入すると、出来上がりのときに豚肉のかたまりがなくなってよいと思う。</p><p>あと気付いたこととして、野菜もお肉も素材を少し小さめに切った方がおいしいように感じる。というのは、ホットクックは圧力鍋ほどの火力で調理しない。圧力鍋に慣れていると、少し大きめに切っても原形がなくなって溶けてしまったり、出来上がり時点で原形があっても混ぜたりしているうちに角がとれて、どんどん小さくなっていく。小さくならなくても口の中でとろけるので大きいままでも問題ない。相対的にホットクックはそこまでの火力はないから、小さめで味が染み込むような出来上がりになるため、小さめに切っても原形は保ったままで溶けてなくなってしまうことはない。これは良い悪いではなくて、それぞれの製品の特徴と言えるだろう。ホットクック調理は素材を小さめに切るというのが、いまところ、私が作ったレシピではうまくいっている。ホットクックでは、小さく切った複数の素材をほお張って食べるのがおいしい。</p><h2 id=go-ldap-への-context-導入の考察>go-ldap への context 導入の考察</h2><p>go-ldap の issue は subscribe しているので、たまたま <a href=https://github.com/go-ldap/ldap/pull/406#issuecomment-1930953422>initial cut of context support #406</a> の draft pr のコメントに気付いた。過去に context を導入しようとして途中で断念した残骸みたいな pr になっている。いまの go の api は context を受け取るのが当たり前になっているので確かにほしいというのは理解できる。</p><p>代わりに私がやってみようかとソースコードを読んでみた。オリジナルの draft pr は client の interface に <em>WithContext</em> なメソッドを追加しようというもの。go の context の扱いとしてもっとも基本的なもの。それでもよいけれど、net/http の実装はどうなっているのかを調べていたら <a href=https://pkg.go.dev/net/http@go1.22.0#Request>Request</a> 構造体のメンバーとして context を保持していることがわかった。このやり方は原則のルールに反するものだけど、context を状態として扱わず、限定的な用途にのみ使っている。これは既存の interface を変えずに context 導入をしようという意図があると推測する。この考え方でいくと、go-ldap の Request 構造体に context を保持するように変更する方が既存の API の変更を少なくして net/http の Request も同様にやっているからと説明もしやすいように思えた。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Request</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ctx is either the client or server context. It should only
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// be modified via copying the whole Request using Clone or WithContext.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// It is unexported to prevent people from using Context wrong
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// and mutating the contexts held by callers of the same request.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>今日のところは go-ldap と net/http のソースコードを読んで設計をしていた。また明日余裕があったらサンプル実装してみる。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0131/>rfc に書いてある仕様の矛盾</a></h1><div class=post-meta><time class=post-date>2024-01-31</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/scim/>scim</a>&nbsp;
#<a href=/diary/tags/exercise/>exercise</a>&nbsp;</span><div class=post-content><p>昨日は21時前に神戸に戻ってきて、オフィスへ行く元気もなくて、そのまま寝てた。0時頃に起きて2-3時ぐらいまでだらだらしていてまた寝て7時半に起きた。</p><p>今日の筋トレはレッグレイズ(椅子):20x2,腹筋ローラー:5x1,スクワット:20x1,縄跳び(両足跳:50x3)をした。縄跳びの疲労で日常生活で痛くなったことのない膝の後ろの、なんと呼ぶのかすらわからない筋が痛い。いまは両足跳以外の負荷のかかる跳び方はできない。</p><h2 id=scim-パーサー周りの改善>scim パーサー周りの改善</h2><p>先日 <a href=/diary/posts/2024/0129/#scim-パーサーの実装>実装した scim パーサー</a> を使って scim プロトコルによる id 連携の内部処理をリファクタリングした。たまたま <a href=https://datatracker.ietf.org/doc/html/rfc7643>rfc7643</a> を読んでいたら go-urn の実装で食い違っているところがあって pr を送ってみた。</p><ul><li><a href=https://github.com/leodido/go-urn/pull/43>Remove param from SCIM types #43</a></li></ul><p>作者から教えてもらって、食い違っているのは rfc7643 の方で相反する内容が書いてある。これはこの rfc を作成した scim WG とやらにメールしてこの仕様はどちらが正なの？と聞いて訂正してもらえばいいんやろか？</p><h2 id=加圧シャツ>加圧シャツ</h2><p>トレーニングが楽しくなってきてその効率を上げようと思って加圧シャツも買ってみた。伸縮する着圧のあるシャツで体を締め付けることで血流が悪くなる。血流が悪くなると、筋繊維 (脳？) は疲労を感じやすくなり、それでより強く太い筋繊維を生成しようとする。要は脳を騙すみたいなアイテムだという。1日着ていたが、とくにお仕事や身体の動作に支障はない。上半身が締め付けられることで背筋が伸びるような気もする。よい意味で緊張感をもつことができているように思う。しばらく使ってみる。</p><p><a href=https://amzn.to/49cW8me target=_blank><img src=https://m.media-amazon.com/images/I/51V2zdpwOSL._AC_SX679_.jpg width=240></a></p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0129/>野菜スープ改</a></h1><div class=post-meta><time class=post-date>2024-01-29</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;
#<a href=/diary/tags/blog/>blog</a>&nbsp;
#<a href=/diary/tags/health/>health</a>&nbsp;
#<a href=/diary/tags/recipe/>recipe</a>&nbsp;</span><div class=post-content><p>2時前に寝て6時半に起きた。たぶん夜中には起きていない。夜は野菜スープしか食べてないから安眠できたのかもしれない。</p><p>今日の筋トレはレッグレイズ(椅子):20x1,スクワット:20x1,縄跳び(両足跳:50x2,駆け足跳び:10x3)をした。今日もお昼休みに公園へ行って縄跳びした。昨日縄跳びしたせいだと思うが跳ぶと膝の後ろの筋が痛い。普段やらないことしたら変なところの筋肉が痛くなる。</p><h2 id=scim-パーサーの実装>scim パーサーの実装</h2><p>半年ほど前に <a href=/diary/posts/2023/0723/#scim-向けの-urn-パーサーの拡張>scim 向け urn パーサーの提案</a> を PR で送っていた。これまでその PR は放置されていた。数日前からライブラリの作者が PR をみてくれたようだ。私が送った PR 自体は作者の意図したものではなかったようでクローズされたが、作者が scim の仕様を把握して代わりに作ってくれた。パーサーの実装が automaton? のようになっていてパッと見ではロジックがよくわからない。</p><ul><li><a href=https://github.com/leodido/go-urn/pull/37>feat: support SCIM (RFC 7643) #37</a></li></ul><p>せっかく作ってくれたのでこの機能を使って、お手伝いしている会社のアプリケーションの scim urn のパース処理を書き直した。これまでは正規表現で実装されていた。rfc に準拠した <a href=https://github.com/leodido/go-urn>go-urn</a> を使うことでバリデーションもできるし、パフォーマンスもよいし、urn の部分文字列も参照できる。ライブラリの学習コストや依存ライブラリを増やすデメリット以外はとくに問題はない。</p><h2 id=テックブログを読む会談義>テックブログを読む会談義</h2><p><a href=https://blogreading.connpass.com/event/308512/>テックブログ一気読み選手権20240129杯</a> に参加した。イベントが終わってから軽くにしはらさんに <a href=/diary/posts/2024/0125/#社内版テックブログを読む会をやってみた>お手伝い先で社内イベント</a> を始めたことを情報共有した。にしはらさんが知る限り、このイベントを他社でもやり始めたというのは初めてのことらしい。とても洗練されたよいイベントなのに社内でもその価値を理解できる人たちは少ないという。前にも書いたけど、まさにこれだと思う。</p><blockquote><p>恐ろしく速い手刀。オレでなきゃ見逃しちゃうね</p></blockquote><p>お手伝い先ではまだ始まったばかり。1回目はそれなりにうまくいったつもり。毎週30分を4週やってみてメンバーに感想を聞いてみる。そして継続しようと決まったらまたブログにでもそのことを書こうと思う。</p><h2 id=野菜スープのレシピ改>野菜スープのレシピ改</h2><p><a href=/diary/posts/2024/0128/#野菜スープのレシピ>昨日初めて作った野菜スープ</a> はいくつか気付きがあったので再挑戦。</p><p>メニューから「野菜スープ」を選択すると最初から画面に約25分と表示されて急加熱しているようにみえる。残り20分ぐらいのところからスマホのタイマーと一緒に比較しながら画面の時間がどう遷移するのかを観察していた。すると、スマホのタイマーと比べてホットクックの時間経過は遅くなっていった。残り13分の状態がもっとも長かった。残り7分のところでスマホのタイマーは20分経過した。残り7分で画面上に残り時間が大きく表示される。この後の時間の推移はスマホのタイマーとだいたい同じぐらいだったので信頼できる残り時間のようにみえる。したがって、ホットクックの調理をスタートした時点での、残り時間表記は目安であってまったく信頼できない。この野菜スープの調理時間は約25分とあるけど、今日作った分量とレシピでは約40分ほどかかっていた。ホットクックは内鍋を加熱して予熱したり、水があれば沸騰させたりする時間が必要らしい。その予熱時間が10分強はかかるとみておくとよさそう。</p><p>圧力鍋と比べるとホットクックの方が調理時間そのものは大きいというのは概ね正しいとは思う。しかし、ホットクックは基本的にスタートボタンを押下したら他にやることないので放ったらかしにする感覚でよいと思う。圧力鍋は圧力がかかったら火加減を調整したり圧力を下げて蓋を開けたらかきまぜしたりしないといけない。その「かきまぜ」の手間暇がホットクックはないのだから多少調理時間がかかっても全体としては気にならないと思う。</p><p>昨日のオリジナルを改変したレシピをさらに改変して今日のレシピはこれ。</p><ul><li>にんじん x 1</li><li>新玉ねぎ x 1</li><li>かぼちゃ 1/4切れ</li><li>ミディアムトマト x 8</li><li>セロリ x 1 の葉っぱ部分</li><li>しめじ 1袋</li><li>えのき 1袋</li><li>ローリエ 1枚</li><li>塩コショウ 適当</li><li>コンソメ (小さじ4杯)</li><li>水 600cc</li></ul><figure><img src=/diary/img/2024/0129_vegisoup.jpg></figure><p>にんじんは乱切りをやめて 1cm 程度の正方形に切る。かぼちゃもにんじん同様、1-2cm の正方形に切る。セロリの茎の部分は使うのをやめて、葉っぱが付いている部分を適当なサイズに切って入れる。野菜を小さくしたことで、いろいろな食材を一緒に口に運べるようになって、にんじんやかぼちゃだけ頬張るのではなく、複数の素材の味を一緒に楽しめるようになった。そうすると、えのきは石づきを切り離してそのままの長さで入れていたが、他の野菜と一緒に食べやすくしようと思ったらもう半分ぐらいに切り落として短くした方がよいのではないかと思えた。あとスープも少なかったので昨日よりも水を 200cc 増やした。</p><p>昨日作ったものは薄味の、なにかひと味足りないというところに、コンソメはうまくはまった。レシピに入れろと書いてあるものを勝手に抜くのよくない。足りなかった旨味が揃ったことで他の食材とのバランスも断然によくなった。セロリを減らしたことでセロリの癖も弱くなってちょうどよくなったと思う。昨日と比べて、お料理ベーコンを買い忘れてなしで作ったが、あってもなくてもそんな変わらない気がする。コンソメにより肉エキスも入ったことで鶏もも肉をちょっと入れてみてもよいような気がした。お肉的なたんぱく質のアクセントがあってもよいんじゃないかと思えた。次に作るときに試してみる。</p><p>昨日作ったものよりもおいしくなって料理としての完成度は増したように思う。野菜スープと一緒におにぎりを2個食べた。100 kcal + (200 kcal * 2) = 500 kcal ぐらいかな。晩ご飯のカロリーとしてちょうどよい。</p><p>仮に調理の味付けを失敗したときでもなにかふりかけのようにかけて味変できるものがあるとよいと思う。昨日のコンソメ抜きの野菜スープも鰹節をふりかけたらおいしくなった。フレークタイプのカレーで市販のカレールウに比べて油脂分が少ないらしい。こういうのも容易しておくと失敗したときに誤魔化せるかもしれない。</p><ul><li><a href=https://tokubai.co.jp/news/articles/5910>リピ決定【成城石井】「大人気無添加カレー」フレーク状でサーッと溶けて洗い物もラク</a></li></ul></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0119/>年明けからコーポレート業務いろいろ</a></h1><div class=post-meta><time class=post-date>2024-01-19</time></div><span class=post-tags>#<a href=/diary/tags/founding/>founding</a>&nbsp;
#<a href=/diary/tags/tax/>tax</a>&nbsp;
#<a href=/diary/tags/finance/>finance</a>&nbsp;
#<a href=/diary/tags/coworking/>coworking</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/debug/>debug</a>&nbsp;
#<a href=/diary/tags/network/>network</a>&nbsp;</span><div class=post-content><p>23時に寝て4時半頃に起きてそのまま6時半までだらだらして起きた。早寝早起き。</p><p>今日の筋トレは腹筋:20x1,腕立て:15x1,スクワット20x1をした。</p><h2 id=隔週の雑談>隔週の雑談</h2><p>顧問のはらさんと隔週の打ち合わせ。今日の議題はこれら。内容が多くて1時間超えた。</p><ul><li><a href=/diary/posts/2024/0105/#事務処理規定の叩き台作成>電子帳簿保存法対応の事務処理規定の共有</a><ul><li>まだ始まったばかりで税理士さんの温度感も低い</li><li>事務処理規定が省令に沿っているかどうかの判断はプロセス監査で行われる</li><li>電子帳簿保存法には規定されていないため、事務処理規定の妥当性の検証は行われない</li></ul></li><li><a href=/diary/posts/2024/0107/#経営の価値観と財務>融資を受ける構想作り</a><ul><li>日本政策金融公庫のみで検討していたが、融資実績を作りたいなら信用金庫も加えた方がよい</li><li>借金のメンタリティ、担当者との折衝や審査など余裕のあるときに経験を積んでおくことはよいように思えた</li></ul></li><li><a href=/diary/posts/2024/0113/#ファイナンシャルプランナーとの打ち合わせ>ファイナンシャルプランナーさんとのやり取り</a><ul><li>会社の経費で役員のための保険に入ろうと考えている</li><li>個人の保険控除は8万円らしい</li></ul></li><li><a href=https://note.com/kanzan10to9/n/n49d8fe09ad5b>ローカル複業化プロジェクトの考察</a><ul><li>IT コミュニティに老人や子どもたちは入りにくい。農業なら老若男女誰でも入れる気がする</li><li>農業や地元の特産品を切り口にコワーキング (コミュニティ) で街の人たちと田舎の人たちをつなげるのはすごいことだと思う (関係人口の創出)</li><li>地元の有力者と仲良くなると、行政の口利きもしてくれて活動しやすくなる</li></ul></li></ul><p>はらさんが <a href=https://yorihiroi-frontend.engineer/ja>よりひろいフロントエンド</a> を始めたそうでその話しも聞いていた。個人のブログサイトにするのか、複数人で記事を共有するサイトにするのかもまだ曖昧だという。<a href=https://www.contentful.com/>Contentful</a> + Next.js + Cloudflare Pages という構成らしい。Contentful というツールを私が知らなかったのでまた時間のあるときに調べてみようと思う。</p><p>母が一人暮らしをしていて体調もよくないことから要介護状態になるリスクがそこそこあると考えている。最悪の場合、会社を休眠させてしばらく介護をするかもしれない。はらさんが仰るには休眠はよいアイディアだという。会社員に例えると退職した日の帰り道を想像するとよいと話されていたのだけど、私は過去の記憶があまりないというのもあるが、これまで6回も退職してきたのに退職日を特別に思ったことはあまりない。退職日と他の日に大きな違いはなくて、次のお仕事の準備や調査をしていることが私は多かったと思う。それでも退職にあわせて有休を1-2ヶ月とってゆっくり過ごしていたことには変わりない。私もそういう、メリハリのある働き方が好きだ。</p><h2 id=smtp-接続のタイムアウト>smtp 接続のタイムアウト</h2><p>たまたまメンバーが誤った設定で smtp サーバーに接続したときにタイムアウトするまで5分ほどかかるという現象を発見した。タイムアウトの設定をせずに接続しようとするからそんなことが起きるのかな？と考えて smtp クライアントのタイムアウト設定を調べてみると <a href=https://pkg.go.dev/net#DialTimeout>net.DialTimeout</a> を使えばよいという。</p><ul><li><a href=https://github.com/golang/go/issues/16436#issuecomment-233829112>https://github.com/golang/go/issues/16436#issuecomment-233829112</a></li></ul><p>多めに見積もって30秒のタイムアウトを設定して接続するようにして再度メンバーに再現検証してもらったら直っていないという。接続そのものは出来ていたのだ。ソースを読んでみると、smtp クライアントを生成するときに <code>220</code> というレスポンスを読むことがわかる。誤った接続設定でもコネクションは確立するが、レスポンスが返ってこなくて待ち状態になっていた。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewClient</span>(<span style=color:#a6e22e>conn</span> <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>Conn</span>, <span style=color:#a6e22e>host</span> <span style=color:#66d9ef>string</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>Client</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>text</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>textproto</span>.<span style=color:#a6e22e>NewConn</span>(<span style=color:#a6e22e>conn</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>text</span>.<span style=color:#a6e22e>ReadResponse</span>(<span style=color:#ae81ff>220</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>text</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>c</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>Client</span>{<span style=color:#a6e22e>Text</span>: <span style=color:#a6e22e>text</span>, <span style=color:#a6e22e>conn</span>: <span style=color:#a6e22e>conn</span>, <span style=color:#a6e22e>serverName</span>: <span style=color:#a6e22e>host</span>, <span style=color:#a6e22e>localName</span>: <span style=color:#e6db74>&#34;localhost&#34;</span>}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>tls</span> = <span style=color:#a6e22e>conn</span>.(<span style=color:#f92672>*</span><span style=color:#a6e22e>tls</span>.<span style=color:#a6e22e>Conn</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>c</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>調べてみると Conn インターフェースにデッドラインを設定する API が提供されている。注意事項としては接続した後にデッドラインをリセットしないといけない。</p><blockquote><p>デッドラインとは、I/O操作がブロックされずに失敗する絶対時間のことである。デッドラインは、ReadやWriteを呼び出した直後のI/Oだけでなく、将来の保留中の I/O すべてに適用される。デッドラインを超過した後は、未来にデッドラインを設定することで、接続をリフレッシュすることができる。</p><p>デッドラインを超えた場合、ReadやWrite、その他のI/Oメソッドの呼び出しは、os.ErrDeadlineExceeded をラップしたエラーを返します。これは、errors.Is(err, os.ErrDeadlineExceeded)を使用してテストすることができます。errorのTimeoutメソッドはtrueを返しますが、期限を超過していなくてもTimeoutメソッドがtrueを返すエラーが他にもあることに注意してください。</p><p>アイドルタイムアウトは、ReadまたはWrite呼び出しに成功した後、デッドラインを繰り返し延長することで実装できる。tの値が0であれば、I/O操作はタイムアウトしない。</p><p><a href=https://pkg.go.dev/net#Conn>https://pkg.go.dev/net#Conn</a></p></blockquote><p>次のように <code>SetReadDeadline()</code> を使ってタイムアウトを5分から30秒に短縮できた。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Clinet</span>) <span style=color:#a6e22e>connectWithReadDeadline</span>(<span style=color:#a6e22e>conn</span> <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>Conn</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>smtp</span>.<span style=color:#a6e22e>Client</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>SetReadDeadline</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>().<span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>dialTimeout</span>)); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to set read deadline: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>smtp</span>.<span style=color:#a6e22e>NewClient</span>(<span style=color:#a6e22e>conn</span>, <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>Host</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to connect to the smtp server: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// clear read deadline
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>SetReadDeadline</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>{}); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to reset read deadline: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>c</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0112/>RWMutex の試用</a></h1><div class=post-meta><time class=post-date>2024-01-12</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;
#<a href=/diary/tags/kobe/>kobe</a>&nbsp;</span><div class=post-content><p>0時に寝て3時半に起きてネットみたてたら6時半になってそれから寝て7時半に起きた。やっぱり生活のリズムがおかしい。</p><p>今日の筋トレは腹筋:20x1,腕立て:10x1,スクワット10x1をした。あと1kmほど散歩した。</p><h2 id=go-の-rwmutex-を使う>go の RWMutex を使う</h2><p>テストツールでちょっとしたプールを実装していて mutex を使うコードを書いた。書き込みはロックしないといけないけど、読み込みはロックする必要がないようなものは <a href=https://pkg.go.dev/sync#RWMutex>RWMutex</a> を使うと普通の Mutex よりは読み込みが並行に動くので効率がよくなる。実際に RWMutex を使ってコードを書いたことがなかったので試しに書いて単体テストを実行して振る舞いを確認してみた。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>pool</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>l</span>  []<span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>m</span>  <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>struct</span>{}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mu</span> <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>RWMutex</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>pool</span>) <span style=color:#a6e22e>exists</span>(<span style=color:#a6e22e>dn</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ldap</span>.<span style=color:#a6e22e>DN</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>RLock</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>RUnlock</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>m</span>[<span style=color:#a6e22e>dn</span>.<span style=color:#a6e22e>String</span>()]
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ok</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>pool</span>) <span style=color:#a6e22e>get</span>() <span style=color:#f92672>*</span><span style=color:#a6e22e>ldap</span>.<span style=color:#a6e22e>DN</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>RLock</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>RUnlock</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>length</span> <span style=color:#f92672>:=</span> len(<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>l</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>length</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>l</span>[<span style=color:#a6e22e>rand</span>.<span style=color:#a6e22e>Intn</span>(<span style=color:#a6e22e>length</span>)]
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>mustParseDN</span>(<span style=color:#a6e22e>s</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>pool</span>) <span style=color:#a6e22e>put</span>(<span style=color:#a6e22e>dn</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ldap</span>.<span style=color:#a6e22e>DN</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>dn</span>.<span style=color:#a6e22e>String</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>l</span> = append(<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>l</span>, <span style=color:#a6e22e>s</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>m</span>[<span style=color:#a6e22e>s</span>] = <span style=color:#66d9ef>struct</span>{}{}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=4年ぶりの神戸ルミナリエ>4年ぶりの神戸ルミナリエ</h2><p>たまたま <a href=https://www.feel-kobe.jp/kobe_luminarie/>第29回 神戸ルミナリエ</a> が1月の19日から28日にかけて行われるという記事をみかけた。そう言えば、いつも12月に開催されていたのが今回から1月に変わったみたい。毎年今回が最後みたいな含みをもたせて、なんやらかんやらでもう29回も続いているんやね。今回が第29回だからおそらく来年に第30回もやるのでしょう。「4年ぶりの開催が決定」と書いてあって、あれ？やってなかったっけ？と思ったらコロナ禍のために2020-2023年まで中止という意思決定はされていて、代替イベントとして小さいルミナリエっぽいイルミネーションをやっていたらしい。ルミナリエの展示場となる東遊園地がうちの近所なのでこれまでもやっていたような記憶があるのはそのせいかもしれない。今年は規模を拡張してやるのかな？久しぶりなので時間があるときに観に行ってみようと思う。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1225/>RemoteAddr はほとんど役に立たない</a></h1><div class=post-meta><time class=post-date>2023-12-25</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;
#<a href=/diary/tags/security/>security</a>&nbsp;</span><div class=post-content><p>0時に寝て何度か起きて7時に起きた。寒くて朝起きれなくなってきた。</p><h2 id=ローカルネットワークからのリクエストのみを受け付けるミドルウェア>ローカルネットワークからのリクエストのみを受け付けるミドルウェア</h2><p><a href=https://pkg.go.dev/net/http#Request>Request</a> 構造体の中にある <code>RemoteAddr</code> を参照すればすぐできるだろ思って、すぐにできた。すぐにできたんだけど、これは実際の運用で使えるものではない。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>LocalNetworkConfig</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Skipper</span> <span style=color:#a6e22e>middleware</span>.<span style=color:#a6e22e>Skipper</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>localNetworkWithConfig</span>(<span style=color:#a6e22e>cfg</span> <span style=color:#a6e22e>LocalNetworkConfig</span>) <span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>MiddlewareFunc</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>next</span> <span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>HandlerFunc</span>) <span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>HandlerFunc</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>c</span> <span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>cfg</span>.<span style=color:#a6e22e>Skipper</span>(<span style=color:#a6e22e>c</span>) {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>next</span>(<span style=color:#a6e22e>c</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>req</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Request</span>()
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>addr</span>, <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>SplitHostPort</span>(<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>RemoteAddr</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>slog</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#e6db74>&#34;failed to get remote address&#34;</span>,
</span></span><span style=display:flex><span>					<span style=color:#e6db74>&#34;err&#34;</span>, <span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;addr&#34;</span>, <span style=color:#a6e22e>addr</span>)
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>ErrForbidden</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>ip</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>ParseIP</span>(<span style=color:#a6e22e>addr</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ip</span>.<span style=color:#a6e22e>IsPrivate</span>() <span style=color:#f92672>||</span> <span style=color:#a6e22e>ip</span>.<span style=color:#a6e22e>IsLoopback</span>() {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>next</span>(<span style=color:#a6e22e>c</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>slog</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#e6db74>&#34;requested from an external network&#34;</span>, <span style=color:#e6db74>&#34;ip&#34;</span>, <span style=color:#a6e22e>ip</span>.<span style=color:#a6e22e>String</span>())
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>ErrForbidden</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewLocalNetwork</span>() <span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>MiddlewareFunc</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>localNetworkWithConfig</span>(<span style=color:#a6e22e>LocalNetworkConfig</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Skipper</span>: <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>c</span> <span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#66d9ef>bool</span> { <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span> },
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>過去にも同じようなことをやらかしたような既視感がある。</p><blockquote><p>golangのnet.Request構造体内にはRemoteAddr属性があり、当然のことながら要求元のリモートアドレスが含まれています。これで仕事は終わりですね？しかし、リバースプロキシやロードバランサーをアプリケーションに使っている場合はそうではありません。これはgoサーバには常に、すべてのリクエストがロードバランサから来ているかのように見えます。これは、これを何らかのスロットリングの指標として使いたいのであれば、最悪なことです。ですから、何らかの形のリバースプロキシの後ろでなく、goサーバーが1つだけ動いているのでない限り、私たちの目的には役に立たないとして、すぐにこれを捨てることができます。</p><p><a href=https://husobee.github.io/golang/ip-address/2015/12/17/remote-ip-go.html>https://husobee.github.io/golang/ip-address/2015/12/17/remote-ip-go.html</a></p></blockquote><p>途中のロードバランサーやアプリケーションゲートウェイ、リバースプロキシなど、中継するサーバーの ip アドレスに置き換わってしまうため、ネットワークのインフラを管理していないとどこからリクエストされたかを追跡することはできない。<code>X-Real-IP</code> や <code>X-Forwarded-For</code> という http ヘッダーに中継したサーバーの ip アドレスを記録するという慣習があるようだけど、これはクライアント側で書き換えできるのでこれ単体でアクセス制御のようなものに使うことはできない。</p><p>次に同じ失敗をしないようにここに書いておく。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1213/>mongodb のサードパーティのコンテナイメージ</a></h1><div class=post-meta><time class=post-date>2023-12-13</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;
#<a href=/diary/tags/mongodb/>mongodb</a>&nbsp;
#<a href=/diary/tags/infrastructure/>infrastructure</a>&nbsp;
#<a href=/diary/tags/container/>container</a>&nbsp;</span><div class=post-content><p>23時に寝て3時に起きて寝たかどうか覚えていないうちに6時半になっていて7時半に起きた。</p><h2 id=json-を介した-go-の-bool-値のバリエーション>json を介した go の bool 値のバリエーション</h2><p><a href=https://github.com/go-playground/validator>go-playground/validator</a> のバリデータには <a href=https://pkg.go.dev/github.com/go-playground/validator/v10#hdr-Required>required</a> というバリデーションオプションがある。しかし、このオプションは go のゼロ値でないことをチェックするという仕様になっている。bool のゼロ値は false となるため、リクエストした JSON データに false を設定していたのか、未設定だったのかの違いを検出できない。これはバリデータの問題ではなく、go の json ライブラリの制約のようなもので使い勝手のよい仕様とは言えない。私もこの振る舞いに起因する不具合に遭遇したこともあるし、こういうときにどうしたらよいかも過去に3回ぐらいは調べている気がする。</p><ul><li><a href=https://github.com/go-playground/validator/issues/142>How to validate bool #142</a></li></ul><p>現時点での私の最適化は次のコードになる。データ構造として <code>*bool</code> 型にすれば、ポインタ型のゼロ値は nil となるため、true, false, nil の3値でバリデーションできる。しかし、私はこのデータ構造を好ましく思わない。というのは、内部的には true/false の2値でしか管理しないメンバーを、json のバリデーションのためだけに nil も許容する3値にすることがよい設計だと私は思えない。そこでバリデータによるバリデーションは諦めて、json の Unmarshal 処理をフックしてバリデーション相当の処理を自分で実装する。このやり方のデメリットはメンバーが追加されたときに自分で UnmarshalJSON() メソッドを保守する必要がある点になる。しかし、メリットとして内部のデータ構造の型は <code>bool</code> 型で扱える。一概にどちらがよいとは言いにくいかもしれないし、設計上の好みかもしれない。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>reqMyData</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Name</span>       <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;name&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>View</span>       <span style=color:#f92672>*</span><span style=color:#66d9ef>bool</span>  <span style=color:#e6db74>`json:&#34;view&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>MyData</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Name</span>       <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;name&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>View</span>       <span style=color:#66d9ef>bool</span>   <span style=color:#e6db74>`json:&#34;view&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>d</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>MyData</span>) <span style=color:#a6e22e>UnmarshalJSON</span>(<span style=color:#a6e22e>data</span> []<span style=color:#66d9ef>byte</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>tmp</span> <span style=color:#a6e22e>reqMyData</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Unmarshal</span>(<span style=color:#a6e22e>data</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>tmp</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to unmarshal as reqMyData&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>tmp</span>.<span style=color:#a6e22e>View</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;required view field&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Name</span> = <span style=color:#a6e22e>tmp</span>.<span style=color:#a6e22e>Name</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>View</span> = <span style=color:#f92672>*</span><span style=color:#a6e22e>tmp</span>.<span style=color:#a6e22e>View</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=サードパーティの-mongodb-コンテナイメージ>サードパーティの mongodb コンテナイメージ</h2><p>先日の <a href=/diary/posts/2023/1211/>mongodb のレプリカセット調査</a> の続き。コードレビューをしていて <a href=https://hub.docker.com/r/bitnami/mongodb>bitnami/mongodb</a> というサードパーティのコンテナイメージを使った方がよいのではないか？というコメントがあったのでその調査をしてみた。VMware 社が提供しているサードパーティのコンテナイメージらしい。</p><blockquote><p>MongoDB(R) is run and maintained by MongoDB, which is a completely separate project from Bitnami.</p></blockquote><p>まず MongoDB プロジェクトとはまったく別管理であることが書いてある。</p><blockquote><p>Bitnami イメージを使用する理由</p><ul><li>Bitnamiはアップストリームソースの変更を綿密に追跡し、自動化されたシステムを使用してこのイメージの新しいバージョンを迅速に公開します。</li><li>Bitnami イメージでは、最新のバグ修正と機能をできるだけ早く利用できます。</li><li>Bitnamiのコンテナ、仮想マシン、クラウドイメージは、同じコンポーネントと構成アプローチを使用しているため、プロジェクトのニーズに応じて形式を簡単に切り替えることができます。</li><li>Bitnamiのイメージはすべて、minideb（最小限のDebianベースのコンテナイメージ）またはscratch（明示的に空のイメージ）をベースにしています。</li><li>Docker Hubで利用可能なすべてのBitnamiイメージは、Docker Content Trust（DCT）で署名されています。DOCKER_CONTENT_TRUST=1 を使用して、イメージの完全性を確認できます。</li><li>Bitnamiコンテナイメージは定期的にリリースされ、最新のディストリビューションパッケージが利用可能です。</li></ul><p>MongoDB®を本番環境で使用したいですか？Bitnami Application Catalogのエンタープライズ版であるVMware Tanzu Application Catalogをお試しください。</p></blockquote><p><a href=https://hub.docker.com/_/mongo>mongo</a> の公式イメージは ubuntu をベースイメージにしている。ubuntu よりは minideb の方が軽いのかな？そしてちゃんと upstream にも追随しているみたい。このベースイメージの違いによるものかは定かではないが、結合テストのイメージも移行してみたところ、10-20秒ほど結合テストの実行時間が速くなった。割合にすると10%程度かな。</p><blockquote><p>KubernetesにMongoDB®をデプロイするには？</p><p>Bitnami アプリケーションを Helm Chart としてデプロイすることは、Kubernetes 上で当社のアプリケーションを使い始める最も簡単な方法です。インストールの詳細については、Bitnami MongoDB® Chart GitHub リポジトリを参照してください。</p><p>Bitnami コンテナは、クラスタへの Helm Charts のデプロイと管理に Kubeapps と一緒に使用できます。</p></blockquote><p>helm chart も提供しているようで、いずれクラウド版を作るときに MongoDB も k8s 上にデプロイする上でこのことは都合がよいように思える。</p><p>レプリケーションを前提とした初期設定があり、entrypoint スクリプトもいくつか読んでみた感じだと、きれいに管理されていて保守もちゃんとやってくれそうにみえる。</p><ul><li><a href=https://github.com/bitnami/containers/tree/main/bitnami/mongodb>https://github.com/bitnami/containers/tree/main/bitnami/mongodb</a></li></ul><p>昨日、導入したばかりの公式イメージ + 自作スクリプトによるレプリケーション設定を廃止して、Bitnami のコンテナイメージを使うことに決めた。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1207/>mongodb のレプリカセットのデプロイ調査</a></h1><div class=post-meta><time class=post-date>2023-12-07</time></div><span class=post-tags>#<a href=/diary/tags/mongodb/>mongodb</a>&nbsp;
#<a href=/diary/tags/infrastructure/>infrastructure</a>&nbsp;
#<a href=/diary/tags/container/>container</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/testing/>testing</a>&nbsp;</span><div class=post-content><p>4時前に寝て6時半に起きた。1時過ぎまで作業して、帰って少しゲームして、うまく眠れなくてだらだらしていた。</p><h2 id=mongodb-のレプリカセットの調査>mongodb のレプリカセットの調査</h2><p>以前 <a href=/diary/posts/2023/1101/#mongo-とトランザクションとレプリカセット>mongodb でトランザクションを使うときにレプリカセットが必要</a> なことがわかった。他機能の開発途中だったので一旦後回しにしていたものを回収している。状況によってはメンバーに委譲してもよかったんだけど、私が遊撃で出張ってみることにした。実際に調べてみてコンテナの運用も考慮するとけっこう難しいことがわかってきた。</p><p><a href=https://www.mongodb.com/docs/mongodb-shell/>mongosh</a> からは <a href=https://www.mongodb.com/docs/v7.0/reference/method/js-replication/>Replication Methods</a> を使ってレプリカセットの操作ができる。これはユーティリティのようなもので mongodb としての低レベルのコマンド操作は <a href=https://www.mongodb.com/docs/manual/reference/command/nav-replication/>Replication Commands</a> になる。<a href=https://github.com/mongodb/mongo-go-driver>mongo-go-driver</a> はレプリカセット向けのユーティリティを提供していないため、Replication Commands を RunCommand() の低レベル API を使って自分で実装しないといけない。</p><p>例えば、レプリカセットの初期化をするときは次のように <code>replSetInitiate</code> というコマンドを適切なパラメーターで呼び出す。あまりドキュメントで丁寧に説明されていないので試行錯誤でエラーメッセージをみながら実装することになる。とくにはまるのが mongod のサーバーは <code>--replSet myrs</code> のようにレプリカセットを指定して起動させるものの、初期化コマンドを実行するときはまだレプリカセットを設定していないため、レプリカセットを指定せず、且つ <code>direct</code> パラメーターをセットしないと mongod サーバーに接続できない。この微妙な設定を把握するのにはまった。これが正しい手順かどうかもわからないが、ググったりしているとフォーラムでそういったコメントが散見されたりする。おそらく mongosh の Replication Methods を使うと、クライアントからサーバー接続は裏方でよしなにやってくれるのでそっちの方が簡単ではある。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ReplicaSet</span>) <span style=color:#a6e22e>Initiate</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>config</span> <span style=color:#a6e22e>bson</span>.<span style=color:#a6e22e>M</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>client</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>connectDirect</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to connect with direct: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Disconnect</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>result</span> <span style=color:#a6e22e>bson</span>.<span style=color:#a6e22e>M</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>cmd</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bson</span>.<span style=color:#a6e22e>D</span>{{<span style=color:#a6e22e>Key</span>: <span style=color:#e6db74>&#34;replSetInitiate&#34;</span>, <span style=color:#a6e22e>Value</span>: <span style=color:#a6e22e>config</span>}}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Database</span>(<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>db</span>).<span style=color:#a6e22e>RunCommand</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>cmd</span>).<span style=color:#a6e22e>Decode</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>result</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to run replSetInitiate(): %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>PrettyPrint</span>(<span style=color:#e6db74>&#34;completed to initiate&#34;</span>, <span style=color:#a6e22e>result</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ReplicaSet</span>) <span style=color:#a6e22e>connectDirect</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>mongo</span>.<span style=color:#a6e22e>Client</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>opts</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>Client</span>().
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>SetAuth</span>(<span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>Credential</span>{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Username</span>: <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>User</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Password</span>: <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>Passwd</span>.<span style=color:#a6e22e>String</span>(),
</span></span><span style=display:flex><span>		}).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>SetHosts</span>(<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>Hosts</span>).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>SetDirect</span>(<span style=color:#66d9ef>true</span>) <span style=color:#75715e>// must be true
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>mongo</span>.<span style=color:#a6e22e>Connect</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>opts</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>InitSingleReplicaSet</span>(
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>cfg</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>MongoDB</span>,
</span></span><span style=display:flex><span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>rs</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NewReplicaSet</span>(<span style=color:#a6e22e>cfg</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>initConfig</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bson</span>.<span style=color:#a6e22e>M</span>{
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;_id&#34;</span>: <span style=color:#a6e22e>cfg</span>.<span style=color:#a6e22e>ReplicaSet</span>,
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;members&#34;</span>: []<span style=color:#a6e22e>bson</span>.<span style=color:#a6e22e>M</span>{
</span></span><span style=display:flex><span>			{<span style=color:#e6db74>&#34;_id&#34;</span>: <span style=color:#ae81ff>0</span>, <span style=color:#e6db74>&#34;host&#34;</span>: <span style=color:#e6db74>&#34;localhost:27017&#34;</span>},
</span></span><span style=display:flex><span>		},
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>rs</span>.<span style=color:#a6e22e>Initiate</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>initConfig</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>さらに mongod サーバーを起動するときに <code>--replSet</code> と <code>--keyFile</code> (認証が必要な場合のみ？) という2つのパラメーターを指定する必要がある。<code>--replSet</code> はレプリカセットの識別子を指定する。そして <code>--keyFile</code> は共通鍵を指定する。この共通鍵を生成するには次のようにする。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ openssl rand -base64 <span style=color:#ae81ff>756</span> &gt; my-mongo-keyfile
</span></span><span style=display:flex><span>$ chown mongodb:mongodb my-mongo-keyfile
</span></span><span style=display:flex><span>$ chmod <span style=color:#ae81ff>400</span> my-mongo-keyfile
</span></span></code></pre></div><p>普通のサーバーインスタンスならすぐできることだが、コンテナの運用において面倒なのが owner とパーミッションを設定しないといけないところ。mongo のコンテナは mongodb ユーザーで起動するため、root でマウントされたファイルシステムには書き込みできなかったりして keyFile の配置をどう扱えばよいのかが難しい。docker hub の mongo の issues でもどうやって設定したらいいの？って議論が発散している。mongo 本体が公式のスクリプトや仕組みを提供していれば済む話しだけど、どうもそうではないみたい。だから泥臭い方法で自分でなんとかしないといけないようにみえる。</p><ul><li><a href=https://github.com/docker-library/mongo/issues/246>Creating a mongo image set with &ndash;replSet #246</a></li><li><a href=https://github.com/docker-library/mongo/issues/339>Cannot configure replica sets with entrypoint-initdb #339</a></li></ul><p>dockertest でもレプリカセットの設定について次の issue として登録されている。mongo のコンテナを使ったテストの場合、dockertest のレイヤーが挟まるのでさらにわかりにくくなっている。テストを動かすためにどういった設定が必要かは把握できたのでなにかよい方法を考えてコントリビュートしたい。</p><ul><li><a href=https://github.com/ory/dockertest/issues/480>Create an example for starting mongodb as a replica set #480</a></li></ul></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1202/>ミニカンファレンスみながら作業してた</a></h1><div class=post-meta><time class=post-date>2023-12-02</time></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/event/>event</a>&nbsp;</span><div class=post-content><p>1時に寝て7時に起きて朝からゲームしてた。お酒飲んだせいで眠りが浅かったような気がする。</p><h2 id=ストレッチ>ストレッチ</h2><p>先週は前日に車であちこち移動して、長時間運転していたのもあり腰に負担がかかっていた。今週は東京出張だったものの、すねの外側の筋やふくらはぎの張りをやや感じた程度でとくに悪いところのない状態に戻ったようにみえる。寒くなってきたのもあり、上半身の肩周りの動きが堅くなっているとトレーナーさんは話していた。今日の開脚幅は開始前153cmで、ストレッチ後158cmだった。</p><h2 id=ミニカンファレンスのオンライン参加>ミニカンファレンスのオンライン参加</h2><p>オンラインのミニカンファレンスを視聴しながらいつも通りの作業をしていた。あまりちゃんと聞いていたわけではないけど、要所要所でおもしろい発表もあった。</p><ul><li><a href=https://kyotogo.connpass.com/event/285351/>Go Conference mini 2023 Winter IN KYOTO</a></li></ul><p>tinygo の中の人が自作キーボードに関する発表をしていて、その人は明石市に住んでいるので、明石市から三ノ宮にかけてイベントをやりたいと話されていた。go について話す相手がいると私も嬉しい。またなにかの機会でご一緒できればと思う。</p></div></article><div class=pagination><div class=pagination__buttons><a href=/diary/tags/go/page/2/ class="button next"><span class=button__text>過去の日記</span>
<span class=button__icon>→</span></a></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2024 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>