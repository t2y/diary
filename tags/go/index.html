<!doctype html><html lang=en><head><title>Go :: </title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/tags/go/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="Go"><meta property="og:description" content><meta property="og:url" content="/diary/tags/go/"><meta property="og:site_name" content><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/tags/go/index.xml rel=alternate type=application/rss+xml title></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><h1>Posts for: #Go</h1><div class=posts><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/1112/>mongodb のトランザクション調査</a></h1><div class=post-meta><time class=post-date>2024-11-12</time></div><span class=post-tags>#<a href=/diary/tags/mongodb/>mongodb</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;</span><div class=post-content><p>今日のバドミントン練習はエアシャトルでリフティングを10分、連続最大回数は120回ほど、ショートサーブ30回した。フットワーク練習はお休み。筋肉痛もあったから、みなとのもり公園をジョギングで3周 1.4km、縄跳び15分で1712回だった。縄跳びも2ヶ月ぶり。8月に過去最高が1838回に対して、2ヶ月ぶりにやって2分弱の休憩、十数回のミスがあっても1700回を超えるんやと思って少し驚いた。8月に比べたらいまは涼しいから記録が伸びるのもある。ジョギングで足が筋肉痛になると走るよりも縄跳びの方が負担が小さい。昨日と同じように運動してストレッチして十分にカラダを動かした。</p><h2 id=トランザクションとコールバック>トランザクションとコールバック</h2><p>お仕事は昨日の続きでリクエスト途中のサービス終了したときに web api ハンドラーの処理が途中でキャンセルされ、そのために内部のデータが不整合になることがわかった。データを不整合にしないため <a href=https://www.mongodb.com/docs/manual/core/transactions/>mongodb のトランザクション</a> の仕組みを調べてデバッグしたりしていた。echo のミドルウェアで <a href=https://en.wikipedia.org/wiki/Unit_of_work>Unit of work</a> を実装できないかをプロトタイプ実装していた。</p><p>基本は次のように callback 関数を渡せばトランザクションに失敗したときにリトライもしてくれて便利なのだけど、いろいろ api サーバーの既存アーキテクチャの都合もあってこれは使えないことがわかった。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>session</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>StartSession</span>()
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>session</span>.<span style=color:#a6e22e>EndSession</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>result</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>session</span>.<span style=color:#a6e22e>WithTransaction</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>callback</span>)
</span></span></code></pre></div></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/1109/>テストカバレッジの LT 発表</a></h1><div class=post-meta><time class=post-date>2024-11-09</time></div><span class=post-tags>#<a href=/diary/tags/event/>event</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/testing/>testing</a>&nbsp;
#<a href=/diary/tags/health/>health</a>&nbsp;</span><div class=post-content><p>今日のバドミントン練習はお休み。</p><h2 id=lt-会>LT 会</h2><p>午後から <a href=https://kobe-sannomiya-dev.connpass.com/event/332096/>LT大会 with カメラマン</a> に参加してきた。副業でカメラマンをやろうとしている方が LT 中にプロフィール写真になるようなものを撮ってくれるという。会社紹介などのスライドで使えるかもしれないと思って参加してきた。趣味で4-5年カメラを勉強しているというだけあって、機材や知識も備えていてよかったと思う。LT のネタとして先月お仕事でやっていた go のテスト改善の一環でカバレッジについての紹介をしてきた。サンプルコードは次になる。</p><ul><li><a href=https://github.com/t2y/go-integration-tests-sample>github.com/t2y/go-integration-tests-sample</a></li></ul><p>終わってから軽く立ち飲み屋で飲んで若い人たちの話しを聞いていた。若い人たちは活気があってやりたいことも多くて、いまの私からみたときのモチベーションの在り方に違いがあるようにも思えた。たまに若い人たちの中に紛れて話しを聞くだけでも自分が失くしたものを気付くきっかけになるようにも思えた。若い人たちはどんどん挑戦してがんばってほしい。</p><h2 id=ストレッチ>ストレッチ</h2><p>今日は身体的に疲れているというよりも、開発合宿から続くお仕事のせいか、精神的に疲れていて、2週間ぶりにトレーナーさんと雑談するだけでも気分転換になってよかったと思う。今週はお仕事に集中していてまったく運動していないため、足の張りなどはほとんどなくなっていた。一方でバドミントンの試合をしてこけたときに痛めた腰だけはまだ張りが残っていてなかなか治りきらないことも実感した。今日の開脚幅は開始前149cmで、ストレッチ後155cmだった。</p><p>ストレッチを終えてから買いものしてオフィスへ戻って軽く作業していた。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/1021/>出張前日の資料づくり</a></h1><div class=post-meta><time class=post-date>2024-10-21</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/testing/>testing</a>&nbsp;
#<a href=/diary/tags/project-management/>project management</a>&nbsp;</span><div class=post-content><p>今日は1日中オフィスにこもって作業と出張準備をしていたのでバドミントン練習はお休み。夕方にお土産として <a href=https://shop.morozoff.co.jp/c/region/kobe>モロゾフのプリンクッキー</a> を購入するために本店へ行ってきた。これも神戸限定らしい。</p><h2 id=パッケージ外のディレクトリにあるテストのカバレッジ計測>パッケージ外のディレクトリにあるテストのカバレッジ計測</h2><p>先日 <a href=/diary/posts/2024/1018/#go-test-からバイナリをビルドしてサーバーを起動する>深夜にバイナリのビルド・起動調査</a> をしたのに、最終的にはそんなことしなくてもよかった。デフォルトではパッケージ外のディレクトリにあるテストのカバレッジを計測しないことから普通にはできないと考えていた。しかし、調べたら次の SO で解決法をみつけた。結論としては <code>-coverpkg ./...</code> のように go test で実行している結合テストに対してオプションを指定するだけでよかった。</p><ul><li><a href=https://stackoverflow.com/questions/34535704/how-to-detect-code-coverage-of-separated-folders-in-go>How to detect code-coverage of separated folders in GO?</a></li></ul><p>この調査を終えて最終的な makefile の coverage ターゲットは次のようになった。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-makefile data-lang=makefile><span style=display:flex><span><span style=color:#a6e22e>coverage</span><span style=color:#f92672>:</span> lint
</span></span><span style=display:flex><span>	rm -f coverage.*
</span></span><span style=display:flex><span>	go test -tags<span style=color:#f92672>=</span>integration -race -cover ./... -coverpkg ./... -covermode atomic -coverprofile<span style=color:#f92672>=</span>coverage.out
</span></span><span style=display:flex><span>	go tool cover -html coverage.out -o coverage.html
</span></span></code></pre></div><p>この make ターゲットを gitlab ci/cd から実行して coverage.out/coverage.html を自動生成する。coverage.out があるので必要に応じて好みのツールで統計情報を解析すればよい。たとえば <a href=https://github.com/nikolaydubina/go-cover-treemap>nikolaydubina/go-cover-treemap</a> でツリーマップを作るなら次のように実行する。</p><pre tabindex=0><code>$ go-cover-treemap -coverprofile coverage.out &gt; treemap.svg
</code></pre><h2 id=近況報告の資料作り>近況報告の資料作り</h2><p>普段は週末に報告資料を作っているのにもうやる気が無さ過ぎてお仕事を終えてから作っている。今回はネガティブな内容も報告に入れる。過去の経緯などを調査しながら3時間もあれば一通りのアウトラインはできた。明日がマイルストーンの最終日になるため、明日を終えてからでないと細かい数字は決定しない。マイルストーンの issue を調べたら qa テストでみつけた不具合の issue がそれなりに溜まっているようにみえる。本当は次のマイルストーンで5次開発は完了予定だが、もう1つ増やしてもよいかもしれない。いずれにしても12月／1月に本番導入のための準備もある。今の開発フェーズを完了しても次の開発フェーズには入らないのではないかという見通しもある。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/1016/>テストライブラリの導入</a></h1><div class=post-meta><time class=post-date>2024-10-16</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/testing/>testing</a>&nbsp;</span><div class=post-content><p>今日のバドミントン練習はエアシャトルでリフティングを25分した。連続最大回数は277回できた。初めてエアシャトルで200回を超えた。しかも夜なのに。やや高めに打ち上げれば安定的にリフティングできるようになってきた。連続回数が増えることはラケットとシャトルの距離感、ラケットコントロールが上達していることの証左でもあるので200回を超えたときは嬉しかった。</p><h2 id=テストライブラリの追加>テストライブラリの追加</h2><p>結合テストを改善するために2つのライブラリを新たに使うよう導入した。</p><ul><li><a href=https://github.com/gavv/httpexpect>gavv/httpexpect</a></li><li><a href=https://github.com/stretchr/testify>stretchr/testify</a></li></ul><p>testify は名前だけ知っていたが、実際に使ってみるのは初めて。testify は大きく3つの機能もっている。</p><ul><li>アサーション</li><li>テストスィート</li><li>モック</li></ul><p>うちらのチームで使うのはアサーション機能だけになる。モックも将来的に使う可能性はある。アサーションを使うと自分でエラーメッセージを書く手間を省ける。次のようなコードがあった場合、</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>expected</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>actual</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;expected %d, but got %d&#34;</span>, <span style=color:#a6e22e>expected</span>, <span style=color:#a6e22e>actual</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>次のようにエラーレポートを testify に委譲できる。このぐらいの利便性でしかないが、テストの規模が大きくなったり、量が増えていけば読み書きのコストを削減できるかもしれない。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>assert</span>.<span style=color:#a6e22e>Equal</span>(<span style=color:#a6e22e>expected</span>, <span style=color:#a6e22e>actual</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>httpexpect はまったく知らなくて初めて使ってみたが、感触がよい。これもデフォルトのエラーレポート機能は testify のアサーション機能を使っているようにみえる。これまでは http リクエストに対して自前のユーティリティ関数と組み合わせて次のようなコードを書いていた。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>doHTTPRequest</span>(<span style=color:#a6e22e>body</span>, <span style=color:#a6e22e>UserPath</span>, <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>MethodGet</span>, <span style=color:#e6db74>&#34;&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>StatusCode</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusOK</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;expected to get %d, but got %d&#34;</span>, <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusOK</span>, <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>StatusCode</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>actual</span> <span style=color:#a6e22e>entry</span>.<span style=color:#a6e22e>User</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>convertBody</span>(<span style=color:#a6e22e>res</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>actual</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to convert: %s&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>httpexpect を使うと次のように簡潔に記述できる上にエラーレポートを httpexpect に委譲できる。これはかなりテストコードを読み書きする工数を削減できると思う。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>actual</span> <span style=color:#a6e22e>entry</span>.<span style=color:#a6e22e>User</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>GET</span>(<span style=color:#a6e22e>UserPath</span>).
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>WithJSON</span>(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>any</span>{ <span style=color:#f92672>...</span> }).
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Expect</span>().
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Status</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusOK</span>).
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>JSON</span>().
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Decode</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>actual</span>)
</span></span></code></pre></div></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/1015/>mongodb のテストデータ管理</a></h1><div class=post-meta><time class=post-date>2024-10-15</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/testing/>testing</a>&nbsp;
#<a href=/diary/tags/mongodb/>mongodb</a>&nbsp;</span><div class=post-content><p>今日のバドミントン練習はエアシャトルでリフティングを45分した。連続最大回数は146回できた。調子は悪くなく安定的に30回前後は続くものの、50回を超えたぐらいで失敗してしまう。打ち上げる高さの違いかな？と気付いて少し高めに打ち上げるようにしたら100回を超えた。エアシャトルはラケット面に対して適切な角度でコルクを打たないとあらぬ方向に飛んでいってしまう。高く打ち上げるほど、重力で落ちてくるときにコルクが下を向きやすくなるため、うまくシャトルを打ち上げやすくなる。ラケットコントロールをうまくできれば、エアシャトルをより低い高さでリフティングできるようになるかもしれない。まだ私はそのレベルには満たない。</p><h2 id=json-からの-mongodb-にテストデータを追加する>json からの mongodb にテストデータを追加する</h2><p>結合テストの改善をしていてテストデータを json で管理したい。これまで go の構造体でテストデータを定義して mongodb の client で insert するといったことをしていた。それも役に立つのだけど、共有のテストデータがどこにあるのか、ソースコードに書いてしまうと時間とともに散らばっていって把握できなくなっていく。テストデータを管理するためのディレクトリを設け、そこに json で記述してどのテスト関数で使うかといったメタ情報も定義できるようにした。次のコードは mongodb に json からデータをインポートするための原理を説明するための疑似コードのようなもの。</p><p>go の構造体で定義したテストデータと json で管理するのとどちらがよいかというのは議論の余地はあるし、一概に言えないとは思う。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>testData</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Documents</span>    []<span style=color:#a6e22e>bson</span>.<span style=color:#a6e22e>Raw</span> <span style=color:#e6db74>`bson:&#34;documents&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>InsertData</span>(
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>, <span style=color:#a6e22e>client</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>mongo</span>.<span style=color:#a6e22e>Client</span>, <span style=color:#a6e22e>b</span> []<span style=color:#66d9ef>byte</span>,
</span></span><span style=display:flex><span>) (<span style=color:#66d9ef>func</span>()) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>data</span> <span style=color:#a6e22e>testData</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bson</span>.<span style=color:#a6e22e>UnmarshalExtJSON</span>(<span style=color:#a6e22e>b</span>, <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>data</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>require</span>.<span style=color:#a6e22e>NoError</span>(<span style=color:#a6e22e>t</span>, <span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;failed to get json files: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>col</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Database</span>(<span style=color:#a6e22e>dbName</span>).<span style=color:#a6e22e>Collection</span>(<span style=color:#e6db74>&#34;mycollection&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>col</span>.<span style=color:#a6e22e>InsertMany</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>docsToInterfaces</span>(<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>Documents</span><span style=color:#f92672>...</span>))
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>require</span>.<span style=color:#a6e22e>NoError</span>(<span style=color:#a6e22e>t</span>, <span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;failed to insert: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>insertResult</span>, <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Helper</span>()
</span></span><span style=display:flex><span>	    <span style=color:#a6e22e>col</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Database</span>(<span style=color:#a6e22e>dbName</span>).<span style=color:#a6e22e>Collection</span>(<span style=color:#e6db74>&#34;mycollection&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>id</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>InsertedIDs</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>filter</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bson</span>.<span style=color:#a6e22e>D</span>{{<span style=color:#a6e22e>Key</span>: <span style=color:#e6db74>&#34;_id&#34;</span>, <span style=color:#a6e22e>Value</span>: <span style=color:#a6e22e>id</span>}}
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>col</span>.<span style=color:#a6e22e>DeleteOne</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>filter</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to delete %s: %v&#34;</span>, <span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>呼び出し側のイメージ。defer で teardown を呼ぶことでテスト完了時に追加したテストデータを削除してくれる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>teardown</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>mongotest</span>.<span style=color:#a6e22e>InsertData</span>(<span style=color:#a6e22e>t</span>, <span style=color:#a6e22e>mongoClient</span>, <span style=color:#a6e22e>b</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>teardown</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span></code></pre></div><p>bson.Raw として読み込める json データは bson パッケージのユーティリティを使って dump できる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>dumpAsJSON</span>(<span style=color:#a6e22e>value</span> <span style=color:#a6e22e>any</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>b</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bson</span>.<span style=color:#a6e22e>MarshalExtJSON</span>(<span style=color:#a6e22e>value</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>false</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>slog</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#e6db74>&#34;failed to marshal as extended JSON&#34;</span>, <span style=color:#e6db74>&#34;err&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(string(<span style=color:#a6e22e>b</span>))
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/1011/>ひとりではできないこと</a></h1><div class=post-meta><time class=post-date>2024-10-11</time></div><span class=post-tags>#<a href=/diary/tags/founding/>founding</a>&nbsp;
#<a href=/diary/tags/issue-management/>issue management</a>&nbsp;
#<a href=/diary/tags/business/>business</a>&nbsp;
#<a href=/diary/tags/motivation/>motivation</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/testing/>testing</a>&nbsp;</span><div class=post-content><p>今日のバドミントン練習はエアシャトルでリフティングを30分した。連続最大回数は80回だが、ほとんどの試行は20回も続かずに失敗してしまう。難しい。</p><h2 id=隔週の雑談>隔週の雑談</h2><p>顧問のはらさんと隔週の打ち合わせ。今日の議題はこれら。</p><h3 id=課題管理と-adr-の関係の考察>課題管理と adr の関係の考察</h3><iframe class=speakerdeck-iframe frameborder=0 src=https://speakerdeck.com/player/1d21876659d244a8b6c121255e2fbce9 title=ADRを運用して3年経った僕らの現在地 allowfullscreen style="border:0;background:padding-box padding-box rgba(0,0,0,.1);margin:0;padding:0;border-radius:6px;box-shadow:rgba(0,0,0,.2)0 5px 40px;width:600px;height:auto;aspect-ratio:560/315" data-ratio=1.7777777777777777></iframe><p>数年前から adr の話題や導入した会社の記事などをみかけるようになった。私はこれまで課題管理をうまくやっていれば adr はそれほど重要ではないとあまり重視してこなかった。しかし、世の中的に認知されて流行っているものはなにかしら意義があるのだろうと最近は少し見直してきているところもある。このスライドによると2017年から流行り始めたらしい。</p><ul><li>開発に関する情報を一元管理する、または全文検索ことにビジネスチャンスはある<ul><li>検索のニーズや要件は多様で言語によっても違い、技術もまだまだ発展的でもあるからずっとビジネスの種になる気はする</li><li>gitlab issues のコメントの全文検索は有料機能なので slack 通知したチャンネルを全文検索している<ul><li>課題管理システムのプラグインでテキストをシステム間連携することで検索システムを別途構築できる可能性がある</li><li>検索できなくてもデータのアーカイブをするという視点でもビジネスニーズに応える？</li></ul></li></ul></li><li><a href=https://www.elastic.co/jp/what-is/vector-search>ベクトル検索</a> を検索がまだ一般的にはなっていない？<ul><li>テックブログを読む会でメンバーが <a href=https://zenn.dev/minedia/articles/d9f01aa05bc880>医薬品検索にベクトル検索を導入したら、デフォで検索ニーズをほぼ満たせそうだった話</a> を紹介していた</li><li>いまや rdb でも全文検索機能はあるが、実運用だと rdb の i/o がボトルネックになることは多いだろうから全文検索用途に使うモチベーションが低いと想定される</li><li>普通の全文検索とベクトル検索の違いを実際に触ってみて評価してみたい</li></ul></li><li>wiki と adr の違いの1つとして wiki になにを書いてよいかわからない問題がある<ul><li>文章を書けるようになるのは経験や習熟を必要とする</li><li>adr のようなテンプレートがあることで経験の浅い開発者も書きやすくなる狙いはある</li><li>課題管理システムの wiki に adr のラッピングをして別機能としてみせるのはよいかもしれない</li><li>業務の引き継ぎにも adr は役に立つのではないか？</li><li>adr 一覧をみたり、そこから検索することで検索効率や精度は上がるという想定</li></ul></li><li>大きい会社でも巨大な課題管理システムと wiki が1つだけあって一元管理しているという噂は聞く<ul><li>ある会社では wiki は誤っている可能性があるから信用するなという教訓があった<ul><li>wiki の情報は更新されていない可能性があるから参考にしながら必ず裏をとって業務をしなさいという話し</li></ul></li><li>wiki を編集したら必ずレビューが必要になるプロセス</li></ul></li><li>notion のプロジェクト管理の使い勝手はどうか？<ul><li>テンプレートを使ってガントチャートやカンバンを作れる<ul><li>基本的に自分でカスタマイズできることの良し悪しがある<ul><li>db をどんどん改良できるが、それだけに魔改造してしまう</li><li>時間とともに複数人が改良すると保守できなくなっていく懸念がある</li></ul></li><li>中核機能をパッケージ側で提供することは堅牢性を担保する上で重要ではないか</li></ul></li><li>タスク管理と wiki がシームレスなところはよい、はらさんは日報を書いてリンクしている</li></ul></li><li>会社のインフラに日々の開発情報を書いていくと退職後に参照できない<ul><li>フリーランスのような働き方をするにはナレッジデータベースをローカルに作りたいという欲求がある</li><li>組み込みの課題管理システムにより、自身のナレッジデータベースをローカルに残すという目的はよいかもしれない</li></ul></li></ul><h3 id=仕事は楽しいかねhahahugoshortcode1113s0hbhb-の考察><a href=/diary/posts/2024/1008/>仕事は楽しいかね？</a> の考察</h3><p>まとめを見返しながら、だいたいの項目は理解または支持できる。1つだけ次の項目が私には欠けていることに気付いた。</p><blockquote><p>毎日1つ試し続ければ必ず上達や進歩ができる</p></blockquote><ul><li>新しいことを始めると、いまやっていることを継続する時間がなくなったりしないか？</li><li>プロダクト開発ではがんばってもあまり成果が出ないような時期もある<ul><li>リファクタリングやテスト追加などはまさにそう</li><li>そういったときも1つでも変化をもたらせれば日々の生活が変わるのか？</li></ul></li><li>はらさんのお奨めは梅原さんの <a href=https://www.kadokawa.co.jp/product/301305000020/>１日ひとつだけ、強くなる。 世界一プロ・ゲーマーの勝ち続ける６４の流儀</a></li><li>本書を読んではらさんのよかったところは「試してみることに失敗はない」<ul><li>それまでも試すことはやっていたはずなのに躊躇してしまう理由として失敗したら時間の無駄だと考えてしまっていた</li><li>失敗したら嫌だと考えてしまうところがあったが、この考え方があるから vision pro を購入できる<ul><li>最近は vision pro の話題を聞かなくなったがどうか？<ul><li><a href=https://internet.watch.impress.co.jp/docs/yajiuma/1630679.html>ロードマップに影響は？ Appleに26年間在籍した「Vision Pro」の開発責任者が退職へ</a></li><li>仕事にはならないのではないか？</li></ul></li></ul></li><li>やりたいことをすぐやってみるという思考につながった</li></ul></li><li>面倒くさいときもなるべくパソコンを使うようにしてなにかしら調べる</li><li>私はオフィスにいれば、家よりはなにかしら作業するモチベーションになる</li><li>目標達成や成果をあげるには環境がもっとも大事<ul><li>個人の感情を信頼しない<ul><li>人間は面倒だとすぐ怠けてやめてしまう</li></ul></li><li>環境を整えることでワークフローを洗練させて習慣化する<ul><li>日記になにか書かないといけないから調べものをする</li><li>嫌々ながらでもやっているうちに習慣になってくるとワークフローが洗練していく</li><li>人間の運用を変えていくなにかは普遍的な価値またはビジネスチャンスがある</li></ul></li><li>調子の悪いときにどうやって早く脱却するかが大事<ul><li>ひとりでは言い訳を作ったり怠けてしまう</li><li>このときに他人の助けがいるのではないか？<ul><li>話しを聞いてもらうだけでも前へ進むきっかけになる</li></ul></li></ul></li></ul></li></ul><h2 id=go-の結合テスト向けカバレッジ計測の考察>go の結合テスト向けカバレッジ計測の考察</h2><p>以前リリースパーティーで go 1.20 で結合テスト向けのカバレッジ計測の機能が入ったことを聞いていた。次のブログ記事でやり方が紹介されている。</p><ul><li><a href=https://go.dev/blog/integration-test-coverage>Code coverage for Go integration tests</a></li><li><a href=https://netdevops.me/2023/test-coverage-for-go-integration-tests/>Test coverage for Go integration tests</a></li></ul><p>将来的に結合テストを作るときにカバレッジ計測のカスタマイズを施したバイナリを使って api server を起動する仕組みにすればこの機能を使えることに気付いた。</p><p>まずは単体テストを実行して任意のディレクトリ (<code>tests/coverage</code>) にカバレッジ計測のための中間データを生成する。</p><pre tabindex=0><code>$ mkdir -p tests/coverage
$ go test -cover ./... -covermode atomic -args -test.gocoverdir=&#34;$PWD/tests/coverage&#34;
$ go tool covdata textfmt -i=./tests/coverage -o coverage.out
</code></pre><p>coverage.out がさまざまなツールの入力となる統計情報となる。例えば、このファイルを使って次のようにしてソースコードのヒートマップの html を作成できる。</p><pre tabindex=0><code>$ go tool cover -html coverage.out -o coverage.html
</code></pre><p><a href=https://github.com/nikolaydubina/go-cover-treemap>nikolaydubina/go-cover-treemap</a> を使うと treemap でカバレッジのヒートマップを確認できる。</p><pre tabindex=0><code>$ go-cover-treemap -coverprofile coverage.out &gt; treemap.svg
</code></pre><p>カバレッジ計測向けのバイナリをビルドする。そのバイナリを起動するときに環境変数 GOCOVERDIR に単体テストのカバレッジの中間データが含まれるディレクトリを指定する。</p><pre tabindex=0><code>$ go build -cover -covermode atomic -o bin/api ./cmd/api/...
$ GOCOVERDIR=&#34;$PWD/tests/coverage&#34; ./bin/api -verbose
</code></pre><p>このバイナリを使って起動した api server に対してリクエストを呼び出すことでカバレッジを計測してくれる。結合テストからバイナリ起動した api server に対してリクエストしたときに GOCOVERDIR に中間データが追加されていく。結合テストを完了したら最終的なカバレッジの統計情報を生成する。
￼</p><pre tabindex=0><code>$ go tool covdata textfmt -i=./tests/coverage -o coverage.out
</code></pre><p>textfmt のヘルプをみたら同じディレクトリじゃなくてもよいみたい。</p><pre tabindex=0><code>$ go tool covdata textfmt -help
...
Examples:

  go tool covdata textfmt -i=dir1,dir2 -o=out.txt

  	merges data from input directories dir1+dir2
  	and emits text format into file &#39;out.txt&#39;
</code></pre></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/1010/>練習場所のビル探し</a></h1><div class=post-meta><time class=post-date>2024-10-10</time></div><span class=post-tags>#<a href=/diary/tags/badminton/>badminton</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/testing/>testing</a>&nbsp;</span><div class=post-content><p>今日のバドミントン練習はリフティングを昼夜あわせて85分 (メイビスで75分、エアで10分) した。フォア持ちとバック持ちを交互に切り替えリフティングで398回続けられた。目標の200回を越せるようになった。</p><h2 id=バドミントンの練習場所探し>バドミントンの練習場所探し</h2><p>お昼休みに公園へ行って20分ほど軽く練習した。そのときに連続回数が198回だった。あと2回足りなかったのが悔しかったのと、夜にがんばったらできそうかなという見通しをもっていた。</p><p>夜は近所で練習場所によさそうなビルを探してまわってみた。まずは少しおしゃれな区役所のビルの軒下へ行ってみた。</p><figure><img src=/diary/img/2024/1010_bullding1.jpg></figure><p>たまたま時間帯が悪かったのか、この場所が風の通り道になっているのか、練習を始めて5分ほどやって風の影響が強くて難しそうだったのですぐに撤収した。人通りが少なく照明もよい感じなのだけど、バドミントンの練習は風が強いとどうにもできない。</p><figure><img src=/diary/img/2024/1010_bullding2.jpg></figure><p>付近を散策しながら旧居留地にある別のビルへ。従業員の通用口がやや近いところが懸念。従業員が出てきたときにこいつ何しているの？と思うかもしれない。私の視点からもややパーソナルスペース／練習スペースを狭く感じるところはある。風の影響は受けにくい構造にはなっている。ここで15分ほど練習して267回継続できた。初めて200回を超えた。その後、あまり回数が続かなくなったのでまた散策して別のビルへ。</p><figure><img src=/diary/img/2024/1010_bullding3.jpg></figure><p>ここも広くて明るくて夜は施錠しているようにみえる。ここは従業員と会うこともない。よい場所なんだけど、照明が明る過ぎて見上げたときにシャトルと照明が重なってしまうと眩しい。照明が明る過ぎても練習しにくいことに気付いた。ここでも20分ほど練習したのに200回を超えなくて次へ移動する。照明が目に入るせいかもしれない。</p><figure><img src=/diary/img/2024/1010_bullding4.jpg></figure><p>最後はホームのビルへ。他のビルで練習してみてホームのビルのよさを実感した。もっとも練習スペースが広い。そして照明を背中側にして練習するスペースも十分にある。そうすると、見上げても照明とシャトルが重なることはないので眩しくて失敗してしまう状況を避けられる。構造的に風の影響も受けにくい。ここで20分ほど練習していたら398回、266回、349回と200回超えを3回できた。</p><p>フォア持ちとバック持ちのリフティングをしていて安定的するようになってきた。うまくラケットのスィートスポットで打てば真上にシャトルが上がる。50回ぐらいならほとんど動くこともなく上げられる。だいたい100回に1-2回ぐらい、失敗してシャトルをラケットのフレームに当てたりしてシャトル操作が乱れる。ドタバタしてリカバリする。これまではそのときに焦ってしまってシャトルを落とすことが多かった。なぜ200回以上続くかというと、その稀に失敗したときのシャトル操作をリカバリできるようになってきたから。つまり5回ぐらいミスしたときにリカバリできれば200回は続くということになる。これはメイビスフィールドのシャトルを使ったときの話し。</p><p>次にエアシャトルを使って同様にリフティングをしてみると最高で50数回ぐらいしか続かない。これはラケットのフレームまたはフレーム近くのガットで弾いてしまうと、コルク部分がプラスチックなために反発せずに落としてしまったり、あらぬ方向へ飛んでいったりしてリカバリがとても難しい。つまり、ラケットコントロールをうまくやらないとエアシャトルでリフティングを継続するのはメイビスフィールドよりもずっと難しい。次の目標としてはエアシャトルで200回を越せるようにラケットコントロールの練習をするのがよいように思える。</p><h2 id=テストとビルドタグ>テストとビルドタグ</h2><p>go ではテスト用途のパッケージを <a href=https://pkg.go.dev/net/http/httptest>httptest</a> や <a href=https://pkg.go.dev/testing/iotest>iotest</a> といった、通常アプリケーションとしてパッケージを提供しているものもある。しかし、通常のパッケージにしてしまうと、アプリケーションをビルドしたときにテストコードもバイナリにも含まれてしまう。依存パッケージの管理やバイナリサイズを減らす上で不要なコードはビルド対象外になる方が望ましい。自分たちが書いたソースコードがアプリケーションに含まれることはサイズの視点では問題ないが、テスト向けの依存パッケージもアプリケーションに含まれると意図せずバイナリサイズが大きくなってしまったり、パッケージの依存解決に時間がかかったりしてしまう懸念がある。そのため、ビルドタグを用いてテスト用途のパッケージはテストのときしかビルドしないように制御する。</p><p>例えば <code>integration</code> というビルドタグを設ける。テスト用途の <code>util</code> パッケージを定義するときは次のようにソースコードを記述する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>//go:build integration
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>util</span>
</span></span></code></pre></div><p>ビルドタグを指定せずに結合テストを実行しようとすると次のようなエラーが発生する。</p><pre tabindex=0><code>$ go test ./tests/...
# example.com/tsets/mypackage
package example.com/tsets/mypackage_test
	imports example.com/tests/util: build constraints exclude all Go files in path/to/tests/util
FAIL	example.com/tests/mypackage [setup failed]
</code></pre><p>結合テストを実行するには次のように明示的にビルドタグを指定して、テスト用途のパッケージをビルドしてテストが実行されるようにしないといけない。</p><pre tabindex=0><code>$ go test -tags=integration ./tests/mypackage/...
</code></pre></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0926/>非同期処理のキャンセルと中断待ち</a></h1><div class=post-meta><time class=post-date>2024-09-26</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;</span><div class=post-content><p>バックエンドで非同期のバッチ処理を実装してサーバーが shutdown したときに実行中のバッチ処理も安全に止めないといけない。</p><p>context でキャンセルするのは簡単だけど、非同期で動いている goroutine が中断してから終了したことを main プログラム側で待つ同期をどう実装しようか悩んでいた。たまたま <a href=https://zenn.dev/the_exile/articles/use-golang-context>【Go】Contextの魅力を感じる</a> の記事をみたら <a href=https://pkg.go.dev/sync#WaitGroup>sync#WaitGroup</a> と組み合わせたサンプルコードがあって、これまでも sync#WaitGroup を使ったコードを何度も書いてきて知っていたはずなのに context と組み合わせるという発想はなかったなと気付きを得た。それからライブラリとして汎用のバッチ処理の controller を実装した。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Controller</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctx</span>    <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>cancel</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>CancelFunc</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>wg</span>     <span style=color:#f92672>*</span><span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>WaitGroup</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mu</span>     <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Mutex</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Controller</span>) <span style=color:#a6e22e>Register</span>() (<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>WaitGroup</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>WithValue</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>ctxKey</span>{}, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>wg</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Controller</span>) <span style=color:#a6e22e>Stop</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>cancel</span>()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Controller</span>) <span style=color:#a6e22e>Wait</span>() <span style=color:#f92672>&lt;-</span><span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>struct</span>{} {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>quit</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>struct</span>{}, <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Wait</span>()
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>slog</span>.<span style=color:#a6e22e>Debug</span>(<span style=color:#e6db74>&#34;completed to wait group in batch.Controller&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>quit</span> <span style=color:#f92672>&lt;-</span> <span style=color:#66d9ef>struct</span>{}{}
</span></span><span style=display:flex><span>	}()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>quit</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewController</span>(<span style=color:#a6e22e>parent</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>Controller</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>cancel</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>WithCancel</span>(<span style=color:#a6e22e>parent</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>Controller</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ctx</span>:    <span style=color:#a6e22e>ctx</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>cancel</span>: <span style=color:#a6e22e>cancel</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>wg</span>:     new(<span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>WaitGroup</span>),
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>parent の context でキャンセルさせることもできるし、この controller の api からキャンセルさせることもできる。</p><p>この controller を使うアプリケーションのコードは次のようになる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>c</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>batch</span>.<span style=color:#a6e22e>NewController</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>wg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Register</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Done</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>	    <span style=color:#75715e>// do something
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Done</span>():
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>slog</span>.<span style=color:#a6e22e>Debug</span>(<span style=color:#e6db74>&#34;canceled&#34;</span>, <span style=color:#e6db74>&#34;err&#34;</span>, <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Err</span>())
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>timer</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>NewTimer</span>(<span style=color:#ae81ff>10</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span><span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>timer</span>.<span style=color:#a6e22e>C</span>:
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>slog</span>.<span style=color:#a6e22e>Debug</span>(<span style=color:#e6db74>&#34;expected to complete waiting, but occur timeout&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Wait</span>():
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>slog</span>.<span style=color:#a6e22e>Debug</span>(<span style=color:#e6db74>&#34;completed to wait&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>context.Done() に習って Wait() が channel を返すことで timer と組み合わせて、バッチ処理の中断を待たずに終了するといった制御もできる。後になってふりかえると、timer の制御も Wait() メソッドに入れてしまってもよい気もするが、それは呼び出し側の要件によって変わってくるからこのままの方がライブラリのコードの見通しがよくてよい気もする。朝から設計して、昼間に実装して夕方にテストを書いて、帰りの新幹線でアプリケーションに組み込みしていた。1日でちゃちゃっと作ったわりにはよく出来たと思う。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0925/>excel が utf-8 で保存する csv ファイルは bom 付き</a></h1><div class=post-meta><time class=post-date>2024-09-25</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/programming/>programming</a>&nbsp;
#<a href=/diary/tags/drink/>drink</a>&nbsp;
#<a href=/diary/tags/drinking/>drinking</a>&nbsp;</span><div class=post-content><p>昨日の定例会議で csv ファイルのエンコーディングの話しになって excel 2016 以降では utf-8 で csv ファイルを保存できるようになった。もう cp932 対応しなくてよいといった話題が出た。そのときにうろ覚えだったものの、excel は <a href=https://ja.wikipedia.org/wiki/%E3%83%90%E3%82%A4%E3%83%88%E9%A0%86%E3%83%9E%E3%83%BC%E3%82%AF>byte order mark (bom)</a> を付けていた気がして、実際にファイルを作ってもらったらそうだった。bom の有無は file コマンドや od コマンドでなどで調べられる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ file book1.csv
</span></span><span style=display:flex><span>book1.csv: Unicode text, UTF-8 <span style=color:#f92672>(</span>with BOM<span style=color:#f92672>)</span> text, with CRLF line terminators
</span></span></code></pre></div><p>ファイルの先頭に <code>0xef</code> <code>0xbb</code> <code>0xbf</code> の3バイトがつく。</p><pre tabindex=0><code>$ head -1 | od -t x1 book1.csv
0000000    ef  bb  bf  68  65  61  64  65  72  31  2c  68  65  61  64  65
0000020    72  32  2c  68  65  61  64  65  72  33  2c  68  65  61  64  65
...
</code></pre><p>印字可能な文字ではないため、テキストにするとわからないが、byte 列だと bom が付いているのがわかる。16進数の 0x68 が &lsquo;h&rsquo; になる。bom がついていると <code>header1</code> という文字列比較したときに別の文字列になってしまうので取り除かないといけない。</p><pre tabindex=0><code>文字列: &#39;header1&#39;
byte列: &#39;efbbbf68656164657231&#39;
</code></pre><p>いろんな対応方法があると思うが、<a href=https://stackoverflow.com/questions/21371673/reading-files-with-a-bom-in-go/76023436#76023436>so の回答</a> でみつけたこの方法がコードの見通しもよくて気に入った。次のように io.Reader をラップするようなコードになる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>newBOMAwaredCSVReader</span>(<span style=color:#a6e22e>reader</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>Reader</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>csv</span>.<span style=color:#a6e22e>Reader</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>transformer</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>unicode</span>.<span style=color:#a6e22e>BOMOverride</span>(<span style=color:#a6e22e>encoding</span>.<span style=color:#a6e22e>Nop</span>.<span style=color:#a6e22e>NewDecoder</span>())
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>csv</span>.<span style=color:#a6e22e>NewReader</span>(<span style=color:#a6e22e>transform</span>.<span style=color:#a6e22e>NewReader</span>(<span style=color:#a6e22e>reader</span>, <span style=color:#a6e22e>transformer</span>))
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><a href=https://pkg.go.dev/golang.org/x/text@v0.18.0/transform#Transformer>Transformer</a> という仕組みがあって、準標準ライブラリの golang.org/x/text/encoding で実装されている。so の回答をみただけでコードを追加するのもよくないかと思って <a href=https://pkg.go.dev/golang.org/x/text/encoding/unicode#BOMOverride>unicode#BOMOverride</a> が返す bomOverride transformer のコードを読んで把握した上でテストを書いてマージリクエストを送った。実際の変換処理は次のようなもの。</p><ul><li>fallback として <code>encoding.Nop</code> を使う<ul><li>ソースの byte 列をそのまま使う (実際には変換しない)</li><li><a href=https://pkg.go.dev/golang.org/x/text/encoding#Encoding>https://pkg.go.dev/golang.org/x/text/encoding#Encoding</a></li></ul></li><li>最初に呼ばれたときに d.current (fallback) をセットして、2回目以降は fallback が呼ばれる</li><li>与えられた byte 列が 2byte 以上のときに bom のチェックを行う</li><li>bom があるときはそのバイト数を読み飛ばして d.current (fallback) で変換する</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>d</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>bomOverride</span>) <span style=color:#a6e22e>Transform</span>(<span style=color:#a6e22e>dst</span>, <span style=color:#a6e22e>src</span> []<span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>atEOF</span> <span style=color:#66d9ef>bool</span>) (<span style=color:#a6e22e>nDst</span>, <span style=color:#a6e22e>nSrc</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>current</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>current</span>.<span style=color:#a6e22e>Transform</span>(<span style=color:#a6e22e>dst</span>, <span style=color:#a6e22e>src</span>, <span style=color:#a6e22e>atEOF</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>src</span>) &lt; <span style=color:#ae81ff>3</span> <span style=color:#f92672>&amp;&amp;</span> !<span style=color:#a6e22e>atEOF</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>transform</span>.<span style=color:#a6e22e>ErrShortSrc</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>current</span> = <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>fallback</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>bomSize</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>src</span>) <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>2</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>src</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>==</span> <span style=color:#ae81ff>0xFF</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>src</span>[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>==</span> <span style=color:#ae81ff>0xFE</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>current</span> = <span style=color:#a6e22e>utf16le</span>.<span style=color:#a6e22e>NewDecoder</span>()
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>bomSize</span> = <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>src</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>==</span> <span style=color:#ae81ff>0xFE</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>src</span>[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>==</span> <span style=color:#ae81ff>0xFF</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>current</span> = <span style=color:#a6e22e>utf16be</span>.<span style=color:#a6e22e>NewDecoder</span>()
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>bomSize</span> = <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>src</span>) <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>3</span> <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>src</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>==</span> <span style=color:#a6e22e>utf8BOM</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>src</span>[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>==</span> <span style=color:#a6e22e>utf8BOM</span>[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>src</span>[<span style=color:#ae81ff>2</span>] <span style=color:#f92672>==</span> <span style=color:#a6e22e>utf8BOM</span>[<span style=color:#ae81ff>2</span>] {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>current</span> = <span style=color:#a6e22e>transform</span>.<span style=color:#a6e22e>Nop</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>bomSize</span> = <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>bomSize</span> &lt; len(<span style=color:#a6e22e>src</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>nDst</span>, <span style=color:#a6e22e>nSrc</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>current</span>.<span style=color:#a6e22e>Transform</span>(<span style=color:#a6e22e>dst</span>, <span style=color:#a6e22e>src</span>[<span style=color:#a6e22e>bomSize</span>:], <span style=color:#a6e22e>atEOF</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>nDst</span>, <span style=color:#a6e22e>nSrc</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>bomSize</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>自分で実装してもなにも難しくないけど、すでに実績のあるコードがあるならそれを再利用した方が保守コストを削減できる。</p><h2 id=同期飲み会>同期飲み会</h2><p>新卒入社した会社の同期との飲み会。<a href=/diary/posts/2024/0730/#同期との飲み会>2ヶ月前と同じメンバー</a> で飲んできた。4人で飲む予定が、また1人が障害対応でドタキャンになったから3人で飲んでた。<a href=https://sake-genkabar.com/>日本酒原価酒蔵</a> という、おいしい日本酒を原価で提供するお店があるみたい。プレミアム飲み放題プランだったのでよいお酒をいろいろ飲み比べできた。どれもおいしかったし、ちょっとずついろいろ飲み比べできておもしろかった。飲み放題メニューに神戸のお酒がなかったのがよいことなのか残念なのか。前半は辛口の日本酒を飲んで、だんだん酔っ払って味がわからなくなるから、後半にコクや甘みの強い日本酒を飲むとおいしく飲めると教えてもらった。本当にその通りで日本酒の飲み方のよい勉強になった。お店で飲んだお酒のカードがもらえる。酔っ払って忘れてしまっても後で思い出せる。</p><figure><img src=/diary/img/2024/0925_sake.jpg></figure><p>特徴的なお酒で記憶に残っているもので <a href=https://miinokotobuki.com/>三井の寿</a> がスラムダンクに出てくる三井寿に由来して命名されていて、その背番号である14番と同じアルコード度数14度、日本酒度 (辛口甘口の度合いを表す) +14 と意図的？にあっているとのこと。日本酒の中ではトップクラスの辛口らしい。たしかに過去に私が飲んだことがないキレだった。もう1つは <a href=https://contents.thedann.com/entry/%E8%AE%83%E5%B2%90%E3%81%8F%E3%82%89%E3%81%86%E3%81%A7%E3%81%83%E3%81%AE%E6%97%A5%E6%9C%AC%E9%85%92%E3%82%92%E5%BE%B9%E5%BA%95%E8%A7%A3%E8%AA%AC>讃岐くらうでぃ</a> という、カルピスのような風味に近い珍しいお酒。甘いので後半に飲むとよい。うちらは酔っ払って訳がわからなくなってきたときに口直しのように飲んでた。そういう飲み方をするものかどうかはわからないが、飲みやすいのでついつい飲んでしまい、さらに酔ってしまう典型的なお酒。同期飲みは記憶をなくす感じで飲む。この歳になってこんな飲み方する相手いないなと思うとまた楽しい。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0919/>pipe による関心の分離</a></h1><div class=post-meta><time class=post-date>2024-09-19</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;
#<a href=/diary/tags/programming/>programming</a>&nbsp;</span><div class=post-content><p>go の <a href=https://pkg.go.dev/io#Pipe>Pipe</a> は go 言語プログラミングのよいところをいくつか同時に実感できる、実用度の高いユーティリティだと思う。go 言語は writer や reader をインターフェースとして定義している。細かいメソッドの違いでいくつかの writer/reader インターフェースを区別していたりもするが、基本的には write/read のメソッドをもっていればよい。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Writer</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Write</span>(<span style=color:#a6e22e>p</span> []<span style=color:#66d9ef>byte</span>) (<span style=color:#a6e22e>n</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Reader</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Read</span>(<span style=color:#a6e22e>p</span> []<span style=color:#66d9ef>byte</span>) (<span style=color:#a6e22e>n</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>この汎用的な writer/reader のインターフェースに従っていれば、さまざまな要件に対して抽象化ができる。オンメモリでデータを扱うこともあるし、OS のファイルシステム上のファイルとして扱うこともあるし、オブジェクトストレージ上のオブジェクトとして扱うこともある。そういった具象オブジェクトの如何によらず writer/reader のインターフェースに従うことでデータ処理とリソース管理を分離できる。これはプログラミングパラダイムにおける <a href=https://ja.wikipedia.org/wiki/%E9%96%A2%E5%BF%83%E3%81%AE%E5%88%86%E9%9B%A2>関心の分離</a> と呼ばれていることを実現する。</p><p>バッチ処理において複数データを読み込みながら処理を行い、処理中にエラーが発生したら、そのエラーデータを特定のファイルに書き込みしたい。エラーが発生したときだけ特定ファイルを生成する。そういった要件は次のように実装できる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>write</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>WriteCloser</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>	<span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>		if true {
</span></span></span><span style=display:flex><span><span style=color:#75715e>			return
</span></span></span><span style=display:flex><span><span style=color:#75715e>		}
</span></span></span><span style=display:flex><span><span style=color:#75715e>	*/</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>records</span> <span style=color:#f92672>:=</span> [][]<span style=color:#66d9ef>string</span>{
</span></span><span style=display:flex><span>		{<span style=color:#e6db74>&#34;first_name&#34;</span>, <span style=color:#e6db74>&#34;last_name&#34;</span>, <span style=color:#e6db74>&#34;username&#34;</span>},
</span></span><span style=display:flex><span>		{<span style=color:#e6db74>&#34;Rob&#34;</span>, <span style=color:#e6db74>&#34;Pike&#34;</span>, <span style=color:#e6db74>&#34;rob&#34;</span>},
</span></span><span style=display:flex><span>		{<span style=color:#e6db74>&#34;Ken&#34;</span>, <span style=color:#e6db74>&#34;Thompson&#34;</span>, <span style=color:#e6db74>&#34;ken&#34;</span>},
</span></span><span style=display:flex><span>		{<span style=color:#e6db74>&#34;Robert&#34;</span>, <span style=color:#e6db74>&#34;Griesemer&#34;</span>, <span style=color:#e6db74>&#34;gri&#34;</span>},
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>cw</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>csv</span>.<span style=color:#a6e22e>NewWriter</span>(<span style=color:#a6e22e>w</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>record</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>records</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>cw</span>.<span style=color:#a6e22e>Write</span>(<span style=color:#a6e22e>record</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatalln</span>(<span style=color:#e6db74>&#34;error writing record to csv:&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>cw</span>.<span style=color:#a6e22e>Flush</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>cw</span>.<span style=color:#a6e22e>Error</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>read</span>(<span style=color:#a6e22e>r</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>ReadCloser</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>rr</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bufio</span>.<span style=color:#a6e22e>NewReader</span>(<span style=color:#a6e22e>r</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>line</span>, <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rr</span>.<span style=color:#a6e22e>ReadLine</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>EOF</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>		writer, err := os.Create(&#34;./test.txt&#34;)
</span></span></span><span style=display:flex><span><span style=color:#75715e>		if err != nil {
</span></span></span><span style=display:flex><span><span style=color:#75715e>			log.Fatal(err)
</span></span></span><span style=display:flex><span><span style=color:#75715e>		}
</span></span></span><span style=display:flex><span><span style=color:#75715e>		defer writer.Close()
</span></span></span><span style=display:flex><span><span style=color:#75715e>	*/</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>writer</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Stdout</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>writer</span>.<span style=color:#a6e22e>Write</span>(append(<span style=color:#a6e22e>line</span>, []<span style=color:#66d9ef>byte</span>{<span style=color:#e6db74>&#39;\n&#39;</span>}<span style=color:#f92672>...</span>)); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>Copy</span>(<span style=color:#a6e22e>writer</span>, <span style=color:#a6e22e>rr</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>w</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>Pipe</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>write</span>(<span style=color:#a6e22e>w</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>read</span>(<span style=color:#a6e22e>r</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li><a href=https://go.dev/play/p/nI-vBAumtAk>https://go.dev/play/p/nI-vBAumtAk</a></li></ul><p>Pipe を使うことで読み込みの処理と書き込みの処理を分離できる。ここでいう読み込みはバッチ処理、書き込みはエラーデータの保存処理に相当する。普通に実装すると、バッチ処理中にエラーデータの保存処理も記述することになる。業務のコードだと本質ではないリソース管理が煩雑になってしまう。2つの処理に分割するため、どちらか一方は非同期で実行する必要がある。ここで goroutine のシンプルさが際立つ。さらに pipe を使えば、reader 側は writer が Close するまでブロックするから終了処理の同期も自然なコードで実現してくれる。</p><p>非同期／並行処理の難しいところを go のインターフェースによる抽象化、簡潔な goroutine 記法、pipe に隠蔽された自然な同期処理の3つで簡潔に表現している。複雑さに対してこれほど簡潔なコードはそうそうないと思う。このコードを他の言語で実装しようとしたらもっと複雑になるはず。このサンプルコードとともに若いメンバーにリソース管理のリファクタリングをコードレビューで指摘したものの、そのメンバーには理解できなくて実装できなかった。そして、その処理を私が作り直すことになったというのが、今日のお仕事だった。本当は難しい非同期／並行処理をいくら簡潔にしても、その経験がないと人間には理解できない。まさに本質的複雑さを表しているように思える。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0913/>責任を扱うコミュニケーションの在り方</a></h1><div class=post-meta><time class=post-date>2024-09-13</time></div><span class=post-tags>#<a href=/diary/tags/founding/>founding</a>&nbsp;
#<a href=/diary/tags/communication/>communication</a>&nbsp;
#<a href=/diary/tags/issue-management/>issue management</a>&nbsp;
#<a href=/diary/tags/business/>business</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/meta-programming/>meta programming</a>&nbsp;</span><div class=post-content><p>水曜日から継続していたメンバーのコードレビューをお昼頃に完了して、それからは自分の時間に集中して開発に取り組めた。途中、晩ご飯休憩もしながら翌2時頃までコードを書いていて issue を2つ fix した。</p><h2 id=隔週の雑談>隔週の雑談</h2><p>顧問のはらさんと隔週の打ち合わせ。ここ1-2ヶ月はあまり議題がなくて近況について雑談した。いまの開発フェーズが終わらないと、私が開発以外にリソースを割いていないので他のことに取り組む余裕はないかもしれない。開発プロジェクトにおける、議題の1つで次のインタビュー記事の内容について雑談した。</p><blockquote><p>責任をすぐに相手に投げてしまわないこと。責任をこちらで負えるように日頃から信頼貯金を貯めていくことが大事です。責任を負うこと自体はたいへんだけど、仕事は楽になるんです。</p><p>でも、人は責任を負いたくないと考えてしまうんですね。気持ちは分かりますよ、責任を負うのには胆力が必要ですから。そして責任を負いたくないから「いつまでですか？」と聞いてしまう。その途端、スケジュールを決めるのは相手の裁量になる。責任から降りて、自分から立場を下にして、受発注の関係にしてしまっています。</p><p><a href=https://findy-code.io/engineer-lab/naoya_ito>何が事業貢献なのか分からなくなっていた伊藤直也さんが再認識したユーザーエクスペリエンスへのコミット</a></p></blockquote><p>私自身、このインタビュー記事を読むまで相手に仕様や納期を決めてもらうことを、相手に責任を負わせるという視点をもっていないかった。しかし、その通りでもあると新たな気付きを得た記事でもあった。うちらはプログラマーという、システムを作る専門家なのでビジネス課題や解決したい業務課題について、その課題意識をもっている人 (ビジネスオーナー) から教えてもらうのを至極当然のように考えてしまう。そして、それ自体はいまの業務の在り方としてそうならざるを得ないところもある。</p><p>システム開発はそれぞれの専門職が分業によって行う。とくに規模が大きくなればそうなる。この構造そのものは一般的といえる。しかし、一緒にプロジェクトをやっていく働き方や考え方によってはその責任を分散させられるというのがこの記事に書いてあることだとわかる。そして、私自身これまで意識せずにそういった行動をいくらか取ってきているところもあり、それは「気付き」のレベルによって起こるものだとずっと考えていた。気付くからより多くの、より本質的な、より優れた改善のための行動ができる。そして、私の考え方も間違ってはいないと思うが、私は他人よりリスクを取りがちな性格があるから責任をこちらで負うという意識をあまりもっていなかった。つまり、私は自分の価値観でこうしたいと思って勝手にやっていたことを、別の見方では相手から責任を受け取って進めているという解釈もできる。</p><p>ちょうど <a href=/diary/posts/2024/0910/>兵庫県知事の百条委員会の答弁</a> もみていて感じたことだが、私はこういったコミュニケーションを本質的に好んでいない。自分の責任ではないという議論をしても、モノゴトは前に進まない。世間では百条委員会の後も知事の説明は十分ではなかったとみられている。その所以である。誰かが責任をもってモノゴトに取り組む必要がある。その責任の所在を明確にすることも大事ではあるが、自身の責任ではないという主張だけでは物足りなさを感じる。普段の業務においてもそういう姿勢やコミュニケーションを取る人が少なからずいる。はらさんの経験でもその点においては同意していた。よくある状況だと思える。自身に責任を負うことをためらわないコミュニケーションを取る人とそうではない人の2通りがあるのだと気付いた。そして、私は後者の人とコミュニケーションを続けていると疲弊したり苛々したりすることがある。それゆえに私自身も結果に対して潔くあろうと努めるし、潔い人たちとウマがあうのだろうともわかってきた。</p><p>課題管理の文脈においては、コミュニケーションのやり取りから責任の綱引きがどのような場所でどのぐらい起きるのか。人間であれば読み取れるが、ai はその意図を解釈できるか。そういった業務の責任という概念を見える化することに意味はあるかもしれない。責任の押し付け合い、または責任分散、本質的にどうあるべきだったかをなんらかの指標をもって数値化できればおもしろいのではないかと思えた。</p><h2 id=go-における簡単な式の評価>go における簡単な式の評価</h2><p>テスト自動化のツールを作っていて、テストデータでちょっとした式の評価をやりたくて調べたらまさに次の記事で解決した。</p><ul><li><a href=https://qiita.com/tenntenn/items/590caa61b9701d2ada23>もっと楽して式の評価器を作る</a></li></ul><p>この記事では <code>go/types</code> パッケージに定数や式の評価を行う機能がその使い方が紹介されている。簡単に使える。ふとサードパーティのパッケージならどうなるんだろう？とインターネットを検索したものの、自分ではみつけられなかった。chatgpt に問い合わせたら次のようなコードを紹介してくれた。そして、たしかにほとんどは正しくて意図したように動いた。次のコードでは http フレームワークの echo の定数を参照している。types.Package を生成するためのモジュールの読み込み方法について標準ライブラリはそのためのユーティリティが用意されているが、サードパーティのパッケージは用意されていなかった。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;go/token&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;go/types&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;golang.org/x/tools/go/packages&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>eval</span>(<span style=color:#a6e22e>expr</span> <span style=color:#66d9ef>string</span>) (<span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>TypeAndValue</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>cfg</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>packages</span>.<span style=color:#a6e22e>Config</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Mode</span>: <span style=color:#a6e22e>packages</span>.<span style=color:#a6e22e>NeedTypes</span> | <span style=color:#a6e22e>packages</span>.<span style=color:#a6e22e>NeedImports</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Fset</span>: <span style=color:#a6e22e>token</span>.<span style=color:#a6e22e>NewFileSet</span>(),
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>pkgs</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>packages</span>.<span style=color:#a6e22e>Load</span>(<span style=color:#a6e22e>cfg</span>, <span style=color:#e6db74>&#34;github.com/labstack/echo/v4&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>TypeAndValue</span>{}, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>pkgs</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>pkgs</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>Types</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>TypeAndValue</span>{}, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to load echo package&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mainPkg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>NewPackage</span>(<span style=color:#e6db74>&#34;main&#34;</span>, <span style=color:#e6db74>&#34;main&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mainPkg</span>.<span style=color:#a6e22e>Scope</span>().<span style=color:#a6e22e>Insert</span>(<span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>NewPkgName</span>(<span style=color:#a6e22e>token</span>.<span style=color:#a6e22e>NoPos</span>, <span style=color:#a6e22e>mainPkg</span>, <span style=color:#e6db74>&#34;echo&#34;</span>, <span style=color:#a6e22e>pkgs</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>Types</span>))
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>Eval</span>(
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>cfg</span>.<span style=color:#a6e22e>Fset</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>mainPkg</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>token</span>.<span style=color:#a6e22e>NoPos</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>expr</span>,
</span></span><span style=display:flex><span>	)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>このコードで expr に次のように echo の定数を指定するとその値を参照できる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>MIMEApplicationJSON</span>
</span></span></code></pre></div><p>動的型付けのノリで関数も実行できたりするのかな？と試してみたら (当たり前だが) できなかった。chatgpt になぜ関数実行できないかを尋ねたら次であるとのこと。静的型付けのコードを実行するには、本来コンパイルしないといけないのだから式の評価よりもずっとやることがある。</p><blockquote><p>packages.Load を使用してサードパーティパッケージをインポートできているにもかかわらず、expr からそのパッケージの関数を呼び出しても結果が取得できない原因は、go/types パッケージがサポートしているのは、型や定数のチェック、構文解析、式の評価であって、関数の実行そのものはサポートされていないためです。</p><p>go/types の Eval 関数はあくまでコンパイル時の型検査や式の評価を行うもので <strong>関数の実行や実行時の評価 (ランタイムの処理)</strong> は行いません。これは、Eval が式を評価して型と値を返すだけであり、動的な関数の実行などはできないためです。</p></blockquote></div></article><div class=pagination><div class=pagination__buttons><a href=/diary/tags/go/page/2/ class="button next"><span class=button__text>過去の日記</span>
<span class=button__icon>→</span></a></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2025 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>