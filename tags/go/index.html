<!doctype html><html lang=en><head><title>Go :: </title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/tags/go/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="Go"><meta property="og:description" content><meta property="og:url" content="/diary/tags/go/"><meta property="og:site_name" content><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/tags/go/index.xml rel=alternate type=application/rss+xml title></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><h1>Posts for: #Go</h1><div class=posts><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0824/>multipart/form-data リクエストの扱い</a></h1><div class=post-meta><time class=post-date>2024-08-24</time></div><span class=post-tags>#<a href=/diary/tags/health/>health</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/testing/>testing</a>&nbsp;</span><div class=post-content><p>9時に起きて2度寝して10時頃に起きたものの、お昼までだらだらしていた。それからオフィスへ行って溜まっていた日記をまとめて書いて、<a href=https://nigewaka.run/>逃げ上手の若君</a> をみながら作業をしていた。来週は出張の週だから事前にやっておくことがいくつかある。</p><h2 id=ストレッチ>ストレッチ</h2><p><a href=/diary/posts/2024/0817/>先週は実家へ帰っていた</a> ために2週間ぶりのストレッチになる。とはいっても、いまは運動をしているので筋肉痛もない。しかし、机に向かってデスクワークする時間が増えている分の負荷がかかっている。トレーナーさんからも腰から背中にかけて硬いと指摘された。今日は硬くなっているカラダ全体をほぐしてもらった感じだった。おかげで今後も体調よく机に向かえる。今日の開脚幅は開始前149cmで、ストレッチ後155cmと普段通りの数値だった。</p><h2 id=multipartform-data-リクエストを扱う結合テスト>multipart/form-data リクエストを扱う結合テスト</h2><p>昨日の夜に汎用のファイル操作の api を実装した。今日はその結合テストを追加してマージリクエストを作成した。multipart/form-data のリクエストを作るのはちょっと面倒くさい。go のライブラリのテストコードや stackoverflow のサンプルコードなどを調べながら自分で実装した。次のような multipart/form-data リクエストを扱う writer や buffer を生成するためのユーティリティを作る。一通りの結合テストを実装するのに3時間ほどかかった。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>createMultiPartFormData</span>(
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fileBody</span> []<span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>formField</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>,
</span></span><span style=display:flex><span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>multipart</span>.<span style=color:#a6e22e>Writer</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>Buffer</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>b</span> <span style=color:#f92672>:=</span> new(<span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>Buffer</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mw</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>multipart</span>.<span style=color:#a6e22e>NewWriter</span>(<span style=color:#a6e22e>b</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>k</span>, <span style=color:#a6e22e>v</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>formField</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fw</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>mw</span>.<span style=color:#a6e22e>CreateFormField</span>(<span style=color:#a6e22e>k</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>b</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fw</span>.<span style=color:#a6e22e>Write</span>([]byte(<span style=color:#a6e22e>v</span>)); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>b</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fw</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>mw</span>.<span style=color:#a6e22e>CreateFormFile</span>(<span style=color:#e6db74>&#34;file&#34;</span>, <span style=color:#e6db74>&#34;path/to/file&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>b</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fw</span>.<span style=color:#a6e22e>Write</span>(<span style=color:#a6e22e>fileBody</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>b</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>mw</span>.<span style=color:#a6e22e>Close</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>b</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>mw</span>, <span style=color:#a6e22e>b</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>このユーティリティを使って http リクエストのテストデータを生成するのは次のようなコードになる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>u</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>url</span>.<span style=color:#a6e22e>URL</span>{
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Scheme</span>: <span style=color:#e6db74>&#34;http&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Host</span>:   <span style=color:#e6db74>&#34;localhost&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Path</span>:   <span style=color:#a6e22e>path</span>,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>mw</span>, <span style=color:#a6e22e>body</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>createMultiPartFormData</span>(<span style=color:#a6e22e>fileBody</span>, <span style=color:#a6e22e>formField</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to create multipart form data: %s&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>NewRequest</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>MethodPost</span>, <span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>String</span>(), <span style=color:#a6e22e>body</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;http create new request error. err: %s&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>Header</span>.<span style=color:#a6e22e>Set</span>(<span style=color:#e6db74>&#34;Content-Type&#34;</span>, <span style=color:#a6e22e>mw</span>.<span style=color:#a6e22e>FormDataContentType</span>())
</span></span></code></pre></div><p>あと結合テストでファイルをアップロードすると実際にファイルシステム上に保存されてしまうのでそれらを削除するには <a href=https://pkg.go.dev/testing#T.Cleanup>Cleanup</a> を使うと簡単に後始末できた。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>TestFileUpload</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Cleanup</span>(<span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>RemoveAll</span>(<span style=color:#a6e22e>file</span>.<span style=color:#a6e22e>FilesDir</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to remove files directory: %s&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0822/>ファイルアップロードのインターフェース</a></h1><div class=post-meta><time class=post-date>2024-08-22</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/programming/>programming</a>&nbsp;</span><div class=post-content><p>今日も昼間は普通にお仕事で開発して、お仕事を終えて晩ごはんを買い出しへ行ってきて、オフィスで晩ごはんを食べてから夜のコーディングに戻るといった一日になった。昼間は会議や問い合わせ対応、他のメンバーの進捗をチェックしたりなど、ちょくちょく割り込みが入る。夜はそれらがないことがわかっているので3-4時間集中してコーディングできる。</p><h2 id=echo-のファイルアップロードのサンプル>echo のファイルアップロードのサンプル</h2><p>メンバーがファイルを受け渡しする web api のインターフェースがよくわからないということで私がサンプルを作ってみることにした。echo には <a href=https://echo.labstack.com/docs/cookbook/file-upload>File Upload</a> のサンプルも紹介されているからすぐにできる。歴史的にブラウザからのファイルアップロードを前提にすると、ファイルを扱うときは次の Content-Type を使う。</p><pre tabindex=0><code>Content-Type: multipart/form-data
</code></pre><p>これを echo のコードで書くと次のようなインターフェースとなる。￼</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>MyRequest</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Type</span>      <span style=color:#66d9ef>string</span>    <span style=color:#e6db74>`form:&#34;type&#34; validate:&#34;required&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Operation</span> <span style=color:#66d9ef>string</span>    <span style=color:#e6db74>`form:&#34;operation&#34; validate:&#34;required&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>handle</span>(<span style=color:#a6e22e>c</span> <span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>req</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>MyRequest</span>{}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Bind</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>req</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Validate</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>req</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>file</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>FormFile</span>(<span style=color:#e6db74>&#34;file&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>Is</span>(<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ErrMissingFile</span>) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>NewHTTPError</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusBadRequest</span>, <span style=color:#e6db74>&#34;file is required&#34;</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span></code></pre></div><p>ファイル情報を MyRequest で管理できるとリクエストパラメーターを一元管理できて望ましいが、次の issue によると現時点ではそれはできないらしい。</p><ul><li><a href=https://github.com/labstack/echo/issues/2672>Bind file from multipart/form-data request #2672</a></li></ul><p>curl コマンドでリクエストするには次のような cli になる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -i -X POST -F type<span style=color:#f92672>=</span>misc -F operation<span style=color:#f92672>=</span>add -F file<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;@myfile.data&#34;</span> ...
</span></span></code></pre></div></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0816/>go の iterator 実装へのリファクタリング</a></h1><div class=post-meta><time class=post-date>2024-08-16</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;
#<a href=/diary/tags/mongodb/>mongodb</a>&nbsp;</span><div class=post-content><h2 id=mongo-go-driver-を使った-go-の-iterator-実装>mongo-go-driver を使った go の iterator 実装</h2><p>先日 <a href=https://go.dev/blog/go1.23>go 1.23</a> がリリースされた。このバージョンの目玉機能の1つに <a href=https://go.dev/wiki/RangefuncExperiment>range-over function iterators</a> がある。簡潔に言えば、ユーザー定義のイテレーターを言語機能の仕組みを使って簡単に実装できる。ある制約を満たして関数を実装すれば、for 文の range 構文を使ってイテレーターとして扱える。ユーザー定義のイテレーターを実装するのが、ほとんど関数を実装するだけで出来てしまうので実装の難易度が減ったと言える。どんなコードかをみるには次のチュートリアルがわかりやすいと思う。</p><ul><li><a href=https://future-architect.github.io/articles/20240718a/>Go 1.23リリース連載 range over funcとiterパッケージ</a></li></ul><p>昨日で私が抱えていたプロジェクトのボトルネックを解消できた。ここからはボーナスステージで相対的に自由に開発できる。手始めにプロダクトの依存バージョンを go 1.23 へアップグレードして mongodb からの fetch 処理をイテレーターに置き換えるリファクタリングをした。アプリケーションからみたら mongodb は Store という generic なインターフェースを定義していて、そこに Iter() メソッドを追加した。mongodb のコレクションは必ず Iter() メソッドを実装しなければいけないという制約を課す。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Store</span>[<span style=color:#a6e22e>T</span> <span style=color:#a6e22e>any</span>] <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Iter</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>query</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>Query</span>, <span style=color:#a6e22e>opt</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sort</span>.<span style=color:#a6e22e>Option</span>) <span style=color:#a6e22e>iter</span>.<span style=color:#a6e22e>Seq2</span>[<span style=color:#f92672>*</span><span style=color:#a6e22e>T</span>, <span style=color:#66d9ef>error</span>]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><a href=https://github.com/mongodb/mongo-go-driver>mongo-go-driver</a> はもともと cursor でイテレーター機能を提供しているため、これを range-over function iterators を使ってアプリケーションから使えるように間をつなげてあげればよい。具体的には generics を使って次のような汎用の iter() メソッドを mongodb client に実装する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>client</span>[<span style=color:#a6e22e>R</span>, <span style=color:#a6e22e>E</span>]) <span style=color:#a6e22e>iter</span>(
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>name</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>filters</span> <span style=color:#a6e22e>queryFilters</span>, <span style=color:#a6e22e>sortOpt</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sort</span>.<span style=color:#a6e22e>Option</span>,
</span></span><span style=display:flex><span>) <span style=color:#a6e22e>iter</span>.<span style=color:#a6e22e>Seq2</span>[<span style=color:#f92672>*</span><span style=color:#a6e22e>E</span>, <span style=color:#66d9ef>error</span>] {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>toEntity</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		panic(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;require toEntity() function&#34;</span>))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>yield</span> <span style=color:#66d9ef>func</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>E</span>, <span style=color:#66d9ef>error</span>) <span style=color:#66d9ef>bool</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>collection</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>raw</span>.<span style=color:#a6e22e>Database</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>db</span>).<span style=color:#a6e22e>Collection</span>(<span style=color:#a6e22e>name</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>opts</span> <span style=color:#f92672>:=</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>FindOptions</span>{}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sortOpt</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>opt</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>Find</span>().<span style=color:#a6e22e>SetSort</span>(<span style=color:#a6e22e>makeSortSet</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>sortOpt</span>))
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>opts</span> = append(<span style=color:#a6e22e>opts</span>, <span style=color:#a6e22e>opt</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>cursor</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>collection</span>.<span style=color:#a6e22e>Find</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>filters</span>, <span style=color:#a6e22e>opts</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>yield</span>(<span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>cursor</span>.<span style=color:#a6e22e>Close</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>cursor</span>.<span style=color:#a6e22e>Next</span>(<span style=color:#a6e22e>ctx</span>) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>result</span> <span style=color:#a6e22e>R</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>cursor</span>.<span style=color:#a6e22e>Decode</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>result</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>yield</span>(<span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>yield</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>toEntity</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>result</span>), <span style=color:#66d9ef>nil</span>) {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>cursor</span>.<span style=color:#a6e22e>Err</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>yield</span>(<span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Store インターフェースを満たすコレクションの実装は次のように型チェックのためのメソッド実装をもてばよい。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>MyCollection</span>) <span style=color:#a6e22e>Iter</span>(
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>query</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>Query</span>, <span style=color:#a6e22e>opts</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sort</span>.<span style=color:#a6e22e>Option</span>,
</span></span><span style=display:flex><span>) <span style=color:#a6e22e>iter</span>.<span style=color:#a6e22e>Seq2</span>[<span style=color:#f92672>*</span><span style=color:#a6e22e>entry</span>.<span style=color:#a6e22e>MyEntity</span>, <span style=color:#66d9ef>error</span>] {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>iter</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>makeFilters</span>(<span style=color:#a6e22e>query</span>), <span style=color:#a6e22e>opts</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>朝から iterator 実装の試行錯誤や使い方の勘どころを確かめながら、これも1日でほとんどリファクタリングして移行できた。python のジェネレーターもそうだけど、関数をイテレーターにできると直感的にわかりやすく簡潔に実装できる。すごくよい機能だと思う。1.23 以降の go のコードはイテレーターを使うよう、大きく変わっていくと思われる。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0805/>サーバーの拡張とフックポイント</a></h1><div class=post-meta><time class=post-date>2024-08-05</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;
#<a href=/diary/tags/economy-investing/>economy investing</a>&nbsp;</span><div class=post-content><p>今日は東京株式市場の歴史的な急落もあっていろいろ経済ニュースを読んでいた。</p><h2 id=echo-の-custom-binding>echo の Custom Binding</h2><p>echo で開発していて気に入っているところの1つに、サーバーサイドの、ここをカスタマイズしたいという箇所にちゃんと拡張するためのフックが用意されているというのがある。例えば、リクエストデータとサーバー内部で使う構造体を紐付ける bind 処理もデフォルトの仕組みを拡張する <a href=https://echo.labstack.com/docs/binding#custom-binding>Custom Binding</a> が提供されている。</p><p>Echo 構造体の値に Binder というフィールドがあり、カスタマイズしたい処理を実装した Binder インターフェースの値をセットする。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>e</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>New</span>()
</span></span><span style=display:flex><span><span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>Binder</span> = <span style=color:#a6e22e>binder</span>.<span style=color:#a6e22e>New</span>()
</span></span></code></pre></div><p>Binder はリクエスト構造体の値と echo.Context の値を受け取る <code>Bind()</code> メソッドを実装する。基本的には echo.DefaultBinder を適用した後にカスタマイズしたい bind 処理を実装すればよいと思う。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Binder</span> <span style=color:#66d9ef>struct</span>{}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>b</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Binder</span>) <span style=color:#a6e22e>Bind</span>(<span style=color:#a6e22e>i</span> <span style=color:#a6e22e>any</span>, <span style=color:#a6e22e>c</span> <span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>defaultBinder</span> <span style=color:#f92672>:=</span> new(<span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>DefaultBinder</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>defaultBinder</span>.<span style=color:#a6e22e>Bind</span>(<span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>c</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>req</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>i</span>.(<span style=color:#66d9ef>type</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>myRequest</span>:
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>BindSomething</span>(<span style=color:#a6e22e>c</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>New</span>() <span style=color:#f92672>*</span><span style=color:#a6e22e>Binder</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>Binder</span>{}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>bind 処理をどう実装するかはいろいろやり方があると思うが、echo.Context の値を渡せるので request 構造体にその実装を隠蔽するというのもいいんじゃないかと思う。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>myRequest</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>myRequest</span>) <span style=color:#a6e22e>UnmarshalJSON</span>(<span style=color:#a6e22e>data</span> []<span style=color:#66d9ef>byte</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Alias</span> <span style=color:#a6e22e>myRequest</span> 
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Unmarshal</span>(<span style=color:#a6e22e>data</span>, (<span style=color:#f92672>*</span><span style=color:#a6e22e>Alias</span>)(<span style=color:#a6e22e>r</span>)); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to unmarshal ids request: %s&#34;</span>, <span style=color:#a6e22e>data</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>    <span style=color:#75715e>// implement custom validation
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>myRequest</span>) <span style=color:#a6e22e>BindSomething</span>(<span style=color:#a6e22e>c</span> <span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// implement custom binding
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=日経平均株価の歴史的な急落>日経平均株価の歴史的な急落</h2><p><a href=/diary/posts/2024/0802/#日経平均株価の急落>金曜日から2日連続</a> で株価指数が 5% 超も下落するのは世界的にも珍しいらしい。</p><ul><li><a href=https://www3.nhk.or.jp/news/html/20240805/k10014537281000.html>株価 過去最大の値下がり ブラックマンデー超え“4つの要因”</a></li></ul><blockquote class=twitter-tweet><p lang=ja dir=ltr>◆ CNBCトップに<br>「日経平均 急落」がCNBCやFTでもトップニュースになっています。2日連続で株価指数が5%超も下落するのは世界的にも珍しいことです。<br>ナスダック先物は2%超の値下がりしています <a href=https://t.co/YGuNKzEdT2>https://t.co/YGuNKzEdT2</a> <a href=https://t.co/CcB2XoycPd>pic.twitter.com/CcB2XoycPd</a></p>&mdash; 後藤達也 (@goto_finance) <a href="https://twitter.com/goto_finance/status/1820280069119783135?ref_src=twsrc%5Etfw">August 5, 2024</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script><p>金曜日に史上2番目の下落幅という見出しでメディアでは煽られていて、下落幅と下落率は違うからそんな不安に感じなくてよいと楽観していたら、今日は史上2番目の下落率 (-12.40%) となった。さらにストップ安になっている銘柄が相次いでいるから実体はもっと悪いと考えられるとのこと。一方でリーマンショックのような、金融機関が破綻しているような状況でもなく、実体経済が傷んでないのに売りが売りを呼ぶ急落になっているので今後どうなるのかはよく分からない。明日も下がるのか、反発するのか、誰にもわからない (素人はしばらく何もしない方がよい) 。注目していた任天堂の株価も -16.53% と日経平均株価以上に急落している。これだけ落ちると、信用取引の追証が2営業日以内となるため、任天堂は明後日「投げ売り」されてもう少し下がる可能性もあるかもしれない。いずれにしても、私は今週いっぱいぐらいかけて空売りの返済をしていく。買うときも売るときも一度に行うのではなく、タイミングや数量を分割してならしていく。</p><p>株価の急落について私の記憶にあるのは、2016年の米大統領選挙でトランプ氏が初当選したとき、2020年にコロナが流行り始めたときを思い出した。たまたまだけど、4年に1回は急落がやってきている。2016年も2020年もとくになにもせず私は見守っていただけだった。しかし、今回は事前にポートフォリオを見直したり、空売りでリスクヘッジしていたりと急落の場面にも対応できた。以前よりは経済の背景を学んで資産運用の行動に反映できるようになってきた。これは経営においてもよいことだと思う。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0616/>初めてのオープンチャット運営</a></h1><div class=post-meta><time class=post-date>2024-06-16</time></div><span class=post-tags>#<a href=/diary/tags/event/>event</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/study/>study</a>&nbsp;
#<a href=/diary/tags/exercise/>exercise</a>&nbsp;
#<a href=/diary/tags/community/>community</a>&nbsp;</span><div class=post-content><p>週末にかけて体調を崩していたのと土日のイベント参加で疲れてしまったのか、ゆっくり休日を過ごしていた。</p><h2 id=イテレーターの復習>イテレーターの復習</h2><p><a href=https://kyotogo.connpass.com/event/321871/>Kyoto.go remote #51 Go Conference 2024 復習会</a> にオンラインで参加した。物理的に京都へ行くのは時間／お金のコストがかかるのでオンラインはありがたい。discord で自己紹介したり、グループディスカッションしたりといった軽い勉強会だった。<a href=/diary/posts/2024/0608/#久しぶりのオフラインカンファレンス>先日参加したカンファレンス</a> で聞いた発表を復習して、周りのメンバーに共有するといった取り組みだった。終わったら周りの人に共有するという制度設計をすることで目の前の課題に集中して取り組みやすいことが、複数の勉強会に参加して私自身もよくわかってきた。ただもくもく会で自分が勉強するだけでは足りないのだ。学習の時間が終わったら後で伝えないといけない、まとめないといけない、そのためには自分が理解しないといけない、こういった制約を人それぞれの無理のない範囲で作っていくことが大事なのだ。</p><h2 id=line-のオープンチャット開設>line のオープンチャット開設</h2><p>近所の体育館を借りて来月からいくつか予定が組まれている。その予約した日が近付いてきて実際にメンバーを確保できるかどうかがわからない。体育館は4ヶ月前に抽選申込みをして日程が決定される。抽選という仕組み上、メンバーを確定して日程が決まるのではなく、日程が決まってからメンバーを探すことになる。先週から三宮.devの運動部や雑談チャンネルで軽く呼びかけてみたが、反応がよくないので普通には参加者を集めるのは無理そう。そこで外部からも参加者を募れるように line のオープンチャットを作ってみた。すぐにはオープンチャットのサイトで検索してもまだ検索結果に出てこない。</p><ul><li><a href="https://line.me/ti/g2/sR0gckI1Y20FdOwkfdfuPp7ZdIz7cMJKO_6EKA?utm_source=invitation&utm_medium=link_copy&utm_campaign=default">バドミントン初心者向け@神戸三宮</a></li></ul><p>すでにメンバーが8人になった。4人は私の知人ではあるけれど、知人の知人で3人新たに関心をもつメンバーを迎い入れることができた。体育館のスペースとしては4-6人来ればよい。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0608/>オフラインカンファレンスへの参加</a></h1><div class=post-meta><time class=post-date>2024-06-08</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/event/>event</a>&nbsp;
#<a href=/diary/tags/packaging/>packaging</a>&nbsp;
#<a href=/diary/tags/health/>health</a>&nbsp;</span><div class=post-content><p>今日の運動は腹筋ローラー,腕立て,スクワット,散歩,ハンドグリップをした。統計を <a href="https://docs.google.com/spreadsheets/d/1bg85QtM-LciUgey8I79uI7vW2PEwsP6TVdeIRVkACBg/edit?usp=sharing">運動の記録</a> にまとめる。</p><p>神戸に戻ってきてから軽く公園へ行って運動しようと思っていたら22時頃から雨降りで行けなかった。オフィスで事務作業や片付けなどをしていた。</p><h2 id=久しぶりのオフラインカンファレンス>久しぶりのオフラインカンファレンス</h2><p>たまたま出張の週末にかさなっていたので <a href=https://gocon.jp/2024/>Go Conference 2024</a> に参加してきた。いつもはオンライン参加していたが、今回はオフラインでしかやらないという。朝ホテルでのんびりしていたら時間がぎりぎりになってしまって、10時半からの tenntenn さんの発表が始まる10分前ぐらいに会場へ着いた。時間的にはちょうどよかった。次の 1.23 でリリース予定のイテレーターについての話しを聞いた。さすがのクォリティだったと思う。</p><ul><li><a href="https://docs.google.com/presentation/d/1oY8pIpcB9t0C7siyQvj-ha5PLHTP_pdD-LA9uL2CaTU/edit?usp=sharing">イテレータによってGoはどう変わるのか</a></li></ul><p>python の generator に近い概念のようにみえる。まだ自分でイテレーターを実装したことがないので seq 関数というのがちょっと腹落ちしていない。お手伝い先の次の開発フェーズで 1.23 にアップデートするだろうからそのときにいろいろ試してみることになると思う。イテレーターは重要な概念なのでチーム勉強会などでメンバーとしっかり情報共有してもよいかもしれない。</p><p>他の発表もどれもレベルが高くておもしろかったのだが、私が関心をもったものを1つあげると go module のバージョン管理の仕組みの解説が勉強になった。</p><ul><li><a href="https://docs.google.com/presentation/d/1X5dXShWTmjhQbXH7vXHnTLJ5Tca7QhU4Pq1YugGiIHs/edit#slide=id.p">試してわかるGo ModulesとMinimal Version Selection</a></li></ul><p>依存先のモジュールのどのバージョンを使うかを決定するアルゴリズムを Minimal Version Selection (MVS) と呼ぶ。ライブラリをアップデートする経緯によってはサードパーティライブラリのバージョンの組み合わせは一意に決定されないという振る舞いを、あまり意識する機会はないだろうけれど、開発者として知っておく必要がある。</p><h2 id=過去の人間ドックの結果>過去の人間ドックの結果</h2><p><a href=/diary/posts/2024/0603/#過去の健康診断の記録>月曜日に手配しておいた</a> 5年前の人間ドックの結果の冊子が届いていた。5年前の時点で体重は80kgあったことがわかった。それからコロナ禍になって一気に90kgまで太ってしまったようにみえる。これでスプレッドシートに過去の健康診断の数値はプロットできた。5年前までの数値を見比べてみると、体重は10kgぐらいの幅で増えたり減ったりしているものの、血液検査や他の内蔵の数値などはあまり変化がないようにみえる。あとは今回の結果が送られてくるのを待つのみ。楽しみ。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0525/>5年ぶりの健康診断</a></h1><div class=post-meta><time class=post-date>2024-05-25</time></div><span class=post-tags>#<a href=/diary/tags/health/>health</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/event/>event</a>&nbsp;
#<a href=/diary/tags/community/>community</a>&nbsp;
#<a href=/diary/tags/facilitation/>facilitation</a>&nbsp;</span><div class=post-content><p>今日の運動は腹筋ローラー,散歩をした。統計を <a href="https://docs.google.com/spreadsheets/d/1bg85QtM-LciUgey8I79uI7vW2PEwsP6TVdeIRVkACBg/edit?usp=sharing">運動の記録</a> にまとめる。</p><h2 id=健康診断>健康診断</h2><p>昨日は早く寝たのもあり、5-6時には起きていたと思う。朝ご飯も食べられないから朝食を作る必要もなく、暇なので7時頃には家を出てゆっくり歩いて <a href=https://www.kobe-mariners.or.jp/>神戸マリナーズ厚生会病院</a> へ向かった。受付は9時からだったものの、8時頃には病院へ着いてしまい、待ち合いスペースでそのまま本を読んでいた。病院だから (おそらく) 24時間開いているのかな？8時でも受け付けは閉まっているものの、警備員や当直のスタッフはいるので待ち合いスペースを案内してもらってそこで待っていればよいと教えてもらった。</p><p>待ち名簿に一番上に名前を書いておいたので一番先に受け付けして健康診断を開始。私の他には数人ぐらいしかいなかった。これなら早く終わるかな？と思ったものの、検査の合間合間の待ち時間がやや長く、それらが積み重なって11時頃に完了した。土曜日だから病院側のスタッフも少なかったのかもしれない。あるいは私が一般検診 + 付加検診を申し込みして項目が多かったせいかもしれない。最後は私と2人ぐらいしか残っていなかった。他の人たちは1時間ほどで完了していたようだ。久しぶりでバリウム飲めるか不安だったけれど一回でクリアできた。だいぶ慣れたのか、歳をとって感覚器官が鈍くなって気持ち悪さがよくわからなくなったのかもしれない。最後に医師の診察をうけて、いくつか聴診をして、諸々の検査の結果はそれぞれの専門医師がみて判断すると聞いただけだった。初めて行った病院だったけど、余裕をもって検査してくれてよいところだったと思う。次回の健康診断もこの病院でよいなと思った。</p><p>一般検診 + 付加検診で診察料は 7,971円 (税込) だった。役員1人だけの会社は健康診断のお金が経費にならないのでこれは個人負担となる。</p><h2 id=go-のイベント>go のイベント</h2><p>健康診断を終えてから <a href=https://umedago.connpass.com/event/316604/>Kansai.go #1</a> へ行ってきた。ちょっと遅れて行った。<a href=https://ja.wikipedia.org/wiki/%E5%A4%A7%E9%98%AA%E6%A2%85%E7%94%B0%E3%83%84%E3%82%A4%E3%83%B3%E3%82%BF%E3%83%AF%E3%83%BC%E3%82%BA%E3%83%BB%E3%83%8E%E3%83%BC%E3%82%B9>大阪梅田ツインタワーズ・ノース</a> にあるサイボウズのオフィスをお借りしての開催だった。聞いたことないビルだと思ったら2022年4月に梅田阪急ビルからビル名が変わったらしい。サイボウズさんの若手の方がスポンサーセッションをされていた。見た目20代半ばから後半ぐらいの方かな？発表を終えて、私がいたテーブルに来られたので後でグループワークすることにもなる。その後、LT が6人続いて <a href=https://tech.smartcamp.co.jp/entry/introduce-lean-coffee>リーンコーヒー</a> という取り組みを行った。私はリーンコーヒーという会議形式をやったことがなかったので新鮮ではあった。ブレストのもうちょっと緩い会議みたいな雰囲気。テーブルにいるメンバーで付箋に関心のあるトピックを書き出して、みんなのを集めて、ファシリテーターが関心の高そうなトピックを選択してそれについてみんなで意見を言い合うみたいな流れだった。7-8つほど付箋に書いたトピックがあって、いろいろな話題について1時間ほど4人でわいわい話し合って楽しかった。テーブルが6つあったのかな？他の所も盛り上がっているようにはみえた。オンラインではなく、オフラインイベントでしかできないことの1つは複数のミーティングを一度に実施できる点がある。オフラインの価値を活かす施策の1つにリーンコーヒーはよい企画のように思えた。</p><p>余談だけど、うちのテーブルの開発者はみんなスキルが高くて他言語と go の比較の議論が盛り上がった。4人中2人が rust も勉強していて rust と go の比較の話しも聞けた。学習コストは高いものの、go で満足できない言語機能が気になったら rust がよいと2人とも話されていた。しかし、rust を書ける開発者は少ないから会社の業務で取り組むなら開発者を確保できるか、既存の社員も rust を勉強するかといった意思決定はいるという話しもあった。sns のタイムラインをみていると、開発者の大半が rust の勉強をしているようにみえてしまうが、現実の会社で普通に働く開発者は rust なんか難しくてできなかったり、個人の趣味で勉強したりしていない。コミュニティイベントへ行っているとそういうところでみんな rust 勉強しているんだと勘違いしてしまう。サイボウズさんのスポンサーセッションをされていた若い開発者がめっちゃ優秀でこんな若手がいたらマネージャーとして楽しいやろなと思えた。さすがサイボウズさん。その子が <a href=https://www.oreilly.co.jp//books/9784814400065/>ソフトウェアアーキテクチャ・ハードパーツ</a> がよいとお勧めしていたのでいつか読んでみたいと思う。</p><p>kyoto.go と kansai.go へお出掛けして少しずつ知り合いが増えてきた。次は kobe.go かな。うちの会社のプロダクト開発は go を採用すると決めているので go のコミュニティとも密接にやっていきたい。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0428/>1日を通して歩きまくった日</a></h1><div class=post-meta><time class=post-date>2024-04-28</time></div><span class=post-tags>#<a href=/diary/tags/founding/>founding</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/event/>event</a>&nbsp;
#<a href=/diary/tags/kobe/>kobe</a>&nbsp;
</span><img src=/diary/img/2024/0428_port-tower.jpg class=post-cover alt=1日を通して歩きまくった日 title="Cover Image"><div class=post-content><p>今日の運動は散歩をした。統計を <a href="https://docs.google.com/spreadsheets/d/1bg85QtM-LciUgey8I79uI7vW2PEwsP6TVdeIRVkACBg/edit?usp=sharing">運動の記録</a> にまとめる。</p><h2 id=オフィスの書類整理>オフィスの書類整理</h2><p>午前中はいろいろ不要なものを捨てたり書類のファイリングをしていた。法人決算の申告書類やその年度の保管書類などもクリアブックにまとめた。個人の書類と会社の書類がオフィスの机の上で散乱していて、過去にはそれが <a href=/diary/posts/2024/0322/#公正証書の正本を紛失する>公正証書の正本を紛失する</a> ことにもつながった。少し片付いたものの、まだ個人の書類をどう片付けてよいかの結論が出ていない。自宅に置くのもよいが、書類を扱う事務作業をオフィスでやることが多いため、個人の書類もオフィスにある方が効率だけ考えたら都合がよい。GW のお休み中にオフィスの書架の整理などもしたい。</p><h2 id=lt-発表>LT 発表</h2><p>午後から <a href=https://kyotogo.connpass.com/event/313309/>Kyoto.go #50 オフラインLT会</a> に参加するため、京都へ行ってきた。会場は <a href=https://www.hankyu.co.jp/station/karasuma.html>阪急烏丸駅</a> 近くにある、はてな社だった。行きは JR + 市営地下鉄 (1時間9分)、帰りは阪急 (1時間10分) で帰ってきた。阪急でも十三乗り換えで1時間10分と、JR で京都へ行くのと総合的にはほとんど時間が変わらないことに気付いた。京都って行きにくい場所だと常々思っていたが、こんなルートもあるのだと、実際に行ってみてたまたま阪急烏丸駅をみつけて発見があった。</p><p>イベントは LT 大会だったのでいろいろな方の発表を聞きつつ、私も遠出したので会社として発表しつつ、たかさごさんやおおなかさんといった、初対面ながら話してみたいと考えていた方々とも少しお話しができてよかった。京都にははてな社やマネーフォワード社、LINE など著名な web 企業がこういった勉強会を開催していて、そこに集まる参加者のレベルも神戸より高いように感じた。神戸には著名な IT 企業がないというのが、こういったテックイベントの参加者層の厚さに相関があるようにも思う。なぜ私が京都のイベントに出張っているのかがその所以か。</p><iframe class=speakerdeck-iframe frameborder=0 src=https://speakerdeck.com/player/6ea2c040a85f44ef8a47737e042ad841 title="Try creating your own orderedmap" allowfullscreen style="border:0;background:padding-box padding-box rgba(0,0,0,.1);margin:0;padding:0;border-radius:6px;box-shadow:rgba(0,0,0,.2)0 5px 40px;width:600px;height:auto;aspect-ratio:560/315" data-ratio=1.7777777777777777></iframe><h2 id=神戸ポートタワー>神戸ポートタワー</h2><p>夕方に京都から戻ってきてその足で <a href=https://www.kobe-port-tower.com/>神戸ポートタワー</a> へ行ってきた。リニューアルしたばかりで屋上デッキというものが新たに作られた。神戸のシンボルの1つではあるのでお客さんがきたときの観光に使えるかどうかを検証してきた。展望フロアへ上がるためのエレベーターに乗るのが20-30分ほど、展望5Fから屋上デッキへ上がる階段に30分ほど並んだ。リニューアルしたばかりなのでこのぐらいの混雑は仕方ないと言えよう。ポートタワー自体が狭い建物なので展望スペース、エレベーター、階段すべて2人がすれ違う程度の幅しかなく、そんなに多くのお客さんがいるわけでもないにも関わらず、その狭さゆえに窮屈さを感じる。展望フロア + 屋上デッキの2つのセットで入場料は1200円／人になる。値段は高くも安くもないかな。混雑度にもよるが、1-2時間もあれば上って下りてくるぐらいの所要時間になる。</p><p>屋上デッキは周囲をぐるっとみて回れるだけで真ん中の方はタワーのアンテナのような設備があってかなり狭い。屋根がない分の開放感はあってよいが、それほど展望5Fから眺める感覚と展望デッキから眺める感覚に違いはなかった。想像していたよりも屋上デッキはしょぼかった。タワーへ行ったおまけ程度のもので屋上デッキを期待していくような場所ではない。展望3Fがカフェ & バーとして外を眺めながら椅子に座ってくつろげるスペースになっている。とは言ってもタワー内なので狭いため、長時間居座るような場所でもない。この場所がタワーの中で一番ゆっくりできる場所にみえる。</p><p>全体の所感としては、気分転換に展望3Fのカフェ&バーへ行ってみるというのは非日常の空間を演出するとう意図でおもしろいかもしれない。年間パスポートは4,000円なので1回あたりの入場チケットが1,200円であることを考えると4回行けばもとを取れる。十分に安いので地元の応援として購入してみるのもよいかもしれない。一方でゲスト向けに期待値をあげていくとタワー体験はややしょぼい気はする。ゲストに先入観をあまりもたせず、近くに来たついでに立ち寄ってみようといった程度で行くと楽しめると思う。</p><h3 id=リファレンス>リファレンス</h3><ul><li><a href=https://www.city.kobe.lg.jp/a02564/838199248653.html>神戸港のシンボル「神戸ポートタワー」2024年４月26日リニューアルオープン決定!!　～神戸ウォーターフロント再開発事業～</a></li><li><a href=https://kobe-note.jp/n/nf223e99e1b86>生まれ変わった神戸ポートタワー、回転展望フロアも健在！</a></li></ul></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0422/>テンパった開発状況</a></h1><div class=post-meta><time class=post-date>2024-04-22</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;
#<a href=/diary/tags/github/>github</a>&nbsp;
#<a href=/diary/tags/ci/cd/>ci/cd</a>&nbsp;</span><div class=post-content><p>今日の運動は腹筋ローラー,スクワットをした。統計を <a href="https://docs.google.com/spreadsheets/d/1bg85QtM-LciUgey8I79uI7vW2PEwsP6TVdeIRVkACBg/edit?usp=sharing">運動の記録</a> にまとめる。</p><h2 id=開発がなかなか進まない>開発がなかなか進まない</h2><p>本当は次の開発課題に着手しないといけないところだが、先週からずっと新機能のための、既存コードのリファクタリングに時間を費やしている。データ構造を変えたり、主キーを変えたりしているので影響範囲が大きくて、テストコードもあちこち修正しないといけなくて時間がかかる。結合テストの実行そのものにも時間がかかるし。</p><p>なかなか開発がテンパっているものの、今日でようやく一通りのリファクタリングを完了して、意図していた新機能のための web api が動くところまで確認できた。なんというか、新機能を作るために既存コードの改善に8割の時間を費やした感じ。おかげで新機能はなにも開発していないのに勝手に動いた (違) ような気持ちになった。今後、同様に個別データの拡張や新たなデータ追加のときは既存データに影響を与えず、独立して追加しやすい設計となっている。将来的に私がいなくなった後に拡張するときにこの設計は役に立つだろうと思う。</p><h2 id=awesome-go-へ道>awesome-go へ道</h2><p><a href=/diary/posts/2024/0421/#kyotogo-の資料づくり>昨日の続き</a> 。contribution guidelines を読んでいて最低限やれと書いてあることの1つに <a href=https://goreportcard.com/report/github.com/kazamori/orderedmap>Go Report Card report</a> を作れと書いてあった。これは静的解析したスコアのようなものが表示される。すべて100%が表示されるようにした。</p><p>カバレッジも測れとあったので github actions の <a href=https://github.com/kazamori/orderedmap/blob/main/.github/workflows/go.yml>workflow ファイル</a> を設定して計測してみた。63.9 % といまいちだった。コアなところしかテスト書いてないからかな。ユーティリティや cli のテストもちゃんと書いたら 80-90% ぐらいはいくのかな？また後日、時間のあるときにやってみる。余談だけど、久しぶりに github actions を触ったらもうワークフローファイルの文法とか覚えてなくてずっと触ってないとすぐ忘れるとか思ったりもした。</p><blockquote><p>if the library/program is testable, then coverage should be >= 80% for non-data-related packages and >=90% for data-related packages. (Note: the tests will be reviewed too. We will check your coverage manually if your package&rsquo;s coverage is just a benchmark result);</p><p><a href=https://github.com/avelino/awesome-go/blob/main/CONTRIBUTING.md#quality-standards>Quality standards</a></p></blockquote></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0421/>来週の資料づくり</a></h1><div class=post-meta><time class=post-date>2024-04-21</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/review/>review</a>&nbsp;
#<a href=/diary/tags/device/>device</a>&nbsp;</span><div class=post-content><p>今日の運動は腕立て,スクワットをした。統計を <a href="https://docs.google.com/spreadsheets/d/1bg85QtM-LciUgey8I79uI7vW2PEwsP6TVdeIRVkACBg/edit?usp=sharing">運動の記録</a> にまとめる。</p><p>外では神戸まつりやっていたけど、1日中雨降りだったからとくに見に行くこともしなかった。</p><h2 id=kyotogo-の資料づくり>kyoto.go の資料づくり</h2><p>前日の深夜2時頃までかけて資料を作った。社内 slack でレビュー依頼を出して帰ったら2時半頃にこみやさんがレビューしてくれてた。こみやさん夜型やなぁ。朝起きてから家事を済ませて、お昼前にオフィスへ行ってレビューで指摘してくれた内容の修正をしていた。なんやらかんやらでスライドも2-3枚増やして指摘前よりわかりやすくなったと思う。他者にレビューしてもらえると、自分だけの視点では気付かなかったところの示唆を受けて改善できる。レビューしてくれる存在のありがたさ。いつか本当に <a href=/diary/posts/2023/1206/>レビューサービス</a> を作るかもしれない。</p><p>こみやさんと話していて、私はライブラリを探すときに <a href=https://github.com/avelino/awesome-go>avelino/awesome-go</a> の話題になった。私はこのリストを参照することが多いのだけど、<a href=https://github.com/ake-persson/mapslice-json>mapslice-json</a> は実用的に使えるライブラリではないのにここにリストされていておかしいなということに気付いた。このリストを更新する PR を送るべきだなと思って <a href=https://github.com/avelino/awesome-go/blob/main/CONTRIBUTING.md>contribution guidelines</a> を読んでみることにした。</p><h2 id=macbook-air-2013-mid-の再インストール>macbook air (2013-mid) の再インストール</h2><p>古いマシンを処分しようと思ってオフィスにもってきた。もう1つの macbook は故障していて起動しない。試しに電源につないで起動させてみたらこっちは起動した。</p><figure><img src=/diary/img/2024/0421_macbook.jpg></figure><p>処分するにしてもデータは全部消したいと思って os の再インストールのようなことができないかを調べていた。最近の macos にはその機能がある。この macbook では <a href="https://apps.apple.com/us/app/macos-catalina/id1466841314?mt=12">macOS Catalina</a> までアップデートできるが、その os では再インストールのようなことはできないみたい。facebook にそんなことを書いていたら知人から <a href=https://chromeenterprise.google/intl/ja_jp/os/chromeosflex/>ChromeOS Flex</a> をインストールすればいいんじゃない？とコメントをもらって、それはいいなと思ってやってみようと思う。ChromeOS ならタブレットの代替のような用途に使えるかもしれない。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0410/>go の generics に慣れてきた</a></h1><div class=post-meta><time class=post-date>2024-04-10</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;
#<a href=/diary/tags/programming/>programming</a>&nbsp;</span><div class=post-content><p>今日の運動は腹筋ローラー,スクワット,縄跳び(両足跳)をした。統計を <a href="https://docs.google.com/spreadsheets/d/1bg85QtM-LciUgey8I79uI7vW2PEwsP6TVdeIRVkACBg/edit?usp=sharing">運動の記録</a> にまとめる。</p><h2 id=go-の-generics-の扱い>go の generics の扱い</h2><p>今日はほぼまる一日コードを書いていた。あるデータ型のリファクタリングをしていて次のような constraint とメソッドの組み合わせで型チェックできることを理解した。generics 使って1年以上開発しているので感覚的にも慣れてきた。User と Group のどちらかを受け取る constraint とそのデータストアの定義は次のようになる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>UserOrGroup</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>User</span> | <span style=color:#a6e22e>Group</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>GetPrimaryID</span>() <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>UserOrGroupStore</span>[<span style=color:#a6e22e>E</span> <span style=color:#a6e22e>UserOrGroup</span>] <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>generic</span>.<span style=color:#a6e22e>Store</span>[<span style=color:#a6e22e>E</span>]
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>FindByPrimaryID</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>primaryID</span> <span style=color:#66d9ef>string</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>E</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>この型定義を使う関数では次のようになる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>find</span>[
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>E</span> <span style=color:#a6e22e>entry</span>.<span style=color:#a6e22e>UserOrGroup</span>,
</span></span><span style=display:flex><span>](
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>store</span> <span style=color:#a6e22e>entry</span>.<span style=color:#a6e22e>UserOrGroupStore</span>[<span style=color:#a6e22e>E</span>], <span style=color:#a6e22e>primaryID</span> <span style=color:#66d9ef>string</span>,
</span></span><span style=display:flex><span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>E</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>e</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>store</span>.<span style=color:#a6e22e>FindByPrimaryID</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>primaryID</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ee</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>e</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ee.PrimaryID はコンパイルが通らない
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>ee</span>.<span style=color:#a6e22e>GetPrimaryID</span>() <span style=color:#75715e>// 現時点ではメソッド呼び出しが必要
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>ここで UserOrGroup に <code>GetPrimaryID()</code> というメソッドを追加している。本来は両方の構造体に保持するメンバー属性ではあるものの、現時点の go のコンパイラはメンバー属性を正しくチェックできない。そのため、メソッドにして generics の型チェックが正しく通るようにしないといけない。go の issue にも上がっているのでいずれはメンバー属性を解決できるようになるのだろうと推測する。</p><ul><li><a href=https://github.com/golang/go/issues/48522>proposal: spec: permit referring to a field shared by all elements of a type set #48522</a><ul><li><a href=https://github.com/golang/go/issues/63940>spec: investigate if we can remove (most or all) needs for the concept of a core type #63940</a></li></ul></li></ul></div></article><div class=pagination><div class=pagination__buttons><a href=/diary/tags/go/page/2/ class="button next"><span class=button__text>過去の日記</span>
<span class=button__icon>→</span></a></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2024 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>