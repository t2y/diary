<!doctype html><html lang=en><head><title>go :: forest nook</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/tags/go/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="go"><meta property="og:description" content><meta property="og:url" content="/diary/tags/go/"><meta property="og:site_name" content="forest nook"><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/tags/go/index.xml rel=alternate type=application/rss+xml title="forest nook"></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><div class=posts><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0327/>docker/compose のモジュールの使い方がわかってきた</a></h1><div class=post-meta><time class=post-date>2023-03-27 (Mon.) ::</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/docker/>docker</a>&nbsp;
#<a href=/diary/tags/cli/>cli</a>&nbsp;</span><div class=post-content><p>0時に寝て7時に起きた。前日はバテてだらだらしていたので寝過ぎた。</p><h2 id=案ずるよりもツールできた>案ずるよりもツールできた</h2><p>先週末に <a href=/diary/posts/2023/0324/>docker/compose 関連のライブラリ調査</a> を終えて実際のツール作りをしていた。本当は日曜日に作ってしまおうと思いつつ休んでしまった。なぜか今日はメンバーが全員お休みでチームで私しか働いていなかった。年度末で有休消化しているのかな？問い合わせ対応やメンバーのサポートが不要だったので1日中、自分の開発に集中できた。そして開発に集中できた結果、一通りツールの機能の開発を終えられた。火曜日までには仕上げたいと思っていたのでぎりぎり間に合った。</p><p>最終的に testcontainers-go の compose モジュールを使うのは断念して compose cli のみ go 標準の <a href=https://pkg.go.dev/os/exec>os/exec</a> パッケージを使ってプロセスを fork するようにした。また docker image をコンテナレジストリから取得するときに認証が必要な場合、最初の <a href=https://docs.docker.com/engine/reference/commandline/login/>docker login</a> すると credentials store にパスワード (またはトークン) 情報が記録される。設定情報は <code>$HOME/.docker/config.json</code> からも確認できる。この仕組みを使ってコンテナレジストリへのログインを自動化できる。私の環境では macbook に docker desktop をインストールしているが、普通に使っていると次のように credentials が保存されてその内容を確認できる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ docker-credential-desktop list | jq .
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;https://index.docker.io/v1/&#34;</span>: <span style=color:#e6db74>&#34;t2y1979&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;https://index.docker.io/v1/access-token&#34;</span>: <span style=color:#e6db74>&#34;t2y1979&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;https://index.docker.io/v1/refresh-token&#34;</span>: <span style=color:#e6db74>&#34;t2y1979&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>$ echo <span style=color:#e6db74>&#34;https://index.docker.io/v1/access-token&#34;</span> | docker-credential-desktop get
</span></span><span style=display:flex><span><span style=color:#f92672>{</span><span style=color:#e6db74>&#34;ServerURL&#34;</span>:<span style=color:#e6db74>&#34;https://index.docker.io/v1/access-token&#34;</span>,<span style=color:#e6db74>&#34;Username&#34;</span>:<span style=color:#e6db74>&#34;t2y1979&#34;</span>,<span style=color:#e6db74>&#34;Secret&#34;</span>:<span style=color:#e6db74>&#34;***&#34;</span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>これと同じことを docker のライブラリで行うには次のようにする。取得したい docker image の uri を参照すればコンテナレジストリがわかる。そこからこの cli でやっているようなことを順番にやっていけばよい。これらのユーティリティは3つのリポジトリで管理されていて、この雰囲気をみただけでもこのモジュール分割が本当に適切なんやろか？とか思ったりもする。</p><ul><li><a href=https://github.com/distribution/distribution>https://github.com/distribution/distribution</a></li><li><a href=https://github.com/docker/cli>https://github.com/docker/cli</a></li><li><a href=https://github.com/moby/moby>https://github.com/moby/moby</a></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>getRegistryAuthFromImage</span>(
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>imageURI</span> <span style=color:#66d9ef>string</span>,
</span></span><span style=display:flex><span>) (<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ref</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>reference</span>.<span style=color:#a6e22e>ParseNormalizedNamed</span>(<span style=color:#a6e22e>imageURI</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to parse image uri: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>repo</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>ParseRepositoryInfo</span>(<span style=color:#a6e22e>ref</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to parse repository: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>dcli</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>command</span>.<span style=color:#a6e22e>NewDockerCli</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to create docker cli: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>auth</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>command</span>.<span style=color:#a6e22e>ResolveAuthConfig</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>dcli</span>, <span style=color:#a6e22e>repo</span>.<span style=color:#a6e22e>Index</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>encoded</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>command</span>.<span style=color:#a6e22e>EncodeAuthToBase64</span>(<span style=color:#a6e22e>auth</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to encode auth: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>encoded</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0322/>プライベートリポジトリの go アプリケーションの依存解決</a></h1><div class=post-meta><time class=post-date>2023-03-22 (Wed.) ::</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/ci/cd/>ci/cd</a>&nbsp;
#<a href=/diary/tags/coworking/>coworking</a>&nbsp;
#<a href=/diary/tags/event/>event</a>&nbsp;</span><div class=post-content><p>0時に寝て6時半に起きた。面倒なお仕事を朝から集中して片づけた。</p><h2 id=gomod-のプライベートリポジトリの依存解決>go.mod のプライベートリポジトリの依存解決</h2><p>非公開のプライベートリポジトリで開発している go アプリケーションを他のリポジトリから依存ライブラリとして使う方法を調べた。go modules は基本的に公開されたパブリックなリポジトリを前提としている。go.mod のワークフローで他の依存ライブラリと同様にバージョン管理ができるようにするには、プライベートリポジトリであることを go.mod に認識させ、トークンなどを使って認証する必要がある。</p><p><a href=https://go.dev/doc/go1.13>go 1.13</a> から <code>GOPROXY</code> と <code>GOPRIVATE</code> という環境変数が追加された。デフォルトでは GOPROXY は <a href=https://proxy.golang.org>https://proxy.golang.org</a> に設定されており、このプロキシサーバー経由で依存ライブラリを取得する。これは公開リポジトリを、ある日、作者が急に削除したり非公開にしたときにビルドできないといった問題を防ぐために依存ライブラリのリポジトリをキャッシュしてくれる役割を担っている。</p><p>一方でインターネット上のプロキシサーバーからはプライベートリポジトリへアクセスできないので <code>GOPRIVATE</code> を設定してアクセスできないサイトを go.mod へ教えてあげる必要がある。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ go env -w GOPRIVATE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;private.repo.jp&#34;</span>
</span></span><span style=display:flex><span>$ go env | grep GOPRIVATE
</span></span><span style=display:flex><span>GOPRIVATE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;private.repo.jp&#34;</span>
</span></span></code></pre></div><p>通常 go.mod は https で依存ライブラリをリポジトリから取得 (クローン) しようとする。このときに git の設定を変更することで特定のサイトへのアクセスを ssh 経由に変更できる。次の例では <code>https://private.repo.jp</code> へのアクセスをすべて <code>ssh://git@private.repo.jp</code> でクローンできる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ git config --global url.<span style=color:#e6db74>&#34;ssh://git@private.repo.jp&#34;</span>.insteadOf <span style=color:#e6db74>&#34;https://private.repo.jp&#34;</span><span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>$ tail -n <span style=color:#ae81ff>2</span> ~/.gitconfig
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>url <span style=color:#e6db74>&#34;ssh://git@gitlab.osstech.co.jp&#34;</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>        insteadOf <span style=color:#f92672>=</span> https://gitlab.osstech.co.jp
</span></span></code></pre></div><p>これで git リポジトリのクローンは ssh で行われるようになるが、go.mod のワークフローでは https でもアクセスする処理があるようにみえる。https でもアクセスできるように PAT などのトークンを取得して次のように <code>~/.netrc</code> に https でプライベートリポジトリへアクセスするための認証設定を追加する。</p><pre tabindex=0><code>machine private.repo.jp
login t2y 
password ${PERSONAL_ACCESS_TOKEN}
</code></pre><ul><li><a href=https://www.digitalocean.com/community/tutorials/how-to-use-a-private-go-module-in-your-own-project>How to Use a Private Go Module in Your Own Project</a></li><li><a href=https://erwinvaneyk.nl/private-repositories-with-go-mod/>How to use private repositories with Go modules</a></li></ul><h2 id=コワーキングのオンラインイベント>コワーキングのオンラインイベント</h2><p>月例のカフーツさんのオンラインイベントに参加した。<a href=/diary/posts/2023/0215/#コワーキングのオンラインイベント>先月の所感はここ</a> 。いとうさんの近況を把握していないが、どうやらバリ島 (インドネシア) のコワーキングスペースをいくつか訪問してきたらしい。その旅程を写真をみながらふりかえるようなイベントだった。バリ島の自然や建物の雰囲気が伺えてとてもおもしろかった。</p><p>いとうさんからバリ島はデジタルノマドの先進的な取り組みをしているように聞いていた。例えば <a href=https://cosmicalz.com/indonesianomadvisaunderconsideration>バリ島でリモートも可能!?インドネシアのノマドビザは最長5年を検討中</a> にあるように最長5年のビザを用意しているという話しが日本で盛り上がっているが、現地ではまだ正式にそのようなビザがあるようには存在が確認されていないらしい。それに近い長期のビザを取得するには、一定の金融資産があることを証明しないといけないらしく、日本円だと数千万円程度ないとビザを取得できないのではないか？といった話題もあったと思う。基本的にインドネシア政府は海外から金持ちを呼び込みたいらしく、金持ち向けに待遇のよいビザを整備するのではないかとのこと。ビザの話しはともかく、ここ2-3年でバリ島のコワーキングスペースもいくつか廃業しているらしい。それは利用者の大半が外国人であったため、コロナ禍により、インドネシア政府からの要請もあって外国人に帰国を促したという。外国人利用者の半分ぐらいが自分たちの国に帰ってしまい、施設の運用コストを維持できなくなった。バリ島は今後の成長が見込まれていることから数年前から外資が入ってきて土地や家賃が急騰しているために利用者が激減すると運用コストを維持できなくなったとのこと。</p><p>肝心のバリ島のコワーキングスペースの雰囲気を聞いていると、利用者は外国人が大半で、感覚的にはヨーロッパから来ている人が多そうだといとうさんが話された。バリ島のコワーキングスペースでいとうさんが見学していたときには、現地の人たちと外国人のコミュニティが活発に活動しているようにはあまりみえなかったらしい。利用者もそう多くはなかったし、その人たちも静かにただ作業しているだけのように映ったという。いとうさんはコワーキングスペースとはコミュニティやコラボレーションが重要という話しをよくしているけれど、バリ島のコワーキングスペースに関しては裕福な外国のデジタルノマドを呼び込むのに成功しただけのような、もしかしたらコロナ禍でそのコミュニティが破壊されてしまったのかもしれないが、普段このイベントで話しているような高い期待値に応えられるような状況ではないようにみえたという。</p><p>とはいえ、日本の田舎よりは遥かにデジタルノマドが集まる場所として世界的に認知されているところなので写真をみながら私もいつか行ってみたいと思えた。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0320/>リファクタリングにはまった</a></h1><div class=post-meta><time class=post-date>2023-03-20 (Mon.) ::</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/ldap/>ldap</a>&nbsp;</span><div class=post-content><p>2時に寝て変な夢をみて何度か起きて7時に起きた。いつも通りな感じ。</p><h2 id=go-のシリアライズデシリアライズとポインタ>go のシリアライズ/デシリアライズとポインタ</h2><p><a href=/diary/posts/2023/0306/#ldap-の-dn-の仕様>ldap の distinguished name (以下dn) をパース</a> するときはエスケープを扱う必要があるのでわりとややこしいのでライブラリを使った方がよいことを前回学んだ。</p><p>複数の web api で dn を扱っていると、それぞれで dn をパースして正規化した形で扱わないと大文字小文字の表記揺れなどに対応できなくて困るということに気付いた。いや、前回もうっすら気付いていたのだけど、既存の api はすべて対応しているからいいかなと楽観的に考えていた。すると、たまたま新規に dn を扱う web api を作ったときに正規化を忘れていることに気付いた。今後の保守や拡張を考慮すると、dn を <code>string</code> 型として扱うのは潜在的に正規化漏れの懸念があることからよくないと理解できた。そのため、既存のリクエストで受け取る dn を特別な型として必ず正規化して扱えるようにリファクタリングすることにした。あちこち直す必要はあったが、幸いにも単体テストも結合テストもそこそこあるのでバグっていればテストが落ちることで不具合には気付けるようになっていた。</p><p><a href=https://pkg.go.dev/encoding/json>encoding/json</a> に Marshaler/Unmarshaler のインターフェースが定義されているのでそれぞれのメソッドを実装する必要がある。DNParameter の値を json にシリアライズするときは値レシーバで MarshalJSON メソッドを実装し、デシリアライズするときはポインタレシーバで UnmarshalJSON メソッドを実装しないと json ライブラリで意図した振る舞いにならないようにみえる。ここで UnmarshalJSON するときに byte 列から一旦 json の文字列に変換 (引用符を外す) してから <code>ldap.ParseDN()</code> しないといけない処理を直接 <code>string</code> 型に変換する誤ったコードを書いてしまって、この誤りに気付くのに1-2時間はまってしまった。</p><ul><li>誤ったコード</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>DNParameter</span>) <span style=color:#a6e22e>UnmarshalJSON</span>(<span style=color:#a6e22e>data</span> []<span style=color:#66d9ef>byte</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>dn</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ldap</span>.<span style=color:#a6e22e>ParseDN</span>(string(<span style=color:#a6e22e>data</span>))
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		(<span style=color:#f92672>*</span><span style=color:#a6e22e>p</span>).<span style=color:#a6e22e>Value</span> = <span style=color:#a6e22e>dn</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span></code></pre></div><ul><li>正しいコード</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>DNParameter</span>) <span style=color:#a6e22e>UnmarshalJSON</span>(<span style=color:#a6e22e>data</span> []<span style=color:#66d9ef>byte</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>s</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Unmarshal</span>(<span style=color:#a6e22e>data</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>s</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;dn should be a string&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>dn</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ldap</span>.<span style=color:#a6e22e>ParseDN</span>(<span style=color:#a6e22e>s</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		(<span style=color:#f92672>*</span><span style=color:#a6e22e>p</span>).<span style=color:#a6e22e>Value</span> = <span style=color:#a6e22e>dn</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span></code></pre></div><p>このときに引用符を ldap のパーサーがエスケープした形で扱えてしまい、テストは失敗するけれど、見た目がほとんど同じ文字列で動いてしまうのにはまった。引用符がエスケープされてテストが落ちることには気付いたものの、どこの処理が問題なのかが分からなくてはまっていた。おそらくスクラッチからこの仕様でコードを書いていたらすぐに気付いたと思えるが、リファクタリングであちこち書き換えていたからどこの処理が誤っているのかの切り分けに時間がかかった。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0317/>syncrepl ことはじめ</a></h1><div class=post-meta><time class=post-date>2023-03-17 (Fri.) ::</time></div><span class=post-tags>#<a href=/diary/tags/ldap/>ldap</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;</span><div class=post-content><p>1時に寝て5時に起きて7時に起きた。</p><h2 id=openldap-の-syncrepl>openldap の syncrepl</h2><p>openldap サーバー同士のレプリケーションの仕組みとして syncrepl (LDAP Sync Replication) と呼ばれる仕組みがある。experimental ではあるものの、仕様は rfc で提案されていてオープンになっている。実際には openldap サーバー (slapd) で実装されている参照実装が仕様みたいなものかもしれない。</p><ul><li><a href=https://www.rfc-editor.org/rfc/rfc4533.html>rfc-4533</a></li><li><a href=https://www.openldap.org/doc/admin25/replication.html>18. Replication</a></li></ul><p>既存の java のアプリケーションで syncrepl の機能を使うツールがあって、ソースコードを読むとかなりレガシーで、もっと言うと設計はひどく、コードも推定バグのような実装をみかけるのであまり使いたくない。go-ldap で syncrepl できれば作り直してしまえばよいのではないかと考えている。ドキュメントには provider (master) と consumer (slave) という用語で説明されているので pubsub に近いような仕組みで実装されているのではないかと推測する。slapd は provider にも consumer にもなる可能性があるのでどちらの実装ももっている。私がやりたいことは更新エントリを取得したいだけなので go-ldap で consumer として振る舞うモジュールのみを作ればよい。</p><p>基本的には openldap サーバーに接続して bind して、syncrepl に準拠したやり取りをすればよいのでそんな難しそうにはみえない。いくつかの定型的な通信の実装をすれば consumer ができるのではないかと思う。go-ldap のソースを grep してみる分には特別な機能はなさそうにみえる。ないならないで私が作ってもいいし、このライブラリでやらない方がよい背景があるのであれば、それに従う。ひとまず背景がわかっていないので issue を立てて聞いてみた。</p><ul><li><a href=https://github.com/go-ldap/ldap/issues/422>About implementing syncrepl (rfc-4533) consumer #422</a></li></ul></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0316/>ポインタの学び直し、参照とは違う</a></h1><div class=post-meta><time class=post-date>2023-03-16 (Thu.) ::</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/programming/>programming</a>&nbsp;
#<a href=/diary/tags/event/>event</a>&nbsp;</span><div class=post-content><p>2時に寝て7時に起きた。深夜に葬送のフリーレン10巻を読んでからなんとなく眠れなくて夜更かししてた。木曜日は会議がなくて自分のために時間を使える。機能開発に集中して実装していた。</p><h2 id=go-の学び直し>go の学び直し</h2><p><a href=https://tenntenn.connpass.com/event/275805/>Gopher塾 #4 - 私も解説できるポインタ - DAY1</a> に参加した。</p><p>今日のテーマはポインタ。tenntenn さんが話すのだから深い内部実装の話しなどもあるのかな？と期待していたけれど、これは基本的な go のポインタの扱いを学ぶ講義だった。私にとっては9割は知っていることだった。それでも1割は知らないことがあったので参加して勉強にはなった。この歳になると本やイベントから1-2割学べたら十分だと思う。go は内部的にすべて値渡しで何でもコピーするするといった振る舞いをする。ポインタを渡すと、ポインタの値であるアドレスをコピーすることでプログラムが動く。コピーなので大きな構造体をそのまま渡すとその分のメモリのオーバーヘッドがあって遅くなったりする。ポインタならアドレスだけのコピーで済む。</p><p>go には参照の概念はないという説明があって、ポインタと参照は別の概念なんだと今更ながらに気付いた。gpt-4 にポインタと参照の違いを尋ねたりしていた。参照は初期化後に変更できなかったり、null を参照できなかったり、ポインタ演算のようなことができなかったりすることで安全にプログラミングするための言語機能と言える。一般的には参照はポインタを使って実装される。ポインタの方が低レイヤで制約が少ないと言える。参照はポインタの一部の機能を安全にプログラマーに提供していると言える。</p><p>次に go のポインタの特徴をまとめる。</p><ul><li>型付け<ul><li>ポインタは型付けされていて、特定の型の変数のアドレスだけがその型のポインタに割り当てられる</li></ul></li><li>アドレス演算子とデリファレンス演算子<ul><li>これらを単項演算子と呼ぶ</li><li>アドレス演算子 (&) で変数のアドレスを取得してポインタを作成する</li><li>デリファレンス演算子 (*) でポインタが指すアドレスに格納されている値にアクセスする</li></ul></li><li>ポインタ演算制限</li><li>ポインタ演算は許可されていない、メモリアクセスの誤りやセキュリティ上の問題が軽減される</li><li>new と make 関数<ul><li>new 関数を使うと指定された型の新しい変数を作成してそのアドレスを返す</li><li>make 関数は、スライス、マップ、チャネルなどの複合データ構造を作成および初期化して、それらへのポインタを返す</li></ul></li><li>ポインタの nil 値<ul><li>ポインタは、無効なアドレスを表す特別な値である nil をもてる</li><li>nil ポインタにアクセスしようとすると、実行時に panic が発生する</li></ul></li><li>メソッドレシーバとしてのポインタ<ul><li>メソッドレシーバとしてポインタを使うとメソッド内でレシーバオブジェクトの変更ができる<ul><li>値レシーバは意図せぬ不具合を招く可能性があるから基本的にはポインタレシーバを使う方がよいのではないかといった話しもあった</li></ul></li></ul></li></ul></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0315/>キャッシュ機構の導入</a></h1><div class=post-meta><time class=post-date>2023-03-15 (Wed.) ::</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/tech-selection/>tech selection</a>&nbsp;</span><div class=post-content><p>1時に寝て7時に起きた。リリース延期を決めたので3月末へのストレスやプレッシャーからは解放されていつもよりよく眠れた気がした。あくまで気がしただけ。</p><h2 id=キャッシュライブラリの選定>キャッシュライブラリの選定</h2><p>ある機能を作るための準備としてキャッシュ機構を作ることにした。<a href=https://github.com/avelino/awesome-go>avelino/awesome-go</a> を眺めて適当なキャッシュライブラリを選定する。シンプルな用途向け、オンメモリで goroutine-safe で保守されていて実績があるものでのバランスを取るときむらさんのキャッシュライブラリになった。</p><ul><li><a href=https://github.com/bluele/gcache>bluele/gcache</a></li></ul><p>ちょうどいまのお仕事を始める前に <a href=/diary/posts/2022/0920/#ブロックチェーンのお仕事の面談>スカウトをもらった会社</a> のテックリードがきむらさんだったので、いまはその会社にいるんだと思い出したのが半年前。きむらさんとはリアルで何年も会っていないし、仲がよいわけでもないけれど、なぜか facebook でも繋がっているので存在を忘れるということもない。</p><p>閑話休題。ある特定の mongodb コレクションのデータをキャッシュしたい。</p><p>キャッシュの生成。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>cache</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>gcache</span>.<span style=color:#a6e22e>New</span>(<span style=color:#ae81ff>128</span>).<span style=color:#a6e22e>Build</span>()
</span></span></code></pre></div><p>特定の用途で一部の処理だけ使いたいのでこんな感じでキャッシュの処理を実装した。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>value</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>cache</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>id</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>value</span>.(<span style=color:#f92672>*</span><span style=color:#a6e22e>myData</span>), <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>gcache</span>.<span style=color:#a6e22e>KeyNotFoundError</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#e6db74>&#34;failed to get value from cache&#34;</span>, <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>any</span>{
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;key&#34;</span>: <span style=color:#a6e22e>id</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;err&#34;</span>: <span style=color:#a6e22e>err</span>,
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 通常処理
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>cache</span>.<span style=color:#a6e22e>Set</span>(<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>setting</span>)
</span></span></code></pre></div><p>念のため、キャッシュをすべてクリアするときは次を呼ぶ。これをキャッシュ制御 api から呼び出せるようにしておく。何らかの理由やバグなどでキャッシュをクリアする必要もあるだろう。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>cache</span>.<span style=color:#a6e22e>Purge</span>()
</span></span></code></pre></div><p>データを削除したときは id 指定でキャッシュを削除する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>cache</span>.<span style=color:#a6e22e>Remove</span>(<span style=color:#a6e22e>id</span>)
</span></span></code></pre></div><p>キャッシュが使われているかどうかは内部的に統計を取っているのでそれをキャッシュ制御 api から取得することでわかる。
キャッシュが使われていれば HitCount が増え、mongodb にアクセスしていれば MissCount が増える。単体レベルでプログラムのデバッグにはなる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>return</span> <span style=color:#a6e22e>CacheStat</span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>HitCount</span>:    <span style=color:#a6e22e>cache</span>.<span style=color:#a6e22e>HitCount</span>(),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>MissCount</span>:   <span style=color:#a6e22e>cache</span>.<span style=color:#a6e22e>MissCount</span>(),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>LookupCount</span>: <span style=color:#a6e22e>cache</span>.<span style=color:#a6e22e>LookupCount</span>(),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>HitRate</span>:     <span style=color:#a6e22e>cache</span>.<span style=color:#a6e22e>HitRate</span>(),
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0308/>windows のサービス起動を go から制御する</a></h1><div class=post-meta><time class=post-date>2023-03-08 (Wed.) ::</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/windows/>windows</a>&nbsp;</span><div class=post-content><p>2時に寝て3回ほど起きて7時に起きた。淡々と自分の機能開発をしていた。ある処理が失敗したときにローカルのファイルシステムに暗号化して書き込み、定期的にそのディレクトリを監視してファイルがあれば読み込んで復号化してリトライをするといった仕組みを実装した。とくに難しくなくすぐにできた。</p><p>晩ご飯に <a href=https://tabelog.com/tokyo/A1316/A131603/13125103/>大衆酒場 PING (ピン)</a> というお店に行ってみた。1人でも入りやすく値段も安く食べ応えもあっても私のイメージする居酒屋さんの印象にぴったりでよかった。また出張したら行こうと思う。そろそろ出張でバテてきたので今日は夜にお仕事せずに晩ご飯食べてからもテレビをみながらだらだらしてた。</p><h2 id=windows-のサービス起動>windows のサービス起動</h2><p>準標準パッケージである <a href=https://pkg.go.dev/golang.org/x/sys/windows/svc/eventlog>golang.org/x/sys</a> パッケージを使ってアプリケーションの起動と停止をサービス管理画面から操作できるようにする。サンプルコードは次の場所にある。</p><ul><li><a href=https://github.com/golang/sys/tree/master/windows/svc/example>https://github.com/golang/sys/tree/master/windows/svc/example</a></li></ul><p>サービスから呼ばれたかどうかを判定をすることでエントリーポイントを切り替えられる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>inService</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>svc</span>.<span style=color:#a6e22e>IsWindowsService</span>()
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>inService</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>runService</span>(<span style=color:#a6e22e>serviceName</span>, <span style=color:#66d9ef>false</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#e6db74>&#34;failed to run service&#34;</span>, <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>any</span>{
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;err&#34;</span>: <span style=color:#a6e22e>err</span>,
</span></span><span style=display:flex><span>        })
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>そして、次のような <code>Execute()</code> メソッドをもつ windows サービスから呼ばれる構造体を定義して、そのメソッド内でサービス管理画面からのステータス変更に対応する状態遷移のコードを実装すればよい。ここではサービス開始してから stop/shutddown で停止するぐらいしか必要ないのでシンプルに実装した。一時停止や再開も必要ならもう少し複雑なコードになる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>myService</span> <span style=color:#66d9ef>struct</span>{}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>myService</span>) <span style=color:#a6e22e>Execute</span>(
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>args</span> []<span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>reqCh</span> <span style=color:#f92672>&lt;-</span><span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>svc</span>.<span style=color:#a6e22e>ChangeRequest</span>, <span style=color:#a6e22e>statusCh</span> <span style=color:#66d9ef>chan</span><span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>svc</span>.<span style=color:#a6e22e>Status</span>,
</span></span><span style=display:flex><span>) (<span style=color:#a6e22e>ssec</span> <span style=color:#66d9ef>bool</span>, <span style=color:#a6e22e>errno</span> <span style=color:#66d9ef>uint32</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>cancel</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>WithCancel</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>())
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ch</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>startMyService</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>getConfig</span>())
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>statusCh</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>svc</span>.<span style=color:#a6e22e>Status</span>{<span style=color:#a6e22e>State</span>: <span style=color:#a6e22e>svc</span>.<span style=color:#a6e22e>Running</span>, <span style=color:#a6e22e>Accepts</span>: <span style=color:#a6e22e>svc</span>.<span style=color:#a6e22e>AcceptStop</span> | <span style=color:#a6e22e>svc</span>.<span style=color:#a6e22e>AcceptShutdown</span>}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>stop</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>c</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>reqCh</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Cmd</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>svc</span>.<span style=color:#a6e22e>Stop</span>, <span style=color:#a6e22e>svc</span>.<span style=color:#a6e22e>Shutdown</span>:
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>stop</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>cancel</span>()
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>stop</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>statusCh</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>svc</span>.<span style=color:#a6e22e>Status</span>{<span style=color:#a6e22e>State</span>: <span style=color:#a6e22e>svc</span>.<span style=color:#a6e22e>StopPending</span>}
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>ch</span> <span style=color:#75715e>// wait until MyService would be completed
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div></article><div class=pagination><div class=pagination__buttons><a href=/diary/tags/go/page/2/ class="button next"><span class=button__text>過去の日記</span>
<span class=button__icon>→</span></a></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>© 2021 Tetsuya Morimoto</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>