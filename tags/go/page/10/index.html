<!doctype html><html lang=en><head><title>go :: forest nook</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/tags/go/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="go"><meta property="og:description" content><meta property="og:url" content="/diary/tags/go/"><meta property="og:site_name" content="forest nook"><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/tags/go/index.xml rel=alternate type=application/rss+xml title="forest nook"></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><div class=posts><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0306/>いろいろな変換</a></h1><div class=post-meta><time class=post-date>2023-03-06 (Mon.) ::</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/ldap/>ldap</a>&nbsp;</span><div class=post-content><p>前日は0時ぐらいまでオフィスでお仕事していて、家に帰ってお風呂入って荷造りして、そのまま寝ないで5時過ぎに出かけて新神戸駅から6時10分発の始発に乗ってから2時間ほど寝た。昼間働いて18時にホテルに戻ってまた2-3時間ほど寝て晩ご飯食べてから2時間ほどお仕事していた。寝付けなくて3時ぐらいに起きて吐いた。吐いたら気分よくなってその後はよく眠れた。</p><h2 id=windows-の内部の文字の扱い>windows の内部の文字の扱い</h2><p>前日の日曜日に実装したツールをメンバーに windows server検証してもらう。ある変換処理で windows の内部では文字を utf16le で扱っていて、文字コード変換の処理が漏れていることに気付いた。go の準標準ライブラリを使って、次のようなコードで utf16le から utf8 への変換ができる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;golang.org/x/text/encoding/unicode&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>decoded</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>unicode</span>.<span style=color:#a6e22e>UTF16</span>(<span style=color:#a6e22e>unicode</span>.<span style=color:#a6e22e>LittleEndian</span>, <span style=color:#a6e22e>unicode</span>.<span style=color:#a6e22e>IgnoreBOM</span>).<span style=color:#a6e22e>NewDecoder</span>().<span style=color:#a6e22e>Bytes</span>(<span style=color:#a6e22e>b</span>)
</span></span></code></pre></div><h2 id=ldap-の-dn-の仕様>LDAP の DN の仕様</h2><p>LDAP の distinguished name (DN) を調べた。例えば、windows で dn を powershell の Get-ADUser を使って取得すると次のような値を取得できる。</p><pre tabindex=0><code>dn=&#34;CN=Test,CN=Users,DC=example,DC=com&#34;
</code></pre><p><code>CN</code> や <code>DC</code> は大文字/小文字どちらでもよいが、それが違うと dn の値として別の値になってしまう。できれば小文字に統一したい。その変換処理を実装しようと思って仕様を調べていたら <a href=https://docs.ldap.com/specs/rfc4514.txt>RFC-4514 Lightweight Directory Access Protocol (LDAP): String Representation of Distinguished Names</a> で定義されていることがわかった。ここで定義されている特殊な文字、例えばカンマや等号などはエスケープして値としても使えるように書いてある。キーの値を変換するにはこれらの仕様を理解してパースして変換しないといけない。わりと大変なことを理解して go-ldap のライブラリのコードを読んでいたら正に <code>ParseDN()</code> がそんな実装になっていた。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>ParseDN</span>(<span style=color:#a6e22e>str</span> <span style=color:#66d9ef>string</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>DN</span>, <span style=color:#66d9ef>error</span>)
</span></span></code></pre></div><ul><li><a href=https://github.com/go-ldap/ldap/blob/master/dn.go#L113>https://github.com/go-ldap/ldap/blob/master/dn.go#L113</a></li></ul><p>このツールを使って dn インスタンスにパースして文字列表現を取得すると自動的に正規化されて小文字に変換してくれる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>dn</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ldap</span>.<span style=color:#a6e22e>ParseDN</span>(<span style=color:#a6e22e>s</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to parse dn: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>dn</span>.<span style=color:#a6e22e>String</span>()
</span></span></code></pre></div></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0305/>イベントログに書き込む</a></h1><div class=post-meta><time class=post-date>2023-03-05 (Sun.) ::</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/windows/>windows</a>&nbsp;</span><div class=post-content><p>1時に寝て2時ぐらいから吐き気で3時間ほど苦しんで寝て9時に起きた。バテてきた。10時過ぎからオフィスへ行ってだいたい丸一日お仕事してた。</p><h2 id=go-のマルチプラットフォーム対応>go のマルチプラットフォーム対応</h2><p>いま作っているモジュールは windows/linux の両方で動くモジュールにする必要がある。go は標準でそういったモジュールの開発に対応していて <a href=https://pkg.go.dev/go/build#hdr-Build_Constraints>Build Constraints</a> にビルドタグの仕様が書いてある。例えば、ログ出力を linux では標準出力に windows ではイベントログに書き込みたいとか。windows のイベントログに書き込むのも準標準パッケージである <a href=https://pkg.go.dev/golang.org/x/sys/windows/svc/eventlog>golang.org/x/sys</a> パッケージを使ってすぐにできた。私がイベントログの仕様をよく知らないのでイベントログそのもののインストール作業をどうするかという課題がある。これは詳しい人に教えてもらおう。ビルドタグには <code>unix</code> という設定が使える。これで linux/macos 対応になる。例えば、log 出力のインターフェースをそれぞれ分けたいときに次のように実装できる。windows は標準ロガーに加えてイベントログにも書き込むようにしてみた。この log パッケージを使う呼び出し側のコードはマルチプラットフォームの違いを意識する必要はない。とても簡単にマルチプラットフォームのコードを管理できる。go のビルドやコンパイラの仕組みを学ぶたびに感心する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>//go:build unix
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>log</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>msg</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>fields</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>any</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>mylogger</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>fields</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Warn</span>(<span style=color:#a6e22e>msg</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>fields</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>any</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>mylogger</span>.<span style=color:#a6e22e>Warn</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>fields</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>//go:build windows
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>log</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;golang.org/x/sys/windows/svc/eventlog&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>	<span style=color:#75715e>// this logName should be installed in advance
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>logName</span> = <span style=color:#e6db74>&#34;mylog&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>eventID</span> = <span style=color:#ae81ff>1</span> <span style=color:#75715e>// TODO
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>elog</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>eventlog</span>.<span style=color:#a6e22e>Log</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>init</span>() {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>elog</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>eventlog</span>.<span style=color:#a6e22e>Open</span>(<span style=color:#a6e22e>logName</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>mylogger</span>.<span style=color:#a6e22e>ErrorExit</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Remove</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>eventlog</span>.<span style=color:#a6e22e>Remove</span>(<span style=color:#a6e22e>logName</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>msg</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>fields</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>any</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>elog</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>eventID</span>, <span style=color:#a6e22e>getMessage</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>fields</span>))
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>mylogger</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>fields</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Warn</span>(<span style=color:#a6e22e>msg</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>fields</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>any</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>elog</span>.<span style=color:#a6e22e>Warning</span>(<span style=color:#a6e22e>eventID</span>, <span style=color:#a6e22e>getMessage</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>fields</span>))
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>mylogger</span>.<span style=color:#a6e22e>Warn</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>fields</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=お土産探し>お土産探し</h2><p>いつもは東京出張のタイミングにあわせてお店やお菓子探しから時間をかけて、自分でも買って試食してみて選択している。今回は2週間前から土日もずっと開発していて余裕がない。前回は <a href=/diary/posts/2023/0129/#本髙砂屋の金つば>本髙砂屋の金つば</a> を持って行った。本髙砂屋は金つばの老舗なのだけど、洋菓子も販売していて和菓子のお店の隣に洋菓子のお店も構えている。
今回も本髙砂屋にあやかって洋菓子の <a href=https://www.hontaka.jp/commodity/western/>エコルセ</a> の季節限定で売っている詰め合わせバージョンを購入してみた。「貧すれば鈍する」とよく言ったものでお土産探しの時間すらかけられなくなってしまっている。15時半頃から出かけて本髙砂屋さんで購入した。今回は試食できていないけど老舗だからあまり心配はいらないとは思う。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0304/>http クライアントのリトライ機能</a></h1><div class=post-meta><time class=post-date>2023-03-04 (Sat.) ::</time></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;</span><div class=post-content><p>1時に寝て7時に起きた。今週末もお仕事をがんばる。今週中に開発タスクを完了させたいという思いがある。まだ今週は続いている。</p><h2 id=ストレッチ>ストレッチ</h2><p>今日の開脚幅は開始前154cmで、ストレッチ後157cmだった。今週も座っている時間が長かったせいか、あまり数値がよくなかった。ここ2-3週間前から右すねの外側の筋に張りがあったが、これが左にも転移して左すねの外側の筋も張りが強くなってきた。両方とも張りがあるという意味ではバランスが取れたと言えるのかもしれない。いずれにしてもいままで張りがなかったところに違和感があるので引き続き注視していきたい。歩くときにやや気になるけれど、日常生活に支障が出るほどの障害ではない。少し前からオフィス通勤に自転車をやめて、通勤とお昼ご飯を買いに行くのが自転車から歩きになったことが影響しているのかな？言うても徒歩3分ぐらいの距離でそんなこと起きるかなぁと思ったり。</p><h2 id=http-クライアントのリトライ機能>http クライアントのリトライ機能</h2><p>結論から言うと <a href=https://github.com/hashicorp/go-retryablehttp>go-retryablehttp</a> を使ってすぐできた。自分で作ってもよかったのだけど、retryablehttp がシンプルで私の求めている機能そのものにみえたのでこのライブラリを採用した。既存の http クライアントの機能を次の2箇所変更するだけで retryablehttp が使える。こういうインテグレーションの簡単さも嬉しい。ちゃんとバックオフとジッターの機能も実装しているし、デフォルトのそれらの機能をカスタムで置き換えることもできる。最低限のリトライ機能があればいいといった http クライアントならこれでよいと思う。こういうシンプルで使い勝手のよいライブラリをみつけると嬉しくなる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span><span style=color:#f92672>-	res, err := c.raw.Do(req)
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+	_req, err := retryablehttp.FromRequest(req)
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+	if err != nil {
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+		return []byte{}, fmt.Errorf(&#34;failed to create retryable request: %w&#34;, err)
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+	}
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+	res, err := c.raw.Do(_req)
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span><span style=color:#a6e22e>+func NewRetryableClient(cfg config.Client) *retryablehttp.Client {
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+	c := retryablehttp.NewClient()
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+	c.Logger = log.GetLogger()
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+	c.RetryWaitMin = cfg.RetryWaitMin
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+	c.RetryWaitMax = cfg.RetryWaitMax
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+	c.RetryMax = cfg.RetryMax
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+	return c
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+}
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>
</span></span><span style=display:flex><span><span style=color:#f92672>-		raw: http.DefaultClient,
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+		raw: NewRetryableClient(cfg),
</span></span></span></code></pre></div></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0302/>zeromq のメッセージングを go でやり取りする</a></h1><div class=post-meta><time class=post-date>2023-03-02 (Thu.) ::</time></div><span class=post-tags>#<a href=/diary/tags/zeromq/>zeromq</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/tech-selection/>tech selection</a>&nbsp;</span><div class=post-content><p>0時に寝て何度か起きて7時に起きた。たぶんよく眠れたと思う。</p><h2 id=zeromq-のライブラリ選定>zeromq のライブラリ選定</h2><p>zeromq のクライアントをサンプル的に実装している。windows と linux の両方で使う予定なので pure go 実装の <a href=https://github.com/go-zeromq/zmq4>go-zeromq/zmq4</a> を使ってみることにした。zeromq のライブラリはいくつかあるが、大きく2つに分けられる。</p><ul><li>c 言語の zeromq ライブラリのラッパー</li><li>zeromq のプロトコルを pure go 実装</li></ul><p>c 言語のライブラリのラッパーだとビルド環境をプラットフォームごとに用意しないといけない。pure go ならクロスコンパイルも簡単。例えば、linux 上で windows のバイナリをビルドするには次のようにする。go ならたったこれだけでよい。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>GOOS<span style=color:#f92672>=</span>windows GOARCH<span style=color:#f92672>=</span>amd64 go build -o bin/myapp.exe ./cmd/myapp/main.go
</span></span></code></pre></div><p>但し、zeromq の pure go 実装は開発があまり活発ではないし production ready でもない。まだまだベータ版というか、stable な実装にはなっていないようにみえる。うちの用途はとてもシンプルなメッセージングに使うだけなので動けば問題ないだろうという想定で最初の選択肢として go-zeromq/zmq4 を試してみる。これはまだチュートリアル的に動かしているレベルなのでコードが誤っているかもしれないが、ひとまずメッセージのやり取りができるところまで確認した。windows でも動く。これから1ヶ月ほどかけて実運用レベルのデータやテストを実施して本当に使えるかどうかの検証をしていく。</p><p>メッセージを送る側は Push というソケットを使う。送信は chan を使って非同期に送る必要性はないのだけど Pull にあわせて汎用性をもつ実装にするとこんな感じかな。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Push</span>(
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>cfg</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>Queue</span>, <span style=color:#a6e22e>msgCh</span> <span style=color:#f92672>&lt;-</span><span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>zmq4</span>.<span style=color:#a6e22e>Msg</span>,
</span></span><span style=display:flex><span>) (<span style=color:#f92672>&lt;-</span><span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>error</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>push</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>zmq4</span>.<span style=color:#a6e22e>NewPush</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>zmq4</span>.<span style=color:#a6e22e>WithDialerRetry</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span><span style=color:#f92672>*</span><span style=color:#ae81ff>3</span>))
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>push</span>.<span style=color:#a6e22e>SetOption</span>(<span style=color:#a6e22e>zmq4</span>.<span style=color:#a6e22e>OptionHWM</span>, <span style=color:#a6e22e>cfg</span>.<span style=color:#a6e22e>SendHWM</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to set socket option: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>endpoint</span> <span style=color:#f92672>:=</span> <span style=color:#e6db74>&#34;ipc://&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>cfg</span>.<span style=color:#a6e22e>Path</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>push</span>.<span style=color:#a6e22e>Dial</span>(<span style=color:#a6e22e>endpoint</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to dial: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>addr</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>push</span>.<span style=color:#a6e22e>Addr</span>(); <span style=color:#a6e22e>addr</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;dialer with non-nil addr&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>errCh</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>error</span>, <span style=color:#a6e22e>messageChanSize</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>defer</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>push</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Debug</span>(<span style=color:#e6db74>&#34;push queue was closed&#34;</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>			close(<span style=color:#a6e22e>errCh</span>)
</span></span><span style=display:flex><span>		}()
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>msg</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>msgCh</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>push</span>.<span style=color:#a6e22e>Send</span>(<span style=color:#a6e22e>msg</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>errCh</span> <span style=color:#f92672>&lt;-</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>			} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>Is</span>(<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Canceled</span>) {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Info</span>(<span style=color:#e6db74>&#34;push queue is closing ...&#34;</span>, <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>any</span>{
</span></span><span style=display:flex><span>					<span style=color:#e6db74>&#34;err&#34;</span>: <span style=color:#a6e22e>err</span>,
</span></span><span style=display:flex><span>				})
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>			} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>errCh</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>errCh</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>メッセージを受け取る側は Pull というソケットを使う。<code>Recv()</code> でキューからメッセージの到着をブロックする。context をキャンセルすると <code>Recv()</code> が即時でエラーを返すので終了処理も制御しやすい。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Pull</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>cfg</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>Queue</span>) (<span style=color:#f92672>&lt;-</span><span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>zmq4</span>.<span style=color:#a6e22e>Msg</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>pull</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>zmq4</span>.<span style=color:#a6e22e>NewPull</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>endpoint</span> <span style=color:#f92672>:=</span> <span style=color:#e6db74>&#34;ipc://&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>cfg</span>.<span style=color:#a6e22e>Path</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>pull</span>.<span style=color:#a6e22e>Listen</span>(<span style=color:#a6e22e>endpoint</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to listen: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>addr</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>pull</span>.<span style=color:#a6e22e>Addr</span>(); <span style=color:#a6e22e>addr</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;listener with nil addr&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ch</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>zmq4</span>.<span style=color:#a6e22e>Msg</span>, <span style=color:#a6e22e>messageChanSize</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>defer</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>pull</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>			close(<span style=color:#a6e22e>ch</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Debug</span>(<span style=color:#e6db74>&#34;pull queue was closed&#34;</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>		}()
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Debug</span>(<span style=color:#e6db74>&#34;-- waiting messages ...&#34;</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>pull</span>.<span style=color:#a6e22e>Recv</span>()
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>ch</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>msg</span>
</span></span><span style=display:flex><span>			} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>Is</span>(<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Canceled</span>) {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Info</span>(<span style=color:#e6db74>&#34;pull queue is closing ...&#34;</span>, <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>any</span>{
</span></span><span style=display:flex><span>					<span style=color:#e6db74>&#34;err&#34;</span>: <span style=color:#a6e22e>err</span>,
</span></span><span style=display:flex><span>				})
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>			} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>EOF</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Debug</span>(<span style=color:#e6db74>&#34;got EOF&#34;</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>			} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#e6db74>&#34;failed to recieve&#34;</span>, <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>any</span>{
</span></span><span style=display:flex><span>					<span style=color:#e6db74>&#34;err&#34;</span>: <span style=color:#a6e22e>err</span>,
</span></span><span style=display:flex><span>				})
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ch</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0227/>go 1.20.1 を使い始めた</a></h1><div class=post-meta><time class=post-date>2023-02-27 (Mon.) ::</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/linux/>linux</a>&nbsp;
#<a href=/diary/tags/network/>network</a>&nbsp;</span><div class=post-content><p>0時に寝て何度か起きて7時半に起きた。あまりうまく眠れなかった。</p><h2 id=go-1201-へのアップグレード>go 1.20.1 へのアップグレード</h2><p>リファクタリングの区切りがついたらやろうと思っていて遅れた。すでに 1.20.1 がリリースされている。先日 <a href=https://gocon.connpass.com/event/273096/>Go 1.20 リリースパーティ</a> に参加して、いろいろ聞いていると改善されているところや新しい機能を試してみたいものがいくつかみつかった。単純にアップグレードするだけでも最大でビルド時間が10%短縮される可能性がある。1.18 と 1.19 で generics 対応でビルド時間が遅くなっていたのが 1.17 相当に改善されたらしい。やっぱり generics はコンパイラを複雑にするものなのでコンパイル時間が長くなる傾向があるんやなと話しを聞いていて思ったりもした。ついでに依存ライブラリなどのバージョンアップもまとめてやった。単体テストと結合テストが普通には揃ってきたのでバージョンアップなども安心して実行できる。</p><iframe class=speakerdeck-iframe frameborder=0 src="https://speakerdeck.com/player/b76374a32d394b66afdfea89da855927?slide=1" title="What's new in Go 1.20?" allowfullscreen style="border:0;background:padding-box padding-box rgba(0,0,0,.1);margin:0;padding:0;border-radius:6px;box-shadow:rgba(0,0,0,.2)0 5px 40px;width:600px;height:auto;aspect-ratio:560/314" data-ratio=1.78343949044586></iframe><h2 id=rocky-linux-のネットワーク設定>rocky linux のネットワーク設定</h2><p>テスト環境に使っている rocky linux の ip アドレスを変更する必要があったので調べてみた。ちゃんとした公式のガイドが出てきてすごいなと感心した。</p><ul><li><a href=https://docs.rockylinux.org/guides/network/basic_network_configuration/>Network Configuration - Rocky Linux 9</a></li></ul><p>ip アドレスを確認するコマンドが ifconfig から ip に変わっていたり、ネットワーク設定のためのツールも私が知っているものとは全然変わってしまっている。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ip addr
</span></span></code></pre></div><p>Network Manager のサービスで設定されているようでそのための設定ファイルは次の場所に保存されていた。</p><pre tabindex=0><code>/etc/NetworkManager/system-connections/my-device.nmconnection 
</code></pre><p>これを書き換えるツールとして nmtui という tui ツールと nmcli という cli ツールの2つがある。tui とか懐かしいなとか思いながら操作していた。ssh 経由で設定していたので cli でいきなり設定を反映するよりも tui で設定ファイルを書き換えて os を再起動するのがよいだろうと考えてやってみた。ドキュメントに書いてある通りに操作したら意図した ip アドレスを設定して変更できた。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0225/>リファクタリング一段落</a></h1><div class=post-meta><time class=post-date>2023-02-25 (Sat.) ::</time></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;
#<a href=/diary/tags/refactoring/>refactoring</a>&nbsp;</span><div class=post-content><p>1時に寝て7時に起きた。前日も21時頃までオフィスにいて、今日も午後からコードを書いていて22時ぐらいまでやってた。コードを書いていると時間がどんどんなくなる。本当は三宮.dev の勉強会があったんだけど、このリファクタリングは週末にやってしまわないとやばいという野生の勘でキャンセルした。</p><h2 id=ストレッチ>ストレッチ</h2><p>今日の開脚幅は開始前156cmで、ストレッチ後160cmだった。だいたいいつも通り。先週から右すねの外側の筋に張りがある。先週よりちょっとよくなった気もするけれど、まだ張りが継続している。あと今週は右腰に張りがあった。今週はリファクタリングしていて座ってきる時間がいつもより長かったためだろうと推測する。どんなに忙しくてもストレッチだけは休まないようにしている。ストレッチに通い始めて2年以上経つが身体的に体調が悪いということは記憶にほぼない。日記にはその週のどこそこに張りがあるとか調子が悪いといったことを書いたりしているが、それは日常生活を送る上で支障が出るようなレベルではない。そうならないように予防している。健康を維持する上でストレッチは大きな影響を与えているため、中長期の展望から忙しくても継続するようにしている。</p><h2 id=機能拡張とリファクタリング>機能拡張とリファクタリング</h2><p>今日は休日出勤して go のコードを書いていた。ある機能を作るときに内部的には汎用の api にしてしまって他のコレクションのデータ型でも再利用できるようにしたい。先週ずっと go の generics を使って mongodb 周りのコレクションとそのクライアントのリファクタリングをしていた。go の generics の理解も進んで crud なインターフェースを generics でどのように定義して実装すればいいかわかってきた。その過程で web api のアプリケーション層と mongodb のインフラ層 (データ層) の役割分担も明確になりつつある。どちらも generics を駆使して型チェックされた上でソースコードを共通化し、汎用 api としてリファクタリングしながら設計している。その集大成としてアプリケーション側で汎用的な機能を追加するときに、理想的には1つのコードを追加・変更すれば、別のデータ型でもすべて同じように動くといった機能として実装した。4つのコレクションのデータ型で同じ振る舞い (機能) を共通化する。その実装も丸1日やれば完了できるぐらいに設計の効率化ができてきた。</p><p>go はオブジェクト指向言語ではないので generics を駆使しても、java でいうところの抽象既定クラスを用いたテンプレートパターンの実装ができない。それぞれの構造体で基本的にはコピペとなる構造体のメソッドを定義しないといけない。もちろん別のヘルパーに移譲するといったことはできるけど、状態をもっていないコードの再利用はたしかに安全ではあるけれど、状態を参照できないからそのために値をコピーするといった整合性の懸念やボイラープレート的なコードを書く必要がある。これは設計におけるトレードオフになるので go の処理系の設計に不満があるわけではない。但し、generics でできることにはまだ機能不足がある。とくに直和型の扱い。できないのかな？とググると proposal の issue がみつかるので今後の機能拡張に期待したい。</p><p>正直マネージャーが開発に工数使っていて何やってるんだとみられているかもしれない。1-2週間集中してリファクタリングしてみて、いまのアプリケーションの設計の勘所が以前よりも理解が進んだ。コードレビューだけではわからないフィードバックがある。結合テストもいくつか追加したので今後の開発で役に立つはず。これで私の (リファクタリング) 開発は終了しようと思う。</p><p>今日作ったマージリクエストの diff が次になる。</p><pre tabindex=0><code>51 files +1314 -648
</code></pre><p>diff の行数だけ数えると今週だけで1万行近くは変更したと思う。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0224/>mongodb のトランザクションの考え方</a></h1><div class=post-meta><time class=post-date>2023-02-24 (Fri.) ::</time></div><span class=post-tags>#<a href=/diary/tags/mongodb/>mongodb</a>&nbsp;
#<a href=/diary/tags/database/>database</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;</span><div class=post-content><p>1時に寝て8時に起きた。3時頃に気分悪くて起きて少し吐いてそれからまた寝た。丸1日機能拡張とリファクタリングのために go のコードを書いていた。</p><h2 id=mongodb-のトランザクション管理>mongodb のトランザクション管理</h2><p>2つの web api から同じコレクションの異なるフィールドを更新したい。mongodb で厳密なトランザクションを管理するようなアプリケーションではないけど、なるべく整合性を維持できるように努めることはやっておきたい。mongodb でトランザクションに近いことを実現する方法として次の記事が参考になった。</p><ul><li><a href=https://www.mongodb.com/blog/post/how-to-select--for-update-inside-mongodb-transactions>How To SELECT &mldr; FOR UPDATE inside MongoDB Transactions</a></li></ul><p>この記事では <code>findOneAndUpdate()</code> という api を使って、更新時に必ず変更されるフィールドを含めることで find したときのそのフィールドの値が変わっていればエラーになってくれることでトランザクション相当の機能が提供されると書いてある。必ず変更されるフィールドとして <a href=https://www.mongodb.com/docs/manual/reference/method/ObjectId/>ObjectId</a> を使えば他の更新処理を検出するのに役立つだろうとある。いま私が開発しているアプリケーションでは同じフィールドを複数の web api から更新するわけではないのでここまで厳密なトランザクション管理は必要にない。</p><p>既存の処理が <a href=https://www.mongodb.com/docs/drivers/go/current/usage-examples/replaceOne/>Replace</a> を使って実装されていたのを <a href=https://www.mongodb.com/docs/drivers/go/current/usage-examples/updateOne/>Update</a> を使うように変更する。Replace と Update の違いはドキュメント全体を更新するのか、一部のフィールドのみを更新するのかの違いになる。具体的には go のドライバーにおいて次のメソッドの使い分けになる。</p><ul><li><a href=https://pkg.go.dev/go.mongodb.org/mongo-driver/mongo#Collection.FindOneAndReplace>FindOneAndReplace</a></li><li><a href=https://pkg.go.dev/go.mongodb.org/mongo-driver/mongo#Collection.FindOneAndUpdate>FindOneAndUpdate</a></li></ul><p>これらのメソッドを使うことで find と replace/update の操作を1回の処理でできるから効率もよいらしい。</p></div></article><div class=pagination><div class=pagination__buttons><a href=/diary/tags/go/page/9/ class="button previous"><span class=button__icon>←</span>
<span class=button__text>最近の日記</span></a>
<a href=/diary/tags/go/page/11/ class="button next"><span class=button__text>過去の日記</span>
<span class=button__icon>→</span></a></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>© 2021 Tetsuya Morimoto</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>