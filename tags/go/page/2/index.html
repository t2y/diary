<!doctype html><html lang=en><head><title>go :: forest nook</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/tags/go/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="go"><meta property="og:description" content><meta property="og:url" content="/diary/tags/go/"><meta property="og:site_name" content="forest nook"><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/tags/go/index.xml rel=alternate type=application/rss+xml title="forest nook"></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><div class=posts><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1120/>生活リズムが崩れた月曜日</a></h1><div class=post-meta><time class=post-date>2023-11-20 (Mon.) ::</time></div><span class=post-tags>#<a href=/diary/tags/animation/>animation</a>&nbsp;
#<a href=/diary/tags/economy/>economy</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/ldap/>ldap</a>&nbsp;
#<a href=/diary/tags/hugo/>hugo</a>&nbsp;</span><div class=post-content><p>1時に寝て2時半に起きて5時に起きて7時に起きた。朝から昼過ぎまで寝てたのでトータルでは睡眠時間をたくさん取っているのになんか疲れている。生活のリズムを崩すのがよくないのかも。</p><h2 id=ガンダムに学ぶ経営学>ガンダムに学ぶ経営学</h2><p>教えてもらって寝る前にみたらおもしろかった。入山先生がガンダム大好きなことが伝わってくる。おもしろいのはそうだけど、まじレスすると、アニメの世界の組織や経済に学ぶというのは誤りで、当時の組織や経済のリアルを参考にして、ガンダムの世界観は作られていると推測する。だから入山先生はユーモアで盛り上げているのだと思うけれど、ガンダムから学ぶのではなく歴史から学べが正解だと思う。でも、ガンダムの世界観を知るよい番組だと思う。</p><div class=video-container><iframe src=https://www.youtube.com/embed/w7Hhimmu26c allowfullscreen title="ガンダムに学ぶ経営学 【まとめ】【テレ東経済ニュースアカデミー　GWセレクション３】"></iframe></div><h2 id=go-ldap-へのプルリクエスト>go-ldap へのプルリクエスト</h2><p>2週間ほど前に送った pr がまだレビューすらしてもらえていない。github actions のテストがいくつか落ちていて、この pr の修正によるものではないところでエラーになっている。メンテナーの1人が再実行してくれたんだけど、たくさんあるマトリックステストのどこかが落ちてまた再実行しないといけない。</p><ul><li><a href=https://github.com/go-ldap/ldap/pull/471>IsErrorAnyOf should match the given result code even if the error is wrapped #471</a></li></ul><p>それを待っている間に、テストがエラーになる本当の原因の問題を直そうと2-3日前に issue 登録していた。この issue の対応を本当は昨日やろうと思っていたのに、思いの外、寝てしまって、その後もいろいろ書きものをしていて時間を使ってしまってできていなかった。今朝からそれを片付けた。業務の一環なので日曜日にプルリクエストを送らなくてもよいのだけど、コントリビューションなので空き時間に終わらせて、業務の時間は別のことに使いたいという思いもあったりする。</p><ul><li><a href=https://github.com/go-ldap/ldap/pull/473>Fix DATA RACE as a result of changing ber&rsquo;s module global variable for fuzz tests #473</a></li></ul><p>さらに github actions のログに deprecated ワーニングが出ていたのでついでにそれも直した。</p><ul><li><a href=https://github.com/go-ldap/ldap/pull/474>Fix deprecated warning on GitHub Actions #474</a></li></ul><p>473, 474, 471 の順番にマージされていくのが望ましい。そろそろコミット権をくれたりしないかな？と思ったりもする。というのは、タイミングの問題で action の job が落ちたり、バージョン上げるだけの pr とか、自分でマージしてしまえばいいと思ったりする。</p><h2 id=hugo-で書いた記事に目次を生成する>hugo で書いた記事に目次を生成する</h2><p>お手伝い先のテックブログは hugo で運用されている。記事の目次がないなと気付いて追加してみた。hugo v0.60.0 以降のバージョンなら標準で目次生成の機能をもっている。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#f92672>aside</span>&gt;
</span></span><span style=display:flex><span>  {{ .TableOfContents }}
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>aside</span>&gt;
</span></span></code></pre></div><ul><li><a href=https://gohugo.io/content-management/toc/>Table of contents</a></li></ul><p>デフォルトはヘッダー2レベルより下の目次を生成する。レベル1も生成したい場合は config.toml に次の設定を追加する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>[<span style=color:#a6e22e>markup</span>]
</span></span><span style=display:flex><span>  [<span style=color:#a6e22e>markup</span>.<span style=color:#a6e22e>tableOfContents</span>]
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>startLevel</span> = <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>endLevel</span> = <span style=color:#ae81ff>3</span>
</span></span></code></pre></div></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1113/>経済的且つ健康</a></h1><div class=post-meta><time class=post-date>2023-11-13 (Mon.) ::</time></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/food/>food</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;</span><div class=post-content><p>22時頃から寝てしまって24時に起きて2時間ほどネットみたりしてまた寝て4時に起きて7時に起きた。</p><h2 id=健康によさそうな紅生姜>健康によさそうな紅生姜</h2><p><a href=/diary/posts/2023/1112/>昨日の続き</a> 。業務スーパーの紅生姜は 1kg 338円、賞味期限も9ヶ月、とお得ではあるものの、中国産且つ合成保存料／着色料を使っているところに懸念がある。日常的に食べるものならもう少し健康に注意を払いたい。amazon で購入できる商品で <a href=https://sakatashop.jp/pages/company>坂田信夫商店</a> という生姜専門店をみつけた。「合成着色料・保存料 不使用」なのがよい。この紅生姜も色はついているものの、野菜色素で色付けしているらしい。この商品は 1kg 1,800円、賞味期限は製造日から4ヶ月になる。健康に気を遣うと割高になるが、普段食べるものはそれで構わない。amazon の定期便で食べる量にあわせて送ってもらうのがよさそう。</p><p><a href=https://amzn.to/47r3HVA target=_blank><img src=https://m.media-amazon.com/images/I/51dzpO1MqVL._AC_.jpg width=320></a></p><h2 id=お昼ご飯の行方>お昼ご飯の行方</h2><p>週末にスーパーのポイントカードの振る舞いをチェックするためにいつもより食材をたくさん買い込んでしまった。冷蔵庫が膨らんでいるので土日の両日とも自炊して、今日のランチも外食ではなく、お昼に帰って自炊した。オフィスと家の距離が徒歩3分なのですぐ帰れる。家で自炊してお昼ご飯を作るメリット・デメリットを考えてみる。</p><p>メリット</p><ul><li>外食するよりも自炊した方が安い<ul><li>物価が上がっているので外食すると1,000円前後になる</li><li>自炊なら高めに見積もっても500円もあれば済む</li></ul></li><li>野菜を多く採れる<ul><li>基本的に外食のランチは野菜が足りない</li><li>野菜は値段が高いのでランチやお弁当ではしばしば省略される</li></ul></li></ul><p>デメリット</p><ul><li>自炊するのが面倒くさい</li><li>家だと仕事の合間の気分転換にならない？</li></ul><p>基本的に私が労力さえ払えば、経済的にも健康的にもメリットしかない。自炊すればするほどスーパーのポイントも多く貯まる。毎日じゃなくても、たまに多めに買い込んでお昼も自炊してみようと思う。</p><h2 id=go-の-set-型の導入予測>go の set 型の導入予測</h2><p>コードレビューをしていて、ある処理の実装を集合演算でやった方がよいとアドバイスした。go の型システムや標準ライブラリには set 型に相当するものがない。しかし、map を使って簡単に実装できるので実際の開発で問題になることはほとんどない。いまは generics と comparable があるので、汎用の set 型を map で実装することもできるはず、と思って調べたら次の記事をみつけた。</p><ul><li><a href=https://bitfieldconsulting.com/golang/generic-set>A generic Set type in Go</a></li></ul><p>私のイメージとも合致して、こういったものをユーザー定義型で実装すればよいと reviewee とやり取りしていた。generics で汎用の set 型を実装できるなら、当然、それを標準ライブラリに導入しようという話しも出ているはずで軽く調べてみた。次の issue がその議論らしい。</p><ul><li><a href=https://github.com/golang/go/discussions/47331>proposal: container/set: new package to provide a generic set type (discussion) #47331</a></li></ul><p>で、私は issue を読んでいないのだけど、どうやらユーザー定義の iterator 機能に依存しているらしい。従って iterator 機能が導入された後に set 型が導入されるといった流れになるだろう。</p><ul><li><a href=https://github.com/golang/go/issues/61405>spec: add range over int, range over func #61405</a></li></ul><p>iterator 機能は早ければ次の 1.22 ともみられているが、まだマイルストーンがついていないので開発状況によっては見送られるかもしれない。これから1-2年後あたりには go 本体が提供する set 型が支えるようになっているのではないかと推測する。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1108/>rbac なロールでの動的な権限チェック</a></h1><div class=post-meta><time class=post-date>2023-11-08 (Wed.) ::</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;
#<a href=/diary/tags/auth/>auth</a>&nbsp;</span><div class=post-content><p>23時に寝て何度か起きて7時に起きた。夜に作業するつもりが、<a href=http://miabyss.com/>メイドインアビス</a> を見ながら寝落ちした。</p><h2 id=ldap-で認証したユーザーの権限管理>ldap で認証したユーザーの権限管理</h2><p><a href=/diary/posts/2023/1026/>rbac なロール管理</a> の仕組みを api サーバーに実装した。初期実装したときは静的にリソース (url) に対して acl から権限が許可されているかどうかのみをチェックするだけでよかった。ldap で認証したユーザーは自分の情報は更新できるが、他人の情報は更新できないといったリクエスト単位に権限が許可されているかどうかをミドルウェアで判別したい。いわば、リクエスト時に動的にリソースの情報をチェックしないといけない。</p><p>いくつか試行錯誤して、あーでもないこーどもないとやった結果、次のように落ち着いた。</p><ul><li>リソースは動的な権限チェックのために AuthorizeFunc を取得するための AuthorizeKey をもつ</li><li>AuthorizeFunc は Context から取得する</li><li>AuthorizeFunc が true を返す場合は権限を付与する</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Role</span>) <span style=color:#a6e22e>CanAccess</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>resourceName</span>, <span style=color:#a6e22e>target</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>ac</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>ACL</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ac</span>.<span style=color:#a6e22e>Resource</span>.<span style=color:#a6e22e>Match</span>(<span style=color:#a6e22e>resourceName</span>) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>perm</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>ac</span>.<span style=color:#a6e22e>Permissions</span> {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>perm</span>.<span style=color:#a6e22e>IsGranted</span>(<span style=color:#a6e22e>target</span>) {
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>authorize</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Value</span>(<span style=color:#a6e22e>ac</span>.<span style=color:#a6e22e>Resource</span>.<span style=color:#a6e22e>Key</span>).(<span style=color:#a6e22e>AuthorizeFunc</span>); <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>authorize</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>resourceName</span>, <span style=color:#a6e22e>target</span>) {
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ロールに渡す Context にはあらかじめ、AuthorizeKey と AuthorizeFunc を登録しておく。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>ctx</span> = <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>WithValue</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>role</span>.<span style=color:#a6e22e>LDAPResource</span>, <span style=color:#a6e22e>role</span>.<span style=color:#a6e22e>IsLDAPResourceOwner</span>)
</span></span></code></pre></div><p>リソースを生成するときに AuthorizeKey をセットしておく。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>ldapUserResource</span> = <span style=color:#a6e22e>rbac</span>.<span style=color:#a6e22e>NewResource</span>(
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;ldap-user-specific-operation&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;(/api/ldap/entry|/api/ldap/entry/.*)&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>LDAPResource</span>,
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><p>ちょっと設定は煩雑になるが、ひとまずこれで要件を満たせた。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1102/>論理の通じない人たち</a></h1><div class=post-meta><time class=post-date>2023-11-02 (Thu.) ::</time></div><span class=post-tags>#<a href=/diary/tags/sns/>sns</a>&nbsp;
#<a href=/diary/tags/writing/>writing</a>&nbsp;
#<a href=/diary/tags/communication/>communication</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;</span><div class=post-content><p>23時に寝て何度か起きて8時に起きた。ホテルの部屋が暗いと朝になった気がしなくて2度寝したら寝坊した。</p><h2 id=組織の対応と-sns-の議論>組織の対応と sns の議論</h2><p><a href=/diary/posts/2023/1030/>先日の sns 騒ぎ</a> の続き。公式からの声明も出たので軽くまとめておく。</p><ul><li><a href=https://pyconjp.blogspot.com/2023/11/pyconapac2023-statement.html>PyCon APAC 2023におけるNOCコンテンツに関するご指摘について</a></li></ul><p>簡潔な文章に事実の記述、責任の所在、関係者への配慮が含まれていて十分な内容にみえる。法律なども関係するため、弁護士チェックが必要なことを考慮すると、こんな短期間で組織の見解を出せたことは運営側の体制を鑑みることができる。それが適正かどうかは人によって判断は異なるかもしれないが、私はコミュニティ運営というボランティア主体の組織であれば十分なものだと思えた。その後のネット上の議論も、ちゃんと終えてはいないが、様々な見解で議論は進んでいるようにみえる。</p><p>今回みていて感じたことの1つに、コミュニケーションが成り立たない人が世の中にはたくさんいるということ。議論の前提や論理の出発点が異なる人たちは、一定の論理を含む全体や大局を理解できず、細部や詳細のところだけを拠り所に自身の論理を組み立てる。意見の差異があることはなんら問題はないが、論理が通じないのは議論の余地すらないようにみえた。そういう人たちを会話するときは前提条件を同じにしたり、思想の背景を共有したり、もっと時間をかけて丁寧にすり合わせていく作業が必要になる。そして sns のような、流れが速い不特定多数の議論はそういった丁寧な作業にまったく向いていない。だから sns で議論することは時間の無駄である。</p><h2 id=コネクションを共有しないプール>コネクションを共有しないプール</h2><p>go の非同期処理であまり使われることはないが、<a href=https://pkg.go.dev/golang.org/x/sync/semaphore>semaphore</a> が準公式ライブラリとして提供されている。私はセマフォを気に入っていてたまに使う。</p><p>ldap プロトコルではコネクションの確立とログインに相当する bind の操作が分かれている。コネクションを確立したまま、ログアウトに相当する処理ができればプールを設けることでコネクションの再利用ができる。</p><ul><li><a href=https://ldap.com/the-ldap-unbind-operation/>The LDAP Unbind Operation</a></li></ul><p>しかし、このドキュメントの説明によると、unbind という操作は用意されているものの、ログアウトに相当する機能ではなく、クローズする前に通知するといった用途だと書いてある。unbind のリクエストをした後にはクローズするしかないといったものになる。それを踏まえて、プールはセマフォで同時接続数のみを制御するのでよいのではないかと思う。そんなワーカープールを実装してみた。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ClientPool</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>config</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>LDAP</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sem</span>    <span style=color:#f92672>*</span><span style=color:#a6e22e>semaphore</span>.<span style=color:#a6e22e>Weighted</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ClientPool</span>) <span style=color:#a6e22e>Get</span>(
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>,
</span></span><span style=display:flex><span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>LDAPClient</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>sem</span>.<span style=color:#a6e22e>TryAcquire</span>(<span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to acquire, wait and get later&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>client</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NewLDAPClient</span>(<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>config</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Connect</span>(<span style=color:#a6e22e>ctx</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>sem</span>.<span style=color:#a6e22e>Release</span>(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to connect: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>client</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ClientPool</span>) <span style=color:#a6e22e>GetAuthenticated</span>(
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>,
</span></span><span style=display:flex><span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>LDAPClient</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>client</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to get: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>dn</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>BindDN</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>passwd</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>BindPasswd</span>.<span style=color:#a6e22e>String</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Bind</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>dn</span>, <span style=color:#a6e22e>passwd</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>sem</span>.<span style=color:#a6e22e>Release</span>(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to bind: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>client</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ClientPool</span>) <span style=color:#a6e22e>Close</span>(<span style=color:#a6e22e>client</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>LDAPClient</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>sem</span>.<span style=color:#a6e22e>Release</span>(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewClientPool</span>(<span style=color:#a6e22e>cfg</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>LDAP</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>ClientPool</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>ClientPool</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>config</span>: <span style=color:#a6e22e>cfg</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>sem</span>:    <span style=color:#a6e22e>semaphore</span>.<span style=color:#a6e22e>NewWeighted</span>(<span style=color:#a6e22e>cfg</span>.<span style=color:#a6e22e>ClientPoolSize</span>),
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1031/>アイマスク効果</a></h1><div class=post-meta><time class=post-date>2023-10-31 (Tue.) ::</time></div><span class=post-tags>#<a href=/diary/tags/health/>health</a>&nbsp;
#<a href=/diary/tags/project-management/>project management</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/event/>event</a>&nbsp;</span><div class=post-content><p>1ヶ月と2週間ぶりの出張。</p><p>0時に寝て2時半に起きた。なにも準備していないのが悪いけれど、出張前夜は寝坊したらどうしようというのが気になってあまり眠れない。起きてから出張の準備をして5時過ぎに出た。電車に乗るまで少し時間があったので朝からなか卯で <a href=https://www.nakau.co.jp/jp/menu/detail/in/116>まぐろのたたき丼</a> を初めて食べた。値段を考えると親子丼を食べた方がお得なように思えた。出張の日は夕方眠くて集中できないことが多い。新幹線の中で眠れるよう、ダイソーでアイマスクを買ってみた。その成果もあって、わりとよく眠れた。アイマスクの効果は確かにあったと思うが、なぜか寝違えて首を痛めた。新幹線でよく眠れたように考えていたが、15-16時は眠気に襲われた。やはり3-5時ぐらいから起きているとそのぐらいの時間に眠くなってしまうんやろか？</p><h2 id=マイルストーン定例>マイルストーン定例</h2><p>いつもの定例会議をやって、開発状況の共有や設計レビューなどを行う。私は権限管理の仕組み作りをちょっとずつ作っているのであまり全体を見渡せていないが、メンバーが主体となって段取りを進めてくれた。あと新規メンバーが先週から開発に参加する予定が、別プロジェクトの段取りがうまく行っていないようでまた仕切り直しになった。もう2週間ほど様子をみるという。3回目のスケジュール調整になる。こういう五月雨式に直前に遅れていくパターンを私は信用しない。スケジュールを自分で制御できる状態にない、または制御できたとしてもやる気がないようにみえる。いずれにしても、私が制御できないプロジェクトの影響で、うちのプロジェクトの成果物に影響が出ないようにしたい。機能開発を3ヶ月と見積もっているうちの、1ヶ月がすでに過ぎた。もう新規メンバーの受け入れは諦めて、既存メンバーだけで成果物ができるような体制へ移行することに決めた。幸いにも既存メンバーは十分にタスクをこなせるようになってきているし、私も10月後半ぐらいからバーンアウトを消化して開発の集中力も戻ってきた。11月にちょっと本気出してサーバーサイドの開発をしてもよいかもしれない。</p><h2 id=go-のオンライン勉強会>go のオンライン勉強会</h2><p><a href=https://gocon.connpass.com/event/299108/>Go 1.21 リリースパーティ & GopherCon 2023 報告会</a> をオンラインで参加した。ホテルについて少し寝てからアラームで起きて視聴してた。始まる前に30分ほど仮眠しても、移動日はしんどくて、みながら半分ぐらいは寝てた。最初と後半2つぐらいのセッションしか覚えていない。メルカリの社員さんたちは <a href=https://gophercon.org/>GopherCon 2023</a> に参加して、その内容などを紹介していた。もう私は海外カンファレンスへわざわざ行こうというモチベーションはない。たぶんもう行くことはないのだろうけど、そういった場に行って学んでいる開発者にはもう追いつけないのだろうなとも思えた。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1026/>権限管理ができるようになった</a></h1><div class=post-meta><time class=post-date>2023-10-26 (Thu.) ::</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;
#<a href=/diary/tags/auth/>auth</a>&nbsp;
#<a href=/diary/tags/node.js/>node.js</a>&nbsp;</span><div class=post-content><p>1時に寝て何度か起きて7時半に起きた。なんかしんどい夢をみたが、もう覚えていない。</p><h2 id=rbac-なミドルウェアの実装>rbac なミドルウェアの実装</h2><p><a href=/diary/posts/2023/1025/#interface-はデシリアライズできない>昨日の続き</a> 。rbac (role-based access control) なライブラリが一通り実装できたのでそれを使って <a href=/diary/posts/2023/1023/>echo のミドルウェア</a> を実装した。やりたいことは次のようなこと。たったこれだけだが、これを実装するために、ここ1週間ほど、あれやこれやの実装をしてきた。ようやくそれが動くようになったというところ。私にとってはミドルウェアの仕組みは過去に何度も実装してきたものだが、頭に描いたイメージのまま、実装できたのがよかったと思う。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>rbacWithConfig</span>(<span style=color:#a6e22e>cfg</span> <span style=color:#a6e22e>rbacConfig</span>) <span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>MiddlewareFunc</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>next</span> <span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>HandlerFunc</span>) <span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>HandlerFunc</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>c</span> <span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>cfg</span>.<span style=color:#a6e22e>Skipper</span>(<span style=color:#a6e22e>c</span>) {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>next</span>(<span style=color:#a6e22e>c</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>req</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Request</span>()
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>Context</span>()
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>sessionStore</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>keySession</span>).(<span style=color:#a6e22e>session</span>.<span style=color:#a6e22e>Store</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>userName</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#e6db74>&#34;username&#34;</span>).(<span style=color:#66d9ef>string</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>s</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>session</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>sessionStore</span>, <span style=color:#a6e22e>userName</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to get session: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Role</span>.<span style=color:#a6e22e>CanAccess</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>URL</span>.<span style=color:#a6e22e>Path</span>, <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>Method</span>) {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>ErrForbidden</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>next</span>(<span style=color:#a6e22e>c</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=nodejs-のアップグレード>node.js のアップグレード</h2><p>ちょうど管理画面も少し触ろうと思って環境を構築し始めた。たまたま node.js のバージョンをみると、ちょうど10月18日で 18 (LTS) の active support 期間が終了していた。security support は2025年4月まであるのでそんな急がなくてもよいが、それに気付いたついでなので 20 (LTS) にアップグレードすることにした。幸い、大半のライブラリは 20 (LTS) でもそのまま動いた。しかし、依存ライブラリのアップデートをしていて、一部 conflict してうまく動かないライブラリもあった。細かい原因調査をしていないが、フロントエンドの方がこまめにバージョンを上げていかないと何が原因でアプリケーションが正常に動かなくなるのか、分からなくなる気がする。</p><ul><li><a href=https://endoflife.date/nodejs>https://endoflife.date/nodejs</a></li></ul></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1025/>非日常を提供するという価値</a></h1><div class=post-meta><time class=post-date>2023-10-25 (Wed.) ::</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;
#<a href=/diary/tags/event/>event</a>&nbsp;
#<a href=/diary/tags/coworking/>coworking</a>&nbsp;
#<a href=/diary/tags/book/>book</a>&nbsp;</span><div class=post-content><p>1時半に寝て3時に起きてもう1回起きて6時半に起きた。</p><h2 id=interface-はデシリアライズできない>interface はデシリアライズできない</h2><p><a href=/diary/posts/2023/1024/#rbac-なライブラリの実装>昨日の続き</a> 。rbac なライブラリを使ってアプリケーションを実装していく。ログイン時にユーザーにロールを割り当ててセッションにロールを保持するのが都合よさそうに思えた。ロールの実装で一部の型は interface にして後から拡張できるような設計にしていた。例えば <a href=https://pkg.go.dev/encoding/json>encoding/json</a> ライブラリだと、Marshaler/Unmarshaler の interface を満たすことで任意の json のシリアライズ/デシリアライズをフックできる。調べたり、実際に動かしていていて気付いたのだけど、interface の場合はシリアライズは任意にできるけど、デシリアライズはできない。当たり前と言えば当たり前だが、interface を満たす複数の型がある中で json ライブラリがどの型でデシリアライズしていいか判別できないからだ。当初の interface を用いた設計が誤りだったことに気付いて、一部の型を汎用の構造体で設計し直すようなことをしていた。</p><p>またデシリアライズするときに一部の値を初期化したいといった要件がある。例えば mutex を初期化したい。このときに処理の内部で派生型を宣言して、それにキャストした上でデシリアライズの処理を実行した上で差分の処理を実装するというテクニックを学んだ。スコープが限定されて、コードがシンプルになって保守性も高い、久しぶりに頭のよいスマートなコードをみた。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Role</span>) <span style=color:#a6e22e>UnmarshalJSON</span>(<span style=color:#a6e22e>b</span> []<span style=color:#66d9ef>byte</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Alias</span> <span style=color:#a6e22e>Role</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Unmarshal</span>(<span style=color:#a6e22e>b</span>, (<span style=color:#f92672>*</span><span style=color:#a6e22e>Alias</span>)(<span style=color:#a6e22e>r</span>)); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>mu</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Mutex</span>{}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li><a href=https://stackoverflow.com/questions/56400734/custom-unmarshalbson-in-mongo-go-driver>Custom UnmarshalBSON in mongo-go-driver</a></li></ul><h2 id=コワーキングのオンラインイベント>コワーキングのオンラインイベント</h2><p>月例のカフーツさんのオンラインイベントに参加した。<a href=/diary/posts/2023/0927/#コワーキングのオンラインイベント>前回の所感はここ</a> 。今日は参加者が2人だけだった。コワーキングスペースを運営するコワーキングスペースマネージャーの連携を強化することで、コワーキングスペースの付加価値が上がったりしないか？といった内容を話したりしていた。コワーキングスペースマネージャーは、普通はお仕事で自分のコワーキングスペースにいないといけないから、なかなか他所のコワーキングスペースへ訪問すること自体が難しい。コワーキングスペース同士の連携により、お仕事でコワーキングスペースマネージャーが自分ところのコワーキングスペースの利用者を連れて、他所のコワーキングスペースへ訪問して、そこでイベントをしたりすればいいんじゃないかという案が出た。</p><p>いとうさんがよく <a href="https://cahootz.jp/?cat=21">コワーキングツアー</a> と称して、全国各地のコワーキングスペースへ訪問して、そこでイベント開催をしたり、その地域の取り組みなどを紹介したりしている。それと全く同じことを、コワーキングスペースの利用者に対してもその付加価値というのはあるかもしれないと私もよいアイディアだと思った。例えば、大阪のコワーキングスペースの利用者を広島へ連れていって、そこでイベントやって交流する。その逆も然り。通常のコワーキングスペースの利用者は自ら広島のコワーキングスペースへ行ってコラボレーションを行ったりしない。いや、いとうさんみたいに自らやる人もいるんだけど、そんな人は対象の利用者ではない。自分からは行かないが、誘われたら行ってもいいかなと考える人 (私もそんな1人だ) を移動させることで、新しい価値やアイディアが生まれるかもしれないと思える。私もいまはフルタイムのお仕事があるから自由に移動はできないが、いずれ会社の投資期間に入って、自分でスケジュールを決められる状況になれば、コワーキングツアーにも出掛けてみようと思う。</p><p>あと勉強会やイベント以外でコワーキングスペースで出来ることはないか？という話題でも盛り上がった。私は主催者の準備が大変だと出来ないから、主催者のコストが低いものという視点から考えて猫コワーキングがいいんじゃないかと提案してみた。ある週だけコワーキングスペースに猫が10匹ぐらいいますといった取り組み。課題は猫をどこから連れてくるかだけだが、そういう機会があれば確かに私も行ってみたい。そのアイディアの発散で非日常の体験ができるような取り組みがよいんじゃないかとまとめられていた。</p><ul><li>猫コワーキング (猫がたくさんいる)</li><li>深夜コワーキング (深夜に開いている)</li></ul><p>深夜コワーキングスペースのモデルとなる <a href=https://20db.stores.jp/>弐拾dB</a> さんというコワーキングスペースが広島の尾道にあるらしい。23-翌5時という営業時間だという。いとうさんが絶賛していたのでおもしろいオーナーが運営されているのだと思う。そのオーナーが執筆したエッセイの <a href=https://20db.stores.jp/items/61869c960548e03fb98a95ac>頁をめくる音で息をする</a> を購入してみた。</p></div></article><div class=pagination><div class=pagination__buttons><a href=/diary/tags/go/ class="button previous"><span class=button__icon>←</span>
<span class=button__text>最近の日記</span></a>
<a href=/diary/tags/go/page/3/ class="button next"><span class=button__text>過去の日記</span>
<span class=button__icon>→</span></a></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>© 2021 Tetsuya Morimoto</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>