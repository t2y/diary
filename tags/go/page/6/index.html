<!doctype html><html lang=en><head><title>Go :: </title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/tags/go/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="Go"><meta property="og:description" content><meta property="og:url" content="/diary/tags/go/"><meta property="og:site_name" content><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/tags/go/index.xml rel=alternate type=application/rss+xml title></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><h1>Posts for: #Go</h1><div class=posts><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0810/>出張帰りにオフィスに寄って開発する</a></h1><div class=post-meta><time class=post-date>2023-08-10</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/logging/>logging</a>&nbsp;
#<a href=/diary/tags/github/>github</a>&nbsp;
#<a href=/diary/tags/python/>python</a>&nbsp;</span><div class=post-content><p>18時19分の新幹線に乗って21時前に新神戸駅に着く。この時間帯で帰ってくるのが楽な気がする。新神戸駅についたらいつもそこからタクシーで帰りたいと思う。いまうちの会社は全然儲かってないのでそんなことできないけれど、いつか余裕ができたら出張帰りの電車乗り継ぎをやめてタクシーで直帰してよいルールにしたい。</p><h2 id=go-121-への移行>go 1.21 への移行</h2><p>昨日 <a href=https://go.dev/blog/go1.21>Go 1.21 is released!</a> されたことを知った。自分の作業を中断して早めに移行して問題があれば検出できるしておきたかったので 1.20 から 1.21 への移行をしていた。もっとも大きな移行としてログ出力をすべて <a href=https://pkg.go.dev/log/slog>log/slog</a> へ移行した。もともと <a href=https://github.com/cybozu-go/log>cybozu-go/log</a> という標準の log パッケージに近いものを使っていたので移行そのものは大きな課題にはならなかった。一方で変更することによって運用にどういった影響が出るかは実際に動かさないと気付かないこともあるだろうという視点で早く移行したかった。昨日の夕方に 1.21 で一通りは動くようにして、今朝から細かいところの修正は他のライブラリとして slices/maps といった新規に追加された標準ライブラリを使うように変更していった。リポジトリが数個あるので単純に労力だけの問題。ついでに go-ldap の ci 環境の設定も変えておいた。</p><ul><li><a href=https://github.com/go-ldap/ldap/pull/457>Add go 1.21 build/testing to github workflow #457</a></li></ul><h2 id=github-api-tools-再び>github-api-tools 再び</h2><p>帰りの新幹線の中でてらださんとやり取りしていた。issue 検索に llm の技術を使ってサンプルアプリケーションを作るというアイディアが進んでいて、公けの github issues のデータを使えばいいという話しをした。実際に学習データにするには、一定の前処理したテキストとメタデータが必要になる。github issues からあるプロジェクトの情報を一括で取得する方法はないか？という相談を受けて、github の rest api などを使って取得するのがよいのではないか？と提案した。</p><p>私も過去に github での作業時間の検証のために <a href=https://github.com/kazamori/github-api-tools>github-api-tools</a> というツールを作っていた。21時半頃にオフィスに戻ってきて、せっかくなので試しにやってみるかと翌1時過ぎぐらいまでコードを書いていた。過去にも issues の機能も作った方がよいよねという課題は残してあった。</p><ul><li><a href=https://github.com/kazamori/github-api-tools/issues/1>Add issue statistics #1</a></li></ul><p>python のコードを滅多に触る機会がなくなってしまったので勘所を思い出したりするのにやや手間取った。それでも自分が過去に作ったものなのですぐにできた。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0805/>go-ldap の syncrepl 機能のレビュー対応</a></h1><div class=post-meta><time class=post-date>2023-08-05</time></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/ldap/>ldap</a>&nbsp;
#<a href=/diary/tags/network/>network</a>&nbsp;
#<a href=/diary/tags/project-management/>project management</a>&nbsp;</span><div class=post-content><p>1時に寝て何度か起きて7時に起きた。今週もよく働いたからバテバテ。</p><h2 id=ストレッチ>ストレッチ</h2><p>これまでも慢性的に右足全般は悪かったのだけれども、今日は左足の張りがある (痛い) ところと右足の張りがある (痛い) ところが全然違うことに気付いた。トレーナーさんによるとさらに今日はいつもより上半身の腕も硬かったという話しだった。これから1ヶ月か、1ヶ月半ほどは開発の佳境で忙しくなる (座っている時間が長くなる) ので体調がよくなることはないと思う。今日の開脚幅は開始前155cmで、ストレッチ後158cmだった。普段通りなのでこの調子なら問題ない。</p><h2 id=syncrepl-のレビュー対応>syncrepl のレビュー対応</h2><p><a href=/diary/posts/2023/0804/#syncrepl-機能の-pr-の続き>先日のレビュー対応</a> の修正。通信プロトコルの処理を実装するには想定したパケット (byte 列) をデコードしないといけない。そのために誤っているとすぐに panic する。開発しているときは既存の処理の振る舞いと競合してあちこちで panic してデバッグが容易ではなかった。そこで既存処理とは分割して先ずは実装した。その後、プロトコルの仕様と対応するパケットを理解してしまえば、どこを直せばよいか把握できているので既存の処理と共存させることはとくに難しくなかった。私の先入観であちこち変更しないといけないのでは？と思い込んでしまっていたのをレビューアの指摘で気付くことができた。感謝。</p><ul><li><a href=https://github.com/go-ldap/ldap/pull/447>Add syncrepl (rfc-4533) consumer (persistent search) #447</a></li></ul><p>これでレビュー対応を終えた。pr を送ってから2週間放置されていた。そこでレビューしてくれないかとお願いしたら2人のメンテナーがすぐにレビューしてくれた。これは <a href=/diary/posts/2023/0703/#非同期の-ldap-検索の-api>非同期検索</a> でのやり取りを経て私の信頼があがっていたためと思われる。この機能はお仕事の開発にも使う。ちょうどいま開発の佳境に際して花を添えるよいタイミングと言える。</p><h2 id=進捗報告の資料作り>進捗報告の資料作り</h2><p>気付いたら来週は出張の週になる。月例報告のための資料を作っていないことに今日気付いて慌てて資料を作った。いまは開発の佳境の時期なので、開発方法論に新しいことを試しているわけでもないし、この1ヶ月のやったことの進捗を報告するだけ。内容は固まっていて資料を作るのはそんなに大変ではない。理想的なスケジュールだと9月上旬で開発完了を目指していたが、それは無理そうだと判断した。その次のイテレーションで完了できるように目指す。さらに追加でバッファのイテレーションももう1つある (と私が勝手に思っている) 。2つイテレーションを伸ばすと開発は1ヶ月の遅延となる。このぐらいのブレは私の中では許容範囲だけれども、一般の会社だと認められるのかどうか、開発マネジメントの機微によって分かれるのかもしれない。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0723/>オフィスは夜の方が涼しい</a></h1><div class=post-meta><time class=post-date>2023-07-23</time></div><span class=post-tags>#<a href=/diary/tags/founding/>founding</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/scim/>scim</a>&nbsp;</span><div class=post-content><p>22時からオフィスで作業していたのもあり、そのまま夜通しで作業して、6時に帰ってきて寝て9時に起きた。こんなことやっているから体調が悪くなりそうな気がする。宅急便を受け取る必要があったので午前中はのんびりしてた。なぜか宅配ボックスは毎日埋まっていてまったく使えない状態になっている。今後はコンビニ受け取りかオフィスに送るようにしよう。</p><h2 id=ジモティー検索>ジモティー検索</h2><p>以前 <a href=/diary/posts/2023/0505/#ジモティーで椅子の受け取り>ジモティーで椅子を購入</a> してよかったので実家で使う家具でよさそうなもの、具体的にはダイニングテーブルを探している。</p><p>ジモティーとヤフオクの違いとして、ジモティーはオークションじゃないから持ち主が処分したい品物はゼロ円で譲りますと出品されていたりする。その代わり、送付はせず引き取りが必須となる。ダイニングテーブルのような大きいものだと粗大ゴミに出すにもお金がいるから持っていってくれるならそれでいいといった感覚だろうか。さらに地域に特化した引き取りを必須条件にするので誰もが応募できるわけでもない。常にみていなくてもタイミングがあえば格安で入手できる可能性がある。そこで社用車の荷室スペースのサイズを確認していた。後部座席を倒すことで荷室スペースを拡げられる。このサイズならたいていのダイニングテーブルは積載できそうに思える。</p><ul><li>長さ: 680-1,480mm</li><li>幅: 1,000mm</li><li>高さ: 850mm</li></ul><p>実家の離れオフィスのリモートワーク、さらには今後のコワーキングスペースとして使うときの家具をジモティーでのリサイクルも考慮しながら揃えていきたい。</p><h2 id=scim-向けの-urn-パーサーの拡張>scim 向けの urn パーサーの拡張</h2><p>先日 <a href=/diary/posts/2023/0706/#コードレビュー>チームのメンバーが実装した scim 連携のレビュー</a> をした。そのときに scim の urn のパース処理を自前で実装していた。それ自体は悪くないが、urn のような標準化されたものなら専用ライブラリを使った方がよいのではないか？と思って調べてみた。予想通り作っている人はいたものの、それほど煩雑なものでもないのでライブラリを使うほどでもないのかもしれない。</p><ul><li><a href=https://github.com/leodido/go-urn>github.com/leodido/go-urn</a></li></ul><p>例えば、次のような scim 向けの urn がある。</p><pre tabindex=0><code>urn:ietf:params:scim:schemas:core:2.0:User
</code></pre><p>go-urn は汎用の urn パーサーなので scim に特化した属性などをパースしてくれない。それについて issue で質問してみたら、scim 向けのサブパーサー作ったらいいんじゃない？というコメントが返ってきた。そこで <a href=https://datatracker.ietf.org/doc/html/rfc7643#section-10>rfc-7643</a> の urn の仕様を眺めながら試しに実装してみた。この機能がマージされてもこの用途のためだけに依存ライブラリを増やすかどうかはまだ懐疑的なところ。とはいえ、せっかく調査して実装したから誰かの役に立つかもしれないと思って pr を送った。</p><ul><li><a href=https://github.com/leodido/go-urn/pull/33>Add scim (rfc 7643) specific struct #33</a></li></ul></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0719/>go-ldap の syncrepl 対応</a></h1><div class=post-meta><time class=post-date>2023-07-19</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/ldap/>ldap</a>&nbsp;
#<a href=/diary/tags/network/>network</a>&nbsp;</span><div class=post-content><p>2時に寝て2回ぐらい起きて6時半に起きた。お休みとったからいろいろ余裕がないけれど、体力だけはある。</p><h2 id=syncrepl-機能の実装>syncrepl 機能の実装</h2><p><a href=/diary/posts/2023/0703/#非同期の-ldap-検索の-api>go-ldap の非同期検索</a> の続き。<a href=/diary/posts/2023/0704/>persistent search という用語</a> も理解して、満を持して openldap の <a href=https://www.openldap.org/doc/admin25/replication.html>syncrepl</a> 対応に臨んでいた。syncrepl を用いた persistent search というのは、簡単に言えばメッセージキューで言うところの pubsub のコンシューマーに相当する。その通信のテストやデバッグをしているときに非同期検索のバグもみつけた。余計なことをして返って複雑なバグを混入したなと反省しながら修正の pr を送った。</p><ul><li><a href=https://github.com/go-ldap/ldap/pull/446>Fix a deadlock issue using search asynchronously #446</a></li></ul><p>go-ldap の ldap 通信の処理や設計を理解するのに2日、<a href=https://datatracker.ietf.org/doc/html/rfc4533>rfc-4533</a> を読みながら Control に関するプロトコル実装に1日、テストやデバッグ、その他の調査や設計に2日ぐらい、次の pr を作るのに1週間 (平日5日) ほどは工数を割いた。</p><ul><li><a href=https://github.com/go-ldap/ldap/pull/447>Add syncrepl (rfc-4533) consumer (persistent search) #447</a></li></ul><p>ローカル環境で単体レベルの動作は問題ないと思う。あとは私が知らない ldap プロトコルの振る舞いや単体レベルで検証できていない通信、実際の運用レベルの syncrepl の状態やエラーなどに耐えられるかどうかといったところだと思う。おそらく rfc を読みながらプロトコルの一部を私が実装したのは初めてかもしれない。もうサーバーサイドやバックエンドの領域で (スキルの多寡はあれども) 私が作れないものはそうないだろうという自信をもっている。実際に rfc で提案されたプロトコルを実装して、テストして、ちゃんと動いて、そういう日々がすごく楽しくて嬉しかった。根拠のなかった自信を確認できた。またレビューに時間かかるかな？マージのためのやり取りや修正に2週間から1ヶ月ぐらいを見込む。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0714/>メモリリークに遭遇</a></h1><div class=post-meta><time class=post-date>2023-07-14</time></div><span class=post-tags>#<a href=/diary/tags/operation/>operation</a>&nbsp;
#<a href=/diary/tags/testing/>testing</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;</span><div class=post-content><p>23時に寝て何度か起きて5時に起きてからだらだらネットしながら記事を読んだりしていて7時に起き上がった。</p><h2 id=agent-アプリケーションのメモリリーク調査>agent アプリケーションのメモリリーク調査</h2><p>qa テストの一環として先月からテスト環境で毎分 agent アプリケーションにリクエストを投げる長時間稼働テストを実行している。なんとなく気になるところがあったからやったわけではあるけれど、長時間稼働テストによってメモリリークを検出できてしまった。自分を過信せずちゃんと検証しないといけないなと思えた。top コマンドの実メモリー (RES) を1ヶ月前と比較して増えているからメモリリークだと気付いたところ。これからメモリプロファイリングをしながら原因を追求していく。私が書いた (レビューした) go のコードでメモリリークはないだろうと高をくくっていただけにちょっとショックではあった。</p><p>go は標準ライブラリに pprof というプロファイラがあるので簡単にデバッグできる。プロファイラで昨日から調査していたところ、<a href=https://github.com/go-zeromq/zmq4>go-zeromq/zmq4</a> の処理でメモリリークしていることはわかった。それがライブラリの使い方が誤っているのか、潜在的な不具合なのかはまだこれから調査するところ。</p><p>ライブラリ側の問題を調査するので厄介ではあるけど、私が書いた (レビューした) go のコードでメモリリークしているわけじゃないことがわかって少しほっとした。</p><h2 id=go-の-generics-勉強会>go の generics 勉強会</h2><p><a href="/diary/posts/2023/0707/#go-の-generics 勉強会の準備">先日準備した資料</a> を使って勉強会を開催した。</p><ul><li><a href=https://github.com/t2y/go-generics-study>https://github.com/t2y/go-generics-study</a></li></ul><p>この勉強会はある意味、うちのチームのメンバーが理解しておくべき内容なので go のプログラミングをやっていないメンバーが聞いてもあまり関心をもてない内容となっている。そういうお断りもした上で最悪2-3人ぐらいの参加者になるかと思ったもののプログラミングに関心がある人たちは参加してくれて5-6人ぐらいの規模にはなった。一方で内容も難しいし、私の説明がどれだけわかりやすかったか、私自身にはわからないのでなんとも言えない。質問も一切なかったので喋りきって疲れたという疲労感と、伝わったのか伝わらなかったのか分からない消化不良感と、金曜日だから今日はもういいや感でどっと疲れたというのが率直な感想になる。</p><p>とはいえ、私もずっと generics の仕様をちゃんと追いかけたいと思いながら先送りしていたものではあるので私の中では自分が go の generics の理解度をあげて実際の開発の中で使い分けるだけの判断基準をもてたことが収穫だったと言える。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0713/>縁の下のマネージャー</a></h1><div class=post-meta><time class=post-date>2023-07-13</time></div><span class=post-tags>#<a href=/diary/tags/design/>design</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/logging/>logging</a>&nbsp;
#<a href=/diary/tags/security/>security</a>&nbsp;</span><div class=post-content><p>20時にホテルに戻ってきてのんびりしながら気付いたら22時ぐらいになって、少しテレビをみて0時に寝て4時ぐらいから起きてその後はあまり眠れなかった。それでも7時過ぎまでだらだらしていた。</p><h2 id=7月後半に実装予定の新機能の設計>7月後半に実装予定の新機能の設計</h2><p>9月までに実装する新機能のうち、唯一、私の頭の中で設計の見通しをもっていなかった機能の設計を行うことにした。</p><p>ざっくりした機能概要から私がふわっと想定していたものはずっと複雑なものだったのだけど、プロダクトオーナーに要件をヒアリングしているうちにそんな高度なものは求められていないことに気付いた。逆にその高度な機能の仕組みを提供しても、実際に運用の現場で使うにあたって手間暇だけかかってそんなものを求めていないと言われそうな気がした。そこで私が作りたいなと思っていた設計のアイディアは封印することにした。既存の先行プロダクトがもっている機能とほぼ同様のものを、うちらの開発しているプロダクトで実現するだけでよさそうにみえた。そのシンプルな機能の設計を軽くやっておいた。詳細を詰めるのは次のマイルストーンで私ではないメンバーに実装してもらうことになるけれど、なんとなく当初の想定よりも早くできそうに思えた。</p><h2 id=ログ出力のリファクタリング>ログ出力のリファクタリング</h2><p>id 連携の処理で複雑なリソースを map 型で扱うときデバッグ用途でリソースを丸ごと dump したい。しかし、パスワードのような機密情報が含まれる場合はそれらはログに出力したくない。この処理をいまは連携種別ごとに実装していて、本質じゃないところで個別実装の手間があるのと機密情報の出力というセキュリティに関するところを毎回プログラマーが手で実装するのもどうかな？という気がして汎用のログユーティリティとしてロガーのライブラリ側で提供することにした。インフラやプラットフォーム的な機能に私は積極的に開発に介入している。</p><p>やり方の1つとしてオリジナルのリソースをコピーして機密情報だけ削除した一時的なリソースコピーを dump してログ出力する。go 1.21 で標準ライブラリに追加される <a href=https://pkg.go.dev/golang.org/x/exp/maps>maps</a> パッケージを使うと map の操作が簡単にできる。コピー関数もある。しかし、この機能は shallow copy なので map の値にネストした map が含まれる場合はオリジナルの値を書き換えてしまう。ネストした map を調べてそれらもクローンしていく処理を実装した。excludeKeys に除外したい任意のキーを渡し、map の値を再帰的にチェックして取り除く。最終的には次のようなコピーユーティリティになった。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>copyWithoutExcludeKeys</span>(
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fields</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>any</span>, <span style=color:#a6e22e>excludeKeys</span> []<span style=color:#66d9ef>string</span>,
</span></span><span style=display:flex><span>) <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>any</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>cloned</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>maps</span>.<span style=color:#a6e22e>Clone</span>(<span style=color:#a6e22e>fields</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>k</span>, <span style=color:#a6e22e>v</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>cloned</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>t</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>v</span>.(<span style=color:#66d9ef>type</span>) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>:
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>strMapCloned</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>maps</span>.<span style=color:#a6e22e>Clone</span>(<span style=color:#a6e22e>t</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>sk</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>maps</span>.<span style=color:#a6e22e>Keys</span>(<span style=color:#a6e22e>strMapCloned</span>) {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>slices</span>.<span style=color:#a6e22e>Contains</span>(<span style=color:#a6e22e>excludeKeys</span>, <span style=color:#a6e22e>sk</span>) {
</span></span><span style=display:flex><span>					delete(<span style=color:#a6e22e>strMapCloned</span>, <span style=color:#a6e22e>sk</span>)
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>cloned</span>[<span style=color:#a6e22e>k</span>] = <span style=color:#a6e22e>strMapCloned</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>any</span>:
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>cloned</span>[<span style=color:#a6e22e>k</span>] = <span style=color:#a6e22e>copyWithoutExcludeKeys</span>(<span style=color:#a6e22e>t</span>, <span style=color:#a6e22e>excludeKeys</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> []<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>any</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>v</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>t</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>t</span>[<span style=color:#a6e22e>i</span>] = <span style=color:#a6e22e>copyWithoutExcludeKeys</span>(<span style=color:#a6e22e>v</span>, <span style=color:#a6e22e>excludeKeys</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>slices</span>.<span style=color:#a6e22e>Contains</span>(<span style=color:#a6e22e>excludeKeys</span>, <span style=color:#a6e22e>k</span>) {
</span></span><span style=display:flex><span>				delete(<span style=color:#a6e22e>cloned</span>, <span style=color:#a6e22e>k</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>cloned</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0707/>七夕と願い</a></h1><div class=post-meta><time class=post-date>2023-07-07</time></div><span class=post-tags>#<a href=/diary/tags/founding/>founding</a>&nbsp;
#<a href=/diary/tags/management/>management</a>&nbsp;
#<a href=/diary/tags/issue-management/>issue management</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;</span><div class=post-content><p>23時に寝て2時に起きて6時に起きた。旅行から帰ってきてから最近はこのパターンになってきた。</p><p>google のロゴが <a href=https://www.google.com/doodles/tanabata-2023>Tanabata 2023</a> になっていて七夕だと気付いた。もう私にとって願いというのは健康を祈るぐらいしかない。残された寿命を使い切る前にいまやっていることをやり切りたい、もしくはその結果をみたいと思っていて、そのために必要なことは健康ぐらいかなと。</p><h2 id=隔週の雑談>隔週の雑談</h2><p>顧問のはらさんと隔週の打ち合わせ。今日の議題はこれら。</p><ul><li><a href=/diary/posts/2023/0628/>ADLIV さんふりかえり</a></li><li><a href=/diary/tags/sightseeing/>社員旅行の同行ふりかえり</a></li></ul><p>他社の社員旅行へ同行してみての所感として学ぶことは多々あった。</p><ul><li>強制参加にはしない (断ってもよい)</li><li>仕事だけではない人間関係の構築という価値観を大事にしている</li><li>上下関係がフラットなので参加者が自由に行動したり話したりできる</li><li>経営陣や上司に忖度しないメンバーがいることでフラットな関係性を共有できる</li><li>チーム単位で行動できるので組織の全体行動を強制される感覚が緩和される</li></ul><p>野中郁二郎先生は業務外での暗黙知を共有する「場」づくりが大事だと説いている。会社が危機のときやしんどいお仕事をこなすとき、最後は経営者やリーダーの人生観や価値観がモノを言うという考え方がある。そんなときにこういった価値観の共有は役に立つのかもしれない。「社員旅行」という単語自体が古い価値観をイメージしてネガティブに聞こえる。いまだったらワーケーションと呼ぶ方がよいかもしれない。</p><p>過去にスタートアップで働いていたとき、会社が M&amp;A で売却して、私にとってはあまりメリットがなかったので即断で辞めると伝えた。即断できたのは経営者に理念がなかったからというのも大きな要因の1つだといまになって思える。時期の差はあれど、私以外の主要メンバーもその後に全員辞めた。要はそういうこと。</p><h2 id=go-の-generics-勉強会の準備>go の generics 勉強会の準備</h2><p>水曜日から資料を作っている。昨日はほぼまる一日コードレビューをやっていた。午前中の半日を費やしてようやく完成した。この資料は一般の go 勉強会でも使えるなと思ったのでお手伝い先のプロダクト開発に関するところを取り除いた資料を別途公開した。資料の中でその内容を検証するサンプルコードも次のリポジトリで公開している。</p><ul><li><a href=https://github.com/t2y/go-generics-study>https://github.com/t2y/go-generics-study</a></li></ul></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0705/>go の generics 勉強会へ向けての準備</a></h1><div class=post-meta><time class=post-date>2023-07-05</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;</span><div class=post-content><p>0時に寝て6時に起きて7時に起きた。週明けから忙しくて余裕ない。それでもよく眠れていることが幸い。</p><h2 id=go-の-generics-勉強会の準備>go の generics 勉強会の準備</h2><p>今週末の金曜日に勉強会をする想定で作り始めた。generics は難しいのでなかなか本腰を入れて取り組めていなかった。基本的には tenntenn さんの <a href=https://tenn.in/generics>プログラミング言語Go完全入門 15章ジェネリクス（型パラメタ）</a> の資料をベースに、自分で理解できるように調査したり、サンプルコードを書いたり、自分で理解した内容を補足したりして資料を作り始めた。go 1.18 のジェネリクスで導入された概念は次になる。これらのキーワードに関するところをそれぞれ調べることにした。</p><ul><li>型パラメーター</li><li>型引数</li><li>インターフェースによる制約 (Type constraint)</li><li>型セット (Type sets)</li></ul></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0703/>リフレクションにはまった半日</a></h1><div class=post-meta><time class=post-date>2023-07-03</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/ldap/>ldap</a>&nbsp;
#<a href=/diary/tags/mongodb/>mongodb</a>&nbsp;
#<a href=/diary/tags/reflection/>reflection</a>&nbsp;</span><div class=post-content><p>23時に寝て5時に起きて6時半に起きた。ストレッチで伸ばしたせいか、いつもよりよく眠れた。先週は主に旅行へ行っていて非日常でリフレッシュした。今朝は朝ご飯に野菜サラダを作って食べて7時半には家を出れた。</p><h2 id=非同期の-ldap-検索の-api>非同期の ldap 検索の api</h2><p>先日送った <a href=/diary/posts/2023/0601/#チャンネルを用いた-ldap-検索の-api>go-ldap の pr</a> を完了した。送ったときはチャンネル用いた検索 api だったのだけど、それから設計を議論して非同期検索を主とした api として生まれ変わった。レビューに1ヶ月を要したものの2人のメンバーから approve をもらって無事にマージされた。</p><ul><li><a href=https://github.com/go-ldap/ldap/pull/440>Add search asynchronously with context #440</a></li></ul><p>この一歩は大きくてこの機能を突破口にうちらの要件に足りない機能を実装していく。プロトコル部分の修正が過去の draft 実装から参考にできるのであれば今週中にはまた pr を送りたい。</p><h2 id=mongodb-の-unmarshal-実装>mongodb の unmarshal 実装</h2><p>mongodb-driver での bson の marshal/unmarshal を実装する。<a href=https://pkg.go.dev/go.mongodb.org/mongo-driver/bson>mongo-driver/bson</a> に unmarshal について2つの interface が紹介されている。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Unmarshaler</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>UnmarshalBSON</span>([]<span style=color:#66d9ef>byte</span>) <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ValueUnmarshaler</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>UnmarshalBSONValue</span>(<span style=color:#a6e22e>bsontype</span>.<span style=color:#a6e22e>Type</span>, []<span style=color:#66d9ef>byte</span>) <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>bson の byte 列を unmarshal するにあたり、構造体そのものには <code>UnmarshalBSON()</code> を、構造体のメンバーには <code>UnmarshalBSONValue()</code> を使う。これでうまくいきそうに思えたのだけど、interface を介したデコード処理で意図した振る舞いにならないことに気付いた。mongodb-driver は decode/unmarshal 処理を <a href=https://pkg.go.dev/reflect>reflect</a> を使って実装している。要件の詳細は省く (interface を使いたい背景がある) が、再現コードが次になる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>MyInterface</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MyFunc</span>() <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>MyType</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>MyType</span>) <span style=color:#a6e22e>MyFunc</span>() <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>tMyInterface</span> = <span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>TypeOf</span>((<span style=color:#f92672>*</span><span style=color:#a6e22e>MyInterface</span>)(<span style=color:#66d9ef>nil</span>)).<span style=color:#a6e22e>Elem</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>some</span>(<span style=color:#a6e22e>v</span> <span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>Value</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>f</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>v</span>.<span style=color:#a6e22e>Convert</span>(<span style=color:#a6e22e>tMyInterface</span>).<span style=color:#a6e22e>MethodByName</span>(<span style=color:#e6db74>&#34;MyFunc&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;got&#34;</span>, <span style=color:#a6e22e>f</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;=========&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>t1</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>MyType</span>{}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>some</span>(<span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>ValueOf</span>(<span style=color:#a6e22e>t1</span>))
</span></span><span style=display:flex><span>	<span style=color:#75715e>// the zero value of an interface is nil
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>t2</span> <span style=color:#a6e22e>MyInterface</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>some</span>(<span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>ValueOf</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>t2</span>).<span style=color:#a6e22e>Elem</span>())
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>このコードを実行すると次のエラーになる。</p><pre tabindex=0><code>panic: reflect: Method on nil interface value
</code></pre><p>ドキュメントにも interface の nil の値を呼び出すと panic するよと書いてある。</p><blockquote><p>Method returns a function value corresponding to v&rsquo;s i&rsquo;th method. The arguments to a Call on the returned function should not include a receiver; the returned function will always use v as the receiver. Method panics if i is out of range or if v is a nil interface value.</p><p><a href=https://pkg.go.dev/reflect#Value.Method>https://pkg.go.dev/reflect#Value.Method</a></p></blockquote></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0627/>scim 調査に着手</a></h1><div class=post-meta><time class=post-date>2023-06-27</time></div><span class=post-tags>#<a href=/diary/tags/remote-work/>remote work</a>&nbsp;
#<a href=/diary/tags/scim/>scim</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;
#<a href=/diary/tags/meta-programming/>meta programming</a>&nbsp;</span><div class=post-content><p>22時に寝て24時に起きて4時に起きて6時に起きた。実家だとやることないので寝るのも早くなる。早く起きているので始業も7時半ぐらいになる。早起きは三文の徳。</p><h2 id=リモートワークのタグを新設>リモートワークのタグを新設</h2><p>神戸のオフィスに行かなかった日は <a href=/diary/tags/day-off/>day off</a> というタグを付けている。名前の通り、お休みしたということを表す。この定義に従うと、実家に帰ってリモートワークをしたときもお休みになってしまうため、それを区別するように <a href=/diary/tags/remote-work/>remote work</a> というタグを作った。</p><h2 id=scim-調査>scim 調査</h2><p>id 連携の文脈で <a href=https://en.wikipedia.org/wiki/System_for_Cross-domain_Identity_Management>System for Cross-domain Identity Management</a>
(頭文字をとって SCIM、すきーむと呼ばれている) という標準がある。基本的には rest api とスキーマを扱うように仕様が決められていて、それに準拠したサービス間で id 連携を標準化する狙いがある。id 連携と同じ用途を表す用語として id プロビジョニングという用語もあるが、多くのクラウドサービスでは id プロビジョニングのために scim 対応していたりする。</p><p>たまたまサイボウズさんが okta と scim 連携に対応しているプレスリリースをみかけた。</p><ul><li><a href=https://www.okta.com/jp/press-room/press-releases/okta-cybozu-scim/>サイボウズの「cybozu.com」がプロビジョニング自動化実現のため、「Okta Integration Network」とのSCIM連携に対応</a></li></ul><p>その延長で調査していたところ、go の scim ツールを提供していることに気付いた。しかもこれを作っているのが <a href=https://lestrrat.github.io/>Maki</a> さん。これはソースを読んでおこうと思った次第。Maki さんはメルカリに所属していたと思うのでこれは副業でやっているのかな？</p><ul><li><a href=https://github.com/cybozu-go/scim>github.com/cybozu-go/scim</a></li><li><a href=https://github.com/cybozu-go/scim-server>github.com/cybozu-go/scim-server</a></li></ul><p>scim-server は scim ライブラリを実際に使うときの参照実装としてアプリケーションの開発者に開発の雰囲気を伝えるための実装になっている。これ自体をプロダクトのサーバーとして使うわけではない。sqlite を使ってユーザー／グループの crud な操作と検索機能を提供している。</p><p>scim ライブラリのソースコードも軽くざっと読んでみた。<a href=https://github.com/lestrrat-go/sketch>github.com/lestrrat-go/sketch</a> という go でスキーマを記述してコード生成する Maki さん製のツールがある。これを起点に scim のプロトコルやリソースの仕様にしたがって go のコードでスキーマを定義し、リソースに関する go のコードと scim スキーマを自動生成している。sketch というツールに関連して他にも Maki 製のメタプログラミングライブラリを多用していて、scim の標準化されている部分のエンドポイントやリソースのインターフェース部分をすべてコード生成している。</p><p>go generate やコード生成の実際の応用例として非常に参考になる。このライブラリは scim のプロトコル仕様に関する開発者と、そのエンドポイントの実際の処理 (バックエンド) の開発者を明確に分離するという開発体制を期待している。scim に関するところは Maki さんが独りでコード生成を多用してオープンなプロトコル仕様の開発を担当し、そのバックエンドをサイボウズさんの開発者が実装するという分業体制を想定しているようにみえる。</p><p>scim 対応のアプリケーション開発のプロトコル部分を外部に委譲するといった設計になっているが、scim が十分に安定していてプロトコルの仕様が変わらないのであれば理に適っているとも考えられる。バックエンドの開発者はいくらか sketch の学習コストを強いることになる。そのため、アプリケーションはその学習コストを支払ってもコード生成のメリットが上回るだけの規模や特性を要求する。おそらく scim はそれだけの価値があると判断されたのだと推測する。</p><p>私はメタプログラミングが好きな方なのでこういうやり方もあるんだなと設計の参考になった。またコード生成の要件があったときにソースを参考にしようと思う。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0626/>実家での初めてのリモートワーク</a></h1><div class=post-meta><time class=post-date>2023-06-26</time></div><span class=post-tags>#<a href=/diary/tags/remote-work/>remote work</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/network/>network</a>&nbsp;
#<a href=/diary/tags/founding/>founding</a>&nbsp;
#<a href=/diary/tags/coworking/>coworking</a>&nbsp;</span><div class=post-content><p>23時に寝て2時に起きて4時に起きて6時に起きた。親が4時頃から作業し始めるからそのぐらいからだらだら起きている。その影響で8時前からお仕事を始めた。</p><h2 id=パスワードの表現の答え合わせ>パスワードの表現の答え合わせ</h2><p>先週末に課題としていた <a href=/diary/posts/2023/0623/#パスワードの表現>パスワードの表現</a> になかなか苦労したようで半日ぐらいかかった。私が答えを言うのではなく、本人が自分で考えて、自分で調べて実装できるまで粘り強く待っていた。概ね、私の模範解答に近いものを実装してきて、コードレビューで少し手直しはあったものの、go でコンストラクタに近いものを実装する方法を学んだと思う。</p><h2 id=実家の離れスペースで働いてみた>実家の離れスペースで働いてみた</h2><p>今朝は軽く雨が降っていて、それ以降もずっと曇っていた。天気がどんよりしていたのもあり、エアコンは除湿に設定してソファで働いてみた。数年前から淡路島に帰ってきてリモートワークをしたことは何度かあったが、すべてマクドナルドへ行って電源を借りて作業していた。実家で丸1日リモートワークで働いたのは今回が初めてだと思う。どんな施設でもインターネットとエアコンさえあれば働けるということを改めて実感した。実家なのでお昼になったらおかんがお昼ご飯だと呼びに来る。食べるものも考えなくてよい。</p><p><a href=/diary/posts/2023/0504/#iijmio-と-iphone-で作るモバイル-wifi-ルーター>iphone で作った wifi ルーター</a> の 2GiB プランで契約している。普通に macbook でリポジトリを操作したり、課題管理を使ったり、ブラウザで調べものしたり、slack でやり取りしたりしていたら約9時間で 987 MiB の通信量となった。いまやネットワークの通信量を意識することはないと思うが、普通にお仕事したらいまの時代1日 1GiB ぐらい使うもんなんやと気付いた。</p><p>iijmio の管理画面で日次の通信量を当日分も含めて確認できる。</p><figure><img src=/diary/img/2023/0626_usage.png></figure><p>1週間とか、実家でリモートワークするなら 2GiB プランだと全然足りない。機をみて 5/10 GiB 程度のプランに変更するとよさそう。これでコワーキングスペースにして複数人が使う想定なら光回線をひかないとネットワークが厳しいということも理解できた。光回線をひくと安くても5,000円/月は固定費がかかってくるので維持費の問題は悩ましいことも分かってきた。</p></div></article><div class=pagination><div class=pagination__buttons><a href=/diary/tags/go/page/5/ class="button previous"><span class=button__icon>←</span>
<span class=button__text>最近の日記</span>
</a><a href=/diary/tags/go/page/7/ class="button next"><span class=button__text>過去の日記</span>
<span class=button__icon>→</span></a></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2024 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>