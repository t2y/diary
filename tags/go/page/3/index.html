<!doctype html><html lang=en><head><title>go :: forest nook</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/tags/go/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="go"><meta property="og:description" content><meta property="og:url" content="/diary/tags/go/"><meta property="og:site_name" content="forest nook"><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/tags/go/index.xml rel=alternate type=application/rss+xml title="forest nook"></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><div class=posts><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0204/>go の学び直し 静的解析編</a></h1><div class=post-meta><time class=post-date>2023-02-04 (Sat.) ::</time></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/static-analysis/>static analysis</a>&nbsp;
#<a href=/diary/tags/event/>event</a>&nbsp;</span><div class=post-content><p>23時に寝て2時に起きて5時ぐらいにも起きて7時に起きた。昨日は podcast 収録でたくさん話して疲れてしまってそのまま帰ってすぐ寝た。すぐ起きるんだけど。</p><h2 id=ストレッチ>ストレッチ</h2><p>今日の開脚幅は開始前157cmで、ストレッチ後159cmだった。朝出かける前に開脚のストレッチしたら数値よくなるかな？と思ってやってみたらいつもより少しよくなった。ストレッチはいつも通りとも言えるし、腰の張りがまだまだ残っていることも確認できた。疲労が溜まっているんよな。毎週ストレッチしているからこの程度の疲労で済んでいるとも思える。お正月に実家から戻ってきてから1月の東京出張と35日は終えた。来週はまた2月の東京出張とその週末に49日がある。ここまで体力がもてばその次の法要は初盆なので少し空く。体力的に第4四半期の山場と言えるかもしれない。ただがんばる。</p><h2 id=go-の学び直し>go の学び直し</h2><p><a href=https://tenntenn.connpass.com/event/271533/>Gopher塾 #3 - 静的解析を使ったGoの開発ツール制作 入門編 - DAY 1</a> に参加した。</p><p>過去にも <a href=https://t2y.hatenablog.jp/entry/2015/03/11/025123>Python とマクロ、インポートフックと抽象構文木</a> や <a href=https://kazamori.jp/blogs/2020/07/12/java-annotation-processor/>Java のアノテーションプロセッサを試す</a> など、メタプログラミングのアプローチやコード生成などを実務で使ってきたので静的解析にも関心がある。講義内容の詳細は書かないけど、静的解析のような難しい話題に対して4時間という短い時間でとてもよい講義になっていたと思う。go の静的解析の要点や提供されているツールなどを一通り学ぶことができた。もちろん、実用するには試行錯誤や習熟を必要とするけど、取っ掛かりとして十分な内容に思えた。</p><p><a href=https://github.com/gostaticanalysis/skeleton>skeleton</a> というツールを使って静的解析のための analyzer プロジェクトのひな形を作る。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ go install github.com/gostaticanalysis/skeleton/v2@latest
</span></span><span style=display:flex><span>$ skeleton myanalyzer
</span></span><span style=display:flex><span>$ tree myanalyzer
</span></span><span style=display:flex><span>myanalyzer
</span></span><span style=display:flex><span>├── cmd
</span></span><span style=display:flex><span>│   └── myanalyzer
</span></span><span style=display:flex><span>│       └── main.go
</span></span><span style=display:flex><span>├── go.mod
</span></span><span style=display:flex><span>├── myanalyzer.go
</span></span><span style=display:flex><span>├── myanalyzer_test.go
</span></span><span style=display:flex><span>└── testdata
</span></span><span style=display:flex><span>    └── src
</span></span><span style=display:flex><span>        └── a
</span></span><span style=display:flex><span>            ├── a.go
</span></span><span style=display:flex><span>            └── go.mod
</span></span></code></pre></div><p>意図的にテストが落ちるようになっていてすぐ動作確認できる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ go mod tidy
</span></span><span style=display:flex><span>$ go test                                          
</span></span><span style=display:flex><span>--- FAIL: TestAnalyzer <span style=color:#f92672>(</span>0.05s<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    analysistest.go:448: a/a.go:5:6: diagnostic <span style=color:#e6db74>&#34;identifier is gopher&#34;</span> does not match pattern <span style=color:#e6db74>&#34;pattern&#34;</span>
</span></span><span style=display:flex><span>    analysistest.go:512: a/a.go:5: no diagnostic was reported matching <span style=color:#e6db74>&#34;pattern&#34;</span>
</span></span><span style=display:flex><span>FAIL
</span></span><span style=display:flex><span>exit status <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>FAIL	myanalyzer	0.349s
</span></span></code></pre></div><p>いろいろ説明を端折るけど、試しに FuncDecl の ast ノードに対して関数の行数をカウントする処理を実装してみた。<a href=https://pkg.go.dev/golang.org/x/tools/go/analysis#hdr-Pass>analysis パッケージの Pass</a> を使うと便利なユーティリティが提供されていて、静的解析をするときに面倒な処理をショートカットできて簡単に実装できることが理解できた。ここで作った analyzer は go vet で実行できるそうなのでプロジェクトの独自ルールを analyzer で実装して ci でチェックするといった運用もできる。応用範囲は広そう。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>case</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ast</span>.<span style=color:#a6e22e>FuncDecl</span>:
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>Name</span>, <span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>Pos</span>(), <span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>End</span>())
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>start</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>pass</span>.<span style=color:#a6e22e>Fset</span>.<span style=color:#a6e22e>Position</span>(<span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>Pos</span>()).<span style=color:#a6e22e>Line</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>end</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>pass</span>.<span style=color:#a6e22e>Fset</span>.<span style=color:#a6e22e>Position</span>(<span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>End</span>()).<span style=color:#a6e22e>Line</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;the number of lines:&#34;</span>, <span style=color:#a6e22e>end</span><span style=color:#f92672>-</span><span style=color:#a6e22e>start</span>)
</span></span></code></pre></div></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0126/>pure go の javascript 処理系を使ってみた</a></h1><div class=post-meta><time class=post-date>2023-01-26 (Thu.) ::</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/javascript/>javascript</a>&nbsp;</span><div class=post-content><p>23時に寝て2時に起きてだらだらして寝て7時に起きた。<a href=https://yanmaga.jp/comics/%E3%83%86%E3%83%B3%E3%82%AB%E3%82%A4%E3%83%81_%E6%97%A5%E6%9C%AC%E6%9C%80%E5%BC%B7%E6%AD%A6%E8%8A%B8%E8%80%85%E6%B1%BA%E5%AE%9A%E6%88%A6>テンカイチ 日本最強武芸者決定戦</a> という漫画を読んでた。</p><h2 id=pure-go-の-javascript-処理系>pure go の javascript 処理系</h2><p>ユーザー定義スクリプトを実行する要件がある。システム管理者がスクリプトを書くなら javascript がいいかなと次のリファレンスを調べたりしていた。</p><ul><li><a href=https://prasanthmj.github.io/go/javascript-parser-in-go/>How to support custom Javascript scripting in Go Applications</a></li><li><a href=https://go.libhunt.com/goja-alternatives>goja alternatives</a></li><li><a href=https://www.reddit.com/r/golang/comments/u8gyii/choosing_scripting_extension_need_advice/>Choosing scripting extension - need advice</a></li></ul><p>これらを読んだ結果として <a href=https://github.com/dop251/goja>dop251/goja</a> がよいだろうと判断した。README だけ読めばすぐに実装できてめっちゃ簡単で感心した。こういうライブラリを私も会社のプロダクトとして作ってみたい。万人が使うものではなくても、必要なときがたまにあって、すごく使いやすいみたいな。こんな感じで goja の機能を使ってライブラリ実装してみた。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>FunctionCaller</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>funcName</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>args</span> <span style=color:#f92672>...</span><span style=color:#66d9ef>interface</span>{}) (<span style=color:#66d9ef>interface</span>{}, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewFunctionCaller</span>(<span style=color:#a6e22e>script</span> <span style=color:#66d9ef>string</span>) (<span style=color:#a6e22e>FunctionCaller</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>vm</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>goja</span>.<span style=color:#a6e22e>New</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>vm</span>.<span style=color:#a6e22e>RunString</span>(<span style=color:#a6e22e>script</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>funcName</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>args</span> <span style=color:#f92672>...</span><span style=color:#66d9ef>interface</span>{}) (<span style=color:#66d9ef>interface</span>{}, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>f</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>goja</span>.<span style=color:#a6e22e>AssertFunction</span>(<span style=color:#a6e22e>vm</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>funcName</span>))
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to get function: %s&#34;</span>, <span style=color:#a6e22e>funcName</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>funcArgs</span> <span style=color:#f92672>:=</span> make([]<span style=color:#a6e22e>goja</span>.<span style=color:#a6e22e>Value</span>, <span style=color:#ae81ff>0</span>, len(<span style=color:#a6e22e>args</span>))
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>arg</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>args</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>funcArgs</span> = append(<span style=color:#a6e22e>funcArgs</span>, <span style=color:#a6e22e>vm</span>.<span style=color:#a6e22e>ToValue</span>(<span style=color:#a6e22e>arg</span>))
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>value</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>f</span>(<span style=color:#a6e22e>goja</span>.<span style=color:#a6e22e>Undefined</span>(), <span style=color:#a6e22e>funcArgs</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to call javascript function: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>value</span>.<span style=color:#a6e22e>Export</span>(), <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	}, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><a href=https://github.com/dop251/goja#is-it-goroutine-safe>Is it goroutine-safe?</a> によると、goroutine-safe ではないので毎回 js の runtime を生成する必要がある。用途によっては、実行したいスクリプトが大きくなるとオーバーヘッドを無視できない状況もあるかもしれない。うちの要件は小さいユーザー定義スクリプトを実行するだけなのでおそらくそれほど問題にはならないだろうという想定。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0105/>駐車場探し</a></h1><div class=post-meta><time class=post-date>2023-01-05 (Thu.) ::</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/founding/>founding</a>&nbsp;</span><div class=post-content><p>3時に寝て8時に起きた。生活リズムが乱れてきた。</p><h2 id=コードレビュー>コードレビュー</h2><p>年末にマージリクエストが届いていたのをレビューした。http リクエストが失敗したときのリトライ処理を <a href=https://github.com/googleapis/google-api-go-client>google-api-go-client</a> の sdk 側に委譲できないかを調べてみた。いくつか issue も上がっているが、おそらく次の issue の結論にあるように、互換性を考慮すると既存の仕組みを置き換えられないという話しのようにみえる。</p><ul><li><a href=https://github.com/googleapis/google-api-go-client/issues/142>Provide a way to easily retry transient errors #142</a></li></ul><p>sdk としては <a href=https://pkg.go.dev/google.golang.org/api/internal/gensupport#RetryConfig>gensupport#RetryConfig</a> のように、ヘルパー関数は用意されていて、例えば storage サービスでは <a href=https://cloud.google.com/storage/docs/retry-strategy#go>Retry strategy</a> として組み込まれている。しかし、これが sdk の http クライアントレベルで実装されているのではなく、それぞれのサービスごとに実装されているため、サービスによってリトライの仕組みがあったりなかったり、もっと言うとサービスごとに異なるリトライ実装になっていたりする。うちらは admin サービスを使いたいのだけど、そのリトライ処理は自前で実装するしかないというのをコードを読みつつ issue を読みつつ理解した。</p><h2 id=駐車場の契約と保管場所使用承諾証明書の手配>駐車場の契約と保管場所使用承諾証明書の手配</h2><p><a href=/diary/posts/2023/0104/#社用車の購入相談>社用車を購入する</a> にあたって駐車場が必要になる。駐車場は本拠地 (会社のオフィス) から2km以内に借りないといけない。候補の駐車場の管理会社とやり取りして法人名義で駐車場を借りるのは問題ないとのこと。来週は私が出張で留守なので並行して納車の手続きを進めるため、この証明書を急ぎでほしいとお願いしたら今日・明日で作ってくれるということになった。朝から何度か電話して便宜を図ってくれた担当者に感謝。</p><h2 id=オンライン飲み会の準備>オンライン飲み会の準備</h2><p>毎年のことになっていて悪い運用なんだけど、交際費の予算を30万円と見積もっている。現時点で78,913円しか使っていない。交際費の予算消化も兼ねてこれからオンライン飲み会の機会を増やしていく。過去に働いていた職場の後輩と今度オンライン飲み会をすることにした。初めてのお酒を飲めない相手ということでソフトドリンクを手配した。<a href=https://appletiser.jp/>アップルタイザー</a> などがよいんじゃないかと思って混ぜてみた。これが新しいオフィスから <a href=https://www.post.japanpost.jp/service/you_pack/sumahowari/>ゆうパックスマホ割</a> で荷物を送付する初めての事例にもなった。オフィスから郵便局が徒歩2分ぐらいの立地なので郵便を出すのも便利。ほんとうによい立地のオフィスを借りられて満足している。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/1230/>お仕事戻し</a></h1><div class=post-meta><time class=post-date>2022-12-30 (Fri.) ::</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/testing/>testing</a>&nbsp;
#<a href=/diary/tags/device/>device</a>&nbsp;
#<a href=/diary/tags/day-off/>day off</a>&nbsp;</span>
<img src=/diary/img/2022/1230_chair.jpg class=post-cover alt=お仕事戻し title="Cover Image"><div class=post-content><p>0時に寝て5時に起きた。昨日も疲れていたのか、不思議とよく眠れた。</p><h2 id=年末のお仕事戻し>年末のお仕事戻し</h2><p>朝から近所のマクドナルドへ。今週は月・火とお休みしたため、いつも火曜日に書いている週報を書いていなかった。言うても3日分の作業なのでちゃっちゃと書いて送付した。私が休んだ日の定例会議はスキップされたようでその確認はなし。その後、issue のコメントをみたり、マージリクエストのコードレビューをしたりした。メンバーが課題管理システムを使うようになっているので、私が休んでいても後で見返してコメントを返せる。非同期／テキストコミュニケーションは働く時間帯があわないときに役に立つ。そういう雰囲気を学ぶ機会になればいいかもしれない。ある文字列の変換関数に go 1.18 で追加された fuzzing テストを実装してみようというリファクタリングの issue を追加していた。</p><ul><li><a href=https://go.dev/doc/tutorial/fuzz>Tutorial: Getting started with fuzzing</a></li></ul><p>私自身、まだ自分で実装したことはなかった。fuzzing テストを実装したマージリクエストがあったのでコードレビューした。実際に実行して動いているようにはみえるが、デバッグログを出力できなくてどういった振る舞いをしているのかを確認できなかった。簡単にできるんやと思っていたら意外と難しかった。また後で自分でも実装してデバッグしてみて振る舞いを再確認する。</p><h2 id=小さい椅子>小さい椅子</h2><p>葬儀で斎場に2泊3日過ごしたときに畳の控え室に小さい椅子が4つほど置いてあった。正座が難しいお年寄り向けだと推測する。あの控え室でその小さい椅子を最も活用していたのは私だった。地べたに座るのと小さな椅子に腰掛けるので腰の負担がこんなに違うとは思わなかった。おそらく太ったことも影響している。ラップトップでキー入力するときに正座にしろ、あぐらにしろ、どちらも長時間続けることはできなかった。この小さい椅子なら2-3時間ぐらいは平気で作業できる。気持ち程度の高さでも十分に椅子の役割を果たせるところに感心した。家用に購入して、いま小さい椅子でこの日記を書いている。</p><p><a href="https://www.amazon.co.jp/gp/product/B003VIW0PG?ie=UTF8&th=1&linkCode=li1&tag=t2y-diary-22&linkId=233bef8ca8a08ce7593f84b75fbea8cf&language=ja_JP&ref_=as_li_ss_il" target=_blank><img border=0 src="//ws-fe.amazon-adsystem.com/widgets/q?_encoding=UTF8&ASIN=B003VIW0PG&Format=_SL110_&ID=AsinImage&MarketPlace=JP&ServiceVersion=20070822&WS=1&tag=t2y-diary-22&language=ja_JP"></a><img src="https://ir-jp.amazon-adsystem.com/e/ir?t=t2y-diary-22&language=ja_JP&l=li1&o=9&a=B003VIW0PG" width=1 height=1 border=0 alt style=border:none!important;margin:0!important></p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/1211/>休日のオンライン学習</a></h1><div class=post-meta><time class=post-date>2022-12-11 (Sun.) ::</time></div><span class=post-tags>#<a href=/diary/tags/event/>event</a>&nbsp;
#<a href=/diary/tags/migration/>migration</a>&nbsp;
#<a href=/diary/tags/team-building/>team building</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/programming/>programming</a>&nbsp;</span><div class=post-content><p>0時に寝て夜中に吐き気がして2回ほど起きて3時と5時に起きて8時に起きた。なかなか苦しい寝方をした。</p><h2 id=ヤフートラベルと一休comのシステム統合>ヤフートラベルと一休.comのシステム統合</h2><p>アーカイブ公開されたらみようと思いつつ忘れてたので見返した。</p><div class=video-container><iframe src=https://www.youtube.com/embed/JN4kGYbQMJ8 allowfullscreen title="ヤフートラベルのシステムリニューアル 一休 com とのシステム統合 -日本語版-"></iframe></div><p>雑なめも。また機をみて見返すこともあるかも。</p><ul><li>バックエンドは完全に一休側に寄せるという大きな意志決定を2016年に行った<ul><li>この意志決定はフロントエンド統合にも大きな影響を与えた</li><li>ふじもんさんの意志決定がよかった？</li></ul></li><li>今日の話しはマルチブランドデザインシステム統合がメイン<ul><li>開発者が50-60人程度で半年ぐらいで launch できた</li><li>nuxt/vuejs で開発している</li><li>スタイルは tailwindcss を使っている</li><li>実は launch した後にこのシステムが必要だとわかった<ul><li>開発者とデザイナー間の細かい意思疎通が困難</li><li>外部からデザインシステムに詳しい人にも来てもらっていろんな議論をした</li><li>ガイドラインを言語化するところから始め、最終的にソースコードの共有ができるようになった</li></ul></li><li>終わってからデザインシステムそのものは重要ではないと気付いた<ul><li>この過程で開発者とデザイナー間のどのように共通化するか、あるいはしないかと議論を繰り返し行ったことが重要だったと当事者がインタビューで語っていた</li><li>デザインシステムの開発を通じてデザインの共通認識をもてたことがよかった</li></ul></li></ul></li><li>波及効果<ul><li>同じソースコードから少し異なる体験の開発のノウハウができた</li><li>ふるさと納税に特化した宿泊予約サイトを作った</li></ul></li><li>統合は終わりではない、lauch したところが始まり<ul><li>統合後にいろいろな施策をすることで課題がみえてくることがある</li></ul></li><li>全国旅行支援は1つの開発で2つの体験をつくることができた</li><li>Q. デザイナーと開発者はわりと仲が悪いのでは？価値観や考え方が異なるのですり合わせるのは難しいのでは？<ul><li>過去の一休でも起きていた</li><li>一休のチームはデザイナーと PM と開発者で構成されている<ul><li>このチームが一緒に働いていてチームでなるべく意志決定している</li><li>普段から一緒に働いていると仲が悪いということはなかった</li><li>とはいえ、仕事のプロセスが異なるので課題はあった<ul><li>地道に丁寧にすり合わせを行った</li><li>外部から講師を読んで中立的な立場でワークショップを何度も行った</li></ul></li></ul></li><li>デザイナーと開発者を別の組織にしているとコミュニケーションの壁ができてしまうかもしれない</li></ul></li></ul><h2 id=go-の学び直し>go の学び直し</h2><p><a href=/diary/posts/2022/1123/#go-の学び直し>テストの学び直し</a> に引き続き、<a href=https://tenntenn.connpass.com/event/267564/>Gopher塾 #2 - Goらしいコードの書き方 - DAY 1</a> に参加した。</p><p>テストの次のプログラミングの話しだったので内容そのものは難しくはなかったけど、改めて重要な項目を選抜しているのだと考えると学びはあったと思う。参考になったことをいくつか覚えている範囲でまとめる。名前の付け方について感覚的に理解していたし、実際に私はそうしているけど、コードレビューしていて自然になっていないコードを指摘する機会も多いので一定の習熟を要するのかもしれない。いま毎週勉強会をやっていて私が講師として話している。ネタがなくなってきたり大変になったきたら準備の少ないコードリーディング会もやってみたいと思った。</p><ul><li><a href=https://google.github.io/styleguide/go/>google Go Style</a></li><li><a href="https://cs.opensource.google/go/x/pkgsite/+/master:internal/derrors/derrors.go;l=237">derrors.Wrap</a></li><li>名前に文脈を与えるという概念<ul><li>相対的な名前をつける</li></ul></li><li>準備の少ないコードリーディング会<ul><li>お題（読むパッケージ）を決める</li><li>選んだお題に期待することを当日話す</li><li>時間を決めてみんなでそれぞれ読む（20分とか）</li><li>読みながらSlackのスレッドにメモをしていく</li><li>残りの時間で気になったところを議論する</li><li>自分が気づけなかった点を知ることができる</li></ul></li></ul></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/1206/>echo のよさの1つはテストがやりやすい</a></h1><div class=post-meta><time class=post-date>2022-12-06 (Tue.) ::</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/founding/>founding</a>&nbsp;</span><div class=post-content><p>にわかサッカーファンになって、20時頃に1-2時間寝て24時からワールドカップのクロアチア戦をみて3時に寝て8時に起きた。睡眠のリズムが完全に狂ってしまった。</p><h2 id=echo-のテストのやりやすさ>echo のテストのやりやすさ</h2><p>うちのチームでは http フレームワークに <a href=/diary/posts/2022/1122/#echo-を採用>echo を採用</a> している。その後、開発を継続していていくつか http ハンドラーも実装されてきた。そろそろ http ハンドラーのテストを書いていこうと参照実装を私が書いてみた。メンバーが知らないことは、マネージャーの私が参照実装して教えるといったやり方をしている。echo.HandlerFunc に echo.Context を渡すシンプルなインターフェースはテストを書くときに http ハンドラー以外の依存関係 (例えば db とのコネクションなど) を context を介することでモックと差し替えるのが容易になる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>tests</span> <span style=color:#f92672>:=</span> []<span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>name</span>    <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctx</span>     <span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>Context</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>err</span>     <span style=color:#f92672>*</span><span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>HTTPError</span>
</span></span><span style=display:flex><span>} {
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>func</span>() <span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>Context</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>data</span> <span style=color:#f92672>:=</span> <span style=color:#e6db74>`{...}`</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>c</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>newEchoContext</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>MethodPost</span>, <span style=color:#e6db74>&#34;/endpoint&#34;</span>, <span style=color:#a6e22e>data</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Set</span>(<span style=color:#e6db74>&#34;db&#34;</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>myMockDB</span>{})
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>c</span>
</span></span><span style=display:flex><span>	}(),
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>myHTTPHandler</span>(<span style=color:#a6e22e>ctx</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>こんな感じで context にモックを入れてしまえば http ハンドラーそのものの単体テストを簡単に書ける。そんなことをツィートした。</p><blockquote class=twitter-tweet><p lang=ja dir=ltr>その後 echo を採用して echo のよいところに1つ気付いた。echo.HandlerFunc に echo.Context を渡すインターフェースはテストがやりやすい。例えば、コンテキストで db のコネクションを保持しておけば、テストのときにモックに差し替えて http ハンドラーの単体テストを実装しやすい。</p>&mdash; Tetsuya Morimoto (@t2y) <a href="https://twitter.com/t2y/status/1600337204286746624?ref_src=twsrc%5Etfw">December 7, 2022</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script><p>そしたら podhmo からレスをもらったので go のリクエストコンテキストの扱いについても議論した。</p><ul><li>リクエストスコープのものを context に入れるのは同意</li><li>それ以外のスコープのものを context に入れるのは懸念がある<ul><li>http ハンドラーのレイヤーとアプリケーションのレイヤーが明確に分かれているならまだ理解できる</li><li>アプリケーションのレイヤーで context を自由に使うと依存関係や統制が取れなくなる<ul><li>これは私も同意するところでアプリケーションのレイヤーにリクエストコンテキストを渡す必要はない</li></ul></li></ul></li></ul><blockquote class=twitter-tweet><p lang=ja dir=ltr><a href=https://t.co/Yomdbyh1H0>https://t.co/Yomdbyh1H0</a><br><br>昔にこういう記事を書いてた。<br>chiはルーティングライブラリと考えるとスムーズ。<br><br>あとはnet/httpのミドルウェアを使いたいかechoなど専用のものを書くかの違いくらいかな。 <a href=https://t.co/9LtoanpY0c>https://t.co/9LtoanpY0c</a></p>&mdash; po (@podhmo) <a href="https://twitter.com/podhmo/status/1600338082242646016?ref_src=twsrc%5Etfw">December 7, 2022</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script><h2 id=オフィス住所の更新>オフィス住所の更新</h2><p>引き続き、住所変更の手続きを時間をみつけてやっている。同じ銀行の住所変更の手続きでも PayPay 銀行と三菱 UFJ 銀行ではまったく異なる。前者はオンラインでアカウント情報を変更するだけで済んだ。簡単。一方で後者はオンラインではできず、来店予約をとって対面で行う。当日に登記事項証明書の原本をもってこいと。なんという面倒臭さ。よくよく考えたら法人の登記事項証明書は誰でも取得できる。行政のシステムがどうなっているか知らないが、銀行が法人の住所変更を自分たちで調べることもやろうと思えばできるはず。登記事項証明書をオンラインで取得する手数料は500円になる。来店予約すると応対する人の人件費を考えたらシステムの手数料を支払った方が安いのではないか。</p><p>国税庁の管轄ではあるが、<a href=https://www.houjin-bangou.nta.go.jp/>国税庁法人番号公表サイト</a> から法人の住所変更そのものは確認できる。これは e-tax で次の2つの書類を申請した。登記事項証明書がなくても申請はできた。なにも言ってこなければ問題ないのかな？</p><ul><li>異動届</li><li>給与支払事務所等の開設・移転・廃止の届出</li></ul><p>有償にはなるが <a href=https://www1.touki.or.jp/night.html>登記情報提供サービス</a> というのがあって登記情報をオンラインで確認できる。このサービスを会社で契約していればいつでも確認できるはず？</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/1123/>go の学び直し テスト編</a></h1><div class=post-meta><time class=post-date>2022-11-23 (Wed.) ::</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/testing/>testing</a>&nbsp;
#<a href=/diary/tags/event/>event</a>&nbsp;</span><div class=post-content><p>23時に寝て2時に起きて気分悪くて寝付けずにだらだらしながら気付いたら5時になっていた。その後いつの間にか寝て8時に起きた。</p><h2 id=go-の学び直し>go の学び直し</h2><p><a href=https://tenntenn.connpass.com/event/265342/>Gopher塾 #1 - Testing - DAY 3</a> に参加した。</p><p>マネージャーとして go 開発のマネジメントをしているため、メンバーの開発者よりは知識やスキルが高くないとコードレビューや適切な指示ができない。2018年ぐらいまで go 開発をしていたが、その後はずっと java 開発をしていたため、最近の go 開発の話題はあまり把握していない。毎週チーム勉強会 (いまのところ、go 開発の話題) をやっていると、チーム外からも開発者が参加してくれるようになった。チーム外からの開発者が go 開発するときの参考にもなるよう、マネージャーのお仕事の付加価値として、組織全体へ go 開発の知識やスキルを提供できればと考えながら働いている。</p><p>今回はテストについて話題で7割ぐらいは知っている知識ではあったが、3割ぐらいは最近の話題や静的解析の知見からの深い洞察を話されていてとても参考になった。知っている知識でも幅広いテストの話題の中で厳選されたコンテンツになるのだろうから本質的に大事なことや最初に学ぶべき優先事項を知ることもできた。私がメンバーに教えるときのコンテンツの参考として役に立つ。まったく知らなかった話題としては、txtar というテキストをアーカイブしたフォーマットをファイルシステムとして扱えるようにした <a href=https://github.com/josharian/txtarfs>txtarfs</a> や、1.18 から追加された <a href=https://go.dev/security/fuzz/>fuzzing</a> というテストの入力値を自動生成する機能が追加されたこと。あと groovy でいうところの power assert に近い機能を提供するライブラリとして <a href=https://github.com/google/go-cmp>google/go-cmp</a> をいまはテストに使うらしい。たまたま <a href=https://github.com/golang/go/wiki/TestComments#equality-comparison-and-diffs>Go Test Comments</a> を読んでいたら go-cmp は go の開発チームが保守していて go のバージョンに依らずほとんどの比較の要件にあうツールのように説明されていて利用を推奨している。</p></div></article><div class=pagination><div class=pagination__buttons><a href=/diary/tags/go/page/2/ class="button previous"><span class=button__icon>←</span>
<span class=button__text>最近の日記</span></a>
<a href=/diary/tags/go/page/4/ class="button next"><span class=button__text>過去の日記</span>
<span class=button__icon>→</span></a></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>© 2021 Tetsuya Morimoto</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>