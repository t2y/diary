<!doctype html><html lang=en><head><title>design :: forest nook</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/tags/design/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="design"><meta property="og:description" content><meta property="og:url" content="/diary/tags/design/"><meta property="og:site_name" content="forest nook"><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/tags/design/index.xml rel=alternate type=application/rss+xml title="forest nook"></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><div class=posts><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0828/>go の処理系も驚く sdk のコード生成</a></h1><div class=post-meta><time class=post-date>2023-08-28 (Mon.) ::</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;
#<a href=/diary/tags/openapi/>openapi</a>&nbsp;
#<a href=/diary/tags/ci/cd/>ci/cd</a>&nbsp;</span><div class=post-content><p>0時に寝て何度か起きて6時に起きた。そのまま7時過ぎまでだらだらしてた。しんどい。</p><h2 id=msgraph-sdk-go-のサイズ問題>msgraph-sdk-go のサイズ問題</h2><p>先週 <a href=/diary/posts/2023/0825/#msgraph-sdk-go-を使った開発>msgraph-sdk-go を使った開発</a> を終えてデプロイする段階になってライブラリのサイズが大きくて、コンパイル速度が遅くなったり、バイナリサイズが大きくなったりする弊害があることに気付いた。コンパイル速度は2-3倍遅くなり (3分が7-10分ぐらい)、バイナリサイズも2-3倍大きくなる (30 MiB が 100 MiB とか) 。たまたまこのリポジトリは他のツール類からも依存パッケージとして使われるものなので想定よりも影響が大きいことに気付いた。</p><p>朝からチームのメンバーとミーティングして、本来は qa に入ったこの時期にこんな変更をすべきではないが、これは放置するデメリットが大きいのでリポジトリ分割 (モジュール分割) しようと提案して了承を得た。私がやれば作業は1日もあれば完了するだろうと見積もって、見積もり通り、夕方には分割したモジュールをテスト環境にデプロイして当面の解決を得た。アプリケーションのモジュール構造をちゃんとレイヤー化して作ってあるから、今回みたいに急遽、モジュール分割が必要になってもほぼ変更する必要はなかった (たった1箇所だけ) 。</p><p>この本質的な問題は次の issue のコメントで説明されている。</p><ul><li><a href=https://github.com/microsoftgraph/msgraph-sdk-go/issues/129#issuecomment-1098028043>Issue with the size of the API surface of the models package #129</a></li></ul><p>ざっと機械翻訳してみる。</p><blockquote><p><strong>コンテキスト</strong></p><p>この SDK は <a href=https://github.com/microsoft/kiota>kiota</a> を使用してメタデータから自動的に生成されます。オリジナルのメタデータは、Microsoft Graph の配下にあるすべてのサービスチーム（v1用とベータ用）によって入力された CSDL です。この CSDL は最終的に OpenAPI のフォーマットに変換されますが、これは非常に大きなものです（1k 以上のエンドポイント、1.5k のモデル &mldr;）。API のサイズが大きいため、完全な API surface の SDK を手作りすることは実現不可能でしょう。</p><p>私たちは、SDK を複数のサブモジュール（ファイル用、メール用など）に &ldquo;スライス&rdquo; して、人々が関心のあるものだけを簡単に入手できるようにすることをしばらく考えてきました。実際、私たちは PowerShell でこれを実現しました。しかし、&ldquo;グラフ&rdquo; の性質（すべてのモデルは互いにある程度関連している）と構築されるアプリケーションの多様性により、スライスは誰にとっても &ldquo;正しい&rdquo; ものにはならない（大きすぎたり、小さすぎたり、モデルの重複につながったり&mldr;）。</p><p>そのような理由から、私たちは「完全なSDK」を提供することにしました。すべての人にとって理想的とは言えないかもしれませんが、Go開発者の中には「アプリケーションを作るためのSDKが欲しいだけ」という人もいると感じています（以下で説明する2つ目のオプションとは対照的です）。</p></blockquote><blockquote><p><strong>Go の欠点</strong></p><p>Go の探求を通して、いくつかの欠点に気づいた。現時点では、私たちのプロジェクトやパッケージが適切にセットアップされていないせいなのか、Go や大規模プロジェクトの制限のせいなのかはわからない：</p><p>go build は、変更されておらず、依存関係も変更されていないサブパッケージをリビルドすることが多い。go build が直前に実行されていても、go test がリビルドすることがよくあります。なぜある種のキャッシュに頼らないのでしょうか？同じ問題が go lint にもある。<br>私には、たくさんのサブパッケージがある大きなプロジェクトをビルドするコストは、依存関係が更新されたり、キャッシュが削除されたり、コードが変更されたりしない限り、「セッションごとに一度」だけ支払われるべきだと感じます。</p><p>私たちのプロジェクト構成／構造において、そのような状況を改善するための最適化について、自由に概説してください。また、Goコミュニティ（Goコンパイラを開発している人たちなど）と関わって、そのようなフィードバックを提供する方法があれば、喜んでそうします。私たちのプロジェクトは、その規模の大きさから、世の中にあるほとんどのGoパッケージと比べると、ちょっと変わり者だとわかっています。</p></blockquote><blockquote><p><strong>適切なサイズの SDK</strong></p><p>最後に、すべてのエンドポイントを備えた完全な SDK を持つことは、様々な理由からすべての人に適しているわけではないことを認識しています。私たちは新しい &ldquo;適切なサイズのセルフサービスSDKエクスペリエンス&rdquo; を可能にするために取り組んでいます。そこでは、APIユーザーは誰でも、この SDK と同じように見え、同じように感じる SDK を生成することができますが、完全な API サーフェスの代わりに、彼らのアプリケーションのために彼らが気にするエンドポイント/モデルのみが含まれています。
私たちは今、そのような取り組みに本当に早くから取り組んでいますが、それでもフィードバックをいただけるとうれしいです。大まかな手順はこんな感じだ：</p><ol><li>新しいgoプロジェクトを作成するか、既存のプロジェクトを特定する。</li><li>kiotaの依存関係を追加するか、msgraph-sdk-go-coreを追加します（これはKiotaの依存関係をプルし、いくつか追加します）。</li><li>グラフエクスプローラで必要なリソースを選択（左パネル、2番目のタブ、&mldr;、&ldquo;コレクションに追加&rdquo;）。</li><li>コレクションをプレビューをクリックし、postmanコレクションとしてエクスポートします。</li><li>hidi を postmanコレクションと先ほど共有したOpenAPIの完全な説明文と一緒に使って、&ldquo;フィルタリングされた&rdquo; OpenAPI フォーマットを生成する。</li><li>kiotaを使って、プロジェクトにMicrosoft Graph用のGoクライアントを生成する。</li><li>APIの呼び出しを開始する。</li></ol><p>この時点で、私たちはこれらのステップをすべて文書化し、効率化するために取り組んでいます（おそらくステップ4～5を圧縮しています）。このアプローチの素晴らしいところは、ステップ5から7までが、Microsoft Graphだけでなく、呼び出したいOpenAPIで記述されたAPIで動作することだ。<br>繰り返しますが、この最後の提案はまだ初期段階です。自由に試して、様々な場所でフィードバックを提供してください。</p><p>この長い投稿で、私たちがどこに向かっているのかが明らかになり、Goコミュニティからこれらの側面すべてについてさらにフィードバックが得られると本当に助かる！</p></blockquote><p>簡単に言えば、ms graph api の体系が巨大過ぎて、その定義は <a href=https://raw.githubusercontent.com/microsoftgraph/msgraph-metadata/master/openapi/v1.0/openapi.yaml>openapi.yaml</a> にあるが、この定義からすべてコード生成すると巨大なモデル定義をもつ sdk が出来上がってしまったという話しである。後半に書いてあるワークアラウンドとして kiota で必要なモデルだけを選択して専用 sdk を生成すればサイズを小さくできるとある。しかし、それはそれで <a href=https://developer.microsoft.com/en-us/graph/graph-explorer>graph explorer</a> で選択しないといけなかったりして面倒そうではある。次のドキュメントでもその手順について書いてある。</p><ul><li><a href=https://devblogs.microsoft.com/microsoft365dev/building-go-applications-with-the-microsoft-graph-go-sdk/#create-a-smaller-and-tailored-microsoft-graph-go-client-library>Create a smaller and tailored Microsoft Graph Go client library</a></li></ul><p>うちの用途ではモジュール分割により、局所化したのでひとまずこの問題は大きな影響をもたないようになった。また余裕があるときにモデルを選択して専用 sdk を自動的に生成する仕組みを構築できるならそれに挑戦してもよいかもしれない。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0812/>室温と集中力との相関関係</a></h1><div class=post-meta><time class=post-date>2023-08-12 (Sat.) ::</time></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/founding/>founding</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;</span><div class=post-content><p>2時に寝て2回ぐらい起きて7時に起きた。朝からやや疲れ気味。</p><h2 id=ストレッチ>ストレッチ</h2><p>疲労と暑さと出張でバテバテ。今日の開脚幅は開始前157cmで、ストレッチ後160cmだった。数値はよい感じ。トレーナーさんが言うにはお尻と肩が硬かったらしい。私の感覚ではそれらに加えて、ふくらはぎの後ろの筋がかなり痛かった、とくに左足。さらに体全体がだるくて疲れが溜まっているなーという印象も受けた。実は8月21日の週にまた出張する予定になったので体力がもつか、不安も感じるようになってきた。</p><h2 id=空調工事の結果>空調工事の結果</h2><p>先日の <a href=/diary/posts/2023/0802/>暑さ対策委員会</a> の続き。</p><p>出張から帰ってきて、エアコンの冷媒切り替えを終えたはずのオフィスの室温はどう変わったか？その結果が楽しみにで昨日、出張帰りにオフィスに寄ってみたというのもあった。結論から言うと</p><blockquote><p>何の成果も！！得られませんでした！！</p></blockquote><p>温湿度計を買っておいてよかった。ちゃんと数値でどう変わったかを測れるもんね。だって午前中は34℃、お昼から32℃、夜は28℃、なんも変わってない。この部屋が暑い理由は冷媒が原因ではなかったという切り分けはできた。がっかりして、また運営会社に電話して、成果がなかったことと、前に断熱のブラインドに変えてくれると言っていた件はどうなったの？とツッコミまで入れてしまったよ。もう建物の構造的にこの区画は涼しくならないんやろか？</p><h2 id=オフィスの-wifi-不通>オフィスの wifi 不通</h2><p>昨日の午前中、運営会社のスタッフとやり取りしていて wifi が不通になっていることに気付いた。デスクトップマシンは有線ネットワークを使っていてそちらは疎通しているものの、wifi のアクセスポイントまでは接続できるが、なぜかその先のインターネット接続が不通になるという現象が発生していた。たまたま部屋の外に出たときにコワーキングスペースの利用者が運営会社のサポートに電話して、やや強い口調でクレームしていた。コワーキングスペースの利用者向けには wifi ネットワークしかないため、コワーキングスペースにわざわざ来てインターネット繋がりませんで怒る気持ちは分からないでもない。</p><p>ネットワーク障害が発生することそのものは仕方ないものの、発生してから翌日の20時時点でその wifi ネットワークの障害が解消していない。同じフロア内にある有線ネットワークが疎通していることから、このネットワーク障害は小規模な原因であることが推測される。それこそ通信機器を再起動すれば直るかもしれない。1日以上放置している運営体制を懸念に思ってしまったのだけど、これは職業病？週末に知らずにコワーキングスペースへ来られる方がいるのではないだろうか？</p><h2 id=エージェントアプリケーション開発>エージェントアプリケーション開発</h2><p><a href=/diary/posts/2023/0807/#エージェントアプリケーション開発>今週中に完了させておきたい機能開発</a> が全然進捗しなかったので週末に取り組む。昼間は暑くて (34℃) 集中力が出なかったので15時から19時まで家に帰ってエアコンの効いた部屋で寝てた。ただただ寝てた。私が4時間起きずに眠れることは稀なので自分でも驚いた。その後、オフィスに戻って19時半ぐらいから開発に臨んだ。夜のオフィスの室温は28℃前後なので十分に涼しい (と適応している自分がいる) 。</p><p>ldap サーバーでのユーザーとグループのエントリー、それぞれの変更を検知して id 連携しないといけない。既存の実装は1つのクエリにユーザーとグループの検索条件を OR 条件にして両方のエントリーを取得するようにしている。このフィルター自体は問題ないが、その後のユーザーとグループの判別に DN の接尾辞の部分マッチで判定していた。これは微妙な判定方法だ。このやり方だとユーザーとグループの DN の接尾辞が同じときに運用できない。ユーザーとグループは分けて管理した方が要件がシンプルで運用も実装もわかりやすいだろうと考え、それぞれのクエリを非同期／並行に動かすようにした。こういうのは go 言語の得意とするところ。一通り動くようになったら3時半ぐらいになってた。涼しい方が集中できる。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0807/>設計の見直しとリファクタリング</a></h1><div class=post-meta><time class=post-date>2023-08-07 (Mon.) ::</time></div><span class=post-tags>#<a href=/diary/tags/design/>design</a>&nbsp;
#<a href=/diary/tags/refactoring/>refactoring</a>&nbsp;</span><div class=post-content><p>2時ぐらいに寝て起きたかどうかあまり覚えていないが7時に起きた。あまり寝た気がしない。</p><h2 id=エージェントアプリケーション開発>エージェントアプリケーション開発</h2><p><a href=/diary/posts/2023/0806/#syncrepl-を使ったエージェントアプリケーション開発>昨日の続き</a> 。一晩寝かした甲斐があったのかどうか、意識的にはわからないが、少なくともつまづくことなく1つずつ設計の見直しや処理をパラメーター化していって一通りプロトコルの差異以外のところは整理できた。今日は自分のコードを書く余裕はなかったけれど、1日かけて既存の設計の見直しを終えられたことをうまくいったと自分で肯定しておこうと思う (他人からみたらそうじゃない可能性はある) 。</p><p>関数は1つの機能のみを実装して、入力しか依存関係をもたないようにシンプルにすべきという基本概念がある。その基本概念をちゃんと理解できていないと、設計のアンチパターンの1つとして、渡すパラメーターがどんどん増えていってしまうことに気付いた。まずは既存の処理やフローを変えずに設計を見直したのでそうなってしまっている。また後で時間があったら、インターフェースを明確にして根本的な設計を見直してもよいかもしれない。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0806/>真夏の休出 第1週</a></h1><div class=post-meta><time class=post-date>2023-08-06 (Sun.) ::</time></div><span class=post-tags>#<a href=/diary/tags/animation/>animation</a>&nbsp;
#<a href=/diary/tags/founding/>founding</a>&nbsp;
#<a href=/diary/tags/blog/>blog</a>&nbsp;
#<a href=/diary/tags/writing/>writing</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;</span><div class=post-content><p>2時に寝て6時に起きてだらだらしてたらいつの間にか2度寝して9時に起きた。8月は開発の佳境なので基本的には土日を働く予定。</p><p>晩ご飯を外食して、夕方から <a href=https://nierautomata-anime.com/>NieR:Automata Ver1.1a</a> というアニメが2期決定というニュースをたまたまみて、1期のコンテンツを見始めた。品質の高い作品だとは思うけれど、世界観 (設定) が私の頭の中のなにかとあわない。世界観の違和感や矛盾を受け入れ難いものがあって引っかかりを覚えるような作品だった。もともとゲームが原作らしい。人によって評価が分かれそうに思えた。</p><h2 id=事例紹介のたたき台>事例紹介のたたき台</h2><p><a href=/diary/posts/2023/0801/>先日のプレスリリース</a> の続き。こういった会社の正式な文章を書くのは、その労力以上に面倒臭さが上回って後回しにしてしまう。簡潔な文章なので、過去の体裁やフォーマットなどをみながらやればすぐにできた。今回は私はマネージャーとしてプロダクト開発しているので、うちが作ったんよ的なノリでちょっと前のめりにプロダクト紹介をしてみた。私がもっている課題管理のノウハウを駆使して開発プロジェクトをうまくまわした工夫も書きたいところだけど、そうすると事例紹介と課題管理のプラクティスの話しがごっちゃになって訳の分からん記事になってしまう。事例紹介とは別に、今回の事例をベースに課題管理のプラクティスの記事を別途ブログに書こうと思った。他にもお客さん先のテックブログにも書かないといけない記事が2つ溜まっている。私は文章を書くのが遅いからなかなか捌けない。日記を書いて練習しているうちに早く書けるようにならないかな？と期待しているが、まだまだそんな予兆はみえない。</p><h2 id=syncrepl-を使ったエージェントアプリケーション開発>syncrepl を使ったエージェントアプリケーション開発</h2><p><a href=/diary/posts/2023/0805/#syncrepl-のレビュー対応>昨日のレビュー対応したものがマージされた</a> 。それをもって自分たちのアプリケーションのコードを書かないといけない。以前に <a href=/diary/posts/2023/0522/#メンバーの-oss-へのコントリビュート>ldap の dirsync というプロトコル</a> をメンバーが実装して、それを使ったアプリケーションのコードがある。その実装といくつか共通部分を再利用しつつ、プロトコルの違うところだけを追加できるようにしたい。既存のエージェントアプリケーションのソースを読みながら、どういう風に設計していくかのイメージを膨らませておいた。今日のところはコードを読んで頭の中に入れて考えるだけ。この状態で一晩寝かすと、寝ている間に脳が無意識に考えてくれて効率がよいはず。これは休日の時間のよい使い方だと思う。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0720/>最後は人のチカラがモノを言う</a></h1><div class=post-meta><time class=post-date>2023-07-20 (Thu.) ::</time></div><span class=post-tags>#<a href=/diary/tags/operation/>operation</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;
#<a href=/diary/tags/management/>management</a>&nbsp;
#<a href=/diary/tags/communication/>communication</a>&nbsp;
#<a href=/diary/tags/event/>event</a>&nbsp;</span><div class=post-content><p>2時半に寝て寝たのかどうかよく分からないながら5時頃に寝落ちして7時半に起きた。</p><h2 id=差分比較のための機能>差分比較のための機能</h2><p>id 連携で運用のための非機能要件の1つとして更新された内容を確認できるようにしたい。非機能要件だから私が作るかと思ってあたためておいた issue に着手した。wikipedia によると差分という言葉には次の2つの用語があるのをみつけた。</p><ul><li><a href=https://en.wikipedia.org/wiki/Delta_update>Delta update</a></li><li><a href=https://en.wikipedia.org/wiki/Data_differencing>Data differencing</a></li></ul><p>数学やコンピューターの用語的には delta (ギリシャ語で変化を表す) という言葉を使う。os のパッケージングシステムで一部のパッケージをアップデートするようなことをデルタアップデートと呼ぶ。一方でコンピューターサイエンスにおいて2つのデータセット間の差分については diff という用語を使う。データの差分においては diff でよいのではないかと思う。そういった用語の定義から始めた。mongodb のコレクションのデータ定義をしたり、結合テストを書いて動かしてみたり、インフラのレイヤーから開発に着手した。</p><h2 id=上司道-企業家として生き様と人として求められること>上司道 企業家として生き様と、人として求められること</h2><p><a href="https://www.facebook.com/events/1287346985493718?ref=newsfeed">第92回上司道 企業家として生き様と、人として求められること</a> に参加した。なんとなくタイトルに惹かれた。<a href=/diary/posts/2023/0228/#上司道-野村監督から学ぶリーダーの器のつくり方>上司道</a> に参加するのは3回目。</p><p>講師の牛島さんは昨日が誕生日だったらしく90歳だという。90歳になって zoom でオンライン勉強会の講師を務めるというのを、私はまったく想像できないけど、コンサルタントの第一線で活躍されてきた方の貫禄があった。もともとどういう主旨の勉強会だったのかよく分かっていないけれど、内容はビジネスの自己啓発セミナーに近いものになった。牛島さんが90年も生きてきて大事だと思える内容には普遍性や汎用性があるのだと思う。いくつか共感できる考え方もあった。</p><ul><li>これからは頭の良い人 (IQ が高い) よりも心が豊かな人 (EQ が高い) の方が大事で組織に貢献する</li><li>一番大切なのは幸せであること</li><li>楽しく生きる (働く)</li></ul><p>過去に働いた会社でも頭がよくて何でもよく理解しているのにプロジェクトにあまり貢献しない人がいることに気付いた。さぼっているわけでもない。その違いを「心が豊かな人 (EQ が高い) 人」という言葉でいくつか説明できるのではないかと思えた。新規プロジェクトのような、常に変化して、正解もわからないまま進める業務において、論理や頭のよさだけでうまくいくことはなくなってきつつあるのではないか。なんのためにそのプロジェクトをやるのか、自分はなぜここで働いているのか、といった問いに答えをもっている人は普通の社員とは行動が異なる。自身の価値観や展望と比較して、現状の課題や改善に気付くのでプロジェクトを前向きに進めていける。頭のよい人は「あれが問題」「これが問題」と問題を指摘してエスカレーションするだけで自らが課題をどう解決するかの答えをもっていない。そんなことを考えながらこの話しを聞いていた。</p><p>次の2つは最近の私の人生観や働き方と重なるところがある。私はもう無理してがんばったりしないし、自分が嫌なお仕事も一切しないように決めている。一般的にいう「働きたくない」という生き方を目指している。もちろん実際には働いているわけだけど、それはなるべく働く時間を、遊んでいる時間に置き換えられないかと模索している。その過程で辛いことやしんどいことも避けようと考えている。</p><p>なぜそれができるかというのも、20代30代と約20年働いてきて自身の価値観を育ててきたからだと捉えている。私はなにが楽しくて、なにが辛くて、なにをやりたくないか。これは人それぞれに違う。私には私にしかない価値観をもっている。それがわかってきたから、いま自分の会社を経営していて、毎日がとても楽しいし、自分の価値観にあわないことはすべて断るという判断基準も明確になっている。そんな勝手気ままでやっていけるの？という懸念を抱く人も多いと思う。ダメかもしれない。仮にやっていけなかったとしても、いまの自分は幸せで楽しいのだからそれでいいんじゃないかと思う。無理をしていまがしんどくても将来がよくなる保証なんてどこにもない。</p><p>牛島さんはマザーテレサとインドで実際に会って10日間ほど一緒に過ごしてその体験がその後の人生を大きく変えたように話されていた。マザーテレサに「社員を大事にしていますか？」と聞かれたときに「しています。」と答え、その後に「社員全員の名前を覚えていますか？」と聞かれたという。当時の牛島さんの会社の社員は300人以上いて全員は覚えていなかった。それで「愛情の反対は無関心なのですよ。」とマザーテレサに指摘されて大きな衝撃を受けたという。その後、帰国してから300人以上の社員全員の名前を覚え、日々の業務で社員の行動などに気を配ってすべての社員に声をかけたりするようになったという。このエピソードもなかなか私には効く話しで、私は他人にかなりのレベルで関心がない。もし自分の会社で社員を雇うことになったら待遇がどうとか以前に、その人そのものに関心をもつという姿勢を覚えておこうと思う。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0714/>メモリリークに遭遇</a></h1><div class=post-meta><time class=post-date>2023-07-14 (Fri.) ::</time></div><span class=post-tags>#<a href=/diary/tags/operation/>operation</a>&nbsp;
#<a href=/diary/tags/testing/>testing</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;</span><div class=post-content><p>23時に寝て何度か起きて5時に起きてからだらだらネットしながら記事を読んだりしていて7時に起き上がった。</p><h2 id=agent-アプリケーションのメモリリーク調査>agent アプリケーションのメモリリーク調査</h2><p>qa テストの一環として先月からテスト環境で毎分 agent アプリケーションにリクエストを投げる長時間稼働テストを実行している。なんとなく気になるところがあったからやったわけではあるけれど、長時間稼働テストによってメモリリークを検出できてしまった。自分を過信せずちゃんと検証しないといけないなと思えた。top コマンドの実メモリー (RES) を1ヶ月前と比較して増えているからメモリリークだと気付いたところ。これからメモリプロファイリングをしながら原因を追求していく。私が書いた (レビューした) go のコードでメモリリークはないだろうと高をくくっていただけにちょっとショックではあった。</p><p>go は標準ライブラリに pprof というプロファイラがあるので簡単にデバッグできる。プロファイラで昨日から調査していたところ、<a href=https://github.com/go-zeromq/zmq4>go-zeromq/zmq4</a> の処理でメモリリークしていることはわかった。それがライブラリの使い方が誤っているのか、潜在的な不具合なのかはまだこれから調査するところ。</p><p>ライブラリ側の問題を調査するので厄介ではあるけど、私が書いた (レビューした) go のコードでメモリリークしているわけじゃないことがわかって少しほっとした。</p><h2 id=go-の-generics-勉強会>go の generics 勉強会</h2><p><a href="/diary/posts/2023/0707/#go-の-generics 勉強会の準備">先日準備した資料</a> を使って勉強会を開催した。</p><ul><li><a href=https://github.com/t2y/go-generics-study>https://github.com/t2y/go-generics-study</a></li></ul><p>この勉強会はある意味、うちのチームのメンバーが理解しておくべき内容なので go のプログラミングをやっていないメンバーが聞いてもあまり関心をもてない内容となっている。そういうお断りもした上で最悪2-3人ぐらいの参加者になるかと思ったもののプログラミングに関心がある人たちは参加してくれて5-6人ぐらいの規模にはなった。一方で内容も難しいし、私の説明がどれだけわかりやすかったか、私自身にはわからないのでなんとも言えない。質問も一切なかったので喋りきって疲れたという疲労感と、伝わったのか伝わらなかったのか分からない消化不良感と、金曜日だから今日はもういいや感でどっと疲れたというのが率直な感想になる。</p><p>とはいえ、私もずっと generics の仕様をちゃんと追いかけたいと思いながら先送りしていたものではあるので私の中では自分が go の generics の理解度をあげて実際の開発の中で使い分けるだけの判断基準をもてたことが収穫だったと言える。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0713/>縁の下のマネージャー</a></h1><div class=post-meta><time class=post-date>2023-07-13 (Thu.) ::</time></div><span class=post-tags>#<a href=/diary/tags/design/>design</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/logging/>logging</a>&nbsp;
#<a href=/diary/tags/security/>security</a>&nbsp;</span><div class=post-content><p>20時にホテルに戻ってきてのんびりしながら気付いたら22時ぐらいになって、少しテレビをみて0時に寝て4時ぐらいから起きてその後はあまり眠れなかった。それでも7時過ぎまでだらだらしていた。</p><h2 id=7月後半に実装予定の新機能の設計>7月後半に実装予定の新機能の設計</h2><p>9月までに実装する新機能のうち、唯一、私の頭の中で設計の見通しをもっていなかった機能の設計を行うことにした。</p><p>ざっくりした機能概要から私がふわっと想定していたものはずっと複雑なものだったのだけど、プロダクトオーナーに要件をヒアリングしているうちにそんな高度なものは求められていないことに気付いた。逆にその高度な機能の仕組みを提供しても、実際に運用の現場で使うにあたって手間暇だけかかってそんなものを求めていないと言われそうな気がした。そこで私が作りたいなと思っていた設計のアイディアは封印することにした。既存の先行プロダクトがもっている機能とほぼ同様のものを、うちらの開発しているプロダクトで実現するだけでよさそうにみえた。そのシンプルな機能の設計を軽くやっておいた。詳細を詰めるのは次のマイルストーンで私ではないメンバーに実装してもらうことになるけれど、なんとなく当初の想定よりも早くできそうに思えた。</p><h2 id=ログ出力のリファクタリング>ログ出力のリファクタリング</h2><p>id 連携の処理で複雑なリソースを map 型で扱うときデバッグ用途でリソースを丸ごと dump したい。しかし、パスワードのような機密情報が含まれる場合はそれらはログに出力したくない。この処理をいまは連携種別ごとに実装していて、本質じゃないところで個別実装の手間があるのと機密情報の出力というセキュリティに関するところを毎回プログラマーが手で実装するのもどうかな？という気がして汎用のログユーティリティとしてロガーのライブラリ側で提供することにした。インフラやプラットフォーム的な機能に私は積極的に開発に介入している。</p><p>やり方の1つとしてオリジナルのリソースをコピーして機密情報だけ削除した一時的なリソースコピーを dump してログ出力する。go 1.21 で標準ライブラリに追加される <a href=https://pkg.go.dev/golang.org/x/exp/maps>maps</a> パッケージを使うと map の操作が簡単にできる。コピー関数もある。しかし、この機能は shallow copy なので map の値にネストした map が含まれる場合はオリジナルの値を書き換えてしまう。ネストした map を調べてそれらもクローンしていく処理を実装した。excludeKeys に除外したい任意のキーを渡し、map の値を再帰的にチェックして取り除く。最終的には次のようなコピーユーティリティになった。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>copyWithoutExcludeKeys</span>(
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fields</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>any</span>, <span style=color:#a6e22e>excludeKeys</span> []<span style=color:#66d9ef>string</span>,
</span></span><span style=display:flex><span>) <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>any</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>cloned</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>maps</span>.<span style=color:#a6e22e>Clone</span>(<span style=color:#a6e22e>fields</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>k</span>, <span style=color:#a6e22e>v</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>cloned</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>t</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>v</span>.(<span style=color:#66d9ef>type</span>) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>:
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>strMapCloned</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>maps</span>.<span style=color:#a6e22e>Clone</span>(<span style=color:#a6e22e>t</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>sk</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>maps</span>.<span style=color:#a6e22e>Keys</span>(<span style=color:#a6e22e>strMapCloned</span>) {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>slices</span>.<span style=color:#a6e22e>Contains</span>(<span style=color:#a6e22e>excludeKeys</span>, <span style=color:#a6e22e>sk</span>) {
</span></span><span style=display:flex><span>					delete(<span style=color:#a6e22e>strMapCloned</span>, <span style=color:#a6e22e>sk</span>)
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>cloned</span>[<span style=color:#a6e22e>k</span>] = <span style=color:#a6e22e>strMapCloned</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>any</span>:
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>cloned</span>[<span style=color:#a6e22e>k</span>] = <span style=color:#a6e22e>copyWithoutExcludeKeys</span>(<span style=color:#a6e22e>t</span>, <span style=color:#a6e22e>excludeKeys</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> []<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>any</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>v</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>t</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>t</span>[<span style=color:#a6e22e>i</span>] = <span style=color:#a6e22e>copyWithoutExcludeKeys</span>(<span style=color:#a6e22e>v</span>, <span style=color:#a6e22e>excludeKeys</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>slices</span>.<span style=color:#a6e22e>Contains</span>(<span style=color:#a6e22e>excludeKeys</span>, <span style=color:#a6e22e>k</span>) {
</span></span><span style=display:flex><span>				delete(<span style=color:#a6e22e>cloned</span>, <span style=color:#a6e22e>k</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>cloned</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div></article><div class=pagination><div class=pagination__buttons><a href=/diary/tags/design/page/2/ class="button next"><span class=button__text>過去の日記</span>
<span class=button__icon>→</span></a></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>© 2021 Tetsuya Morimoto</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>