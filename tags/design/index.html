<!doctype html><html lang=en><head><title>Design :: </title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/tags/design/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="Design"><meta property="og:description" content><meta property="og:url" content="/diary/tags/design/"><meta property="og:site_name" content><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/tags/design/index.xml rel=alternate type=application/rss+xml title></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><h1>Posts for: #Design</h1><div class=posts><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0919/>pipe による関心の分離</a></h1><div class=post-meta><time class=post-date>2024-09-19</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;
#<a href=/diary/tags/programming/>programming</a>&nbsp;</span><div class=post-content><p>go の <a href=https://pkg.go.dev/io#Pipe>Pipe</a> は go 言語プログラミングのよいところをいくつか同時に実感できる、実用度の高いユーティリティだと思う。go 言語は writer や reader をインターフェースとして定義している。細かいメソッドの違いでいくつかの writer/reader インターフェースを区別していたりもするが、基本的には write/read のメソッドをもっていればよい。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Writer</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Write</span>(<span style=color:#a6e22e>p</span> []<span style=color:#66d9ef>byte</span>) (<span style=color:#a6e22e>n</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Reader</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Read</span>(<span style=color:#a6e22e>p</span> []<span style=color:#66d9ef>byte</span>) (<span style=color:#a6e22e>n</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>この汎用的な writer/reader のインターフェースに従っていれば、さまざまな要件に対して抽象化ができる。オンメモリでデータを扱うこともあるし、OS のファイルシステム上のファイルとして扱うこともあるし、オブジェクトストレージ上のオブジェクトとして扱うこともある。そういった具象オブジェクトの如何によらず writer/reader のインターフェースに従うことでデータ処理とリソース管理を分離できる。これはプログラミングパラダイムにおける <a href=https://ja.wikipedia.org/wiki/%E9%96%A2%E5%BF%83%E3%81%AE%E5%88%86%E9%9B%A2>関心の分離</a> と呼ばれていることを実現する。</p><p>バッチ処理において複数データを読み込みながら処理を行い、処理中にエラーが発生したら、そのエラーデータを特定のファイルに書き込みしたい。エラーが発生したときだけ特定ファイルを生成する。そういった要件は次のように実装できる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>write</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>WriteCloser</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>	<span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>		if true {
</span></span></span><span style=display:flex><span><span style=color:#75715e>			return
</span></span></span><span style=display:flex><span><span style=color:#75715e>		}
</span></span></span><span style=display:flex><span><span style=color:#75715e>	*/</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>records</span> <span style=color:#f92672>:=</span> [][]<span style=color:#66d9ef>string</span>{
</span></span><span style=display:flex><span>		{<span style=color:#e6db74>&#34;first_name&#34;</span>, <span style=color:#e6db74>&#34;last_name&#34;</span>, <span style=color:#e6db74>&#34;username&#34;</span>},
</span></span><span style=display:flex><span>		{<span style=color:#e6db74>&#34;Rob&#34;</span>, <span style=color:#e6db74>&#34;Pike&#34;</span>, <span style=color:#e6db74>&#34;rob&#34;</span>},
</span></span><span style=display:flex><span>		{<span style=color:#e6db74>&#34;Ken&#34;</span>, <span style=color:#e6db74>&#34;Thompson&#34;</span>, <span style=color:#e6db74>&#34;ken&#34;</span>},
</span></span><span style=display:flex><span>		{<span style=color:#e6db74>&#34;Robert&#34;</span>, <span style=color:#e6db74>&#34;Griesemer&#34;</span>, <span style=color:#e6db74>&#34;gri&#34;</span>},
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>cw</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>csv</span>.<span style=color:#a6e22e>NewWriter</span>(<span style=color:#a6e22e>w</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>record</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>records</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>cw</span>.<span style=color:#a6e22e>Write</span>(<span style=color:#a6e22e>record</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatalln</span>(<span style=color:#e6db74>&#34;error writing record to csv:&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>cw</span>.<span style=color:#a6e22e>Flush</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>cw</span>.<span style=color:#a6e22e>Error</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>read</span>(<span style=color:#a6e22e>r</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>ReadCloser</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>rr</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bufio</span>.<span style=color:#a6e22e>NewReader</span>(<span style=color:#a6e22e>r</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>line</span>, <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rr</span>.<span style=color:#a6e22e>ReadLine</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>EOF</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>		writer, err := os.Create(&#34;./test.txt&#34;)
</span></span></span><span style=display:flex><span><span style=color:#75715e>		if err != nil {
</span></span></span><span style=display:flex><span><span style=color:#75715e>			log.Fatal(err)
</span></span></span><span style=display:flex><span><span style=color:#75715e>		}
</span></span></span><span style=display:flex><span><span style=color:#75715e>		defer writer.Close()
</span></span></span><span style=display:flex><span><span style=color:#75715e>	*/</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>writer</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Stdout</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>writer</span>.<span style=color:#a6e22e>Write</span>(append(<span style=color:#a6e22e>line</span>, []<span style=color:#66d9ef>byte</span>{<span style=color:#e6db74>&#39;\n&#39;</span>}<span style=color:#f92672>...</span>)); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>Copy</span>(<span style=color:#a6e22e>writer</span>, <span style=color:#a6e22e>rr</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>w</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>Pipe</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>write</span>(<span style=color:#a6e22e>w</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>read</span>(<span style=color:#a6e22e>r</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li><a href=https://go.dev/play/p/nI-vBAumtAk>https://go.dev/play/p/nI-vBAumtAk</a></li></ul><p>Pipe を使うことで読み込みの処理と書き込みの処理を分離できる。ここでいう読み込みはバッチ処理、書き込みはエラーデータの保存処理に相当する。普通に実装すると、バッチ処理中にエラーデータの保存処理も記述することになる。業務のコードだと本質ではないリソース管理が煩雑になってしまう。2つの処理に分割するため、どちらか一方は非同期で実行する必要がある。ここで goroutine のシンプルさが際立つ。さらに pipe を使えば、reader 側は writer が Close するまでブロックするから終了処理の同期も自然なコードで実現してくれる。</p><p>非同期／並行処理の難しいところを go のインターフェースによる抽象化、簡潔な goroutine 記法、pipe に隠蔽された自然な同期処理の3つで簡潔に表現している。複雑さに対してこれほど簡潔なコードはそうそうないと思う。このコードを他の言語で実装しようとしたらもっと複雑になるはず。このサンプルコードとともに若いメンバーにリソース管理のリファクタリングをコードレビューで指摘したものの、そのメンバーには理解できなくて実装できなかった。そして、その処理を私が作り直すことになったというのが、今日のお仕事だった。本当は難しい非同期／並行処理をいくら簡潔にしても、その経験がないと人間には理解できない。まさに本質的複雑さを表しているように思える。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0905/>go で parser を実装してみた</a></h1><div class=post-meta><time class=post-date>2024-09-05</time></div><span class=post-tags>#<a href=/diary/tags/ldap/>ldap</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;</span><div class=post-content><p><a href=/diary/posts/2024/0904/>昨日の ldap スキーマ parser 実装</a> の続き。parser generator は使わず自分で parser を実装してみることにした。go の標準ライブラリにある <a href=https://pkg.go.dev/text/scanner>text/scanner</a> を使って字句解析をしたら、次のカスタマイズを行うことでそれっぽく token に分解できた。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Mode</span> ^= <span style=color:#a6e22e>scanner</span>.<span style=color:#a6e22e>ScanFloats</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>IsIdentRune</span> = <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>ch</span> <span style=color:#66d9ef>rune</span>, <span style=color:#a6e22e>i</span> <span style=color:#66d9ef>int</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ch</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;.&#39;</span> <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>unicode</span>.<span style=color:#a6e22e>IsLetter</span>(<span style=color:#a6e22e>ch</span>) <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>unicode</span>.<span style=color:#a6e22e>IsDigit</span>(<span style=color:#a6e22e>ch</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>しかし、text/scanner はあくまで go のソースコードを字句解析するためのツールになる。ldap スキーマの字句解析も一応は意図したように分割できたが <code>'objectClass'</code> のようなシングルクォートで文字列を囲むような構文を go のソースコードでは記述できないため、エラーをチェックすると <code>invalid char literal</code> として必ずエラーになってしまう。これでは字句解析のエラーチェックをできなくなってしまうため text/scanner の利用は断念した。</p><p>そこで <a href=https://pkg.go.dev/bufio#Scanner>bufio#Scanner</a> を使って字句解析を実装した。字句解析を行うツールを lexer または tokenizer と呼ぶ。go ではこのツールを scanner と呼ぶ慣習になってるようにみえる。分割する token をカスタマイズするには <a href=https://pkg.go.dev/bufio#SplitFunc>SplitFunc</a> を定義する。ldap スキーマの字句解析は次のように定義できた。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>singleQuote</span> <span style=color:#66d9ef>byte</span> = <span style=color:#e6db74>&#39;\&#39;&#39;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>tokenize</span>(
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>data</span> []<span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>atEOF</span> <span style=color:#66d9ef>bool</span>,
</span></span><span style=display:flex><span>) (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>advance</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>token</span> []<span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>,
</span></span><span style=display:flex><span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>advance</span>, <span style=color:#a6e22e>token</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>bufio</span>.<span style=color:#a6e22e>ScanWords</span>(<span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>atEOF</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>token</span>) &gt; <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>token</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>==</span> <span style=color:#a6e22e>singleQuote</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>since</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>data</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>!=</span> <span style=color:#a6e22e>singleQuote</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>since</span> = <span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>IndexByte</span>(<span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>singleQuote</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>IndexByte</span>(<span style=color:#a6e22e>data</span>[<span style=color:#a6e22e>since</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>:], <span style=color:#a6e22e>singleQuote</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>bufio</span>.<span style=color:#a6e22e>ErrFinalToken</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>pos</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>since</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>pos</span>, <span style=color:#a6e22e>data</span>[<span style=color:#a6e22e>since</span>:<span style=color:#a6e22e>pos</span>], <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewScanner</span>(<span style=color:#a6e22e>src</span> <span style=color:#66d9ef>string</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>bufio</span>.<span style=color:#a6e22e>Scanner</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bufio</span>.<span style=color:#a6e22e>NewScanner</span>(<span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>NewReader</span>(<span style=color:#a6e22e>src</span>))
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Split</span>(<span style=color:#a6e22e>tokenize</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>s</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>次のような ldap スキーマの文字列は、</p><p><code>( 2.5.4.0 NAME 'objectClass' DESC 'RFC4512: object classes of the entity' EQUALITY objectIdentifierMatch SYNTAX 1.3.6.1.4.1.1466.115.121.1.38 )</code></p><p>次のように token として分割される。</p><pre tabindex=0><code>(
2.5.4.0
NAME
&#39;objectClass&#39;
DESC
&#39;RFC4512: object classes of the entity&#39;
EQUALITY
objectIdentifierMatch
SYNTAX
1.3.6.1.4.1.1466.115.121.1.38
)
</code></pre><p>あとはこれらの token から構文解析を行う parser を実装するだけ。AttributeTypeDescription の文法は次になる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-abnf data-lang=abnf><span style=display:flex><span><span style=color:#a6e22e>AttributeTypeDescription</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>&#34;(&#34;</span> <span style=color:#a6e22e>whsp</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>numericoid</span> <span style=color:#a6e22e>whsp</span>              <span style=color:#75715e>; AttributeType identifier</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;NAME&#34;</span> <span style=color:#a6e22e>qdescrs</span> ]             <span style=color:#75715e>; name used in AttributeType</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;DESC&#34;</span> <span style=color:#a6e22e>qdstring</span> ]            <span style=color:#75715e>; description</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;OBSOLETE&#34;</span> <span style=color:#a6e22e>whsp</span> ]
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;SUP&#34;</span> <span style=color:#a6e22e>woid</span> ]                 <span style=color:#75715e>; derived from this other</span>
</span></span><span style=display:flex><span>                                   <span style=color:#75715e>; AttributeType</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;EQUALITY&#34;</span> <span style=color:#a6e22e>woid</span>              <span style=color:#75715e>; Matching Rule name</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;ORDERING&#34;</span> <span style=color:#a6e22e>woid</span>              <span style=color:#75715e>; Matching Rule name</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;SUBSTR&#34;</span> <span style=color:#a6e22e>woid</span> ]              <span style=color:#75715e>; Matching Rule name</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;SYNTAX&#34;</span> <span style=color:#a6e22e>whsp</span> <span style=color:#a6e22e>noidlen</span> <span style=color:#a6e22e>whsp</span> ] <span style=color:#75715e>; Syntax OID</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;SINGLE-VALUE&#34;</span> <span style=color:#a6e22e>whsp</span> ]        <span style=color:#75715e>; default multi-valued</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;COLLECTIVE&#34;</span> <span style=color:#a6e22e>whsp</span> ]          <span style=color:#75715e>; default not collective</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;NO-USER-MODIFICATION&#34;</span> <span style=color:#a6e22e>whsp</span> ]<span style=color:#75715e>; default user modifiable</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;USAGE&#34;</span> <span style=color:#a6e22e>whsp</span> <span style=color:#a6e22e>AttributeUsage</span> ]<span style=color:#75715e>; default userApplications</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>whsp</span> <span style=color:#ae81ff>&#34;)&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>AttributeUsage</span> <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>&#34;userApplications&#34;</span>     <span style=color:#f92672>/</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>&#34;directoryOperation&#34;</span>   <span style=color:#f92672>/</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>&#34;distributedOperation&#34;</span> <span style=color:#f92672>/</span> <span style=color:#75715e>; DSA-shared</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>&#34;dSAOperation&#34;</span>          <span style=color:#75715e>; DSA-specific, value depends on server</span>
</span></span></code></pre></div><p>字句解析する scanner と組み合わせて実装した parser は次のようになる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>ParseAttributeTypeDescription</span>(
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>src</span> <span style=color:#66d9ef>string</span>,
</span></span><span style=display:flex><span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>AttributeTypeDescription</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>d</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>AttributeTypeDescription</span>{}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NewScanner</span>(<span style=color:#a6e22e>src</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Scan</span>() {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>token</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Text</span>()
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>token</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>leftParenthesis</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Scan</span>() {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>OID</span> = <span style=color:#a6e22e>OID</span>{<span style=color:#a6e22e>Value</span>: <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Text</span>()}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>rightParenthesis</span>:
</span></span><span style=display:flex><span>			<span style=color:#75715e>// do nothing
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;NAME&#34;</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Scan</span>() {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Name</span> = <span style=color:#a6e22e>ParseNAME</span>(<span style=color:#a6e22e>s</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;DESC&#34;</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Scan</span>() {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Desc</span> = <span style=color:#a6e22e>Unquote</span>(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Text</span>())
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;OBSOLETE&#34;</span>:
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Obsolete</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;SUP&#34;</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Scan</span>() {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Sup</span> = <span style=color:#a6e22e>NewWOID</span>(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Text</span>())
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;EQUALITY&#34;</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Scan</span>() {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Equality</span> = <span style=color:#a6e22e>NewWOID</span>(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Text</span>())
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;ORDERING&#34;</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Scan</span>() {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Ordering</span> = <span style=color:#a6e22e>NewWOID</span>(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Text</span>())
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;SUBSTR&#34;</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Scan</span>() {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>SubStr</span> = <span style=color:#a6e22e>NewWOID</span>(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Text</span>())
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;SYNTAX&#34;</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Scan</span>() {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Syntax</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>ParseNOIDLen</span>(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Text</span>())
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to parse SYNTAX: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;SINGLE-VALUE&#34;</span>:
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>SingleValue</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;COLLECTIVE&#34;</span>:
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Collective</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;NO-USER-MODIFICATION&#34;</span>:
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>NoUserModification</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;USAGE&#34;</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Scan</span>() {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>usage</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>GetAttributeTypeUsage</span>(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Text</span>())
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Usage</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>usage</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>HasPrefix</span>(<span style=color:#a6e22e>token</span>, <span style=color:#e6db74>&#34;X-&#34;</span>) {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Scan</span>() {
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Extension</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>						<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Extension</span> = make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>][]<span style=color:#66d9ef>string</span>)
</span></span><span style=display:flex><span>					}
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Extension</span>[<span style=color:#a6e22e>token</span>] = <span style=color:#a6e22e>ParseQuotedStrings</span>(<span style=color:#a6e22e>s</span>)
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>slog</span>.<span style=color:#a6e22e>Warn</span>(<span style=color:#e6db74>&#34;unsupported&#34;</span>, <span style=color:#e6db74>&#34;token&#34;</span>, <span style=color:#a6e22e>token</span>, <span style=color:#e6db74>&#34;oid&#34;</span>, <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>OID</span>, <span style=color:#e6db74>&#34;name&#34;</span>, <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Name</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Err</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to scan: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>d</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>昨日の調査で go 製の parser generator をあまりみつけられなかったことに気付いた。その理由を理解できた。go で初めて parser を実装してみて簡単に実装できることに気付いた。標準ライブラリにある text/scanner や bufio#Scanner を使うと簡単に字句解析できるため、自分で parser を実装する労力が小さい。したがって parser generator を使って実装するよりも、自分で parser を実装することを選ぶ開発者が多いのではないかと推測する。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0903/>case-insensitive という古くて厄介な問題</a></h1><div class=post-meta><time class=post-date>2024-09-03</time></div><span class=post-tags>#<a href=/diary/tags/ldap/>ldap</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;
#<a href=/diary/tags/refactoring/>refactoring</a>&nbsp;</span><div class=post-content><h2 id=casemap-によるリファクタリング>casemap によるリファクタリング</h2><p>ldap プロトコル (v3) は <a href=https://datatracker.ietf.org/doc/html/rfc2251>rfc 2251</a> で定義されていて属性へのアクセスは case-insensitive (大文字小文字を区別しない) に扱うという仕様になっている。</p><p>ldap サーバーへの問い合わせや検索は case-insensitive となるため、ldap エントリーを扱う他システムの処理もすべて case-insensitive にしないと整合性が取れなくて混乱する。これは利用者だけでなく開発者も同様であり、一部が case-insensitive なのに、一部を case-sensitive (大文字小文字を区別する) にすると、比較処理がマッチしたりしなかったりという混乱を生じる。そういう面倒くさい issue が過去にいくつか散見されてきた。この問題は場当たり的な修正ではなく、本質的な対応が求められた。</p><p>結論としては、すべてを case-insensitive に扱う必要があって、そのためにキーを case-insensitive として扱う map like なデータ構造を実装した。オリジナルのキー情報も保持しつつ、case-insensitive にアクセスできるよう小文字変換しておいた名前変換テーブルを内部にもつ。最初からこういったデータ構造を定義しておけば開発時に混乱は起きないが、こういうものは後になってわかってくる。うちは1年半経ってからこの問題の本質を理解した。そのため、関連する処理のインターフェースを見直して置き換えることになった。こういうリファクタリングは時間がかかる割に成果も地味なので労力に対して評価されないことが多い。私もやっていてあまり楽しくはないが、こういうところをきっちり作ると品質に寄与するのを経験的に知っている。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>CaseMap</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>keyValue</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>][]<span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>nameConv</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>CaseMap</span>) <span style=color:#a6e22e>String</span>() <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;%v&#34;</span>, <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>keyValue</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>CaseMap</span>) <span style=color:#a6e22e>Values</span>(<span style=color:#a6e22e>name</span> <span style=color:#66d9ef>string</span>) []<span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>origName</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>nameConv</span>[<span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>ToLower</span>(<span style=color:#a6e22e>name</span>)]
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>values</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>keyValue</span>[<span style=color:#a6e22e>origName</span>]
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>values</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>CaseMap</span>) <span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>name</span> <span style=color:#66d9ef>string</span>) ([]<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>bool</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>origName</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>nameConv</span>[<span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>ToLower</span>(<span style=color:#a6e22e>name</span>)]
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>values</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>keyValue</span>[<span style=color:#a6e22e>origName</span>]
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>values</span>, <span style=color:#a6e22e>ok</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>CaseMap</span>) <span style=color:#a6e22e>Set</span>(<span style=color:#a6e22e>name</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>values</span> []<span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>keyValue</span>[<span style=color:#a6e22e>name</span>] = <span style=color:#a6e22e>values</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>nameConv</span>[<span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>ToLower</span>(<span style=color:#a6e22e>name</span>)] = <span style=color:#a6e22e>name</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>CaseMap</span>) <span style=color:#a6e22e>Len</span>() <span style=color:#66d9ef>int</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> len(<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>keyValue</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>CaseMap</span>) <span style=color:#a6e22e>Iter</span>() <span style=color:#a6e22e>iter</span>.<span style=color:#a6e22e>Seq2</span>[<span style=color:#66d9ef>string</span>, []<span style=color:#66d9ef>string</span>] {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>yield</span> <span style=color:#66d9ef>func</span>(<span style=color:#66d9ef>string</span>, []<span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>bool</span>) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>k</span>, <span style=color:#a6e22e>v</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>keyValue</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>yield</span>(<span style=color:#a6e22e>k</span>, <span style=color:#a6e22e>v</span>) {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>CaseName</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Original</span>  <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>LowerName</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>CaseMap</span>) <span style=color:#a6e22e>IterWithLower</span>() <span style=color:#a6e22e>iter</span>.<span style=color:#a6e22e>Seq2</span>[<span style=color:#a6e22e>CaseName</span>, []<span style=color:#66d9ef>string</span>] {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>yield</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>CaseName</span>, []<span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>bool</span>) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>lowerName</span>, <span style=color:#a6e22e>origName</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>nameConv</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>name</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>CaseName</span>{
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>Original</span>:  <span style=color:#a6e22e>origName</span>,
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>LowerName</span>: <span style=color:#a6e22e>lowerName</span>,
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>yield</span>(<span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>keyValue</span>[<span style=color:#a6e22e>origName</span>]) {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>CaseMap</span>) <span style=color:#a6e22e>ToMap</span>() <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>][]<span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>keyValue</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>length</span> <span style=color:#66d9ef>int</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>CaseMap</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>CaseMap</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>keyValue</span>: make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>][]<span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>length</span>),
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>nameConv</span>: make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>length</span>),
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewFrom</span>(<span style=color:#a6e22e>attr</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>][]<span style=color:#66d9ef>string</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>CaseMap</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>m</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>New</span>(len(<span style=color:#a6e22e>attr</span>))
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>k</span>, <span style=color:#a6e22e>v</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>attr</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>Set</span>(<span style=color:#a6e22e>k</span>, <span style=color:#a6e22e>v</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>m</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0816/>go の iterator 実装へのリファクタリング</a></h1><div class=post-meta><time class=post-date>2024-08-16</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;
#<a href=/diary/tags/mongodb/>mongodb</a>&nbsp;</span><div class=post-content><h2 id=mongo-go-driver-を使った-go-の-iterator-実装>mongo-go-driver を使った go の iterator 実装</h2><p>先日 <a href=https://go.dev/blog/go1.23>go 1.23</a> がリリースされた。このバージョンの目玉機能の1つに <a href=https://go.dev/wiki/RangefuncExperiment>range-over function iterators</a> がある。簡潔に言えば、ユーザー定義のイテレーターを言語機能の仕組みを使って簡単に実装できる。ある制約を満たして関数を実装すれば、for 文の range 構文を使ってイテレーターとして扱える。ユーザー定義のイテレーターを実装するのが、ほとんど関数を実装するだけで出来てしまうので実装の難易度が減ったと言える。どんなコードかをみるには次のチュートリアルがわかりやすいと思う。</p><ul><li><a href=https://future-architect.github.io/articles/20240718a/>Go 1.23リリース連載 range over funcとiterパッケージ</a></li></ul><p>昨日で私が抱えていたプロジェクトのボトルネックを解消できた。ここからはボーナスステージで相対的に自由に開発できる。手始めにプロダクトの依存バージョンを go 1.23 へアップグレードして mongodb からの fetch 処理をイテレーターに置き換えるリファクタリングをした。アプリケーションからみたら mongodb は Store という generic なインターフェースを定義していて、そこに Iter() メソッドを追加した。mongodb のコレクションは必ず Iter() メソッドを実装しなければいけないという制約を課す。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Store</span>[<span style=color:#a6e22e>T</span> <span style=color:#a6e22e>any</span>] <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Iter</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>query</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>Query</span>, <span style=color:#a6e22e>opt</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sort</span>.<span style=color:#a6e22e>Option</span>) <span style=color:#a6e22e>iter</span>.<span style=color:#a6e22e>Seq2</span>[<span style=color:#f92672>*</span><span style=color:#a6e22e>T</span>, <span style=color:#66d9ef>error</span>]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><a href=https://github.com/mongodb/mongo-go-driver>mongo-go-driver</a> はもともと cursor でイテレーター機能を提供しているため、これを range-over function iterators を使ってアプリケーションから使えるように間をつなげてあげればよい。具体的には generics を使って次のような汎用の iter() メソッドを mongodb client に実装する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>client</span>[<span style=color:#a6e22e>R</span>, <span style=color:#a6e22e>E</span>]) <span style=color:#a6e22e>iter</span>(
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>name</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>filters</span> <span style=color:#a6e22e>queryFilters</span>, <span style=color:#a6e22e>sortOpt</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sort</span>.<span style=color:#a6e22e>Option</span>,
</span></span><span style=display:flex><span>) <span style=color:#a6e22e>iter</span>.<span style=color:#a6e22e>Seq2</span>[<span style=color:#f92672>*</span><span style=color:#a6e22e>E</span>, <span style=color:#66d9ef>error</span>] {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>toEntity</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		panic(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;require toEntity() function&#34;</span>))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>yield</span> <span style=color:#66d9ef>func</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>E</span>, <span style=color:#66d9ef>error</span>) <span style=color:#66d9ef>bool</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>collection</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>raw</span>.<span style=color:#a6e22e>Database</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>db</span>).<span style=color:#a6e22e>Collection</span>(<span style=color:#a6e22e>name</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>opts</span> <span style=color:#f92672>:=</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>FindOptions</span>{}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sortOpt</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>opt</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>Find</span>().<span style=color:#a6e22e>SetSort</span>(<span style=color:#a6e22e>makeSortSet</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>sortOpt</span>))
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>opts</span> = append(<span style=color:#a6e22e>opts</span>, <span style=color:#a6e22e>opt</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>cursor</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>collection</span>.<span style=color:#a6e22e>Find</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>filters</span>, <span style=color:#a6e22e>opts</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>yield</span>(<span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>cursor</span>.<span style=color:#a6e22e>Close</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>cursor</span>.<span style=color:#a6e22e>Next</span>(<span style=color:#a6e22e>ctx</span>) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>result</span> <span style=color:#a6e22e>R</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>cursor</span>.<span style=color:#a6e22e>Decode</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>result</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>yield</span>(<span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>yield</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>toEntity</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>result</span>), <span style=color:#66d9ef>nil</span>) {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>cursor</span>.<span style=color:#a6e22e>Err</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>yield</span>(<span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Store インターフェースを満たすコレクションの実装は次のように型チェックのためのメソッド実装をもてばよい。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>MyCollection</span>) <span style=color:#a6e22e>Iter</span>(
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>query</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>Query</span>, <span style=color:#a6e22e>opts</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sort</span>.<span style=color:#a6e22e>Option</span>,
</span></span><span style=display:flex><span>) <span style=color:#a6e22e>iter</span>.<span style=color:#a6e22e>Seq2</span>[<span style=color:#f92672>*</span><span style=color:#a6e22e>entry</span>.<span style=color:#a6e22e>MyEntity</span>, <span style=color:#66d9ef>error</span>] {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>iter</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>makeFilters</span>(<span style=color:#a6e22e>query</span>), <span style=color:#a6e22e>opts</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>朝から iterator 実装の試行錯誤や使い方の勘どころを確かめながら、これも1日でほとんどリファクタリングして移行できた。python のジェネレーターもそうだけど、関数をイテレーターにできると直感的にわかりやすく簡潔に実装できる。すごくよい機能だと思う。1.23 以降の go のコードはイテレーターを使うよう、大きく変わっていくと思われる。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0805/>サーバーの拡張とフックポイント</a></h1><div class=post-meta><time class=post-date>2024-08-05</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;
#<a href=/diary/tags/economy-investing/>economy investing</a>&nbsp;</span><div class=post-content><p>今日は東京株式市場の歴史的な急落もあっていろいろ経済ニュースを読んでいた。</p><h2 id=echo-の-custom-binding>echo の Custom Binding</h2><p>echo で開発していて気に入っているところの1つに、サーバーサイドの、ここをカスタマイズしたいという箇所にちゃんと拡張するためのフックが用意されているというのがある。例えば、リクエストデータとサーバー内部で使う構造体を紐付ける bind 処理もデフォルトの仕組みを拡張する <a href=https://echo.labstack.com/docs/binding#custom-binding>Custom Binding</a> が提供されている。</p><p>Echo 構造体の値に Binder というフィールドがあり、カスタマイズしたい処理を実装した Binder インターフェースの値をセットする。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>e</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>New</span>()
</span></span><span style=display:flex><span><span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>Binder</span> = <span style=color:#a6e22e>binder</span>.<span style=color:#a6e22e>New</span>()
</span></span></code></pre></div><p>Binder はリクエスト構造体の値と echo.Context の値を受け取る <code>Bind()</code> メソッドを実装する。基本的には echo.DefaultBinder を適用した後にカスタマイズしたい bind 処理を実装すればよいと思う。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Binder</span> <span style=color:#66d9ef>struct</span>{}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>b</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Binder</span>) <span style=color:#a6e22e>Bind</span>(<span style=color:#a6e22e>i</span> <span style=color:#a6e22e>any</span>, <span style=color:#a6e22e>c</span> <span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>defaultBinder</span> <span style=color:#f92672>:=</span> new(<span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>DefaultBinder</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>defaultBinder</span>.<span style=color:#a6e22e>Bind</span>(<span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>c</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>req</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>i</span>.(<span style=color:#66d9ef>type</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>myRequest</span>:
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>BindSomething</span>(<span style=color:#a6e22e>c</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>New</span>() <span style=color:#f92672>*</span><span style=color:#a6e22e>Binder</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>Binder</span>{}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>bind 処理をどう実装するかはいろいろやり方があると思うが、echo.Context の値を渡せるので request 構造体にその実装を隠蔽するというのもいいんじゃないかと思う。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>myRequest</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>myRequest</span>) <span style=color:#a6e22e>UnmarshalJSON</span>(<span style=color:#a6e22e>data</span> []<span style=color:#66d9ef>byte</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Alias</span> <span style=color:#a6e22e>myRequest</span> 
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Unmarshal</span>(<span style=color:#a6e22e>data</span>, (<span style=color:#f92672>*</span><span style=color:#a6e22e>Alias</span>)(<span style=color:#a6e22e>r</span>)); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to unmarshal ids request: %s&#34;</span>, <span style=color:#a6e22e>data</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>    <span style=color:#75715e>// implement custom validation
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>myRequest</span>) <span style=color:#a6e22e>BindSomething</span>(<span style=color:#a6e22e>c</span> <span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// implement custom binding
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=日経平均株価の歴史的な急落>日経平均株価の歴史的な急落</h2><p><a href=/diary/posts/2024/0802/#日経平均株価の急落>金曜日から2日連続</a> で株価指数が 5% 超も下落するのは世界的にも珍しいらしい。</p><ul><li><a href=https://www3.nhk.or.jp/news/html/20240805/k10014537281000.html>株価 過去最大の値下がり ブラックマンデー超え“4つの要因”</a></li></ul><blockquote class=twitter-tweet><p lang=ja dir=ltr>◆ CNBCトップに<br>「日経平均 急落」がCNBCやFTでもトップニュースになっています。2日連続で株価指数が5%超も下落するのは世界的にも珍しいことです。<br>ナスダック先物は2%超の値下がりしています <a href=https://t.co/YGuNKzEdT2>https://t.co/YGuNKzEdT2</a> <a href=https://t.co/CcB2XoycPd>pic.twitter.com/CcB2XoycPd</a></p>&mdash; 後藤達也 (@goto_finance) <a href="https://twitter.com/goto_finance/status/1820280069119783135?ref_src=twsrc%5Etfw">August 5, 2024</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script><p>金曜日に史上2番目の下落幅という見出しでメディアでは煽られていて、下落幅と下落率は違うからそんな不安に感じなくてよいと楽観していたら、今日は史上2番目の下落率 (-12.40%) となった。さらにストップ安になっている銘柄が相次いでいるから実体はもっと悪いと考えられるとのこと。一方でリーマンショックのような、金融機関が破綻しているような状況でもなく、実体経済が傷んでないのに売りが売りを呼ぶ急落になっているので今後どうなるのかはよく分からない。明日も下がるのか、反発するのか、誰にもわからない (素人はしばらく何もしない方がよい) 。注目していた任天堂の株価も -16.53% と日経平均株価以上に急落している。これだけ落ちると、信用取引の追証が2営業日以内となるため、任天堂は明後日「投げ売り」されてもう少し下がる可能性もあるかもしれない。いずれにしても、私は今週いっぱいぐらいかけて空売りの返済をしていく。買うときも売るときも一度に行うのではなく、タイミングや数量を分割してならしていく。</p><p>株価の急落について私の記憶にあるのは、2016年の米大統領選挙でトランプ氏が初当選したとき、2020年にコロナが流行り始めたときを思い出した。たまたまだけど、4年に1回は急落がやってきている。2016年も2020年もとくになにもせず私は見守っていただけだった。しかし、今回は事前にポートフォリオを見直したり、空売りでリスクヘッジしていたりと急落の場面にも対応できた。以前よりは経済の背景を学んで資産運用の行動に反映できるようになってきた。これは経営においてもよいことだと思う。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0803/>mongodb も一応は外部結合できる</a></h1><div class=post-meta><time class=post-date>2024-08-03</time></div><span class=post-tags>#<a href=/diary/tags/mongodb/>mongodb</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;
#<a href=/diary/tags/health/>health</a>&nbsp;</span><div class=post-content><p>今日は出張中にたまっていた日記をまとめて書いていた。昨日筋トレしたから運動はおやすみ。</p><h2 id=mongodb-における外部結合>mongodb における外部結合</h2><p>出張中のふりかえりやプロジェクトマネジメントの合間に mongodb の <a href=https://www.mongodb.com/docs/manual/reference/operator/aggregation/lookup/>$lookup (aggregation)</a> 機能を調査していた。一言で言えば、rdbms で言うところの外部結合 (join) を mongodb で実現する機能と言える。しかし、aggregation の機能として実装されていることから rdbms の外部結合とはパフォーマンスの側面で大きく違うのでは？と推測する。mongodb のような kvs では基本的に外部結合のようなことは行わず、結合済みのコレクションを定義するやり方がプラクティスとされる。一方で整合性を保証するには外部結合は有効なデザインパターンの1つなので使いたい場面があってもおかしくない。実際に mongodb に $lookup が実装されているのだから、そのニーズは大きいのだと思われる。</p><p>ちょうどいまやっている開発でその要件があったので <a href=https://github.com/mongodb/mongo-go-driver>mongo-go-driver</a> の次のチュートリアルをみながら実装してみた。</p><ul><li><a href=https://www.mongodb.com/blog/post/quick-start-golang--mongodb--data-aggregation-pipeline>Quick Start: Golang & MongoDB - Data Aggregation Pipeline</a></li></ul><p>例えば、次のような2つのコレクションがある。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Group</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ID</span>          <span style=color:#66d9ef>string</span>      <span style=color:#e6db74>`bson:&#34;_id&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Name</span>        <span style=color:#66d9ef>string</span>      <span style=color:#e6db74>`bson:&#34;name&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>UpdatedAt</span>   <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>   <span style=color:#e6db74>`bson:&#34;updatedAt&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>MyData</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ID</span>           <span style=color:#66d9ef>string</span>    <span style=color:#e6db74>`bson:&#34;_id&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>GroupID</span>      <span style=color:#66d9ef>string</span>    <span style=color:#e6db74>`bson:&#34;groupID&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>RegisteredAt</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span> <span style=color:#e6db74>`bson:&#34;registeredAt&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>MyData の GroupID フィールドが Group コレクションの ID を保持して外部参照している。MyData コレクションに対する aggregate に渡すパラメーターとして pipeline を渡す。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>myPipeline</span> = <span style=color:#a6e22e>mongo</span>.<span style=color:#a6e22e>Pipeline</span>{
</span></span><span style=display:flex><span>	{{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Key</span>: <span style=color:#e6db74>&#34;$lookup&#34;</span>, <span style=color:#a6e22e>Value</span>: <span style=color:#a6e22e>bson</span>.<span style=color:#a6e22e>D</span>{
</span></span><span style=display:flex><span>			{<span style=color:#a6e22e>Key</span>: <span style=color:#e6db74>&#34;from&#34;</span>, <span style=color:#a6e22e>Value</span>: <span style=color:#e6db74>&#34;group&#34;</span>},
</span></span><span style=display:flex><span>			{<span style=color:#a6e22e>Key</span>: <span style=color:#e6db74>&#34;localField&#34;</span>, <span style=color:#a6e22e>Value</span>: <span style=color:#e6db74>&#34;groupID&#34;</span>},
</span></span><span style=display:flex><span>			{<span style=color:#a6e22e>Key</span>: <span style=color:#e6db74>&#34;foreignField&#34;</span>, <span style=color:#a6e22e>Value</span>: <span style=color:#e6db74>&#34;_id&#34;</span>},
</span></span><span style=display:flex><span>			{<span style=color:#a6e22e>Key</span>: <span style=color:#e6db74>&#34;as&#34;</span>, <span style=color:#a6e22e>Value</span>: <span style=color:#e6db74>&#34;foreignGroup&#34;</span>},
</span></span><span style=display:flex><span>		},
</span></span><span style=display:flex><span>	}},
</span></span><span style=display:flex><span>	{{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Key</span>: <span style=color:#e6db74>&#34;$unwind&#34;</span>, <span style=color:#a6e22e>Value</span>: <span style=color:#a6e22e>bson</span>.<span style=color:#a6e22e>D</span>{
</span></span><span style=display:flex><span>			{<span style=color:#a6e22e>Key</span>: <span style=color:#e6db74>&#34;path&#34;</span>, <span style=color:#a6e22e>Value</span>: <span style=color:#e6db74>&#34;$foreignGroup&#34;</span>},
</span></span><span style=display:flex><span>			{<span style=color:#a6e22e>Key</span>: <span style=color:#e6db74>&#34;preserveNullAndEmptyArrays&#34;</span>, <span style=color:#a6e22e>Value</span>: <span style=color:#66d9ef>false</span>},
</span></span><span style=display:flex><span>		},
</span></span><span style=display:flex><span>	}},
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>$lookup の操作の後に $unwind で配列を flatten する処理がセットになる。result set にマッピングするためには flatten が必要になるのだと推測する。aggregate() を呼び出すと cursor が返ってきて、その cursor に外部結合される値の配列を渡すことで result set を取得できる。デバッグはややこしいし、コード上もちょっとわかりにくいけど、これは mongodb のお作法だと割り切ってユーティリティ化してしまえばよいものだと思う。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>joinedMyData</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ID</span>           <span style=color:#66d9ef>string</span>    <span style=color:#e6db74>`bson:&#34;_id&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Group</span>        <span style=color:#a6e22e>Group</span>     <span style=color:#e6db74>`bson:&#34;foreignGroup&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>RegisteredAt</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span> <span style=color:#e6db74>`bson:&#34;registeredAt&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>cursor</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>collection</span>.<span style=color:#a6e22e>Aggregate</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>myPipeline</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>joined</span> []<span style=color:#a6e22e>joinedMember</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>cursor</span>.<span style=color:#a6e22e>All</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>joined</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>また時間があるときにある程度のデータ量でどのぐらいの負荷に対してパフォーマンスが出るのかを測ってみたい。</p><h2 id=ストレッチ>ストレッチ</h2><p>昨日1週間ぶりに筋トレをしたせいか、今朝から筋肉痛になっていてカラダが痛い。その影響もあって今日の開脚幅は開始前146cmで、ストレッチ後152cmとカラダが硬かった。足も腰も肩周りも全身にわたって軽い筋肉痛だった。それだけよい感じの負荷をかけて筋トレができていたと言えるのかもしれない。あちこち筋肉痛はあったものの、ストレッチを受けていての辛さのようなものは感じなかった。ちょうどよい感じにほぐされているような印象を受けた。もしかしたらトレーナーさんが気を遣っていつもよりは弱めにストレッチしてくれたのかもしれない。トレーナーさんが立候補していた店長選挙は落選してしまったらしい。もし店長になったらよそのお店へ転勤になって担当者が変わってしまうのかなとも思っていた。トレーナーさんは私が通っているお店の副店長を務める方向で調整しているらしい。待遇をあげていくにはキャリアアップをしていかないといけないといった背景もあるようにみえる。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0610/>テストの依存関係をステージで表現する</a></h1><div class=post-meta><time class=post-date>2024-06-10</time></div><span class=post-tags>#<a href=/diary/tags/testing/>testing</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;
#<a href=/diary/tags/issue-management/>issue management</a>&nbsp;</span><div class=post-content><p>今日の運動は腹筋ローラー,腕立て,縄跳び(両足跳),散歩,ジョギング,ハンドグリップをした。統計を <a href="https://docs.google.com/spreadsheets/d/1bg85QtM-LciUgey8I79uI7vW2PEwsP6TVdeIRVkACBg/edit?usp=sharing">運動の記録</a> にまとめる。</p><h2 id=qa-テストの設計>qa テストの設計</h2><p>システムや機能が複雑になった後の qa テストをどう設計するか。先日 <a href=/diary/posts/2024/0607/#qa-テストのテスト設計>Full Stack Testing を読んで考察</a> したりしていた。テストでもっとも工数がかかるのはデータや設定も含めてテストできる環境を構築すること。gitlab ci/cd で3つのテスト環境を構築しているものの、それらと qa テストのテストケースとどうやって関連させるか、またはテストの依存関係をどのように表現するかといったことを設計の重要事項として考察していた。</p><p>これまで google sheets の1ファイルですべてのテストケースを管理していた。しかし、機能が増え、テストケースが増えていくにあたり、この1ファイルにより管理は破綻しかけていた。id 連携という、複数のシステムまたはモジュールを介してデータをやり取りするというアプリケーションの特性上、テストの依存関係は google sheets の1ファイルでは表現できない。そこで「ステージ」という概念を導入し、google drive のフォルダや階層構造で依存関係を表現することにした。ステージ1のテストが成功しない限り、ステージ2のテストが成功することはない。業務における本質的な難しさである依存関係を人間にとってどう管理していくかが重要になる。急にこれらの qa テストをすべてできるわけではないが、ステージを3つまで定義した。最後の手動探索テストを issue の創発という、課題管理にとって重要な位置づけにおさめたのが個人的にお気に入り。実際に手動探索テストをどのように実施できるか？というのはまだまだこれからの課題ではあるが。</p><ul><li>ステージ1<ul><li>2つのシステム間におけるテスト</li><li>特定モジュールの振る舞いの検証</li><li>ui 周りのテスト</li></ul></li><li>ステージ2<ul><li>複数のシステムをまたがるテスト</li><li>機能横断的な要求テスト<ul><li>可用性に関するテスト</li><li>エラー制御に関するテスト</li></ul></li><li>アプリケーションの機能が動作した次にある高度な要件<ul><li>セキュリティテスト</li><li>パフォーマンステスト</li><li>アクセシビリティテスト</li></ul></li></ul></li><li>ステージ3<ul><li>手動探索テスト<ul><li>issue の創発</li></ul></li></ul></li></ul></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0607/>テスト設計についての考察</a></h1><div class=post-meta><time class=post-date>2024-06-07</time></div><span class=post-tags>#<a href=/diary/tags/biztrip/>biztrip</a>&nbsp;
#<a href=/diary/tags/testing/>testing</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;
#<a href=/diary/tags/book/>book</a>&nbsp;
#<a href=/diary/tags/sake/>sake</a>&nbsp;</span><div class=post-content><p>飲みにいっていたので今日の運動はお休み。</p><h2 id=都営浅草線>都営浅草線</h2><p>宿泊したホテルの近くにある三田駅から五反田まで都営浅草線で乗り換えなしで通勤できることに気付いた。山手線でも行けるが。芝公園は運動にもよいスポットなので五反田の京王プレッソイン以外にスーパーホテルに泊まるプランも織り交ぜてよさそうに思える。</p><h2 id=qa-テストのテスト設計>QA テストのテスト設計</h2><p>次のマイルストーンから QA テストが始まる。その前に今回の開発した成果物を踏まえてテストケースなどを整備し直さないといけない。さらに機能が増えてシステムが複雑化したことでテストのカテゴライズなども見直したいと考えていた。そういった一連のテスト設計を再構築しようと考えている。一般的なやり方としてテストケースをスプレッドシートでまとめる手法がある。それ自体は悪くないし、デフォルトのやり方だとは思うが、もっとよいやり方はないかと模索している。試しにオライリーのサブスクリプションでみつけた <a href=https://www.oreilly.com/library/view/full-stack-testing/9781098108120/>Full Stack Testing</a> の、関心のあるところだけ斜め読みした。</p><p>これまでは手動テストと自動テストの２つのカテゴリ程度でしか分類されていなかったテストに関するコンテキストを、著者は10個のスキルに分割して体系化し、これらをまとめて <em>full stack testing</em> と呼んでいる。適切な名前をつけられることから著者のテストに関する知識や経験の深さが伺える。</p><figure><img src=/diary/img/2024/0607_book1.jpg></figure><p>いくつか斜め読みした中で私が最も関心をもったところに手動探索テストの章がある。著者は「手動テスト」と「手動探索テスト」はまったく別の概念であると定義している。前者はあらかじめ決められたテスト仕様にしたがってテストするだけ。後者はアプリケーションの詳細を掘り下げ、現実的なシナリオを考えて、それらをシミュレートするようにテストしていく。</p><blockquote><p>この開発後の探索的テストを実施するために、別個の担当者を配置する必要はないかもしれない。しかし、そのアプローチの方が、アプリケーションに関する知識が蓄積され、鋭い観察力と分析力を持つ人が必要になるため、より良い結果が得られるかもしれない。コストや稼働率の問題でこれができない場合は、既存のチームメンバーが、各イテレーション期間中、総当り方式で探索的テストを実施する責任を負うべきである。実際、探索的テストのスキルを開発することは、すべての役割のパフォーマンスを向上させるのに役立つかもしれない。</p></blockquote><p>探索テストをやるときはその人の経験に応じて感覚的にあちこち触ってテストをしているように思う。次の図は、その分類を明確にすることでチェックポイントやテストのコツやプラクティスの共有をやりやすくなっていくかもしれないと思えた。</p><figure><img src=/diary/img/2024/0607_book2.jpg></figure><h2 id=雑談会>雑談会</h2><p>夜はやぎさんとおがわさんと久しぶりに会って雑談してきた。おがわさんとは1年以上会っていなかったと思う。実家が大阪なので帰ってきたら声をかけてくださいとよく伝えているものの、最近は実家に帰っておられないようだ。うちは最低でも年に1回お正月に帰るのが当たり前の家だったから何年も実家に帰っていないという家族の形態もあるんだなという所感。それぞれの家の文化がある。ホットクックで <a href=https://cocoroplus.jp.sharp/kitchen/recipe/hotcook/KN-HW24G/R4078>麻婆なす</a> を作ろうという話題になって、私も作ったことがないことに気付いた。今度うちでも作ってみようと思う。あと、まったく飲んだことのなかった焼酎で <a href=https://tsnet-web.jp/products_sake/>十割そば焼酎粋蕎 (いっきょう)</a> がおいしかった。近所の酒屋でも売っているか探してみよう。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0524/>健康診断前は安静に</a></h1><div class=post-meta><time class=post-date>2024-05-24</time></div><span class=post-tags>#<a href=/diary/tags/founding/>founding</a>&nbsp;
#<a href=/diary/tags/health/>health</a>&nbsp;
#<a href=/diary/tags/svelte/>svelte</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;
#<a href=/diary/tags/event/>event</a>&nbsp;</span><div class=post-content><p>今日の運動は腕立て,スクワットをした。統計を <a href="https://docs.google.com/spreadsheets/d/1bg85QtM-LciUgey8I79uI7vW2PEwsP6TVdeIRVkACBg/edit?usp=sharing">運動の記録</a> にまとめる。明日は健康診断があるのでよい数値を得るために今日は休養して安静にしようと思う。</p><h2 id=オフィス移転祝>オフィス移転祝</h2><p>お手伝い先の会社が6月1日にオフィス移転をする。感覚的に引っ越ししたら胡蝶蘭を玄関に並べてあるイメージがあって、ちょうどよい機会なのでうちも送ってみることにした。</p><ul><li><a href=https://www.kokuyo-marketing.co.jp/column/relocation-renewal/post-162/>オフィスの移転祝いの選び方やマナーを解説｜相場やメッセージの書き方、贈る時の注意点も紹介</a></li></ul><p>この記事によると、次の2つのパターンのときは移転祝いを送らない方がよいらしい。</p><ul><li>事業縮小による移転</li><li>移転祝いを辞退している</li></ul><p>お手伝い先はどちらにも該当しないから送って大丈夫だと思う。初めて胡蝶蘭を購入して送付する手続きをする。適当にオンラインで検索して <a href=https://prrr.jp/>PREMIER GARDEN</a> というサイトから手配をした。取引関係のある法人だと2-5万円ぐらいが相場になるらしい。適当にみて27,000円の白の胡蝶蘭 (3本立て) にした。立て札も法人なら縦書きがよいらしい。胡蝶蘭を送る慣習は花言葉が「幸せが飛んでくる」となっていて、さらに胡蝶蘭には「根付く」という意味があって「幸せが根付く」という意図も込められているらしい。そんなことも知らんかった。機会があってよい学びになった。</p><h2 id=歯科検診>歯科検診</h2><p>17時から歯科検診へ行ってきた。今日はベテランっぽいスタッフの方が担当でとても効率よく巧く歯のお掃除をやってくれた気がする。時間も早かったし、口をあけた状態で作業される不快さもいつもより少なかった気がする。機械を使った作業でも、人間の手際のよさで大きく違うものやなと思った。</p><h2 id=svelte-の情報収集>svelte の情報収集</h2><p>19時から <a href=https://svelte-jp.connpass.com/event/315825/>Svelte Japan Online Meetup #3</a> にオンライン参加した。もう私はほとんどフロントエンドの開発に携わっていないけれど、アーキテクチャや大きな開発の方針などをメンバーに指導していくためには svelte を取り巻くエコシステムの流れを把握しておかないといけない。こういったコミュニティのミートアップはそういった情報収集に役に立つ。前回から都合がつけば参加するようにしている。</p><p>svelte/kit を使っている会社の情報をまとめているという話しを聞いたので骨髄反射で pr を投げておいた。</p><ul><li><a href=https://github.com/svelte-jp/japanese-svelte-companies/pull/2>https://github.com/svelte-jp/japanese-svelte-companies/pull/2</a></li></ul><p>svelte 5 はいま rc になっているそうでもう少しでリリースされそう。うちらは次の開発フェーズで移行することになると思うけれど、大きく機能や構文が変わっているようにみえるのでまたこのタイミングで私も再勉強するのがよさそうに思えた。</p><ul><li><a href=https://svelte.dev/blog/svelte-5-release-candidate>Svelte 5 Release Candidate</a></li><li><a href=https://speakerdeck.com/azukiazusa1/yorisinpuruninaru-svelte-noshi-jie>よりシンプルになる Svelte の世界</a></li></ul></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0425/>よく働きよく動く</a></h1><div class=post-meta><time class=post-date>2024-04-25</time></div><span class=post-tags>#<a href=/diary/tags/ldap/>ldap</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;
#<a href=/diary/tags/health/>health</a>&nbsp;
#<a href=/diary/tags/exercise/>exercise</a>&nbsp;</span><div class=post-content><p>今日の運動は腕立て,スクワット,縄跳び(両足跳),散歩をした。統計を <a href="https://docs.google.com/spreadsheets/d/1bg85QtM-LciUgey8I79uI7vW2PEwsP6TVdeIRVkACBg/edit?usp=sharing">運動の記録</a> にまとめる。</p><h2 id=ou-エントリーの更新対応>ou エントリーの更新対応</h2><p>ここ2週間ほどずっと、お仕事のある機能開発で <a href=/diary/posts/2024/0422/>テンパった開発状況</a> でやってきたものがようやく終わった。私は自社の経営だったり、プロジェクトのマネージャーだったりで、普通の開発メンバーのような集中した開発を時間的にできないものの、それでも私が1つの機能に2週間もかける開発はそうそうない。想定以上にこの対応のために、扱う LDAP エントリーのデータ定義や既存システムの実装変更を余儀なくされた。逆に言えば、既存の実装にそういった考慮が当初の設計に足りなかったと言える。この改修において ID 連携におけるノウハウをメンバーと共有したとも言える。</p><p>運用視点からは出来て当然の、しかし、開発視点からは厄介な仕様変更の開発を完了できた。いまの時点では完璧に作ったので将来的な拡張も含めて、さまざまな要件に対応できる設計になったと思う。自画自賛だが、時間をかけた分のよいものができたと思う。</p><h2 id=みなとのもりの運動>みなとのもりの運動</h2><p>今週の前半は雨降りだったり、雨が断続的に降ったりやんだりでお出掛けできなかった。お仕事も一区切りついた開放感と久しぶりによい天気だったのもあって <a href=https://kobe-machiguide.com/park/minatonomori-park/>みなとのもり公園</a> へ行って縄跳びしてきた。運動できない日々が続いて体力を回復していたせいか、15分間のワークアウトで過去最高の 1113 回となった。前回よりも大きく回数が増えたので、もしかしたら100ほど計測ミスがあるのかもしれない。いまの目標としては15分間で最低800回跳ぶことを想定している。跳んでいるうちにカラダが慣れてきて、ミスしなくなったり、フロー状態に入って速く巧く跳べて回数が増えたりする。</p><p>縄跳びの前後にストレッチをできるよう、大きめのレジャーシートも買った。100円ショップなどで売っているレジャーシートに比べたら少し厚手になる。折り畳んで持ち運びできるのがいいなと思って購入した。公園へ持っていくのに便利。1人なら完全に寝転がって広々とストレッチできる。よいと思う。</p><figure><img src=/diary/img/2024/0425_sheet.jpg></figure><p><a href=https://amzn.to/49Ur0YS target=_blank><img src=https://m.media-amazon.com/images/I/71jz9VPb9TL._AC_SX679_.jpg width=240></a></p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0422/>テンパった開発状況</a></h1><div class=post-meta><time class=post-date>2024-04-22</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;
#<a href=/diary/tags/github/>github</a>&nbsp;
#<a href=/diary/tags/ci/cd/>ci/cd</a>&nbsp;</span><div class=post-content><p>今日の運動は腹筋ローラー,スクワットをした。統計を <a href="https://docs.google.com/spreadsheets/d/1bg85QtM-LciUgey8I79uI7vW2PEwsP6TVdeIRVkACBg/edit?usp=sharing">運動の記録</a> にまとめる。</p><h2 id=開発がなかなか進まない>開発がなかなか進まない</h2><p>本当は次の開発課題に着手しないといけないところだが、先週からずっと新機能のための、既存コードのリファクタリングに時間を費やしている。データ構造を変えたり、主キーを変えたりしているので影響範囲が大きくて、テストコードもあちこち修正しないといけなくて時間がかかる。結合テストの実行そのものにも時間がかかるし。</p><p>なかなか開発がテンパっているものの、今日でようやく一通りのリファクタリングを完了して、意図していた新機能のための web api が動くところまで確認できた。なんというか、新機能を作るために既存コードの改善に8割の時間を費やした感じ。おかげで新機能はなにも開発していないのに勝手に動いた (違) ような気持ちになった。今後、同様に個別データの拡張や新たなデータ追加のときは既存データに影響を与えず、独立して追加しやすい設計となっている。将来的に私がいなくなった後に拡張するときにこの設計は役に立つだろうと思う。</p><h2 id=awesome-go-へ道>awesome-go へ道</h2><p><a href=/diary/posts/2024/0421/#kyotogo-の資料づくり>昨日の続き</a> 。contribution guidelines を読んでいて最低限やれと書いてあることの1つに <a href=https://goreportcard.com/report/github.com/kazamori/orderedmap>Go Report Card report</a> を作れと書いてあった。これは静的解析したスコアのようなものが表示される。すべて100%が表示されるようにした。</p><p>カバレッジも測れとあったので github actions の <a href=https://github.com/kazamori/orderedmap/blob/main/.github/workflows/go.yml>workflow ファイル</a> を設定して計測してみた。63.9 % といまいちだった。コアなところしかテスト書いてないからかな。ユーティリティや cli のテストもちゃんと書いたら 80-90% ぐらいはいくのかな？また後日、時間のあるときにやってみる。余談だけど、久しぶりに github actions を触ったらもうワークフローファイルの文法とか覚えてなくてずっと触ってないとすぐ忘れるとか思ったりもした。</p><blockquote><p>if the library/program is testable, then coverage should be >= 80% for non-data-related packages and >=90% for data-related packages. (Note: the tests will be reviewed too. We will check your coverage manually if your package&rsquo;s coverage is just a benchmark result);</p><p><a href=https://github.com/avelino/awesome-go/blob/main/CONTRIBUTING.md#quality-standards>Quality standards</a></p></blockquote></div></article><div class=pagination><div class=pagination__buttons><a href=/diary/tags/design/page/2/ class="button next"><span class=button__text>過去の日記</span>
<span class=button__icon>→</span></a></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2024 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>