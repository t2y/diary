<!doctype html><html lang=en><head><title>virtualization :: forest nook</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/tags/virtualization/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="virtualization"><meta property="og:description" content><meta property="og:url" content="/diary/tags/virtualization/"><meta property="og:site_name" content="forest nook"><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/tags/virtualization/index.xml rel=alternate type=application/rss+xml title="forest nook"></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><div class=posts><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0412/>ローカルのゲスト os に開発環境を作る</a></h1><div class=post-meta><time class=post-date>2023-04-12 (Wed.) ::</time></div><span class=post-tags>#<a href=/diary/tags/virtualization/>virtualization</a>&nbsp;
#<a href=/diary/tags/cli/>cli</a>&nbsp;</span><div class=post-content><p>0時に寝て7時に起きた。いろいろうまくいってない。</p><h2 id=vagrant-再び>vagrant 再び</h2><p>rpm でパッケージングされた openldap サーバーの動作検証をするために vagrant で <a href=https://app.vagrantup.com/rockylinux/boxes/8>rockylinux/8 Vagrant box</a> の環境を構築する。 rockylinux 8 だと次のようなエラーが発生した。</p><pre tabindex=0><code>VBoxManage: error: Failed to open OVF file &#39;path/to/.vagrant.d/boxes/rockylinux-VAGRANTSLASH-8/7.0.0/virtualbox/box.ovf&#39; (VERR_FILE_NOT_FOUND)
</code></pre><p>既知のバグとして次の forum にワークアラウンドが書かれている。</p><ul><li><a href=https://forums.rockylinux.org/t/vagrant-box-rockylinux-8-fails-for-virtualbox-provider-with-error-vbox-e-object-not-found/8228/4>Vagrant box rockylinux/8 fails for virtualbox provider with error VBOX_E_OBJECT_NOT_FOUND</a></li></ul><p>uefi なマシンのせいなのかな？詳細を理解していないけど Vagrantfile を次のようにする。</p><pre tabindex=0><code>Vagrant.configure(&#34;2&#34;) do |config|
  config.vm.box = &#34;rockylinux/8&#34;
  config.vm.provider &#34;virtualbox&#34; do |domain|
    domain.customize [&#34;modifyvm&#34;, :id, &#34;--firmware&#34;, &#34;efi&#34;]
  end
end
</code></pre><p>修正済みのイメージをダウンロードするようにメタデータを作成する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ vi box-metadata.json
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;name&#34;</span> : <span style=color:#e6db74>&#34;rockylinux/8&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;description&#34;</span> : <span style=color:#e6db74>&#34;Rocky Linux 8 7.0.0 Bugfix&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;versions&#34;</span> : [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;version&#34;</span> : <span style=color:#e6db74>&#34;7.0.1-20221213.0&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;providers&#34;</span> : [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;name&#34;</span> : <span style=color:#e6db74>&#34;virtualbox&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;url&#34;</span> : <span style=color:#e6db74>&#34;http://dl.rockylinux.org/pub/rocky/8/images/x86_64/Rocky-8-Vagrant-Vbox-8.7-20221213.0.x86_64.box&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      ]
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>再度 vagrant の環境を作り直す。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ vagrant box add box-metadata.json
</span></span><span style=display:flex><span>$ rm -rf .vagrant/  <span style=color:#75715e># 古い設定を削除</span>
</span></span><span style=display:flex><span>$ vagrant up
</span></span></code></pre></div><p>vagrant を使うのも4年ぶりになるかな。コンテナに慣れてしまうと久しぶり感がある。使い方を忘れていて調べながらやってた。</p><h3 id=vagrant-にポートフォワーディングの設定を追加>vagrant にポートフォワーディングの設定を追加</h3><pre tabindex=0><code>$ vi Vagrantfile
...
  config.vm.network &#34;forwarded_port&#34;, guest: 389, host: 1389   # ldap
  config.vm.network &#34;forwarded_port&#34;, guest: 636, host: 1636   # ldaps
...
</code></pre><p>これでホスト os からゲスト os へ接続できる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>==&gt; default: Forwarding ports...
</span></span><span style=display:flex><span>    default: 389 (guest) =&gt; 1389 (host) (adapter 1)
</span></span><span style=display:flex><span>    default: 636 (guest) =&gt; 1636 (host) (adapter 1)
</span></span><span style=display:flex><span>    default: 22 (guest) =&gt; 2222 (host) (adapter 1)
</span></span></code></pre></div><p>ここでは ldap サーバーに対して <a href=https://directory.apache.org/studio/>Apache Directory Studio</a> で接続できるように ssh のポートフォワーディングを設定している。</p><h3 id=scp-でファイルを転送>scp でファイルを転送</h3><p>config を出力する。ssh の秘密鍵へのパス設定をしてくれるので scp のオプションに指定しなくて済む。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ vagrant ssh-config &gt; ssh.config
</span></span></code></pre></div><p>ポート番号も config に記載されているけれど、それは指定しないと scp できなかった。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ scp -P <span style=color:#ae81ff>2200</span> -F ssh.config path/to/myfile vagrant@localhost:
</span></span></code></pre></div><p>vagrant ユーザーのパスワードも聞かれて vagrant を指定すればコピーできた。config を作ってもあまり便利ではなかった。</p><p><a href=https://github.com/invernizzi/vagrant-scp>vagrant-scp</a> というプラグインがあるのでインストールしてみる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ vagrant plugin install vagrant-scp
</span></span></code></pre></div><p>次のようにして使う。この方が簡単。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ vagrant scp path/to/myfile ./  <span style=color:#75715e># 仮想マシンのホームディレクトリにコピーされる</span>
</span></span></code></pre></div></div></article><div class=pagination><div class=pagination__buttons></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>© 2021 Tetsuya Morimoto</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>