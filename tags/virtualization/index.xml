<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Virtualization on</title><link>/diary/tags/virtualization/</link><description>Recent content in Virtualization on</description><generator>Hugo -- gohugo.io</generator><language>en</language><lastBuildDate>Fri, 26 Jan 2024 08:53:11 +0900</lastBuildDate><atom:icon>/diary/favicon.ico</atom:icon><icon>/diary/favicon.ico</icon><atom:link href="/diary/tags/virtualization/index.xml" rel="self" type="application/rss+xml"/><item><title>仮想化と観光案内</title><link>/diary/posts/2024/0126/</link><pubDate>Fri, 26 Jan 2024 08:53:11 +0900</pubDate><guid>/diary/posts/2024/0126/</guid><description>1時過ぎに寝て4時に起きて、その後の記憶はないが気付いたら6時半になっていて7時に起きた。
今日の筋トレは腕立て:15x1,スクワット:20x1,背筋:10x1をした。夜に3-4kmほど歩いた。
テスト環境の再構築 テスト環境の見直し を進めている。今日はこれまで project specific gitlab runner として使っていた物理マシンを、gitlab runner の機能は別マシンへ移行したので、その物理マシンをテスト環境の仮想マシンを管理するホスト OS にしようといろいろ作業していた。
rhel が開発している cockpit というツールが本当に使いやすい。rhel はエンタープライズ向けなので、あまり一般の開発者が rhel が提供するツールを意識する機会は少ないかもしれない。いろいろ便利なツールを出しているのだけど、会社の色が付いているのを oss な開発者が嫌うのか、マーケティング不足なのか、よくわからないけど、私がまったく知らないツールをお手伝い先で教えてもらって驚くことがある。その1つがこの cockpit というシステム管理ツール。サイトにはシステム管理用の gui ツールとある。うちらは仮想マシンを管理するために使ったりしている。virtualbox のような使い勝手とほとんど同じような容量で仮想マシンを作成したり、管理したりできる。virt-manager (libvirt) の api 経由で低レイヤーは kvm, zen, qemu がサポートされているらしい。デフォルトは kvm なのかな？なにで動いているのだろう？
神戸ルミナリエ散策 (2回目) たまたま出張でよしださんが関西へ来られた。せっかくの機会なのでルミナリエをみていきなよと案内してきた。わたなべさんも参加してくれて3人でわいわいやりながら楽しくできた。
東遊園地の横に神戸市役所があり展望スペースがある。ルミナリエの時期は閉鎖しているんじゃないかと勝手に思っていたら、普通に空いていて10分ほど並べば24Fの展望スペースに上がることができた。実は初めて展望スペースへ上がってきた。ルミナリエが展望できるならさぞ人気があってもっと並ぶんじゃないかと思ったんだけど、登ってみてみたらそれほど夜景の見晴らしがよいわけではなかった。付近に高いビルがちらほらあって真下の東遊園地のルミナリエはよくみえたが、メリケンパークのルミナリエはそれほどきれいにはみえなかった。想像よりも展望スペースの人気がない理由がわかった。
その後、晩ご飯を食べにいって、初めてのお店へ行ってみた。まぁ悪くはなかったんだけど、知人からよいお店と紹介を受けていたほどではなく、それほど特別でもなく、何も知らずに行ったらよいお店だなと普通に思ったのかもしれないけれど「よいお店ですよ」とお勧めされて期待値を上げていった分だけ普通に思えてしまった。マーケティングと期待値の関係は難しい。私が誰かを案内するときはあまり期待値をあげないよう、気を遣って控えめに表現することが多い。20時過ぎから始めて22時で解散した。お互いの近況などを話して楽しかった。</description><content>&lt;p>1時過ぎに寝て4時に起きて、その後の記憶はないが気付いたら6時半になっていて7時に起きた。&lt;/p>
&lt;p>今日の筋トレは腕立て:15x1,スクワット:20x1,背筋:10x1をした。夜に3-4kmほど歩いた。&lt;/p>
&lt;h2 id="テスト環境の再構築">テスト環境の再構築&lt;/h2>
&lt;p>&lt;a href="/diary/diary/posts/2024/0116/#テスト環境の見直し">テスト環境の見直し&lt;/a> を進めている。今日はこれまで project specific gitlab runner として使っていた物理マシンを、gitlab runner の機能は別マシンへ移行したので、その物理マシンをテスト環境の仮想マシンを管理するホスト OS にしようといろいろ作業していた。&lt;/p>
&lt;p>rhel が開発している &lt;a href="https://cockpit-project.org/">cockpit&lt;/a> というツールが本当に使いやすい。rhel はエンタープライズ向けなので、あまり一般の開発者が rhel が提供するツールを意識する機会は少ないかもしれない。いろいろ便利なツールを出しているのだけど、会社の色が付いているのを oss な開発者が嫌うのか、マーケティング不足なのか、よくわからないけど、私がまったく知らないツールをお手伝い先で教えてもらって驚くことがある。その1つがこの cockpit というシステム管理ツール。サイトにはシステム管理用の gui ツールとある。うちらは仮想マシンを管理するために使ったりしている。virtualbox のような使い勝手とほとんど同じような容量で仮想マシンを作成したり、管理したりできる。virt-manager (libvirt) の api 経由で低レイヤーは kvm, zen, qemu がサポートされているらしい。デフォルトは kvm なのかな？なにで動いているのだろう？&lt;/p>
&lt;h2 id="神戸ルミナリエ散策-2回目">神戸ルミナリエ散策 (2回目)&lt;/h2>
&lt;p>たまたま出張でよしださんが関西へ来られた。せっかくの機会なのでルミナリエをみていきなよと案内してきた。わたなべさんも参加してくれて3人でわいわいやりながら楽しくできた。&lt;/p>
&lt;figure>&lt;img src="/diary/diary/img/2024/0126_luminarie.jpg"/>
&lt;/figure>
&lt;p>東遊園地の横に神戸市役所があり展望スペースがある。ルミナリエの時期は閉鎖しているんじゃないかと勝手に思っていたら、普通に空いていて10分ほど並べば24Fの展望スペースに上がることができた。実は初めて展望スペースへ上がってきた。ルミナリエが展望できるならさぞ人気があってもっと並ぶんじゃないかと思ったんだけど、登ってみてみたらそれほど夜景の見晴らしがよいわけではなかった。付近に高いビルがちらほらあって真下の東遊園地のルミナリエはよくみえたが、メリケンパークのルミナリエはそれほどきれいにはみえなかった。想像よりも展望スペースの人気がない理由がわかった。&lt;/p>
&lt;figure>&lt;img src="/diary/diary/img/2024/0126_top-of-luminarie.jpg"/>
&lt;/figure>
&lt;p>その後、晩ご飯を食べにいって、初めてのお店へ行ってみた。まぁ悪くはなかったんだけど、知人からよいお店と紹介を受けていたほどではなく、それほど特別でもなく、何も知らずに行ったらよいお店だなと普通に思ったのかもしれないけれど「よいお店ですよ」とお勧めされて期待値を上げていった分だけ普通に思えてしまった。マーケティングと期待値の関係は難しい。私が誰かを案内するときはあまり期待値をあげないよう、気を遣って控えめに表現することが多い。20時過ぎから始めて22時で解散した。お互いの近況などを話して楽しかった。&lt;/p></content></item><item><title>継続の習慣</title><link>/diary/posts/2024/0122/</link><pubDate>Mon, 22 Jan 2024 08:30:33 +0900</pubDate><guid>/diary/posts/2024/0122/</guid><description>1時に寝て4時に起きて2時間ほどだらだらして7時半に起きた。
今日の筋トレは腹筋:15x1,腕立て:15x1,スクワット20x1をした。
雑多な作業 virtualbox に windows server 2022 のインストールと Active Directory ドメインサービスの構築 する方法のドキュメントを書き終えた。年度が変わったら新卒のメンバーがチームに入る可能性もあるし、滅多にやらない作業だし、windows のことを私はよく知らないので整理しておくとよい気がした。その後、メンバーのツール開発やインフラ作業のアドバイスややり取りなどをしていたら時間が経ってしまった。
テックブログを読む会 年を明けて初めての テックブログ一気読み選手権20240122杯 に参加した。次の記事を読んで他の参加者に共有した。
心理的安全性の高い職場はどのように作られているか？ 2023年も開発合宿を開催しました この30分イベントのためにテックブログを読むことを強制されるのがよい。この日記を始めたことで「書くこと」と最近は「筋トレ」も継続できるようになった。短い時間の継続を目的とした仕組みをもっとうまく取り入れて他にも応用していきたいと思う。</description><content>&lt;p>1時に寝て4時に起きて2時間ほどだらだらして7時半に起きた。&lt;/p>
&lt;p>今日の筋トレは腹筋:15x1,腕立て:15x1,スクワット20x1をした。&lt;/p>
&lt;h2 id="雑多な作業">雑多な作業&lt;/h2>
&lt;p>&lt;a href="/diary/diary/posts/2024/0118/#windows-server-2022-試用版のインストール">virtualbox に windows server 2022 のインストールと Active Directory ドメインサービスの構築&lt;/a> する方法のドキュメントを書き終えた。年度が変わったら新卒のメンバーがチームに入る可能性もあるし、滅多にやらない作業だし、windows のことを私はよく知らないので整理しておくとよい気がした。その後、メンバーのツール開発やインフラ作業のアドバイスややり取りなどをしていたら時間が経ってしまった。&lt;/p>
&lt;h2 id="テックブログを読む会">テックブログを読む会&lt;/h2>
&lt;p>年を明けて初めての &lt;a href="https://blogreading.connpass.com/event/308426/">テックブログ一気読み選手権20240122杯&lt;/a> に参加した。次の記事を読んで他の参加者に共有した。&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://techtouch.hatenablog.jp/entry/psychological_safety_in_workplace">心理的安全性の高い職場はどのように作られているか？&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://developers.freee.co.jp/entry/developers-camp-2023">2023年も開発合宿を開催しました&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>この30分イベントのためにテックブログを読むことを強制されるのがよい。この日記を始めたことで「書くこと」と最近は「筋トレ」も継続できるようになった。短い時間の継続を目的とした仕組みをもっとうまく取り入れて他にも応用していきたいと思う。&lt;/p></content></item><item><title>ローカルに window server をインストールした</title><link>/diary/posts/2024/0118/</link><pubDate>Thu, 18 Jan 2024 09:28:57 +0900</pubDate><guid>/diary/posts/2024/0118/</guid><description>1時過ぎに寝て6時半に起きた。久しぶりによく眠れた。6時半に起きてたのに8時ぐらいまでだらだらしてた。
今日の筋トレは腹筋:20x1,腕立て:15x1,スクワット20x1をした。
windows server 2022 試用版のインストール Windows Server 2022 の試用版が提供されていると知ったのでローカルの VirtualBox 環境にインストールしてみた。Active Directory の検証に使うのでディレクトサービスや ldaps 接続のための証明書サービスなどを設定する。メンバーがインストールして課題管理システムにメモを残してくれてあったのでそれを見ながらインストールや設定自体はすぐにできた。1つだけうまく接続できないことがあった。
ホスト os から ldapsearch で ldaps で接続しようとすると次のようなエラーになる。
$ ldapsearch -x -H &amp;#34;ldaps://192.168.56.101&amp;#34; -W -b &amp;#34;CN=Users,DC=myad,DC=com&amp;#34; -D &amp;#34;CN=Administrator,CN=Users,DC=myad,DC=com&amp;#34; ldap_sasl_bind(SIMPLE): Can&amp;#39;t contact LDAP server (-1) ldap では接続できるので tls の検証のチェックに失敗していることは自明だったが、メンバーは接続できているようにみえたので私の環境の設定が誤っているのかどうかを調べていた。2時間ぐらいデバッグしたりしながら調べてもよくわからなくて、たまたまチーム勉強会があったので終わったときにメンバーに聞いてみた。すぐに完結した。ldapsearch は LDAPTLS_REQCERT という環境変数で tls のリクエストの振る舞いを制御できる。次のように明示的に指定すると接続できる。
$ LDAPTLS_REQCERT=never ldapsearch -x -H &amp;#34;ldaps://192.168.56.101&amp;#34; ... この設定はいくつかの方法で設定ファイルに書いておくこともできる。メンバーが使っている環境には ldap.conf でこの設定を有効にしていたので ldaps 接続できていたというオチだった。私が openldap について明るくないのでこういった背景知識をもっていなくてはまっていただけだった。
Thus the following files and variables are read, in order: variable $LDAPNOINIT, and if that is not set: system file /etc/openldap/ldap.</description><content>&lt;p>1時過ぎに寝て6時半に起きた。久しぶりによく眠れた。6時半に起きてたのに8時ぐらいまでだらだらしてた。&lt;/p>
&lt;p>今日の筋トレは腹筋:20x1,腕立て:15x1,スクワット20x1をした。&lt;/p>
&lt;h2 id="windows-server-2022-試用版のインストール">windows server 2022 試用版のインストール&lt;/h2>
&lt;p>&lt;a href="https://www.microsoft.com/ja-jp/evalcenter/evaluate-windows-server-2022">Windows Server 2022&lt;/a> の試用版が提供されていると知ったのでローカルの &lt;a href="https://www.virtualbox.org/">VirtualBox&lt;/a> 環境にインストールしてみた。Active Directory の検証に使うのでディレクトサービスや ldaps 接続のための証明書サービスなどを設定する。メンバーがインストールして課題管理システムにメモを残してくれてあったのでそれを見ながらインストールや設定自体はすぐにできた。1つだけうまく接続できないことがあった。&lt;/p>
&lt;p>ホスト os から ldapsearch で ldaps で接続しようとすると次のようなエラーになる。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>$ ldapsearch -x -H &lt;span style="color:#e6db74">&amp;#34;ldaps://192.168.56.101&amp;#34;&lt;/span> -W -b &lt;span style="color:#e6db74">&amp;#34;CN=Users,DC=myad,DC=com&amp;#34;&lt;/span> -D &lt;span style="color:#e6db74">&amp;#34;CN=Administrator,CN=Users,DC=myad,DC=com&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>ldap_sasl_bind&lt;span style="color:#f92672">(&lt;/span>SIMPLE&lt;span style="color:#f92672">)&lt;/span>: Can&lt;span style="color:#960050;background-color:#1e0010">&amp;#39;&lt;/span>t contact LDAP server &lt;span style="color:#f92672">(&lt;/span>-1&lt;span style="color:#f92672">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ldap では接続できるので tls の検証のチェックに失敗していることは自明だったが、メンバーは接続できているようにみえたので私の環境の設定が誤っているのかどうかを調べていた。2時間ぐらいデバッグしたりしながら調べてもよくわからなくて、たまたまチーム勉強会があったので終わったときにメンバーに聞いてみた。すぐに完結した。ldapsearch は &lt;code>LDAPTLS_REQCERT&lt;/code> という環境変数で tls のリクエストの振る舞いを制御できる。次のように明示的に指定すると接続できる。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>$ LDAPTLS_REQCERT&lt;span style="color:#f92672">=&lt;/span>never ldapsearch -x -H &lt;span style="color:#e6db74">&amp;#34;ldaps://192.168.56.101&amp;#34;&lt;/span> ...
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>この設定はいくつかの方法で設定ファイルに書いておくこともできる。メンバーが使っている環境には &lt;code>ldap.conf&lt;/code> でこの設定を有効にしていたので ldaps 接続できていたというオチだった。私が openldap について明るくないのでこういった背景知識をもっていなくてはまっていただけだった。&lt;/p>
&lt;pre tabindex="0">&lt;code>Thus the following files and variables are read, in order:
variable $LDAPNOINIT, and if that is not set:
system file /etc/openldap/ldap.conf,
user files $HOME/ldaprc, $HOME/.ldaprc, ./ldaprc,
system file $LDAPCONF,
user files $HOME/$LDAPRC, $HOME/.$LDAPRC, ./$LDAPRC,
variables $LDAP&amp;lt;uppercase option name&amp;gt;.
Settings late in the list override earlier ones.
&lt;/code>&lt;/pre>&lt;h2 id="明石海峡大橋海上ウォーク">明石海峡大橋海上ウォーク&lt;/h2>
&lt;p>神戸ジャーナルの記事をみかけて、そういうイベントがあるのは知っていた。&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://kaijo-uzushio-walk.jp/">神戸淡路鳴門自動車道 2橋ウォーク同時開催！ 明石海峡大橋海上ウォーク/大鳴門橋うずしおウォーク 令和6年3月9日(土)・10日(日)&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>開発合宿の翌週だし、わざわざ行くほどでもないかとスルーしていたものの、関東から知人がわざわざ歩きに来るという話しを聞いて、せっかくの機会なので私も参加することにした。土曜日の午前中に明石海峡大橋を歩いてくる。まだ申込みが始まったばかりなので希望の時間帯を選択できると思う。&lt;/p></content></item><item><title>メリハリの付け直し</title><link>/diary/posts/2023/0613/</link><pubDate>Tue, 13 Jun 2023 04:21:59 +0900</pubDate><guid>/diary/posts/2023/0613/</guid><description>23時ぐらいまで作業して、1時から2時ぐらいまで仮眠した。いつも通り普通に寝ないで始発の新幹線に乗って寝てた。寝ていて体があちこち痛くて、月に1回ではあるけどこの生活を続けるのもよくないかもなと思い始めた。
新しい定例会議の初日 6月から新しい開発がスタートして 新しい定例会議の進め方 に変更した。ふりかえりと情報共有の定例を1時間に詰め込むので時間が足りないかも？と時間を意識しながら進めた。その甲斐もあってか、ちょうどぴったり1時間におさまった。これも一種のパーキンソンの法則のようなものが働いているのかもしれない。
仕事は、完成までに利用可能な時間を使い果たすように拡大していく
パーキンソンの法則
メンバーが2人なので機能開発が2つずつ並行に進む。1つは開発が完了し、もう1つも大半は完了している。完了できなかったことは残念だが、私からみても着実にステップアップしているのでそれほど問題視していない。ドッグフードテスト の導入も完了こそしなかったが、これも社内インフラの都合や管理者の工数を調整してもらったりするので着実に進捗しているのであれば、それほど厳密にスケジュール管理しなくてよいのかもしれない。
イテレーション開発のルール的には優先度を付けた issue はそのイテレーション内でやり切るという目標をもつように促している。但し、まだ開発の序盤であるので現時点ではそれほど重要ではない。これも1つのメリハリだとみなすこともできる。また様々な状況の変化や調整をしながら期限を意識して働くのは一定のスキルと自律的な行動を取れる開発者に限られる。
なんのために働くかの答えを見い出せていない若い人にそれを求めるのもまた違うなと思えて、この状況を作り出しているのは、働く目的そのものを導くようなリーダーシップを取れていない私自身の責任だと実感した。つまり私が自身の規律を緩めているのがメンバーに伝わって、結果的にスケジュールを守ろうとする最後の底力を支えられていないと思えた。開発の仕切り直しに私自身も切り替えていかないといけない。
厄介なインフラの問題 x 2 ちょうどインフラに関する、特定の状況においてパフォーマンスが劇的に劣化したり、意図しない振る舞いをしたりする事象を2つ確認している。これこそ私が面倒をみる issue だなと思って着手した。m2 macbook はこういったインフラの再現環境を作るのに向いていない。2022年に virtualbox 7.0 で m1/m2 に対応したという changelog があるけど、少し前にインストールしようとするとエラーになって動かなくて諦めた。
macOS host: Providing a Developer Preview package for systems with an Apple silicon CPU. This is unsupported work in progress, and is known to have very modest performance.
Changelog for VirtualBox 7.0
アプリケーションのコンテナイメージも、現時点では amd64 向けにしか提供していないため、どのみちコンテナでの検証が必要になったら m2 macbook では動作させられない。そういう厄介な issue を抱えた。帰ったらオフィスのデスクトップマシンで再現環境を作るところから始める。</description><content>&lt;p>23時ぐらいまで作業して、1時から2時ぐらいまで仮眠した。いつも通り普通に寝ないで始発の新幹線に乗って寝てた。寝ていて体があちこち痛くて、月に1回ではあるけどこの生活を続けるのもよくないかもなと思い始めた。&lt;/p>
&lt;h2 id="新しい定例会議の初日">新しい定例会議の初日&lt;/h2>
&lt;p>6月から新しい開発がスタートして &lt;a href="/diary/diary/posts/2023/0607/">新しい定例会議の進め方&lt;/a> に変更した。ふりかえりと情報共有の定例を1時間に詰め込むので時間が足りないかも？と時間を意識しながら進めた。その甲斐もあってか、ちょうどぴったり1時間におさまった。これも一種のパーキンソンの法則のようなものが働いているのかもしれない。&lt;/p>
&lt;blockquote>
&lt;p>仕事は、完成までに利用可能な時間を使い果たすように拡大していく&lt;/p>
&lt;p>&lt;a href="https://asana.com/ja/resources/parkinsons-law">パーキンソンの法則&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>メンバーが2人なので機能開発が2つずつ並行に進む。1つは開発が完了し、もう1つも大半は完了している。完了できなかったことは残念だが、私からみても着実にステップアップしているのでそれほど問題視していない。&lt;a href="/diary/diary/posts/2023/0526/#ドッグフードテストと運用談義">ドッグフードテスト&lt;/a> の導入も完了こそしなかったが、これも社内インフラの都合や管理者の工数を調整してもらったりするので着実に進捗しているのであれば、それほど厳密にスケジュール管理しなくてよいのかもしれない。&lt;/p>
&lt;p>イテレーション開発のルール的には優先度を付けた issue はそのイテレーション内でやり切るという目標をもつように促している。但し、まだ開発の序盤であるので現時点ではそれほど重要ではない。これも1つのメリハリだとみなすこともできる。また様々な状況の変化や調整をしながら期限を意識して働くのは一定のスキルと自律的な行動を取れる開発者に限られる。&lt;/p>
&lt;p>なんのために働くかの答えを見い出せていない若い人にそれを求めるのもまた違うなと思えて、この状況を作り出しているのは、働く目的そのものを導くようなリーダーシップを取れていない私自身の責任だと実感した。つまり私が自身の規律を緩めているのがメンバーに伝わって、結果的にスケジュールを守ろうとする最後の底力を支えられていないと思えた。開発の仕切り直しに私自身も切り替えていかないといけない。&lt;/p>
&lt;h2 id="厄介なインフラの問題-x-2">厄介なインフラの問題 x 2&lt;/h2>
&lt;p>ちょうどインフラに関する、特定の状況においてパフォーマンスが劇的に劣化したり、意図しない振る舞いをしたりする事象を2つ確認している。これこそ私が面倒をみる issue だなと思って着手した。m2 macbook はこういったインフラの再現環境を作るのに向いていない。2022年に virtualbox 7.0 で m1/m2 に対応したという changelog があるけど、少し前にインストールしようとするとエラーになって動かなくて諦めた。&lt;/p>
&lt;blockquote>
&lt;p>macOS host: Providing a Developer Preview package for systems with an Apple silicon CPU. This is unsupported work in progress, and is known to have very modest performance.&lt;/p>
&lt;p>&lt;a href="https://www.virtualbox.org/wiki/Changelog-7.0">Changelog for VirtualBox 7.0&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>アプリケーションのコンテナイメージも、現時点では amd64 向けにしか提供していないため、どのみちコンテナでの検証が必要になったら m2 macbook では動作させられない。そういう厄介な issue を抱えた。帰ったらオフィスのデスクトップマシンで再現環境を作るところから始める。&lt;/p></content></item><item><title>ローカルのゲスト os に開発環境を作る</title><link>/diary/posts/2023/0412/</link><pubDate>Wed, 12 Apr 2023 09:30:05 +0900</pubDate><guid>/diary/posts/2023/0412/</guid><description>0時に寝て7時に起きた。いろいろうまくいってない。
vagrant 再び rpm でパッケージングされた openldap サーバーの動作検証をするために vagrant で rockylinux/8 Vagrant box の環境を構築する。 rockylinux 8 だと次のようなエラーが発生した。
VBoxManage: error: Failed to open OVF file &amp;#39;path/to/.vagrant.d/boxes/rockylinux-VAGRANTSLASH-8/7.0.0/virtualbox/box.ovf&amp;#39; (VERR_FILE_NOT_FOUND) 既知のバグとして次の forum にワークアラウンドが書かれている。
Vagrant box rockylinux/8 fails for virtualbox provider with error VBOX_E_OBJECT_NOT_FOUND uefi なマシンのせいなのかな？詳細を理解していないけど Vagrantfile を次のようにする。
Vagrant.configure(&amp;#34;2&amp;#34;) do |config| config.vm.box = &amp;#34;rockylinux/8&amp;#34; config.vm.provider &amp;#34;virtualbox&amp;#34; do |domain| domain.customize [&amp;#34;modifyvm&amp;#34;, :id, &amp;#34;--firmware&amp;#34;, &amp;#34;efi&amp;#34;] end end 修正済みのイメージをダウンロードするようにメタデータを作成する。
$ vi box-metadata.json { &amp;#34;name&amp;#34; : &amp;#34;rockylinux/8&amp;#34;, &amp;#34;description&amp;#34; : &amp;#34;Rocky Linux 8 7.</description><content>&lt;p>0時に寝て7時に起きた。いろいろうまくいってない。&lt;/p>
&lt;h2 id="vagrant-再び">vagrant 再び&lt;/h2>
&lt;p>rpm でパッケージングされた openldap サーバーの動作検証をするために vagrant で &lt;a href="https://app.vagrantup.com/rockylinux/boxes/8">rockylinux/8 Vagrant box&lt;/a> の環境を構築する。 rockylinux 8 だと次のようなエラーが発生した。&lt;/p>
&lt;pre tabindex="0">&lt;code>VBoxManage: error: Failed to open OVF file &amp;#39;path/to/.vagrant.d/boxes/rockylinux-VAGRANTSLASH-8/7.0.0/virtualbox/box.ovf&amp;#39; (VERR_FILE_NOT_FOUND)
&lt;/code>&lt;/pre>&lt;p>既知のバグとして次の forum にワークアラウンドが書かれている。&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://forums.rockylinux.org/t/vagrant-box-rockylinux-8-fails-for-virtualbox-provider-with-error-vbox-e-object-not-found/8228/4">Vagrant box rockylinux/8 fails for virtualbox provider with error VBOX_E_OBJECT_NOT_FOUND&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>uefi なマシンのせいなのかな？詳細を理解していないけど Vagrantfile を次のようにする。&lt;/p>
&lt;pre tabindex="0">&lt;code>Vagrant.configure(&amp;#34;2&amp;#34;) do |config|
config.vm.box = &amp;#34;rockylinux/8&amp;#34;
config.vm.provider &amp;#34;virtualbox&amp;#34; do |domain|
domain.customize [&amp;#34;modifyvm&amp;#34;, :id, &amp;#34;--firmware&amp;#34;, &amp;#34;efi&amp;#34;]
end
end
&lt;/code>&lt;/pre>&lt;p>修正済みのイメージをダウンロードするようにメタデータを作成する。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>$ vi box-metadata.json
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-json" data-lang="json">&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;name&amp;#34;&lt;/span> : &lt;span style="color:#e6db74">&amp;#34;rockylinux/8&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;description&amp;#34;&lt;/span> : &lt;span style="color:#e6db74">&amp;#34;Rocky Linux 8 7.0.0 Bugfix&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;versions&amp;#34;&lt;/span> : [
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;version&amp;#34;&lt;/span> : &lt;span style="color:#e6db74">&amp;#34;7.0.1-20221213.0&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;providers&amp;#34;&lt;/span> : [
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;name&amp;#34;&lt;/span> : &lt;span style="color:#e6db74">&amp;#34;virtualbox&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;url&amp;#34;&lt;/span> : &lt;span style="color:#e6db74">&amp;#34;http://dl.rockylinux.org/pub/rocky/8/images/x86_64/Rocky-8-Vagrant-Vbox-8.7-20221213.0.x86_64.box&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>再度 vagrant の環境を作り直す。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>$ vagrant box add box-metadata.json
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ rm -rf .vagrant/ &lt;span style="color:#75715e"># 古い設定を削除&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ vagrant up
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>vagrant を使うのも4年ぶりになるかな。コンテナに慣れてしまうと久しぶり感がある。使い方を忘れていて調べながらやってた。&lt;/p>
&lt;h3 id="vagrant-にポートフォワーディングの設定を追加">vagrant にポートフォワーディングの設定を追加&lt;/h3>
&lt;pre tabindex="0">&lt;code>$ vi Vagrantfile
...
config.vm.network &amp;#34;forwarded_port&amp;#34;, guest: 389, host: 1389 # ldap
config.vm.network &amp;#34;forwarded_port&amp;#34;, guest: 636, host: 1636 # ldaps
...
&lt;/code>&lt;/pre>&lt;p>これでホスト os からゲスト os へ接続できる。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-console" data-lang="console">&lt;span style="display:flex;">&lt;span>==&amp;gt; default: Forwarding ports...
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> default: 389 (guest) =&amp;gt; 1389 (host) (adapter 1)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> default: 636 (guest) =&amp;gt; 1636 (host) (adapter 1)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> default: 22 (guest) =&amp;gt; 2222 (host) (adapter 1)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ここでは ldap サーバーに対して &lt;a href="https://directory.apache.org/studio/">Apache Directory Studio&lt;/a> で接続できるように ssh のポートフォワーディングを設定している。&lt;/p>
&lt;h3 id="scp-でファイルを転送">scp でファイルを転送&lt;/h3>
&lt;p>config を出力する。ssh の秘密鍵へのパス設定をしてくれるので scp のオプションに指定しなくて済む。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>$ vagrant ssh-config &amp;gt; ssh.config
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ポート番号も config に記載されているけれど、それは指定しないと scp できなかった。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>$ scp -P &lt;span style="color:#ae81ff">2200&lt;/span> -F ssh.config path/to/myfile vagrant@localhost:
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>vagrant ユーザーのパスワードも聞かれて vagrant を指定すればコピーできた。config を作ってもあまり便利ではなかった。&lt;/p>
&lt;p>&lt;a href="https://github.com/invernizzi/vagrant-scp">vagrant-scp&lt;/a> というプラグインがあるのでインストールしてみる。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>$ vagrant plugin install vagrant-scp
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>次のようにして使う。この方が簡単。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>$ vagrant scp path/to/myfile ./ &lt;span style="color:#75715e"># 仮想マシンのホームディレクトリにコピーされる&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></content></item></channel></rss>