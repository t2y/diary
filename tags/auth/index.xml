<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>auth on forest nook</title><link>/diary/tags/auth/</link><description>Recent content in auth on forest nook</description><generator>Hugo -- gohugo.io</generator><language>ja-jp</language><copyright>© 2021 Tetsuya Morimoto</copyright><lastBuildDate>Tue, 29 Mar 2022 07:19:00 +0900</lastBuildDate><atom:icon>/diary/favicon.ico</atom:icon><icon>/diary/favicon.ico</icon><atom:link href="/diary/tags/auth/index.xml" rel="self" type="application/rss+xml"/><item><title>backlog の認可の仕組み</title><link>/diary/posts/2022/0329/</link><pubDate>Tue, 29 Mar 2022 07:19:00 +0900</pubDate><guid>/diary/posts/2022/0329/</guid><description>0時に寝て6時に起きた。
backlog の oauth 2.0 の仕組み ユーザー単位の API キーの他、oauth 2.0 の認可の仕組みもある。OAuth Grant Types は Authorization Code と Refresh Token の2つをサポートしている。
https://developer.nulab.com/ja/docs/backlog/auth/ https://backlog.com/developer/applications/ 手順はざっくりこんな感じ。
開発者向けのサイトからアプリケーションを作成して認可コードのリクエストを送る。
https://YOUR-SPACE.backlog.com/OAuth2AccessRequest.action?response_type=code&amp;amp;client_id=xxx&amp;amp;redirect_uri=http://localhost:18080/callback リダイレクト先に query='code=zzz' な認可コードが届く。それを使ってアクセストークンを取得する。
{&amp;#39;access_token&amp;#39;: &amp;#39;xxx&amp;#39;, &amp;#39;expires_in&amp;#39;: 3599, &amp;#39;refresh_token&amp;#39;: &amp;#39;xxx&amp;#39;, &amp;#39;token_type&amp;#39;: &amp;#39;Bearer&amp;#39;} 有効期限が1時間のアクセストークンを取得できる。次のようにして認証をパスできる。
$ curl -s -H &amp;#34;Authorization: Bearer xxx&amp;#34; &amp;#39;https://YOUR-SPACE.backlog.com/api/v2/space&amp;#39; 基本的にはユーザー単位の認証しかなくてアプリケーションアカウントの運用はできないみたい。backlog の課金プランをみると、基本的にはユーザー無制限っぽいのでアプリケーションアカウントを一般ユーザーで作成すれば、運用上問題にならないからアプリケーションアカウントを設けていないのではないかと思う。お手伝い先の管理者にインテグレーション向けの専用ユーザーを作成して API キーを github の secrets に登録してほしいという依頼を出した。</description><content>&lt;p>0時に寝て6時に起きた。&lt;/p>
&lt;h2 id="backlog-の-oauth-20-の仕組み">backlog の oauth 2.0 の仕組み&lt;/h2>
&lt;p>ユーザー単位の API キーの他、oauth 2.0 の認可の仕組みもある。&lt;a href="https://oauth.net/2/grant-types/">OAuth Grant Types&lt;/a> は Authorization Code と Refresh Token の2つをサポートしている。&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://developer.nulab.com/ja/docs/backlog/auth/">https://developer.nulab.com/ja/docs/backlog/auth/&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://backlog.com/developer/applications/">https://backlog.com/developer/applications/&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>手順はざっくりこんな感じ。&lt;/p>
&lt;p>開発者向けのサイトからアプリケーションを作成して認可コードのリクエストを送る。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">https://YOUR-SPACE.backlog.com/OAuth2AccessRequest.action?response_type&lt;span style="color:#f92672">=&lt;/span>code&amp;amp;client_id&lt;span style="color:#f92672">=&lt;/span>xxx&amp;amp;redirect_uri&lt;span style="color:#f92672">=&lt;/span>http://localhost:18080/callback
&lt;/code>&lt;/pre>&lt;/div>&lt;p>リダイレクト先に &lt;code>query='code=zzz'&lt;/code> な認可コードが届く。それを使ってアクセストークンを取得する。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-json" data-lang="json">{&lt;span style="color:#960050;background-color:#1e0010">&amp;#39;access_token&amp;#39;:&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">&amp;#39;xxx&amp;#39;,&lt;/span>
&lt;span style="color:#960050;background-color:#1e0010">&amp;#39;expires_in&amp;#39;:&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">3599,&lt;/span>
&lt;span style="color:#960050;background-color:#1e0010">&amp;#39;refresh_token&amp;#39;:&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">&amp;#39;xxx&amp;#39;,&lt;/span>
&lt;span style="color:#960050;background-color:#1e0010">&amp;#39;token_type&amp;#39;:&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">&amp;#39;Bearer&amp;#39;&lt;/span>}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>有効期限が1時間のアクセストークンを取得できる。次のようにして認証をパスできる。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ curl -s -H &lt;span style="color:#e6db74">&amp;#34;Authorization: Bearer xxx&amp;#34;&lt;/span> &lt;span style="color:#e6db74">&amp;#39;https://YOUR-SPACE.backlog.com/api/v2/space&amp;#39;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>基本的にはユーザー単位の認証しかなくてアプリケーションアカウントの運用はできないみたい。backlog の課金プランをみると、基本的にはユーザー無制限っぽいのでアプリケーションアカウントを一般ユーザーで作成すれば、運用上問題にならないからアプリケーションアカウントを設けていないのではないかと思う。お手伝い先の管理者にインテグレーション向けの専用ユーザーを作成して API キーを github の secrets に登録してほしいという依頼を出した。&lt;/p></content></item><item><title>github apps を調べた</title><link>/diary/posts/2022/0301/</link><pubDate>Tue, 01 Mar 2022 07:56:36 +0900</pubDate><guid>/diary/posts/2022/0301/</guid><description>23時に寝て5時半に起きた。何度か夜中にも起きた。起きてからドラクエタクトやってた。
oauth apps と github apps いまお仕事で ci/cd の改善をやっていて、その一環としてリポジトリをまたがったパイプライン処理を検討している。 ci/cd で使うような認可の仕組みとして github には oauth apps と github apps の2種類がある。
Building OAuth Apps Building GitHub Apps 私はどちらも全く関わったことがなかったので、仕組みがイメージできる oauth apps を使えばよいのだろうと調べ始めた。しかし、一通り調べてみて会社の開発における ci/cd に使うなら github apps の方が適していることがわかった。両者がどう違うのかもドキュメントに記載されている。最初にこのドキュメントを読めば oauth apps を調査する必要はなかった。
Differences between GitHub Apps and OAuth Apps 具体的には、oauth apps は user の権限を認可する仕組みで、github apps は organization の権限を認可する仕組みと言える。github apps も oauth によるユーザー認証もできる上にアプリ自身の認証もできる。さらにアクセスできるリポジトリも制限できることから github actions などで、特定のリポジトリに対してのみアクセス可能なトークンを取得するには github apps の方が向くというわけだ。oauth でユーザーが認可するときに scope を指定するが、その scope を organization が設定できるといったところが github apps と oauth との違いにみえる。取得できる token の有効期限にもその考え方の違いが出ている。</description><content>&lt;p>23時に寝て5時半に起きた。何度か夜中にも起きた。起きてからドラクエタクトやってた。&lt;/p>
&lt;h2 id="oauth-apps-と-github-apps">oauth apps と github apps&lt;/h2>
&lt;p>いまお仕事で ci/cd の改善をやっていて、その一環としてリポジトリをまたがったパイプライン処理を検討している。
ci/cd で使うような認可の仕組みとして github には oauth apps と github apps の2種類がある。&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://docs.github.com/en/developers/apps/building-oauth-apps">Building OAuth Apps&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://docs.github.com/en/developers/apps/building-github-apps">Building GitHub Apps&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>私はどちらも全く関わったことがなかったので、仕組みがイメージできる oauth apps を使えばよいのだろうと調べ始めた。しかし、一通り調べてみて会社の開発における ci/cd に使うなら github apps の方が適していることがわかった。両者がどう違うのかもドキュメントに記載されている。最初にこのドキュメントを読めば oauth apps を調査する必要はなかった。&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://docs.github.com/en/developers/apps/getting-started-with-apps/differences-between-github-apps-and-oauth-apps">Differences between GitHub Apps and OAuth Apps&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>具体的には、oauth apps は user の権限を認可する仕組みで、github apps は organization の権限を認可する仕組みと言える。github apps も oauth によるユーザー認証もできる上にアプリ自身の認証もできる。さらにアクセスできるリポジトリも制限できることから github actions などで、特定のリポジトリに対してのみアクセス可能なトークンを取得するには github apps の方が向くというわけだ。oauth でユーザーが認可するときに scope を指定するが、その scope を organization が設定できるといったところが github apps と oauth との違いにみえる。取得できる token の有効期限にもその考え方の違いが出ている。&lt;/p>
&lt;ul>
&lt;li>oauth apps
&lt;ul>
&lt;li>ユーザー/デバイス認証
&lt;ul>
&lt;li>認可コード: 15分&lt;/li>
&lt;li>アクセストークン: 無期限&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>github apps
&lt;ul>
&lt;li>installation 認証
&lt;ul>
&lt;li>認可jwt: 10分&lt;/li>
&lt;li>installation トークン: 1時間&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>ユーザー/デバイス認証
&lt;ul>
&lt;li>認可コード: 15分&lt;/li>
&lt;li>アクセストークン: 8時間&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul></content></item></channel></rss>