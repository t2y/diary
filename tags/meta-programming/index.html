<!doctype html><html lang=en><head><title>Meta Programming :: </title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/tags/meta-programming/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="Meta Programming"><meta property="og:description" content><meta property="og:url" content="/diary/tags/meta-programming/"><meta property="og:site_name" content><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/tags/meta-programming/index.xml rel=alternate type=application/rss+xml title></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><h1>Posts for: #Meta Programming</h1><div class=posts><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0904/>openldap スキーマと parser generator</a></h1><div class=post-meta><time class=post-date>2024-09-04</time></div><span class=post-tags>#<a href=/diary/tags/ldap/>ldap</a>&nbsp;
#<a href=/diary/tags/programming/>programming</a>&nbsp;
#<a href=/diary/tags/meta-programming/>meta programming</a>&nbsp;</span><div class=post-content><p>この開発フェーズではあまり機能拡張を行わない方針としているが、できればやっておいた方がよい機能拡張の1つに openldap サーバーから ldap スキーマを取得する処理がある。ちょうどいま若いメンバーに実装してもらっている大きな機能のバリデーションにも ldap スキーマの情報があると便利そうなので私が対応することに決めた。</p><p>openldap サーバーで管理している ldap スキーマの定義は openldap サーバーの <a href=https://www.openldap.org/doc/admin26/schema.html>Schema Specification</a> と <a href=https://www.openldap.org/doc/admin25/schema.html>rfc 4512</a> の2つをみると仕様がわかる。たとえば、次のように AttributeTypeDescription というスキーマの定義は <a href=https://en.wikipedia.org/wiki/Augmented_Backus%E2%80%93Naur_form>Augmented Backus–Naur form (abnf)</a> という記法で定義されている。rfc などのネットワークプロトコルの世界では abnf のフォーマットで仕様を説明することが多いらしい。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-abnf data-lang=abnf><span style=display:flex><span><span style=color:#a6e22e>AttributeTypeDescription</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>&#34;(&#34;</span> <span style=color:#a6e22e>whsp</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>numericoid</span> <span style=color:#a6e22e>whsp</span>              <span style=color:#75715e>; AttributeType identifier</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;NAME&#34;</span> <span style=color:#a6e22e>qdescrs</span> ]             <span style=color:#75715e>; name used in AttributeType</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;DESC&#34;</span> <span style=color:#a6e22e>qdstring</span> ]            <span style=color:#75715e>; description</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;OBSOLETE&#34;</span> <span style=color:#a6e22e>whsp</span> ]
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;SUP&#34;</span> <span style=color:#a6e22e>woid</span> ]                 <span style=color:#75715e>; derived from this other</span>
</span></span><span style=display:flex><span>                                   <span style=color:#75715e>; AttributeType</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;EQUALITY&#34;</span> <span style=color:#a6e22e>woid</span>              <span style=color:#75715e>; Matching Rule name</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;ORDERING&#34;</span> <span style=color:#a6e22e>woid</span>              <span style=color:#75715e>; Matching Rule name</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;SUBSTR&#34;</span> <span style=color:#a6e22e>woid</span> ]              <span style=color:#75715e>; Matching Rule name</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;SYNTAX&#34;</span> <span style=color:#a6e22e>whsp</span> <span style=color:#a6e22e>noidlen</span> <span style=color:#a6e22e>whsp</span> ] <span style=color:#75715e>; Syntax OID</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;SINGLE-VALUE&#34;</span> <span style=color:#a6e22e>whsp</span> ]        <span style=color:#75715e>; default multi-valued</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;COLLECTIVE&#34;</span> <span style=color:#a6e22e>whsp</span> ]          <span style=color:#75715e>; default not collective</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;NO-USER-MODIFICATION&#34;</span> <span style=color:#a6e22e>whsp</span> ]<span style=color:#75715e>; default user modifiable</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;USAGE&#34;</span> <span style=color:#a6e22e>whsp</span> <span style=color:#a6e22e>AttributeUsage</span> ]<span style=color:#75715e>; default userApplications</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>whsp</span> <span style=color:#ae81ff>&#34;)&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>AttributeUsage</span> <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>&#34;userApplications&#34;</span>     <span style=color:#f92672>/</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>&#34;directoryOperation&#34;</span>   <span style=color:#f92672>/</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>&#34;distributedOperation&#34;</span> <span style=color:#f92672>/</span> <span style=color:#75715e>; DSA-shared</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>&#34;dSAOperation&#34;</span>          <span style=color:#75715e>; DSA-specific, value depends on server</span>
</span></span></code></pre></div><p>openldap サーバーに対して ldap スキーマを取得する方法は <a href=https://www.openldap.org/faq/data/cache/1366.html>How can I fetch schema information from the server?</a> の faq に書いてある。search base に対してサブスキーマサブエントリを返す dn を取得する。openldap サーバーの場合 ldap の root ツリーに対応するのは <code>cn=Subschema</code> がデフォルトとなる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ldapsearch -H ldap://localhost -x -LLL -b dc<span style=color:#f92672>=</span>example,dc<span style=color:#f92672>=</span>com -s base subschemaSubentry
</span></span><span style=display:flex><span>dn: dc<span style=color:#f92672>=</span>example,dc<span style=color:#f92672>=</span>com
</span></span><span style=display:flex><span>subschemaSubentry: cn<span style=color:#f92672>=</span>Subschema
</span></span></code></pre></div><p>この dn にスキーマ情報の属性が格納されているのでそれらを取得する。このスキーマ情報は operational attributes として管理されているので <code>+</code> という記号が operational attributes 属性群をまとめて取得するキーワードになっている。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ldapsearch -x -LLL -b cn<span style=color:#f92672>=</span>Subschema -s base <span style=color:#e6db74>&#39;(objectClass=subschema)&#39;</span> +
</span></span></code></pre></div><p>これでスキーマ情報を取得できる。先に書いた AttributeTypeDescription の実際のスキーマ情報は次のような内容になる。こういったスキーマのテキスト情報をたくさん取得できる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-abnf data-lang=abnf><span style=display:flex><span>( <span style=color:#f92672>2</span>.<span style=color:#f92672>5</span>.<span style=color:#f92672>4</span>.<span style=color:#f92672>0</span> <span style=color:#a6e22e>NAME</span> &#39;<span style=color:#a6e22e>objectClass</span>&#39; <span style=color:#a6e22e>DESC</span> &#39;<span style=color:#a6e22e>RFC4512</span>: <span style=color:#a6e22e>object</span> <span style=color:#a6e22e>classes</span> <span style=color:#a6e22e>of</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>entity</span>&#39; <span style=color:#a6e22e>EQUALITY</span> <span style=color:#a6e22e>objectIdentifierMatch</span> <span style=color:#a6e22e>SYNTAX</span> <span style=color:#f92672>1</span>.<span style=color:#f92672>3</span>.<span style=color:#f92672>6</span>.<span style=color:#f92672>1</span>.<span style=color:#f92672>4</span>.<span style=color:#f92672>1</span>.<span style=color:#f92672>1466</span>.<span style=color:#f92672>115</span>.<span style=color:#f92672>121</span>.<span style=color:#f92672>1</span>.<span style=color:#f92672>38</span> )
</span></span></code></pre></div><h2 id=go-の-parser-generator-調査>go の parser generator 調査</h2><p>この手のものは abnf から parser をコード生成するのが一般的なやり方かな？と、まずは go で使えそうな parser generator について調べてみた。意外と go 製の parser generator はみつからなかった。私が発見できたのは次の3つぐらい。</p><ul><li><a href=https://pkg.go.dev/golang.org/x/tools/cmd/goyacc>golang.org/x/tools/cmd/goyacc</a></li><li><a href=https://github.com/goccmack/gocc>goccmack/gocc</a></li><li><a href=https://github.com/antlr4-go/antlr>antlr4-go/antlr</a></li></ul><p>最後の antlr は java 製のツールだけれども、go のソースコードを出力できるので go 実装の parser をコード生成できるという意図で対象としている。goyacc は abnf の文法を yacc に変換しないといけない。<a href=https://github.com/yinyin/go-ldap-schema-parser/blob/master/parser.y>yacc で実装した ldap スキーマの parser</a> を公開しているのもみかけたが、yacc は違うなと思って除外した。antlr も abnf から専用の文法に変換しないといけないから不採用にした。</p><p>それで消去法的に bnf (ebnf) を扱える gocc で parser をコード生成できないかを調査してみた。しかし、半日ほど bnf を書いて実際にコード生成してみて不採用とした。ebnf の options 記法として <code>[...]</code> に gocc が対応していないようにみえた。この記法がないと ldap スキーマの文法定義が煩雑になる。<a href=https://github.com/goccmack/gocc/issues/21#issuecomment-216398402>issue のコメント</a> をみると、lexer は対応したが、parser は対応していないといったコメントがある。コード生成しようとするとエラーになるので未対応なのかもしれない。bnf でこの options 記法相当のものを自分で文法定義すると、1つ2つなら簡単に変換できるが、数個の組み合わせがあると途端に文法の複雑さが大きくなるように思える。abnf から bnf に変換する過程で文法が複雑になってしまうとその後の保守ができなくなる懸念が生じるので断念した。</p><p>今回の gocc の採用は却下したが、軽く触ってみて gocc 自体の感触はよかった。シンプルな bnf で表現できるものであれば機会があれば採用してもよいと思える。<a href=https://github.com/goccmack/gocc/tree/master/example>gocc example</a> をみればわかるが、bnf を書きながら単体テストのコードを実行して動作検証を小さく簡潔にできる。これは parser のコード生成の開発サイクルは速くできそうに感じた。こういう小さく単体で動くツールは好み。</p><p>最終的な結論としては parser generator は使わず、自前で parser を実装することを決めた。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0627/>scim 調査に着手</a></h1><div class=post-meta><time class=post-date>2023-06-27</time></div><span class=post-tags>#<a href=/diary/tags/remote-work/>remote work</a>&nbsp;
#<a href=/diary/tags/scim/>scim</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;
#<a href=/diary/tags/meta-programming/>meta programming</a>&nbsp;</span><div class=post-content><p>22時に寝て24時に起きて4時に起きて6時に起きた。実家だとやることないので寝るのも早くなる。早く起きているので始業も7時半ぐらいになる。早起きは三文の徳。</p><h2 id=リモートワークのタグを新設>リモートワークのタグを新設</h2><p>神戸のオフィスに行かなかった日は <a href=/diary/tags/day-off/>day off</a> というタグを付けている。名前の通り、お休みしたということを表す。この定義に従うと、実家に帰ってリモートワークをしたときもお休みになってしまうため、それを区別するように <a href=/diary/tags/remote-work/>remote work</a> というタグを作った。</p><h2 id=scim-調査>scim 調査</h2><p>id 連携の文脈で <a href=https://en.wikipedia.org/wiki/System_for_Cross-domain_Identity_Management>System for Cross-domain Identity Management</a>
(頭文字をとって SCIM、すきーむと呼ばれている) という標準がある。基本的には rest api とスキーマを扱うように仕様が決められていて、それに準拠したサービス間で id 連携を標準化する狙いがある。id 連携と同じ用途を表す用語として id プロビジョニングという用語もあるが、多くのクラウドサービスでは id プロビジョニングのために scim 対応していたりする。</p><p>たまたまサイボウズさんが okta と scim 連携に対応しているプレスリリースをみかけた。</p><ul><li><a href=https://www.okta.com/jp/press-room/press-releases/okta-cybozu-scim/>サイボウズの「cybozu.com」がプロビジョニング自動化実現のため、「Okta Integration Network」とのSCIM連携に対応</a></li></ul><p>その延長で調査していたところ、go の scim ツールを提供していることに気付いた。しかもこれを作っているのが <a href=https://lestrrat.github.io/>Maki</a> さん。これはソースを読んでおこうと思った次第。Maki さんはメルカリに所属していたと思うのでこれは副業でやっているのかな？</p><ul><li><a href=https://github.com/cybozu-go/scim>github.com/cybozu-go/scim</a></li><li><a href=https://github.com/cybozu-go/scim-server>github.com/cybozu-go/scim-server</a></li></ul><p>scim-server は scim ライブラリを実際に使うときの参照実装としてアプリケーションの開発者に開発の雰囲気を伝えるための実装になっている。これ自体をプロダクトのサーバーとして使うわけではない。sqlite を使ってユーザー／グループの crud な操作と検索機能を提供している。</p><p>scim ライブラリのソースコードも軽くざっと読んでみた。<a href=https://github.com/lestrrat-go/sketch>github.com/lestrrat-go/sketch</a> という go でスキーマを記述してコード生成する Maki さん製のツールがある。これを起点に scim のプロトコルやリソースの仕様にしたがって go のコードでスキーマを定義し、リソースに関する go のコードと scim スキーマを自動生成している。sketch というツールに関連して他にも Maki 製のメタプログラミングライブラリを多用していて、scim の標準化されている部分のエンドポイントやリソースのインターフェース部分をすべてコード生成している。</p><p>go generate やコード生成の実際の応用例として非常に参考になる。このライブラリは scim のプロトコル仕様に関する開発者と、そのエンドポイントの実際の処理 (バックエンド) の開発者を明確に分離するという開発体制を期待している。scim に関するところは Maki さんが独りでコード生成を多用してオープンなプロトコル仕様の開発を担当し、そのバックエンドをサイボウズさんの開発者が実装するという分業体制を想定しているようにみえる。</p><p>scim 対応のアプリケーション開発のプロトコル部分を外部に委譲するといった設計になっているが、scim が十分に安定していてプロトコルの仕様が変わらないのであれば理に適っているとも考えられる。バックエンドの開発者はいくらか sketch の学習コストを強いることになる。そのため、アプリケーションはその学習コストを支払ってもコード生成のメリットが上回るだけの規模や特性を要求する。おそらく scim はそれだけの価値があると判断されたのだと推測する。</p><p>私はメタプログラミングが好きな方なのでこういうやり方もあるんだなと設計の参考になった。またコード生成の要件があったときにソースを参考にしようと思う。</p></div></article><div class=pagination><div class=pagination__buttons></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2024 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>