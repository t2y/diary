<!doctype html><html lang=en><head><title>static analysis :: forest nook</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/tags/static-analysis/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="static analysis"><meta property="og:description" content><meta property="og:url" content="/diary/tags/static-analysis/"><meta property="og:site_name" content="forest nook"><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/tags/static-analysis/index.xml rel=alternate type=application/rss+xml title="forest nook"></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><h1>Posts for: #static analysis</h1><div class=posts><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0204/>go の学び直し 静的解析編</a></h1><div class=post-meta><time class=post-date>2023-02-04</time></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/static-analysis/>static analysis</a>&nbsp;
#<a href=/diary/tags/event/>event</a>&nbsp;</span><div class=post-content><p>23時に寝て2時に起きて5時ぐらいにも起きて7時に起きた。昨日は podcast 収録でたくさん話して疲れてしまってそのまま帰ってすぐ寝た。すぐ起きるんだけど。</p><h2 id=ストレッチ>ストレッチ</h2><p>今日の開脚幅は開始前157cmで、ストレッチ後159cmだった。朝出かける前に開脚のストレッチしたら数値よくなるかな？と思ってやってみたらいつもより少しよくなった。ストレッチはいつも通りとも言えるし、腰の張りがまだまだ残っていることも確認できた。疲労が溜まっているんよな。毎週ストレッチしているからこの程度の疲労で済んでいるとも思える。お正月に実家から戻ってきてから1月の東京出張と35日は終えた。来週はまた2月の東京出張とその週末に49日がある。ここまで体力がもてばその次の法要は初盆なので少し空く。体力的に第4四半期の山場と言えるかもしれない。ただがんばる。</p><h2 id=go-の学び直し>go の学び直し</h2><p><a href=https://tenntenn.connpass.com/event/271533/>Gopher塾 #3 - 静的解析を使ったGoの開発ツール制作 入門編 - DAY 1</a> に参加した。</p><p>過去にも <a href=https://t2y.hatenablog.jp/entry/2015/03/11/025123>Python とマクロ、インポートフックと抽象構文木</a> や <a href=https://kazamori.jp/blogs/2020/07/12/java-annotation-processor/>Java のアノテーションプロセッサを試す</a> など、メタプログラミングのアプローチやコード生成などを実務で使ってきたので静的解析にも関心がある。講義内容の詳細は書かないけど、静的解析のような難しい話題に対して4時間という短い時間でとてもよい講義になっていたと思う。go の静的解析の要点や提供されているツールなどを一通り学ぶことができた。もちろん、実用するには試行錯誤や習熟を必要とするけど、取っ掛かりとして十分な内容に思えた。</p><p><a href=https://github.com/gostaticanalysis/skeleton>skeleton</a> というツールを使って静的解析のための analyzer プロジェクトのひな形を作る。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ go install github.com/gostaticanalysis/skeleton/v2@latest
</span></span><span style=display:flex><span>$ skeleton myanalyzer
</span></span><span style=display:flex><span>$ tree myanalyzer
</span></span><span style=display:flex><span>myanalyzer
</span></span><span style=display:flex><span>├── cmd
</span></span><span style=display:flex><span>│   └── myanalyzer
</span></span><span style=display:flex><span>│       └── main.go
</span></span><span style=display:flex><span>├── go.mod
</span></span><span style=display:flex><span>├── myanalyzer.go
</span></span><span style=display:flex><span>├── myanalyzer_test.go
</span></span><span style=display:flex><span>└── testdata
</span></span><span style=display:flex><span>    └── src
</span></span><span style=display:flex><span>        └── a
</span></span><span style=display:flex><span>            ├── a.go
</span></span><span style=display:flex><span>            └── go.mod
</span></span></code></pre></div><p>意図的にテストが落ちるようになっていてすぐ動作確認できる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ go mod tidy
</span></span><span style=display:flex><span>$ go test                                          
</span></span><span style=display:flex><span>--- FAIL: TestAnalyzer <span style=color:#f92672>(</span>0.05s<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    analysistest.go:448: a/a.go:5:6: diagnostic <span style=color:#e6db74>&#34;identifier is gopher&#34;</span> does not match pattern <span style=color:#e6db74>&#34;pattern&#34;</span>
</span></span><span style=display:flex><span>    analysistest.go:512: a/a.go:5: no diagnostic was reported matching <span style=color:#e6db74>&#34;pattern&#34;</span>
</span></span><span style=display:flex><span>FAIL
</span></span><span style=display:flex><span>exit status <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>FAIL	myanalyzer	0.349s
</span></span></code></pre></div><p>いろいろ説明を端折るけど、試しに FuncDecl の ast ノードに対して関数の行数をカウントする処理を実装してみた。<a href=https://pkg.go.dev/golang.org/x/tools/go/analysis#hdr-Pass>analysis パッケージの Pass</a> を使うと便利なユーティリティが提供されていて、静的解析をするときに面倒な処理をショートカットできて簡単に実装できることが理解できた。ここで作った analyzer は go vet で実行できるそうなのでプロジェクトの独自ルールを analyzer で実装して ci でチェックするといった運用もできる。応用範囲は広そう。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>case</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ast</span>.<span style=color:#a6e22e>FuncDecl</span>:
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>Name</span>, <span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>Pos</span>(), <span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>End</span>())
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>start</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>pass</span>.<span style=color:#a6e22e>Fset</span>.<span style=color:#a6e22e>Position</span>(<span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>Pos</span>()).<span style=color:#a6e22e>Line</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>end</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>pass</span>.<span style=color:#a6e22e>Fset</span>.<span style=color:#a6e22e>Position</span>(<span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>End</span>()).<span style=color:#a6e22e>Line</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;the number of lines:&#34;</span>, <span style=color:#a6e22e>end</span><span style=color:#f92672>-</span><span style=color:#a6e22e>start</span>)
</span></span></code></pre></div></div></article><div class=pagination><div class=pagination__buttons></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>© 2021 Tetsuya Morimoto</span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>