<!doctype html><html lang=en><head><title>device :: forest nook</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/tags/device/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="device"><meta property="og:description" content><meta property="og:url" content="/diary/tags/device/"><meta property="og:site_name" content="forest nook"><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/tags/device/index.xml rel=alternate type=application/rss+xml title="forest nook"></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><div class=posts><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0618/>クラウド経由で tapo を制御する方法がわからない</a></h1><div class=post-meta><time class=post-date>2023-06-18 (Sun.) ::</time></div><span class=post-tags>#<a href=/diary/tags/smartplug/>smartplug</a>&nbsp;
#<a href=/diary/tags/device/>device</a>&nbsp;</span><div class=post-content><p>0時に寝て7時に起きて8時過ぎまでだらだらしてた。オフィスのエアコンの効き具合がよくなくて昼間暑くてやる気にならなかった。</p><h2 id=tp-link-cloud-api-で-tapo-の制御を調べる>tp-link cloud api で tapo の制御を調べる</h2><p>先日 <a href=/diary/posts/2023/0612/>ifttt で tapo p105 の制御</a> を行った。これが動くということはなんらかのクラウドの api 経由で tapo p105 を制御できている。次の記事をみながらやってみようと試してみた。結論から言ってクラウドの api 経由ではできなかった。</p><ul><li><a href=https://zenn.dev/book000/articles/tp-link-cloud-api>TP-Link cloud APIを使ってみる</a></li></ul><p>アクセストークンを取得する。terminalUUID は適当に生成すればよい。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -s -X POST -H <span style=color:#e6db74>&#34;Content-Type: application/json&#34;</span> -d <span style=color:#e6db74>&#39;{&#34;method&#34;: &#34;login&#34;, &#34;params&#34;: {&#34;appType&#34;: &#34;iphone&#34;, &#34;cloudUserName&#34;: &#34;register@kazamori.jp&#34;, &#34;cloudPassword&#34;: &#34;***&#34;, &#34;terminalUUID&#34;: &#34;bf63e1d0-d5dc-4636-abf1-7eeada585935&#34;}}&#39;</span> https://wap.tplinkcloud.com/ | jq .
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;error_code&#34;</span>: 0,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;result&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;accountId&#34;</span>: <span style=color:#e6db74>&#34;142785160&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;regTime&#34;</span>: <span style=color:#e6db74>&#34;2023-06-11 04:59:43&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;countryCode&#34;</span>: <span style=color:#e6db74>&#34;JP&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;riskDetected&#34;</span>: 0,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;email&#34;</span>: <span style=color:#e6db74>&#34;register@kazamori.jp&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;token&#34;</span>: <span style=color:#e6db74>&#34;***-***&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>ここで取得したアクセストークンを使ってデバイスの一覧を取得する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -s -X POST -H <span style=color:#e6db74>&#34;Content-Type: application/json&#34;</span> -d <span style=color:#e6db74>&#39;{&#34;method&#34;: &#34;getDeviceList&#34;}&#39;</span> https://wap.tplinkcloud.com/?token<span style=color:#f92672>=</span>***-*** | jq .
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;error_code&#34;</span>: 0,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;result&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;deviceList&#34;</span>: <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;deviceType&#34;</span>: <span style=color:#e6db74>&#34;SMART.TAPOPLUG&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;role&#34;</span>: 0,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;fwVer&#34;</span>: <span style=color:#e6db74>&#34;1.3.6 Build 20230308 Rel. 52591&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;appServerUrl&#34;</span>: <span style=color:#e6db74>&#34;https://aps1-wap.tplinkcloud.com&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;deviceRegion&#34;</span>: <span style=color:#e6db74>&#34;ap-southeast-1&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;deviceId&#34;</span>: <span style=color:#e6db74>&#34;802241DA5175CF114E567DE8D72A3094210CB12D&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;deviceName&#34;</span>: <span style=color:#e6db74>&#34;P105&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;deviceHwVer&#34;</span>: <span style=color:#e6db74>&#34;1.0.0&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;alias&#34;</span>: <span style=color:#e6db74>&#34;U21hcnQgUGx1ZyAoS2F6YW1vcmkgT2ZmaWNlKQ==&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;deviceMac&#34;</span>: <span style=color:#e6db74>&#34;482254AC1D25&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;oemId&#34;</span>: <span style=color:#e6db74>&#34;495AC9D888EB711C42A28BECF62071CF&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;deviceModel&#34;</span>: <span style=color:#e6db74>&#34;P105&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;hwId&#34;</span>: <span style=color:#e6db74>&#34;58070BD9D8ECC915CD3D6F20A2172712&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;fwId&#34;</span>: <span style=color:#e6db74>&#34;1D18AD293A25ABDE41405B20C6F98816&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;isSameRegion&#34;</span>: true,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;status&#34;</span>: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>ここまでは従来のスマートプラグと同様に動く。ここから先の手順は従来の hs105 と tapo p105 では手順が異なるみたい。<code>passthrough</code> というメソッドを呼び出してみてもエラーが返ってくる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -s -X POST -H <span style=color:#e6db74>&#34;Content-Type: application/json&#34;</span> -d <span style=color:#e6db74>&#39;{&#34;method&#34;:&#34;passthrough&#34;, &#34;params&#34;: {&#34;deviceId&#34;: &#34;802241DA5175CF114E567DE8D72A3094210CB12D&#34;, &#34;requestData&#34;: &#34;{\&#34;system\&#34;:{\&#34;get_sysinfo\&#34;:null},\&#34;emeter\&#34;:{\&#34;get_realtime\&#34;:null}}&#34;}}&#39;</span> https://wap.tplinkcloud.com/?token<span style=color:#f92672>=</span>***-*** | jq .
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;error_code&#34;</span>: -20571,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;Device is offline&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>どうやら tapo シリーズはスマートプラグ自体が web api のエンドポイントを提供していて、ローカルからデバイスの web api を呼び出して制御できるらしい。例えば、次の記事でその手順が書いてあって、同様のやり方で実装した野生のライブラリもたくさんみつかる。</p><ul><li><a href=https://guminote.sakura.ne.jp/archives/911>ESP8266 で Tp-Link のスマートプラグ『Tapo P105』を直接操作する</a></li></ul><p>うちのシェアオフィスのネットワークはローカルの ip アドレスへの通信をすべて拒否しているようなのでこのやり方はうちのオフィスでは検証できない。しかし、tp-link 社のスマホアプリと ifttt の webhook 経由で p105 の制御ができているため、おそらくローカルのエンドポイントに接続する以外の別の手段があるのだと推測する。それをインターネット上で数時間探してみたものの、発見できなかった。この前 interop の展示で聞いた話しだと ifttt は非公開 api を使ってインテグレーションを実装しているという話しだったけど、どうやってクラウド経由で通信しているのだろう？と不思議に思った。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0616/>アイディアのコラボレーション</a></h1><div class=post-meta><time class=post-date>2023-06-16 (Fri.) ::</time></div><span class=post-tags>#<a href=/diary/tags/document/>document</a>&nbsp;
#<a href=/diary/tags/infrastructure/>infrastructure</a>&nbsp;
#<a href=/diary/tags/payment/>payment</a>&nbsp;
#<a href=/diary/tags/smartplug/>smartplug</a>&nbsp;
#<a href=/diary/tags/device/>device</a>&nbsp;</span><div class=post-content><p>2時に寝て何度か起きて7時に起きた。今日は勉強会の登板なのになにも準備できてなくてどうしようとか思いながら寝た。</p><h2 id=パッケージングとリリースのドキュメント>パッケージングとリリースのドキュメント</h2><p>5月の落ち穂拾いの時期にプロジェクトの開発ドキュメントを刷新していろいろな要項を書き残している。最後に残ったまだ書いていないドキュメントに次の2つがある。水曜日から課題管理やコードレビューの隙間時間に書き出していって3日ほどかけて一通り書き終えた。私は文章を書くのが遅いのと、1回ですべての内容を網羅できなくて、書いているうちに思い出して追記したり、寝かした文章をあとで見返して推敲したりすることが多い。そのため、ドキュメントを1週間ぐらいかけて書いたりする。</p><ul><li>パッケージング</li><li>リリース</li></ul><p>たまたまメンバーにあるモジュールをリファクタリングのために再実装してもらっている。その開発を完了したら古いモジュールと入れ替える必要があるので、開発だけではなく、パッケージングやリリース周りの作業を把握してもらう、よい機会と言える。これまでパッケージングやリリース周りのインフラはほとんど私が作って運用をまわしてきたので徐々にそれらを引き継ぐタイミングとも言える。開発者はインフラのことを気にせず、アプリケーションを開発してコミットすれば後はすべて ci/cd が自動的にいろいろやってくれて便利ぐらいの感覚で扱えるようにするのが、外資系などではプラットフォームに投資しろと言われたりするものだと推測する。うちらが開発しているプロダクトはコンテナ、RPM、Windows インストーラーとパッケージングする種類が多い。その要項に加えて QA 責任の考え方などについても書いておいた。主には私がいなくなった後に役に立つドキュメントとなるだろう。</p><h2 id=チーム勉強会>チーム勉強会</h2><p>本当は go の generics の勉強会をやりますと先週宣言していた。しかし、私が遊んでいて全然準備できなかったので代わりに決済とスマートプラグの話しをした。<a href=/diary/posts/2023/0612/>先週末と月曜日</a> に作った決済とスマートプラグを組み合わせたもの。サービスや仕組みを簡単に説明して、実際にデモを動かして電球を灯す。</p><figure><img src=/diary/img/2023/0616_payment-and-smartplug.png></figure><p>参加者からスマートプラグをラズベリーパイに置き換えてパワーリレーというモジュールを使えばもっとスマートにできるんじゃないかという意見が出た。たしかにラズベリーパイなら stripe の決済イベントを受け取るサーバーをデバイス内に同梱させることもできるかもしれない。そうすると、スマートプラグのような電源の on/off だけではなく、ラズベリーパイが扱えるセンサーとインテグレーションすることもできそう。また時間のあるときにやってみたい。コラボレーションって正にこういうことを言うとわかってきた。私が1人でこの仕組みを実装していたときにはラズベリーパイというキーワードはまったく頭の中になかった。他者の視点が加わるから新しいアイディアが広がる。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0612/>ネットワークからスマートプラグの制御</a></h1><div class=post-meta><time class=post-date>2023-06-12 (Mon.) ::</time></div><span class=post-tags>#<a href=/diary/tags/smartplug/>smartplug</a>&nbsp;
#<a href=/diary/tags/device/>device</a>&nbsp;</span><div class=post-content><p>昨日は夕方に親が立ち寄るかもしれないというから待機していたのに空振りに終わった。0時に寝ようとしてあまり眠れなくて7時に起きた。ここ最近寝ているのか寝てないのかよく分からない眠り方になる。</p><h2 id=決済してスマートプラグを-on-にしろ>決済してスマートプラグを ON にしろ</h2><p><a href=/diary/posts/2023/0611/>昨日の続き</a> 。夕方に <a href=https://www.tp-link.com/jp/home-networking/smart-plug/tapo-p105/>Tapo P105</a> が届いたので業務を終えてからさっそく使ってみた。</p><figure><img src=/diary/img/2023/0612_smartplug.jpeg></figure><p>オフィスの wifi に接続して、tp-link 社のスマホアプリからデバイス登録する。スマホアプリからはすぐに on/off できた。スマホで電源の on/off を制御できてあまり嬉しいことはパッと思いつかないけど、プログラムから制御できるならなにか遊べそうな気もしてくる。<a href=https://ifttt.com>ifttt</a> というインテグレーションサービスがあって、それを使うと tp-link 社のデバイスと ifttt 社の web api 経由で制御できる。おそらくなんらかの web api が tp-link 社からも提供されているはず。それが公開されていれば ifttt を使う必要はないし、すでにハックされているものを使うのでもよいかもしれない。ひとまず動かすことを目的とするので ifttt を使う。スマートプラグに電球をつなげて、決済したら電球が灯って3秒後に消えるようなサンプルアプリを作った。一通り最後まで動かすことができておもしろかった。</p><ul><li><a href=https://github.com/kazamori/stripe-webhook-sample>https://github.com/kazamori/stripe-webhook-sample</a></li></ul></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0611/>スマートプラグ制御の調査</a></h1><div class=post-meta><time class=post-date>2023-06-11 (Sun.) ::</time></div><span class=post-tags>#<a href=/diary/tags/smartplug/>smartplug</a>&nbsp;
#<a href=/diary/tags/device/>device</a>&nbsp;
#<a href=/diary/tags/kobe/>kobe</a>&nbsp;
#<a href=/diary/tags/food/>food</a>&nbsp;</span><div class=post-content><p>23時に寝てうまく眠れなくて5時に起きた。そのまま10時ぐらいまでだらだらしてた。</p><h2 id=スマートプラグの通電テスター>スマートプラグの通電テスター</h2><p><a href=/diary/posts/2023/0610/>昨日の続き</a> 。スマートプラグを検索すると TP-Link 社の製品がよく出てくるのでミニスマート wi-fi プラグの <a href=https://www.tp-link.com/jp/home-networking/smart-plug/tapo-p105/>Tapo P105</a> を購入してみた。この製品だとネットワーク経由で電源の on/off ができそう。ifttt というサービスが <a href=https://ifttt.com/tplink_tapo>TP-Link Tapo</a> インテグレーションを公開している。TP-Link 社も自前で <a href=https://www.tplinkcloud.com/>TP-LINK Cloud</a> というサービスを提供していて、どうやらその web api は公開されていないようだけど、おそらくそこで使っている web api を調べてライブラリにしたのが <a href=https://www.npmjs.com/package/tplink-cloud-api>tplink-cloud-api</a> のようにみえる。サイトをみる限りはカメラしかサポートしていないようにもみえる。スマートプラグのようなデバイスがハックしやすい性質のせいか、書いてある情報が曖昧で実際にどうやってデバイスを制御したらよいのかネット上の記事からよくわからない。実際に購入したもので試してみるのが早そう。明日届く予定。</p><p>このスマートプラグによる電源 on/off のテスターに、ダイソーで電球を購入してきた。電源ソケットアダプタが100円、電球は100円、200円、300円とそれぞれあったんだけど、100円の差異でどうせ買うなら精度のよいものをと考えて300円のものを購入した。LED で電力消費も少ない。</p><figure><img src=/diary/img/2023/0611_light.jpeg></figure><p>試しにオフィスにあった amazon 純正スマートプラグ経由で接続して alexa アプリで on/off したら意図したように電球が灯ってテスターの代替にできた。デモのために使うのでそれぐらいわかりやすいのがよい。</p><h2 id=モロゾフ>モロゾフ</h2><p>昨日参加したもくもく会を借りていた <a href=https://www.kobe-bunka.jp/facilities/chuo/>中央区文化センター</a> には2フロアに渡って大小いくつかの会議室がある。それぞれの会議室には張り紙をしていて借り主の名前が外からわかる。たまたま通ったところに「モロゾフ労働組合」と書いてあって、どこかの会社の労組が会議しているんだなと覚えていた。今日になって来週の東京出張のお土産を探していたらモロゾフというお店があることに気付いた。<a href=https://www.morozoff.co.jp/company_ir/history_index.html>モロゾフの歩み</a> によると1931年創業の神戸本店の洋菓子の会社らしい。これもなにかの縁だと思って今回はモロゾフさんの神戸本店へ行って <a href=https://www.morozoff.co.jp/products/baked_sweets/15_3/>ブロードランド 15個入</a> をお土産用に購入した。</p><p>自分用にアーモンドケーキを買って食べてみた。しっとり食感で控え目にアーモンドの風味がして甘過ぎなくて後味のよいケーキでおいしかった。</p><figure><img src=/diary/img/2023/0611_armond-cake.png></figure></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0521/>yubikey bio を完全にマスターした</a></h1><div class=post-meta><time class=post-date>2023-05-21 (Sun.) ::</time></div><span class=post-tags>#<a href=/diary/tags/device/>device</a>&nbsp;
#<a href=/diary/tags/pam/>pam</a>&nbsp;
#<a href=/diary/tags/auth/>auth</a>&nbsp;
#<a href=/diary/tags/security/>security</a>&nbsp;</span><div class=post-content><p>2時に寝て遅くまで飲んでいたせいか、やや吐き気もしながら朝起きてだらだらして11時ぐらいに起きた。</p><h2 id=1password-のロック解除を-yubikey-で行う>1password のロック解除を yubikey で行う</h2><p>先日購入して触っていた <a href=/diary/posts/2023/0429/#yubikey-bio-を触ってみた>yubikey bio の設定</a> の続き。1password のロック解除を指紋認証で行いたかったが、1password の 8.10.4 のアプリではロック解除をシステム認証で行おうとするとエラーが発生していた (バグってた) 。5月の頭に <a href=https://releases.1password.com/linux/8.10/#1password-for-linux-8.10.6>8.10.6</a> がリリースされていてシステム認証のバグが直っていることに気付いた。1password のアプリケーションがどうやって linux のシステム認証を使っているかは次の1文に書いてある。</p><blockquote><p>システム認証は、Linux のユーザーアカウントに組み込まれたアクセス制御機構を使用します。これは polkit と PAM (Pluggable Authentication Modules) という2つの Linux 標準に依存しています。この2つを組み合わせることで、安全な認証サービスを提供します</p><p><a href=https://support.1password.com/system-authentication-linux/#about-system-authentication-security>https://support.1password.com/system-authentication-linux/#about-system-authentication-security</a></p></blockquote><p>私は <a href=https://wiki.archlinux.org/title/Polkit>polkit</a> を使ったことがなくて初見でよく分かっていないが、どうやら polkit から pam を介して認証しているようにみえる。pam.d 配下の設定を調べてみると <code>/etc/pam.d/polkit-1</code> がある。前回の設定で pam.d の設定とテストの方法を理解していた。ここまでくれば <a href=https://github.com/Yubico/pam-u2f/tree/main#module-arguments>Module Arguments</a> のドキュメントをみながらオプションを設定するだけ。<a href=https://yoshiori.hatenablog.com/entry/2022/02/17/173147>1Password のロック解除をYubiKeyでやる</a> の記事で origin/appid にホスト名を指定しているが、最新のモジュールだと指定しないときはデフォルトでホスト名が使われるようにみえる。</p><ul><li>origin: FIDO 認証手順の party ID を設定する、値が指定されない場合は識別子 <code>pam://$HOSTNAME</code> が使用される</li><li>appid: FIDO 認証手順の application ID を設定する、値を指定しない場合は origin で使用されたものと同じ値が使用される (origin も指定しない場合は <code>pam://$HOSTNAME</code>)</li><li>nouserok: 認証しようとするユーザーが <code>authfile</code> 内に存在しない場合や <code>authfile</code> が欠落/不正確な場合でも、認証の試行を成功させるように設定する</li><li>cue: タッチすることを促すメッセージを表示するように設定する</li></ul><p>これらを踏まえて u2f で認証が成功したらそれ以降の処理をスキップするように次の設定を先頭に追加する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sudo vi /etc/pam.d/polkit-1
</span></span><span style=display:flex><span>auth   sufficient   pam_u2f.so nouserok cue
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>cue を指定したことでパスワードプロンプトを表示せず、デバイスをタッチするように促される。よい感じ。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pamtester polkit-1 t2y authenticate
</span></span><span style=display:flex><span>Please touch the device.
</span></span><span style=display:flex><span>pamtester: successfully authenticated
</span></span></code></pre></div><p>これで pam の polkit の設定が正しいことを検証できる。この後に 1password のアプリケーションでロック解除するときに u2f を使って指紋認証できた。めっちゃ便利。</p><figure><img src=/diary/img/2023/0521_1password-system-auth.png></figure></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0504/>法人決算の続き</a></h1><div class=post-meta><time class=post-date>2023-05-04 (Thu.) ::</time></div><span class=post-tags>#<a href=/diary/tags/founding/>founding</a>&nbsp;
#<a href=/diary/tags/tax/>tax</a>&nbsp;
#<a href=/diary/tags/device/>device</a>&nbsp;
#<a href=/diary/tags/network/>network</a>&nbsp;
#<a href=/diary/tags/issue-management/>issue management</a>&nbsp;
#<a href=/diary/tags/communication/>communication</a>&nbsp;</span><div class=post-content><p>0時に寝て何度か起きて6時過ぎに起きた。休日は朝だらだらしてオフィスへ行くのが9-10時ぐらいになることが多いのだけど、今日は普通に8時過ぎに行けた。</p><h2 id=法人決算>法人決算</h2><p>朝から法人決算の続き。昨日たまたま消費税の計算をして、祝日やのに e-tax 稼働しているんやと思いながら申告した。これまで休日や祝日は稼働していなかった気がするので時代の変化にあわせてシステムはなるべく24時間稼働するように少しずつ変わってきている。今日も法人決算の続きをやっていて、課税所得を確認して、カテゴリ的には3つに分類される法人3税と呼ばれる税金を算出した。具体的には6つの税金を算出しないといけない。</p><ul><li>法人税 (=> 国税 => e-tax)<ul><li>法人税</li><li>地方法人税</li></ul></li><li>法人住民税 (=> 地方税 => eltax)<ul><li>法人県民税</li><li>法人市民税</li></ul></li><li>法人事業税 (=> 地方税 => eltax)<ul><li>法人事業税</li><li>特別法人事業税</li></ul></li></ul><p>過去の法人決算の経験からまず法人住民税と法人事業税を確定させてから法人決算の申告をすべきだというプラクティスがある。というのは、法人住民税と法人事業税の数値になんらかの誤りがあると法人決算で提出する別表の数字も修正しないといけないため、先に地方税を確定させた方が手戻りを少なくできる可能性が高い。電子申請するとそれぞれの書類の数値のバリデーションが機能するので手計算や手入力で誤りがあったときに発見できる可能性がある。これは電子申請をするメリットの1つでもある。</p><p>地方税を管轄するのが <a href=https://www.eltax.lta.go.jp/>eltax</a> で国税を管轄するのが <a href=https://www.e-tax.nta.go.jp/>e-tax</a> で別システムになる。いまとなっては、事前にチェックしておけばよかったなと思うところだが、あとの祭り。e-tax は5月3-4日が稼働していて5-7日が休止している。eltax は5月3-5日が休止していて6-7日が稼働しているというスケジュールになっていた。双方のシステムが稼働していれば今日中に終えられたものが、なんともちぐはぐなスケジュールで申告を完了させるのは来週以降に持ち越すことになる。また来年やるときはこのそれぞれのシステムの稼働スケジュールを事前にチェックして法人決算の作業日程を決めるように法人決算の issue に書き込んでおいた。来年はもっとうまくやる。</p><ul><li><a href=https://www.e-tax.nta.go.jp/info_center/index.htm>e-tax e-Taxの利用可能時間</a></li><li><a href=https://www.eltax.lta.go.jp/news/07638>eltax 令和5年度の休日運用日</a></li></ul><p>今日のところは法人3税の税金を算出し終えて、それらと関係ない別表の大半を作成した。基本的には決算の試算表から数値を転記したり、特例措置の申請のための書類を作ったりでなにも難しくない。</p><h2 id=iijmio-と-iphone-で作るモバイル-wifi-ルーター>iijmio と iphone で作るモバイル wifi ルーター</h2><p>今年に入ってから <a href=/diary/posts/2023/0321/#実家の出張所オフィスの準備>実家のオフィス化</a> の準備を着々と進めている。晩年は足が不自由だった祖父が生活できるよう、倉庫の一部を改築して車椅子でも生活できるような部屋になっていて、ある種の離れのようなスペースになっている。祖父が他界してからは誰も使っていない。トイレもお風呂もキッチンもついていて広さで言えば14畳ぐらいある。これまで使いにくかった理由は2つあってエアコンとインターネットがなかった。この前、母にお願いしてエアコンを購入してもらい、つい先日、設置が完了したらしい。</p><p>インターネットの回線をひくことも検討していたが、どうやら5000円/月ぐらいかかることがわかってきた。母はインターネットを必要としていないので月1回ぐらいしか使わないのに5000円も支払うのはもったいないなと一旦ストップしていた。スマートフォンのテザリングでお仕事できないわけではないから当初はそれでもいいかと考えていた。私の個人のスマホとインターネット回線は <a href=https://www.iijmio.jp/>iijmio</a> を使っていて iij さん好きなので同じように pocket wifi 的なものはないのかな？と調べたら正にそういう記事をみつけた。</p><ul><li><a href=https://mobile.inest-inc.co.jp/iijmio-pocket-wifi/>格安！IIJmioでポケットWiFiを作る！料金・手順・注意点まとめ</a></li></ul><p>よくよく考えたらデータ専用の sim を購入したらあとはモバイル wifi ルーターだけあればよいことに気付いて、それって iphone でできるやんということに気付いて、過去に使っていた古い iphone 11 を再利用できることに気付いた。さらにいまは <a href=https://www.iijmio.jp/gigaplan/esim/>esim</a> という物理 sim を必要としないソフトウェアベースの sim もあるようで月額の料金も esim の方が安い。
音声通話なしのデータ専用プランで税込で次の金額になる。さらに使わなかったらデータ量は翌月以降に繰越できる。プランによって繰越できる期間が異なる。例えば2GiBなら翌月末まで繰越できる。繰越という概念はたまにしか使わない私の用途にぴったりでひとまず2GiBプランを選択してお試し運用してみることにした。</p><ul><li>1GiB: 165円/月</li><li>2GiB: 440円/月</li><li>5GiB: 660円/月</li><li>10GiB: 1,100円/月</li><li>20GiB: 1,650円/月</li></ul><p>esim というソフトウェアベースのものだと、申し込みして5分後に設定できましたというメールが届き、すぐにアクティベートして iphone 11 に esim の設定をしたら10分後にはインターネットに接続できるようになった。その後 apn の設定を行ってテザリングもできるようになって、30分後には iphone 11 をモバイル wifi ルーターとして macbook からインターネットにアクセスできるかの疎通確認を終えた。</p><p>つまりソフトウェアベースで業務を行うことのワークフローの効率が半端なく高い。これが物理 sim なら数人の人手と待ち時間がかかることは容易に想像できる。物理的にしかできなかったことをソフトウェアベースにしてワークフローを洗練化させることの強力さを実感した。常々、私が課題管理の文脈でコミュニケーションコストを減らせれば生産性が上がると開発者に啓蒙していることと同じで自分がやろうとしていることの概念を追体験するような経験となった。ワークフローの効率を極端に落とすのは人間である。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0429/>yubikey bio を触ってみた</a></h1><div class=post-meta><time class=post-date>2023-04-29 (Sat.) ::</time></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/device/>device</a>&nbsp;
#<a href=/diary/tags/pam/>pam</a>&nbsp;
#<a href=/diary/tags/auth/>auth</a>&nbsp;
#<a href=/diary/tags/security/>security</a>&nbsp;</span><div class=post-content><p>3時半に寝て7時に起きた。リリース終えたので晩ご飯を食べてから自分の会社のお仕事をしていたら遅くなった。</p><h2 id=ストレッチ>ストレッチ</h2><p>今週もリリース明けでそれほど座っている時間が長かったわけでもないため、腰の張りはあまりなく、負荷は低くなっているのではないかと推測する。今日の開脚幅は開始前156cmで、ストレッチ後158cmだった。右股関節周りの硬さは相変わらず大きく変化はないが、他がよくなった分、右ふともも前の筋を伸ばすと張りがきつくてしんどいように感じた。しばらく余裕のある生活ができるので歩いたりストレッチしたりする余裕が出てくるかもしれない。</p><h2 id=yubikey-bio-を触ってみた>yubikey bio を触ってみた</h2><p>先日 <a href=/diary/posts/2023/0416/#yubikey-bio-の購入>yubikey bio をオンラインストアで購入</a> した。会社の経費で業務で使うことを目的に購入したのでこの場合は商用利用の輸入にあたる。また別途、輸入についての会計処理を書く。yubico はスウェーデンの会社でどうやら日本向けはスウェーデンの首都ストックホルムから発送されてきたらしい。安いエコノミープランで注文していた。発送メールを受け取ったのが 4/17 でオフィスの郵便受けに入っていることに気付いたのが 4/29 になる。12日で届いたことになる。船便にしては早いからなにかしら航空便の安いプランで届いたのだと推測する。</p><blockquote><p>Economy - 10-20 Working Days - No tracking available</p></blockquote><p>早速、接続していろいろ触ってみた。結論から言って ubuntu 22.04 で fido2 pin を設定して u2f を使って2要素認証のメソッドとして pam や web アプリケーションから問題なく使えた。ubuntu 向けのアプリケーションも ppa のリポジトリを追加して apt からインストールできる。</p><ul><li><a href=https://support.yubico.com/hc/en-us/articles/360016649039-Installing-Yubico-Software-on-Linux>Installing Yubico Software on Linux</a></li></ul><p>このドキュメントには次の4つのアプリケーションのインストールが書いてある。</p><ul><li>YubiKey Manager (CLI): <code>sudo apt install yubikey-manager</code></li><li>YubiKey Personalization Tool: <code>sudo apt install yubikey-personalization-gui</code></li><li>libpam-yubico: <code>sudo apt install libpam-yubico</code></li><li>libpam-u2f: <code>sudo apt install libpam-u2f</code></li></ul><p>yubikey は他にもいろいろな認証の用途に使えるらしい。今回は fido2 の設定のみを紹介する。fido2 pin を登録するには YubiKey Manager の GUI を使った方が簡単なので次のアプリケーションも一緒にインストールするとよい。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sudo apt install -y yubikey-manager-qt
</span></span><span style=display:flex><span>$ ykman-gui
</span></span></code></pre></div><p>おそらく ykman の cli でも登録できると思うけど、yubikey や認証設定に慣れていない初心者は gui のナビゲーションに従って作業して結果を確認した方が安心だと思う。fido2 pin は ssh でいうところのパスフレーズのようなものなのかな？デバイスが盗まれるのを防ぐために pin があるという。一方で web アプリケーションが fido2 で認証するときに pin を要求するかどうかは任意になるらしい。よくあるパターンは初めて使うときは pin を要求して2回目以降はスキップするといった用途が多いのではないかと推測する。</p><figure><img src=/diary/img/2023/0429_ykman-gui1.png></figure><p>この fido2 pin を使って <a href=https://en.wikipedia.org/wiki/Universal_2nd_Factor>Universal 2nd Factor (u2f)</a> の設定を行う。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ mkdir -p ~/.config/Yubico
</span></span><span style=display:flex><span>$ pamu2fcfg &gt; ~/.config/Yubico/u2f_keys
</span></span><span style=display:flex><span>Enter PIN <span style=color:#66d9ef>for</span> /dev/hidraw3: ***  &lt;<span style=color:#f92672>=</span> このときに yubikey manager で設定した fido2 pin を入力
</span></span></code></pre></div><p>この後 yubikey デバイスが点滅するので丸いセンサー部分を指でタッチすると完了する。このときに指紋登録しているのか、物理的にタッチすることを要求しているだけなのか、よくわかっていない。この前に <a href=https://www.yubico.com/setup/yubikey-bio-series/>chrome で指紋登録</a> をしていたのでそれが使われているのかもしれない。いま ykman で設定をみたら <code>Fingerprints registered</code> とあるのでどこかしらに指紋登録されているらしい。おそらく chrome じゃないかと推測する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ykman fido info
</span></span><span style=display:flex><span>WARNING: PC/SC not available. Smart card <span style=color:#f92672>(</span>CCID<span style=color:#f92672>)</span> protocols will not <span style=color:#66d9ef>function</span>.
</span></span><span style=display:flex><span>PIN is set, with <span style=color:#ae81ff>8</span> attempt<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span> remaining.
</span></span><span style=display:flex><span>Fingerprints registered, with <span style=color:#ae81ff>3</span> attempt<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span> remaining.
</span></span><span style=display:flex><span>Always Require User Verification is turned on.
</span></span></code></pre></div><p>linux で認証時に u2f を使いたいときは <code>pam_u2f.so</code> を使って pam の設定をするとよい。ubuntu だと <code>/etc/pam.d/</code> 配下にいろんな認証設定がある。例えば login 時に2要素認証をしたい場合は次のようにフックする。パスワード入力した後に yubikey のセンサーを物理的にタッチして指紋認証を行える。セキュリティに厳しい会社はこういった運用をしているのかもしれない。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sudo vi /etc/pam.d/login
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span><span style=color:#75715e># Standard Un*x authentication.</span>
</span></span><span style=display:flex><span>@include common-auth
</span></span><span style=display:flex><span>auth       required    pam_u2f.so
</span></span></code></pre></div><p>パスワード認証の代替として使いたい場合は通常の認証の前に <code>sufficient</code> として呼び出せば指紋認証が成功したときにそれ以降の処理がスキップされる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>auth       sufficient    pam_u2f.so
</span></span><span style=display:flex><span>@include common-auth
</span></span></code></pre></div><p>これらの設定を確認にするには <a href=https://pamtester.sourceforge.net/>pamtester</a> というツールを使うと簡単にできる。認証の設定を誤るとログインできなくなってしまうので慎重にテストして振る舞いを確認した上で実際の運用を行うとよい。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pamtester login t2y authenticate  &lt;<span style=color:#f92672>=</span> このときに yubikey デバイスが点滅するので指紋認証する
</span></span><span style=display:flex><span>pamtester: successfully authenticated
</span></span></code></pre></div><p>せっかく購入したので 1password アカウントや github の2要素認証に設定してみた。ワンタイムパスワードの otp の代替として使える。ワンタイムパスワードを入力するより yubikey のセンサーをタッチする方が日々の運用としては少しお手軽と言える。設定していて otp と yubikey でお互いに2要素認証のバックアップを兼ねることに気付いた。認証方法が増えるのでセキュリティ的には脆弱になるけれど、サービスとセキュリティのトレードオフの考え方から、yubikey の分だけ脆弱になっても物理的なセキュリティを担保できるのであれば利便性を考慮してよいように私には思えた。</p></div></article><div class=pagination><div class=pagination__buttons><a href=/diary/tags/device/page/2/ class="button next"><span class=button__text>過去の日記</span>
<span class=button__icon>→</span></a></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>© 2021 Tetsuya Morimoto</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>