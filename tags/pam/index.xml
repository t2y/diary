<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Pam on</title><link>/diary/tags/pam/</link><description>Recent content in Pam on</description><generator>Hugo -- gohugo.io</generator><language>en</language><lastBuildDate>Sun, 21 May 2023 13:28:53 +0900</lastBuildDate><atom:icon>/diary/favicon.ico</atom:icon><icon>/diary/favicon.ico</icon><atom:link href="/diary/tags/pam/index.xml" rel="self" type="application/rss+xml"/><item><title>yubikey bio を完全にマスターした</title><link>/diary/posts/2023/0521/</link><pubDate>Sun, 21 May 2023 13:28:53 +0900</pubDate><guid>/diary/posts/2023/0521/</guid><description>2時に寝て遅くまで飲んでいたせいか、やや吐き気もしながら朝起きてだらだらして11時ぐらいに起きた。
1password のロック解除を yubikey で行う 先日購入して触っていた yubikey bio の設定 の続き。1password のロック解除を指紋認証で行いたかったが、1password の 8.10.4 のアプリではロック解除をシステム認証で行おうとするとエラーが発生していた (バグってた) 。5月の頭に 8.10.6 がリリースされていてシステム認証のバグが直っていることに気付いた。1password のアプリケーションがどうやって linux のシステム認証を使っているかは次の1文に書いてある。
システム認証は、Linux のユーザーアカウントに組み込まれたアクセス制御機構を使用します。これは polkit と PAM (Pluggable Authentication Modules) という2つの Linux 標準に依存しています。この2つを組み合わせることで、安全な認証サービスを提供します
https://support.1password.com/system-authentication-linux/#about-system-authentication-security
私は polkit を使ったことがなくて初見でよく分かっていないが、どうやら polkit から pam を介して認証しているようにみえる。pam.d 配下の設定を調べてみると /etc/pam.d/polkit-1 がある。前回の設定で pam.d の設定とテストの方法を理解していた。ここまでくれば Module Arguments のドキュメントをみながらオプションを設定するだけ。1Password のロック解除をYubiKeyでやる の記事で origin/appid にホスト名を指定しているが、最新のモジュールだと指定しないときはデフォルトでホスト名が使われるようにみえる。
origin: FIDO 認証手順の party ID を設定する、値が指定されない場合は識別子 pam://$HOSTNAME が使用される appid: FIDO 認証手順の application ID を設定する、値を指定しない場合は origin で使用されたものと同じ値が使用される (origin も指定しない場合は pam://$HOSTNAME) nouserok: 認証しようとするユーザーが authfile 内に存在しない場合や authfile が欠落/不正確な場合でも、認証の試行を成功させるように設定する cue: タッチすることを促すメッセージを表示するように設定する これらを踏まえて u2f で認証が成功したらそれ以降の処理をスキップするように次の設定を先頭に追加する。</description><content>&lt;p>2時に寝て遅くまで飲んでいたせいか、やや吐き気もしながら朝起きてだらだらして11時ぐらいに起きた。&lt;/p>
&lt;h2 id="1password-のロック解除を-yubikey-で行う">1password のロック解除を yubikey で行う&lt;/h2>
&lt;p>先日購入して触っていた &lt;a href="/diary/diary/posts/2023/0429/#yubikey-bio-を触ってみた">yubikey bio の設定&lt;/a> の続き。1password のロック解除を指紋認証で行いたかったが、1password の 8.10.4 のアプリではロック解除をシステム認証で行おうとするとエラーが発生していた (バグってた) 。5月の頭に &lt;a href="https://releases.1password.com/linux/8.10/#1password-for-linux-8.10.6">8.10.6&lt;/a> がリリースされていてシステム認証のバグが直っていることに気付いた。1password のアプリケーションがどうやって linux のシステム認証を使っているかは次の1文に書いてある。&lt;/p>
&lt;blockquote>
&lt;p>システム認証は、Linux のユーザーアカウントに組み込まれたアクセス制御機構を使用します。これは polkit と PAM (Pluggable Authentication Modules) という2つの Linux 標準に依存しています。この2つを組み合わせることで、安全な認証サービスを提供します&lt;/p>
&lt;p>&lt;a href="https://support.1password.com/system-authentication-linux/#about-system-authentication-security">https://support.1password.com/system-authentication-linux/#about-system-authentication-security&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>私は &lt;a href="https://wiki.archlinux.org/title/Polkit">polkit&lt;/a> を使ったことがなくて初見でよく分かっていないが、どうやら polkit から pam を介して認証しているようにみえる。pam.d 配下の設定を調べてみると &lt;code>/etc/pam.d/polkit-1&lt;/code> がある。前回の設定で pam.d の設定とテストの方法を理解していた。ここまでくれば &lt;a href="https://github.com/Yubico/pam-u2f/tree/main#module-arguments">Module Arguments&lt;/a> のドキュメントをみながらオプションを設定するだけ。&lt;a href="https://yoshiori.hatenablog.com/entry/2022/02/17/173147">1Password のロック解除をYubiKeyでやる&lt;/a> の記事で origin/appid にホスト名を指定しているが、最新のモジュールだと指定しないときはデフォルトでホスト名が使われるようにみえる。&lt;/p>
&lt;ul>
&lt;li>origin: FIDO 認証手順の party ID を設定する、値が指定されない場合は識別子 &lt;code>pam://$HOSTNAME&lt;/code> が使用される&lt;/li>
&lt;li>appid: FIDO 認証手順の application ID を設定する、値を指定しない場合は origin で使用されたものと同じ値が使用される (origin も指定しない場合は &lt;code>pam://$HOSTNAME&lt;/code>)&lt;/li>
&lt;li>nouserok: 認証しようとするユーザーが &lt;code>authfile&lt;/code> 内に存在しない場合や &lt;code>authfile&lt;/code> が欠落/不正確な場合でも、認証の試行を成功させるように設定する&lt;/li>
&lt;li>cue: タッチすることを促すメッセージを表示するように設定する&lt;/li>
&lt;/ul>
&lt;p>これらを踏まえて u2f で認証が成功したらそれ以降の処理をスキップするように次の設定を先頭に追加する。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>$ sudo vi /etc/pam.d/polkit-1
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>auth sufficient pam_u2f.so nouserok cue
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>...
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>cue を指定したことでパスワードプロンプトを表示せず、デバイスをタッチするように促される。よい感じ。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>$ pamtester polkit-1 t2y authenticate
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Please touch the device.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>pamtester: successfully authenticated
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>これで pam の polkit の設定が正しいことを検証できる。この後に 1password のアプリケーションでロック解除するときに u2f を使って指紋認証できた。めっちゃ便利。&lt;/p>
&lt;figure>&lt;img src="/diary/diary/img/2023/0521_1password-system-auth.png"/>
&lt;/figure></content></item><item><title>yubikey bio を触ってみた</title><link>/diary/posts/2023/0429/</link><pubDate>Sat, 29 Apr 2023 14:24:07 +0900</pubDate><guid>/diary/posts/2023/0429/</guid><description>3時半に寝て7時に起きた。リリース終えたので晩ご飯を食べてから自分の会社のお仕事をしていたら遅くなった。
ストレッチ 今週もリリース明けでそれほど座っている時間が長かったわけでもないため、腰の張りはあまりなく、負荷は低くなっているのではないかと推測する。今日の開脚幅は開始前156cmで、ストレッチ後158cmだった。右股関節周りの硬さは相変わらず大きく変化はないが、他がよくなった分、右ふともも前の筋を伸ばすと張りがきつくてしんどいように感じた。しばらく余裕のある生活ができるので歩いたりストレッチしたりする余裕が出てくるかもしれない。
yubikey bio を触ってみた 先日 yubikey bio をオンラインストアで購入 した。会社の経費で業務で使うことを目的に購入したのでこの場合は商用利用の輸入にあたる。また別途、輸入についての会計処理を書く。yubico はスウェーデンの会社でどうやら日本向けはスウェーデンの首都ストックホルムから発送されてきたらしい。安いエコノミープランで注文していた。発送メールを受け取ったのが 4/17 でオフィスの郵便受けに入っていることに気付いたのが 4/29 になる。12日で届いたことになる。船便にしては早いからなにかしら航空便の安いプランで届いたのだと推測する。
Economy - 10-20 Working Days - No tracking available
早速、接続していろいろ触ってみた。結論から言って ubuntu 22.04 で fido2 pin を設定して u2f を使って2要素認証のメソッドとして pam や web アプリケーションから問題なく使えた。ubuntu 向けのアプリケーションも ppa のリポジトリを追加して apt からインストールできる。
Installing Yubico Software on Linux このドキュメントには次の4つのアプリケーションのインストールが書いてある。
YubiKey Manager (CLI): sudo apt install yubikey-manager YubiKey Personalization Tool: sudo apt install yubikey-personalization-gui libpam-yubico: sudo apt install libpam-yubico libpam-u2f: sudo apt install libpam-u2f yubikey は他にもいろいろな認証の用途に使えるらしい。今回は fido2 の設定のみを紹介する。fido2 pin を登録するには YubiKey Manager の GUI を使った方が簡単なので次のアプリケーションも一緒にインストールするとよい。</description><content>&lt;p>3時半に寝て7時に起きた。リリース終えたので晩ご飯を食べてから自分の会社のお仕事をしていたら遅くなった。&lt;/p>
&lt;h2 id="ストレッチ">ストレッチ&lt;/h2>
&lt;p>今週もリリース明けでそれほど座っている時間が長かったわけでもないため、腰の張りはあまりなく、負荷は低くなっているのではないかと推測する。今日の開脚幅は開始前156cmで、ストレッチ後158cmだった。右股関節周りの硬さは相変わらず大きく変化はないが、他がよくなった分、右ふともも前の筋を伸ばすと張りがきつくてしんどいように感じた。しばらく余裕のある生活ができるので歩いたりストレッチしたりする余裕が出てくるかもしれない。&lt;/p>
&lt;h2 id="yubikey-bio-を触ってみた">yubikey bio を触ってみた&lt;/h2>
&lt;p>先日 &lt;a href="/diary/diary/posts/2023/0416/#yubikey-bio-の購入">yubikey bio をオンラインストアで購入&lt;/a> した。会社の経費で業務で使うことを目的に購入したのでこの場合は商用利用の輸入にあたる。また別途、輸入についての会計処理を書く。yubico はスウェーデンの会社でどうやら日本向けはスウェーデンの首都ストックホルムから発送されてきたらしい。安いエコノミープランで注文していた。発送メールを受け取ったのが 4/17 でオフィスの郵便受けに入っていることに気付いたのが 4/29 になる。12日で届いたことになる。船便にしては早いからなにかしら航空便の安いプランで届いたのだと推測する。&lt;/p>
&lt;blockquote>
&lt;p>Economy - 10-20 Working Days - No tracking available&lt;/p>
&lt;/blockquote>
&lt;p>早速、接続していろいろ触ってみた。結論から言って ubuntu 22.04 で fido2 pin を設定して u2f を使って2要素認証のメソッドとして pam や web アプリケーションから問題なく使えた。ubuntu 向けのアプリケーションも ppa のリポジトリを追加して apt からインストールできる。&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://support.yubico.com/hc/en-us/articles/360016649039-Installing-Yubico-Software-on-Linux">Installing Yubico Software on Linux&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>このドキュメントには次の4つのアプリケーションのインストールが書いてある。&lt;/p>
&lt;ul>
&lt;li>YubiKey Manager (CLI): &lt;code>sudo apt install yubikey-manager&lt;/code>&lt;/li>
&lt;li>YubiKey Personalization Tool: &lt;code>sudo apt install yubikey-personalization-gui&lt;/code>&lt;/li>
&lt;li>libpam-yubico: &lt;code>sudo apt install libpam-yubico&lt;/code>&lt;/li>
&lt;li>libpam-u2f: &lt;code>sudo apt install libpam-u2f&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>yubikey は他にもいろいろな認証の用途に使えるらしい。今回は fido2 の設定のみを紹介する。fido2 pin を登録するには YubiKey Manager の GUI を使った方が簡単なので次のアプリケーションも一緒にインストールするとよい。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>$ sudo apt install -y yubikey-manager-qt
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ ykman-gui
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>おそらく ykman の cli でも登録できると思うけど、yubikey や認証設定に慣れていない初心者は gui のナビゲーションに従って作業して結果を確認した方が安心だと思う。fido2 pin は ssh でいうところのパスフレーズのようなものなのかな？デバイスが盗まれるのを防ぐために pin があるという。一方で web アプリケーションが fido2 で認証するときに pin を要求するかどうかは任意になるらしい。よくあるパターンは初めて使うときは pin を要求して2回目以降はスキップするといった用途が多いのではないかと推測する。&lt;/p>
&lt;figure>&lt;img src="/diary/diary/img/2023/0429_ykman-gui1.png"/>
&lt;/figure>
&lt;p>この fido2 pin を使って &lt;a href="https://en.wikipedia.org/wiki/Universal_2nd_Factor">Universal 2nd Factor (u2f)&lt;/a> の設定を行う。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>$ mkdir -p ~/.config/Yubico
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ pamu2fcfg &amp;gt; ~/.config/Yubico/u2f_keys
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Enter PIN &lt;span style="color:#66d9ef">for&lt;/span> /dev/hidraw3: *** &amp;lt;&lt;span style="color:#f92672">=&lt;/span> このときに yubikey manager で設定した fido2 pin を入力
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>この後 yubikey デバイスが点滅するので丸いセンサー部分を指でタッチすると完了する。このときに指紋登録しているのか、物理的にタッチすることを要求しているだけなのか、よくわかっていない。この前に &lt;a href="https://www.yubico.com/setup/yubikey-bio-series/">chrome で指紋登録&lt;/a> をしていたのでそれが使われているのかもしれない。いま ykman で設定をみたら &lt;code>Fingerprints registered&lt;/code> とあるのでどこかしらに指紋登録されているらしい。おそらく chrome じゃないかと推測する。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>$ ykman fido info
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>WARNING: PC/SC not available. Smart card &lt;span style="color:#f92672">(&lt;/span>CCID&lt;span style="color:#f92672">)&lt;/span> protocols will not &lt;span style="color:#66d9ef">function&lt;/span>.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>PIN is set, with &lt;span style="color:#ae81ff">8&lt;/span> attempt&lt;span style="color:#f92672">(&lt;/span>s&lt;span style="color:#f92672">)&lt;/span> remaining.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Fingerprints registered, with &lt;span style="color:#ae81ff">3&lt;/span> attempt&lt;span style="color:#f92672">(&lt;/span>s&lt;span style="color:#f92672">)&lt;/span> remaining.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Always Require User Verification is turned on.
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>linux で認証時に u2f を使いたいときは &lt;code>pam_u2f.so&lt;/code> を使って pam の設定をするとよい。ubuntu だと &lt;code>/etc/pam.d/&lt;/code> 配下にいろんな認証設定がある。例えば login 時に2要素認証をしたい場合は次のようにフックする。パスワード入力した後に yubikey のセンサーを物理的にタッチして指紋認証を行える。セキュリティに厳しい会社はこういった運用をしているのかもしれない。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>$ sudo vi /etc/pam.d/login
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>...
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># Standard Un*x authentication.&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>@include common-auth
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>auth required pam_u2f.so
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>パスワード認証の代替として使いたい場合は通常の認証の前に &lt;code>sufficient&lt;/code> として呼び出せば指紋認証が成功したときにそれ以降の処理がスキップされる。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>auth sufficient pam_u2f.so
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>@include common-auth
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>これらの設定を確認にするには &lt;a href="https://pamtester.sourceforge.net/">pamtester&lt;/a> というツールを使うと簡単にできる。認証の設定を誤るとログインできなくなってしまうので慎重にテストして振る舞いを確認した上で実際の運用を行うとよい。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>$ pamtester login t2y authenticate &amp;lt;&lt;span style="color:#f92672">=&lt;/span> このときに yubikey デバイスが点滅するので指紋認証する
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>pamtester: successfully authenticated
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>せっかく購入したので 1password アカウントや github の2要素認証に設定してみた。ワンタイムパスワードの otp の代替として使える。ワンタイムパスワードを入力するより yubikey のセンサーをタッチする方が日々の運用としては少しお手軽と言える。設定していて otp と yubikey でお互いに2要素認証のバックアップを兼ねることに気付いた。認証方法が増えるのでセキュリティ的には脆弱になるけれど、サービスとセキュリティのトレードオフの考え方から、yubikey の分だけ脆弱になっても物理的なセキュリティを担保できるのであれば利便性を考慮してよいように私には思えた。&lt;/p></content></item></channel></rss>