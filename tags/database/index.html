<!doctype html><html lang=en><head><title>Database :: </title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/tags/database/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="Database"><meta property="og:description" content><meta property="og:url" content="/diary/tags/database/"><meta property="og:site_name" content><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/tags/database/index.xml rel=alternate type=application/rss+xml title></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><h1>Posts for: #Database</h1><div class=posts><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0224/>mongodb のトランザクションの考え方</a></h1><div class=post-meta><time class=post-date>2023-02-24</time></div><span class=post-tags>#<a href=/diary/tags/mongodb/>mongodb</a>&nbsp;
#<a href=/diary/tags/database/>database</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;</span><div class=post-content><p>1時に寝て8時に起きた。3時頃に気分悪くて起きて少し吐いてそれからまた寝た。丸1日機能拡張とリファクタリングのために go のコードを書いていた。</p><h2 id=mongodb-のトランザクション管理>mongodb のトランザクション管理</h2><p>2つの web api から同じコレクションの異なるフィールドを更新したい。mongodb で厳密なトランザクションを管理するようなアプリケーションではないけど、なるべく整合性を維持できるように努めることはやっておきたい。mongodb でトランザクションに近いことを実現する方法として次の記事が参考になった。</p><ul><li><a href=https://www.mongodb.com/blog/post/how-to-select--for-update-inside-mongodb-transactions>How To SELECT &mldr; FOR UPDATE inside MongoDB Transactions</a></li></ul><p>この記事では <code>findOneAndUpdate()</code> という api を使って、更新時に必ず変更されるフィールドを含めることで find したときのそのフィールドの値が変わっていればエラーになってくれることでトランザクション相当の機能が提供されると書いてある。必ず変更されるフィールドとして <a href=https://www.mongodb.com/docs/manual/reference/method/ObjectId/>ObjectId</a> を使えば他の更新処理を検出するのに役立つだろうとある。いま私が開発しているアプリケーションでは同じフィールドを複数の web api から更新するわけではないのでここまで厳密なトランザクション管理は必要にない。</p><p>既存の処理が <a href=https://www.mongodb.com/docs/drivers/go/current/usage-examples/replaceOne/>Replace</a> を使って実装されていたのを <a href=https://www.mongodb.com/docs/drivers/go/current/usage-examples/updateOne/>Update</a> を使うように変更する。Replace と Update の違いはドキュメント全体を更新するのか、一部のフィールドのみを更新するのかの違いになる。具体的には go のドライバーにおいて次のメソッドの使い分けになる。</p><ul><li><a href=https://pkg.go.dev/go.mongodb.org/mongo-driver/mongo#Collection.FindOneAndReplace>FindOneAndReplace</a></li><li><a href=https://pkg.go.dev/go.mongodb.org/mongo-driver/mongo#Collection.FindOneAndUpdate>FindOneAndUpdate</a></li></ul><p>これらのメソッドを使うことで find と replace/update の操作を1回の処理でできるから効率もよいらしい。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0215/>後世に残せるものを書く</a></h1><div class=post-meta><time class=post-date>2023-02-15</time></div><span class=post-tags>#<a href=/diary/tags/book/>book</a>&nbsp;
#<a href=/diary/tags/database/>database</a>&nbsp;
#<a href=/diary/tags/coworking/>coworking</a>&nbsp;
#<a href=/diary/tags/community/>community</a>&nbsp;
#<a href=/diary/tags/event/>event</a>&nbsp;</span><div class=post-content><p>0時に寝て4時に起きて6時半に起きた。今日は3つのイベントに参加して疲れた。そのうちの2つを紹介する。</p><h2 id=データ指向アプリケーションデザインの紹介イベント>データ指向アプリケーションデザインの紹介イベント</h2><p><a href=https://forkwell.connpass.com/event/269125/>Data Engineering Study #18「データ指向アプリケーションデザイン」</a> に参加した。監訳者のさいとうさんのブログの <a href=https://medium.com/@taroleo/2022%E5%B9%B4%E3%82%92%E6%8C%AF%E3%82%8A%E8%BF%94%E3%81%A3%E3%81%A6-563ed3405ce0>2022年を振り返って</a> を読んだときにたまたまみつけて登録していた。</p><p>14:00 - 16:30 というちょっと変わった時間帯に設定されているのはさいとうさんが米国在住で時差によるものだと推測する。さいとうさんのいる場所では21時ぐらいと話されていたような気がする。2時間半分のお仕事を休んでもこのイベントは聞きたいなと思ったので取引先に連絡した上でその時間帯はイベントを聞いていた。</p><p>この本は人類の叡智といってよいと私は思う。
さいとうさんによると、2007-2017年の過去10年間の分散データシステムの教科書と紹介されていた。私はそれ以前の研究を知っているわけではないので、私のような初学者にとってはもっと長い期間のデータベース研究の歴史を学べるように感じた。
著者はこの本を書くのに4年を費やしたという。本を1冊書くのに4年とか、著者の偉大さが伺える年月でもある。</p><p>著者はデータベースの研究者であろうけれど、すべての研究を自分で行ったわけではないだろう。
他者の研究を調査した上でこういった書籍にまとめるというお仕事も非常に価値のあることだと本書を読んで実感した。私も課題管理の分野でそういうことができればいいなと思う。</p><p>さいとうさんの講演のタイトルは「30分でわかる〜」という接頭辞がついているものの、さいとうさんと同レベルの人にしかわかるわけはなくて、このイベントに参加しても本に書いてある全体像がわかるだけで、本の内容がわかることはほぼないと言える。私はこの本を精読したのでさいとうさんの話しを聞きながら、あの辺の書いてあった話しの紹介だなと記憶を辿りながら聞いていた。</p><blockquote class=twitter-tweet><p lang=ja dir=ltr>「30分でわかるデータ指向アプリケーションデザイン」発表資料を公開しました。「データの量、複雑さ、変化の速度」を中心に考えてアプリケーション設計する分散データシステムの世界と、その楽しさを身近に感じていただければ幸いです。<a href=https://t.co/zavNqMxEvt>https://t.co/zavNqMxEvt</a> <a href="https://twitter.com/hashtag/DataEngineeringStudy?src=hash&amp;ref_src=twsrc%5Etfw">#DataEngineeringStudy</a></p>&mdash; Taro L. Saito (@taroleo) <a href="https://twitter.com/taroleo/status/1625768417415532544?ref_src=twsrc%5Etfw">February 15, 2023</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script><h2 id=コワーキングのオンラインイベント>コワーキングのオンラインイベント</h2><p>月例のカフーツさんのオンラインイベントに参加した。<a href=/diary/posts/2023/0118/#コワーキングのオンラインイベント>先月の所感はここ</a> 。今日の話題は <a href="https://cahootz.jp/?p=2428">間借りコワーキング</a> だった。実際にカフーツさんで間借りコワーキングを実践された方をゲストにお招きしてその体験談を話してもらってみんなで議論したりしていた。ここで言う間借りとは、コワーキングスペースの運営をメンバーにも体験してもらってそこから新たな価値を模索しようといったもの。インターンシップのようなものとも言えるし価値創造のための施策とも受け取れる。ただのアルバイトではないという意図で「間借り」という名前を付けている。最初に説明を聞いていて、あまり私にはピンと来なかった。それは it 業界は勉強会を個々に開くのが当たり前過ぎて、そんなのはわざわざコワーキングスペースの運営者にならなくてもすぐにできることのように思えたから。おそらくここは it 業界が先進的過ぎて、普通の組織や会社に勤めている人は、気軽に知人や不特定多数の人たちを呼んで勉強会 (イベント) をしたりしないのだと推測する。</p><p>それからコミュニティの話題で、強い紐帯と弱い紐帯の話しが出てきて、<a href=https://ja.wikipedia.org/wiki/%E3%83%AA%E3%83%B3%E3%83%80%E3%83%BB%E3%82%B0%E3%83%A9%E3%83%83%E3%83%88%E3%83%B3>リンダ・グラットン</a> 氏の著書に書いてあった言葉として「境界接続者」という用語を紹介されていた。私が軽くググってみてもその用語は出てこないのでおそらくは次の研究者の研究を紹介されている一節だったのではないかと推測する。</p><blockquote><p>　アメリカの社会学者Ｍ・グラノヴェッターの「弱い紐帯の強さ」という有名な説をご存じの方は多いと思う。「紐帯（ちゅうたい）」とは文字どおり紐（ひも）や帯（おび）のことではあるが、転じて「二つのものをかたく結びつけるもの」また「 血縁・地縁・利害関係など、社会を形づくる結びつき」という意味がある。（「デジタル大辞泉」より）「弱い紐帯の強さ」とは『価値ある情報の伝達やイノベーションの伝播においては、家族や親友、同じ職場の仲間のような強いネットワーク（強い紐帯）よりも、「ちょっとした知り合い」や「知人の知人」のような弱いネットワーク（弱い紐帯）が重要である』という社会ネットワーク理論である。もう40年前に発表されたが、SNSが世の中を席巻するようになり再び注目をあびている。</p><p><a href=https://www.ogis-ri.co.jp/column/kr/257.html>会社内の「弱い紐帯（ちゅうたい）」</a></p></blockquote><p>なにかの英語の言葉の訳語として「境界接続者」という用語をあてているのだと推測する。ここでいう境界とは、コミュニティとコミュニティをつなぐ役割をする人のことでそういった人がコミュニティにおいて大きな価値を提供しているというのが、弱い紐帯の強さで提案されている価値に相当するらしい。それを体験もしくは実践する機会として間借りコワーキングはうまく作用するのではないかという企画につながってくる。そこまで聞いて、単なるインターンシップではないことは理解できた。</p><p>私はどちらかと言うと弱い紐帯よりも強い紐帯のコミュニティの価値を認める方だと言える。その真逆の考え方は懸念もいくつかあるものの、普段は考えないことを考える機会としておもしろかったと言える。社会で生きていく上でどちらの要素もあることなので一方に固執しなくてもよいというのも正しいと思う。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0506/>flyway を触ってみた</a></h1><div class=post-meta><time class=post-date>2022-05-06</time></div><span class=post-tags>#<a href=/diary/tags/java/>java</a>&nbsp;
#<a href=/diary/tags/database/>database</a>&nbsp;
#<a href=/diary/tags/migration/>migration</a>&nbsp;</span><div class=post-content><p>0時に寝て4時に起きてタイムライン眺めながらだらだらして6時半に起き上がった。</p><h2 id=データベースの移行処理>データベースの移行処理</h2><p>半年前から導入したいという話しは聞いていたものの、先送りになっていたライブラリに <a href=https://flywaydb.org/>flyway</a> がある。データベースの移行処理のためのスクリプト (sql) を管理するツールでどの移行スクリプトを実行したかを記録したり、未適用の処理を自動で適用してくれたりする。spring boot だとすぐ組み込める状態になっていて <a href=https://flywaydb.org/documentation/usage/plugins/springboot>Community Plugins and Integrations: Spring Boot</a> をみながら設定したらすぐに動いた。flyway 自体の設定も <a href=https://docs.spring.io/spring-boot/docs/current/reference/html/application-properties.html>Common Application Properties</a> を参考に spring boot の設定ファイルで行える。</p><p>例えば、こんな感じ。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>spring</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>flyway</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>￼    enabled</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span><span style=color:#f92672>￼    schemas</span>: <span style=color:#ae81ff>public</span>
</span></span><span style=display:flex><span><span style=color:#f92672>￼    locations</span>: <span style=color:#ae81ff>classpath:db/migration</span>
</span></span><span style=display:flex><span><span style=color:#f92672>￼    baseline-version</span>: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#f92672>￼    baseline-on-migrate</span>: <span style=color:#66d9ef>true</span>
</span></span></code></pre></div><p>移行処理の履歴情報は <code>flyway_schema_history</code> テーブルに保持される。既存のテーブルが存在して flyway の履歴データがない場合 (初回起動時) に移行処理を実行するかどうかを baseline-on-migrate で決める。実行するなら baseline-version でどのバージョンをベースラインとするかも設定できる。ゼロにすることで <code>V1</code> からの sql ファイルを適用してくれる。ベースラインの考え方は実際に何度かデータベースの初期状態を変えて実行しないとわかりにくいかもしれない。</p><ul><li><a href=https://flywaydb.org/documentation/tutorials/baselineMigrations>Tutorial: Baseline Migrations</a></li></ul></div></article><div class=pagination><div class=pagination__buttons></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2024 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>