<!doctype html><html lang=en><head><title>mongodb :: forest nook</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/tags/mongodb/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="mongodb"><meta property="og:description" content><meta property="og:url" content="/diary/tags/mongodb/"><meta property="og:site_name" content="forest nook"><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/tags/mongodb/index.xml rel=alternate type=application/rss+xml title="forest nook"></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><div class=posts><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1101/>穴場のビアバー</a></h1><div class=post-meta><time class=post-date>2023-11-01 (Wed.) ::</time></div><span class=post-tags>#<a href=/diary/tags/food/>food</a>&nbsp;
#<a href=/diary/tags/project-management/>project management</a>&nbsp;
#<a href=/diary/tags/mongodb/>mongodb</a>&nbsp;
#<a href=/diary/tags/drinking/>drinking</a>&nbsp;</span>
<img src=/diary/img/2023/1101_autumn.jpg class=post-cover alt=穴場のビアバー title="Cover Image"><div class=post-content><p>0時に寝て何度か起きて6時半に起きた。移動日の疲れもあってか、いつもよりよく眠れた気がする。</p><h2 id=朝食バイキング>朝食バイキング</h2><p><a href=/diary/posts/2023/0919/#大崎に泊まる>先々月から大崎探索</a> をしていて <a href=https://www.newotani-inntokyo.jp/>ニューオータニイン東京</a> に泊まってみた。川沿いの道を歩きながら朝食バイキングもおいしい。食品の品数があると満足度が高い。</p><figure><img src=/diary/img/2023/1101_breakfast.jpg></figure><h2 id=プロジェクトの進捗報告>プロジェクトの進捗報告</h2><p>出張したときの月例報告の11回目。<a href=/diary/posts/2023/0920/>前回の進捗報告はこちら</a> 。</p><p>まだ開発の序盤なので <a href=/diary/posts/2023/1028/#近況報告の資料作り>事前に準備した資料</a> の内容を一通り終えて雑談の時間も多かったように思う。3回目の開発フェーズになるのもあり、メンバーの練度も上がって、開発の手際はかなりよくなっているように私からはみえている。それらも含めて、メンバーが自律的に issue を作ったり、タスクを自分に割り当てたりしながら開発が進むようになっていると報告した。プロジェクトオーナーからも、最近のマイルストーン定例をみていて、メンバーが気付きが増えている、自律的によくないところを改善しようという意思がみえるといった話題も出ていた。課題管理のプラクティスを実践してきて、着実によい開発者の習慣を身につけて、よい開発チームに育ってきているように、私からもみえている。あとは課題管理についてのコンテンツを私が書かないといけないのを、バーンナウトの影響もあってか、先月はさぼってしまっていたので、今月こそなんか書きますと、自分を追い込む意図でもその場で話題にした。</p><h2 id=mongo-とトランザクションとレプリカセット>mongo とトランザクションとレプリカセット</h2><p>mongo には <a href=https://www.mongodb.com/docs/manual/core/transactions/>トランザクション</a> の機能が提供されている。しかし、トランザクションを使うためには <a href=https://www.mongodb.com/docs/v7.0/replication/>レプリケーション</a> を有効にしないといけない。レプリケーションは通常は複数台のマシンでクラスタリングを構築するものになる。うちらはシングルノードの mongo を扱っているのでレプリケーションを必要としていない。それでも、ドキュメントを読んでいると、スタンドアローンでも本番環境ではレプリカセットを使う方がよいといった説明もみつかる。</p><ul><li><a href=https://www.mongodb.com/docs/manual/tutorial/convert-standalone-to-replica-set/>Convert a Standalone mongod to a Replica Set</a></li></ul><p>ちょうど開発の要件としてトランザクションを必要とする状況も出てきた。mongo のレプリケーションやトランザクションの仕組みを理解するよい機会かもしれない。11月中には調査したいというところ。</p><h2 id=エビスバー>エビスバー</h2><p>大崎探検の2日目。<a href=https://www.ginzalion.jp/shop/brand/yebisubar/shop60.html>YEBISU BAR 大崎店</a> へ行ってみた。大崎駅横の駅ビルの2階にある。アクセスもよい。水曜日なのに20-21時半ぐらいまでいて、お客さんは3組ぐらしかいなかった。よい意味で空いてて静かにゆっくり飲めてよかった。穴場のバーをみつけた。ビール2杯とつまみ2品でちょうど3000円程度。ちょっと割高かもしれないけど、場所とお店の雰囲気とゆっくりできたことを考慮するとちょうどよい価格帯にも思える。またゆっくり軽く飲みたいときに行こうと思う。</p><p><figure><img src=/diary/img/2023/1101_beer.jpg></figure><figure><img src=/diary/img/2023/1101_salad.jpg></figure><figure><img src=/diary/img/2023/1101_potate.jpg></figure></p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1004/>相続税の申告の一歩手前</a></h1><div class=post-meta><time class=post-date>2023-10-04 (Wed.) ::</time></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/tax/>tax</a>&nbsp;
#<a href=/diary/tags/mongodb/>mongodb</a>&nbsp;</span><div class=post-content><p>22時頃から寝始めて何度か起きて6時に起きた。早寝早起き。</p><h2 id=会計士事務所への訪問>会計士事務所への訪問</h2><p>相続税の申告手続きを未だにやっている。</p><p>父が失くなったのが <a href=/diary/posts/2022/1226/>昨年の12月26日</a> になる。相続税は死亡を知った日から10ヶ月以内と期限が決められている。それを過ぎると算税や延滞税などのペナルティが科せられる。うちの期限は10月26日になる。1-3月ぐらい葬儀やらお仕事やらで忙しかったものの、4月ぐらいから相続の手続きに着手した。5月29日に親族の相続関連の書類を取りまとめて弁護士さんへ送付した。それから銀行口座の解約やら司法書士さんやら税理士さんの作業やらなんやらあって、いまもまだ会計士さんに申告の書類を作ってもらっているところ。その過程でいくつか質疑応答があってそれを調査したりしている。</p><p>その会計士さんの事務所が近所にあるのでお昼に訪問して挨拶してきた。申告に必要な書類の提出をしつつ軽く打ち合わせをした。税務署は20年遡って口座のお金を動きを調べるらしい。話しているときに死亡保険金とかないですか？と聞かれて、母が受けとったと話していたなと思い出して、それも父の遺産として扱う必要がありますと言われて、確かにそうだと思って申告漏れしていることに気付いた。これで死亡保険金の書類が必要になってまた取り寄せに時間がかかる。こんな感じに五月雨式に遅れていくので10ヶ月ぎりぎりになりそうな雰囲気。来週中に申告が終わる嬉しいなといったところ。</p><h2 id=mongodb-の初期化ツール>mongodb の初期化ツール</h2><p>ちょっと前から少しずつ mongodb の初期化ツールを作っている。コレクションの作成ならびにインデックスの追加を、さらに初期データの投入も制御したい。mongodb のバージョンが 6.0.x のときは作成済みのコレクションに対して同じ設定で作成しようとすると、既に作成済みというエラーが発生していた。それが 7.0.x になってエラーにならないようになっていることに気付いた。調べてみると、次の issue で同じ設定なら作成の結果に関係なく冪等であるのでエラーとして扱わなくてよいという考え方になる。</p><ul><li><a href=https://jira.mongodb.org/browse/SERVER-60064>Make create command idempotent on mongod</a></li></ul><p>これは初期化ツールを作っている私にとっては朗報で、同じコレクションに対して複数の操作をしても変更した設定だけが有効になるといった振る舞いをする。こういう細かい所もバージョンアップをしながら改善していくことが伺えて学びになった。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0914/>資料作りの一日</a></h1><div class=post-meta><time class=post-date>2023-09-14 (Thu.) ::</time></div><span class=post-tags>#<a href=/diary/tags/project-management/>project management</a>&nbsp;
#<a href=/diary/tags/issue-management/>issue management</a>&nbsp;
#<a href=/diary/tags/issue-tracking-system/>issue tracking system</a>&nbsp;
#<a href=/diary/tags/gitlab/>gitlab</a>&nbsp;
#<a href=/diary/tags/mongodb/>mongodb</a>&nbsp;</span><div class=post-content><p>23時に寝て何度か起きて6時に起きた。疲労も溜まっているのでなるべく早く寝るように努めている。旅行中ずっと早起きしていたから早起きするのは苦にならない。</p><h2 id=今開発の大きなふりかえりの資料作り>今開発の大きなふりかえりの資料作り</h2><p>ふりかえりのために課題管理システムの issue 情報から統計的な数値を取得する。</p><p>gitlab の <a href=https://gitlab.com/gitlab-org/cli>cli</a> ツールを使って issue 情報を取得して mongodb にインポートする。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ glab api --paginate <span style=color:#e6db74>&#34;groups/product%2Funicorncidm/issues?milestone=2023-09-05&amp;not[labels]=Duplicate,Invalid,Wontfix&#34;</span> | jq -c <span style=color:#e6db74>&#39;.[]&#39;</span> &gt; 2023-09-05-issues.json
</span></span><span style=display:flex><span>$ mongoimport --authenticationDatabase<span style=color:#f92672>=</span>admin --uri <span style=color:#e6db74>&#34;mongodb://root:secret@localhost:27017&#34;</span> --db gitlab --collection issues 2023-09-05-issues.json
</span></span></code></pre></div><p>mongodb で aggregation (sql で言うところの group by 句に相当する) するときはパイプライン処理を実装する。例えば、最初にデータをフィルターして、次にグルーピングして、最後にソートするのは次のようなパラメーターになる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ mongosh --username root --password secret
</span></span><span style=display:flex><span>test&gt; use gitlab
</span></span><span style=display:flex><span>gitlab&gt; db.issues.aggregate<span style=color:#f92672>([</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>{</span> $match: <span style=color:#f92672>{</span> $or: <span style=color:#f92672>[</span> <span style=color:#f92672>{</span> <span style=color:#e6db74>&#34;milestone.title&#34;</span>: <span style=color:#e6db74>&#34;2023-09-05&#34;</span> <span style=color:#f92672>}</span>,<span style=color:#f92672>{</span> <span style=color:#e6db74>&#34;milestone.title&#34;</span>: <span style=color:#e6db74>&#34;2023-09-19&#34;</span> <span style=color:#f92672>}</span> <span style=color:#f92672>]</span> <span style=color:#f92672>}</span> <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>{</span> $group: <span style=color:#f92672>{</span> <span style=color:#e6db74>&#34;_id&#34;</span>: <span style=color:#f92672>{</span> milestone: <span style=color:#e6db74>&#34;</span>$milestone<span style=color:#e6db74>.title&#34;</span> , author: <span style=color:#e6db74>&#34;</span>$author<span style=color:#e6db74>.username&#34;</span> <span style=color:#f92672>}</span>, councount: <span style=color:#f92672>{</span> <span style=color:#e6db74>&#34;</span>$sum<span style=color:#e6db74>&#34;</span>: <span style=color:#ae81ff>1</span> <span style=color:#f92672>}</span> <span style=color:#f92672>}</span> <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>{</span> $sort: <span style=color:#f92672>{</span> _id: <span style=color:#ae81ff>1</span> <span style=color:#f92672>}</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>])</span>
</span></span></code></pre></div><p>これで前回の開発のときに取得した数値と今回の開発の数値を比較してみると、いろいろわかることもあって、メンバーが成長していることも伺えて、課題管理をしながら開発を進めることのメリットを実感できる開発になったのではないかと思う。gitlab のアクティビティ図 (草生え図) をみても前回の開発よりも草がたくさん生えているので課題管理に習熟している様子が伺える。これをあと2-3年ぐらいすれば、課題管理を使いこなせる一般の開発者になるのではないかと思う。課題管理 + イテレーション開発でチームビルディングしていくところの、地盤のようなものはできたようにみえる。</p><p>この草生え図を匿名化して利用許可をもらって、うちの会社でいうところの課題管理ができるようになると、メンバーの働き方はこうなるというサンプルとして紹介させてもらうつもり。また来週メンバーにもその許諾を取ろうと思う。</p><h2 id=次開発の要件打ち合わせの資料作り>次開発の要件打ち合わせの資料作り</h2><p>今開発を始めるときに洗い出した要件の未対応のものと、今開発でやり残した非機能要件の開発課題を資料にまとめてたたき台とした。それだけでも3-4ヶ月分の開発課題になりそうだし、アーキテクチャとして大きな意思決定も1つある。私自身、7割型は決まっているが、考え方や要件によってはもう1つの案でいくのもよいかもしれない。機能要件は実際にお客さん先へ導入するときにもいくつか出てくるだろうけれど、非機能要件の運用に影響を与える懸念のところはなるべく早く改善しておきたい。次の開発期間にそこだけ対応すれば、一定の安心をもってお客さんへ提供できるようになると思う。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0816/>お盆の最終日</a></h1><div class=post-meta><time class=post-date>2023-08-16 (Wed.) ::</time></div><span class=post-tags>#<a href=/diary/tags/drinking/>drinking</a>&nbsp;
#<a href=/diary/tags/mongodb/>mongodb</a>&nbsp;
#<a href=/diary/tags/testing/>testing</a>&nbsp;
#<a href=/diary/tags/writing/>writing</a>&nbsp;</span><div class=post-content><p>1時に寝て何度か起きて8時半に起きた。数ヶ月に1回ぐらいの頻度でしかないことだけど寝坊した。起きたら8時半であれ？と思った。起きてから家でそのぐらいの時間までだらだらするのはちょくちょくあることだけど、気付かず寝てたのは久しぶりだった。</p><h2 id=台風が過ぎた後の焼き鳥屋さん>台風が過ぎた後の焼き鳥屋さん</h2><p>今朝に寝坊した理由はこれだと思うけれど、昨日の22時から晩ご飯を求めて仲のよい焼き鳥屋さんへ行ってきた。台風で9割以上のお店が閉めている中、唯一と言っていいぐらいの珍しさで開いてた。そのお店 (グループ) のオーナーは雨が降ろうが槍が降ろうが営業日は開けるという方針らしい。マスターも夕方から台風は過ぎて雨も弱まっていたので普通に営業していたらしい。しかし、お客さんは数グループと少なかったと仰っていた。私が22時に行って誰もいなくて24時までいたけれど、誰も来なかった。通常なら22時だと他に2-3グループはいて、その後も最低でも1グループは飲みにやってくるぐらいの人気のある焼き鳥屋さんだ。そもそも駅から人が出てこないし、道にも人が歩いていない。物流も止まっていたのでいくつか仕入れが出来なくて提供できないメニューもあった。</p><p>いつもなら2杯飲んで帰るところを、こんな日だから売上に貢献しようと思って3杯飲んで寝坊した気がする。</p><h2 id=mongodb-700-リリース>mongodb 7.0.0 リリース</h2><p>ちょうど qa テスト前で mongodb のメジャーバージョンがリリースされそうなので毎週のようにチェックしていた。rc10 までいって ga されたみたい。</p><ul><li><a href=https://www.mongodb.com/community/forums/t/mongodb-7-0-0-is-released/239732>MongoDB 7.0.0 is released</a></li></ul><p>まだ docker hub には正式なリリースバージョンのコンテナイメージは公開されていない。しかし、rc10 が ga になったはずなのでひとまずはそれを使って開発環境とテスト環境を 7.0.0 に移行した。うちの用途だと ttl インデックスを作り直す以外には移行作業は必要なかった。自動テストはそのまま成功したし、テスト環境のデータもそのまま移行してパッとみた感じでは正常に動いている。来週から qa テストも始まるのでぎりぎり間に合ったというところ。<a href=https://www.mongodb.com/support-policy/lifecycles>MongoDB Software Lifecycle Schedules</a> によると、だいたい mongodb は3年サポートされる。メジャーバージョンが年に1回リリースされているようにみえるので、いまメジャーバージョンを上げておくと1年余裕をもって運用できる。</p><h2 id=テックブログの執筆開始>テックブログの執筆開始</h2><p>お昼からテックブログの執筆に着手した。あまり大きな意味はないのだけど、お手伝い先のテックブログの記事を早く3つ書きたかった。別に三部作というわけでもない。けれど、テックブログ書いてますよと他者へ伝えるときに最低3つぐらい記事を書いていないと、全然書いてないやんと私なら思ってしまう。3つぐらいあれば、この人はこういう技術に関心があるんだ、こんな業務をやっているんだ、内容もしっかり書けているねとか、そういう判断を下すことができる最低限のコンテンツ量と言えるのではないだろうか。私にとってはそれが3つの記事と言える。<a href=/diary/posts/2023/0815/#課題管理とプロジェクトマネージメントの話を熱く語る>ちょっと前に公開した podcast</a> でテックブログの記事を読んでくださいと話したのでリスナーが聞く前に増やしておきたい。ちょうどプロダクトのプレスリリースも出たのでその宣伝も兼ねられるし、勉強会のネタにもなるし、私の義務感を軽減してストレス解消にもなるし、ここは踏ん張って今日・明日で下書きを書き終えたい。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0809/>年一ゲストの podcast 収録</a></h1><div class=post-meta><time class=post-date>2023-08-09 (Wed.) ::</time></div><span class=post-tags>#<a href=/diary/tags/mongodb/>mongodb</a>&nbsp;
#<a href=/diary/tags/performance/>performance</a>&nbsp;
#<a href=/diary/tags/audio-media/>audio media</a>&nbsp;
#<a href=/diary/tags/llm/>llm</a>&nbsp;</span><div class=post-content><p>夕方に寝て晩ご飯食べてきて23時に寝て7時に起きた。起きてから podcast のネタ帳を書いていた。本当は前日の夜に書くと宣言したものの、夜は眠くて普通に寝てた。</p><h2 id=mongodb-のインデックス追加>mongodb のインデックス追加</h2><p>テスト環境の履歴テーブルにドキュメントが135万件ほど入っている。管理画面の履歴一覧を表示すると、一覧がレンダリングされるのに約1秒かかるようになった。遅い。インデックスなしでフルスキャンしているのでデフォルトのソートキーのインデックスが必要なことはすぐに想定できた。実際に <a href=https://www.mongodb.com/ja-jp/products/compass>compass</a> でクエリを explain で実行してみるとフルスキャンしていることと、どのぐらいの時間がかかっているのかを計測できた。</p><figure><img src=/diary/img/2023/0809_mongodb-explain1.png></figure><p>デフォルトのソートキーのインデックスを追加すると explain の画面で数十 msec かかっていた時間が解消された。ソートキーに対して自動的にインデックスが使われることもわかった。</p><figure><img src=/diary/img/2023/0809_mongodb-explain2.png></figure><p>管理画面からも数十 msec で一覧が表示されるようになった。私の感覚ではひと昔のデータベースは10万件を超えたら1秒ぐらいかかった気はするが、いまはマシンスペックもミドルウェアの性能も上がっているのでそれが100万件超になったんだなという印象。実運用だとすぐに発生する問題が普通の開発をしていると気付きにくくなる懸念があることを学んだ。</p><h2 id=podcast-収録>podcast 収録</h2><p>お仕事を終えてから、年一ゲストとして出演している <a href=https://podcast.terapyon.net/>terapyon channel</a> の podcast の収録へ行ってきた。本当は6月頃に出演依頼が来ていたのを、私がお手伝いしている開発のプレスリリースや事例紹介が終わってからの方が話せる内容が多くてよいということで延期してもらっていた。事例紹介はまだ公開できていないけれど、別に事例紹介なくても先方にうちの会社が手伝っていることを公開してよい許可はもらっているので podcast の中で話してもまったく問題ない。</p><p>昨日てらださんとたまたまやり取りしていたときに、せっかく東京に来ているのでオフラインで収録しては？と言ったらその方向になって、翌日即収録という行き当たりばったりやっつけ計画で話しが進んだ。非商用の podcast で話すのでそこまで品質に責任をもつ必要もない。19時半にてらださんの会社のオフィスへ伺い、20時頃から収録を始めて、なんやらかんやら盛り上がって言いたい放題言って、2時間経っていた。オンラインで収録するよりも、オフラインの方がずっと多くのことを短い時間で話せるように感じた。相槌うったり会話の掛け合いがしやすいので間が短い気がする。内容的にはちょっと話し過ぎで聞く人は疲れて最後まで聞いてもらえないかもしれない。その後、近くの居酒屋さんへ飲みに行って1時間ほど飲んで24時前にはホテルへ戻ってきた。楽しかったー。</p><p>てらださんの近況の中に llm を使ってサービスを開発するときに <a href=https://www.langchain.com/>LangChain</a> というツールがあって、これを使うと簡単にいろんな言語処理ができて楽しいといったことを共有してもらった。いまは触る余裕がないけれど、覚えておきたい。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0703/>リフレクションにはまった半日</a></h1><div class=post-meta><time class=post-date>2023-07-03 (Mon.) ::</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/ldap/>ldap</a>&nbsp;
#<a href=/diary/tags/mongodb/>mongodb</a>&nbsp;
#<a href=/diary/tags/reflection/>reflection</a>&nbsp;</span><div class=post-content><p>23時に寝て5時に起きて6時半に起きた。ストレッチで伸ばしたせいか、いつもよりよく眠れた。先週は主に旅行へ行っていて非日常でリフレッシュした。今朝は朝ご飯に野菜サラダを作って食べて7時半には家を出れた。</p><h2 id=非同期の-ldap-検索の-api>非同期の ldap 検索の api</h2><p>先日送った <a href=/diary/posts/2023/0601/#チャンネルを用いた-ldap-検索の-api>go-ldap の pr</a> を完了した。送ったときはチャンネル用いた検索 api だったのだけど、それから設計を議論して非同期検索を主とした api として生まれ変わった。レビューに1ヶ月を要したものの2人のメンバーから approve をもらって無事にマージされた。</p><ul><li><a href=https://github.com/go-ldap/ldap/pull/440>Add search asynchronously with context #440</a></li></ul><p>この一歩は大きくてこの機能を突破口にうちらの要件に足りない機能を実装していく。プロトコル部分の修正が過去の draft 実装から参考にできるのであれば今週中にはまた pr を送りたい。</p><h2 id=mongodb-の-unmarshal-実装>mongodb の unmarshal 実装</h2><p>mongodb-driver での bson の marshal/unmarshal を実装する。<a href=https://pkg.go.dev/go.mongodb.org/mongo-driver/bson>mongo-driver/bson</a> に unmarshal について2つの interface が紹介されている。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Unmarshaler</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>UnmarshalBSON</span>([]<span style=color:#66d9ef>byte</span>) <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ValueUnmarshaler</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>UnmarshalBSONValue</span>(<span style=color:#a6e22e>bsontype</span>.<span style=color:#a6e22e>Type</span>, []<span style=color:#66d9ef>byte</span>) <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>bson の byte 列を unmarshal するにあたり、構造体そのものには <code>UnmarshalBSON()</code> を、構造体のメンバーには <code>UnmarshalBSONValue()</code> を使う。これでうまくいきそうに思えたのだけど、interface を介したデコード処理で意図した振る舞いにならないことに気付いた。mongodb-driver は decode/unmarshal 処理を <a href=https://pkg.go.dev/reflect>reflect</a> を使って実装している。要件の詳細は省く (interface を使いたい背景がある) が、再現コードが次になる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>MyInterface</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MyFunc</span>() <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>MyType</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>MyType</span>) <span style=color:#a6e22e>MyFunc</span>() <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>tMyInterface</span> = <span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>TypeOf</span>((<span style=color:#f92672>*</span><span style=color:#a6e22e>MyInterface</span>)(<span style=color:#66d9ef>nil</span>)).<span style=color:#a6e22e>Elem</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>some</span>(<span style=color:#a6e22e>v</span> <span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>Value</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>f</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>v</span>.<span style=color:#a6e22e>Convert</span>(<span style=color:#a6e22e>tMyInterface</span>).<span style=color:#a6e22e>MethodByName</span>(<span style=color:#e6db74>&#34;MyFunc&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;got&#34;</span>, <span style=color:#a6e22e>f</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;=========&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>t1</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>MyType</span>{}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>some</span>(<span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>ValueOf</span>(<span style=color:#a6e22e>t1</span>))
</span></span><span style=display:flex><span>	<span style=color:#75715e>// the zero value of an interface is nil
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>t2</span> <span style=color:#a6e22e>MyInterface</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>some</span>(<span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>ValueOf</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>t2</span>).<span style=color:#a6e22e>Elem</span>())
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>このコードを実行すると次のエラーになる。</p><pre tabindex=0><code>panic: reflect: Method on nil interface value
</code></pre><p>ドキュメントにも interface の nil の値を呼び出すと panic するよと書いてある。</p><blockquote><p>Method returns a function value corresponding to v&rsquo;s i&rsquo;th method. The arguments to a Call on the returned function should not include a receiver; the returned function will always use v as the receiver. Method panics if i is out of range or if v is a nil interface value.</p><p><a href=https://pkg.go.dev/reflect#Value.Method>https://pkg.go.dev/reflect#Value.Method</a></p></blockquote></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0511/>gitlab issues と mongodb による分析</a></h1><div class=post-meta><time class=post-date>2023-05-11 (Thu.) ::</time></div><span class=post-tags>#<a href=/diary/tags/gitlab/>gitlab</a>&nbsp;
#<a href=/diary/tags/mongodb/>mongodb</a>&nbsp;
#<a href=/diary/tags/cli/>cli</a>&nbsp;</span><div class=post-content><p>0時に寝て何度か起きて7時に起きた。今日も一日資料作りをしていた。</p><h2 id=gitlab-issues-の解析>gitlab issues の解析</h2><p>ふりかえりの資料を作っていて gitlab issues の解析を始めた。gitlab にも分析系機能は提供されているが、大半が有償機能で free では使えない。実質 free で役に立ちそうなレポートを私はみつけられなかった。</p><ul><li><a href=https://docs.gitlab.com/ee/user/analytics/>Analyze GitLab usage</a></li></ul><p>gitlab は <a href=https://gitlab.com/gitlab-org/cli>glab cli</a> というツールを提供している。試しに glab を使って issues の解析ができないかとやってみたが、グループ単位ではなくプロジェクト単位でしか操作できないようにみえた。そこで rest api を呼び出すための便利ツールとして使うことにした。要は rest api で任意のデータを取得してそれを使ってローカルで解析することにした。例えば、次のようにして特定ラベルを除外した特定グループのマイルストーンごとの issues をすべて取得できる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ mygrpid<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;xxx&#34;</span>
</span></span><span style=display:flex><span>$ milestones<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;2022-11 2022-12 2023-01 2023-02 2023-03 2023-04&#34;</span>
</span></span><span style=display:flex><span>$ <span style=color:#66d9ef>for</span> i in $milestones; <span style=color:#66d9ef>do</span> echo $i; glab api --paginate <span style=color:#e6db74>&#34;groups/</span><span style=color:#e6db74>${</span>mygrpid<span style=color:#e6db74>}</span><span style=color:#e6db74>/issues?milestone=</span><span style=color:#e6db74>${</span>i<span style=color:#e6db74>}</span><span style=color:#e6db74>&amp;not[labels]=Duplicate,Invalid,Wontfix&#34;</span> | jq -c <span style=color:#e6db74>&#39;.[]&#39;</span> &gt; <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>i<span style=color:#e6db74>}</span><span style=color:#e6db74>-issues.json&#34;</span>; <span style=color:#66d9ef>done</span>
</span></span></code></pre></div><p>あとはこの json データをそのまま分析のためのデータベースに取り込む。今回は mongodb にインポートしてみた。mongodb だとスキーマを定義しなくても json データをそのままインポートできてアドホックな分析に便利そうに思えた。オブジェクトの入れ子構造をもつ json データのようなものを rdbms にインポートするのはひと工夫必要なことから json データをそのままインポートできるドキュメントデータベースの有効性を理解できた。インポートしたら <a href=https://www.mongodb.com/products/shell>MongoDB Shell</a> を使うとてっとり早い。例えば、マイルストーンごとの issues の件数などは次のようにして集計できる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gitlab&gt; db.issues.aggregate<span style=color:#f92672>([{</span> $group: <span style=color:#f92672>{</span> <span style=color:#e6db74>&#34;_id&#34;</span>: <span style=color:#e6db74>&#34;</span>$milestone<span style=color:#e6db74>.title&#34;</span>, count: <span style=color:#f92672>{</span> <span style=color:#e6db74>&#34;</span>$sum<span style=color:#e6db74>&#34;</span>: <span style=color:#ae81ff>1</span> <span style=color:#f92672>}</span> <span style=color:#f92672>}</span> <span style=color:#f92672>}</span>, <span style=color:#f92672>{</span> $sort: <span style=color:#f92672>{</span> _id: <span style=color:#ae81ff>1</span> <span style=color:#f92672>}}])</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>{</span> _id: <span style=color:#e6db74>&#39;2022-11&#39;</span>, count: <span style=color:#ae81ff>348</span> <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>{</span> _id: <span style=color:#e6db74>&#39;2022-12&#39;</span>, count: <span style=color:#ae81ff>346</span> <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>{</span> _id: <span style=color:#e6db74>&#39;2023-01&#39;</span>, count: <span style=color:#ae81ff>338</span> <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>{</span> _id: <span style=color:#e6db74>&#39;2023-02&#39;</span>, count: <span style=color:#ae81ff>357</span> <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>{</span> _id: <span style=color:#e6db74>&#39;2023-03&#39;</span>, count: <span style=color:#ae81ff>347</span> <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>{</span> _id: <span style=color:#e6db74>&#39;2023-04&#39;</span>, count: <span style=color:#ae81ff>336</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>]</span>
</span></span></code></pre></div><p>担当者別に <code>Enhance</code> ラベルが付いた issues の件数を数えるときには次のようになる。sql を使えないというデメリットを json データをそのままインポートできるメリットの方が上回るときは mongodb のクエリを学ぶ機会になる。私も mongodb の aggregation の実行方法をドキュメントみながらやってた。全然わからないので慣れが必要になる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gitlab&gt; db.issues.aggregate<span style=color:#f92672>([{</span> $group: <span style=color:#f92672>{</span> <span style=color:#e6db74>&#34;_id&#34;</span>: <span style=color:#f92672>{</span> assignee: <span style=color:#e6db74>&#34;</span>$assignee<span style=color:#e6db74>.username&#34;</span>, enhance: <span style=color:#f92672>{</span>$in: <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;Enhance&#34;</span>, <span style=color:#e6db74>&#34;</span>$labels<span style=color:#e6db74>&#34;</span><span style=color:#f92672>]}</span> <span style=color:#f92672>}</span>, count: <span style=color:#f92672>{</span> <span style=color:#e6db74>&#34;</span>$sum<span style=color:#e6db74>&#34;</span>: <span style=color:#ae81ff>1</span> <span style=color:#f92672>}</span> <span style=color:#f92672>}</span> <span style=color:#f92672>}</span>, <span style=color:#f92672>{</span>$match: <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;_id.enhance&#34;</span>: true<span style=color:#f92672>}}</span>, <span style=color:#f92672>{</span> $sort: <span style=color:#f92672>{</span> _id: <span style=color:#ae81ff>1</span> <span style=color:#f92672>}}])</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>{</span> _id: <span style=color:#f92672>{</span> assignee: <span style=color:#e6db74>&#39;bob&#39;</span>, enhance: true <span style=color:#f92672>}</span>, count: <span style=color:#ae81ff>84</span> <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>{</span> _id: <span style=color:#f92672>{</span> assignee: <span style=color:#e6db74>&#39;john&#39;</span>, enhance: true <span style=color:#f92672>}</span>, count: <span style=color:#ae81ff>143</span> <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>{</span> _id: <span style=color:#f92672>{</span> assignee: <span style=color:#e6db74>&#39;mary&#39;</span>, enhance: true <span style=color:#f92672>}</span>, count: <span style=color:#ae81ff>53</span> <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>{</span> _id: <span style=color:#f92672>{</span> assignee: <span style=color:#e6db74>&#39;parks&#39;</span>, enhance: true <span style=color:#f92672>}</span>, count: <span style=color:#ae81ff>78</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>]</span>
</span></span></code></pre></div></div></article><div class=pagination><div class=pagination__buttons><a href=/diary/tags/mongodb/page/2/ class="button next"><span class=button__text>過去の日記</span>
<span class=button__icon>→</span></a></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>© 2021 Tetsuya Morimoto</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>