<!doctype html><html lang=en><head><title>mongodb :: forest nook</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/tags/mongodb/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="mongodb"><meta property="og:description" content><meta property="og:url" content="/diary/tags/mongodb/"><meta property="og:site_name" content="forest nook"><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/tags/mongodb/index.xml rel=alternate type=application/rss+xml title="forest nook"></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><div class=posts><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0511/>gitlab issues と mongodb による分析</a></h1><div class=post-meta><time class=post-date>2023-05-11 (Thu.) ::</time></div><span class=post-tags>#<a href=/diary/tags/gitlab/>gitlab</a>&nbsp;
#<a href=/diary/tags/mongodb/>mongodb</a>&nbsp;
#<a href=/diary/tags/cli/>cli</a>&nbsp;</span><div class=post-content><p>0時に寝て何度か起きて7時に起きた。今日も一日資料作りをしていた。</p><h2 id=gitlab-issues-の解析>gitlab issues の解析</h2><p>ふりかえりの資料を作っていて gitlab issues の解析を始めた。gitlab にも分析系機能は提供されているが、大半が有償機能で free では使えない。実質 free で役に立ちそうなレポートを私はみつけられなかった。</p><ul><li><a href=https://docs.gitlab.com/ee/user/analytics/>Analyze GitLab usage</a></li></ul><p>gitlab は <a href=https://gitlab.com/gitlab-org/cli>glab cli</a> というツールを提供している。試しに glab を使って issues の解析ができないかとやってみたが、グループ単位ではなくプロジェクト単位でしか操作できないようにみえた。そこで rest api を呼び出すための便利ツールとして使うことにした。要は rest api で任意のデータを取得してそれを使ってローカルで解析することにした。例えば、次のようにして特定ラベルを除外した特定グループのマイルストーンごとの issues をすべて取得できる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ mygrpid<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;xxx&#34;</span>
</span></span><span style=display:flex><span>$ milestones<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;2022-11 2022-12 2023-01 2023-02 2023-03 2023-04&#34;</span>
</span></span><span style=display:flex><span>$ <span style=color:#66d9ef>for</span> i in $milestones; <span style=color:#66d9ef>do</span> echo $i; glab api --paginate <span style=color:#e6db74>&#34;groups/</span><span style=color:#e6db74>${</span>mygrpid<span style=color:#e6db74>}</span><span style=color:#e6db74>/issues?milestone=</span><span style=color:#e6db74>${</span>i<span style=color:#e6db74>}</span><span style=color:#e6db74>&amp;not[labels]=Duplicate,Invalid,Wontfix&#34;</span> | jq -c <span style=color:#e6db74>&#39;.[]&#39;</span> &gt; <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>i<span style=color:#e6db74>}</span><span style=color:#e6db74>-issues.json&#34;</span>; <span style=color:#66d9ef>done</span>
</span></span></code></pre></div><p>あとはこの json データをそのまま分析のためのデータベースに取り込む。今回は mongodb にインポートしてみた。mongodb だとスキーマを定義しなくても json データをそのままインポートできてアドホックな分析に便利そうに思えた。オブジェクトの入れ子構造をもつ json データのようなものを rdbms にインポートするのはひと工夫必要なことから json データをそのままインポートできるドキュメントデータベースの有効性を理解できた。インポートしたら <a href=https://www.mongodb.com/products/shell>MongoDB Shell</a> を使うとてっとり早い。例えば、マイルストーンごとの issues の件数などは次のようにして集計できる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gitlab&gt; db.issues.aggregate<span style=color:#f92672>([{</span> $group: <span style=color:#f92672>{</span> <span style=color:#e6db74>&#34;_id&#34;</span>: <span style=color:#e6db74>&#34;</span>$milestone<span style=color:#e6db74>.title&#34;</span>, count: <span style=color:#f92672>{</span> <span style=color:#e6db74>&#34;</span>$sum<span style=color:#e6db74>&#34;</span>: <span style=color:#ae81ff>1</span> <span style=color:#f92672>}</span> <span style=color:#f92672>}</span> <span style=color:#f92672>}</span>, <span style=color:#f92672>{</span> $sort: <span style=color:#f92672>{</span> _id: <span style=color:#ae81ff>1</span> <span style=color:#f92672>}}])</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>{</span> _id: <span style=color:#e6db74>&#39;2022-11&#39;</span>, count: <span style=color:#ae81ff>348</span> <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>{</span> _id: <span style=color:#e6db74>&#39;2022-12&#39;</span>, count: <span style=color:#ae81ff>346</span> <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>{</span> _id: <span style=color:#e6db74>&#39;2023-01&#39;</span>, count: <span style=color:#ae81ff>338</span> <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>{</span> _id: <span style=color:#e6db74>&#39;2023-02&#39;</span>, count: <span style=color:#ae81ff>357</span> <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>{</span> _id: <span style=color:#e6db74>&#39;2023-03&#39;</span>, count: <span style=color:#ae81ff>347</span> <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>{</span> _id: <span style=color:#e6db74>&#39;2023-04&#39;</span>, count: <span style=color:#ae81ff>336</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>]</span>
</span></span></code></pre></div><p>担当者別に <code>Enhance</code> ラベルが付いた issues の件数を数えるときには次のようになる。sql を使えないというデメリットを json データをそのままインポートできるメリットの方が上回るときは mongodb のクエリを学ぶ機会になる。私も mongodb の aggregation の実行方法をドキュメントみながらやってた。全然わからないので慣れが必要になる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gitlab&gt; db.issues.aggregate<span style=color:#f92672>([{</span> $group: <span style=color:#f92672>{</span> <span style=color:#e6db74>&#34;_id&#34;</span>: <span style=color:#f92672>{</span> assignee: <span style=color:#e6db74>&#34;</span>$assignee<span style=color:#e6db74>.username&#34;</span>, enhance: <span style=color:#f92672>{</span>$in: <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;Enhance&#34;</span>, <span style=color:#e6db74>&#34;</span>$labels<span style=color:#e6db74>&#34;</span><span style=color:#f92672>]}</span> <span style=color:#f92672>}</span>, count: <span style=color:#f92672>{</span> <span style=color:#e6db74>&#34;</span>$sum<span style=color:#e6db74>&#34;</span>: <span style=color:#ae81ff>1</span> <span style=color:#f92672>}</span> <span style=color:#f92672>}</span> <span style=color:#f92672>}</span>, <span style=color:#f92672>{</span>$match: <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;_id.enhance&#34;</span>: true<span style=color:#f92672>}}</span>, <span style=color:#f92672>{</span> $sort: <span style=color:#f92672>{</span> _id: <span style=color:#ae81ff>1</span> <span style=color:#f92672>}}])</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>{</span> _id: <span style=color:#f92672>{</span> assignee: <span style=color:#e6db74>&#39;bob&#39;</span>, enhance: true <span style=color:#f92672>}</span>, count: <span style=color:#ae81ff>84</span> <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>{</span> _id: <span style=color:#f92672>{</span> assignee: <span style=color:#e6db74>&#39;john&#39;</span>, enhance: true <span style=color:#f92672>}</span>, count: <span style=color:#ae81ff>143</span> <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>{</span> _id: <span style=color:#f92672>{</span> assignee: <span style=color:#e6db74>&#39;mary&#39;</span>, enhance: true <span style=color:#f92672>}</span>, count: <span style=color:#ae81ff>53</span> <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>{</span> _id: <span style=color:#f92672>{</span> assignee: <span style=color:#e6db74>&#39;parks&#39;</span>, enhance: true <span style=color:#f92672>}</span>, count: <span style=color:#ae81ff>78</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>]</span>
</span></span></code></pre></div></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0407/>一日中リファクタリング</a></h1><div class=post-meta><time class=post-date>2023-04-07 (Fri.) ::</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/docker/>docker</a>&nbsp;
#<a href=/diary/tags/mongodb/>mongodb</a>&nbsp;</span><div class=post-content><p>0時に寝て7時に起きた。昨日は夜にホテルで作業しようと思いながらテレビをみているうちに寝落ちしてた。朝から夜までずっとリファクタリングのためにコードを書いたり、コンテナ環境の設定を変更したりしていた。</p><h2 id=mongodb-のコネクションプール>mongodb のコネクションプール</h2><p>MongoDB Drivers の <a href=https://www.mongodb.com/docs/drivers/go/current/fundamentals/connection/#connection-example>Connection Example</a> に次のようなことが書いてある。</p><blockquote><p>Reuse Your Client</p><p>We recommend that you reuse your client across sessions and operations. You can use the same Client instance to perform multiple tasks, instead of creating a new one each time. The Client type is safe for concurrent use by multiple goroutines. To learn more about how connection pools work in the driver, see the <a href=https://www.mongodb.com/docs/drivers/go/current/faq/#std-label-golang-faq-connection-pool>FAQ</a> page.</p></blockquote><p>mongodb drivers の client は goroutine safe なので再利用することを推奨している。内部的にはコネクションプールをもっていて mongodb とのコネクションを再利用できる。具体的にはライブラリ内部に次のようなコードがみつかる。context にセッション情報があればそれを使い、なければクライアントの sessionPool (コネクションプール) を使ってセッションを取得して mongodb にアクセスする関数の終わりで終了処理を行う。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>sess</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sessionFromContext</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sess</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>coll</span>.<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>sessionPool</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sess</span> = <span style=color:#a6e22e>session</span>.<span style=color:#a6e22e>NewImplicitClientSession</span>(<span style=color:#a6e22e>coll</span>.<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>sessionPool</span>, <span style=color:#a6e22e>coll</span>.<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>id</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>sess</span>.<span style=color:#a6e22e>EndSession</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>既存のコードはコネクションプールのことを考慮していないコードになっていたので大きくリファクタリングして効率化した。</p><h2 id=docker-hub-の-pull-制限>docker hub の pull 制限</h2><p>午前中はリファクタリング、午後は docker compose 環境の変更と再構築、午後はバグ修正と一日中 docker image を取得する作業をしていた。gitlab ci/cd が動くとテストと docker image 生成の処理が動くのでその過程で関連する docker image を pull する。夕方になって gitlab ci/cd で初めて次のエラーが発生することに気付いた。前にお手伝いしていた職場でもそういう現象が起こると聞いて、docker login するコードを github actions のスクリプトに追加していたので、rate limit がかかることは知っていた。</p><pre tabindex=0><code>You have reached your pull rate limit. You may increase the limit by authenticating and upgrading: https://www.docker.com/increase-rate-limits.
</code></pre><p><a href=https://www.docker.com/increase-rate-limits/>Understanding Your Docker Hub Rate Limit</a> によると、6時間あたり匿名アクセスは100、
free ユーザーは200を上限としているらしい。匿名アクセスは ip アドレスでカウントしているのだろうから場合によっては会社内からのアクセスをすべてカウントされたりするかもしれない。課金するとこの上限が24時間あたり5000になる。docker hub のプライベートリポジトリを利用する意図で team プランの課金を検討していたが、docker hub のアクセス制限を緩和するために課金する必要があるかもしれない。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0224/>mongodb のトランザクションの考え方</a></h1><div class=post-meta><time class=post-date>2023-02-24 (Fri.) ::</time></div><span class=post-tags>#<a href=/diary/tags/mongodb/>mongodb</a>&nbsp;
#<a href=/diary/tags/database/>database</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;</span><div class=post-content><p>1時に寝て8時に起きた。3時頃に気分悪くて起きて少し吐いてそれからまた寝た。丸1日機能拡張とリファクタリングのために go のコードを書いていた。</p><h2 id=mongodb-のトランザクション管理>mongodb のトランザクション管理</h2><p>2つの web api から同じコレクションの異なるフィールドを更新したい。mongodb で厳密なトランザクションを管理するようなアプリケーションではないけど、なるべく整合性を維持できるように努めることはやっておきたい。mongodb でトランザクションに近いことを実現する方法として次の記事が参考になった。</p><ul><li><a href=https://www.mongodb.com/blog/post/how-to-select--for-update-inside-mongodb-transactions>How To SELECT &mldr; FOR UPDATE inside MongoDB Transactions</a></li></ul><p>この記事では <code>findOneAndUpdate()</code> という api を使って、更新時に必ず変更されるフィールドを含めることで find したときのそのフィールドの値が変わっていればエラーになってくれることでトランザクション相当の機能が提供されると書いてある。必ず変更されるフィールドとして <a href=https://www.mongodb.com/docs/manual/reference/method/ObjectId/>ObjectId</a> を使えば他の更新処理を検出するのに役立つだろうとある。いま私が開発しているアプリケーションでは同じフィールドを複数の web api から更新するわけではないのでここまで厳密なトランザクション管理は必要にない。</p><p>既存の処理が <a href=https://www.mongodb.com/docs/drivers/go/current/usage-examples/replaceOne/>Replace</a> を使って実装されていたのを <a href=https://www.mongodb.com/docs/drivers/go/current/usage-examples/updateOne/>Update</a> を使うように変更する。Replace と Update の違いはドキュメント全体を更新するのか、一部のフィールドのみを更新するのかの違いになる。具体的には go のドライバーにおいて次のメソッドの使い分けになる。</p><ul><li><a href=https://pkg.go.dev/go.mongodb.org/mongo-driver/mongo#Collection.FindOneAndReplace>FindOneAndReplace</a></li><li><a href=https://pkg.go.dev/go.mongodb.org/mongo-driver/mongo#Collection.FindOneAndUpdate>FindOneAndUpdate</a></li></ul><p>これらのメソッドを使うことで find と replace/update の操作を1回の処理でできるから効率もよいらしい。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0219/>mongodb の view 調査</a></h1><div class=post-meta><time class=post-date>2023-02-19 (Sun.) ::</time></div><span class=post-tags>#<a href=/diary/tags/mongodb/>mongodb</a>&nbsp;
#<a href=/diary/tags/refactoring/>refactoring</a>&nbsp;</span><div class=post-content><p>4時半に寝て11時に起きた。午後から go のコードをリファクタリングしてた。平日はメンバーの issue を監視して困ってたらコメントしたり、マージリクエストをレビューしたり、管理画面の振る舞いを検証したりと、コードを書いていても途中で作業がちょくちょく中断する。休日にコードを書くとその中断がない分、いつもよりかなり捗った。リファクタリングに思いの外、時間を取られている気がしたのはそのせいもあるか。</p><h2 id=mongodb-の-view-作成>mongodb の view 作成</h2><p>実はこれまで mongodb を扱ったことがなくて今回初めて触っている。とくに難しくもないのだけど、ドキュメントを探してやりたいことを調べたり、デバッグや開発のためのツールとしてどういうものがあるかといった知見がない。ないものは仕方ないので1からドキュメントを読みながら開発というか、リファクタリングをしている。mongodb そのものの知見はなくても、様々なデータベースを操作する開発をしてきたのでやりたいことに対して実装方法はいくつか検討がつくし、その実装を支援するための機能もあるはずだと予測がつくので探すのも早い。</p><p>ある collection から複数のデータ構造のレスポンスを返すような処理がある。こういったものは view を使うとうまく整理できると知っているので調べると <a href=https://www.mongodb.com/docs/manual/core/views/>mongodb view</a> が提供されていることがわかる。3.4 から追加されたらしい。いまクエリの中で <a href=https://www.mongodb.com/docs/manual/core/aggregation-pipeline/#std-label-aggregation-pipeline>aggregation pipeline</a> を書いている処理のいくつかは、あらかじめ view を定義してクエリすることでインフラ層を堅牢にした上で実装もシンプルにできる。さらに 4.2 から <a href=https://www.mongodb.com/docs/manual/core/materialized-views/#std-label-manual-materialized-views>on-demand materialized view</a> が追加されていて、標準の view と比較して aggregation pipeline の計算結果をディスクに保持するのでパフォーマンス上のメリットがある。元データの更新が頻繁でなければ on-demand を使った方がよいのだろうと推測する。</p><p>またこれまで mongodb の管理画面に <a href=https://github.com/mongo-express/mongo-express>mongo-express</a> を使っている。view の振る舞いを確認しようとしたところ、どうも view には対応していないようにみえる。web ベースの管理画面を他にも探してみたが、どうも他に適当なものがない。mongodb が公式に <a href=https://www.mongodb.com/products/compass>compass</a> というデスクトップアプリケーションの gui クライアントを提供している。macos なら brew からインストールできた。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>&gt; brew install mongodb-compass
</span></span></code></pre></div><p>このツールは collection も view も両方扱えるし、クエリやパイプラインも実行できて機能も充実している。web ベースじゃないとインフラとして共有はできないところだけが残念なところ。それでも開発する上ではとても強力なツールにみえる。適当にデータをインポートしたり、テストで aggregation pipeline を作成してみて、それをエクスポートして view を生成するときのスキーマ定義も作ることができた。ui も洗練していて、こんな優れたデスクトップアプリケーションは久しぶりにみたと思うぐらい感心した。</p></div></article><div class=pagination><div class=pagination__buttons><a href=/diary/tags/mongodb/ class="button previous"><span class=button__icon>←</span>
<span class=button__text>最近の日記</span></a></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>© 2021 Tetsuya Morimoto</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>