<!doctype html><html lang=en><head><title>Programming :: </title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/tags/programming/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="Programming"><meta property="og:description" content><meta property="og:url" content="/diary/tags/programming/"><meta property="og:site_name" content><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/tags/programming/index.xml rel=alternate type=application/rss+xml title></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><h1>Posts for: #Programming</h1><div class=posts><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0925/>excel が utf-8 で保存する csv ファイルは bom 付き</a></h1><div class=post-meta><time class=post-date>2024-09-25</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/programming/>programming</a>&nbsp;
#<a href=/diary/tags/drink/>drink</a>&nbsp;
#<a href=/diary/tags/drinking/>drinking</a>&nbsp;</span><div class=post-content><p>昨日の定例会議で csv ファイルのエンコーディングの話しになって excel 2016 以降では utf-8 で csv ファイルを保存できるようになった。もう cp932 対応しなくてよいといった話題が出た。そのときにうろ覚えだったものの、excel は <a href=https://ja.wikipedia.org/wiki/%E3%83%90%E3%82%A4%E3%83%88%E9%A0%86%E3%83%9E%E3%83%BC%E3%82%AF>byte order mark (bom)</a> を付けていた気がして、実際にファイルを作ってもらったらそうだった。bom の有無は file コマンドや od コマンドでなどで調べられる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ file book1.csv
</span></span><span style=display:flex><span>book1.csv: Unicode text, UTF-8 <span style=color:#f92672>(</span>with BOM<span style=color:#f92672>)</span> text, with CRLF line terminators
</span></span></code></pre></div><p>ファイルの先頭に <code>0xef</code> <code>0xbb</code> <code>0xbf</code> の3バイトがつく。</p><pre tabindex=0><code>$ head -1 | od -t x1 book1.csv
0000000    ef  bb  bf  68  65  61  64  65  72  31  2c  68  65  61  64  65
0000020    72  32  2c  68  65  61  64  65  72  33  2c  68  65  61  64  65
...
</code></pre><p>印字可能な文字ではないため、テキストにするとわからないが、byte 列だと bom が付いているのがわかる。16進数の 0x68 が &lsquo;h&rsquo; になる。bom がついていると <code>header1</code> という文字列比較したときに別の文字列になってしまうので取り除かないといけない。</p><pre tabindex=0><code>文字列: &#39;header1&#39;
byte列: &#39;efbbbf68656164657231&#39;
</code></pre><p>いろんな対応方法があると思うが、<a href=https://stackoverflow.com/questions/21371673/reading-files-with-a-bom-in-go/76023436#76023436>so の回答</a> でみつけたこの方法がコードの見通しもよくて気に入った。次のように io.Reader をラップするようなコードになる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>newBOMAwaredCSVReader</span>(<span style=color:#a6e22e>reader</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>Reader</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>csv</span>.<span style=color:#a6e22e>Reader</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>transformer</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>unicode</span>.<span style=color:#a6e22e>BOMOverride</span>(<span style=color:#a6e22e>encoding</span>.<span style=color:#a6e22e>Nop</span>.<span style=color:#a6e22e>NewDecoder</span>())
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>csv</span>.<span style=color:#a6e22e>NewReader</span>(<span style=color:#a6e22e>transform</span>.<span style=color:#a6e22e>NewReader</span>(<span style=color:#a6e22e>reader</span>, <span style=color:#a6e22e>transformer</span>))
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><a href=https://pkg.go.dev/golang.org/x/text@v0.18.0/transform#Transformer>Transformer</a> という仕組みがあって、準標準ライブラリの golang.org/x/text/encoding で実装されている。so の回答をみただけでコードを追加するのもよくないかと思って <a href=https://pkg.go.dev/golang.org/x/text/encoding/unicode#BOMOverride>unicode#BOMOverride</a> が返す bomOverride transformer のコードを読んで把握した上でテストを書いてマージリクエストを送った。実際の変換処理は次のようなもの。</p><ul><li>fallback として <code>encoding.Nop</code> を使う<ul><li>ソースの byte 列をそのまま使う (実際には変換しない)</li><li><a href=https://pkg.go.dev/golang.org/x/text/encoding#Encoding>https://pkg.go.dev/golang.org/x/text/encoding#Encoding</a></li></ul></li><li>最初に呼ばれたときに d.current (fallback) をセットして、2回目以降は fallback が呼ばれる</li><li>与えられた byte 列が 2byte 以上のときに bom のチェックを行う</li><li>bom があるときはそのバイト数を読み飛ばして d.current (fallback) で変換する</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>d</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>bomOverride</span>) <span style=color:#a6e22e>Transform</span>(<span style=color:#a6e22e>dst</span>, <span style=color:#a6e22e>src</span> []<span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>atEOF</span> <span style=color:#66d9ef>bool</span>) (<span style=color:#a6e22e>nDst</span>, <span style=color:#a6e22e>nSrc</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>current</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>current</span>.<span style=color:#a6e22e>Transform</span>(<span style=color:#a6e22e>dst</span>, <span style=color:#a6e22e>src</span>, <span style=color:#a6e22e>atEOF</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>src</span>) &lt; <span style=color:#ae81ff>3</span> <span style=color:#f92672>&amp;&amp;</span> !<span style=color:#a6e22e>atEOF</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>transform</span>.<span style=color:#a6e22e>ErrShortSrc</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>current</span> = <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>fallback</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>bomSize</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>src</span>) <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>2</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>src</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>==</span> <span style=color:#ae81ff>0xFF</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>src</span>[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>==</span> <span style=color:#ae81ff>0xFE</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>current</span> = <span style=color:#a6e22e>utf16le</span>.<span style=color:#a6e22e>NewDecoder</span>()
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>bomSize</span> = <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>src</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>==</span> <span style=color:#ae81ff>0xFE</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>src</span>[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>==</span> <span style=color:#ae81ff>0xFF</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>current</span> = <span style=color:#a6e22e>utf16be</span>.<span style=color:#a6e22e>NewDecoder</span>()
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>bomSize</span> = <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>src</span>) <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>3</span> <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>src</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>==</span> <span style=color:#a6e22e>utf8BOM</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>src</span>[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>==</span> <span style=color:#a6e22e>utf8BOM</span>[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>src</span>[<span style=color:#ae81ff>2</span>] <span style=color:#f92672>==</span> <span style=color:#a6e22e>utf8BOM</span>[<span style=color:#ae81ff>2</span>] {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>current</span> = <span style=color:#a6e22e>transform</span>.<span style=color:#a6e22e>Nop</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>bomSize</span> = <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>bomSize</span> &lt; len(<span style=color:#a6e22e>src</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>nDst</span>, <span style=color:#a6e22e>nSrc</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>current</span>.<span style=color:#a6e22e>Transform</span>(<span style=color:#a6e22e>dst</span>, <span style=color:#a6e22e>src</span>[<span style=color:#a6e22e>bomSize</span>:], <span style=color:#a6e22e>atEOF</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>nDst</span>, <span style=color:#a6e22e>nSrc</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>bomSize</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>自分で実装してもなにも難しくないけど、すでに実績のあるコードがあるならそれを再利用した方が保守コストを削減できる。</p><h2 id=同期飲み会>同期飲み会</h2><p>新卒入社した会社の同期との飲み会。<a href=/diary/posts/2024/0730/#同期との飲み会>2ヶ月前と同じメンバー</a> で飲んできた。4人で飲む予定が、また1人が障害対応でドタキャンになったから3人で飲んでた。<a href=https://sake-genkabar.com/>日本酒原価酒蔵</a> という、おいしい日本酒を原価で提供するお店があるみたい。プレミアム飲み放題プランだったのでよいお酒をいろいろ飲み比べできた。どれもおいしかったし、ちょっとずついろいろ飲み比べできておもしろかった。飲み放題メニューに神戸のお酒がなかったのがよいことなのか残念なのか。前半は辛口の日本酒を飲んで、だんだん酔っ払って味がわからなくなるから、後半にコクや甘みの強い日本酒を飲むとおいしく飲めると教えてもらった。本当にその通りで日本酒の飲み方のよい勉強になった。お店で飲んだお酒のカードがもらえる。酔っ払って忘れてしまっても後で思い出せる。</p><figure><img src=/diary/img/2024/0925_sake.jpg></figure><p>特徴的なお酒で記憶に残っているもので <a href=https://miinokotobuki.com/>三井の寿</a> がスラムダンクに出てくる三井寿に由来して命名されていて、その背番号である14番と同じアルコード度数14度、日本酒度 (辛口甘口の度合いを表す) +14 と意図的？にあっているとのこと。日本酒の中ではトップクラスの辛口らしい。たしかに過去に私が飲んだことがないキレだった。もう1つは <a href=https://contents.thedann.com/entry/%E8%AE%83%E5%B2%90%E3%81%8F%E3%82%89%E3%81%86%E3%81%A7%E3%81%83%E3%81%AE%E6%97%A5%E6%9C%AC%E9%85%92%E3%82%92%E5%BE%B9%E5%BA%95%E8%A7%A3%E8%AA%AC>讃岐くらうでぃ</a> という、カルピスのような風味に近い珍しいお酒。甘いので後半に飲むとよい。うちらは酔っ払って訳がわからなくなってきたときに口直しのように飲んでた。そういう飲み方をするものかどうかはわからないが、飲みやすいのでついつい飲んでしまい、さらに酔ってしまう典型的なお酒。同期飲みは記憶をなくす感じで飲む。この歳になってこんな飲み方する相手いないなと思うとまた楽しい。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0919/>pipe による関心の分離</a></h1><div class=post-meta><time class=post-date>2024-09-19</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;
#<a href=/diary/tags/programming/>programming</a>&nbsp;</span><div class=post-content><p>go の <a href=https://pkg.go.dev/io#Pipe>Pipe</a> は go 言語プログラミングのよいところをいくつか同時に実感できる、実用度の高いユーティリティだと思う。go 言語は writer や reader をインターフェースとして定義している。細かいメソッドの違いでいくつかの writer/reader インターフェースを区別していたりもするが、基本的には write/read のメソッドをもっていればよい。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Writer</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Write</span>(<span style=color:#a6e22e>p</span> []<span style=color:#66d9ef>byte</span>) (<span style=color:#a6e22e>n</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Reader</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Read</span>(<span style=color:#a6e22e>p</span> []<span style=color:#66d9ef>byte</span>) (<span style=color:#a6e22e>n</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>この汎用的な writer/reader のインターフェースに従っていれば、さまざまな要件に対して抽象化ができる。オンメモリでデータを扱うこともあるし、OS のファイルシステム上のファイルとして扱うこともあるし、オブジェクトストレージ上のオブジェクトとして扱うこともある。そういった具象オブジェクトの如何によらず writer/reader のインターフェースに従うことでデータ処理とリソース管理を分離できる。これはプログラミングパラダイムにおける <a href=https://ja.wikipedia.org/wiki/%E9%96%A2%E5%BF%83%E3%81%AE%E5%88%86%E9%9B%A2>関心の分離</a> と呼ばれていることを実現する。</p><p>バッチ処理において複数データを読み込みながら処理を行い、処理中にエラーが発生したら、そのエラーデータを特定のファイルに書き込みしたい。エラーが発生したときだけ特定ファイルを生成する。そういった要件は次のように実装できる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>write</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>WriteCloser</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>	<span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>		if true {
</span></span></span><span style=display:flex><span><span style=color:#75715e>			return
</span></span></span><span style=display:flex><span><span style=color:#75715e>		}
</span></span></span><span style=display:flex><span><span style=color:#75715e>	*/</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>records</span> <span style=color:#f92672>:=</span> [][]<span style=color:#66d9ef>string</span>{
</span></span><span style=display:flex><span>		{<span style=color:#e6db74>&#34;first_name&#34;</span>, <span style=color:#e6db74>&#34;last_name&#34;</span>, <span style=color:#e6db74>&#34;username&#34;</span>},
</span></span><span style=display:flex><span>		{<span style=color:#e6db74>&#34;Rob&#34;</span>, <span style=color:#e6db74>&#34;Pike&#34;</span>, <span style=color:#e6db74>&#34;rob&#34;</span>},
</span></span><span style=display:flex><span>		{<span style=color:#e6db74>&#34;Ken&#34;</span>, <span style=color:#e6db74>&#34;Thompson&#34;</span>, <span style=color:#e6db74>&#34;ken&#34;</span>},
</span></span><span style=display:flex><span>		{<span style=color:#e6db74>&#34;Robert&#34;</span>, <span style=color:#e6db74>&#34;Griesemer&#34;</span>, <span style=color:#e6db74>&#34;gri&#34;</span>},
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>cw</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>csv</span>.<span style=color:#a6e22e>NewWriter</span>(<span style=color:#a6e22e>w</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>record</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>records</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>cw</span>.<span style=color:#a6e22e>Write</span>(<span style=color:#a6e22e>record</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatalln</span>(<span style=color:#e6db74>&#34;error writing record to csv:&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>cw</span>.<span style=color:#a6e22e>Flush</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>cw</span>.<span style=color:#a6e22e>Error</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>read</span>(<span style=color:#a6e22e>r</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>ReadCloser</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>rr</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bufio</span>.<span style=color:#a6e22e>NewReader</span>(<span style=color:#a6e22e>r</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>line</span>, <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rr</span>.<span style=color:#a6e22e>ReadLine</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>EOF</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>		writer, err := os.Create(&#34;./test.txt&#34;)
</span></span></span><span style=display:flex><span><span style=color:#75715e>		if err != nil {
</span></span></span><span style=display:flex><span><span style=color:#75715e>			log.Fatal(err)
</span></span></span><span style=display:flex><span><span style=color:#75715e>		}
</span></span></span><span style=display:flex><span><span style=color:#75715e>		defer writer.Close()
</span></span></span><span style=display:flex><span><span style=color:#75715e>	*/</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>writer</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Stdout</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>writer</span>.<span style=color:#a6e22e>Write</span>(append(<span style=color:#a6e22e>line</span>, []<span style=color:#66d9ef>byte</span>{<span style=color:#e6db74>&#39;\n&#39;</span>}<span style=color:#f92672>...</span>)); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>Copy</span>(<span style=color:#a6e22e>writer</span>, <span style=color:#a6e22e>rr</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>w</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>Pipe</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>write</span>(<span style=color:#a6e22e>w</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>read</span>(<span style=color:#a6e22e>r</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li><a href=https://go.dev/play/p/nI-vBAumtAk>https://go.dev/play/p/nI-vBAumtAk</a></li></ul><p>Pipe を使うことで読み込みの処理と書き込みの処理を分離できる。ここでいう読み込みはバッチ処理、書き込みはエラーデータの保存処理に相当する。普通に実装すると、バッチ処理中にエラーデータの保存処理も記述することになる。業務のコードだと本質ではないリソース管理が煩雑になってしまう。2つの処理に分割するため、どちらか一方は非同期で実行する必要がある。ここで goroutine のシンプルさが際立つ。さらに pipe を使えば、reader 側は writer が Close するまでブロックするから終了処理の同期も自然なコードで実現してくれる。</p><p>非同期／並行処理の難しいところを go のインターフェースによる抽象化、簡潔な goroutine 記法、pipe に隠蔽された自然な同期処理の3つで簡潔に表現している。複雑さに対してこれほど簡潔なコードはそうそうないと思う。このコードを他の言語で実装しようとしたらもっと複雑になるはず。このサンプルコードとともに若いメンバーにリソース管理のリファクタリングをコードレビューで指摘したものの、そのメンバーには理解できなくて実装できなかった。そして、その処理を私が作り直すことになったというのが、今日のお仕事だった。本当は難しい非同期／並行処理をいくら簡潔にしても、その経験がないと人間には理解できない。まさに本質的複雑さを表しているように思える。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0912/>つなぎの雑多な一日</a></h1><div class=post-meta><time class=post-date>2024-09-12</time></div><span class=post-tags>#<a href=/diary/tags/programming/>programming</a>&nbsp;</span><div class=post-content><p>昨日の続きでメンバーのコードレビューをしながら、openldap スキーマの validator のバグ修正をしつつ、チーム勉強会で雑多な仕様や設計の議論をしていたらそれにも時間を取られて、1日としてはまあり開発を進捗させられなかった。コードを書くことに集中できる時間を2-3時間連続で確保できないとモチベーションにも影響が出てくる。それだけ取り組んでいる課題が複雑だったり煩雑だったりしているのもある。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0907/>集中力の正体</a></h1><div class=post-meta><time class=post-date>2024-09-07</time></div><span class=post-tags>#<a href=/diary/tags/audio-media/>audio media</a>&nbsp;
#<a href=/diary/tags/exercise/>exercise</a>&nbsp;
#<a href=/diary/tags/health/>health</a>&nbsp;
#<a href=/diary/tags/programming/>programming</a>&nbsp;
#<a href=/diary/tags/motivation/>motivation</a>&nbsp;
#<a href=/diary/tags/psychology/>psychology</a>&nbsp;</span><div class=post-content><p>昨日は20時半頃にお仕事を終えて帰った。スーパーで買いものして、家に帰って晩ご飯を作って食べて、休んだらオフィスへ戻るつもりがそのまま寝てしまった。</p><h2 id=メッセージ作成>メッセージ作成</h2><p>年一ゲストとして出演している <a href=https://podcast.terapyon.net/>terapyon channel</a> の <a href=https://terapyon.connpass.com/event/326314/>100回記念公開収録</a> があった。いつもお世話になっているので私は参加できないがカンパ枠で応援していた。昨日てらださんから音声メッセージを作ってほしいと依頼され、本当は昨日の夜に作ろうと思っていたものの、疲れて寝てしまったので朝起きてから慌ててオフィスへ行って作成した。ubuntu の apt でインストールできるツールとして <a href=https://www.audacityteam.org/>audacity</a> を使って録音した。簡単に使えた。お祝いのメッセージを文章に書き出して、マイクテストも含めて最終的には7回撮り直した。文章を書いてから、話してみると、流れが悪かったり、語呂が悪かったり、途中で詰まったり、かんでしまったりと、なにか気になるところをみつけて、文章を推敲して録音しながら1時間ほどやってた。録音して聞き直すと、いかに自分の話し方が下手であるかがよくわかる。話し方を練習しないとうまくならないのだろうな。</p><h2 id=みなとのもりの運動>みなとのもりの運動</h2><p><a href=/diary/posts/2024/0724/#みなとのもりの運動>前回の所感</a> 。14時頃に作業を終えてストレッチまで1時間ほど時間が空いた。ふと運動してからストレッチへ行くとよさそうだと思い立ってジョギングと縄跳びをしてきた。前回が7月24日なので1ヶ月半ほど運動していなかった。1kmほどジョギングしてから縄跳びを15分間した。以前と比較したら軽めに流したにも関わらず、久しぶりに運動したら体力が落ちていてかなりバテた。習慣的に運動していないとすぐに衰える。久しぶりに運動できたので、また再開するきっかけになるかもしれない。</p><h2 id=ストレッチ>ストレッチ</h2><p>今日の開脚幅も開始前148cmで、ストレッチ後152cmとあまり数値は出なかった。直前に運動して行ったのでよく伸びるかな？と予測したものの、測ってみるとそうでもなかった。それでも運動した後にストレッチを受けるのはカラダによさそうにも思える。ここ1ヶ月半ほど運動できていないものの、体重は67kg台を維持していて体脂肪率や筋肉量はあまり変わっていない。トレーナーさんとそういう話をしていたら、筋肉は落ちにくくつきにくいから1ヶ月ではそんなもんとのこと。</p><h2 id=プログラミングの集中力と生産性への考察>プログラミングの集中力と生産性への考察</h2><p>ストレッチを受けているときにトレーナーさんと話していて思うことがあったのでまとめておく。いまの開発フェーズは開発者としてプロジェクトに参加している。平均すると1日10時間ぐらいお仕事していて、早く帰る日もあるから遅い日は日付が変わるぐらいまではコードを書いていることがある。家に帰ると休んでしまうからオフィスで晩ご飯を食べることも多い。なぜプログラミングに集中していると運動ができないのか？を考察してみた。</p><ul><li>他の余分なことを排除すると集中力が増す</li></ul><p>いまやっている開発のお仕事は1日で完了するような簡単な開発ではない。1年半開発しているので残っている課題は厄介で複雑な問題への対応であることが多い。新規機能を追加するときも既存機能や仕様や依存関係を考慮しないといけない。そうすると2-3日かけて課題を解決することが多い。そのときに他の余分なことを排除した方が脳のリソースを課題解決に割り当てられる。通勤しているときも、寝ているときも、ご飯を食べているときも取り組んでいる課題のことを四六時中考えている。他のことに脳のリソースを割くと課題解決の品質が下がる可能性が高い。ずっと考え続けることが複雑な問題の課題解決に重要となる。</p><ul><li>システム開発とはタイムアタック競技である</li></ul><p>システム開発のプロジェクトマネジメントにおいてもっとも重要な概念はタイムボックスだと私は考えている。適度な期間 (うちは2週間) を設け、モノゴトに取り組む最初と最後を作ること。認知心理学の研究からも記憶の仕組みからも期間の最初と最後がもっとも学習効果が高いことを示唆している。このことは私の経験則においてもシステム開発で当てはまる。作業期間が適切でないと人間はだらだらしてしまう (<a href=https://ja.wikipedia.org/wiki/%E3%83%91%E3%83%BC%E3%82%AD%E3%83%B3%E3%82%BD%E3%83%B3%E3%81%AE%E6%B3%95%E5%89%87>パーキンソンの法則</a>) 。プログラミングにおいて動くのは当たり前で、動いた上でいかに品質をあげられるかが腕の見せ所になる。エラー処理を適切に制御できているか、他人がコードを読んでも理解しやすく保守しやすいか、将来の拡張性を考慮して設計されているか、など品質をよくするための取り組みには答えがない。仕事ができる・できないを分ける行動の1つとして、答えのない問いにどれだけ準備できるか、考え続けられるかと言い換えられるかもしれない。答えがないからいくらでも品質をあげるための施策がある。しかし、現実の業務には期限があるため、期限内に最善の品質を目指すことになる。そのため、タイムボックスでシステム開発をマネジメントする限り、いつもタイムアタック競技をしているのと同義になるから時間が足りない。</p><p>プログラミングはいつも妥協を強いられる。完璧で最高のシステムなどありえない。その時々で開発途中における最善の動くものをスナップショットとしてバージョン管理しているに過ぎない。この妥協するレベルが私にとってはマネージャーと開発者という役割で大きく異なるのだろうと思う。マネージャーとしての遊撃なら先送りできても、開発者としては多少の負荷があっても解決してしまう。自身の基準を満たす働き方に違いがあるのではないかと思う。言語化してみると、この考え方はプログラミングに限らず、そのときに取り組む対象によって何にでも応用できそうに思う。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0906/>ldap スキーマの情報を返す web api の実装</a></h1><div class=post-meta><time class=post-date>2024-09-06</time></div><span class=post-tags>#<a href=/diary/tags/ldap/>ldap</a>&nbsp;
#<a href=/diary/tags/programming/>programming</a>&nbsp;</span><div class=post-content><p><a href=/diary/posts/2024/0904/>一昨日</a>、<a href=/diary/posts/2024/0905/>昨日</a> と ldap スキーマの parser について調査して実装した。最終的には構文解析した値をそのまますべて返すわけではなく、実際に ui や内部の処理で必要な情報のみを使いやすい構造にして web api として実装する。マージリクエストを作成してメンバーにコードレビューをしてもらっていて、スキーマ情報だけでは足りない仕様に1つ気付いた。たとえば、次の <code>cn</code> という属性の定義には SUP (super の略語で親の定義から派生していることを表す) として <code>name</code> が定義されている。</p><pre tabindex=0><code>attributetype ( 2.5.4.41 NAME &#39;name&#39;
       EQUALITY caseIgnoreMatch
       SUBSTR caseIgnoreSubstringsMatch
       SYNTAX 1.3.6.1.4.1.1466.115.121.1.15{32768} )

attributetype ( 2.5.4.3 NAME ( &#39;cn&#39; &#39;commonName&#39; )
       DESC &#39;RFC2256: common name(s) for which the entity is known by&#39;
       SUP name )
</code></pre><p><code>cn</code> の定義には SYNTAX は定義されていないが、これは <code>name</code> の定義にある SYNTAX 1.3.6.1.4.1.1466.115.121.1.15 (<code>Directory String</code> のこと) の oid を継承するという仕様になっている。自分で SUP を調べて継承元の情報を取得するのは面倒なので構文解析した後に SUP が指定されていれば Equality, Ordering, SubStr, Syntax を親から取得するように改善した。こういうところは自前で parser を実装しているので自分たちの都合にあわせてカスタマイズしやすい。</p><p>3日もかかってしまったが、これで ldap スキーマを返す web api の実装を完了できた。いまの開発フェーズにおける、私が機能拡張する issue はこれで完了にしようと考えている。来週からはテストや qa 向けの作業にのみ注力していこうと思う。本番導入前に少しでも運用トラブルの懸念を減らす、もしくは品質をあげるための取り組みをあと3週間やってからしっかり検証をしていく。ここ1ヶ月ほど深夜までコードを書いていることが多かった。終わってみれば、面倒で厄介な issue も大半を fix した。当たり前の話だけど、四六時中ずっとコードを書いていたら気付いたら成果として積み上がってきた。マネージャーを移管したことでその分の労力を開発にまわせているのもある。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0904/>openldap スキーマと parser generator</a></h1><div class=post-meta><time class=post-date>2024-09-04</time></div><span class=post-tags>#<a href=/diary/tags/ldap/>ldap</a>&nbsp;
#<a href=/diary/tags/programming/>programming</a>&nbsp;
#<a href=/diary/tags/meta-programming/>meta programming</a>&nbsp;</span><div class=post-content><p>この開発フェーズではあまり機能拡張を行わない方針としているが、できればやっておいた方がよい機能拡張の1つに openldap サーバーから ldap スキーマを取得する処理がある。ちょうどいま若いメンバーに実装してもらっている大きな機能のバリデーションにも ldap スキーマの情報があると便利そうなので私が対応することに決めた。</p><p>openldap サーバーで管理している ldap スキーマの定義は openldap サーバーの <a href=https://www.openldap.org/doc/admin26/schema.html>Schema Specification</a> と <a href=https://www.openldap.org/doc/admin25/schema.html>rfc 4512</a> の2つをみると仕様がわかる。たとえば、次のように AttributeTypeDescription というスキーマの定義は <a href=https://en.wikipedia.org/wiki/Augmented_Backus%E2%80%93Naur_form>Augmented Backus–Naur form (abnf)</a> という記法で定義されている。rfc などのネットワークプロトコルの世界では abnf のフォーマットで仕様を説明することが多いらしい。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-abnf data-lang=abnf><span style=display:flex><span><span style=color:#a6e22e>AttributeTypeDescription</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>&#34;(&#34;</span> <span style=color:#a6e22e>whsp</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>numericoid</span> <span style=color:#a6e22e>whsp</span>              <span style=color:#75715e>; AttributeType identifier</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;NAME&#34;</span> <span style=color:#a6e22e>qdescrs</span> ]             <span style=color:#75715e>; name used in AttributeType</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;DESC&#34;</span> <span style=color:#a6e22e>qdstring</span> ]            <span style=color:#75715e>; description</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;OBSOLETE&#34;</span> <span style=color:#a6e22e>whsp</span> ]
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;SUP&#34;</span> <span style=color:#a6e22e>woid</span> ]                 <span style=color:#75715e>; derived from this other</span>
</span></span><span style=display:flex><span>                                   <span style=color:#75715e>; AttributeType</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;EQUALITY&#34;</span> <span style=color:#a6e22e>woid</span>              <span style=color:#75715e>; Matching Rule name</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;ORDERING&#34;</span> <span style=color:#a6e22e>woid</span>              <span style=color:#75715e>; Matching Rule name</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;SUBSTR&#34;</span> <span style=color:#a6e22e>woid</span> ]              <span style=color:#75715e>; Matching Rule name</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;SYNTAX&#34;</span> <span style=color:#a6e22e>whsp</span> <span style=color:#a6e22e>noidlen</span> <span style=color:#a6e22e>whsp</span> ] <span style=color:#75715e>; Syntax OID</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;SINGLE-VALUE&#34;</span> <span style=color:#a6e22e>whsp</span> ]        <span style=color:#75715e>; default multi-valued</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;COLLECTIVE&#34;</span> <span style=color:#a6e22e>whsp</span> ]          <span style=color:#75715e>; default not collective</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;NO-USER-MODIFICATION&#34;</span> <span style=color:#a6e22e>whsp</span> ]<span style=color:#75715e>; default user modifiable</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;USAGE&#34;</span> <span style=color:#a6e22e>whsp</span> <span style=color:#a6e22e>AttributeUsage</span> ]<span style=color:#75715e>; default userApplications</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>whsp</span> <span style=color:#ae81ff>&#34;)&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>AttributeUsage</span> <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>&#34;userApplications&#34;</span>     <span style=color:#f92672>/</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>&#34;directoryOperation&#34;</span>   <span style=color:#f92672>/</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>&#34;distributedOperation&#34;</span> <span style=color:#f92672>/</span> <span style=color:#75715e>; DSA-shared</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>&#34;dSAOperation&#34;</span>          <span style=color:#75715e>; DSA-specific, value depends on server</span>
</span></span></code></pre></div><p>openldap サーバーに対して ldap スキーマを取得する方法は <a href=https://www.openldap.org/faq/data/cache/1366.html>How can I fetch schema information from the server?</a> の faq に書いてある。search base に対してサブスキーマサブエントリを返す dn を取得する。openldap サーバーの場合 ldap の root ツリーに対応するのは <code>cn=Subschema</code> がデフォルトとなる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ldapsearch -H ldap://localhost -x -LLL -b dc<span style=color:#f92672>=</span>example,dc<span style=color:#f92672>=</span>com -s base subschemaSubentry
</span></span><span style=display:flex><span>dn: dc<span style=color:#f92672>=</span>example,dc<span style=color:#f92672>=</span>com
</span></span><span style=display:flex><span>subschemaSubentry: cn<span style=color:#f92672>=</span>Subschema
</span></span></code></pre></div><p>この dn にスキーマ情報の属性が格納されているのでそれらを取得する。このスキーマ情報は operational attributes として管理されているので <code>+</code> という記号が operational attributes 属性群をまとめて取得するキーワードになっている。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ldapsearch -x -LLL -b cn<span style=color:#f92672>=</span>Subschema -s base <span style=color:#e6db74>&#39;(objectClass=subschema)&#39;</span> +
</span></span></code></pre></div><p>これでスキーマ情報を取得できる。先に書いた AttributeTypeDescription の実際のスキーマ情報は次のような内容になる。こういったスキーマのテキスト情報をたくさん取得できる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-abnf data-lang=abnf><span style=display:flex><span>( <span style=color:#f92672>2</span>.<span style=color:#f92672>5</span>.<span style=color:#f92672>4</span>.<span style=color:#f92672>0</span> <span style=color:#a6e22e>NAME</span> &#39;<span style=color:#a6e22e>objectClass</span>&#39; <span style=color:#a6e22e>DESC</span> &#39;<span style=color:#a6e22e>RFC4512</span>: <span style=color:#a6e22e>object</span> <span style=color:#a6e22e>classes</span> <span style=color:#a6e22e>of</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>entity</span>&#39; <span style=color:#a6e22e>EQUALITY</span> <span style=color:#a6e22e>objectIdentifierMatch</span> <span style=color:#a6e22e>SYNTAX</span> <span style=color:#f92672>1</span>.<span style=color:#f92672>3</span>.<span style=color:#f92672>6</span>.<span style=color:#f92672>1</span>.<span style=color:#f92672>4</span>.<span style=color:#f92672>1</span>.<span style=color:#f92672>1466</span>.<span style=color:#f92672>115</span>.<span style=color:#f92672>121</span>.<span style=color:#f92672>1</span>.<span style=color:#f92672>38</span> )
</span></span></code></pre></div><h2 id=go-の-parser-generator-調査>go の parser generator 調査</h2><p>この手のものは abnf から parser をコード生成するのが一般的なやり方かな？と、まずは go で使えそうな parser generator について調べてみた。意外と go 製の parser generator はみつからなかった。私が発見できたのは次の3つぐらい。</p><ul><li><a href=https://pkg.go.dev/golang.org/x/tools/cmd/goyacc>golang.org/x/tools/cmd/goyacc</a></li><li><a href=https://github.com/goccmack/gocc>goccmack/gocc</a></li><li><a href=https://github.com/antlr4-go/antlr>antlr4-go/antlr</a></li></ul><p>最後の antlr は java 製のツールだけれども、go のソースコードを出力できるので go 実装の parser をコード生成できるという意図で対象としている。goyacc は abnf の文法を yacc に変換しないといけない。<a href=https://github.com/yinyin/go-ldap-schema-parser/blob/master/parser.y>yacc で実装した ldap スキーマの parser</a> を公開しているのもみかけたが、yacc は違うなと思って除外した。antlr も abnf から専用の文法に変換しないといけないから不採用にした。</p><p>それで消去法的に bnf (ebnf) を扱える gocc で parser をコード生成できないかを調査してみた。しかし、半日ほど bnf を書いて実際にコード生成してみて不採用とした。ebnf の options 記法として <code>[...]</code> に gocc が対応していないようにみえた。この記法がないと ldap スキーマの文法定義が煩雑になる。<a href=https://github.com/goccmack/gocc/issues/21#issuecomment-216398402>issue のコメント</a> をみると、lexer は対応したが、parser は対応していないといったコメントがある。コード生成しようとするとエラーになるので未対応なのかもしれない。bnf でこの options 記法相当のものを自分で文法定義すると、1つ2つなら簡単に変換できるが、数個の組み合わせがあると途端に文法の複雑さが大きくなるように思える。abnf から bnf に変換する過程で文法が複雑になってしまうとその後の保守ができなくなる懸念が生じるので断念した。</p><p>今回の gocc の採用は却下したが、軽く触ってみて gocc 自体の感触はよかった。シンプルな bnf で表現できるものであれば機会があれば採用してもよいと思える。<a href=https://github.com/goccmack/gocc/tree/master/example>gocc example</a> をみればわかるが、bnf を書きながら単体テストのコードを実行して動作検証を小さく簡潔にできる。これは parser のコード生成の開発サイクルは速くできそうに感じた。こういう小さく単体で動くツールは好み。</p><p>最終的な結論としては parser generator は使わず、自前で parser を実装することを決めた。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0830/>まる一日コードレビュー</a></h1><div class=post-meta><time class=post-date>2024-08-30</time></div><span class=post-tags>#<a href=/diary/tags/programming/>programming</a>&nbsp;
#<a href=/diary/tags/review/>review</a>&nbsp;</span><div class=post-content><p>昨日は2時頃に帰ってきて、朝も昼も食べてなくて空港でおにぎりを食べただけだったので家に戻ってきてお腹が空いて軽食を食べてから寝た。お手伝い先の都合で朝から請求書を送る必要があったため、8時過ぎにはオフィスへ行って請求書を作成して送付した。9時からはらさんと隔週の雑談もあったのでスケジュール的にも早起きする理由があってちょうどよかった。</p><p>出張帰りの気分転換に nginx で <code>X-Forwarded-For</code> を設定する方法を <a href=https://christina04.hatenablog.com/entry/2016/10/25/190000>remote_addrとかx-forwarded-forとかx-real-ipとか</a> をみたりしながら調査していた。リバースプロキシがある前提であれば、api サーバーがそのヘッダーを参照するのではなく、nginx がそのヘッダーを <code>remote_addr</code> に設定するようにしてしまおうと思う。</p><p>今回の開発フェーズでは若いメンバーにサーバーサイドの大きな機能を開発してもらう。サーバーサイド開発の経験を積んでもらう機会にもする。レビューに私の時間が取られることを折り込んで工数を確保している。ある機能の初期実装ができたというのでそのレビューをしていた。そのコードレビューをしていてサーバーサイドの開発は難しいなと実感した。経験がないメンバーだと動けばいいコードしか書けない。効率やリソースの消費を考えながらコードを書いていないし、ライブラリやフレームワークのコードも読んでいないからサーバーサイドの運用に耐えるコードは書けない。あちこち指摘して直してもらう必要があった。なんやらかんやらでまる一日コードレビューしていて、自分の作業はまったくできなかった。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0827/>実際に動くようになってからわかること</a></h1><div class=post-meta><time class=post-date>2024-08-27</time></div><span class=post-tags>#<a href=/diary/tags/programming/>programming</a>&nbsp;
#<a href=/diary/tags/business/>business</a>&nbsp;</span><div class=post-content><p>東京出張しての、隔週の定例会議にて、ある仕様について話しをした。これまでもずっとそういう仕様ではあったが、実際の本番運用が近づいてきて、実運用を考えているうちにある要件が出てきた。しかし、現状のシステムの構成上、その要件は満たせないことがわかった。1年半にわたって開発してきて初めてこの要件は現状のシステムの制約でできないと発言した。出来ないものは出来ないで仕方ない。それでも今更そんな要件が出てくるところに課題管理として出来ていなかった反省もあるし、気付きが足りなかった。私は20年も開発してきたからたいていの要件への対応は出来るだろうと、自身の経験から過信してしまっているところもあったなと思えた。やはりお仕事になるエンタープライズの要件はなかなか難しい。難しいからお客さんはお金を払って si 的なお仕事になるとも言える。自分への情けなさとそれでもできる範囲でやっていかないといけないという現実とを実感したひとときだった。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0823/>生活のリズムづくりの1ヶ月</a></h1><div class=post-meta><time class=post-date>2024-08-23</time></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/programming/>programming</a>&nbsp;
#<a href=/diary/tags/motivation/>motivation</a>&nbsp;</span><div class=post-content><h2 id=歯科検診>歯科検診</h2><p>17時から歯科検診へ行ってきた。スタッフに「痩せてませんか？」と尋ねられて3ヶ月ぶりならそれほど変わらないんじゃないかと返したが、そのスタッフが私の担当をするのは2月以来だったらしく、それならかなり変わりましたと話していた。たまにしか行かないのに、首まわりが全然違うと言われて、半年前の体型を覚えているんやなと思ってこっちが驚いた。たまに会う人向けのお断りとして「癌ではありません」と説明しといた。</p><h2 id=生活のリズムづくり>生活のリズムづくり</h2><p>ここ1ヶ月ほど開発者へ戻るための取り組みをしてきた。昼間にお仕事でコードを書いて、晩ごはんを食べてから、夜にコードを書くのが習慣的になってきた。概ね1日の作業時間が10-12時間になってきている。夜に開発できている日はだいたい20-21時頃から24時頃までコードを書いている。夜は割り込みが入らないので集中できる。今日も晩ごはんを食べて22時前から翌2時半ぐらいまでコーディングしていた。ファイルのアップロード／ダウンロードを扱う汎用 api を実装した。</p><p>いまの開発フェーズでは <a href=/diary/posts/2024/0801/>過去の残課題</a> が多い。それはこれまでの私のマネジメント不備でもあるし、知見を得たことでアーキテクチャの不備や再設計のリファクタリングができるようになった課題も多い。技術的負債が溜まっているとみなせる。いずれにしても、実運用を間近に控えて直せるところをできるだけ直しておきたい。当初は私が改善する issue が仕様変更になるためにプロジェクト全体のボトルネックになってしまっていた。なるべく初期の開発で <a href=/diary/posts/2024/0816/>ボトルネックを解消</a> してからもペースを落とすことなく、集中して開発作業を継続できている。スケジュールの前倒しとまではいかないが、後手にまわっている印象はなく迅速に対応できている。個人的にもよいリズムと集中力が出てきたと感じている。その視点からみると、いま開発に向いている集中力をこれまでは体脂肪コントロールや運動に費やしてきたこともわかる。だから短期間に大きな成果が出た。人の可処分時間は決まっている。継続的になにかに取り組むと1ヶ月も経てば実感できるぐらいの成果がでる。もしかしたら私がフルタイムの開発者として作業できるのはあと3ヶ月になるかもしれない。悔いの残らないよう、できるだけ集中して取り組もうと思う。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0822/>ファイルアップロードのインターフェース</a></h1><div class=post-meta><time class=post-date>2024-08-22</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/programming/>programming</a>&nbsp;</span><div class=post-content><p>今日も昼間は普通にお仕事で開発して、お仕事を終えて晩ごはんを買い出しへ行ってきて、オフィスで晩ごはんを食べてから夜のコーディングに戻るといった一日になった。昼間は会議や問い合わせ対応、他のメンバーの進捗をチェックしたりなど、ちょくちょく割り込みが入る。夜はそれらがないことがわかっているので3-4時間集中してコーディングできる。</p><h2 id=echo-のファイルアップロードのサンプル>echo のファイルアップロードのサンプル</h2><p>メンバーがファイルを受け渡しする web api のインターフェースがよくわからないということで私がサンプルを作ってみることにした。echo には <a href=https://echo.labstack.com/docs/cookbook/file-upload>File Upload</a> のサンプルも紹介されているからすぐにできる。歴史的にブラウザからのファイルアップロードを前提にすると、ファイルを扱うときは次の Content-Type を使う。</p><pre tabindex=0><code>Content-Type: multipart/form-data
</code></pre><p>これを echo のコードで書くと次のようなインターフェースとなる。￼</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>MyRequest</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Type</span>      <span style=color:#66d9ef>string</span>    <span style=color:#e6db74>`form:&#34;type&#34; validate:&#34;required&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Operation</span> <span style=color:#66d9ef>string</span>    <span style=color:#e6db74>`form:&#34;operation&#34; validate:&#34;required&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>handle</span>(<span style=color:#a6e22e>c</span> <span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>req</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>MyRequest</span>{}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Bind</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>req</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Validate</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>req</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>file</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>FormFile</span>(<span style=color:#e6db74>&#34;file&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>Is</span>(<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ErrMissingFile</span>) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>NewHTTPError</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusBadRequest</span>, <span style=color:#e6db74>&#34;file is required&#34;</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span></code></pre></div><p>ファイル情報を MyRequest で管理できるとリクエストパラメーターを一元管理できて望ましいが、次の issue によると現時点ではそれはできないらしい。</p><ul><li><a href=https://github.com/labstack/echo/issues/2672>Bind file from multipart/form-data request #2672</a></li></ul><p>curl コマンドでリクエストするには次のような cli になる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -i -X POST -F type<span style=color:#f92672>=</span>misc -F operation<span style=color:#f92672>=</span>add -F file<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;@myfile.data&#34;</span> ...
</span></span></code></pre></div></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0821/>寝ている間に再設計</a></h1><div class=post-meta><time class=post-date>2024-08-21</time></div><span class=post-tags>#<a href=/diary/tags/issue-management/>issue management</a>&nbsp;
#<a href=/diary/tags/communication/>communication</a>&nbsp;
#<a href=/diary/tags/programming/>programming</a>&nbsp;
#<a href=/diary/tags/health/>health</a>&nbsp;</span><div class=post-content><p>昨日のもやもやは寝ている間に整理され、今日は標準的な開発者としての過ごし方になった感じがする。</p><h2 id=マネージャーとの-1on1>マネージャーとの 1on1</h2><p>これまでは私がマネージャーとして 1on1 をしてきたが、今後は交代したメンバーがマネージャーを務める。この開発フェーズでは私は開発者 (メンバー) として 1on1 をしてもらうといった感じかな。自分が開発者側だと思うと、いま私が取り組んでいることの話しをしやすかったりした。立場によって 1on1 のやり方は変わることを実感した。マネージャーはメンバーの話しを聞く方に注力したり、プロジェクト全体の話しをしがちになる。開発者として臨むと、自分の抱えている issue に集中して話せるといった違いがあった。</p><h2 id=cpap-の中断>CPAP の中断</h2><p>夜に睡眠外来へ行ってきた。以前に <a href=/diary/posts/2024/0314/>CPAP 装置</a> を借りて3ヶ月ぐらいやっていたものの、ここ2ヶ月ほどやらなくなってしまっていた。もともとは体脂肪コントロールの疲労回復のために始めたものだった。体脂肪コントロールがうまくいって目標達成したことで睡眠改善を行う目的もなくなってしまって関心を失ってしまった。借りているだけで毎月5千円ほどかかるので中断して機器を返却することにした。旅行のときなど、一時的に借りられないかを聞いてみたら、それは不可とのこと。また再開したくなったらいつでも言えばよいとのこと。</p><h2 id=ツールの再設計>ツールの再設計</h2><p><a href=/diary/posts/2024/0820/>昨日の続き</a> 。睡眠外来から帰ってきて、晩ごはん食べて、軽く飲みながら24時過ぎまでコードを書いていた。今日もまる一日ツールの再設計をしていた。昨日のノーアイディアな状況から少しずつ好転していって、ある処理で歯車が噛み合ってからはいつも通り着実に進捗していく様がみられた。意図的にやっていることではあるけど、課題について考えながら一晩寝ると、寝ている間に無意識に刷り込まれて脳が考えてくれる。それで徐々によい設計が現れてくるようになって明確な実装に落ち着いたのではないかと推測する。今日はよい感じに集中できた。</p></div></article><div class=pagination><div class=pagination__buttons><a href=/diary/tags/programming/page/2/ class="button next"><span class=button__text>過去の日記</span>
<span class=button__icon>→</span></a></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2024 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>