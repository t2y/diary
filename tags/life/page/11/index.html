<!doctype html><html lang=en><head><title>life :: forest nook</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/tags/life/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="life"><meta property="og:description" content><meta property="og:url" content="/diary/tags/life/"><meta property="og:site_name" content="forest nook"><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/tags/life/index.xml rel=alternate type=application/rss+xml title="forest nook"></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><div class=posts><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0917/>ドキュメントを書いてマンガを読んで</a></h1><div class=post-meta><time class=post-date>2022-09-17 (Sat.) ::</time></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/document/>document</a>&nbsp;</span><div class=post-content><p>0時に寝て7時に起きた。</p><h2 id=ストレッチ>ストレッチ</h2><p>今日の開脚幅は開始前160cmで、ストレッチ後163cmだった。今週も調子がよい。やはり涼しくなって日々の生活の快適度があがって体調もよくなっている気がする。ストレッチを受けていてもあちこち調子よくていい感じにストレッチできているように思う。これで少しジョギングや運動をするといいんだろなという気持ちになってくる。これまでも暑い夏はあったと思うが、今年ほど夏の暑さにまいって集中力を欠いた年はなかったと思う。というのは、日記を1年近くも毎日書いたことがなかったからその変化に気付けたことも過去になかった。日記を書く過程で環境や状況の変化に敏感に気付けるようになったという背景もある。他の要因としては歳をとって体力が落ちているのだろうと推測する。落ちた体力をカバーするだけの取り組み (運動するとか摂生するとか) が必要なのだろうけれど、私は昔と比べて生活の姿勢をとくに変えていない。もうそろそろ不摂生がダメなんだろうなという自覚は出てきた。昨年からストレッチを始めたのは本当に僥倖で健康度はいくらか上がっていると思う。</p><h2 id=まだドキュメントを書いている>まだドキュメントを書いている</h2><p><a href=/diary/posts/2022/0915/#インフラのドキュメント作成の続き>非開発者向けのインフラドキュメント</a> がなかなか完成に至らない。厳密に書くわけでもなく、嘘を書くわけでもなく、重要なことのみを専門用語を使わずに技術知識がない人たち向けに書くドキュメントは相当に難しい。どういう構成にするかも何度も試行錯誤しているし、説明のための文章量も増えてしまうところがある。インフラを知らない開発者向けに引き継ぎのドキュメントを書くよりもずっと大変だと3日も書いているのに書き終わらない (自分で納得がいかない) 事実から認識できた。書いて読まれるのかどうかもわからないけど、それは読み手の自由であって書き手は自分が伝えたいことを自分の言葉で書くことに意味があるだろうと考えて、いまの自分ができる精一杯のドキュメントを書こうと思う。</p><h2 id=葬送のフリーレン>葬送のフリーレン</h2><p>夕方から <a href=https://websunday.net/work/708/>葬送のフリーレン</a> を7巻ぐらいまで読んだ。これまで1巻を無料キャンペーンで読んだことはあったし、人気があることも知ってはいたけどいつか読もうぐらいの感覚だった。毎日 LINE マンガで <a href=/diary/posts/2022/0514/#神之塔>神之塔</a> を読んでいて、たまたま2巻も無料化されたのを見かけて読んでみたらおもしろかったので、いつかはいまだと認識して電子版を購入して読み進めた。</p><p><a href=https://ja.wikipedia.org/wiki/%E8%91%AC%E9%80%81>葬送</a> という言葉も私は知らなかった。「死者と最後の別れをし、火葬場、墓地に送り出すこと。」を指す言葉らしい。マンガのタイトルから「葬送のフリーレン」という物語だよというのは、内容から妥当だと思うものの、これは物語の世界の中でもフリーレンの異名として魔族が呼んでいる。私はてっきり勇者ヒンメルとの思い出を辿る旅全体を葬送に見立てているのだと思って読み進めていたのに、途中で魔族からそう呼ばれていて、魔族を殺しまくる忌み名的なものだったの？！というところで、それまで読み進めていた自分の中の世界観とバグが生じた。もしかしたら今後の物語の展開によってまた違った意味になってくるのかもしれないけど。</p><blockquote><p>歴史上で最も多くの魔族を葬り去った魔法使いとして「葬送のフリーレン」の異名を持ち、魔族から忌み恐れられている。</p><p><a href=https://ja.wikipedia.org/wiki/%E8%91%AC%E9%80%81%E3%81%AE%E3%83%95%E3%83%AA%E3%83%BC%E3%83%AC%E3%83%B3>ja.wikipedia.org/wiki/葬送のフリーレン</a></p></blockquote><p>あと思い出を辿るという物語は、ほのぼのしている話しもあれば、魔族との戦いを話しもあり、資格を取るための競技会の話しもある。話しの展開を何とでも創生できる想像力の源になっている。このマンガは旅の終わりが来なくてもよいし、強い敵を倒さなくてもよいし、思い出さえあれば物語を展開できるのでその幅の広さに感心した。内容はまったく違うけれど、<a href=https://www.mushishi-anime.com/>蟲師</a> を読んだときと同じような感銘を受けた。葬送のフリーレンもアニメ化が決定しているらしい。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0910/>キャリアは知識と経験の差分でわかる</a></h1><div class=post-meta><time class=post-date>2022-09-10 (Sat.) ::</time></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/medium/>medium</a>&nbsp;
#<a href=/diary/tags/programming/>programming</a>&nbsp;
#<a href=/diary/tags/information-exchange/>information exchange</a>&nbsp;</span><div class=post-content><p>23時に寝て2時に起きてその後どうしていたかあまり覚えていないが気付いたら8時だった。</p><h2 id=ストレッチ>ストレッチ</h2><p>今日の開脚幅は開始前160cmで、ストレッチ後163cmだった。今週も全然ストレッチできなかったのになぜか数値はよくなっていた。ストレッチを受けていて調子の悪さも感じなかったので気候が過ごしやすくなってきて体調がよくなった結果として普段の生活における活動量や新陳代謝などにも影響を与えているのかもしれない。トレーナーさんからは涼しくなったのだから運動をしてくださいと言われた。ほんとその通り。</p><h2 id=知識と経験>知識と経験</h2><ul><li><a href=https://medium.com/vanguards-of-code/youre-not-a-senior-software-engineer-9056ef9ffb96>You’re Not a Senior Software Engineer</a></li></ul><p>たまたま目を通した medium のおすすめ記事に出ていて、タイトルにひかれて斜め読みしたらおもしろかったので後で deepl を使って精読した。最近は英語の記事を deepl で訳して読んでいる。まず deepl で全訳した後に文脈から訳文の意味をとれなかったり、明らかにおかしいところだけを手直しする。著作権的に機械翻訳を公開はできないため、その翻訳内容は課題管理システムのイシューで管理している。この記事だと手直し数回ぐらいで大意を読める。普段、英語の記事を日本語アカウントで紹介することはないんだけど、これは素晴らしい内容だったのでそのまま共有することにした。軽く所感も書いてあるが、課題管理システムのイシューにはさらに詳細な分析やコメントも残している。</p><blockquote class=twitter-tweet><p lang=ja dir=ltr>知識とはやり方を知っていることで、経験とはやってはいけないことを知っていること。素晴らしい記事だった。 / You’re Not a Senior Software Engineer by @repsofsunshine <a href=https://t.co/3qitFOFTJp>https://t.co/3qitFOFTJp</a></p>&mdash; Tetsuya Morimoto (@t2y) <a href="https://twitter.com/t2y/status/1568471581961388034?ref_src=twsrc%5Etfw">September 10, 2022</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script><p>多くの若いチームでは課題管理の重要性を理解していない。その無理解の原因の1つとして、ものごとを検討したり判断したりした時点では正しかったことが未来のある時点で誤りになってしまう可能性を想像できないからだと私は考えている。記憶と忘却の仕組みから前日のことですら半分以上忘れてしまうので数ヶ月前の詳細など、ほとんどの人は覚えていない。にも関わらず、日々の小さい判断の積み重ねや意思決定の履歴を記録として残さないのはなぜだろうか？それはその詳細があとで重要になるかどうか、多くのケースでその発生時点ではわからないからだ。例えば、システムのアーキテクチャに関して言えば <a href=https://adr.github.io/>Architectural Decision Records (ADRs)</a> というドキュメントが提唱されている。アーキテクチャのような大きなものでさえ、明示的に残さないと経緯がわからなくなるのに、もっと小さい粒度である日々の開発や運用の誤りを、一般の (普通の) 開発者がその発生時点から数ヶ月や数年経ってふりかえって見直すことができるだろうか？いやできないというのが、多くのチームやメンバーをみてきた私の所感だ。多くのメンバーは過去のある時点の見逃しや判断ミスをなかったことにしようとする。それは無意識にしろ意識的にしろ起きやすい。客観的に詳細を確認できればなかったことになってしまうのは仕方のないことでもある。</p><p>私は課題管理システムのコメントに、こういう状況からこう判断したとか、誰それと相談してこういう事情でそうしたとか、自身の感覚からとくに意味もなく決めたとか、常々なぜに相当する内容を残している。そして、あるとき過去の経緯を見返して、そのときの判断は適切だったか、過去のある時点で気付けたはずのことを見逃してなかったか、見逃していたとすればどうすればその時に気付きを得られたか、というふりかえりを日常的なチケット整理の一環として実践している。件の medium の記事にはなぜそれが重要なのかの概念を書いてあるように私には受け取れた。課題管理 + 情報共有の需要な概念の1つだと認識して寝かせておこうと思う。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0903/>夏バテは解消しつつある</a></h1><div class=post-meta><time class=post-date>2022-09-03 (Sat.) ::</time></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/book/>book</a>&nbsp;</span><div class=post-content><p>1時に寝て7時に起きた。開発の作業しようかと思っていたけど、なんか気分が乗らなくて本を読んでただけだった。</p><h2 id=ストレッチ>ストレッチ</h2><p>今日の開脚幅は開始前158cmで、ストレッチ後162cmだった。まずまずの数値でストレッチを受けていても調子がよかった。気温が下がって暑さが和らいできて体調もよくなってきた感じがある。以前から姿勢があまりよくないといったアドバイスを受けていて、前側の筋肉に比べて後側の方が相対的に強いから後側の筋肉を多用しようとして腰に負担がきているといった話しがある。姿勢を保つときに腹筋を使うように意識した方がよいといったアドバイスをトレーナーさんからもらった。</p><h2 id=正史-諸葛亮孔明>正史 諸葛亮孔明</h2><p>「第四章 赤壁の戦い」を読んだ。</p><p>孔明が軍事の指揮をとるのは劉備の死後になるので、劉備の生前に起こった赤壁の戦いで伝えられる孔明の逸話は基本的にすべて嘘になる。演義では十万本の矢、東南の風、龐統による連環の計までもが創作らしい。赤壁の戦いの功労者は呉の都督だった周瑜の戦略によるもので戦う前から結果がみえていた。周瑜が用意周到に準備した戦略通りに魏軍がはまり、そこに周瑜の部下である黄蓋が提案した火計が成功をおさめたという。これはこれでおもしろくて戦いとはその前の準備の段階で決着がついているという見方ができる。周瑜は都督で全体の戦略を描くものの、実際の戦場における戦術は積極的に部下に任せるというスタンスをとっていた。また実際にはこれは大きな戦ではなく、小競り合いと決定打だとなった火計はあったものの、魏軍で流行した疫病による撤退というのが史実だと言えるらしい。演義における赤壁の戦いが大創作になっている背景として、三国志演義が編纂された時代 (実際の赤壁の戦いから千年後) にあった <a href=https://ja.wikipedia.org/wiki/%E9%84%B1%E9%99%BD%E6%B9%96%E3%81%AE%E6%88%A6%E3%81%84>鄱陽湖の戦い</a> がモデルになっているのではないか。また孔明の神算鬼謀も朱元璋に仕えた <a href=https://ja.wikipedia.org/wiki/%E5%8A%89%E5%9F%BA>劉基</a> からきているのではないかという話しでもあるらしい。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0827/>eks クラスター障害のふりかえり</a></h1><div class=post-meta><time class=post-date>2022-08-27 (Sat.) ::</time></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/os/>os</a>&nbsp;
#<a href=/diary/tags/postmortem/>postmortem</a>&nbsp;</span><div class=post-content><h2 id=ストレッチ>ストレッチ</h2><p>今日の開脚幅は開始前155cmで、ストレッチ後161cmだった。開始前の数値が悪いけど、とくに調子が悪いというわけでもなかったので計測の仕方がよくなかったか、たまたま足の開き方が悪かったかといったところだろう。昨日、高級時計と投資の話しを聞いたのでトレーナーさんとお金があったら何に使う話しが盛り上がった。トレーナーさんも庶民的な方でとくにお金があっても贅沢をしたいというものでもないらしい。私も改めてお金があったら何がしたいかを考えてみてもお金を使ってやりたいことはとくにないなというのが率直な思いでもある。私には自分がやったことのないことをやってみたいという思いしかなく、そのためにお金を使ってきた側面も多々あるけれど、お金を直接的に使って何かをやるというよりも、生活できるだけのお金があれば、その時間に自分がやったことのないことに挑戦して人生を楽しむということぐらいしかやることはないんだなと、トレーナーさんと話していて考えたりしていた。</p><h2 id=os-雑談>os 雑談</h2><p>午後から昨日の障害のふりかえりといくつか調査をして、夕方におがわさんに声をかけたら話し相手になってくれると返ってきた。障害のふりかえりをした後に課題管理の雑談もしていて4時間弱ぐらい話してた。私自身、反省しないといけないとは思っていたのでおがわさんはちゃんと指摘をしてくれた。この歳になると私を叱ってくれる人はいない。たまに失敗したときにおがわさんに話して然るべき指摘をしてもらえるのは本当にありがたい。</p><blockquote><p>kubernetes がどうやって動いているのかを理解して運用しているのか？</p><p>コンピューターがどうやって動いているのかを理解しているのか？</p></blockquote><p>私が未熟で理解できていなかったからこんな障害を見過ごしていた。システム障害が発生しても人生は終わりじゃない。反省してから次につなげる。おがわさんと話していて、os の仕組みや機能についていくつか教えてもらった。</p><ul><li>制限対象の違い<ul><li>ulimit はユーザーに対する制限</li><li>/proc ファイルシステムはシステムに対する制限</li></ul></li><li><code>/proc/sys/kernel/pid_max</code> は kernel のデフォルト値として 32768 が設定されているが、systemd を使っていれば値を変更している場合がある<ul><li>私の ubuntu マシンだと 4194304 が設定されていた</li></ul></li><li>コンテナ内から <code>/sys/fs/cgroup/memory/memory.usage_in_bytes</code> をみると、コンテナが使っているメモリ量なのか？<ul><li>cgroup の使い方次第で変わる、システムの値かもしれないしコンテナの値かもしれない</li></ul></li><li>ゾンビプロセスに残っている情報は親プロセスが子プロセスの統計情報を取得するために必要なもの<ul><li>どんな子プロセスも一時的にはゾンビプロセスになる</li><li>kernel の task_struct 構造体やその他の構造体、リンクしている情報などをすべて足すと1つのゾンビプロセスが10数 KiB 程度ではないか<ul><li>仮に 15 KiB として 32000 個のゾンビプロセスがあると約 469 MiB のメモリ量になるのでだいたい数字があう</li></ul></li></ul></li><li>ユーザー空間とカーネル空間の違いを理解できるようになった方がよい<ul><li>システムコールの fork がエラーになるのはシステムがおかしいとすぐに気付けるはず<ul><li>fork がエラーになる原因として考えられるのはメモリを確保できないか、pid_max に達したか、いずれにしてもエラーコードをみれば推測がつくのではないか</li></ul></li></ul></li><li>環境にログインできるのであれば <a href=https://strace.io/>strace</a> を使えば障害調査に役立つ<ul><li>私が普段使っていないツールなので障害のときにとっさに扱えるよう練習しておく</li></ul></li></ul></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0820/>休日の本番障害</a></h1><div class=post-meta><time class=post-date>2022-08-20 (Sat.) ::</time></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/kubernetes/>kubernetes</a>&nbsp;
#<a href=/diary/tags/operation/>operation</a>&nbsp;</span><div class=post-content><p>夕方から寝ていて何度か起きたものの、そのままずっと寝ていた。あまりないことなんだけど、珍しくたくさん眠れた。</p><h2 id=ストレッチ>ストレッチ</h2><p>今日の開脚幅は開始前160cmで、ストレッチ後163cmだった。計測の仕方がややいい加減だった気もしたが、先週より少しよくなったということにしておく。右腰の張りが強いのと肩が前に入りがちなので肩を開いて姿勢を保つように心がけるとよいとアドバイスをいただいた。もう通い始めて1年半ぐらい経つ。トレーナーさんも大半が入れ替わっていて通い始めたときに話しかけてくれた私が知っているトレーナーさんはほとんどいない。1年半も経つと人は変わっていくなというのを実感している。私の最初のトレーナーさんは社内制度で別の店舗の助っ人に行っているのでいなくなった人たちが辞めているわけでもないとは思うけど、1-2年で人が入れ替わってもサービスは継続していかないといけないし、会社ってそういうものだなと実感する機会でもある。</p><h2 id=aws-インフラの調子が悪い>aws インフラの調子が悪い？</h2><p>1-2週間ぐらい前からテスト環境を含めると複数回発生している <a href=/diary/posts/2022/0815/>eks クラスターの障害</a> がたまたま土曜日の夜という休日に発生した。いま eks クラスターのインフラの振る舞いを把握しているのは私だけなので、気付いてから指示を出して問題が発生している k8s ノードの削除 (ec2 インスタンスの削除) で復旧させるワークアラウンドで復旧させた。私は本番環境にアクセスできないので詳しい調査はできない。状況を正しく把握できてはいないけれど、k8s ノードが死んだり生き返ったりする不安定な状況に発生しているらしく、k8s ノードを削除して新規に作り直すと復旧することがわかっている。NotReady と Ready を繰り返したりしてアプリケーションの振る舞いが不安定になる。NotReady,SchedulingDisabled になれば、おそらく drain して k8s ノードが入れ替わってくれるのだけど、そうならない不安定な状況があるみたい。これ以上の調査は aws のサポートに問い合わせないとわからない。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0813/>戦略シミュレーションと特性</a></h1><div class=post-meta><time class=post-date>2022-08-13 (Sat.) ::</time></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/game/>game</a>&nbsp;</span><div class=post-content><h2 id=ストレッチ>ストレッチ</h2><p>今日の開脚幅は開始前158cmで、ストレッチ後161cmだった。先週よりやや数字が悪くなった。それでも先週はストレッチを受けていても体全体のだるさのようなものを感じていたのが、今回はちゃんと筋を伸ばしている感覚があって先週の体調の悪さはなくなったように思える。右股関節周りの詰まりに加えて、右前ももの張りがいつもより大きかった気がする。毎週ストレッチを受けていると物理的な体調の良し悪しもわかるのがよい。</p><h2 id=わざと負ける理由>わざと負ける理由</h2><p><a href=/diary/posts/2022/0812/#ドラクエタクトのリアルタイム対戦>一昨日からリアルタイム対戦</a> にはまっている。数をこなしていてわかってきたことがたくさんある。戦略シミュレーションゲームはやればやるほど学びがある。</p><ul><li>パーティーの特性によって相性のよい対戦相手とそうじゃないのがある<ul><li>リアルタイム対戦のマッチングは選択できないのでマッチングしないと相手がわからない</li><li>相性の悪い相手だとマッチング時点で辞退する (負けを認める) 相手もいる</li></ul></li><li>こっちの戦略に呼び込むための布石がいる<ul><li>3つぐらい戦略を用意して最終的にどの戦略に呼び込むかを相手の動きをみながら考えないといけない</li><li>キャラを動かす制限時間が15秒なのでわりと忙しい</li><li>こちらの布石にはめて最終的に勝てると達成感がある<ul><li>中盤まで負けていて向こうに勝ったと思わせて逆転できるとなお嬉しい</li><li><a href=https://game8.jp/dqtact/395606>ダークドレアム</a> は奇数ターン (1, 3, 5, 7 &mldr;) ごとに攻撃力・守備力・すばやさ・かしこさが1段階上がるバフがかかる<ul><li>ダークドレアムはすばやさが低いので徐々にすばやさが上がっていって先制できるようになると最後の1手違いで勝つ状況が出来上がる</li><li>ダークドレアムで5ターンまで戦闘を継続できれば勝率が高い</li></ul></li></ul></li></ul></li><li>すばやさの高いパーティーには何もできないから勝てない<ul><li>高すばやさ (且つ、高火力または状態異常) パーティーには絶対に勝てない<ul><li>リアルタイム対戦でダークドレアムがあまり使われていない理由だと思う</li></ul></li><li>初手前にパーティーの半分ぐらいがやられている</li><li>相手の攻撃が届かない初期配置がないので絶対に防げない</li></ul></li><li>状態異常攻撃の主体パーティーは対戦していておもしろくない<ul><li>混乱・麻痺・眠り・魅了といった状態異常になると2ターン何もできない</li><li>状態異常攻撃 + 高すばやさのキャラの攻撃を防ぐ方法はない<ul><li><a href=https://game8.jp/dqtact/455291>創造神マデサゴーラ</a> が出てきたら高い確率で勝てない</li></ul></li></ul></li><li>パーティー編成のウェイト制限がうまく調整されている<ul><li>高ランク (ステータス高い) のキャラばかりを編成できないようにウェイト制限がある</li><li>これにより、パーティー編成が4人か5人かにわかれる</li><li>低ランク (ステータス低い) のキャラはウェイトも低いので5人目には入れやすい<ul><li><a href=https://game8.jp/dqtact/390466>たたかいのベホイム</a> が使える <a href=https://game8.jp/dqtact/344037>ホイミスライム</a> が活躍したりする</li></ul></li></ul></li></ul><p>本題のわざと負ける理由だが、わかってきた。リアルタイム対戦のマッチングは同じランク内で行われる。上位のランクになればなるほど、対戦相手も強くなる (強くなければ上位のランクに上がれない) 。一定量のポイントを獲得するとランクアップしていけるが、負けるとポイントが下がるペナルティがつく。一定のランクで勝ち負けを繰り返すとそのランクに留まり続けるということができる。私も自分の限界までランクアップしてみて気付いたのは周りも強いので限界に到達すると勝ったり負けたりを繰り返す。ここで別のルールで勝った回数に応じてコインが支払われるボーナスがある。強い人が低いランクで勝ち数を稼ぐのは限界に近いランクで勝ったり負けたりを繰り返すよりもはるかに効率がよい。それはリアルタイム対戦のマッチングに時間制限があるからなおさらそうなる。実力が均衡した相手と時間をたくさん使って2勝3敗を繰り返すよりも、わざと負けながら弱い相手に勝ち続ける5勝?敗を繰り返す方が絶対数としての勝ち数を稼ぐには効率がよい。おそらく負けたときのペナルティがあるランクからわざと負ける人が現れ始めていると思う。なるほどなぁ。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0806/>Kubernetes Clients のサンプル実装</a></h1><div class=post-meta><time class=post-date>2022-08-06 (Sat.) ::</time></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/kubernetes/>kubernetes</a>&nbsp;</span><div class=post-content><p>23時に寝て7時半に起きた。夜中も2回ぐらい起きる。暑さでまいってきた。</p><h2 id=ストレッチ>ストレッチ</h2><p>今日の開脚幅は開始前159cmで、ストレッチ後162cmだった。数字は悪くない。いつもはストレッチを受けていると疲労しているところが伸びることで体が軽くなっていく感覚があるのだけど、今日は体全体がだるくてストレッチを受けていてもなんかしんどいなぁとだるさを感じていた。コロナに感染してないと思うけど、夏バテの状態をそのままストレッチにも持ち込んだような感覚があった。腰の張りや肩甲骨の硬さなどが少し気になったかな。トレーナーさんには立ったときの姿勢が少し前よりで重心のバランスがよくないといったアドバイスをされた。とくにどこが悪いというわけでもないのになんかしんどい。</p><h2 id=kubernetes-clients-のサンプル実装>Kubernetes Clients のサンプル実装</h2><p><a href=/diary/posts/2022/0804/>Kubernetes Clients の調査</a> の続き。java クライアントを使って minikube でいくつか動かしてみた。openapi で生成した rest api クライントが提供されている。デフォルト設定でも minikube で普通に動いたのでおそらく裏で <code>$HOME/.kube/config</code> をみたり <code>/var/run/secrets/kubernetes.io/serviceaccount/token</code> を読み込んで認証ヘッダーに設定してくれたりするのだと推測する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> ApiClient <span style=color:#a6e22e>getKubernetesClient</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    var client <span style=color:#f92672>=</span> Config<span style=color:#f92672>.</span><span style=color:#a6e22e>defaultClient</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    io<span style=color:#f92672>.</span><span style=color:#a6e22e>kubernetes</span><span style=color:#f92672>.</span><span style=color:#a6e22e>client</span><span style=color:#f92672>.</span><span style=color:#a6e22e>openapi</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Configuration</span><span style=color:#f92672>.</span><span style=color:#a6e22e>setDefaultApiClient</span><span style=color:#f92672>(</span>client<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> client<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>このクライアントを使って <a href=https://github.com/kubernetes-client/java/tree/master/kubernetes/docs>java/kubernetes/docs/</a> 配下にある api インスタンスを生成する。例えば、cronjob や job を扱うならば <code>BatchV1Api</code> というドキュメントがある。BatchApi だけでも3つのドキュメントがあるのでちょっとやり過ぎな気もする。</p><ul><li>BatchApi.md</li><li>BatchV1Api.md</li><li>BatchV1beta1Api.md</li></ul><p>kubectl コマンドで使う cronjob から手動で job を設定するのを実装してみる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl create job --from<span style=color:#f92672>=</span>cronjob/my-schedule-job my-manual-job
</span></span></code></pre></div><p>細かい設定はちゃんと調べないといけないけど、一応はこれで動いた。cronjob のオブジェクトを取得して job のオブジェクトを生成して create するだけ。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>var api <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> BatchV1Api<span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getKubernetesClient</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>var cronJob <span style=color:#f92672>=</span> api<span style=color:#f92672>.</span><span style=color:#a6e22e>readNamespacedCronJob</span><span style=color:#f92672>(</span>cronJobName<span style=color:#f92672>,</span> NAMESPACE_DEFAULT<span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>var ann <span style=color:#f92672>=</span> Map<span style=color:#f92672>.</span><span style=color:#a6e22e>of</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;cronjob.kubernetes.io/instantiate&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;manual&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>var metadata <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> V1ObjectMeta<span style=color:#f92672>().</span><span style=color:#a6e22e>name</span><span style=color:#f92672>(</span>newJobName<span style=color:#f92672>).</span><span style=color:#a6e22e>annotations</span><span style=color:#f92672>(</span>ann<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>var spec <span style=color:#f92672>=</span> cronJob<span style=color:#f92672>.</span><span style=color:#a6e22e>getSpec</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getJobTemplate</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getSpec</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>spec<span style=color:#f92672>.</span><span style=color:#a6e22e>setTtlSecondsAfterFinished</span><span style=color:#f92672>(</span><span style=color:#ae81ff>10</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>var job <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> V1Job<span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>apiVersion</span><span style=color:#f92672>(</span>cronJob<span style=color:#f92672>.</span><span style=color:#a6e22e>getApiVersion</span><span style=color:#f92672>())</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>kind</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Job&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>spec</span><span style=color:#f92672>(</span>cronJob<span style=color:#f92672>.</span><span style=color:#a6e22e>getSpec</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getJobTemplate</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getSpec</span><span style=color:#f92672>())</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>metadata</span><span style=color:#f92672>(</span>metadata<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>var result <span style=color:#f92672>=</span> api<span style=color:#f92672>.</span><span style=color:#a6e22e>createNamespacedJob</span><span style=color:#f92672>(</span>NAMESPACE_DEFAULT<span style=color:#f92672>,</span> job<span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
</span></span></code></pre></div><p>手動で作成した job の pod は終了後にゴミとして残ってしまうので ttl を設定すれば自動的に削除できることに気付いた。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>spec<span style=color:#f92672>.</span><span style=color:#a6e22e>setTtlSecondsAfterFinished</span><span style=color:#f92672>(</span><span style=color:#ae81ff>10</span><span style=color:#f92672>);</span>
</span></span></code></pre></div><p>k8s クラスターの内部、つまり pod 内からリクエストするには <a href=https://kubernetes.io/docs/reference/access-authn-authz/rbac/#service-account-permissions>ServiceAccount permissions</a> を適切に設定しないといけない。ひとまずローカルの minikube で super user 権限にしたらリクエストはできた。実運用では適切なロールを定義して適切に権限設定しないといけない。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl create clusterrolebinding serviceaccounts-cluster-admin <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --clusterrole<span style=color:#f92672>=</span>cluster-admin <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --group<span style=color:#f92672>=</span>system:serviceaccounts
</span></span></code></pre></div></div></article><div class=pagination><div class=pagination__buttons><a href=/diary/tags/life/page/10/ class="button previous"><span class=button__icon>←</span>
<span class=button__text>最近の日記</span></a>
<a href=/diary/tags/life/page/12/ class="button next"><span class=button__text>過去の日記</span>
<span class=button__icon>→</span></a></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>© 2021 Tetsuya Morimoto</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>