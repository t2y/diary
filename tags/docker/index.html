<!doctype html><html lang=en><head><title>docker :: forest nook</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/tags/docker/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="docker"><meta property="og:description" content><meta property="og:url" content="/diary/tags/docker/"><meta property="og:site_name" content="forest nook"><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/tags/docker/index.xml rel=alternate type=application/rss+xml title="forest nook"></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><div class=posts><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0301/>rocky linux も悪くない</a></h1><div class=post-meta><time class=post-date>2023-03-01 (Wed.) ::</time></div><span class=post-tags>#<a href=/diary/tags/docker/>docker</a>&nbsp;
#<a href=/diary/tags/linux/>linux</a>&nbsp;</span><div class=post-content><p>2時に寝て7時に起きた。夜うまく眠れなくて夜更かしした。3月になってしまったか。2月の記憶がほとんどない。</p><h2 id=rocky-linux-をベースイメージとして使う>rocky linux をベースイメージとして使う</h2><p>コンテナを作るときのデフォルトの os は、私の中では <a href=https://hub.docker.com/_/alpine>alpine</a> だが、依存ライブラリの制約があって、いま作っている docker image は <a href=https://hub.docker.com/r/rockylinux/rockylinux>rockylinux</a> をベースイメージに使う。rockylinux を docker pull した感覚は速いのでそんな大きなイメージでもない。minimal だと40数 MiB 程度のサイズ。すでに成果物として rpm パッケージがあり、その rpm が依存解決できないといけないため、rhel ベースの os をベースイメージにしないといけない。rpm パッケージに systemd の起動スクリプトなども入っているのでそのまま使えばいいかとも思ったのだけど普通には systemd は動かない。rockylinux のドキュメントにも systemd はこうやったら動くよと書いてあるものの、実際に起動してみるとエラーになる。細かくは追いかけていないけれど、cgroup v2 で未解決な問題があるらしく、cgroup v2 を使うカーネルでは systemd が動かないらしい。</p><ul><li><a href=https://github.com/moby/moby/issues/42275>Unable to run systemd in docker with ro /sys/fs/cgroup after systemd 248 host upgrade #42275</a></li></ul><p>コンテナを動かすプラットフォームがハイパーバイザーも兼ねるので systemd を動かす必要性はないけれど、サードパーティの起動スクリプトを自分たちで保守するのも嫌だなという印象はあるのでもしかしたら悩ましい問題なのかもしれない。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0130/>思い立ったらドキュメントを公開</a></h1><div class=post-meta><time class=post-date>2023-01-30 (Mon.) ::</time></div><span class=post-tags>#<a href=/diary/tags/document/>document</a>&nbsp;
#<a href=/diary/tags/ci/cd/>ci/cd</a>&nbsp;
#<a href=/diary/tags/docker/>docker</a>&nbsp;</span><div class=post-content><p>23時に寝て2時頃に少し吐いて起きた。夜遅めに日本酒飲んでいい気分で寝たものの、もう夜に食べたらダメな体になりつつある。4時ぐらいまで起きててそれから寝て7時に起きた。</p><h2 id=echo-の静的ファイルの扱い>echo の静的ファイルの扱い</h2><p>web api のドキュメントは <a href=/diary/posts/2022/1216/#openapi-勉強会>openapi スキーマを使って生成</a> している。本当はこのドキュメントを gitlab pages で公開させたいのだけど、まだそのインフラ構築ができていなくて先送りになっている。いつもローカルで gitlab ci/cd がビルドしたドキュメントをみていたのだけど、ある機能開発をするときにローカルで web api ドキュメントみるの飽きたなと思って、web api サーバーに同梱してしまえと思い立った。テスト環境の web api サーバーは常に動いているのだから、そこに web api のドキュメントが同梱されていて、なんの不都合があろうか？ (いや、なにもない) 。</p><p>次のドキュメントに echo で静的ファイルを扱う方法が書いてある。</p><ul><li><a href=https://echo.labstack.com/guide/static-files/>Static Files</a></li></ul><p>ミドルウェアで実装されているようで簡単に静的ファイルを返せる。指定したパスのディレクトリ配下を扱えるのが <code>Static</code> で、指定したパスのファイルを扱うのが <code>File</code> になる。web api ドキュメントのようなものならキャッシュしてもいいなとは思ったものの、次の issue によると v4 ではミドルウェアで自前実装しないといけないらしい。v5 ではその仕組みが echo の機能として入るかもしれない。</p><ul><li><a href=https://github.com/labstack/echo/issues/1902>TTL (Cache-Control header in response) for static files #1902</a></li></ul><p>その後、gitlab ci/cd で web api サーバーのビルド後、openapi.yml からドキュメント生成をして、任意の static ディレクトリに配置するように設定した。docker のマルチステージビルドを使うと簡単にできる。バックエンドやっていて、サーバーとインフラの両方に手を入れて機能を作っていくときの、うまくできると利便性と達成感の両方を得られるのが楽しい。web api サーバーがドキュメントを提供することは、要件に含まれるわけでも、誰かに指示されたわけでもない。私が勝手にローカルでドキュメントみるの飽きたと思って、勝手に作って、勝手に動くようにしただけ。こういう開発の遊びのゆとりや権限をチームのメンバーにも与えられるようにしていきたい。開発が楽しくて悪いことはなにもないと思うんよね。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/1219/>dind をやってみた</a></h1><div class=post-meta><time class=post-date>2022-12-19 (Mon.) ::</time></div><span class=post-tags>#<a href=/diary/tags/gitlab/>gitlab</a>&nbsp;
#<a href=/diary/tags/ci/cd/>ci/cd</a>&nbsp;
#<a href=/diary/tags/docker/>docker</a>&nbsp;
#<a href=/diary/tags/testing/>testing</a>&nbsp;</span><div class=post-content><p>3時に寝て7時半に起きた。最後なのでワールドカップの決勝戦をみてた。接戦で試合もおもしろかったしよかったと思う。</p><h2 id=gitlab-cicd-で-docker-in-docker>gitlab ci/cd で docker in docker</h2><p>ミドルウェアを伴う結合テストは <a href=https://github.com/ory/dockertest>dockertest</a> というツールを使って docker でミドルウェアを起動して実行している。デフォルトで作成した gitlab runner で docker を使おうとすると失敗する。これは gitlab runner が ci/cd ジョブを docker で動かすため docker in docker (これを <em>dind</em> と呼ぶらしい) のための設定が必要になる。大雑把に言えば gitlab runner にそのための権限を設定する必要がある。gitlab の次のドキュメントに詳細が書いてある。</p><ul><li><a href=https://docs.gitlab.com/ee/ci/docker/using_docker_build.html#use-docker-in-docker>Use Docker-in-Docker</a></li></ul><p>gitlab runner に権限を設定したら次のような job が動けば docker in docker は成功と言える。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>hello-dind</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>stage</span>: <span style=color:#ae81ff>test</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>image</span>: <span style=color:#ae81ff>docker:20.10.21</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>variables</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>DOCKER_HOST</span>: <span style=color:#ae81ff>tcp://docker:2375</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>DOCKER_TLS_CERTDIR</span>: <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>docker:20.10.21-dind</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>allow_failure</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>before_script</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>docker info</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>script</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>docker run hello-world</span>
</span></span></code></pre></div><p>あとになって気付いたことだけど、dockertest の README にも <a href=https://github.com/ory/dockertest#running-dockertest-in-gitlab-ci>Running dockertest in Gitlab CI</a> としていくつか tips が紹介されている。dockertest で作成したリソースからホスト名とポート番号を取得するには次のようなユーティリティを使う必要がある。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>getHostPort</span>(<span style=color:#a6e22e>resource</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>dockertest</span>.<span style=color:#a6e22e>Resource</span>, <span style=color:#a6e22e>id</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>dockerURL</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Getenv</span>(<span style=color:#e6db74>&#34;DOCKER_HOST&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>dockerURL</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>resource</span>.<span style=color:#a6e22e>GetHostPort</span>(<span style=color:#a6e22e>id</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>u</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>url</span>.<span style=color:#a6e22e>Parse</span>(<span style=color:#a6e22e>dockerURL</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>Hostname</span>() <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;:&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>resource</span>.<span style=color:#a6e22e>GetPort</span>(<span style=color:#a6e22e>id</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/1216/>openapi 勉強会</a></h1><div class=post-meta><time class=post-date>2022-12-16 (Fri.) ::</time></div><span class=post-tags>#<a href=/diary/tags/docker/>docker</a>&nbsp;
#<a href=/diary/tags/nginx/>nginx</a>&nbsp;
#<a href=/diary/tags/tls/>tls</a>&nbsp;
#<a href=/diary/tags/openapi/>openapi</a>&nbsp;</span><div class=post-content><p>1時に寝て7時に起きた。昨日はたまたま遅くなって0時頃に帰ってきたが、最近は22時前後に帰ってくることが多い。疲労困憊。</p><h2 id=nginx-でつくるリバースプロキシ>nginx でつくるリバースプロキシ</h2><p>ちょっとググってみつかる記事を参考にして設定したらすぐにできた。私は tls 周りの設定に詳しくないのでこういうまとめ記事はとても助かる。インターネットって便利。</p><ul><li><a href=https://gist.github.com/dahlsailrunner/679e6dec5fd769f30bce90447ae80081>Docker with SSL and an nginx reverse proxy</a></li><li><a href=https://mpolinowski.github.io/docs/DevOps/NGINX/2020-08-27--nginx-docker-ssl-certs-self-signed/2020-08-27/>NGINX Docker with SSL Encryption (Self-signed)</a></li></ul><h2 id=openapi-勉強会>openapi 勉強会</h2><p>昨日の続き。openapi についてチーム勉強会を開催した。wiki に次の目次で説明を書いてその内容を勉強会で話した。ちょうど1時間におさまって内容もわかりやすいものができたのではないかと自画自賛。毎週のチーム勉強会のネタとしてちょうどよい粒度だった。</p><ul><li>code generator が fork した背景</li><li>スキーマ駆動開発<ul><li>メリット</li><li>デメリット</li></ul></li><li>OpenAPI スキーマからドキュメント生成</li><li>OpenAPI スキーマからコード生成</li><li>リファレンス</li></ul><p>余談だけど、過去に働いていた会社の発表資料が slideshare から docswell というサービスに移管されてた。slideshare は広告が鬱陶しいサービスになってしまってひどいユーザー体験だからこれは適切な判断だと思う。</p><ul><li><a href=https://www.docswell.com/s/ydnjp/Z3YQV5-2019-11-21-120351>https://www.docswell.com/s/ydnjp/Z3YQV5-2019-11-21-120351</a></li></ul></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/1212/>docker compose に期待しない</a></h1><div class=post-meta><time class=post-date>2022-12-12 (Mon.) ::</time></div><span class=post-tags>#<a href=/diary/tags/gitlab/>gitlab</a>&nbsp;
#<a href=/diary/tags/docker/>docker</a>&nbsp;
#<a href=/diary/tags/infrastructure/>infrastructure</a>&nbsp;
#<a href=/diary/tags/founding/>founding</a>&nbsp;</span><div class=post-content><p>0時に寝て5時に起きて7時に起きた。起きたら冷やしたのかお腹痛かったが、まぁまぁ眠れたと思う。</p><h2 id=テスト環境の構築>テスト環境の構築</h2><p><a href=https://docs.gitlab.com/ee/ci/>GitLab CI/CD</a> にだいぶ慣れてきてジョブを追加したり改善したりしながらようやくアプリケーションの docker image もコンテナレジストリに push されるようになった。それを pull してきて、テスト環境を <a href=https://docs.docker.com/compose/>docker compose</a> で構築する。<a href=https://docs.docker.com/compose/production/>Use Compose in production</a> とドキュメントでは威勢がよいが、これが全然イケてない。複数の compose.yml で項目によっては変更したいところを置き換えるといった振る舞いになっていない。例えば、ポート番号などを dev と prod で置き換えたいといった運用の要件を考える。</p><ul><li>dev.yml</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>myapp</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>18080</span>:<span style=color:#ae81ff>8080</span>
</span></span></code></pre></div><ul><li>prod.yml</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>myapp</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>8080</span>:<span style=color:#ae81ff>8080</span>
</span></span></code></pre></div><p>これを次のように指定すると、</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ docker compose -f dev.yml -f prod.yml up -d
</span></span></code></pre></div><p>実際のサービスは次のように振る舞う。全然あかん。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>myapp</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>18080</span>:<span style=color:#ae81ff>8080</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>8080</span>:<span style=color:#ae81ff>8080</span>
</span></span></code></pre></div><p>他にもそれぞれの yml ファイルで読み込む environment file のマージなどもよくわからない振る舞いをしていて複数の compose.yml で制御するのは断念した。dry の原則に反して設定は重複するけど、それぞれの環境を個別に compose.yml として管理した方が保守コストは小さくなると私は判断した。複数の compose.yml の使い分けのデバッグを1-2日やった後に諦めてテスト環境の構築は完了した。</p><h2 id=年金事務所の住所変更手続き>年金事務所の住所変更手続き</h2><p>先週 <a href=/diary/posts/2022/1205/#法務局で法人登記の変更申請>法務局で法人登記の変更申請</a> をしていて、そのときに問題がなければ今日から登記事項証明書を取得できると案内をもらっていた。決定書が漏れていて再提出というトラブルはあったものの、最小限の損失で留めたせいか、問題なく登記事項証明書を発行できた。住所の変更だけわかればよいので履歴事項証明書ではなく現在事項証明書を発行してみた。この書類もおもしろくて1つ前の住所といまの住所の2つを確認できる。法務局へ行った帰りに年金事務所へ立ち寄って社会保険の住所変更の手続きを行った。次の3つの書類をもって窓口へ。</p><ul><li>登記事項証明書: 番地まで記載されている</li><li>オフィスの一時使用契約書: ビル名はあるがこのビル名は来月に改名</li><li>ビル名変更の証明書類: ビル名の変更のみが記載されている</li></ul><p>この3つの書類で完全に指定された住所 (Fully Qualified Address: 造語) を丁寧に説明したところ担当者に納得してもらえて事なきを得た。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/1109/>軽量のコンテナオーケストレーションツールは存在しない</a></h1><div class=post-meta><time class=post-date>2022-11-09 (Wed.) ::</time></div><span class=post-tags>#<a href=/diary/tags/docker/>docker</a>&nbsp;
#<a href=/diary/tags/kubernetes/>kubernetes</a>&nbsp;
#<a href=/diary/tags/event/>event</a>&nbsp;</span><div class=post-content><p>0時に寝て6時に起きた。冷蔵庫に飲みものなくて不安。</p><h2 id=docker-の-swarm-mode>docker の swarm mode</h2><p>昨日から docker の <a href=https://docs.docker.com/engine/swarm/>swarm mode</a> について調べていた。</p><p>オンプレにコンテナのアプリケーションをデプロイするにあたり、軽量のコンテナオーケストレーションツールはないかと調べ始めた。<a href=https://www.portainer.io/blog/orchestrator-wars-continue>Kubernetes vs Docker Swarm vs Nomad - the orchestrator wars continue?</a> を記事を読むと、軽量のオーケストレーションツールと言えるのは swarm mode か <a href=https://www.nomadproject.io/>Nomad</a> ぐらいしかない。docker に付属しているならまずはそれを調べるべきだろうと調査した。そして swarm mode の採用は見送った。現時点でこの機能が廃止されるというアナウンスはないが、あまり保守されておらず、docker 社も積極的に推進していない。近い将来、機能が廃止される可能性が高いと私は判断した。</p><p>docker のドキュメントをみながら3台の ec2 インスタンスでクラスターを構築してみて簡単であることは間違いない。コマンド2つで swarm クラスターを構築できる。一通り触ってみて数台のマシンを管理する軽量のコンテナオーケストレーションツールとしては十分だと私は思うけれど、残念ながらこのツールが求められる業務やビジネスは少ないのだろうと思う。みんな k8s に持ってかれたという感じかな。調べていて読んだ記事など。</p><ul><li><a href=https://dockerswarm.rocks/>Docker Swarm Rocks</a></li><li><a href=https://levelup.gitconnected.com/six-tips-for-running-swarm-cluster-in-production-e0f2ef367694>Six Tips For Running Swarm Cluster in Production</a></li><li><a href=https://www.reddit.com/r/docker/comments/936924/docker_swarm_in_production_anyone_using_it/>Docker swarm in production - Anyone using it?</a></li></ul><h2 id=hannali-dao-雑談>hannali dao 雑談</h2><p><a href=https://hannari-python.connpass.com/event/265098/>Hannali DAO #02</a> に参加した。</p><p>最初は dao とは何かをみんなで雑談してた。私はお仕事しながら軽く聞いているつもりだったのが、議論に口出しして熱中してた。技術的に私が理解できないことが出てくると、私の認識が誤っていたり新しい気付きがあったりする可能性があるので、ついつい詳細を聞いてみたくなる。hannali dao でトークンをばら撒く戦略をみんなで考えていて dao の宣伝をしたら貢献の1つとみなしてトークンをもらえる。私は twitter でいくつか hannali dao のツィートをしていて、1ツィートが 300 PROG とかで、合計で 1250 PROG のトークンをもらった。PROG というのは hannali dao でのみ使えるトークンね。</p><p>その後、ウォレットに名前を付けられる <a href=https://ens.domains/ja/>ENS (Ethereum Name Service)</a> というサービスがあるのを教えてもらった。ちょうどいくらか ethereum をもってたので metamask に送金して、metamask で ens の登録 (購入) をやってみた。初めて ethereum を使ってサービスの支払いをやってみた。これで私も web3 を完全に理解したよ。ens で名前を登録 (購入) するのに $22.58 、ドメイン名みたいなものでサブドメインも登録できる。サブドメインを付けるのに $2.96 かかり、その ens を metamask に紐付けるのに $7.49 がかかった。metamask に紐付けると <a href=https://etherscan.io/>https://etherscan.io/</a> などで検索したときにウォレットのアドレスではなく、ens で購入した名前が表示されるようになる。トランザクションの履歴に名前が付いてそれが誰なのかが他人にもわかってしまうことがどういった影響を及ぼすのか、プライバシー云々の他に私はまだわかっていない。web3 なので購入した名前は一般公開されているものだけど、その名前は知り合いにしかまだ教えていない。暗号資産のウォレットに名前を付けることの意味や体験などをこれから経験してみる。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0220/>2021年度の確定申告</a></h1><div class=post-meta><time class=post-date>2022-02-20 (Sun.) ::</time></div><span class=post-tags>#<a href=/diary/tags/tax/>tax</a>&nbsp;
#<a href=/diary/tags/docker/>docker</a>&nbsp;
#<a href=/diary/tags/jib/>jib</a>&nbsp;</span><div class=post-content><p>0時に寝て6時に起きた。</p><h2 id=確定申告>確定申告</h2><p>本当は9時から受け付けなんだけど、昨年早めに行ったら受け付けしてくれたので今年も8時半ぐらいから出掛けていった。家から徒歩5分のところに特設の申告会場があって、行ったらすでに100人ぐらいは並んでいた。整理券を配るために行列を誘導している係員に「書類は作成済みで提出だけです」と伝えると「どうぞ、こちらへ」と行列をショートカットして、書類の作成会場の横にある提出会場へ案内される。朝一なので誰も提出してなくてすぐに応対してくれた。書類チェックして提出完了。会場についてから提出するまでに5分。あわせて10分もあれば確定申告できる。電子申告してもよいのだけど、寄付金の領収書の電子化が面倒なのでまだ紙で申告している。寄付金の領収書が電子化されて添付できるような手軽さになったら電子申告してもよいかもしれない。</p><h2 id=github-container-action-の検証>github container action の検証</h2><p><a href=https://github.com/GoogleContainerTools/jib>jib</a> という java アプリケーション向けの docker イメージをビルドするためのツールがある。お仕事で使い始めたので雰囲気を理解するために私もサンプルアプリケーションを <a href=https://github.com/t2y/jib-sample>jib-sample</a> として作ってみた。簡単に設定して java アプリケーションを docker 化できるので感触はよさそう。基本的に java アプリケーションと docker は相性が悪くて、たぶん go で開発するような用途と比較するとサイズがめちゃくちゃでかい。それでも jib を使うと作成された docker イメージのサイズも自分でビルドして作るよりは小さくしてくれる。さすが google という感じ。</p><p>この jib-sample の docker イメージを使って github actions のカスタム container action を作ってみたのが <a href=https://github.com/t2y/gh-actions-container-sample>gh-actions-container-sample</a> になる。<a href=https://docs.github.com/en/actions/creating-actions/creating-a-docker-container-action>Creating a Docker container action</a> のドキュメントには Dockerfile を使ったサンプルしか紹介されていないけど、docker イメージを直接参照して利用することもできる。</p><p>検証作業をしているときに jib-sample リポジトリの github packages が private 設定になっていることに気付かなくて少しはまった。リポジトリの visibility 設定と github packages の visibility 設定は連動していないのでそれぞれで別に管理しないといけない。</p><p>また jib で作った docker イメージはデフォルトでは manifest を作ってくれない。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ docker manifest inspect --verbose ghcr.io/t2y/jib-sample:latest
</span></span><span style=display:flex><span>no such manifest: ghcr.io/t2y/jib-sample:latest
</span></span></code></pre></div><p><a href=https://github.com/GoogleContainerTools/jib/blob/master/docs/faq.md#how-do-i-specify-a-platform-in-the-manifest-list-or-oci-index-of-a-base-image>How do I specify a platform in the manifest list (or OCI index) of a base image?</a> のドキュメントによると、manifest に platform 情報を追加するのは incubating feature らしくて、なんか条件付きで設定すれば使えそうにもみえたんだけど、私がやってみた感じだとうまくいかなかった。また必要ならもう一度調べてみる。</p></div></article><div class=pagination><div class=pagination__buttons><a href=/diary/tags/docker/page/2/ class="button next"><span class=button__text>過去の日記</span>
<span class=button__icon>→</span></a></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>© 2021 Tetsuya Morimoto</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>