<!doctype html><html lang=en><head><title>infrastructure :: forest nook</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/tags/infrastructure/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="infrastructure"><meta property="og:description" content><meta property="og:url" content="/diary/tags/infrastructure/"><meta property="og:site_name" content="forest nook"><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/tags/infrastructure/index.xml rel=alternate type=application/rss+xml title="forest nook"></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><div class=posts><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0621/>厄介なインフラ問題をやっつけた</a></h1><div class=post-meta><time class=post-date>2023-06-21 (Wed.) ::</time></div><span class=post-tags>#<a href=/diary/tags/infrastructure/>infrastructure</a>&nbsp;
#<a href=/diary/tags/operation/>operation</a>&nbsp;
#<a href=/diary/tags/podman/>podman</a>&nbsp;
#<a href=/diary/tags/event/>event</a>&nbsp;</span><div class=post-content><p>2時に寝て6時に起きて7時に起きた。夜に作業していたら遅くなった。</p><h2 id=厄介なインフラの問題-解決編>厄介なインフラの問題 解決編</h2><p><a href=/diary/posts/2023/0619/#運用のトラブルシューティング>運用のトラブルシューティング</a> の続き。アプリケーションアカウントを作って compose 環境を構築したら nginx のコンテナが起動して即時終了する状態になったという。これまで起きていた現象とまた違う問題が発生してさらに混迷をもたらすかに思えたが、私の中では nginx のコンテナでなにかがおかしいと問題の発生箇所を局所化できたのでそこからの調査はそんなに時間を必要としなかった。</p><p>結論からいうと podman の <a href=https://github.com/containers/aardvark-dns>aardvark-dns</a> の不具合だった。なんらかのトリガーでコンテナネットワーク内の名前解決が不整合な状態に陥る。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>vagrant@bookworm:$ podman-compose exec proxy /bin/bash
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>root@3742c45c7c60:/# dig app
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>; &lt;&lt;&gt;&gt; DiG 9.16.37-Debian &lt;&lt;&gt;&gt; app
</span></span><span style=display:flex><span>;; global options: +cmd
</span></span><span style=display:flex><span>;; Got answer:
</span></span><span style=display:flex><span>;; -&gt;&gt;HEADER<span style=color:#e6db74>&lt;&lt;- opco</span>de: QUERY, status: NOERROR, id: <span style=color:#ae81ff>56696</span>
</span></span><span style=display:flex><span>;; flags: qr rd ra ad; QUERY: 1, ANSWER: 8, AUTHORITY: 0, ADDITIONAL: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; OPT PSEUDOSECTION:
</span></span><span style=display:flex><span>; EDNS: version: 0, flags:; udp: <span style=color:#ae81ff>4096</span>
</span></span><span style=display:flex><span>; COOKIE: 37ff0fd63315d70e <span style=color:#f92672>(</span>echoed<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>;; QUESTION SECTION:
</span></span><span style=display:flex><span>;app.				IN	A
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; ANSWER SECTION:
</span></span><span style=display:flex><span>app.			86400	IN	A	10.89.0.36
</span></span><span style=display:flex><span>app.			86400	IN	A	10.89.0.36
</span></span><span style=display:flex><span>app.			86400	IN	A	10.89.0.136
</span></span><span style=display:flex><span>app.			86400	IN	A	10.89.0.136
</span></span><span style=display:flex><span>app.			86400	IN	A	10.89.0.146
</span></span><span style=display:flex><span>app.			86400	IN	A	10.89.0.146
</span></span><span style=display:flex><span>app.			86400	IN	A	10.89.0.156
</span></span><span style=display:flex><span>app.			86400	IN	A	10.89.0.156
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; Query time: <span style=color:#ae81ff>4</span> msec
</span></span><span style=display:flex><span>;; SERVER: 10.89.0.1#53<span style=color:#f92672>(</span>10.89.0.1<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>;; WHEN: Thu Jun <span style=color:#ae81ff>22</span> 02:45:26 UTC <span style=color:#ae81ff>2023</span>
</span></span><span style=display:flex><span>;; MSG SIZE  rcvd: <span style=color:#ae81ff>172</span>
</span></span></code></pre></div><p>podman 4.0 から aardvark-dns がコンテナネットワーク内での dns を提供する。nginx が app を名前解決したときに起動しているコンテナの ip アドレスではなく、削除された過去のコンテナの ip アドレスが返される状況が発生する。app という名前に対して複数の ip アドレスが返る。</p><p>このとき nginx は複数の ip アドレスのうちの1つに接続しようとするが、正しい ip アドレスでない場合、リクエストがタイムアウトする。タイムアウトした後に fallback で他の ip アドレスに接続しにいく。このときに正しい ip アドレスがみつかればクライアントにレスポンスが返る。この fallback のリトライの回数分だけリクエストのレイテンシの時間がかかっていた。</p><pre tabindex=0><code>vagrant@bookworm:$ podman logs -f proxy
...
2023/06/22 02:46:26 [error] 15#15: *41 connect() failed (113: No route to host) while connecting to upstream, client: 10.89.0.38, server: ucidmsv1-app, request: &#34;GET / HTTP/1.1&#34;, upstream: &#34;http://10.89.0.136:3000/&#34;, host: &#34;localhost:4430&#34;
2023/06/22 02:46:29 [error] 15#15: *41 connect() failed (113: No route to host) while connecting to upstream, client: 10.89.0.38, server: ucidmsv1-app, request: &#34;GET / HTTP/1.1&#34;, upstream: &#34;http://10.89.0.156:3000/&#34;, host: &#34;localhost:4430&#34;
2023/06/22 02:46:32 [error] 15#15: *41 connect() failed (113: No route to host) while connecting to upstream, client: 10.89.0.38, server: ucidmsv1-app, request: &#34;GET / HTTP/1.1&#34;, upstream: &#34;http://10.89.0.136:3000/&#34;, host: &#34;localhost:4430&#34;
10.89.0.38 - - [22/Jun/2023:02:46:32 +0000] &#34;GET / HTTP/1.1&#34; 200 2864 &#34;-&#34; &#34;curl/7.88.1&#34;
</code></pre><p>ワークアラウンドとして、次のファイルに複数の app の ip アドレスが登録されていれば不整合な状態なのでネットワークを削除して、このファイルも手動で削除してしまえばよい。</p><pre tabindex=0><code>$ cat /run/user/$(id -u)/containers/networks/aardvark-dns/mynetwork
</code></pre><p>ファイルを監視していると、どうやら mynetwork ファイルから名前と ip アドレスの情報が削除されるのは該当のコンテナが削除されるタイミングになる。なんらかのエラーにより、コンテナ削除時にマッピングの削除が実行されないと、古いコンテナのマッピング設定が残ったままとなり、compose サービスを起動したときに複数の ip アドレスの名前解決できる状態になってしまう。ちょっと調べても aardvark-dns に関する issue はたくさん登録されている。</p><ul><li><a href=https://github.com/containers/podman/issues/18783>https://github.com/containers/podman/issues/18783</a></li><li><a href=https://github.com/containers/podman/issues/18530>https://github.com/containers/podman/issues/18530</a></li><li><a href=https://github.com/containers/podman/issues/17370>https://github.com/containers/podman/issues/17370</a></li></ul><h2 id=コワーキングのオンラインイベント>コワーキングのオンラインイベント</h2><p>月例のカフーツさんのオンラインイベントに参加した。<a href=/diary/posts/2023/0517/#コワーキングのオンラインイベント>先月の所感はここ</a> 。今日はもともと予定していた話しをする参加者が急遽参加できなくなってしまったので他の参加者での雑談会になった。</p><p>いとうさん曰く、これまで外国人のデジタルノマドは自分で業務時間を選べるフリーランスの、さらにお金に余裕をもった人たちが多いと考えられていた。しかし、実際にコワーキングスペースに来られている外国人にキャリアを伺うと、大企業の普通の社員であることがわかってきた。グローバルな会社だと、働く場所に制限のない会社もあって、ただ日本へ行ってみたかった的な理由で日本へ来られて数ヶ月滞在して普通に会社のお仕事をするといったデジタルノマドもいるという。過去に私が働いていた職場の同僚も、コロナのときに会社がフルリモートワークの体制を設けて、airbnb で全国を旅しながら1年ほど働いていた。日本でもそういう社員はいるのだから外国人はなおさらという感じ。</p><p>そういった外国人のデジタルノマドが要求することが3つある。</p><ul><li>24時間利用できること (勤め先の会社と時差があるから)</li><li>セカンドモニターがあること</li><li>・・・ (あともう1つあったが、忘れてしまった)</li></ul><p>コワーキングスペースに外国人のデジタルノマドを呼び込むにはどうすればよいか。実際にコワーキングスペースへ来られた外国人に理由を伺うと英語のホームページをみて来ましたということらしい。至極、当たり前の話し。英語のホームページをちゃんと作ろうねみたいな話題で話していた。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0619/>運用トラブルの調査</a></h1><div class=post-meta><time class=post-date>2023-06-19 (Mon.) ::</time></div><span class=post-tags>#<a href=/diary/tags/infrastructure/>infrastructure</a>&nbsp;
#<a href=/diary/tags/operation/>operation</a>&nbsp;
#<a href=/diary/tags/web-design/>web design</a>&nbsp;</span><div class=post-content><p>0時に寝て5時に起きて7時に起きた。もう暑くて家でもエアコンを解禁した。エアコンがあると寝心地が違う、快適。</p><h2 id=運用のトラブルシューティング>運用のトラブルシューティング</h2><p><a href=/diary/posts/2023/0613/#厄介なインフラの問題-x-2>厄介なインフラの問題</a> のクリティカルな方から着手し始めた。<a href=https://github.com/containers/podman-compose>podman-compose</a> を使って rootless な環境構築をやってみたところ、nginx を tls 終端としてリバースプロキシとするアプリケーションサーバーとの通信が数回に1回ぐらいの頻度で遅くなる。通常は 100msec 程度でレスポンスが返るのが数秒から数十秒かかる。</p><p>もともと podman-compose はサポート対象外なのでそんながんばる必要はない。しかし、これも調査の過程でコンテナの技術を学ぶ1つだと考え再現環境を構築しようとした。vagrant の debian 12 と podman-compose をインストールして同様に環境構築してみたが、仮想環境では再現しない。どうやら環境要因のようだ。そこで問題が発生しているマシンで私のアカウントで環境構築してみたが、やはり再現しない。なんと個人アカウントの違いによって起きる現象のようだ。また質が悪いのは私のアカウントでは再現しないが、メンバー2人のアカウントでは再現している。一般ユーザーから他人のユーザーのプロセスやコンテナの情報にアクセスできるわけがないので調査ができない。個人アカウントで compose 環境を構築するのは諦めてアプリケーションアカウントを作ってやりましょうという話しにした。アプリケーションアカウントで再現すれば調査するし、再現しなければこんな環境要因のトラブルシューティングの優先度を下げてもいいかなぁとも考えている。どうなるかなぁ。</p><h2 id=サイトデザインのサンプルページ>サイトデザインのサンプルページ</h2><p><a href=/diary/posts/2023/0522/#サイトデザイン打ち合わせ>サイトデザイン打ち合わせ</a> の続き。実際のサンプルが出てきたのでデザインの雰囲気やコードも含めて確認していく。ざっとサンプルページを確認した。デザインはとても気に入っている。あとは私が hugo のテーマとしてテンプレートの組み込めるかどうか次第。今週末には実家帰らないといけないし、毎日やることがいっぱいいっぱい。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0616/>アイディアのコラボレーション</a></h1><div class=post-meta><time class=post-date>2023-06-16 (Fri.) ::</time></div><span class=post-tags>#<a href=/diary/tags/document/>document</a>&nbsp;
#<a href=/diary/tags/infrastructure/>infrastructure</a>&nbsp;
#<a href=/diary/tags/payment/>payment</a>&nbsp;
#<a href=/diary/tags/smartplug/>smartplug</a>&nbsp;
#<a href=/diary/tags/device/>device</a>&nbsp;</span><div class=post-content><p>2時に寝て何度か起きて7時に起きた。今日は勉強会の登板なのになにも準備できてなくてどうしようとか思いながら寝た。</p><h2 id=パッケージングとリリースのドキュメント>パッケージングとリリースのドキュメント</h2><p>5月の落ち穂拾いの時期にプロジェクトの開発ドキュメントを刷新していろいろな要項を書き残している。最後に残ったまだ書いていないドキュメントに次の2つがある。水曜日から課題管理やコードレビューの隙間時間に書き出していって3日ほどかけて一通り書き終えた。私は文章を書くのが遅いのと、1回ですべての内容を網羅できなくて、書いているうちに思い出して追記したり、寝かした文章をあとで見返して推敲したりすることが多い。そのため、ドキュメントを1週間ぐらいかけて書いたりする。</p><ul><li>パッケージング</li><li>リリース</li></ul><p>たまたまメンバーにあるモジュールをリファクタリングのために再実装してもらっている。その開発を完了したら古いモジュールと入れ替える必要があるので、開発だけではなく、パッケージングやリリース周りの作業を把握してもらう、よい機会と言える。これまでパッケージングやリリース周りのインフラはほとんど私が作って運用をまわしてきたので徐々にそれらを引き継ぐタイミングとも言える。開発者はインフラのことを気にせず、アプリケーションを開発してコミットすれば後はすべて ci/cd が自動的にいろいろやってくれて便利ぐらいの感覚で扱えるようにするのが、外資系などではプラットフォームに投資しろと言われたりするものだと推測する。うちらが開発しているプロダクトはコンテナ、RPM、Windows インストーラーとパッケージングする種類が多い。その要項に加えて QA 責任の考え方などについても書いておいた。主には私がいなくなった後に役に立つドキュメントとなるだろう。</p><h2 id=チーム勉強会>チーム勉強会</h2><p>本当は go の generics の勉強会をやりますと先週宣言していた。しかし、私が遊んでいて全然準備できなかったので代わりに決済とスマートプラグの話しをした。<a href=/diary/posts/2023/0612/>先週末と月曜日</a> に作った決済とスマートプラグを組み合わせたもの。サービスや仕組みを簡単に説明して、実際にデモを動かして電球を灯す。</p><figure><img src=/diary/img/2023/0616_payment-and-smartplug.png></figure><p>参加者からスマートプラグをラズベリーパイに置き換えてパワーリレーというモジュールを使えばもっとスマートにできるんじゃないかという意見が出た。たしかにラズベリーパイなら stripe の決済イベントを受け取るサーバーをデバイス内に同梱させることもできるかもしれない。そうすると、スマートプラグのような電源の on/off だけではなく、ラズベリーパイが扱えるセンサーとインテグレーションすることもできそう。また時間のあるときにやってみたい。コラボレーションって正にこういうことを言うとわかってきた。私が1人でこの仕組みを実装していたときにはラズベリーパイというキーワードはまったく頭の中になかった。他者の視点が加わるから新しいアイディアが広がる。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0509/>久しぶりのテックブログの執筆</a></h1><div class=post-meta><time class=post-date>2023-05-09 (Tue.) ::</time></div><span class=post-tags>#<a href=/diary/tags/docker/>docker</a>&nbsp;
#<a href=/diary/tags/infrastructure/>infrastructure</a>&nbsp;
#<a href=/diary/tags/writing/>writing</a>&nbsp;
#<a href=/diary/tags/subcontract/>subcontract</a>&nbsp;</span><div class=post-content><p>3時に寝て7時に起きた。昨日は連休明け初日なのに2時まで作業していた。開発が落ち着いたので夜に自社のお仕事をする余力が戻ってきたとも言える。</p><h2 id=docker-についてのテックブログ執筆>Docker についてのテックブログ執筆</h2><p>先日から <a href=/diary/posts/2023/0502/#docker-エコシステムの調査>Docker エコシステムの調査</a> をして、そこでわかったことをテックブログとしてまとめていた。一通り書き終えてマージリクエストを作成して社内レビューを依頼した。当初は <em>「ライブラリとしての Docker とは何か？」</em> というタイトルで書いていたものの、レビューを経て「ライブラリとしての」という修飾は必要ないことに気付いた。そのまま Docker のコンポーネントのソフトウェアスタックや過去の経緯や現状の雰囲気がわかるような記事にした。Docker を中心としたコンテナプラットフォームと標準化の概要について追っていく記事に仕上がった。インフラに関心をもつ人たちは少ないかもしれないけど、個人的にはコンテナの学びになってよい記事に仕上がったと思う。調査と執筆とレビューを含めると5人日ぐらいかけている。かけた工数を考えれば当然と言えるかもしれない。</p><h2 id=デザイナーさんと契約締結>デザイナーさんと契約締結</h2><p>昨日の続き。デザイナーさんからいただいたワイヤーフレームをレビューして、契約書の叩き台も送付して、先方の所感や意見も伺いながら契約を締結した。基本的にはこちらが提示した契約書の通りに進んだのでとくに揉めることなくうまくいったと言える。顧問のはらさんからデザイナーと契約をするときの要項を事前にヒアリングしていて、その詳細を盛り込めんたこともよかったと思える。サイトデザインをお願いするものの、hugo のテンプレートは私が実装しないといけない。ある意味デザイナーと協調してサイトデザインを構築すると言えるかもしれない。私もそこから学ぶ機会があるだろうし、その過程でできた成果物は hugo のテーマとして oss で公開したい。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0502/>飛び石のお仕事</a></h1><div class=post-meta><time class=post-date>2023-05-02 (Tue.) ::</time></div><span class=post-tags>#<a href=/diary/tags/docker/>docker</a>&nbsp;
#<a href=/diary/tags/infrastructure/>infrastructure</a>&nbsp;
#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/career/>career</a>&nbsp;</span><div class=post-content><p>0時に寝て何度か起きて7時に起きた。休んでもよかったんだけど、休む理由がないので飛び石でお仕事することにした。</p><h2 id=docker-エコシステムの調査>docker エコシステムの調査</h2><p>少し前に <a href=/diary/posts/2023/0327/>docker をライブラリとして使って運用ツールを作った</a> 。その内容をテックブログに書こうと思って docker のソフトウェアスタックやアーキテクチャの背景を調べ直していた。もっとたくさんいろんな記事を読んだのだけど、次の記事とそこから辿れるものを読むとよいだろうと思う。</p><ul><li><a href=https://blog.inductor.me/entry/2019/11/22/072353>Docker社がエンタープライズ事業を譲渡した今、Dockerの父が思うこと</a></li><li><a href=https://www.tutorialworks.com/difference-docker-containerd-runc-crio-oci/>The differences between Docker, containerd, CRI-O and runc</a><ul><li><a href=https://thenewstack.io/oci-building-way-kubernetes-run-containers-without-docker/>Red Hat, Google Engineers Work on a Way for Kubernetes to Run Containers Without Docker</a></li></ul></li></ul><p>コンテナに関して cri と oci という2つの標準化があることを学び、その実装として docker 社が使っているツールに関係があるのが次の3つになる。おもしろいことにすべて docker 社のリポジトリにはなく、oss として然るべき所管の organization にリポジトリがある。</p><ul><li><a href=https://github.com/moby/moby>https://github.com/moby/moby</a></li><li><a href=https://github.com/opencontainers/runc>https://github.com/opencontainers/runc</a></li><li><a href=https://github.com/containerd/containerd>https://github.com/containerd/containerd</a></li></ul><p>すべて docker 社がオリジナルを作って、いまも moby は docker 社が主体となって開発を継続しているだろうけれど、コンテナの実行環境のプラットフォームは k8s に取って変わられ、cri のコンテナランタイムとしての containerd があれば moby は docker daemon や docker engine のためのツールでしかなくなっている。当初 docker と moby を分割したのは、docker を開発ツール、moby を infrastructure にするという判断の下、moby を k8s のようなプラットフォームにしたかったはずである。しかし、結果的にその標準化競争に破れ containerd があれば dockerd daemon は不要になったとも解釈できる。docker という名前はコンテナのエコシステムにおいて docker 社が提供するコマンドラインやプロダクトの総称としての名前でしかなくなってしまっていて、一世を風靡した docker というパッケージングシステムの開発元に同情してしまう感もある。いまの docker engine は docker daemon と containerd の2つの daemon を起動していて docker 社としては微妙なアーキテクチャになっているのではないかと推測する。とくに swarm なんか最早削除したいだろう。</p><p>こういった docker を取り巻くエコシステムやツールの背景を説明するだけでも1つの記事になりそうなことが1日調べていてわかった。</p><h2 id=しくじり先生>しくじり先生</h2><p>たまたま <a href=https://www.tv-asahi.co.jp/shikujiri/backnumber2/0099/>竹原慎二先生「５０歳過ぎてもケンカを売られ続けてバリしんどい先生」</a> をみたらおもしろかった。ガチンコをリアルタイムでみていた世代なので竹原氏には好感をもっている。少し前に <a href=https://www.nhk.or.jp/kenko/atc_731.html>【あの人の健康法】元プロボクサー・竹原慎二の膀胱（ぼうこう）がんとの闘い</a> のような、闘病生活の記事もみかけていた。病気は克服してがんばっているといるようにみえる。よかった。もう51歳なのか。</p><p>この番組の中で若い頃に上京してボクシングジムへ通ったときに根性の定義が変わったという話しが出てくる。</p><blockquote><p>殴られても耐えることを根性だと思っていた。そのときに初めて殴られようが何しようが毎日辛い練習を重ねるのが根性だと気付かされた。</p></blockquote><p>地元で最強だったのが、ボクシングジムのヤンキーでもない先輩にまったく太刀打ちできなかったという。そのとき1番違うのはスタミナだったらしく、竹原氏は1分で息がきれるのに相手は軽く流すといった様相だった。この先輩にボコボコにされた経験を経てそれから心を改めて真面目になったと言う。その後ボクシングと真剣に向き合い、1995年に日本人初のミドル級世界チャンピオンになる。おそらく番組の主旨的に若ものへのメッセージとして「強さ」について話されていた。</p><blockquote><p>「ケンカに強い」だけが「強さ」じゃない、「強さ」の意味を履き違えずに生きよう。大人になると、いろんな強さを知る。大切な人のために仕事をどれだけ頑張れるか、辛い状況でもじっと耐えることができるか。そういう強さもある。</p></blockquote><p>私は誰かのために仕事をがんばったことないし、辛い状況を耐えるみたいなこともほぼやってなくて、嫌になったら仕事を辞めてて、こういう言葉にあうと自分を恥じてしまう。その後、喧嘩自慢で youtube 動画を検索していたらまさにそういうのがあった。竹原氏が「勝てるはずねぇだろ、お前らこんな茶番なことすんなよ」とぼやいていた。先の番組の中でも触れていたが、本当に真剣勝負したいと思って来ているのではなく、記念に戦ってみたいという不純な動機でやってくる人が多いらしい。たしかにそれは相手するのがしんどそう。</p><div class=video-container><iframe src=https://www.youtube.com/embed/O2rjpxf9W7U allowfullscreen title=懲りない喧嘩自慢に終止符を打ってみた></iframe></div></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/1212/>docker compose に期待しない</a></h1><div class=post-meta><time class=post-date>2022-12-12 (Mon.) ::</time></div><span class=post-tags>#<a href=/diary/tags/gitlab/>gitlab</a>&nbsp;
#<a href=/diary/tags/docker/>docker</a>&nbsp;
#<a href=/diary/tags/infrastructure/>infrastructure</a>&nbsp;
#<a href=/diary/tags/founding/>founding</a>&nbsp;</span><div class=post-content><p>0時に寝て5時に起きて7時に起きた。起きたら冷やしたのかお腹痛かったが、まぁまぁ眠れたと思う。</p><h2 id=テスト環境の構築>テスト環境の構築</h2><p><a href=https://docs.gitlab.com/ee/ci/>GitLab CI/CD</a> にだいぶ慣れてきてジョブを追加したり改善したりしながらようやくアプリケーションの docker image もコンテナレジストリに push されるようになった。それを pull してきて、テスト環境を <a href=https://docs.docker.com/compose/>docker compose</a> で構築する。<a href=https://docs.docker.com/compose/production/>Use Compose in production</a> とドキュメントでは威勢がよいが、これが全然イケてない。複数の compose.yml で項目によっては変更したいところを置き換えるといった振る舞いになっていない。例えば、ポート番号などを dev と prod で置き換えたいといった運用の要件を考える。</p><ul><li>dev.yml</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>myapp</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>18080</span>:<span style=color:#ae81ff>8080</span>
</span></span></code></pre></div><ul><li>prod.yml</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>myapp</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>8080</span>:<span style=color:#ae81ff>8080</span>
</span></span></code></pre></div><p>これを次のように指定すると、</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ docker compose -f dev.yml -f prod.yml up -d
</span></span></code></pre></div><p>実際のサービスは次のように振る舞う。全然あかん。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>myapp</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>18080</span>:<span style=color:#ae81ff>8080</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>8080</span>:<span style=color:#ae81ff>8080</span>
</span></span></code></pre></div><p>他にもそれぞれの yml ファイルで読み込む environment file のマージなどもよくわからない振る舞いをしていて複数の compose.yml で制御するのは断念した。dry の原則に反して設定は重複するけど、それぞれの環境を個別に compose.yml として管理した方が保守コストは小さくなると私は判断した。複数の compose.yml の使い分けのデバッグを1-2日やった後に諦めてテスト環境の構築は完了した。</p><h2 id=年金事務所の住所変更手続き>年金事務所の住所変更手続き</h2><p>先週 <a href=/diary/posts/2022/1205/#法務局で法人登記の変更申請>法務局で法人登記の変更申請</a> をしていて、そのときに問題がなければ今日から登記事項証明書を取得できると案内をもらっていた。決定書が漏れていて再提出というトラブルはあったものの、最小限の損失で留めたせいか、問題なく登記事項証明書を発行できた。住所の変更だけわかればよいので履歴事項証明書ではなく現在事項証明書を発行してみた。この書類もおもしろくて1つ前の住所といまの住所の2つを確認できる。法務局へ行った帰りに年金事務所へ立ち寄って社会保険の住所変更の手続きを行った。次の3つの書類をもって窓口へ。</p><ul><li>登記事項証明書: 番地まで記載されている</li><li>オフィスの一時使用契約書: ビル名はあるがこのビル名は来月に改名</li><li>ビル名変更の証明書類: ビル名の変更のみが記載されている</li></ul><p>この3つの書類で完全に指定された住所 (Fully Qualified Address: 造語) を丁寧に説明したところ担当者に納得してもらえて事なきを得た。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/1111/>ログおじさん</a></h1><div class=post-meta><time class=post-date>2022-11-11 (Fri.) ::</time></div><span class=post-tags>#<a href=/diary/tags/infrastructure/>infrastructure</a>&nbsp;
#<a href=/diary/tags/mermaid/>mermaid</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/logging/>logging</a>&nbsp;</span><div class=post-content><p>23時に寝て3時半に起きて眠れそうになかったからそのまま5時からオフィスで作業してた。</p><h2 id=システム構成の検討>システム構成の検討</h2><p>コンサルタントから顧客要件のヒアリングを行い、プロダクトを提供するインフラのシステム概要を mermaid で書いた。オンプレとクラウド環境のそれぞれを同じコンテナアプリケーションで動かすための構成を検討した。クラウド環境の一例として aws の構成を考えていて、https と http のプロトコル変換のようなことをするには api gateway を経由しないといけないと考えていたら、alb に証明書を設定して api gateway なくてもいけるとはらさんに教えてもらった。昔からできたそうで、なぜか私が長い間ずっと勘違いしていた。また時間があるときに自分でもやってみようと思う。</p><ul><li><a href=https://dev.classmethod.jp/articles/for-begginer-ssl-communication-by-aws-certificate-manager/>AWS Certificate Managerを使用してインターネットからELBへの通信をHTTPS化してみた</a></li></ul><h2 id=logger-の再実装>Logger の再実装</h2><p>プロダクトのコアな部分の実装は私がみた方がよいだろうと考えていて、そのうちの1つ Logger の設計がよくなかったので私が作り直した。といっても <a href=https://github.com/cybozu-go/log>cybozu-go/log</a> を使った薄いラッパーを設けただけ。チームメンバーからどこでエラーが起きているか追跡しにくいという声があったのでログ出力したところのソースコードの情報を出力しようと考えた。ググればたくさん出てくる。スタックフレームにアクセスする標準パッケージとして runtime を使うとできる。<a href=https://pkg.go.dev/runtime#Caller>runtime.Caller</a> と runtime.Callers は似て非なる関数のようでファイル名と行番号だけでよければ Caller を使った方がシンプルになると思う。関数名もほしかったら Callers を使ったスタックフレーム自体から取得する必要がある。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Trace</span>(<span style=color:#a6e22e>skip</span> <span style=color:#66d9ef>int</span>) (<span style=color:#a6e22e>file</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>funcName</span> <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>pc</span> <span style=color:#f92672>:=</span> make([]<span style=color:#66d9ef>uintptr</span>, <span style=color:#ae81ff>15</span>)
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>n</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>Callers</span>(<span style=color:#a6e22e>skip</span>, <span style=color:#a6e22e>pc</span>)
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>frames</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>CallersFrames</span>(<span style=color:#a6e22e>pc</span>[:<span style=color:#a6e22e>n</span>])
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>frame</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>frames</span>.<span style=color:#a6e22e>Next</span>()
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>_file</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>frame</span>.<span style=color:#a6e22e>File</span>[<span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Index</span>(<span style=color:#a6e22e>frame</span>.<span style=color:#a6e22e>File</span>, <span style=color:#a6e22e>sourceRepositoryPath</span>)<span style=color:#f92672>+</span><span style=color:#ae81ff>8</span>:]
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>file</span> = <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;%s:%d&#34;</span>, <span style=color:#a6e22e>_file</span>, <span style=color:#a6e22e>frame</span>.<span style=color:#a6e22e>Line</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>file</span>, <span style=color:#a6e22e>frame</span>.<span style=color:#a6e22e>Function</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>この情報を cybozu-go/log の map に追加するようなログ関数を提供するようにした。cybozu-go/log は標準の log パッケージに足りないところだけを追加していて、そのシンプルさと拡張性の高さを私は気に入ってよく使っている。私が気に入っているのでもっと有名になってほしい。</p><p>前のお手伝いでもログ基盤を含めて Logger を作っていて、またいまも Logger を作り直していて、気付いたら私は Logger やログ出力に一家言あるような、ログおじさんになりつつある。</p></div></article><div class=pagination><div class=pagination__buttons><a href=/diary/tags/infrastructure/ class="button previous"><span class=button__icon>←</span>
<span class=button__text>最近の日記</span></a>
<a href=/diary/tags/infrastructure/page/3/ class="button next"><span class=button__text>過去の日記</span>
<span class=button__icon>→</span></a></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>© 2021 Tetsuya Morimoto</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>