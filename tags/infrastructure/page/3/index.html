<!doctype html><html lang=en><head><title>infrastructure :: forest nook</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/tags/infrastructure/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="infrastructure"><meta property="og:description" content><meta property="og:url" content="/diary/tags/infrastructure/"><meta property="og:site_name" content="forest nook"><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/tags/infrastructure/index.xml rel=alternate type=application/rss+xml title="forest nook"></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><div class=posts><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/1017/>副反応終わり</a></h1><div class=post-meta><time class=post-date>2022-10-17 (Mon.) ::</time></div><span class=post-tags>#<a href=/diary/tags/cdk/>cdk</a>&nbsp;
#<a href=/diary/tags/infrastructure/>infrastructure</a>&nbsp;</span><div class=post-content><p>0時に寝て7時半に起きた。久しぶりによく寝た。ワクチン接種の副反応はおさまり体調は回復した。昼間は UI 改善やバグ修正をしていた。</p><h2 id=インフラ勉強会>インフラ勉強会</h2><p>引き継ぎを兼ねて cdk の使い方、簡単な本番環境向けのデプロイ作業を共有した。wiki に一通りの説明は書いてあって、実際に cdk アプリケーションのソースや設定をみたり、cloud formation のドリフトを検出して解消するのを実践したりしてた。そんな中、別の不具合もみつけた。rds のデータベースのバージョン情報が次のように差分として出力される。</p><pre tabindex=0><code>Resources
[~] AWS::RDS::DBInstance GodPostgreSQL/Instance1 GodPostgreSQLInstance1857D2683
 └─ [-] EngineVersion
     └─ 13.6
</code></pre><p>少し前にたまたま cdk のバージョンを 2.44.0 にアップグレードしてあったのだけど、この差分は 2.44.0 以降で発生する。次の issue の説明によると、メジャーバージョンをまたぐ rds のアップグレードを cdk で実行すると、Stack が回復不能な状態になるのでそのワークアラウンドとしてバージョン情報をみえなくしてしまって、誤って cdk で rds のアップグレードできないようにしているとのこと。この差分はとくに気にする必要なく、一度デプロイしてしまえば次回からは出力されなくなる。インフラにも影響は与えないとのこと。</p><ul><li><a href=https://github.com/aws/aws-cdk/issues/21758>(rds): AWS::RDS::DBInstance should not have EngineVersion property set for Aurora clusters #21758</a></li></ul><p>過去にマイナーバージョンアップは試したことがあって、やはりエラーにはなるのだけど、実際のインフラはアップグレードされて、それで運用上は問題なかったようにみえる。但し、cdk 正しく rds のアップグレードを扱えないというのは確かであるようにみえる。</p><blockquote class=twitter-tweet><p lang=ja dir=ltr>試しに今日 aurora postgresql のバージョンを 13.4 から 13.6 にアップグレードしたらデプロイは失敗してるのに実際のインフラはアップグレードして、cf のテンプレートが実際のインフラと不整合になった。手動でテンプレートを更新して cdk のコードと同期する必要がある。</p>&mdash; Tetsuya Morimoto (@t2y) <a href="https://twitter.com/t2y/status/1517831237997838336?ref_src=twsrc%5Etfw">April 23, 2022</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/1013/>サイトコントローラーの障害は大変そう</a></h1><div class=post-meta><time class=post-date>2022-10-13 (Thu.) ::</time></div><span class=post-tags>#<a href=/diary/tags/infrastructure/>infrastructure</a>&nbsp;
#<a href=/diary/tags/java/>java</a>&nbsp;
#<a href=/diary/tags/life/>life</a>&nbsp;</span><div class=post-content><p>0時に寝て3時に起きて6時半に起きた。だいぶよく眠れるようになってきた。</p><h2 id=サイトコントローラーの障害>サイトコントローラーの障害</h2><p>お手伝いしている宿泊業のシステムでトラブルが発生している。厳密には外部サービスになるのだが、複数のオンライン予約サイトの違いを吸収して単一のインターフェースを提供する宿泊業のハブシステムのような存在をサイトコントローラーと呼ぶらしい。週明けから全国旅行支援という新しいGoToトラベルが開始されて、その予約が想定以上のトラフィックになっていてサイトコントローラーがダウンしてしまった。web 開発者向けに例えれば aws の s3 が落ちて大半のサービスに影響が出てなんもできないみたいな状況かな。</p><ul><li><a href=https://www.traicy.com/posts/20221012252499/>宿泊施設向け予約・販売管理システム「TL-リンカーン」、復旧目処立たず　約5,100施設に影響</a></li></ul><p>全国レベルのニュースになるぐらいの障害規模が大きいらしい。それだけユーザーが多いシステム／事業者なんだろうとは思う。システムと向き合う上で障害が発生するのは仕方ないが、フォールトトレランスは常に意識して設計・運用しないといけないことを、今回の障害を傍からみていて感じた。</p><h2 id=java-のちょっとした小技>java のちょっとした小技</h2><p>java で1つのリストを複数のリストに分割したいときに <a href=https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/List.html#subList(int,int)>List.subList</a> というメソッドがある。複数の値を並行処理するときなど入力を分割するのに便利そう。使い方は次の通り。toIndex を超えると IndexOutOfBoundsException が投げられるのでそこだけ注意かな。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>var total <span style=color:#f92672>=</span> myList<span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>var step <span style=color:#f92672>=</span> <span style=color:#ae81ff>20</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> total<span style=color:#f92672>;</span> i <span style=color:#f92672>+=</span> step<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    var toIndex <span style=color:#f92672>=</span> i <span style=color:#f92672>+</span> step<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>toIndex <span style=color:#f92672>&gt;</span> total<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        toIndex <span style=color:#f92672>=</span> total<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    var subList <span style=color:#f92672>=</span> myList<span style=color:#f92672>.</span><span style=color:#a6e22e>subList</span><span style=color:#f92672>(</span>i<span style=color:#f92672>,</span> toIndex<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// do something
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=シャンプー>シャンプー</h2><p>散髪屋さんのマスターからシャンプーを変えた方がいいんじゃないかとアドバイスされた。髪は油分と水分のバランスが大事らしく、シャンプーによって変わることもあるらしい。いつからか記憶にないけど、少なくとも学生時代から私はずっと <a href=https://www.kao.co.jp/merit/products/norinse/>メリット リンスのいらないシャンプー</a> を使っている。20年ぐらい？こだわりがあるわけでもないし、このシャンプーを使っていて懸念があったことは一度もない。マスターから <a href=https://hscare.jp/shop-products/men/all-collections>h&s scalp</a> がよいとお勧めされた。せっかくの機会だから試してみようかなと思う。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0922/>勉強会が2つ</a></h1><div class=post-meta><time class=post-date>2022-09-22 (Thu.) ::</time></div><span class=post-tags>#<a href=/diary/tags/infrastructure/>infrastructure</a>&nbsp;
#<a href=/diary/tags/finance/>finance</a>&nbsp;
#<a href=/diary/tags/event/>event</a>&nbsp;</span><div class=post-content><p>0時に寝て6時に起きた。涼しくて体調は抜群。</p><h2 id=インフラ引き継ぎ勉強会>インフラ引き継ぎ勉強会</h2><p>先週引き継ぎのためのインフラドキュメントを書いていたものをチームの開発者に共有した。今日は開発者向けの話しなので <a href=/diary/posts/2022/0919/#ドキュメントを書き終えた>5日以上かけた非開発者向けのインフラドキュメント</a> は使わないが、社員さんによると、(私が参加していない社員さんだけの) 別の開発者チャンネルで読まれているとのこと。時間をかけたので多くの人に読んでもらえるに越したことはない。但し、そのフィードバックは私には一切ないので役に立っているのかどうかの判断しようがない。業務委託にそういう外様感を与えるかどうかは組織によって大きく異なる。過去に働いたある会社では自由に勉強会に参加したり他チームのメンバーとも技術の議論をできたりした。私は技術の話題に対しては真摯なので当たり前のように感じていたが、あの会社のあの文化は特別だったのだとそれから別の数社で働いてみて気付いた。</p><p>書いたインフラドキュメントに沿って一通り説明して、ほとんど実務をやっていないメンバーではあまりイメージができないと思うので質問もそれほどなかった。次回は実際にどうやってインフラのデプロイをするかの作業をみんなで確認しながら cdk の使い方などの話しをしようと思う。</p><h2 id=インフレ勉強会>インフレ勉強会</h2><p><a href=https://fin-py.connpass.com/>fin-py</a> の月例のインフレ勉強会に参加した。背景はわかってないが、connpass イベントではない。市場調査や金融の勉強のために最近は毎月出席している。</p><blockquote class=twitter-tweet><p lang=ja dir=ltr>明日9/22(木)19:00-20:00にインフレ研究会をやります<a href=https://t.co/b6gabjIRYY>https://t.co/b6gabjIRYY</a><br>研究会といっても物価に関連する雑談です、どなたでも参加できます<br>Twitterのコミュニティはこちらです<a href=https://t.co/jBBn07Ahtg>https://t.co/jBBn07Ahtg</a></p>&mdash; driller/どりらん (@patraqushe) <a href="https://twitter.com/patraqushe/status/1572558645837320193?ref_src=twsrc%5Etfw">September 21, 2022</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script><p>直前に政府の円買いの為替介入あったのが話題になってた。政府が本気？出せばこんな勢いで5円も動くらしい。為替介入はサプライズが大事らしくて、サプライズという側面ではみんなびっくりしたので効果はあったのかもしれない。</p><blockquote class=twitter-tweet><p lang=ja dir=ltr>きょうの外国為替市場では、政府・日銀が市場介入を行ったことで、それまで1ドル＝145円台後半の円安ドル高水準で推移していた円相場が、一時、一気に140円台前半まで円高方向に。<br>夕方の円相場の動きです。<a href=https://t.co/2PZ8BqzH00>https://t.co/2PZ8BqzH00</a><a href="https://twitter.com/hashtag/nhk_video?src=hash&ref_src=twsrc%5Etfw">#nhk_video</a> <a href=https://t.co/FPg9Ydvihw>pic.twitter.com/FPg9Ydvihw</a></p>&mdash; NHKニュース (@nhk_news) <a href="https://twitter.com/nhk_news/status/1572880709274181632?ref_src=twsrc%5Etfw">September 22, 2022</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script><p>fin-py の中の人もこんな勢いで動くのは珍しいと話していた。日本が為替介入するときは米国にお伺いを立てないといけないらしく、米国がうんと言わないと実弾の為替介入はできないことが多いらしい。中の人によれば、いまも米国は日本の為替介入をよくは思ってないだろうと推測されるので、こんなことをずっと続けられるかどうかは懐疑的だという。さらに世の中のトレンドはドル高なので為替介入しても一時的なもので意味がないという考え方もあるとのこと。今回の介入の意味があったかどうかは今後の為替が安定するかどうかで判断される。日本は世界でトップクラスに外貨準備のドルをもっている国なのも事実なので為替介入の実弾もたくさんあるから今後も介入する可能性はある。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0915/>インフラと非開発者</a></h1><div class=post-meta><time class=post-date>2022-09-15 (Thu.) ::</time></div><span class=post-tags>#<a href=/diary/tags/infrastructure/>infrastructure</a>&nbsp;
#<a href=/diary/tags/document/>document</a>&nbsp;</span><div class=post-content><p>0時に寝て5時に起きて7時に起きた。</p><h2 id=インフラのドキュメント作成の続き>インフラのドキュメント作成の続き</h2><p>昨日はインフラ構成図を主に書いていたが、今日は引き継ぎのために wiki に概要を書いて補足事項なども肉付けしながら、私がやったことや今後運用していく上で知っておくべきことなどをまとめていた。それと同時に backlog の wiki の階層構造なども見直していた。backlog の wiki はタイトルに <code>/</code> を含めることで階層構造を表す。実際の url はエイリアスリンクが使われていて、タイトルとは無関係なので wiki のタイトルを変更することで階層構造が変わる。これはこれでお手軽とも言えるけれど、この階層以下のドキュメントをすべて移動したいといったときは1つずつタイトルを変えないといけないので面倒になる。デイリースクラムのときに来週のインフラ勉強会の時間もスケジュールを抑えてもらった。おそらく1回では終わらないのではないかと推測するが、説明してみて開発者の反応もみながら2回目の有無を決める。</p><p>さらに「プロダクトオーナーのためのインフラ入門」というタイトルで別のドキュメントも書き始めた。他の重要な業務がなくて暇だと言ってしまえばそうなのだけど、非開発者向けにクラウドのインフラや自分たちの web システムをどう理解してもらうのがよいか、私自身、試行錯誤で答えをもっているわけではないが、難しいからプロダクトオーナーはインフラを理解しなくてよいというつもりもない。以前からプロダクトオーナーが「自分たちもインフラがどうなっているのかを理解したい」というコメントを何度か聞いていたので筆を取った次第だ。技術的な詳細は理解できないだろうが、いまどきのインフラにおいてどういった概念や考え方が重要なのか、なぜこのような複雑なインフラになってしまっているのか、そうした背景を理解してもらおうと考えている。初めての試みなので、後日やってみて反応をみてふりかえりしようと思う。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0914/>インフラと引き継ぎ</a></h1><div class=post-meta><time class=post-date>2022-09-14 (Wed.) ::</time></div><span class=post-tags>#<a href=/diary/tags/infrastructure/>infrastructure</a>&nbsp;
#<a href=/diary/tags/document/>document</a>&nbsp;</span><div class=post-content><p>0時に寝て6時に起きた。</p><h2 id=インフラのドキュメント作成>インフラのドキュメント作成</h2><p>契約終了まであと1ヶ月半。私が唯一引き継ぎしないといけないものにインフラがある。</p><p>引き継ぐ前のインフラは本当にひどい状態だった。手抜き工事のまま放置されたような状態だった。cdk のコードから実際のインフラを構築することはできなくて、コード化されていないところを aws のマネジメントコンソールから手作業で設定していた上、どこを手作業で設定していたかの情報は一切残されていなかった。新しいインフラが追加されるときに cdk のコードと乖離があるからデプロイできなくて、それを前任者は直せなくて私が引き継いだという経緯がある。私が1ヶ月ほどかけて30以上の pr を作ってコードと実際のインフラをほぼ完全に同期させた。その過程で3回ほど (テスト環境ではあるが) 障害も発生させている。デプロイしたら手動設定が消えて壊れてしまう。何が手動設定で何がコード管理なのかの情報が何もないのだからデプロイしてみないと動くかどうかわからないという状況だった。そのため、現在のインフラは私が作り直したと言っても過言ではない。cdk のバージョンも v1 から v2 にアップグレードした。半分以上の cdk のコードは私が書いたと思う。その引き継ぎならびにドキュメント化の作業にようやく着手した。これまで書いてなかったのはインフラを管理しているのは私だけだったのでドキュメントなくても運用上の問題はなく、ドキュメントタスクの優先順位が低かったから。今日は draw.io で aws のシステム構成図を書き上げて、wiki のインフラドキュメントの再構築に着手したところ。</p><p>今週中に引き継ぎのドキュメントを書いて、来週ぐらいからインフラ勉強会やって引き継ぎを完了させる予定。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0817/>たまには画面作り</a></h1><div class=post-meta><time class=post-date>2022-08-17 (Wed.) ::</time></div><span class=post-tags>#<a href=/diary/tags/infrastructure/>infrastructure</a>&nbsp;
#<a href=/diary/tags/migration/>migration</a>&nbsp;
#<a href=/diary/tags/vue.js/>vue.js</a>&nbsp;</span><div class=post-content><p>1時に寝て6時に起きた。</p><h2 id=リファクタリングとインフラ移行>リファクタリングとインフラ移行</h2><p>ここ2週間ほどリファクタリングやらインフラ変更やらをしてきて、来週からまた新しい施設がサービスインするので区切りとしてリファクタリングは一旦終わりにする。今日がその集大成となるインフラ移行も含めた本番リリースだった。インフラ移行するときはなにかしら障害が起きる前提で待機しているものの、今日もすんなりと意図した通りに移行できて、してやったりではあるものの、モノ足りなさで拍子抜けしてしまった。また昨日から社内 wiki にも minikube の使い方、k8s cronjob の設計、バッチ処理の設計と実装についてドキュメントなどを書いていた。いままですべて私が1人で担当していたものを他メンバーでも作業できるようにドキュメント化した。近いうちにいなくなるので引き継ぎのドキュメントにもなる。</p><h2 id=nuxt-で画面作り>nuxt で画面作り</h2><p>ここ最近2種類の web api の機能を作ったのでその管理画面も2つ作る必要がある。私はフロントエンド開発の素人なので他のメンバーが作ってくれないかと声をかけてはいたけど、みんな忙しいようなので私が作ることにした。今週は <a href=https://nuxtjs.org/ja/>nuxtjs</a> の新規画面の開発をがんばってみようと思う。既存のソースを読む限りはそんなに複雑ではなさそう。素人が雰囲気で実装しても動くんじゃないかと思っている。ソースコードを読んでいて url 設計はめちゃくちゃだし、一覧画面にはページング機能も実装されていない。素人がソースを読んで基本的な骨子や機能が正しく実装されてないことがわかってしまうのは品質レベルとしてなにかがおかしい。圧倒的低品質と呼ぶのか、こんなことが起こってしまうのはよい開発文化がないせいなのだろうと考えている。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0727/>無障害インフラ移行</a></h1><div class=post-meta><time class=post-date>2022-07-27 (Wed.) ::</time></div><span class=post-tags>#<a href=/diary/tags/infrastructure/>infrastructure</a>&nbsp;</span><div class=post-content><p>0時に寝て6時に起きた。</p><h2 id=本番環境リリースのサポート>本番環境リリースのサポート</h2><p><a href=/diary/posts/2022/0719/#2つ目のサービスイン>サービスイン</a> のバタバタによって毎週の定例リリースを先週はやらなかった。そのため、今回は2週間分の変更をまとめてリリースすることになった。インフラの変更が複数あったので私も万全の準備をして作業に備えた。</p><ul><li><a href=/diary/posts/2022/0725/#waf-のカスタムレスポンス>waf を使ったメンテナンス切り替えの導入</a></li><li><a href=/diary/posts/2022/0720/>k8s のノードグループと nodeSelector の導入</a></li></ul><p>他にもいくつか本番のマスターデータの更新など、箇条書きにした作業項目は15個になった。今回はインフラとアプリケーションが相互に依存する変更を加えているので意図した順番で作業しないといけない。ノードグループ導入による k8s の作業内容は wiki にすべて作業方法を書いていたのでその通りに作業してもらった。メンテナンスモードに切り替える初動もうまくいったので現場の運用担当者が間違って使うこともない。意図した作業内容と順番でうまくリリース作業もできた。メンテナンス時間を2時間もらっていて、宿泊業だとその時間帯が12-14時になる。宿泊客のチェックアウト後、チェックイン前の空き時間だ。メンテナンス後に運用担当者にすぐ確認もしてもらえるし、リリース作業の時間帯としては深夜早朝にしなくてよいのは助かる。私が想定した通りに作業は進み、1時間でリリース作業を終えた。障害も一切なかった。インフラ担当者は想定外の障害に備えて、切り戻しやリスク管理をする。まったく問題なく想定内だったので晴れ晴れしい気持ちになった。こういう気持ちはインフラ担当者にしかわからないと思う。</p></div></article><div class=pagination><div class=pagination__buttons><a href=/diary/tags/infrastructure/page/2/ class="button previous"><span class=button__icon>←</span>
<span class=button__text>最近の日記</span></a>
<a href=/diary/tags/infrastructure/page/4/ class="button next"><span class=button__text>過去の日記</span>
<span class=button__icon>→</span></a></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>© 2021 Tetsuya Morimoto</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>