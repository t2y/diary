<!doctype html><html lang=en><head><title>github :: forest nook</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/tags/github/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="github"><meta property="og:description" content><meta property="og:url" content="/diary/tags/github/"><meta property="og:site_name" content="forest nook"><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/tags/github/index.xml rel=alternate type=application/rss+xml title="forest nook"></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><div class=posts><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0810/>出張帰りにオフィスに寄って開発する</a></h1><div class=post-meta><time class=post-date>2023-08-10 (Thu.) ::</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/logging/>logging</a>&nbsp;
#<a href=/diary/tags/github/>github</a>&nbsp;
#<a href=/diary/tags/python/>python</a>&nbsp;</span><div class=post-content><p>18時19分の新幹線に乗って21時前に新神戸駅に着く。この時間帯で帰ってくるのが楽な気がする。新神戸駅についたらいつもそこからタクシーで帰りたいと思う。いまうちの会社は全然儲かってないのでそんなことできないけれど、いつか余裕ができたら出張帰りの電車乗り継ぎをやめてタクシーで直帰してよいルールにしたい。</p><h2 id=go-121-への移行>go 1.21 への移行</h2><p>昨日 <a href=https://go.dev/blog/go1.21>Go 1.21 is released!</a> されたことを知った。自分の作業を中断して早めに移行して問題があれば検出できるしておきたかったので 1.20 から 1.21 への移行をしていた。もっとも大きな移行としてログ出力をすべて <a href=https://pkg.go.dev/log/slog>log/slog</a> へ移行した。もともと <a href=https://github.com/cybozu-go/log>cybozu-go/log</a> という標準の log パッケージに近いものを使っていたので移行そのものは大きな課題にはならなかった。一方で変更することによって運用にどういった影響が出るかは実際に動かさないと気付かないこともあるだろうという視点で早く移行したかった。昨日の夕方に 1.21 で一通りは動くようにして、今朝から細かいところの修正は他のライブラリとして slices/maps といった新規に追加された標準ライブラリを使うように変更していった。リポジトリが数個あるので単純に労力だけの問題。ついでに go-ldap の ci 環境の設定も変えておいた。</p><ul><li><a href=https://github.com/go-ldap/ldap/pull/457>Add go 1.21 build/testing to github workflow #457</a></li></ul><h2 id=github-api-tools-再び>github-api-tools 再び</h2><p>帰りの新幹線の中でてらださんとやり取りしていた。issue 検索に llm の技術を使ってサンプルアプリケーションを作るというアイディアが進んでいて、公けの github issues のデータを使えばいいという話しをした。実際に学習データにするには、一定の前処理したテキストとメタデータが必要になる。github issues からあるプロジェクトの情報を一括で取得する方法はないか？という相談を受けて、github の rest api などを使って取得するのがよいのではないか？と提案した。</p><p>私も過去に github での作業時間の検証のために <a href=https://github.com/kazamori/github-api-tools>github-api-tools</a> というツールを作っていた。21時半頃にオフィスに戻ってきて、せっかくなので試しにやってみるかと翌1時過ぎぐらいまでコードを書いていた。過去にも issues の機能も作った方がよいよねという課題は残してあった。</p><ul><li><a href=https://github.com/kazamori/github-api-tools/issues/1>Add issue statistics #1</a></li></ul><p>python のコードを滅多に触る機会がなくなってしまったので勘所を思い出したりするのにやや手間取った。それでも自分が過去に作ったものなのですぐにできた。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0913/>コワーキングから学ぶコミュニティ</a></h1><div class=post-meta><time class=post-date>2022-09-13 (Tue.) ::</time></div><span class=post-tags>#<a href=/diary/tags/github/>github</a>&nbsp;
#<a href=/diary/tags/coworking/>coworking</a>&nbsp;
#<a href=/diary/tags/community/>community</a>&nbsp;
#<a href=/diary/tags/event/>event</a>&nbsp;</span><div class=post-content><p>0時に寝て2時に起きて5時前ぐらいまで本を読んでまた寝て8時に起きた。昨日の続きでちょっとした画面の改修をやって、小さいタスクを2つほど片付けて、それでもやることなくて暇だなぁ。</p><h2 id=backlog-github-integration-action-のアップデート>backlog-github-integration-action のアップデート</h2><p>backlog のライブラリのバージョンが上がっていたのを少し前にみかけていたので更新してリリースした。</p><ul><li><a href=https://github.com/kazamori/backlog-github-integration-action/releases/tag/v1.0.2>https://github.com/kazamori/backlog-github-integration-action/releases/tag/v1.0.2</a></li></ul><h2 id=コワーキングのオンラインイベント>コワーキングのオンラインイベント</h2><p><a href=/diary/posts/2022/0831/#コワーキングのオンラインイベント>先日のカフーツさんのトークイベント</a> 同様、9月のイベントに参加した。前回は急遽スケジュール調整をしたせいか私1人だったけど、今日は6人の参加者がいた。私以外はコワーキングスペースを運営している人みたい。コワーキングと街づくりといった内容が今日のテーマだったみたい。その事例の1つとして <a href=https://coworkingpress.com/archives/457>オトナリ［島根県雲南市］</a> を教えてもらった。成功事例の話しを聞いていると共通点の1つとして主催者が地元の人ではなくても、その地域に移住して運営しているという。オトナリも東京のコンサル会社が受注してコワーキングのビジネスを始めたものの、その会社の社員が東京から移住してまでその地域の街づくりに参画しているという。その熱意の違いが正否をわける要因の1つであろうと私は感じた。<a href=/diary/posts/2022/0805/##神戸市さんと雑談>以前、神戸市さんとコミュニティについて雑談した</a> ときも、あえて言わなかったけど、職員自らではなく業者に委託して運営しているようなコミュニティではまったく運営の取り組みは異なるだろうと思う。他にも <a href=https://www.cf-japan.org/about-cf/>コミュニティ財団</a> という財団法人を作って運営している <a href=https://escf.jp/>愛媛県 西条市</a> の事例なども教えていただいた。</p><p>その後、参加者個々のコワーキングスペースの運営者のお悩み相談みたいなやり取りをしていた。私だけ運営者じゃないのでちょっと浮いてた。お前何ものやねん的なw あと箇条書きで書いたものをマインドマップに変換する <a href=https://transno.com/>Transno</a> というエディターがあるらしい。私は手書きでマインドマップを描くのでこういったツールは使わないけれど、ツールでマインドマップを書くのが好きな人には向くのかもしれない。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0907/>ドキュメントを書きながら思うこと</a></h1><div class=post-meta><time class=post-date>2022-09-07 (Wed.) ::</time></div><span class=post-tags>#<a href=/diary/tags/github/>github</a>&nbsp;
#<a href=/diary/tags/document/>document</a>&nbsp;</span><div class=post-content><p>3時に寝て7時に起きた。眠れない。</p><h2 id=github-リポジトリとシステム間連携>github リポジトリとシステム間連携</h2><p>社員さんが運用対応に忙しくてスプリントタスクがなくなって暇なのでドキュメントを書いてた。github に新規リポジトリを作成したときに行う初期設定の作業が増えてきた。大半は私が導入した仕組みや機能のための初期設定になるが、私はリポジトリの管理権限をもっていないので、社員さんにお願いして、この設定して、あの設定してとお願いして対応してきた。もうすぐ辞めるので引き継ぎできるようにやっていることのドキュメントを整理した。</p><ul><li>slack 連携</li><li>backlog 連携</li><li>github<ul><li>pull requests テンプレート</li><li>github actions<ul><li>github apps</li><li>github environments</li></ul></li></ul></li></ul><p>リポジトリと他システムとの連携を効率化しようとすればするほど設定や背景が煩雑になる。とくに認証や権限周りのセキュリティを考慮した仕組みはサービスとのトレードオフになるので設定が面倒になりがちではある。とくに github actions のワークフローは <a href=https://note.com/hoshino_technote/n/n6afff42aeee0>【登壇報告】JJUG CCC 2022 Spring で語りきれなかった技術的なお話</a> にあるように、世の中のプラクティスに依らず、私が設計して整備したものなので他メンバーにとって身近ではない。</p><p>backlog の wiki にプロジェクトのドキュメントを書いている。開発メンバーでドキュメントを定期的に書くのはほぼ私だけで、他メンバーはほとんど書かない。なぜそうなるのかな？と考えたときに思いつくことの1つとして、開発全般の業務としてやることを、誰でもできる汎用的な仕組みに落とし込むことを考慮して設計していないからではないかと思う。あるアプリケーションが内製／外部システム／外部ライブラリに関わらず、こういう機能や仕組みを使って、こんな課題を解決して、こんな機能を実現していますという構成にはなっていない。発生している問題に対して動けばいいといったレベルでしか開発していないから、本来どう在るべきなのか、どういった設計思想なのか、今後はどうやって保守していけばいいのかの指針を提供できない。これは私の言葉だと設計ができないということと同義だと思う。他に思いつくこととしては、既存アプリケーションにない新規の仕組みを定期的に設計しているのは私しかいないのかもしれない。言い換えれば、言われたことしかやらない人しかいない。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0731/>久しぶりにブログを書いた</a></h1><div class=post-meta><time class=post-date>2022-07-31 (Sun.) ::</time></div><span class=post-tags>#<a href=/diary/tags/book/>book</a>&nbsp;
#<a href=/diary/tags/github/>github</a>&nbsp;
#<a href=/diary/tags/ci/cd/>ci/cd</a>&nbsp;</span><div class=post-content><p>2時過ぎに寝て7時に起きて9時まで寝てた。</p><h2 id=もてなしだけではもう食えない>もてなしだけではもう食えない</h2><p>読み進めておもしろかったし学びにもなったので書評を書いた。</p><ul><li><a href=https://note.com/t2y1979/n/nc5c156ae529e>もてなしだけではもう食えない -ホテル経営学の本質と実践-</a></li></ul><h2 id=backlog-github-integration-action-v101-リリース>backlog-github-integration-action v1.0.1 リリース</h2><p><a href=/diary/posts/2022/0710/#backlog-github-integration-action-のバグ修正>backlog-github-integration-action のバグ修正</a> した変更を v1.0.1 としてリリースした。2週間ほど検証環境でリグレッションがないかをみていた。問題なさそうなので v1 ブランチにマージして docker イメージを push して v1.0.1 タグを付けてリリース成果物を作成した。久しぶりにやると手順を忘れていてドキュメントを書かないといけないなとか思ったりした。</p><ul><li><a href=https://github.com/marketplace/actions/backlog-github-integration-action>backlog-github-integration-action</a></li></ul></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0714/>意図がわかる設計とリファクタリング</a></h1><div class=post-meta><time class=post-date>2022-07-14 (Thu.) ::</time></div><span class=post-tags>#<a href=/diary/tags/github/>github</a>&nbsp;
#<a href=/diary/tags/ci/cd/>ci/cd</a>&nbsp;
#<a href=/diary/tags/refactoring/>refactoring</a>&nbsp;</span><div class=post-content><p>1時に寝て7時に起きた。久しぶりに <a href=https://www.nbcuni.co.jp/rondorobe/anime/hellsing/>HELLSING</a> をみてた。アレクサンド・アンデルセンの狂信者ノリが好き。</p><h2 id=煩雑な保守>煩雑な保守</h2><p>昨日から着手した s3 とやり取りするアプリケーションの保守をしている。一通り機能は実装できたが、このアプリケーションの保守を今後どうやっていけばいいのかが私からはみえない。要件が変わる度に継ぎ接ぎで拡張してきて、意図をもった設計があるわけではないようにみえる。このまま保守することはできるかもしれないが、このロジックの説明もテストも検証もすべてが難しい。私がみても難しいのだから、経験の浅い開発者がみるともっと難しいのではないかと思う。</p><p>これを直すにはまず単体テストを直さないといけない。単体テストの大半がモックベースなので実際の振る舞いと異なる可能性がある。とくに s3 とやり取りするところの検証ができない。<a href=https://www.testcontainers.org/modules/localstack/>testcontainers の localstack</a> があるので単体テストはモックからこのモジュールを使うように代替できそう。まずはそこからやるべきだが、2-3日はかかると見込まれるのでチームで承認を得られるかどうか、ちょっと聞いてみてから考える。</p><h2 id=job-summary-を使ってみた>Job Summary を使ってみた</h2><p>ちょっと前に github actions のワークフローの実行画面にサマリを出力できるようになったという記事をみた。</p><ul><li><a href=https://github.blog/2022-05-09-supercharging-github-actions-with-job-summaries/>Supercharging GitHub Actions with Job Summaries</a></li></ul><p>自動でよさげなサマリを出力してくれるわけではなく、自分でサマリを作らないといけないので面倒だなと思ってそのまま放置していた。先週末に <a href=/diary/posts/2022/0709/#github-actions-の-push-イベントワークフロー改善>モジュール別のビルド・デプロイのワークフロー改善</a> を行った。ふとワークフローの実行結果をみていて、選択したモジュール名が表示されているとわかりやすくていいなと思えた。それを出力する手段としてサマリがちょうどいいやということに気付いた。inputs などで動的に変更するパラメーターをワークフローの実行画面で確認できるといちいちログ確認する手間が省けてよいという場面が他の用途でもある気がしてきた。もっと積極的にサマリを使っていこうと思えた瞬間だった。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0710/>放置していたバグを直した</a></h1><div class=post-meta><time class=post-date>2022-07-10 (Sun.) ::</time></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/government/>government</a>&nbsp;
#<a href=/diary/tags/github/>github</a>&nbsp;
#<a href=/diary/tags/ci/cd/>ci/cd</a>&nbsp;</span><div class=post-content><p>1時に寝て7時に起きた。寝ていて夜中に吐き気して眠れなくて上体を起こすしかなかった。たまにある <a href=/diary/posts/2021/1114/#傾斜枕>胃食道逆流症</a> のひどいやつ。</p><h2 id=参議院選挙>参議院選挙</h2><p>普段は期日前投票で済ませるのだけど、今週は他のことに注意を取られていたせいか、当日行ってきた。場所が期日前と違ったので勝手がわからなかったけど、とくに混雑もしてなかったのですぐに完了できた。タイムラインを眺めると、私のタイムライン上では投票したと発言する人が増えてきたように思う。投票率が50%程度で半分ぐらいの人が投票していない状況に懸念をもつ人たちの可視化がされている。</p><figure><img src=/diary/img/2022/0710_voted.jpg></figure><p>ふと父の選挙はどうなるんだろう？と思って検索してみた。意思表示できない状態だと選挙はできないみたい。</p><blockquote><p>選挙人本人が投票所に行き自らの意思で投票することが原則であることから、意思表示が困難である場合には投票することはできません。これは投票所の係員が選挙人の投票を補助する代理投票においても同様です。したがって、家族の方が本人に代わって投票することはできません。</p><p><a href=https://help.city.kobe.lg.jp/hc/ja/articles/4488187002767-%E6%84%8F%E6%80%9D%E8%A1%A8%E7%A4%BA%E3%81%8C%E5%9B%B0%E9%9B%A3%E3%81%AA%E9%81%B8%E6%8C%99%E4%BA%BA%E3%81%AB%E4%BB%A3%E3%82%8F%E3%81%A3%E3%81%A6-%E5%AE%B6%E6%97%8F%E3%81%8C%E6%8A%95%E7%A5%A8%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95%E3%81%AF%E3%81%82%E3%82%8A%E3%81%BE%E3%81%99%E3%81%8B->神戸市 FAQ > 市政情報 > 選挙</a></p></blockquote><p>70歳以上は傷病で選挙権を行使できない人たちもいるだろうから減るのかな？と、総務省の <a href=https://www.soumu.go.jp/senkyo/senkyo_s/news/sonota/nendaibetu/>年代別投票率</a> のグラフを確認してみた。直近だと、70歳以上が61.96, 60歳代が71.43、50歳代が62.96だった。60歳代と比べて減ってはいるけど、50歳代とそう変わらないのをみると、元気な人たちに選挙へ行こうと呼びかけるのは正しい気がした。</p><h2 id=backlog-github-integration-action-のバグ修正>backlog-github-integration-action のバグ修正</h2><p>運用してすぐにコミットメッセージ中にシングルクォートやダブルクォートが含まれると引数を正しくパースできなくてエラーになることがわかっていた。いま運用している環境の用途だと、それほど重要ではないので後回しにしているうちに面倒になって放置していた。晩ご飯を食べてからデバッグしていたら7時間ぐらいやってた。</p><ul><li><a href=https://github.com/kazamori/backlog-github-integration-action/issues/6>push subcommand is failed when a commit message includes single quote or double quote #6</a></li></ul><p>bash 上の文字列の扱いと action.yml の inputs の args に引数渡しするときの振る舞いの勘違いもあって、issue の見た目以上に複雑な振る舞いをしていることがわかった。github actions 上のコンテキストに依存したくなかったため、<code>github.event.commits</code> の json をそのまま cli パラメーターとして渡している。bash 上の json 文字列と cli パラメーターとしての扱いが煩雑になるのでこのやり方は失敗だったかもしれない。ローカルでのテストもやりにくい。私はそのことをよく理解していたはずなのに github actoins 上のアンチパターンにはまってしまった。カスタムアクションのユーザーが簡単に使えるように cli パラメーターの設定を簡単にする意図で json 渡しにしたんだけど、エスケープの振る舞いが想像以上にややこしくなって、エスケープしたいユーザーには簡単ではなくなってしまった。それでもデバッグをがんばったおかげでシングルクォートは完全に使えるように実装できた。ダブルクォートは制限付きでエラーにならなくできるが、事実上は使わないでくださいといった仕様制限にしてしまおうと思う。引用するときはダブルクォートじゃなくてシングルクォートを使ってくださいと啓蒙することに決めた。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0709/>github actions の push イベントワークフロー改善</a></h1><div class=post-meta><time class=post-date>2022-07-09 (Sat.) ::</time></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/github/>github</a>&nbsp;
#<a href=/diary/tags/ci/cd/>ci/cd</a>&nbsp;</span><div class=post-content><p>23時に寝て6時に起きた。今週はサービスインで凸凹していて疲れた。</p><h2 id=ストレッチ>ストレッチ</h2><p>今日の開脚幅は開始前161cmで、ストレッチ後164cmだった。ちょっと数値がよくなった。一昨日の日本酒イベントで4時間ほど立ち呑みをしていた疲労で腰に張りが少しあった。それ以外はとくに問題はなくて調子がよかった。右股関節の詰まりも2-3週間前よりもよくなっている気がする。これはトレーナーさんも注意を払って詰まりを取り除くようにストレッチのメニューを組んでくれているのでその成果が徐々に出始めている気がする。以前よりも可動領域が広がってきている気がして安心感を得た。</p><h2 id=github-actions-の-push-イベントワークフロー改善>github actions の push イベントワークフロー改善</h2><p>午後からビルド・デプロイの最適化のために github actions のワークフローを改善作業をしていた。</p><p>今週はサービスインにより、本番環境への緊急リリースを何回もやっているのを傍からみていて、ビルド・デプロイが速くなればなるほど、その回数を増やせるし、修正後の検証に時間を多く割ける。あるリポジトリが7つのモジュールをまとめてビルド・デプロイしている。これはあるモジュールの微修正の反映には向かないので改善することにした。結果として最大で50%ぐらいのビルド時間の削減、モジュールに依っては、具体的には10分かかっていたものを4分台でビルドできるようにした。</p><p>ワークフロー改善のためのデバッグしている間はビルド・デプロイが出来なくなることから開発者が使っていない時間帯が望ましい。必然的にサービス休日出勤して github actions のワークフローを改善していた。デバッグと動作の検証も兼ねて午後から半日以上やっていたので休日にやったのは正解だと言えるだろう。</p><p>push イベントの github コンテキストの <code>github.event.commits</code> にコミット情報が入っていて、そこにコミットのリビジョンがある。例えば、次のようなオブジェクトで <code>id</code> がコミットのリビジョンに相当する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>[
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;author&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;email&#34;</span>: <span style=color:#e6db74>&#34;...&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;...&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;username&#34;</span>: <span style=color:#e6db74>&#34;t2y&#34;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;committer&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;email&#34;</span>: <span style=color:#e6db74>&#34;...&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;...&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;username&#34;</span>: <span style=color:#e6db74>&#34;t2y&#34;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;distinct&#34;</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#e6db74>&#34;f8df1f77ffec9ef234e7321b2e237b663256b01c&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;message&#34;</span>: <span style=color:#e6db74>&#34;コミットログのメッセージ&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;timestamp&#34;</span>: <span style=color:#e6db74>&#34;2022-07-08T12:32:33+09:00&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;tree_id&#34;</span>: <span style=color:#e6db74>&#34;37b066734e58779c5d2c687d40b4cc43af177cb2&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;url&#34;</span>: <span style=color:#e6db74>&#34;https://github.com/OWNER/REPO/commit/f8df1f77ffec9ef234e7321b2e237b663256b01c&#34;</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>...</span>
</span></span><span style=display:flex><span>]
</span></span></code></pre></div><p>このリビジョンを使って <a href=https://docs.github.com/en/rest/commits/commits#get-a-commit>github rest api</a> からファイル情報を取得できる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ gh api -H <span style=color:#e6db74>&#34;Accept: application/vnd.github+json&#34;</span> /repos/OWNER/REPO/commits/f8df1f77ffec9ef234e7321b2e237b663256b01c
</span></span></code></pre></div><p>いろんなデータが返ってくるけど、ここでは変更したファイルのパスを知りたい。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;sha&#34;</span>: <span style=color:#e6db74>&#34;...&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;node_id&#34;</span>: <span style=color:#e6db74>&#34;...&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;commit&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>...</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;files&#34;</span>: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;sha&#34;</span>: <span style=color:#e6db74>&#34;...&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;filename&#34;</span>: <span style=color:#e6db74>&#34;module1/path/to/src&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#960050;background-color:#1e0010>...</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;sha&#34;</span>: <span style=color:#e6db74>&#34;...&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;filename&#34;</span>: <span style=color:#e6db74>&#34;module2/path/to/src&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#960050;background-color:#1e0010>...</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>この <code>filename</code> のトップディレクトリがモジュール名と同じなのでここだけ取り出して、管理対象のモジュールかどうかを比較する。bash でも <code>=~</code> をサブ文字列のマッチングができる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ targets<span style=color:#f92672>=(</span>mymodule1 mymodule2<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>$ echo <span style=color:#e6db74>&#34; </span><span style=color:#e6db74>${</span>targets[@]<span style=color:#e6db74>}</span><span style=color:#e6db74> &#34;</span>
</span></span><span style=display:flex><span> mymodule1 mymodule2 
</span></span><span style=display:flex><span>$ <span style=color:#f92672>[[</span> <span style=color:#e6db74>&#34; </span><span style=color:#e6db74>${</span>targets[@]<span style=color:#e6db74>}</span><span style=color:#e6db74> &#34;</span> <span style=color:#f92672>=</span>~ <span style=color:#e6db74>&#34; mymodule1 &#34;</span> <span style=color:#f92672>]]</span> <span style=color:#f92672>&amp;&amp;</span> echo <span style=color:#e6db74>&#34;match&#34;</span>
</span></span><span style=display:flex><span>match
</span></span><span style=display:flex><span>$ <span style=color:#f92672>[[</span> <span style=color:#e6db74>&#34; </span><span style=color:#e6db74>${</span>targets[@]<span style=color:#e6db74>}</span><span style=color:#e6db74> &#34;</span> <span style=color:#f92672>=</span>~ <span style=color:#e6db74>&#34; mymodule2 &#34;</span> <span style=color:#f92672>]]</span> <span style=color:#f92672>&amp;&amp;</span> echo <span style=color:#e6db74>&#34;match&#34;</span>
</span></span><span style=display:flex><span>match
</span></span></code></pre></div><p>さらにマッチしたモジュールを <a href=https://docs.github.com/en/actions/learn-github-actions/expressions>github actions の expressions</a> で制御しやすいように json の array に変換する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ jq --compact-output --null-input <span style=color:#e6db74>&#39;$ARGS.positional&#39;</span> --args -- <span style=color:#e6db74>${</span>targets[@]<span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span><span style=color:#e6db74>&#34;mymodule1&#34;</span>,<span style=color:#e6db74>&#34;mymodule2&#34;</span><span style=color:#f92672>]</span>
</span></span></code></pre></div><p>これを step の outputs として格納する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>echo <span style=color:#e6db74>&#34;::set-output name=modules::</span><span style=color:#e6db74>${</span>json_array<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span></code></pre></div><p>例えば、後続の job で実行条件としてモジュールの有無を調べたいときは expressions を使って次のように記述できる。if 文は <code>${{ ... }}</code> のブラケットを省略できるようだけど、ここだけ省略すると返って混乱するかなと思って私は記述するようにしている。その方が統合性があってコードが読みやすいように私は考えている。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>  mymodule1-job:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>: <span style=color:#e6db74>${</span>{ contains(fromJSON(needs.build.outputs.mymodule_target.modules), <span style=color:#e6db74>&#39;mymodule1&#39;</span>) <span style=color:#e6db74>}</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    needs:
</span></span><span style=display:flex><span>      - build
</span></span></code></pre></div><p>ちなみに workflow レベルの env は job の if 文には使えない。outputs を使って動的な値を扱うようにしている。どうも workflow レベルの env はいろいろ問題があるみたいでなかなか issue がクローズされないのをみると取り扱い注意なのかもしれない。</p><ul><li><a href=https://github.com/actions/runner/issues/480>Workflow level env does not work properly in all fields. #480</a></li><li><a href=https://github.com/actions/runner/issues/1661>workflow level env. is unrecognised on job level&rsquo;s &lsquo;if&rsquo;-expression when calling reusable workflow #1661</a></li></ul><p>最終的なモジュールを判別するための step は次のようなものになった。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span>  <span style=color:#f92672>build</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>outputs</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>mymodule_target</span>: <span style=color:#ae81ff>${{ steps.mymodule-target.outputs.modules }}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>steps</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>コミットログからビルド対象のモジュールを設定</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>id</span>: <span style=color:#ae81ff>mymodule-target</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>run</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        declare -A modules
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        target_modules=${{ env.TARGET_MODULES }}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        revisions=$(jq --raw-output &#39;.[].id&#39; &lt;&lt;&lt; &#39;${{ env.COMMITS }}&#39;)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        for revision in ${revisions}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        do
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          names=$(gh api -H &#34;${{ env.ACCEPT_HEADER }}&#34; ${{ env.COMMITS_PATH }}/${revision} | jq --raw-output &#39;.files[].filename&#39; | cut -d&#34;/&#34; -f1 | sort -u)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          for name in $names
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          do
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            if [[ &#34; ${target_modules[@]} &#34; =~ &#34; ${name} &#34; ]]; then
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              modules[${name}]=true
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            fi
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          done
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        done
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        targets=$(jq --compact-output --null-input &#39;$ARGS.positional&#39; --args -- &#34;${!modules[@]}&#34;)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        echo &#34;::set-output name=modules::${targets}&#34;</span>        
</span></span><span style=display:flex><span>      <span style=color:#f92672>env</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>TARGET_MODULES</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          (
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &#39;mymodule1&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &#39;mymodule2&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          )</span>          
</span></span><span style=display:flex><span>        <span style=color:#f92672>ACCEPT_HEADER</span>: <span style=color:#e6db74>&#34;Accept: application/vnd.github+json&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>COMMITS_PATH</span>: <span style=color:#ae81ff>/repos/${{ github.repository }}/commits</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>COMMITS</span>: <span style=color:#ae81ff>${{ toJSON(github.event.commits) }}</span>
</span></span></code></pre></div><p>処理も理屈も簡単なんだけど、実際の運用コードはもう少しだけ複雑なものの、デバッグは github actions を実行しないといけない。ちょっとした typo のために実は2時間ほどはまっていたのは内緒。シェルの配列や連想配列を使うと、記号が多くてわかりにくい。配列の閉じブラケットを忘れていたがために EOF のエラーが発生していた。閉じブラケットのミスだけにエラーが発生しているところと実際のコードがズレていて、それに気付くのに少しずつコードを足したり消したりしてデバッグするみたいな原始的なやり方で些細な typo を気付くのに時間がかかった。</p><pre tabindex=0><code>xxx.sh: line 47: unexpected EOF while looking for matching `&#34;&#39;
</code></pre></div></article><div class=pagination><div class=pagination__buttons><a href=/diary/tags/github/page/2/ class="button next"><span class=button__text>過去の日記</span>
<span class=button__icon>→</span></a></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>© 2021 Tetsuya Morimoto</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>