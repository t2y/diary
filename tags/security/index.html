<!doctype html><html lang=en><head><title>security :: forest nook</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/tags/security/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="security"><meta property="og:description" content><meta property="og:url" content="/diary/tags/security/"><meta property="og:site_name" content="forest nook"><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/tags/security/index.xml rel=alternate type=application/rss+xml title="forest nook"></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><div class=posts><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0108/>evernote から upnote への移行</a></h1><div class=post-meta><time class=post-date>2024-01-08 (Mon.) ::</time></div><span class=post-tags>#<a href=/diary/tags/biztrip/>biztrip</a>&nbsp;
#<a href=/diary/tags/migration/>migration</a>&nbsp;
#<a href=/diary/tags/upnote/>upnote</a>&nbsp;
#<a href=/diary/tags/security/>security</a>&nbsp;</span><div class=post-content><p>6時に寝て8時半に起きた。オフィスで3時前ぐらいまで調べものして、帰ってからも眠れなくてネットしてたら朝になった。</p><p>今日の筋トレは腹筋:15x1,腕立て:10x1,スクワット10x1をした。</p><h2 id=サンライズ出雲の予約>サンライズ出雲の予約</h2><p>以前 <a href=/diary/posts/2023/1119/#サンライズ瀬戸・出雲>やまさきさんに教えていただいた夜行列車</a> を予約してみた。列車は瀬戸と出雲の2つがある。岡山〜東京間は瀬戸と出雲が連結して運行するそうなのでどちらを選択しても同じだと思うけれど、出雲で予約してみた。乗り込む車両が異なるのかな？</p><p>三ノ宮(00:11発) => 東京 (07:08着)</p><ul><li>特急サンライズ出雲（シングル）<ul><li>料金券部分 10,460円 (三ノ宮 - 東京)</li><li>乗車券部分 9,460円 (神戸市内 - 東京都区内 2月6日～2月9日まで有効)</li></ul></li></ul><p>前回に <a href=https://www.jr-odekake.net/goyoyaku/campaign/sunriseseto_izumo/form.html>専用の予約画面</a> があることを調査済みだったので迷わず予約を取れた。唯一、面倒なところがオンラインで予約した後に紙の切符を発行しないといけないところ。切符を発行するには緑の窓口・券売機へ行かないといけない。三ノ宮駅にはあるので問題はない。発行には次の3つが必要になる。初めてだから予約後、すぐに駅へ行って発行してみた。迷わず簡単にできたのでこれなら乗車する直前でもそう困らないように思える。</p><ul><li>予約したクレジットカード</li><li>電話番号の下四桁</li><li>予約番号</li></ul><h2 id=upnote-への移行>upnote への移行</h2><p>数年前から evernote のビジネスが安定していないのは既知になっていたが、ここ1-2年でフリープランをどんどん縮小して投資回収的な値上げを強行している。</p><ul><li><a href=https://forest.watch.impress.co.jp/docs/news/1550894.html>「Evernote」無料プランの上限変更が正式決定、導入は12月4日から</a></li></ul><p>値上げするだけならまだしも、アプリを開くたびに有料プランにアップグレードするためのダイアログを表示して、意図的にユーザー体験を悪化させて、フリープランのユーザーを退会させたいようにみえる。ここまで露骨にやって既存の課金ユーザーだけで十分にビジネスはペイするという目論見なのか、経営陣が短期的にV字回復させたという実績作りなのか。いずれにしても、私のようなちょっと使いのフリープランユーザーはターゲットではないらしい。どうやら2011年6月から使っていたらしいが、件数にすると216件のノートしかない。週に1-2回は使うのだけど、なくなったら別アプリに移行しても困らない程度の用途にしか使っていない。</p><p>ずっと移行したいと思いつつ、なおざりにしていた理由として移行先のアプリを選定していなかった。私の用途としては次のような使い方をしている。</p><ul><li>買いものの備忘録として思いついたときにパソコンから記録し、スマホでチェックしながら買いものする</li><li>法人番号、住所、家族の誕生日など、オンラインで手入力しないといけないときなどのコピペ元</li><li>郵便受けのダイヤルロックを忘れたときのメモ</li><li>パソコンやデバイスを購入したときのスペックを記録しておく</li><li>オンラインの記事やサイトを保管しておくときの web クリップ</li></ul><p>正直メモ帳アプリでなくても、他のアプリへ移行することもできるが、惰性で使っているのでできればそのまま移行したい。私の周りでは <a href=https://obsidian.md/>obsidian</a> を使っている人も多く評判もいいからこれでもよかったんだけど、いくつか記事を読んでいると <a href=https://getupnote.com/>upnote</a> の評判もよさそうにみえた。また upnote はサブスクリプションモデルではなく、パッケージライセンスなのでコストが安い。app store 経由でプレミアムのライセンスを購入する。為替によって値段が変わると思うが、いま買ったら3,500円だった。この値段で未来永劫 upnote のインフラコストを賄えるのかは懐疑的だが、3,500円ぐらいならそうなったときにまた別のメモ帳アプリへ移行するのでもよいかなというぐらいの気持ちで upnote を使ってみることにした。</p><ul><li><a href=https://ryob.net/upnote/>ノートアプリ難民必見！UpNoteが超気に入った理由を語りたい</a></li></ul><p>web 版はなくて、それぞれのデバイスごとにインストールする。linux は snap パッケージが用意されているので ubuntu なら次のようにインストールする。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sudo snap install upnote
</span></span></code></pre></div><p>evernote から移行をするにあたり、<code>.enex</code> という xml ファイル形式でデータをエクスポートできる。これは macos または windows アプリでないとエクスポートできない。仕方ないから macos に evernote のアプリをインストールしてエクスポートする。ノートブック単位でエクスポートできる。</p><ul><li><a href=https://help.evernote.com/hc/ja/articles/209005557-%E3%83%8E%E3%83%BC%E3%83%88%E3%81%A8%E3%83%8E%E3%83%BC%E3%83%88%E3%83%96%E3%83%83%E3%82%AF%E3%82%92-ENEX-%E3%81%BE%E3%81%9F%E3%81%AF-HTML-%E5%BD%A2%E5%BC%8F%E3%81%A7%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%9D%E3%83%BC%E3%83%88>ノートとノートブックを ENEX または HTML 形式でエクスポート</a></li></ul><p>その後、upnote の macos アプリでインポートしようと試みるも macos 版にはインポート機能が見当たらない。linux 版にはインポート機能があったので <code>.enex</code> ファイルを linux にコピーしてきて linux 版でインポートしたら移行を完了した。移行の制約事項は次の通り。216件のノートしかないので10分もあれば完了した。同期もかなり速くて、すぐに iphone, macos, linux でノートが同期された。</p><blockquote><p>最適なパフォーマンスを得るには、次の点に注意してください。</p><ul><li>多数のノートをインポートすると、アプリのパフォーマンスに影響を与える可能性があります。</li><li>20MBを超えるファイルはインポートされません。</li><li>300,000文字を超えるノートはインポートされません。</li></ul></blockquote><p>インストールしてから、このアプリの開発元はどこなんだろう？と調べてみるとベトナムの会社らしい。ややセキュリティは大丈夫なのかな？と不安に思ってしまう。<a href=https://getupnote.com/support.html>Frequently Asked Questions</a> から引用する。firebase を使っているならストレージは強固だし、同期も firebase に委譲すればおかしなことも起こらないだろう。</p><blockquote><p>アップノートはどのように私のデータを保存するのですか？</p><p>UpNoteは、アカウントにサインアップしなくても確実に動作するように設計されています。サインインしない場合、メモはあなたのデバイスにローカルに残ります。デバイス間でメモを同期したい場合は、アカウントにサインアップすると、UpNoteが中央サーバーにメモを保存し、他のデバイスと同期できるようになります。</p><p>お客様はご自身のデータを完全に管理することができ、アップノートがお客様のデータにアクセスしたり、お客様のデータを第三者に販売したりすることは決してありません。プライバシーに関する詳細は、プライバシーポリシーをご覧ください。</p></blockquote><blockquote><p><strong>アップノートのサーバーはどこにありますか？安全ですか？</strong></p><p>UpNoteはFirebaseサーバー（Googleが提供するサービス）にデータを保存します。Firebaseプラットフォームは、主要なプライバシーおよびセキュリティ基準で認定されており、EU一般データ保護規則（GDPR）およびカリフォルニア州消費者プライバシー法（CCPA）を完全にサポートしています。Firebaseは、HTTPSを使用して転送中のデータを暗号化し、静止時のデータを暗号化します。詳しくは <a href=https://firebase.google.com/support/privacy>https://firebase.google.com/support/privacy</a> をご覧ください。また、お客様のデータが安全に保護され、お客様だけがアクセスできるように細心の注意を払っています。</p></blockquote><blockquote><p><strong>アップノートはエンドツーエンド暗号化に対応していますか？</strong></p><p>エンドツーエンド暗号化（E2EE）は、データを暗号化・復号化するための高度なセキュリティ手法で、機密性の高い情報を保護するために設計されています。実装が複雑なため、アップノートでは現在E2EEをサポートする予定はありません。パスワードやクレジットカード番号などの機密情報を保存する場合は、機密情報を暗号化するために特別に設計されたパスワードマネージャーアプリケーションを使用することをお勧めします。</p></blockquote><p>e2ee に対応していないところは残念なところ。未対応のセキュリティリスクの懸念としては、upnote 社の社員が私のノートの内容を閲覧できる可能性があったり、攻撃者が upnote 社のインフラに侵入してしまった場合、メモ帳の内容が外部に漏洩してしまう可能性がある。とはいえ、値段も安いのだからそこは割り切って機密情報はすべてパスワードマネージャに移行せよという戦略は理解できる。私の用途だと、メモ帳に機密情報はほとんどないけれど、賃貸の部屋のインターネット接続のアカウント情報や wifi パスワードなどを書いていたりする。こういった内容もこの機会に整理して 1password へ移行していくのがよいように思う。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1225/>RemoteAddr はほとんど役に立たない</a></h1><div class=post-meta><time class=post-date>2023-12-25 (Mon.) ::</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;
#<a href=/diary/tags/security/>security</a>&nbsp;</span><div class=post-content><p>0時に寝て何度か起きて7時に起きた。寒くて朝起きれなくなってきた。</p><h2 id=ローカルネットワークからのリクエストのみを受け付けるミドルウェア>ローカルネットワークからのリクエストのみを受け付けるミドルウェア</h2><p><a href=https://pkg.go.dev/net/http#Request>Request</a> 構造体の中にある <code>RemoteAddr</code> を参照すればすぐできるだろ思って、すぐにできた。すぐにできたんだけど、これは実際の運用で使えるものではない。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>LocalNetworkConfig</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Skipper</span> <span style=color:#a6e22e>middleware</span>.<span style=color:#a6e22e>Skipper</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>localNetworkWithConfig</span>(<span style=color:#a6e22e>cfg</span> <span style=color:#a6e22e>LocalNetworkConfig</span>) <span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>MiddlewareFunc</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>next</span> <span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>HandlerFunc</span>) <span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>HandlerFunc</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>c</span> <span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>cfg</span>.<span style=color:#a6e22e>Skipper</span>(<span style=color:#a6e22e>c</span>) {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>next</span>(<span style=color:#a6e22e>c</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>req</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Request</span>()
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>addr</span>, <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>SplitHostPort</span>(<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>RemoteAddr</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>slog</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#e6db74>&#34;failed to get remote address&#34;</span>,
</span></span><span style=display:flex><span>					<span style=color:#e6db74>&#34;err&#34;</span>, <span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;addr&#34;</span>, <span style=color:#a6e22e>addr</span>)
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>ErrForbidden</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>ip</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>ParseIP</span>(<span style=color:#a6e22e>addr</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ip</span>.<span style=color:#a6e22e>IsPrivate</span>() <span style=color:#f92672>||</span> <span style=color:#a6e22e>ip</span>.<span style=color:#a6e22e>IsLoopback</span>() {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>next</span>(<span style=color:#a6e22e>c</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>slog</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#e6db74>&#34;requested from an external network&#34;</span>, <span style=color:#e6db74>&#34;ip&#34;</span>, <span style=color:#a6e22e>ip</span>.<span style=color:#a6e22e>String</span>())
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>ErrForbidden</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewLocalNetwork</span>() <span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>MiddlewareFunc</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>localNetworkWithConfig</span>(<span style=color:#a6e22e>LocalNetworkConfig</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Skipper</span>: <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>c</span> <span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#66d9ef>bool</span> { <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span> },
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>過去にも同じようなことをやらかしたような既視感がある。</p><blockquote><p>golangのnet.Request構造体内にはRemoteAddr属性があり、当然のことながら要求元のリモートアドレスが含まれています。これで仕事は終わりですね？しかし、リバースプロキシやロードバランサーをアプリケーションに使っている場合はそうではありません。これはgoサーバには常に、すべてのリクエストがロードバランサから来ているかのように見えます。これは、これを何らかのスロットリングの指標として使いたいのであれば、最悪なことです。ですから、何らかの形のリバースプロキシの後ろでなく、goサーバーが1つだけ動いているのでない限り、私たちの目的には役に立たないとして、すぐにこれを捨てることができます。</p><p><a href=https://husobee.github.io/golang/ip-address/2015/12/17/remote-ip-go.html>https://husobee.github.io/golang/ip-address/2015/12/17/remote-ip-go.html</a></p></blockquote><p>途中のロードバランサーやアプリケーションゲートウェイ、リバースプロキシなど、中継するサーバーの ip アドレスに置き換わってしまうため、ネットワークのインフラを管理していないとどこからリクエストされたかを追跡することはできない。<code>X-Real-IP</code> や <code>X-Forwarded-For</code> という http ヘッダーに中継したサーバーの ip アドレスを記録するという慣習があるようだけど、これはクライアント側で書き換えできるのでこれ単体でアクセス制御のようなものに使うことはできない。</p><p>次に同じ失敗をしないようにここに書いておく。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1018/>パスワードリセットのテストのためのガイドライン</a></h1><div class=post-meta><time class=post-date>2023-10-18 (Wed.) ::</time></div><span class=post-tags>#<a href=/diary/tags/auth/>auth</a>&nbsp;
#<a href=/diary/tags/security/>security</a>&nbsp;
#<a href=/diary/tags/testing/>testing</a>&nbsp;</span><div class=post-content><p>0時に寝て何度か起きて4時に起きて仮眠して6時に起きた。あまり寝た気がしない。</p><h2 id=owasp-のパスワードリセットのガイドライン>OWASP のパスワードリセットのガイドライン</h2><p>パスワードリセットの仕組みをメンバーに開発してもらっている。そのコードレビューが先週から白熱している。セキュリティが関連するので堅牢に作る必要があるのでここはあまり妥協せきない。お手伝い先のシニアエンジニアから独自設計で作るのではなく、最低限、世の中の一般的なガイドラインに従っているかを確認するために OWASP のガイドラインを紹介してくれた。これはパスワードリセットの仕組みをテストするための要項をあげている。</p><ul><li><a href=https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/04-Authentication_Testing/09-Testing_for_Weak_Password_Change_or_Reset_Functionalities>Testing for Weak Password Change or Reset Functionalities</a></li></ul><p>これをメンバーに読んでもらって理解して実装しろと言いたいところでもあるが、私自身、読んだことがないとレビューできないことに気付いて、これは私が読んだ上で既存の設計や実装を見直すべきだと判断して deepl を駆使しながらほとんどを読んでみた。たしかに読んでみていくつか抜け・漏れに気付いたり、うちのセキュリティポリシーとして意図的に緩和しているところも認識できたりして、結論から言って読んでよかったと思う。当初はパスワードリセットのために一時トークンを1つだけ使っていたのだけど、それも2つを別々の経路に送って、割符のように組み合わせて認証する仕組みに変更した。よりセキュアにするという意図では一時トークンも1つよりも2つの方がよいというのは概ね正しいと思う。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1011/>ステートレスな認証という概念</a></h1><div class=post-meta><time class=post-date>2023-10-11 (Wed.) ::</time></div><span class=post-tags>#<a href=/diary/tags/auth/>auth</a>&nbsp;
#<a href=/diary/tags/security/>security</a>&nbsp;</span><div class=post-content><p>0時に寝て4時ぐらいに起きてだらだらして7時半に起きた。やっぱりあまり眠れない。</p><h2 id=ステートレスな認証という概念>ステートレスな認証という概念</h2><p>次の開発フェーズが始まっていて、ちょっと時間が経ってしまったが、前開発フェーズのお披露目的な製品紹介をお手伝い先の全社向けに行った。主には直近の開発フェーズで追加した機能などを紹介した。その過程で新たに認証の仕組みを追加して jwt で認証するといった話しをしたところ、それはステートレスなのかどうかといった質問が出た。セキュリティを考慮して、アーキテクチャ的にフロントエンドの認証と api サーバーの認証は分けて実装しているのと、そのために仕組みも複雑になっているのだけど、ステートレスという言葉が指す意図を私がよくわかっていなくて、うまく説明できなかった。説明を終えた後にアーキテクチャのイメージ図と一緒に補足をしながらやり取りして次の記事を教えてもらった。</p><ul><li><a href=https://zenn.dev/ritou/articles/4a5d6597a5f250>&ldquo;JWT=ステートレス"から一歩踏み出すための考え方</a></li></ul><p>jwt は暗号化の技術で認証する仕組みなので有効期限が切れるまでは有効なアクセストークンとなる。そのため、jwt のみだとログアウトという概念はないため、そこをどうしているのか？という質問だった。フロントエンド／api サーバーともに session をオンメモリで保持して、ログインしたユーザーを管理しているため、ログアウトしたら session からレコードを削除することで有効な jwt のアクセストークンが来ても認証エラーにしてしまうことでステートをもった認証方式を実現している。とくまる先生が次のように説明しているところ。</p><blockquote><p>「セッションIDをJWTに内包する」 という考え方です。</p></blockquote><p>うちはこれをセッション ID ではなくユーザー名でやっている。とくに難しいことをやっているわけではなく、普通に実装したらそんな感じかな？と考えていたが、jwt = ステートレス認証だと思い込んでいる人たちがいるから <em>ストートレスな認証</em> というキーワードが出てきたんだなと理解できた。最近のトレンドとしてはログアウトで jwt のアクセストークンを無効にできないと脆弱性と指摘される可能性がありそうとも書いてある。</p><blockquote><p>ログアウト時にJWTを無効化できない実装は今後脆弱性診断で「OWASP Top 10 2021違反」と指摘されるようになりそう(今も個別にされてるかもしれないけど)</p></blockquote><p>私はアーキテクチャ的にブラウザに api サーバーのアクセストークンをみせないというところに注力して認証機能の開発をサポートしていた。それ自体も間違っていないとは思うけど、今回の質問はその工夫とは異なるところの質問だった。認証は難しい。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0713/>縁の下のマネージャー</a></h1><div class=post-meta><time class=post-date>2023-07-13 (Thu.) ::</time></div><span class=post-tags>#<a href=/diary/tags/design/>design</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/logging/>logging</a>&nbsp;
#<a href=/diary/tags/security/>security</a>&nbsp;</span><div class=post-content><p>20時にホテルに戻ってきてのんびりしながら気付いたら22時ぐらいになって、少しテレビをみて0時に寝て4時ぐらいから起きてその後はあまり眠れなかった。それでも7時過ぎまでだらだらしていた。</p><h2 id=7月後半に実装予定の新機能の設計>7月後半に実装予定の新機能の設計</h2><p>9月までに実装する新機能のうち、唯一、私の頭の中で設計の見通しをもっていなかった機能の設計を行うことにした。</p><p>ざっくりした機能概要から私がふわっと想定していたものはずっと複雑なものだったのだけど、プロダクトオーナーに要件をヒアリングしているうちにそんな高度なものは求められていないことに気付いた。逆にその高度な機能の仕組みを提供しても、実際に運用の現場で使うにあたって手間暇だけかかってそんなものを求めていないと言われそうな気がした。そこで私が作りたいなと思っていた設計のアイディアは封印することにした。既存の先行プロダクトがもっている機能とほぼ同様のものを、うちらの開発しているプロダクトで実現するだけでよさそうにみえた。そのシンプルな機能の設計を軽くやっておいた。詳細を詰めるのは次のマイルストーンで私ではないメンバーに実装してもらうことになるけれど、なんとなく当初の想定よりも早くできそうに思えた。</p><h2 id=ログ出力のリファクタリング>ログ出力のリファクタリング</h2><p>id 連携の処理で複雑なリソースを map 型で扱うときデバッグ用途でリソースを丸ごと dump したい。しかし、パスワードのような機密情報が含まれる場合はそれらはログに出力したくない。この処理をいまは連携種別ごとに実装していて、本質じゃないところで個別実装の手間があるのと機密情報の出力というセキュリティに関するところを毎回プログラマーが手で実装するのもどうかな？という気がして汎用のログユーティリティとしてロガーのライブラリ側で提供することにした。インフラやプラットフォーム的な機能に私は積極的に開発に介入している。</p><p>やり方の1つとしてオリジナルのリソースをコピーして機密情報だけ削除した一時的なリソースコピーを dump してログ出力する。go 1.21 で標準ライブラリに追加される <a href=https://pkg.go.dev/golang.org/x/exp/maps>maps</a> パッケージを使うと map の操作が簡単にできる。コピー関数もある。しかし、この機能は shallow copy なので map の値にネストした map が含まれる場合はオリジナルの値を書き換えてしまう。ネストした map を調べてそれらもクローンしていく処理を実装した。excludeKeys に除外したい任意のキーを渡し、map の値を再帰的にチェックして取り除く。最終的には次のようなコピーユーティリティになった。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>copyWithoutExcludeKeys</span>(
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fields</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>any</span>, <span style=color:#a6e22e>excludeKeys</span> []<span style=color:#66d9ef>string</span>,
</span></span><span style=display:flex><span>) <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>any</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>cloned</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>maps</span>.<span style=color:#a6e22e>Clone</span>(<span style=color:#a6e22e>fields</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>k</span>, <span style=color:#a6e22e>v</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>cloned</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>t</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>v</span>.(<span style=color:#66d9ef>type</span>) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>:
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>strMapCloned</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>maps</span>.<span style=color:#a6e22e>Clone</span>(<span style=color:#a6e22e>t</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>sk</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>maps</span>.<span style=color:#a6e22e>Keys</span>(<span style=color:#a6e22e>strMapCloned</span>) {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>slices</span>.<span style=color:#a6e22e>Contains</span>(<span style=color:#a6e22e>excludeKeys</span>, <span style=color:#a6e22e>sk</span>) {
</span></span><span style=display:flex><span>					delete(<span style=color:#a6e22e>strMapCloned</span>, <span style=color:#a6e22e>sk</span>)
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>cloned</span>[<span style=color:#a6e22e>k</span>] = <span style=color:#a6e22e>strMapCloned</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>any</span>:
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>cloned</span>[<span style=color:#a6e22e>k</span>] = <span style=color:#a6e22e>copyWithoutExcludeKeys</span>(<span style=color:#a6e22e>t</span>, <span style=color:#a6e22e>excludeKeys</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> []<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>any</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>v</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>t</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>t</span>[<span style=color:#a6e22e>i</span>] = <span style=color:#a6e22e>copyWithoutExcludeKeys</span>(<span style=color:#a6e22e>v</span>, <span style=color:#a6e22e>excludeKeys</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>slices</span>.<span style=color:#a6e22e>Contains</span>(<span style=color:#a6e22e>excludeKeys</span>, <span style=color:#a6e22e>k</span>) {
</span></span><span style=display:flex><span>				delete(<span style=color:#a6e22e>cloned</span>, <span style=color:#a6e22e>k</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>cloned</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0521/>yubikey bio を完全にマスターした</a></h1><div class=post-meta><time class=post-date>2023-05-21 (Sun.) ::</time></div><span class=post-tags>#<a href=/diary/tags/device/>device</a>&nbsp;
#<a href=/diary/tags/pam/>pam</a>&nbsp;
#<a href=/diary/tags/auth/>auth</a>&nbsp;
#<a href=/diary/tags/security/>security</a>&nbsp;</span><div class=post-content><p>2時に寝て遅くまで飲んでいたせいか、やや吐き気もしながら朝起きてだらだらして11時ぐらいに起きた。</p><h2 id=1password-のロック解除を-yubikey-で行う>1password のロック解除を yubikey で行う</h2><p>先日購入して触っていた <a href=/diary/posts/2023/0429/#yubikey-bio-を触ってみた>yubikey bio の設定</a> の続き。1password のロック解除を指紋認証で行いたかったが、1password の 8.10.4 のアプリではロック解除をシステム認証で行おうとするとエラーが発生していた (バグってた) 。5月の頭に <a href=https://releases.1password.com/linux/8.10/#1password-for-linux-8.10.6>8.10.6</a> がリリースされていてシステム認証のバグが直っていることに気付いた。1password のアプリケーションがどうやって linux のシステム認証を使っているかは次の1文に書いてある。</p><blockquote><p>システム認証は、Linux のユーザーアカウントに組み込まれたアクセス制御機構を使用します。これは polkit と PAM (Pluggable Authentication Modules) という2つの Linux 標準に依存しています。この2つを組み合わせることで、安全な認証サービスを提供します</p><p><a href=https://support.1password.com/system-authentication-linux/#about-system-authentication-security>https://support.1password.com/system-authentication-linux/#about-system-authentication-security</a></p></blockquote><p>私は <a href=https://wiki.archlinux.org/title/Polkit>polkit</a> を使ったことがなくて初見でよく分かっていないが、どうやら polkit から pam を介して認証しているようにみえる。pam.d 配下の設定を調べてみると <code>/etc/pam.d/polkit-1</code> がある。前回の設定で pam.d の設定とテストの方法を理解していた。ここまでくれば <a href=https://github.com/Yubico/pam-u2f/tree/main#module-arguments>Module Arguments</a> のドキュメントをみながらオプションを設定するだけ。<a href=https://yoshiori.hatenablog.com/entry/2022/02/17/173147>1Password のロック解除をYubiKeyでやる</a> の記事で origin/appid にホスト名を指定しているが、最新のモジュールだと指定しないときはデフォルトでホスト名が使われるようにみえる。</p><ul><li>origin: FIDO 認証手順の party ID を設定する、値が指定されない場合は識別子 <code>pam://$HOSTNAME</code> が使用される</li><li>appid: FIDO 認証手順の application ID を設定する、値を指定しない場合は origin で使用されたものと同じ値が使用される (origin も指定しない場合は <code>pam://$HOSTNAME</code>)</li><li>nouserok: 認証しようとするユーザーが <code>authfile</code> 内に存在しない場合や <code>authfile</code> が欠落/不正確な場合でも、認証の試行を成功させるように設定する</li><li>cue: タッチすることを促すメッセージを表示するように設定する</li></ul><p>これらを踏まえて u2f で認証が成功したらそれ以降の処理をスキップするように次の設定を先頭に追加する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sudo vi /etc/pam.d/polkit-1
</span></span><span style=display:flex><span>auth   sufficient   pam_u2f.so nouserok cue
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>cue を指定したことでパスワードプロンプトを表示せず、デバイスをタッチするように促される。よい感じ。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pamtester polkit-1 t2y authenticate
</span></span><span style=display:flex><span>Please touch the device.
</span></span><span style=display:flex><span>pamtester: successfully authenticated
</span></span></code></pre></div><p>これで pam の polkit の設定が正しいことを検証できる。この後に 1password のアプリケーションでロック解除するときに u2f を使って指紋認証できた。めっちゃ便利。</p><figure><img src=/diary/img/2023/0521_1password-system-auth.png></figure></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0429/>yubikey bio を触ってみた</a></h1><div class=post-meta><time class=post-date>2023-04-29 (Sat.) ::</time></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/device/>device</a>&nbsp;
#<a href=/diary/tags/pam/>pam</a>&nbsp;
#<a href=/diary/tags/auth/>auth</a>&nbsp;
#<a href=/diary/tags/security/>security</a>&nbsp;</span><div class=post-content><p>3時半に寝て7時に起きた。リリース終えたので晩ご飯を食べてから自分の会社のお仕事をしていたら遅くなった。</p><h2 id=ストレッチ>ストレッチ</h2><p>今週もリリース明けでそれほど座っている時間が長かったわけでもないため、腰の張りはあまりなく、負荷は低くなっているのではないかと推測する。今日の開脚幅は開始前156cmで、ストレッチ後158cmだった。右股関節周りの硬さは相変わらず大きく変化はないが、他がよくなった分、右ふともも前の筋を伸ばすと張りがきつくてしんどいように感じた。しばらく余裕のある生活ができるので歩いたりストレッチしたりする余裕が出てくるかもしれない。</p><h2 id=yubikey-bio-を触ってみた>yubikey bio を触ってみた</h2><p>先日 <a href=/diary/posts/2023/0416/#yubikey-bio-の購入>yubikey bio をオンラインストアで購入</a> した。会社の経費で業務で使うことを目的に購入したのでこの場合は商用利用の輸入にあたる。また別途、輸入についての会計処理を書く。yubico はスウェーデンの会社でどうやら日本向けはスウェーデンの首都ストックホルムから発送されてきたらしい。安いエコノミープランで注文していた。発送メールを受け取ったのが 4/17 でオフィスの郵便受けに入っていることに気付いたのが 4/29 になる。12日で届いたことになる。船便にしては早いからなにかしら航空便の安いプランで届いたのだと推測する。</p><blockquote><p>Economy - 10-20 Working Days - No tracking available</p></blockquote><p>早速、接続していろいろ触ってみた。結論から言って ubuntu 22.04 で fido2 pin を設定して u2f を使って2要素認証のメソッドとして pam や web アプリケーションから問題なく使えた。ubuntu 向けのアプリケーションも ppa のリポジトリを追加して apt からインストールできる。</p><ul><li><a href=https://support.yubico.com/hc/en-us/articles/360016649039-Installing-Yubico-Software-on-Linux>Installing Yubico Software on Linux</a></li></ul><p>このドキュメントには次の4つのアプリケーションのインストールが書いてある。</p><ul><li>YubiKey Manager (CLI): <code>sudo apt install yubikey-manager</code></li><li>YubiKey Personalization Tool: <code>sudo apt install yubikey-personalization-gui</code></li><li>libpam-yubico: <code>sudo apt install libpam-yubico</code></li><li>libpam-u2f: <code>sudo apt install libpam-u2f</code></li></ul><p>yubikey は他にもいろいろな認証の用途に使えるらしい。今回は fido2 の設定のみを紹介する。fido2 pin を登録するには YubiKey Manager の GUI を使った方が簡単なので次のアプリケーションも一緒にインストールするとよい。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sudo apt install -y yubikey-manager-qt
</span></span><span style=display:flex><span>$ ykman-gui
</span></span></code></pre></div><p>おそらく ykman の cli でも登録できると思うけど、yubikey や認証設定に慣れていない初心者は gui のナビゲーションに従って作業して結果を確認した方が安心だと思う。fido2 pin は ssh でいうところのパスフレーズのようなものなのかな？デバイスが盗まれるのを防ぐために pin があるという。一方で web アプリケーションが fido2 で認証するときに pin を要求するかどうかは任意になるらしい。よくあるパターンは初めて使うときは pin を要求して2回目以降はスキップするといった用途が多いのではないかと推測する。</p><figure><img src=/diary/img/2023/0429_ykman-gui1.png></figure><p>この fido2 pin を使って <a href=https://en.wikipedia.org/wiki/Universal_2nd_Factor>Universal 2nd Factor (u2f)</a> の設定を行う。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ mkdir -p ~/.config/Yubico
</span></span><span style=display:flex><span>$ pamu2fcfg &gt; ~/.config/Yubico/u2f_keys
</span></span><span style=display:flex><span>Enter PIN <span style=color:#66d9ef>for</span> /dev/hidraw3: ***  &lt;<span style=color:#f92672>=</span> このときに yubikey manager で設定した fido2 pin を入力
</span></span></code></pre></div><p>この後 yubikey デバイスが点滅するので丸いセンサー部分を指でタッチすると完了する。このときに指紋登録しているのか、物理的にタッチすることを要求しているだけなのか、よくわかっていない。この前に <a href=https://www.yubico.com/setup/yubikey-bio-series/>chrome で指紋登録</a> をしていたのでそれが使われているのかもしれない。いま ykman で設定をみたら <code>Fingerprints registered</code> とあるのでどこかしらに指紋登録されているらしい。おそらく chrome じゃないかと推測する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ykman fido info
</span></span><span style=display:flex><span>WARNING: PC/SC not available. Smart card <span style=color:#f92672>(</span>CCID<span style=color:#f92672>)</span> protocols will not <span style=color:#66d9ef>function</span>.
</span></span><span style=display:flex><span>PIN is set, with <span style=color:#ae81ff>8</span> attempt<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span> remaining.
</span></span><span style=display:flex><span>Fingerprints registered, with <span style=color:#ae81ff>3</span> attempt<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span> remaining.
</span></span><span style=display:flex><span>Always Require User Verification is turned on.
</span></span></code></pre></div><p>linux で認証時に u2f を使いたいときは <code>pam_u2f.so</code> を使って pam の設定をするとよい。ubuntu だと <code>/etc/pam.d/</code> 配下にいろんな認証設定がある。例えば login 時に2要素認証をしたい場合は次のようにフックする。パスワード入力した後に yubikey のセンサーを物理的にタッチして指紋認証を行える。セキュリティに厳しい会社はこういった運用をしているのかもしれない。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sudo vi /etc/pam.d/login
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span><span style=color:#75715e># Standard Un*x authentication.</span>
</span></span><span style=display:flex><span>@include common-auth
</span></span><span style=display:flex><span>auth       required    pam_u2f.so
</span></span></code></pre></div><p>パスワード認証の代替として使いたい場合は通常の認証の前に <code>sufficient</code> として呼び出せば指紋認証が成功したときにそれ以降の処理がスキップされる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>auth       sufficient    pam_u2f.so
</span></span><span style=display:flex><span>@include common-auth
</span></span></code></pre></div><p>これらの設定を確認にするには <a href=https://pamtester.sourceforge.net/>pamtester</a> というツールを使うと簡単にできる。認証の設定を誤るとログインできなくなってしまうので慎重にテストして振る舞いを確認した上で実際の運用を行うとよい。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pamtester login t2y authenticate  &lt;<span style=color:#f92672>=</span> このときに yubikey デバイスが点滅するので指紋認証する
</span></span><span style=display:flex><span>pamtester: successfully authenticated
</span></span></code></pre></div><p>せっかく購入したので 1password アカウントや github の2要素認証に設定してみた。ワンタイムパスワードの otp の代替として使える。ワンタイムパスワードを入力するより yubikey のセンサーをタッチする方が日々の運用としては少しお手軽と言える。設定していて otp と yubikey でお互いに2要素認証のバックアップを兼ねることに気付いた。認証方法が増えるのでセキュリティ的には脆弱になるけれど、サービスとセキュリティのトレードオフの考え方から、yubikey の分だけ脆弱になっても物理的なセキュリティを担保できるのであれば利便性を考慮してよいように私には思えた。</p></div></article><div class=pagination><div class=pagination__buttons><a href=/diary/tags/security/page/2/ class="button next"><span class=button__text>過去の日記</span>
<span class=button__icon>→</span></a></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>© 2021 Tetsuya Morimoto</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>