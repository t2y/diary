<!doctype html><html lang=en><head><title>Testing :: </title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/tags/testing/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="Testing"><meta property="og:description" content><meta property="og:url" content="/diary/tags/testing/"><meta property="og:site_name" content><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/tags/testing/index.xml rel=alternate type=application/rss+xml title></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><h1>Posts for: #Testing</h1><div class=posts><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1219/>結合テストのデバッグ</a></h1><div class=post-meta><time class=post-date>2023-12-19</time></div><span class=post-tags>#<a href=/diary/tags/gitlab/>gitlab</a>&nbsp;
#<a href=/diary/tags/ci/cd/>ci/cd</a>&nbsp;
#<a href=/diary/tags/mongodb/>mongodb</a>&nbsp;
#<a href=/diary/tags/testing/>testing</a>&nbsp;</span><div class=post-content><p>1時に寝て5時半に起きて7時半に起きた。なんか週の前半からバテている。</p><h2 id=gitlab-cicd-の-dind-で-mongodb-のレプリカセット接続ができない>gitlab ci/cd の dind で mongodb のレプリカセット接続ができない</h2><p>先日対応した <a href=/diary/posts/2023/1214/>mongodb のレプリカセット対応</a> で残った最後の課題。ローカルで実行すれば結合テストは動くが、gitlab ci/cd 環境では動作しないという問題が残っていた。<a href=/diary/posts/2023/1218/>gitlab-runner をローカルで実行できる</a> ようにして、設定やパラメーターを変えたり、デバッグコードを埋め込んだり、コンテナに attach して振る舞いを確認したり、いろいろデバッグして原因はレプリカセット接続におけるホスト名の解決がコンテナ間でできていなかったことがわかった。</p><p>mongodb の結合テストは <a href=https://github.com/ory/dockertest>dockertest</a> を使って実装している。これを gitlab ci/cd で動かすには dind を有効にする必要がある。dind 環境では2つのコンテナを使って結合テストが実行されるわけだが、テストが実行されるコンテナと mongodb コンテナが起動するコンテナの2つが生成される。このときにテストが実行されるコンテナから実際に mongodb が起動するコンテナのホスト名の解決と、mongodb が起動するコンテナ上での自分のホスト名の解決の2つが成立していないとレプリカセット接続ができない。要は1台のローカルホスト上で結合テストを実行するのと、2つのコンテナ上で実行されるのでは設定を変更する必要があるということに気付いた。</p><p>具体的には dockertest の次のパラメーターを、実行環境から解決するホスト名を考慮して設定すればよいと気付いた。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>pool</span>.<span style=color:#a6e22e>RunWithOptions</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>dockertest</span>.<span style=color:#a6e22e>RunOptions</span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span> 
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Hostname</span>:   <span style=color:#a6e22e>executor</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Env</span>: []<span style=color:#66d9ef>string</span>{
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;MONGODB_ADVERTISED_HOSTNAME=%s&#34;</span>, <span style=color:#a6e22e>executor</span>),
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><p>たったこれだけの修正だし、現状の動作の振る舞いが分かればすぐに直せるものではあるけれど、このデバッグにはまた2-3時間を費やした。mongodb のレプリカセット接続はなかなか大変。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1207/>mongodb のレプリカセットのデプロイ調査</a></h1><div class=post-meta><time class=post-date>2023-12-07</time></div><span class=post-tags>#<a href=/diary/tags/mongodb/>mongodb</a>&nbsp;
#<a href=/diary/tags/infrastructure/>infrastructure</a>&nbsp;
#<a href=/diary/tags/container/>container</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/testing/>testing</a>&nbsp;</span><div class=post-content><p>4時前に寝て6時半に起きた。1時過ぎまで作業して、帰って少しゲームして、うまく眠れなくてだらだらしていた。</p><h2 id=mongodb-のレプリカセットの調査>mongodb のレプリカセットの調査</h2><p>以前 <a href=/diary/posts/2023/1101/#mongo-とトランザクションとレプリカセット>mongodb でトランザクションを使うときにレプリカセットが必要</a> なことがわかった。他機能の開発途中だったので一旦後回しにしていたものを回収している。状況によってはメンバーに委譲してもよかったんだけど、私が遊撃で出張ってみることにした。実際に調べてみてコンテナの運用も考慮するとけっこう難しいことがわかってきた。</p><p><a href=https://www.mongodb.com/docs/mongodb-shell/>mongosh</a> からは <a href=https://www.mongodb.com/docs/v7.0/reference/method/js-replication/>Replication Methods</a> を使ってレプリカセットの操作ができる。これはユーティリティのようなもので mongodb としての低レベルのコマンド操作は <a href=https://www.mongodb.com/docs/manual/reference/command/nav-replication/>Replication Commands</a> になる。<a href=https://github.com/mongodb/mongo-go-driver>mongo-go-driver</a> はレプリカセット向けのユーティリティを提供していないため、Replication Commands を RunCommand() の低レベル API を使って自分で実装しないといけない。</p><p>例えば、レプリカセットの初期化をするときは次のように <code>replSetInitiate</code> というコマンドを適切なパラメーターで呼び出す。あまりドキュメントで丁寧に説明されていないので試行錯誤でエラーメッセージをみながら実装することになる。とくにはまるのが mongod のサーバーは <code>--replSet myrs</code> のようにレプリカセットを指定して起動させるものの、初期化コマンドを実行するときはまだレプリカセットを設定していないため、レプリカセットを指定せず、且つ <code>direct</code> パラメーターをセットしないと mongod サーバーに接続できない。この微妙な設定を把握するのにはまった。これが正しい手順かどうかもわからないが、ググったりしているとフォーラムでそういったコメントが散見されたりする。おそらく mongosh の Replication Methods を使うと、クライアントからサーバー接続は裏方でよしなにやってくれるのでそっちの方が簡単ではある。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ReplicaSet</span>) <span style=color:#a6e22e>Initiate</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>config</span> <span style=color:#a6e22e>bson</span>.<span style=color:#a6e22e>M</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>client</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>connectDirect</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to connect with direct: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Disconnect</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>result</span> <span style=color:#a6e22e>bson</span>.<span style=color:#a6e22e>M</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>cmd</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bson</span>.<span style=color:#a6e22e>D</span>{{<span style=color:#a6e22e>Key</span>: <span style=color:#e6db74>&#34;replSetInitiate&#34;</span>, <span style=color:#a6e22e>Value</span>: <span style=color:#a6e22e>config</span>}}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Database</span>(<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>db</span>).<span style=color:#a6e22e>RunCommand</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>cmd</span>).<span style=color:#a6e22e>Decode</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>result</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to run replSetInitiate(): %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>PrettyPrint</span>(<span style=color:#e6db74>&#34;completed to initiate&#34;</span>, <span style=color:#a6e22e>result</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ReplicaSet</span>) <span style=color:#a6e22e>connectDirect</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>mongo</span>.<span style=color:#a6e22e>Client</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>opts</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>Client</span>().
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>SetAuth</span>(<span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>Credential</span>{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Username</span>: <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>User</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Password</span>: <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>Passwd</span>.<span style=color:#a6e22e>String</span>(),
</span></span><span style=display:flex><span>		}).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>SetHosts</span>(<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>Hosts</span>).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>SetDirect</span>(<span style=color:#66d9ef>true</span>) <span style=color:#75715e>// must be true
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>mongo</span>.<span style=color:#a6e22e>Connect</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>opts</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>InitSingleReplicaSet</span>(
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>cfg</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>MongoDB</span>,
</span></span><span style=display:flex><span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>rs</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NewReplicaSet</span>(<span style=color:#a6e22e>cfg</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>initConfig</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bson</span>.<span style=color:#a6e22e>M</span>{
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;_id&#34;</span>: <span style=color:#a6e22e>cfg</span>.<span style=color:#a6e22e>ReplicaSet</span>,
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;members&#34;</span>: []<span style=color:#a6e22e>bson</span>.<span style=color:#a6e22e>M</span>{
</span></span><span style=display:flex><span>			{<span style=color:#e6db74>&#34;_id&#34;</span>: <span style=color:#ae81ff>0</span>, <span style=color:#e6db74>&#34;host&#34;</span>: <span style=color:#e6db74>&#34;localhost:27017&#34;</span>},
</span></span><span style=display:flex><span>		},
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>rs</span>.<span style=color:#a6e22e>Initiate</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>initConfig</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>さらに mongod サーバーを起動するときに <code>--replSet</code> と <code>--keyFile</code> (認証が必要な場合のみ？) という2つのパラメーターを指定する必要がある。<code>--replSet</code> はレプリカセットの識別子を指定する。そして <code>--keyFile</code> は共通鍵を指定する。この共通鍵を生成するには次のようにする。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ openssl rand -base64 <span style=color:#ae81ff>756</span> &gt; my-mongo-keyfile
</span></span><span style=display:flex><span>$ chown mongodb:mongodb my-mongo-keyfile
</span></span><span style=display:flex><span>$ chmod <span style=color:#ae81ff>400</span> my-mongo-keyfile
</span></span></code></pre></div><p>普通のサーバーインスタンスならすぐできることだが、コンテナの運用において面倒なのが owner とパーミッションを設定しないといけないところ。mongo のコンテナは mongodb ユーザーで起動するため、root でマウントされたファイルシステムには書き込みできなかったりして keyFile の配置をどう扱えばよいのかが難しい。docker hub の mongo の issues でもどうやって設定したらいいの？って議論が発散している。mongo 本体が公式のスクリプトや仕組みを提供していれば済む話しだけど、どうもそうではないみたい。だから泥臭い方法で自分でなんとかしないといけないようにみえる。</p><ul><li><a href=https://github.com/docker-library/mongo/issues/246>Creating a mongo image set with &ndash;replSet #246</a></li><li><a href=https://github.com/docker-library/mongo/issues/339>Cannot configure replica sets with entrypoint-initdb #339</a></li></ul><p>dockertest でもレプリカセットの設定について次の issue として登録されている。mongo のコンテナを使ったテストの場合、dockertest のレイヤーが挟まるのでさらにわかりにくくなっている。テストを動かすためにどういった設定が必要かは把握できたのでなにかよい方法を考えてコントリビュートしたい。</p><ul><li><a href=https://github.com/ory/dockertest/issues/480>Create an example for starting mongodb as a replica set #480</a></li></ul></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1019/>メールの結合テストのツール</a></h1><div class=post-meta><time class=post-date>2023-10-19</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/testing/>testing</a>&nbsp;
#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/event/>event</a>&nbsp;
#<a href=/diary/tags/postmortem/>postmortem</a>&nbsp;</span><div class=post-content><p>0時に寝て4時と5時に起きて6時に起きた。最近は4時から1時間ごとに起きたりする。メールの送信処理のリファクタリングのコードレビューが長く続いていてなかなかややこしい。</p><h2 id=mailhog-の-web-api-を使って検索する>mailhog の web api を使って検索する</h2><p>メール送信の結合テストに <a href=https://github.com/mailhog>mailhog</a> というツールを使っている。smtp サーバーとしてメールを受け付けて web ui でそのメールの内容を確認できる機能をもっている。さらに web api で任意のメール取り出すこともできる。パスワードリセットの一時トークンをメールで送信するため、結合テストで一連のパスワードリセットを検証するにはメールから一時トークンを取り出さないといけない。そこで mailhog の出番だ。</p><p>検索 api を使うと任意のメールをフィルターできる。例えば、送り先のメールアドレスで検索するときは次のようにリクエストする。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -s <span style=color:#e6db74>&#34;http://localhost:8025/api/v2/search?kind=to&amp;query=myuser1@example.com&#34;</span> | jq .
</span></span></code></pre></div><p>うちらのやり方はメールのメッセージ ID に意図した uuid をセットしている。メールのメッセージから指定した uuid を含んでいるかを検索することで任意のメールをフィルターできる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -s <span style=color:#e6db74>&#34;http://localhost:8025/api/v2/search?kind=containing&amp;query=28c9391f-25a5-4a8f-9035-7b8d5ac2d0f4&#34;</span> | jq .
</span></span></code></pre></div><p>それを結合テストのテストコードから呼び出すようにユーティリティを作ると次のようなコードになる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;github.com/mailhog/data&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>mmSearchResult</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Total</span> <span style=color:#66d9ef>int</span>            <span style=color:#e6db74>`json:&#34;total&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Count</span> <span style=color:#66d9ef>int</span>            <span style=color:#e6db74>`json:&#34;count&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Start</span> <span style=color:#66d9ef>int</span>            <span style=color:#e6db74>`json:&#34;start&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Items</span> []<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>Message</span> <span style=color:#e6db74>`json:&#34;items&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>searchMail</span>(
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>host</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>kind</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>query</span> <span style=color:#66d9ef>string</span>,
</span></span><span style=display:flex><span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>mmSearchResult</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>q</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>url</span>.<span style=color:#a6e22e>Values</span>{}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>Set</span>(<span style=color:#e6db74>&#34;kind&#34;</span>, <span style=color:#a6e22e>kind</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>Set</span>(<span style=color:#e6db74>&#34;query&#34;</span>, <span style=color:#a6e22e>query</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>u</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>url</span>.<span style=color:#a6e22e>URL</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Scheme</span>:   <span style=color:#e6db74>&#34;http&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Host</span>:     <span style=color:#a6e22e>host</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Path</span>:     <span style=color:#e6db74>&#34;/api/v2/search&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>RawQuery</span>: <span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>Encode</span>(),
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>url</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>String</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>slog</span>.<span style=color:#a6e22e>Debug</span>(<span style=color:#e6db74>&#34;mailhog search endpoint&#34;</span>, <span style=color:#e6db74>&#34;url&#34;</span>, <span style=color:#a6e22e>url</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>NewRequest</span>(<span style=color:#e6db74>&#34;GET&#34;</span>, <span style=color:#a6e22e>url</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;http create new request error. err: %s&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>DefaultClient</span>.<span style=color:#a6e22e>Do</span>(<span style=color:#a6e22e>req</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;http request error. err: %s&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>StatusCode</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>400</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;returned response code is %d&#34;</span>, <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>StatusCode</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>r</span> <span style=color:#a6e22e>mmSearchResult</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>convertBody</span>(<span style=color:#a6e22e>res</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>r</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to convert: %s&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>r</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=歯医者>歯医者</h2><p>17時から歯科検診へ行ってきた。歯科検診をしてくれた今回のスタッフはおそらく初めてだったと思うが、手際がよくていつもよりもストレスが少なかった気がした。うちのチームのメンバーは朝方なので8時過ぎにはだいたいみんな始業し始める。なので、朝よりも夜にいない方がメンバーにとってよいだろうと考えて、朝一 (9時) に歯医者へ行くよりも最終 (17時) に行くようにしている。</p><h2 id=pycamp-ふりかえり>pycamp ふりかえり</h2><p>先週末の <a href=/diary/posts/2023/1014/#python-boot-camp>Python Boot Camp</a> のふりかえり。ここまでがスタッフのお仕事なので一般的な kpt でイベントのふりかえりをした。仕事じゃないし、大きなトラブルもなかったし、参加者の評判 (アンケートの内容) もよかったので概ねよい内容だったと思う。テキストの改善点は直接 issue に追加してほしいと言われたので報告した。是非も含めてスタッフに判断してほしいので私が直すつもりはない。</p><ul><li><a href=https://github.com/pyconjp/pycamp.pycon.jp/issues/219>タプルとリストの違いの説明に辞書のキーになれることも追加する #219</a></li><li><a href=https://github.com/pyconjp/pycamp.pycon.jp/issues/220>Windows 環境で普通に pip upgrade をすると環境が壊れる #220</a></li><li><a href=https://github.com/pyconjp/pycamp.pycon.jp/issues/221>pip コマンドの説明で実際に存在するモジュールを書いてあると誤ってインストールしてしまう #221</a></li></ul></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1018/>パスワードリセットのテストのためのガイドライン</a></h1><div class=post-meta><time class=post-date>2023-10-18</time></div><span class=post-tags>#<a href=/diary/tags/auth/>auth</a>&nbsp;
#<a href=/diary/tags/security/>security</a>&nbsp;
#<a href=/diary/tags/testing/>testing</a>&nbsp;</span><div class=post-content><p>0時に寝て何度か起きて4時に起きて仮眠して6時に起きた。あまり寝た気がしない。</p><h2 id=owasp-のパスワードリセットのガイドライン>OWASP のパスワードリセットのガイドライン</h2><p>パスワードリセットの仕組みをメンバーに開発してもらっている。そのコードレビューが先週から白熱している。セキュリティが関連するので堅牢に作る必要があるのでここはあまり妥協せきない。お手伝い先のシニアエンジニアから独自設計で作るのではなく、最低限、世の中の一般的なガイドラインに従っているかを確認するために OWASP のガイドラインを紹介してくれた。これはパスワードリセットの仕組みをテストするための要項をあげている。</p><ul><li><a href=https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/04-Authentication_Testing/09-Testing_for_Weak_Password_Change_or_Reset_Functionalities>Testing for Weak Password Change or Reset Functionalities</a></li></ul><p>これをメンバーに読んでもらって理解して実装しろと言いたいところでもあるが、私自身、読んだことがないとレビューできないことに気付いて、これは私が読んだ上で既存の設計や実装を見直すべきだと判断して deepl を駆使しながらほとんどを読んでみた。たしかに読んでみていくつか抜け・漏れに気付いたり、うちのセキュリティポリシーとして意図的に緩和しているところも認識できたりして、結論から言って読んでよかったと思う。当初はパスワードリセットのために一時トークンを1つだけ使っていたのだけど、それも2つを別々の経路に送って、割符のように組み合わせて認証する仕組みに変更した。よりセキュアにするという意図では一時トークンも1つよりも2つの方がよいというのは概ね正しいと思う。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0906/>openldap サーバーのデバッグ</a></h1><div class=post-meta><time class=post-date>2023-09-06</time></div><span class=post-tags>#<a href=/diary/tags/ldap/>ldap</a>&nbsp;
#<a href=/diary/tags/debug/>debug</a>&nbsp;
#<a href=/diary/tags/testing/>testing</a>&nbsp;</span><div class=post-content><p>1時に寝て3時に起きて5時に起きて6時半に起きた。あとひと踏ん張りなのでこのまま突っ切る。</p><h2 id=openldap-25-の-ldappasswd-の振る舞い>openldap 2.5 の ldappasswd の振る舞い</h2><p>openldap サーバーでパスワードを変更時の平文パスワードを連携するために <a href=/diary/posts/2023/0525/#カスタム-overlay-モジュールの改修>カスタム overlay モジュール</a> を使っている。前回の改修をしたときは openldap 2.4 向けのみの振る舞いを検証していた。今回は開発フェーズでは openldap 2.5 向けにもモジュールをビルドしてパッケージングしていた。その qa テストをしていて ldappasswd だけ、意図したパスワード連携が行われないという。</p><p>開発時に私が振る舞いを検証したつもりが ldapadd, ldapmodify は確認済みだったが、ldappasswd の確認をしていなかった。これは完全に私のミスで2つのフックポイントに対してカスタム overlay モジュールが動くのだから ldappasswd も大丈夫だろうと見通していた。しかし、そうではなかった。それぞれにフックポイントのコールバック設定があって、フックポイントもロジックが違うのだから当然ではあるのだけど、ちゃんと動作検証をしないといけないという、初歩的なミスをした。こんなこともあるんやと反省した。</p><p>gdb でデバッグしていて原因は 2.5.3 に含まれる次の修正だとわかった。私が検証していた openldap サーバーのバージョンは 2.5.14 だった。</p><ul><li><a href="https://bugs.openldap.org/show_bug.cgi?id=8698">Issue 8698 - ppolicy: responses from pwdCheckModule discarded when using an extended password modify</a></li><li><a href=https://git.openldap.org/openldap/openldap/-/merge_requests/304/diffs>ITS#8698 Propagate policy checker message through even if using PW Extop</a></li></ul><p>簡潔に言えば、なんらかの不具合対応でもともと設定してあるコールバックを別のものに上書きしていた。カスタム overlay モジュールが設定したコールバックが別のものに上書きされてしまって意図した振る舞いをしないという現象が起きていた。これは明らかに openldap のリグレッションなので 2.5.15 で修正されてた。</p><ul><li><a href="https://bugs.openldap.org/show_bug.cgi?id=9990">Issue 9990 - Part of the ITS#8698 fix breaks exop overlays that set a callback</a></li></ul><p>たまたまピンポイントにバグを踏んだ形にはなったが、qa テストという別の人がテストをする仕組みでこのバグを検出できたことがうちの開発の品質基準を担保していることの表れでもある。</p><blockquote><p>生きるということは嬉しいこと半分、辛いこと半分なのですよ。 采王</p></blockquote></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0904/>週末遊んで月曜日を迎える</a></h1><div class=post-meta><time class=post-date>2023-09-04</time></div><span class=post-tags>#<a href=/diary/tags/testing/>testing</a>&nbsp;
#<a href=/diary/tags/issue-management/>issue management</a>&nbsp;</span><div class=post-content><p>21時に寝て何度か起きて7時に起きた。決して夜更ししているわけでもないのにずっと疲れている感があって早めに寝ていた。それでさらにお仕事が溜まる。</p><h2 id=qa-テストとバグ修正>qa テストとバグ修正</h2><p>先々週から qa テストが始まっていて、私はあまり参加できていないけれど、上がってくる issue のトリアージや致命的なバグの修正、インフラ周りの不具合の修正などをしている。1つは1つは難しくない小さい粒度のものだけれど、他の issue との関連があったり、アーキテクチャや既存の仕様そのものを見直した方がよいものもあったりと、背景の調査に時間がかかっていて、思ったよりも「ちぎっては投げちぎっては投げ」といった対応は取れていない。issue の優先順位付けしようにも、先に解決しないといけない issue があったり、この仕様はそもそもおかしいとか、よいことではあるのだけど qa でみつかる issue のトリアージが難しくなっている。それだけメンバーのシステムへの習熟度が上がって精度の高い issue をあげられるようになってきたという現れでもある。私がまごまごしているのは紛れもない事実ではある。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0831/>qa と最初のキャリア</a></h1><div class=post-meta><time class=post-date>2023-08-31</time></div><span class=post-tags>#<a href=/diary/tags/testing/>testing</a>&nbsp;
#<a href=/diary/tags/career/>career</a>&nbsp;
#<a href=/diary/tags/book/>book</a>&nbsp;</span><div class=post-content><p>0時に寝て何度か起きて6時に起きた。1-2週間前に2年ほどやっていたドラクエタクトをやめた。飽きたのか自然ともういいかって感じでやめられた。それ以来、家に帰ってからゆっくり休む時間が増えた気がする。</p><h2 id=qa-という業務の懐の広さ>qa という業務の懐の広さ</h2><p>先週の水曜日から qa テストに移行している。スケジュールとしてはこのために1ヶ月を確保している。おそらくもう少し早く終えられるんじゃないかという気はしている。早く終われば次の開発の計画づくりを前倒しにすればよいのでそれは構わない。私は先週から残タスクのリファクタリングが終わりきらなかったのでややバタバタしていたが、メンバーはテストに専念してテスト環境で動かして意図しない振る舞いを issue 登録したり、直感とは反する振る舞いを issue 登録したりしている。</p><p>新人さんや、未経験だけと開発者になりたいとジョブチェンジする人たち向けに、最初のキャリアとしてテスターや qa をするのがよいのではないかと私は考えている。きっかけは More Joel on Software に、テクニカルサポートは開発者を配置する必要があると書いてあった。しかし、テクニカルサポートだとスキルを身につけると持て余してしまうため、その業務ためのキャリアパスを考えないといけないと書いてあった。まったく同感だ。私がお手伝いしたある会社でもテクニカルサポートは1-2年で辞めているのを見聞きした。みんな開発したいからね。</p><blockquote><p>(おまけ) カスタマーサービスの人たちのためのキャリアパスを用意する</p><ul><li>テクニカルサポートにはデバッグ能力を要求するため、資質の高い人を配置する必要がある</li></ul><p><a href=https://t2y.hatenablog.jp/entry/2021/10/09/162618>More Joel on Software</a></p></blockquote><p>新卒以外の採用ルートで未経験から開発者になるのは、いまは相当に難しいと思う。そんな人たちがキャリアアップするための試金石としてテスターがよいと思う。重要なお仕事だし、テストツールをプログラミングすることで開発者になるための準備期間 (学習) にもあてられる。システムの振る舞いや知識もテストを通して身につけられる。このお仕事を2-3年務められて、プログラミングも少し理解できるようになって、それでも開発者になりたいという意志があるなら開発者にステップアップすればよい。適正があるかどうかわからない状態で開発者を始めるよりも、ゆっくり学んでいけるのでうまくいくのではないか？と思ったりする。うちの会社はまだ社員を雇う余裕がないので私の持論の検証はできないが、どこかの会社でやってみてほしい。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0822/>イレギュラーな出張</a></h1><div class=post-meta><time class=post-date>2023-08-22</time></div><span class=post-tags>#<a href=/diary/tags/project-management/>project management</a>&nbsp;
#<a href=/diary/tags/testing/>testing</a>&nbsp;
#<a href=/diary/tags/food/>food</a>&nbsp;
#<a href=/diary/tags/biztrip/>biztrip</a>&nbsp;</span><div class=post-content><p>本当は昨日の夜にもう少し開発しようと思っていたが、体力的に衰えているせいか、晩ご飯食べに帰ってそのまま家でだらだらしていた。翌1-3時前までオフィス戻って作業して、それから出張の準備をして、5時過ぎからいつも通り始発の新幹線に向かった。</p><h2 id=定例会議>定例会議</h2><p>私のリファクタリング issue が1つだけ未達で残ってしまった。他の新機能開発はほぼ予定通り完了できた。メンバーががんばってお仕事してくれたことに感謝。無理なスケジュールを強いていないというのもあるが、ちゃんと見積もりと工数を管理できていることそのものはよいことだと思う。概ね予定通りであることを確認して、あと2つのマイルストーン (1ヶ月) を使って qa テストにあてる。これも web 開発からしたら驚くほどの工数を使っているようにみえると思う。しかし、品質の悪い web 開発を私はたくさんみてきたので結果的に qa をちゃんとやる方が工数削減になると私は考えている。</p><p>いま作っているプロダクトのライセンスが実は Apache License v2 になる。oss な会社だから基本的にプロダクトは oss なライセンスで提供しているらしい。とはいえ、リポジトリを一般公開しているというわけでもないため、広く oss として使ってもらいたいというほどのモチベーションでもない。お客さんが要求すればソースコードも提供するといったスタンスらしい。実際にお客さんがソースコードを要求してくることは皆無らしいが。</p><h2 id=もうやんカレー>もうやんカレー</h2><p>過去に虎ノ門で働いた頃、もうやんカレー好きな同僚がいて懐かしくて <a href=https://www.moyan.jp/shimbashi/>新橋店</a> へ行ってみた。私がこのお店へ行っていた頃は10年以上のことなのに、昔とお店の雰囲気やメニューはあまり変わっていない気がする。スパイスが効いておいしかった。薬味？トッピング？にサービスで提供されるスモーキーなたくわんや玉ねぎのピクルスもおいしかった。</p><figure><img src=/diary/img/2023/0822_curry.jpg></figure><h2 id=かぷせる旅籠-赤坂-spablic-inn>かぷせる旅籠 赤坂 SPABLIC INN</h2><p>五反田から赤坂へ行くルートの1つとして、五反田 - 新橋 - 赤坂見附で行ける。乗り換えのアクセスがよかったり、新橋で晩ご飯食べるのもちょうどいい。前から知っていて1度泊まってみたいと考えていた <a href=https://www.booking.com/hotel/jp/kapuserulu-long-chi-ban-spablic-inn.ja.html>かぷせる旅籠 赤坂 SPABLIC INN</a> に泊まってみた。<a href=https://spablic.com/>SPA:BLIC</a> がコーポレートサイトらしい。結論から行って、私の感覚ではすごくよかった。また一泊出張のようなスポットで泊まるときがあれば予約したい。カプセルホテルだから料金は4,471円だった。いまの相場からいうとビジネスホテルでも1万2千円ぐらいするので半額以下と言える。カプセルホテルだから盗難防止を考慮して着替え以外はもっていかなかったが、ちゃんと鍵付きのロッカーもあったのでパソコン程度の荷物なら保管できる。</p><p>和風カプセルホテルで施設が新しく、ハイテクであちこちの入館やロッカー、チェックイン／アウトはすべて ic チップで行う。お風呂とサウナはこれといって特徴もなかった気はするが、大きなお風呂に入れるだけで私は満足。コワーキングスペースも併設されていた。休憩プランだと150円/時で使えるらしい。宿泊でももしかしたら使えたのかもしれない。コワーキングスペースが使えるならリモートワークをここでしてもよいのかもしれない。よいところをみつけた。</p><figure><img src=/diary/img/2023/0822_capsule1.jpg></figure></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0816/>お盆の最終日</a></h1><div class=post-meta><time class=post-date>2023-08-16</time></div><span class=post-tags>#<a href=/diary/tags/drinking/>drinking</a>&nbsp;
#<a href=/diary/tags/mongodb/>mongodb</a>&nbsp;
#<a href=/diary/tags/testing/>testing</a>&nbsp;
#<a href=/diary/tags/writing/>writing</a>&nbsp;</span><div class=post-content><p>1時に寝て何度か起きて8時半に起きた。数ヶ月に1回ぐらいの頻度でしかないことだけど寝坊した。起きたら8時半であれ？と思った。起きてから家でそのぐらいの時間までだらだらするのはちょくちょくあることだけど、気付かず寝てたのは久しぶりだった。</p><h2 id=台風が過ぎた後の焼き鳥屋さん>台風が過ぎた後の焼き鳥屋さん</h2><p>今朝に寝坊した理由はこれだと思うけれど、昨日の22時から晩ご飯を求めて仲のよい焼き鳥屋さんへ行ってきた。台風で9割以上のお店が閉めている中、唯一と言っていいぐらいの珍しさで開いてた。そのお店 (グループ) のオーナーは雨が降ろうが槍が降ろうが営業日は開けるという方針らしい。マスターも夕方から台風は過ぎて雨も弱まっていたので普通に営業していたらしい。しかし、お客さんは数グループと少なかったと仰っていた。私が22時に行って誰もいなくて24時までいたけれど、誰も来なかった。通常なら22時だと他に2-3グループはいて、その後も最低でも1グループは飲みにやってくるぐらいの人気のある焼き鳥屋さんだ。そもそも駅から人が出てこないし、道にも人が歩いていない。物流も止まっていたのでいくつか仕入れが出来なくて提供できないメニューもあった。</p><p>いつもなら2杯飲んで帰るところを、こんな日だから売上に貢献しようと思って3杯飲んで寝坊した気がする。</p><h2 id=mongodb-700-リリース>mongodb 7.0.0 リリース</h2><p>ちょうど qa テスト前で mongodb のメジャーバージョンがリリースされそうなので毎週のようにチェックしていた。rc10 までいって ga されたみたい。</p><ul><li><a href=https://www.mongodb.com/community/forums/t/mongodb-7-0-0-is-released/239732>MongoDB 7.0.0 is released</a></li></ul><p>まだ docker hub には正式なリリースバージョンのコンテナイメージは公開されていない。しかし、rc10 が ga になったはずなのでひとまずはそれを使って開発環境とテスト環境を 7.0.0 に移行した。うちの用途だと ttl インデックスを作り直す以外には移行作業は必要なかった。自動テストはそのまま成功したし、テスト環境のデータもそのまま移行してパッとみた感じでは正常に動いている。来週から qa テストも始まるのでぎりぎり間に合ったというところ。<a href=https://www.mongodb.com/support-policy/lifecycles>MongoDB Software Lifecycle Schedules</a> によると、だいたい mongodb は3年サポートされる。メジャーバージョンが年に1回リリースされているようにみえるので、いまメジャーバージョンを上げておくと1年余裕をもって運用できる。</p><h2 id=テックブログの執筆開始>テックブログの執筆開始</h2><p>お昼からテックブログの執筆に着手した。あまり大きな意味はないのだけど、お手伝い先のテックブログの記事を早く3つ書きたかった。別に三部作というわけでもない。けれど、テックブログ書いてますよと他者へ伝えるときに最低3つぐらい記事を書いていないと、全然書いてないやんと私なら思ってしまう。3つぐらいあれば、この人はこういう技術に関心があるんだ、こんな業務をやっているんだ、内容もしっかり書けているねとか、そういう判断を下すことができる最低限のコンテンツ量と言えるのではないだろうか。私にとってはそれが3つの記事と言える。<a href=/diary/posts/2023/0815/#課題管理とプロジェクトマネージメントの話を熱く語る>ちょっと前に公開した podcast</a> でテックブログの記事を読んでくださいと話したのでリスナーが聞く前に増やしておきたい。ちょうどプロダクトのプレスリリースも出たのでその宣伝も兼ねられるし、勉強会のネタにもなるし、私の義務感を軽減してストレス解消にもなるし、ここは踏ん張って今日・明日で下書きを書き終えたい。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0814/>週明けから疲労困憊</a></h1><div class=post-meta><time class=post-date>2023-08-14</time></div><span class=post-tags>#<a href=/diary/tags/network/>network</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/testing/>testing</a>&nbsp;</span><div class=post-content><p>4時に寝て7時に起きた。遅くまでコードを書いていたわけではないけど、眠れなかったのとお腹空いて夜にもぐもぐ夜食を食べていたせいかもしれない。たいてい月曜日は元気いっぱいなのに今日はバテバテだった。</p><h2 id=wifi-復旧>wifi 復旧</h2><p><a href=/diary/posts/2023/0812/#オフィスの-wifi-不通>金曜日からコワーキングスペースの wifi が不通</a> になっていた。午前中に業者がフロアの機器室の扉 (施錠されている) を開けて作業していた。週末に復旧できなかったのはシンプルに業者との保守契約に休日対応オプションが入っていなかったのかもしれない。運悪く連休に発生したために約3日間停止していた wifi が11時過ぎにようやく復旧した。フロアにまったく人影がなくて、みんなお盆休みなのかもしれない。</p><h2 id=エージェントアプリケーション開発>エージェントアプリケーション開発</h2><p><a href=/diary/posts/2023/0813/#エージェントアプリケーション開発>昨日の続き</a> 。朝からマージリクエストを作ってメンバーにレビューしてもらう。1000行程度の diff になったのでレビューするのも大変。基本的なロジックは問題なかったけれど、メンバーがしっかりレビューしてくれたおかげで細かいところをみていくと、いくつか修正点があった。感謝。レビューを終えて、マージして、テスト環境にデプロイして、一通り動いていることは確認した。ここからは運用レベルの検証に入っていく。週末も昨日もあまり寝てないのもあって、台風がきているし、今日はここで休むことにした。疲れたー。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0714/>メモリリークに遭遇</a></h1><div class=post-meta><time class=post-date>2023-07-14</time></div><span class=post-tags>#<a href=/diary/tags/operation/>operation</a>&nbsp;
#<a href=/diary/tags/testing/>testing</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;</span><div class=post-content><p>23時に寝て何度か起きて5時に起きてからだらだらネットしながら記事を読んだりしていて7時に起き上がった。</p><h2 id=agent-アプリケーションのメモリリーク調査>agent アプリケーションのメモリリーク調査</h2><p>qa テストの一環として先月からテスト環境で毎分 agent アプリケーションにリクエストを投げる長時間稼働テストを実行している。なんとなく気になるところがあったからやったわけではあるけれど、長時間稼働テストによってメモリリークを検出できてしまった。自分を過信せずちゃんと検証しないといけないなと思えた。top コマンドの実メモリー (RES) を1ヶ月前と比較して増えているからメモリリークだと気付いたところ。これからメモリプロファイリングをしながら原因を追求していく。私が書いた (レビューした) go のコードでメモリリークはないだろうと高をくくっていただけにちょっとショックではあった。</p><p>go は標準ライブラリに pprof というプロファイラがあるので簡単にデバッグできる。プロファイラで昨日から調査していたところ、<a href=https://github.com/go-zeromq/zmq4>go-zeromq/zmq4</a> の処理でメモリリークしていることはわかった。それがライブラリの使い方が誤っているのか、潜在的な不具合なのかはまだこれから調査するところ。</p><p>ライブラリ側の問題を調査するので厄介ではあるけど、私が書いた (レビューした) go のコードでメモリリークしているわけじゃないことがわかって少しほっとした。</p><h2 id=go-の-generics-勉強会>go の generics 勉強会</h2><p><a href="/diary/posts/2023/0707/#go-の-generics 勉強会の準備">先日準備した資料</a> を使って勉強会を開催した。</p><ul><li><a href=https://github.com/t2y/go-generics-study>https://github.com/t2y/go-generics-study</a></li></ul><p>この勉強会はある意味、うちのチームのメンバーが理解しておくべき内容なので go のプログラミングをやっていないメンバーが聞いてもあまり関心をもてない内容となっている。そういうお断りもした上で最悪2-3人ぐらいの参加者になるかと思ったもののプログラミングに関心がある人たちは参加してくれて5-6人ぐらいの規模にはなった。一方で内容も難しいし、私の説明がどれだけわかりやすかったか、私自身にはわからないのでなんとも言えない。質問も一切なかったので喋りきって疲れたという疲労感と、伝わったのか伝わらなかったのか分からない消化不良感と、金曜日だから今日はもういいや感でどっと疲れたというのが率直な感想になる。</p><p>とはいえ、私もずっと generics の仕様をちゃんと追いかけたいと思いながら先送りしていたものではあるので私の中では自分が go の generics の理解度をあげて実際の開発の中で使い分けるだけの判断基準をもてたことが収穫だったと言える。</p></div></article><div class=pagination><div class=pagination__buttons><a href=/diary/tags/testing/ class="button previous"><span class=button__icon>←</span>
<span class=button__text>最近の日記</span>
</a><a href=/diary/tags/testing/page/3/ class="button next"><span class=button__text>過去の日記</span>
<span class=button__icon>→</span></a></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2024 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>