<!doctype html><html lang=en><head><title>Testing :: </title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/tags/testing/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="Testing"><meta property="og:description" content><meta property="og:url" content="/diary/tags/testing/"><meta property="og:site_name" content><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/tags/testing/index.xml rel=alternate type=application/rss+xml title></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><h1>Posts for: #Testing</h1><div class=posts><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/1031/>開発合宿前日</a></h1><div class=post-meta><time class=post-date>2024-10-31</time></div><span class=post-tags>#<a href=/diary/tags/testing/>testing</a>&nbsp;
#<a href=/diary/tags/badminton/>badminton</a>&nbsp;</span><div class=post-content><p>今日のバドミントン練習は体育館で1時間ほど練習できた。試合中にまた足と腰を痛めてしまった。無理しないように意識していてもついついシャトルを追いかけてしまう。しばらく試合はやめとこうと思う。</p><h2 id=テストコード追加の一区切り>テストコード追加の一区切り</h2><p>これまでテストの改善をやってきてもっとも仕様が複雑、且つ数量も多い api 群のテストコードを一通り書き終えた。カバレッジを目標の1つにしているので改善していることを数値で確認できる。その過程でいくつかバグをみつけて直すこともできる。区切りとして一通りやり切ったので安心して明日はお休みをとって開発合宿へと行ける。しんどかったけど、やっていれば形になって結果は出てくる。一方で私が実際の開発をやってしまうと自分の時間をどんどん浪費していることにも気付けるようになってきた。自分の時間をどう使うのかをいろいろ考える開発やリファクタリングの機会となった。今回の開発フェーズが終わったらまた振り返りしたい。</p><h2 id=体育館でバドミントン>体育館でバドミントン</h2><p><a href=/diary/posts/2024/1027/#体育館でバドミントン>前回の所感</a> 。抽選予約で獲得した平日夜の時間帯。今日は参加者が多くて8人来られた。1面のスペースだとこれ以上の人数はちょっと無理そうに思えた。なにか練習をしてもよかったのだけど、8人もいたらスペースが足りないかなと思ってどう運用していいのかわからなかった。不完全燃焼。最初は3対3でネットを挟んでの打ち合いをしてみたが、スペースが狭いからなんとなく手持ち無沙汰になってしまう。経験者の方から2人チームを作ってローテーションでまわしましょうという提案をもらって2対2で10点先取の試合形式にした。10点取ったら交代でローテーションしていくようにした。このときにチーム編成を簡単に決める手段を準備しておくと、決め方を「決める」の無駄な時間を省ける。前に練習に参加させてもらったチームではトランプのカードを引いていた。これはなにかしらツールを用意しておくとよさそう。</p><p>経験者の方にフットワークについて教えてもらった。一歩でどう動くか、腕とラケットを伸ばしてどこまで届くかの距離感を掴むのが大事なように思えた。カラダの近くでシャトルを捉えようとすると動かないといけないが、実際の試合だとシャトルの方が速いのでなかなか動けない。フットワークの重要性が少しわかってきた。</p><p>私の場合、下手だから試合形式にするとすぐミスをして試合を止めてしまい、申し訳なさと自身の練習時間も短くなるという2重でネガティブな所感を受ける。なにかしら量をこなせる練習メニューや打ち合いをしていた方が楽しかったりする。中級者なら試合する方が楽しめるのかな？やはり2面ないと別の思考をもつ人たちが一緒に活動するのは難しいのかもしれない。いまの私はスキルアップにつながる練習の量をこなしないという思いがある。また他のチームの練習にも参加して考察してみようと思う。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/1029/>より良くなって苦しくなる</a></h1><div class=post-meta><time class=post-date>2024-10-29</time></div><span class=post-tags>#<a href=/diary/tags/testing/>testing</a>&nbsp;
#<a href=/diary/tags/management/>management</a>&nbsp;
#<a href=/diary/tags/business/>business</a>&nbsp;</span><div class=post-content><p>お仕事の区切りが悪くて23時までコードを書いていたので今日のバドミントン練習はお休み。ひたすらテストコードを書いている。テストケースをみて、カバレッジをみて、アプリケーションコードを読んで、テストコードを読んでの繰り返しの日々。時間をかけてきたけれど、ようやく成果が出てきつつある。一番ややこしいところのカバレッジを 50.6% から 80.4% に改善したと報告をあげた。テストデータを細かく管理できるようになったのでカバレッジが上がっているだけでなく、複数設定の違いによる振る舞いの検証も進んでいる。</p><h2 id=改善のための改善を繰り返すと苦しくなる>改善のための改善を繰り返すと苦しくなる</h2><p>ちょうどいま私がやっていることのしんどさを代弁してくれているような記事をみかけた。</p><ul><li><a href=https://yashio.hatenablog.com/entry/20241022/1729600977>業務効率化の苦しみでもとの濁りの田沼恋しき的な気持ち</a></li></ul><p>私もいまマネージャーやって、プロダクトの開発全般を改善して、また開発者に戻ってプロダクトのコードを改善して、ここ半年ほど技術的負債になってしまったところを改善しまくってきた。小さい規模ではうまくいったことが規模が大きくなる中での見直しや依存関係によって複雑化したり、自動化をしても自動化のための仕組みは保守しないといけない。改善にはいろいろ面倒くささがついてくる。その割にその成果がみえにくかったり分かりにくかったりする。やっている本人ですら微妙とか思ってしまうことさえあるものの、しかし、それをやらないとさらにひどい状況になるのでやらざるを得ない。</p><p>ひどいプロダクトやどうしようもないスタートアップなどはリアーキテクチャをやらないので直せないといった状況になってしまい、保守している人たちが苦労したり、鈍重な開発で苦しんでいるのをみかけたりする。少なくとも私がイニシアティブをとっているプロダクトでそんなことは起きない。常に改善しまくっているから短期でみた機能開発のスループットは高くないかもしれないが、中長期でみた開発を停滞させる要因はまったくない。</p><blockquote><p>この「より良くしているのに、より苦しくなってくる」機序は、基本的に産業資本主義の特徴なのだろうと思っている。<br>時間軸上の価値体系の差異から価値を取り出す行為を回し続けないといけなくて、効率化して生産性を上げたなら、さらに上げ続けないと価値を取り出せなくなってしまう。<br></p></blockquote><p>テストがなければそもそもテストの改善や見直しという作業は発生しない。開発したときにテストコードを書くという作業も発生しない。業務量はずっと下がる。もちろんその減った業務量は将来の不具合や鈍重な開発により後払いになるわけだが、いまテストを書いていてもその保守や改善のための作業が既存の開発に付加された形で将来に積み重なっていく。テストがなかった未来とテストがある未来を比較することはできないが、どちらの未来にも手に余る業務量が待ち受けているという展望はそれほど変わらないようにみえる。そこで自身の自己実現や成長といった目的がないのであれば、テストがある未来に得ているはずの利益を資本家が搾取するだけで労働者はなんら変わらないのではないかという気持ちが「改善すればするほど苦しくなっていく」と感じてしまう。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/1024/>飛行機での出張帰り</a></h1><div class=post-meta><time class=post-date>2024-10-24</time></div><span class=post-tags>#<a href=/diary/tags/mongodb/>mongodb</a>&nbsp;
#<a href=/diary/tags/testing/>testing</a>&nbsp;
#<a href=/diary/tags/performance/>performance</a>&nbsp;
#<a href=/diary/tags/biztrip/>biztrip</a>&nbsp;</span><div class=post-content><p>夜に神戸に戻ってきてからオフィスに来て、機内でやっていた作業を区切りのよいところまで進めてコミットしたりしていた。その後スーパーへ買いものへ行ったりしていた。今日もバドミントン練習はおやすみ。</p><h2 id=ローカルは-standalone-mongodb>ローカルは standalone mongodb</h2><p>mongodb の <a href=https://www.mongodb.com/docs/manual/replication/>レプリケーション</a> 機能を使っていて、replica set の設定が容易なことから <a href=https://hub.docker.com/r/bitnami/mongodb>bitnami/mongodb</a> というコンテナを使っている。これまで結合テストもレプリケーション機能を設定して実行するようにしていた。結合テストの量が増えてきたのもあって実行時間が徐々に遅くなってきた。いまテストのリファクタリングをしているため、ローカルで検証のために何度も実行する必要がある。コードの品質を上げるためにテストを書きやすくする必要がある。実行時間は短いほどよい。そこでローカルでの実行はレプリケーションを設定しないようにしてみた。さらに go のデータ競合を検知する <code>-race</code> オプションも外してテストを実行してみたところ、この2つの改善で macbook の環境で改善前より45%ほど速くなった。十分な高速化を図れた。</p><h2 id=飛行機ルートのふりかえり>飛行機ルートのふりかえり</h2><p>8月に大雨で新幹線が止まってしまい <a href=/diary/posts/2024/0829/>神戸に帰れない状況</a> に直面した。私はほとんど飛行機に乗ったことがなかったため、新幹線が動かないときの迂回手段として飛行機のルートに慣れておく。普段リュックサックに小さいカッターとマイナスドライバーを携帯している。これらは飛行機の手荷物検査でとめられてしまう。荷物を預けるか、検査場で処分してもらうしかない。前回は ANA で帰ってきたが、今回は <a href=https://www.skymark.co.jp/ja/>スカイマーク</a> の飛行機に乗った。値段が安いから LCC だと思っていたら <a href=https://japantour.airtrip.jp/column/magazine/skymark-why-popularity-goodvalue/>スカイマークは安くて快適なMCC</a> らしい。ANA に比べたらずっと小さい飛行機だった。</p><p>タイムスケジュールは次のようになった。</p><pre tabindex=0><code>18:15 (都営浅草線) 五反田 発
18:56 (京急本線) 羽田空港 着
19:45 搭乗開始
19:55 飛行機の座席に着く
20:08 羽田空港の滑走路を発進
20:20 離陸
(機内は暗かった、ラップトップで作業)
21:16 神戸空港の滑走路に着陸
21:22 降機
21:25 空港内の荷物受け取り場に着く
21:30 荷物を受け取り
21:35 (ポートライナー) 神戸空港 発
21:51 (ポートライナー) 貿易センター 着
</code></pre><p>新幹線だと次のようなタイムスケジュールになる。トータルの時間でみれば新幹線の方が20-30分早いかなといったところ。一方で新幹線だと2時間半、同じ姿勢で座っている必要がある。飛行機だと座っている時間は1時間強。飛行機は搭乗手続きのチェックポイントがいくつかあってそれぞれに細かい待ち時間ができてしまうのが気になる。そのときの体調によってもどちらがよいかは変わってくるかもしれない。来月は行きは飛行機、帰りは新幹線にしてみる。</p><pre tabindex=0><code>17:57 (JR) 五反田 発
18:03 (JR) 品川 着
18:19 (新幹線) 品川 発
20:53 (新幹線) 新神戸 着
21:10 (市営地下鉄) 新神戸
21:12 (市営地下鉄) 三宮
</code></pre></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/1021/>出張前日の資料づくり</a></h1><div class=post-meta><time class=post-date>2024-10-21</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/testing/>testing</a>&nbsp;
#<a href=/diary/tags/project-management/>project management</a>&nbsp;</span><div class=post-content><p>今日は1日中オフィスにこもって作業と出張準備をしていたのでバドミントン練習はお休み。夕方にお土産として <a href=https://shop.morozoff.co.jp/c/region/kobe>モロゾフのプリンクッキー</a> を購入するために本店へ行ってきた。これも神戸限定らしい。</p><h2 id=パッケージ外のディレクトリにあるテストのカバレッジ計測>パッケージ外のディレクトリにあるテストのカバレッジ計測</h2><p>先日 <a href=/diary/posts/2024/1018/#go-test-からバイナリをビルドしてサーバーを起動する>深夜にバイナリのビルド・起動調査</a> をしたのに、最終的にはそんなことしなくてもよかった。デフォルトではパッケージ外のディレクトリにあるテストのカバレッジを計測しないことから普通にはできないと考えていた。しかし、調べたら次の SO で解決法をみつけた。結論としては <code>-coverpkg ./...</code> のように go test で実行している結合テストに対してオプションを指定するだけでよかった。</p><ul><li><a href=https://stackoverflow.com/questions/34535704/how-to-detect-code-coverage-of-separated-folders-in-go>How to detect code-coverage of separated folders in GO?</a></li></ul><p>この調査を終えて最終的な makefile の coverage ターゲットは次のようになった。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-makefile data-lang=makefile><span style=display:flex><span><span style=color:#a6e22e>coverage</span><span style=color:#f92672>:</span> lint
</span></span><span style=display:flex><span>	rm -f coverage.*
</span></span><span style=display:flex><span>	go test -tags<span style=color:#f92672>=</span>integration -race -cover ./... -coverpkg ./... -covermode atomic -coverprofile<span style=color:#f92672>=</span>coverage.out
</span></span><span style=display:flex><span>	go tool cover -html coverage.out -o coverage.html
</span></span></code></pre></div><p>この make ターゲットを gitlab ci/cd から実行して coverage.out/coverage.html を自動生成する。coverage.out があるので必要に応じて好みのツールで統計情報を解析すればよい。たとえば <a href=https://github.com/nikolaydubina/go-cover-treemap>nikolaydubina/go-cover-treemap</a> でツリーマップを作るなら次のように実行する。</p><pre tabindex=0><code>$ go-cover-treemap -coverprofile coverage.out &gt; treemap.svg
</code></pre><h2 id=近況報告の資料作り>近況報告の資料作り</h2><p>普段は週末に報告資料を作っているのにもうやる気が無さ過ぎてお仕事を終えてから作っている。今回はネガティブな内容も報告に入れる。過去の経緯などを調査しながら3時間もあれば一通りのアウトラインはできた。明日がマイルストーンの最終日になるため、明日を終えてからでないと細かい数字は決定しない。マイルストーンの issue を調べたら qa テストでみつけた不具合の issue がそれなりに溜まっているようにみえる。本当は次のマイルストーンで5次開発は完了予定だが、もう1つ増やしてもよいかもしれない。いずれにしても12月／1月に本番導入のための準備もある。今の開発フェーズを完了しても次の開発フェーズには入らないのではないかという見通しもある。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/1016/>テストライブラリの導入</a></h1><div class=post-meta><time class=post-date>2024-10-16</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/testing/>testing</a>&nbsp;</span><div class=post-content><p>今日のバドミントン練習はエアシャトルでリフティングを25分した。連続最大回数は277回できた。初めてエアシャトルで200回を超えた。しかも夜なのに。やや高めに打ち上げれば安定的にリフティングできるようになってきた。連続回数が増えることはラケットとシャトルの距離感、ラケットコントロールが上達していることの証左でもあるので200回を超えたときは嬉しかった。</p><h2 id=テストライブラリの追加>テストライブラリの追加</h2><p>結合テストを改善するために2つのライブラリを新たに使うよう導入した。</p><ul><li><a href=https://github.com/gavv/httpexpect>gavv/httpexpect</a></li><li><a href=https://github.com/stretchr/testify>stretchr/testify</a></li></ul><p>testify は名前だけ知っていたが、実際に使ってみるのは初めて。testify は大きく3つの機能もっている。</p><ul><li>アサーション</li><li>テストスィート</li><li>モック</li></ul><p>うちらのチームで使うのはアサーション機能だけになる。モックも将来的に使う可能性はある。アサーションを使うと自分でエラーメッセージを書く手間を省ける。次のようなコードがあった場合、</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>expected</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>actual</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;expected %d, but got %d&#34;</span>, <span style=color:#a6e22e>expected</span>, <span style=color:#a6e22e>actual</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>次のようにエラーレポートを testify に委譲できる。このぐらいの利便性でしかないが、テストの規模が大きくなったり、量が増えていけば読み書きのコストを削減できるかもしれない。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>assert</span>.<span style=color:#a6e22e>Equal</span>(<span style=color:#a6e22e>expected</span>, <span style=color:#a6e22e>actual</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>httpexpect はまったく知らなくて初めて使ってみたが、感触がよい。これもデフォルトのエラーレポート機能は testify のアサーション機能を使っているようにみえる。これまでは http リクエストに対して自前のユーティリティ関数と組み合わせて次のようなコードを書いていた。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>doHTTPRequest</span>(<span style=color:#a6e22e>body</span>, <span style=color:#a6e22e>UserPath</span>, <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>MethodGet</span>, <span style=color:#e6db74>&#34;&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>StatusCode</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusOK</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;expected to get %d, but got %d&#34;</span>, <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusOK</span>, <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>StatusCode</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>actual</span> <span style=color:#a6e22e>entry</span>.<span style=color:#a6e22e>User</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>convertBody</span>(<span style=color:#a6e22e>res</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>actual</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to convert: %s&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>httpexpect を使うと次のように簡潔に記述できる上にエラーレポートを httpexpect に委譲できる。これはかなりテストコードを読み書きする工数を削減できると思う。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>actual</span> <span style=color:#a6e22e>entry</span>.<span style=color:#a6e22e>User</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>GET</span>(<span style=color:#a6e22e>UserPath</span>).
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>WithJSON</span>(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>any</span>{ <span style=color:#f92672>...</span> }).
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Expect</span>().
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Status</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusOK</span>).
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>JSON</span>().
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Decode</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>actual</span>)
</span></span></code></pre></div></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/1015/>mongodb のテストデータ管理</a></h1><div class=post-meta><time class=post-date>2024-10-15</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/testing/>testing</a>&nbsp;
#<a href=/diary/tags/mongodb/>mongodb</a>&nbsp;</span><div class=post-content><p>今日のバドミントン練習はエアシャトルでリフティングを45分した。連続最大回数は146回できた。調子は悪くなく安定的に30回前後は続くものの、50回を超えたぐらいで失敗してしまう。打ち上げる高さの違いかな？と気付いて少し高めに打ち上げるようにしたら100回を超えた。エアシャトルはラケット面に対して適切な角度でコルクを打たないとあらぬ方向に飛んでいってしまう。高く打ち上げるほど、重力で落ちてくるときにコルクが下を向きやすくなるため、うまくシャトルを打ち上げやすくなる。ラケットコントロールをうまくできれば、エアシャトルをより低い高さでリフティングできるようになるかもしれない。まだ私はそのレベルには満たない。</p><h2 id=json-からの-mongodb-にテストデータを追加する>json からの mongodb にテストデータを追加する</h2><p>結合テストの改善をしていてテストデータを json で管理したい。これまで go の構造体でテストデータを定義して mongodb の client で insert するといったことをしていた。それも役に立つのだけど、共有のテストデータがどこにあるのか、ソースコードに書いてしまうと時間とともに散らばっていって把握できなくなっていく。テストデータを管理するためのディレクトリを設け、そこに json で記述してどのテスト関数で使うかといったメタ情報も定義できるようにした。次のコードは mongodb に json からデータをインポートするための原理を説明するための疑似コードのようなもの。</p><p>go の構造体で定義したテストデータと json で管理するのとどちらがよいかというのは議論の余地はあるし、一概に言えないとは思う。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>testData</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Documents</span>    []<span style=color:#a6e22e>bson</span>.<span style=color:#a6e22e>Raw</span> <span style=color:#e6db74>`bson:&#34;documents&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>InsertData</span>(
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>, <span style=color:#a6e22e>client</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>mongo</span>.<span style=color:#a6e22e>Client</span>, <span style=color:#a6e22e>b</span> []<span style=color:#66d9ef>byte</span>,
</span></span><span style=display:flex><span>) (<span style=color:#66d9ef>func</span>()) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>data</span> <span style=color:#a6e22e>testData</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bson</span>.<span style=color:#a6e22e>UnmarshalExtJSON</span>(<span style=color:#a6e22e>b</span>, <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>data</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>require</span>.<span style=color:#a6e22e>NoError</span>(<span style=color:#a6e22e>t</span>, <span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;failed to get json files: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>col</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Database</span>(<span style=color:#a6e22e>dbName</span>).<span style=color:#a6e22e>Collection</span>(<span style=color:#e6db74>&#34;mycollection&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>col</span>.<span style=color:#a6e22e>InsertMany</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>docsToInterfaces</span>(<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>Documents</span><span style=color:#f92672>...</span>))
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>require</span>.<span style=color:#a6e22e>NoError</span>(<span style=color:#a6e22e>t</span>, <span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;failed to insert: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>insertResult</span>, <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Helper</span>()
</span></span><span style=display:flex><span>	    <span style=color:#a6e22e>col</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Database</span>(<span style=color:#a6e22e>dbName</span>).<span style=color:#a6e22e>Collection</span>(<span style=color:#e6db74>&#34;mycollection&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>id</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>InsertedIDs</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>filter</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bson</span>.<span style=color:#a6e22e>D</span>{{<span style=color:#a6e22e>Key</span>: <span style=color:#e6db74>&#34;_id&#34;</span>, <span style=color:#a6e22e>Value</span>: <span style=color:#a6e22e>id</span>}}
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>col</span>.<span style=color:#a6e22e>DeleteOne</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>filter</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to delete %s: %v&#34;</span>, <span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>呼び出し側のイメージ。defer で teardown を呼ぶことでテスト完了時に追加したテストデータを削除してくれる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>teardown</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>mongotest</span>.<span style=color:#a6e22e>InsertData</span>(<span style=color:#a6e22e>t</span>, <span style=color:#a6e22e>mongoClient</span>, <span style=color:#a6e22e>b</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>teardown</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span></code></pre></div><p>bson.Raw として読み込める json データは bson パッケージのユーティリティを使って dump できる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>dumpAsJSON</span>(<span style=color:#a6e22e>value</span> <span style=color:#a6e22e>any</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>b</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bson</span>.<span style=color:#a6e22e>MarshalExtJSON</span>(<span style=color:#a6e22e>value</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>false</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>slog</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#e6db74>&#34;failed to marshal as extended JSON&#34;</span>, <span style=color:#e6db74>&#34;err&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(string(<span style=color:#a6e22e>b</span>))
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/1011/>ひとりではできないこと</a></h1><div class=post-meta><time class=post-date>2024-10-11</time></div><span class=post-tags>#<a href=/diary/tags/founding/>founding</a>&nbsp;
#<a href=/diary/tags/issue-management/>issue management</a>&nbsp;
#<a href=/diary/tags/business/>business</a>&nbsp;
#<a href=/diary/tags/motivation/>motivation</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/testing/>testing</a>&nbsp;</span><div class=post-content><p>今日のバドミントン練習はエアシャトルでリフティングを30分した。連続最大回数は80回だが、ほとんどの試行は20回も続かずに失敗してしまう。難しい。</p><h2 id=隔週の雑談>隔週の雑談</h2><p>顧問のはらさんと隔週の打ち合わせ。今日の議題はこれら。</p><h3 id=課題管理と-adr-の関係の考察>課題管理と adr の関係の考察</h3><iframe class=speakerdeck-iframe frameborder=0 src=https://speakerdeck.com/player/1d21876659d244a8b6c121255e2fbce9 title=ADRを運用して3年経った僕らの現在地 allowfullscreen style="border:0;background:padding-box padding-box rgba(0,0,0,.1);margin:0;padding:0;border-radius:6px;box-shadow:rgba(0,0,0,.2)0 5px 40px;width:600px;height:auto;aspect-ratio:560/315" data-ratio=1.7777777777777777></iframe><p>数年前から adr の話題や導入した会社の記事などをみかけるようになった。私はこれまで課題管理をうまくやっていれば adr はそれほど重要ではないとあまり重視してこなかった。しかし、世の中的に認知されて流行っているものはなにかしら意義があるのだろうと最近は少し見直してきているところもある。このスライドによると2017年から流行り始めたらしい。</p><ul><li>開発に関する情報を一元管理する、または全文検索ことにビジネスチャンスはある<ul><li>検索のニーズや要件は多様で言語によっても違い、技術もまだまだ発展的でもあるからずっとビジネスの種になる気はする</li><li>gitlab issues のコメントの全文検索は有料機能なので slack 通知したチャンネルを全文検索している<ul><li>課題管理システムのプラグインでテキストをシステム間連携することで検索システムを別途構築できる可能性がある</li><li>検索できなくてもデータのアーカイブをするという視点でもビジネスニーズに応える？</li></ul></li></ul></li><li><a href=https://www.elastic.co/jp/what-is/vector-search>ベクトル検索</a> を検索がまだ一般的にはなっていない？<ul><li>テックブログを読む会でメンバーが <a href=https://zenn.dev/minedia/articles/d9f01aa05bc880>医薬品検索にベクトル検索を導入したら、デフォで検索ニーズをほぼ満たせそうだった話</a> を紹介していた</li><li>いまや rdb でも全文検索機能はあるが、実運用だと rdb の i/o がボトルネックになることは多いだろうから全文検索用途に使うモチベーションが低いと想定される</li><li>普通の全文検索とベクトル検索の違いを実際に触ってみて評価してみたい</li></ul></li><li>wiki と adr の違いの1つとして wiki になにを書いてよいかわからない問題がある<ul><li>文章を書けるようになるのは経験や習熟を必要とする</li><li>adr のようなテンプレートがあることで経験の浅い開発者も書きやすくなる狙いはある</li><li>課題管理システムの wiki に adr のラッピングをして別機能としてみせるのはよいかもしれない</li><li>業務の引き継ぎにも adr は役に立つのではないか？</li><li>adr 一覧をみたり、そこから検索することで検索効率や精度は上がるという想定</li></ul></li><li>大きい会社でも巨大な課題管理システムと wiki が1つだけあって一元管理しているという噂は聞く<ul><li>ある会社では wiki は誤っている可能性があるから信用するなという教訓があった<ul><li>wiki の情報は更新されていない可能性があるから参考にしながら必ず裏をとって業務をしなさいという話し</li></ul></li><li>wiki を編集したら必ずレビューが必要になるプロセス</li></ul></li><li>notion のプロジェクト管理の使い勝手はどうか？<ul><li>テンプレートを使ってガントチャートやカンバンを作れる<ul><li>基本的に自分でカスタマイズできることの良し悪しがある<ul><li>db をどんどん改良できるが、それだけに魔改造してしまう</li><li>時間とともに複数人が改良すると保守できなくなっていく懸念がある</li></ul></li><li>中核機能をパッケージ側で提供することは堅牢性を担保する上で重要ではないか</li></ul></li><li>タスク管理と wiki がシームレスなところはよい、はらさんは日報を書いてリンクしている</li></ul></li><li>会社のインフラに日々の開発情報を書いていくと退職後に参照できない<ul><li>フリーランスのような働き方をするにはナレッジデータベースをローカルに作りたいという欲求がある</li><li>組み込みの課題管理システムにより、自身のナレッジデータベースをローカルに残すという目的はよいかもしれない</li></ul></li></ul><h3 id=仕事は楽しいかねhahahugoshortcode1111s0hbhb-の考察><a href=/diary/posts/2024/1008/>仕事は楽しいかね？</a> の考察</h3><p>まとめを見返しながら、だいたいの項目は理解または支持できる。1つだけ次の項目が私には欠けていることに気付いた。</p><blockquote><p>毎日1つ試し続ければ必ず上達や進歩ができる</p></blockquote><ul><li>新しいことを始めると、いまやっていることを継続する時間がなくなったりしないか？</li><li>プロダクト開発ではがんばってもあまり成果が出ないような時期もある<ul><li>リファクタリングやテスト追加などはまさにそう</li><li>そういったときも1つでも変化をもたらせれば日々の生活が変わるのか？</li></ul></li><li>はらさんのお奨めは梅原さんの <a href=https://www.kadokawa.co.jp/product/301305000020/>１日ひとつだけ、強くなる。 世界一プロ・ゲーマーの勝ち続ける６４の流儀</a></li><li>本書を読んではらさんのよかったところは「試してみることに失敗はない」<ul><li>それまでも試すことはやっていたはずなのに躊躇してしまう理由として失敗したら時間の無駄だと考えてしまっていた</li><li>失敗したら嫌だと考えてしまうところがあったが、この考え方があるから vision pro を購入できる<ul><li>最近は vision pro の話題を聞かなくなったがどうか？<ul><li><a href=https://internet.watch.impress.co.jp/docs/yajiuma/1630679.html>ロードマップに影響は？ Appleに26年間在籍した「Vision Pro」の開発責任者が退職へ</a></li><li>仕事にはならないのではないか？</li></ul></li></ul></li><li>やりたいことをすぐやってみるという思考につながった</li></ul></li><li>面倒くさいときもなるべくパソコンを使うようにしてなにかしら調べる</li><li>私はオフィスにいれば、家よりはなにかしら作業するモチベーションになる</li><li>目標達成や成果をあげるには環境がもっとも大事<ul><li>個人の感情を信頼しない<ul><li>人間は面倒だとすぐ怠けてやめてしまう</li></ul></li><li>環境を整えることでワークフローを洗練させて習慣化する<ul><li>日記になにか書かないといけないから調べものをする</li><li>嫌々ながらでもやっているうちに習慣になってくるとワークフローが洗練していく</li><li>人間の運用を変えていくなにかは普遍的な価値またはビジネスチャンスがある</li></ul></li><li>調子の悪いときにどうやって早く脱却するかが大事<ul><li>ひとりでは言い訳を作ったり怠けてしまう</li><li>このときに他人の助けがいるのではないか？<ul><li>話しを聞いてもらうだけでも前へ進むきっかけになる</li></ul></li></ul></li></ul></li></ul><h2 id=go-の結合テスト向けカバレッジ計測の考察>go の結合テスト向けカバレッジ計測の考察</h2><p>以前リリースパーティーで go 1.20 で結合テスト向けのカバレッジ計測の機能が入ったことを聞いていた。次のブログ記事でやり方が紹介されている。</p><ul><li><a href=https://go.dev/blog/integration-test-coverage>Code coverage for Go integration tests</a></li><li><a href=https://netdevops.me/2023/test-coverage-for-go-integration-tests/>Test coverage for Go integration tests</a></li></ul><p>将来的に結合テストを作るときにカバレッジ計測のカスタマイズを施したバイナリを使って api server を起動する仕組みにすればこの機能を使えることに気付いた。</p><p>まずは単体テストを実行して任意のディレクトリ (<code>tests/coverage</code>) にカバレッジ計測のための中間データを生成する。</p><pre tabindex=0><code>$ mkdir -p tests/coverage
$ go test -cover ./... -covermode atomic -args -test.gocoverdir=&#34;$PWD/tests/coverage&#34;
$ go tool covdata textfmt -i=./tests/coverage -o coverage.out
</code></pre><p>coverage.out がさまざまなツールの入力となる統計情報となる。例えば、このファイルを使って次のようにしてソースコードのヒートマップの html を作成できる。</p><pre tabindex=0><code>$ go tool cover -html coverage.out -o coverage.html
</code></pre><p><a href=https://github.com/nikolaydubina/go-cover-treemap>nikolaydubina/go-cover-treemap</a> を使うと treemap でカバレッジのヒートマップを確認できる。</p><pre tabindex=0><code>$ go-cover-treemap -coverprofile coverage.out &gt; treemap.svg
</code></pre><p>カバレッジ計測向けのバイナリをビルドする。そのバイナリを起動するときに環境変数 GOCOVERDIR に単体テストのカバレッジの中間データが含まれるディレクトリを指定する。</p><pre tabindex=0><code>$ go build -cover -covermode atomic -o bin/api ./cmd/api/...
$ GOCOVERDIR=&#34;$PWD/tests/coverage&#34; ./bin/api -verbose
</code></pre><p>このバイナリを使って起動した api server に対してリクエストを呼び出すことでカバレッジを計測してくれる。結合テストからバイナリ起動した api server に対してリクエストしたときに GOCOVERDIR に中間データが追加されていく。結合テストを完了したら最終的なカバレッジの統計情報を生成する。
￼</p><pre tabindex=0><code>$ go tool covdata textfmt -i=./tests/coverage -o coverage.out
</code></pre><p>textfmt のヘルプをみたら同じディレクトリじゃなくてもよいみたい。</p><pre tabindex=0><code>$ go tool covdata textfmt -help
...
Examples:

  go tool covdata textfmt -i=dir1,dir2 -o=out.txt

  	merges data from input directories dir1+dir2
  	and emits text format into file &#39;out.txt&#39;
</code></pre></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/1010/>練習場所のビル探し</a></h1><div class=post-meta><time class=post-date>2024-10-10</time></div><span class=post-tags>#<a href=/diary/tags/badminton/>badminton</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/testing/>testing</a>&nbsp;</span><div class=post-content><p>今日のバドミントン練習はリフティングを昼夜あわせて85分 (メイビスで75分、エアで10分) した。フォア持ちとバック持ちを交互に切り替えリファクタリングで398回続けられた。目標の200回を越せるようになった。</p><h2 id=バドミントンの練習場所探し>バドミントンの練習場所探し</h2><p>お昼休みに公園へ行って20分ほど軽く練習した。そのときに連続回数が198回だった。あと2回足りなかったのが悔しかったのと、夜にがんばったらできそうかなという見通しをもっていた。</p><p>夜は近所で練習場所によさそうなビルを探してまわってみた。まずは少しおしゃれな区役所のビルの軒下へ行ってみた。</p><figure><img src=/diary/img/2024/1010_bullding1.jpg></figure><p>たまたま時間帯が悪かったのか、この場所が風の通り道になっているのか、練習を始めて5分ほどやって風の影響が強くて難しそうだったのですぐに撤収した。人通りが少なく照明もよい感じなのだけど、バドミントンの練習は風が強いとどうにもできない。</p><figure><img src=/diary/img/2024/1010_bullding2.jpg></figure><p>付近を散策しながら旧居留地にある別のビルへ。従業員の通用口がやや近いところが懸念。従業員が出てきたときにこいつ何しているの？と思うかもしれない。私の視点からもややパーソナルスペース／練習スペースを狭く感じるところはある。風の影響は受けにくい構造にはなっている。ここで15分ほど練習して267回継続できた。初めて200回を超えた。その後、あまり回数が続かなくなったのでまた散策して別のビルへ。</p><figure><img src=/diary/img/2024/1010_bullding3.jpg></figure><p>ここも広くて明るくて夜は施錠しているようにみえる。ここは従業員と会うこともない。よい場所なんだけど、照明が明る過ぎて見上げたときにシャトルと照明が重なってしまうと眩しい。照明が明る過ぎても練習しにくいことに気付いた。ここでも20分ほど練習したのに200回を超えなくて次へ移動する。照明が目に入るせいかもしれない。</p><figure><img src=/diary/img/2024/1010_bullding4.jpg></figure><p>最後はホームのビルへ。他のビルで練習してみてホームのビルのよさを実感した。もっとも練習スペースが広い。そして照明を背中側にして練習するスペースも十分にある。そうすると、見上げても照明とシャトルが重なることはないので眩しくて失敗してしまう状況を避けられる。構造的に風の影響も受けにくい。ここで20分ほど練習していたら398回、266回、349回と200回超えを3回できた。</p><p>フォア持ちとバック持ちのリフティングをしていて安定的するようになってきた。うまくラケットのスィートスポットで打てば真上にシャトルが上がる。50回ぐらいならほとんど動くこともなく上げられる。だいたい100回に1-2回ぐらい、失敗してシャトルをラケットのフレームに当てたりしてシャトル操作が乱れる。ドタバタしてリカバリする。これまではそのときに焦ってしまってシャトルを落とすことが多かった。なぜ200回以上続くかというと、その稀に失敗したときのシャトル操作をリカバリできるようになってきたから。つまり5回ぐらいミスしたときにリカバリできれば200回は続くということになる。これはメイビスフィールドのシャトルを使ったときの話し。</p><p>次にエアシャトルを使って同様にリフティングをしてみると最高で50数回ぐらいしか続かない。これはラケットのフレームまたはフレーム近くのガットで弾いてしまうと、コルク部分がプラスチックなために反発せずに落としてしまったり、あらぬ方向へ飛んでいったりしてリカバリがとても難しい。つまり、ラケットコントロールをうまくやらないとエアシャトルでリフティングを継続するのはメイビスフィールドよりもずっと難しい。次の目標としてはエアシャトルで200回を越せるようにラケットコントロールの練習をするのがよいように思える。</p><h2 id=テストとビルドタグ>テストとビルドタグ</h2><p>go ではテスト用途のパッケージを <a href=https://pkg.go.dev/net/http/httptest>httptest</a> や <a href=https://pkg.go.dev/testing/iotest>iotest</a> といった、通常アプリケーションとしてパッケージを提供しているものもある。しかし、通常のパッケージにしてしまうと、アプリケーションをビルドしたときにテストコードもバイナリにも含まれてしまう。依存パッケージの管理やバイナリサイズを減らす上で不要なコードはビルド対象外になる方が望ましい。自分たちが書いたソースコードがアプリケーションに含まれることはサイズの視点では問題ないが、テスト向けの依存パッケージもアプリケーションに含まれると意図せずバイナリサイズが大きくなってしまったり、パッケージの依存解決に時間がかかったりしてしまう懸念がある。そのため、ビルドタグを用いてテスト用途のパッケージはテストのときしかビルドしないように制御する。</p><p>例えば <code>integration</code> というビルドタグを設ける。テスト用途の <code>util</code> パッケージを定義するときは次のようにソースコードを記述する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>//go:build integration
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>util</span>
</span></span></code></pre></div><p>ビルドタグを指定せずに結合テストを実行しようとすると次のようなエラーが発生する。</p><pre tabindex=0><code>$ go test ./tests/...
# example.com/tsets/mypackage
package example.com/tsets/mypackage_test
	imports example.com/tests/util: build constraints exclude all Go files in path/to/tests/util
FAIL	example.com/tests/mypackage [setup failed]
</code></pre><p>結合テストを実行するには次のように明示的にビルドタグを指定して、テスト用途のパッケージをビルドしてテストが実行されるようにしないといけない。</p><pre tabindex=0><code>$ go test -tags=integration ./tests/mypackage/...
</code></pre></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0911/>openldap スキーマの validator と go のマルチエラー制御</a></h1><div class=post-meta><time class=post-date>2024-09-11</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/testing/>testing</a>&nbsp;
#<a href=/diary/tags/ldap/>ldap</a>&nbsp;</span><div class=post-content><p>今日もメンバーのコードレビューに半日以上の時間を割いたので自分の時間をあまり取れなくて開発が進捗しなかった。</p><p>隙間時間で <a href=/diary/posts/2024/0906/>openldap スキーマの情報</a> を使って validator を実装していた。バリデーションのようなものはまとめてエラーを返せるのが望ましい。go でマルチエラーを制御する仕組みが少し前に追加されていたことを思い出した。<a href=https://future-architect.github.io/articles/20230126a/>Go 1.20 Wrapping multiple errors</a> のチュートリアル記事を読みながら openldap スキーマの validator を実装して複数のエラーを返すようにした。まだ抜け・漏れはあるかもしれないけど objectClass の validator は次のようになる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ObjectClassValidator</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>objectClassMap</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>ObjectClassDescription</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>v</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ObjectClassValidator</span>) <span style=color:#a6e22e>Validate</span>(<span style=color:#a6e22e>attr</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>][]<span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>errs</span> []<span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>objClassDescs</span> []<span style=color:#a6e22e>ObjectClassDescription</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>hasStructuralKind</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>allAttrMap</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>struct</span>{}{}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>lowerAttrNameMap</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>struct</span>{}, len(<span style=color:#a6e22e>attr</span>))
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>k</span>, <span style=color:#a6e22e>values</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>attr</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>lowerName</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>ToLower</span>(<span style=color:#a6e22e>ParseAttribute</span>(<span style=color:#a6e22e>k</span>))
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>lowerAttrNameMap</span>[<span style=color:#a6e22e>lowerName</span>] = <span style=color:#66d9ef>struct</span>{}{}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>lowerName</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;objectclass&#34;</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>objClassDescs</span> = make([]<span style=color:#a6e22e>ObjectClassDescription</span>, <span style=color:#ae81ff>0</span>, len(<span style=color:#a6e22e>values</span>))
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>objcName</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>values</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>lowerObjcName</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>ToLower</span>(<span style=color:#a6e22e>objcName</span>)
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>ocd</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>v</span>.<span style=color:#a6e22e>objectClassMap</span>[<span style=color:#a6e22e>lowerObjcName</span>]
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>msg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;&#39;%s&#39; objectClass is not defined&#34;</span>, <span style=color:#a6e22e>objcName</span>)
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>errs</span> = append(<span style=color:#a6e22e>errs</span>, <span style=color:#a6e22e>NewErrorValidation</span>(<span style=color:#a6e22e>msg</span>))
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ocd</span>.<span style=color:#a6e22e>Kind</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ocd</span>.<span style=color:#a6e22e>Kind</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>Structural</span> {
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>hasStructuralKind</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>objClassDescs</span> = append(<span style=color:#a6e22e>objClassDescs</span>, <span style=color:#a6e22e>ocd</span>)
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>mustAttr</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>ocd</span>.<span style=color:#a6e22e>GetMust</span>() {
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>allAttrMap</span>[<span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>ToLower</span>(<span style=color:#a6e22e>mustAttr</span>)] = <span style=color:#66d9ef>struct</span>{}{}
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>mayAttr</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>ocd</span>.<span style=color:#a6e22e>GetMay</span>() {
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>allAttrMap</span>[<span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>ToLower</span>(<span style=color:#a6e22e>mayAttr</span>)] = <span style=color:#66d9ef>struct</span>{}{}
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// require at least 1 structural objectClass
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>hasStructuralKind</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>errs</span> = append(<span style=color:#a6e22e>errs</span>, <span style=color:#a6e22e>NewErrorValidation</span>(<span style=color:#e6db74>&#34;no structural objectClass&#34;</span>))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// must in objectClass requires must attributes
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>ocd</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>objClassDescs</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>mustAttr</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>ocd</span>.<span style=color:#a6e22e>GetMust</span>() {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>lowerAttrNameMap</span>[<span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>ToLower</span>(<span style=color:#a6e22e>mustAttr</span>)]; !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>msg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;&#39;%s&#39; objectClass requires &#39;%s&#39;&#34;</span>, <span style=color:#a6e22e>ocd</span>.<span style=color:#a6e22e>GetName</span>(), <span style=color:#a6e22e>mustAttr</span>)
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>errs</span> = append(<span style=color:#a6e22e>errs</span>, <span style=color:#a6e22e>NewErrorValidation</span>(<span style=color:#a6e22e>msg</span>))
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// all attribute keys are allowed may/must in objectClass
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>attrName</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>lowerAttrNameMap</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>allAttrMap</span>[<span style=color:#a6e22e>attrName</span>]; !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>msg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;&#39;%s&#39; is not allowed by objectClass&#34;</span>, <span style=color:#a6e22e>attrName</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>errs</span> = append(<span style=color:#a6e22e>errs</span>, <span style=color:#a6e22e>NewErrorValidation</span>(<span style=color:#a6e22e>msg</span>))
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>Join</span>(<span style=color:#a6e22e>errs</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewObjectClassValidator</span>(
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>objectClasses</span> []<span style=color:#a6e22e>ObjectClassDescription</span>,
</span></span><span style=display:flex><span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>ObjectClassValidator</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ocm</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>ObjectClassDescription</span>, len(<span style=color:#a6e22e>objectClasses</span>))
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>v</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>objectClasses</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>n</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>v</span>.<span style=color:#a6e22e>Name</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>ocm</span>[<span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>ToLower</span>(<span style=color:#a6e22e>n</span>)] = <span style=color:#a6e22e>v</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>ObjectClassValidator</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>objectClassMap</span>: <span style=color:#a6e22e>ocm</span>,
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>次のように複数のエラーを返すテストケースを定義する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>name</span>:       <span style=color:#e6db74>&#34;multiple errors&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>objClasses</span>: <span style=color:#a6e22e>objectClasses1</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>attr</span>: <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>][]<span style=color:#66d9ef>string</span>{
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;objectClass&#34;</span>:           []<span style=color:#66d9ef>string</span>{<span style=color:#e6db74>&#34;top&#34;</span>, <span style=color:#e6db74>&#34;posixAccount&#34;</span>, <span style=color:#e6db74>&#34;myObjeClass&#34;</span>},
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;uid&#34;</span>:                   <span style=color:#66d9ef>nil</span>,
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;mail&#34;</span>:                  <span style=color:#66d9ef>nil</span>,
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;mail;lang-ja;phonetic&#34;</span>: <span style=color:#66d9ef>nil</span>,
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;employeeType;lang-ja&#34;</span>:  <span style=color:#66d9ef>nil</span>,
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;homeDirectory&#34;</span>:         <span style=color:#66d9ef>nil</span>,
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;GIDNumber&#34;</span>:             <span style=color:#66d9ef>nil</span>,
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;street&#34;</span>:                <span style=color:#66d9ef>nil</span>,
</span></span><span style=display:flex><span>	},
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>expected</span>: []<span style=color:#66d9ef>error</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>openldap</span>.<span style=color:#a6e22e>NewErrorValidation</span>(<span style=color:#e6db74>&#34;&#39;employeetype&#39; is not allowed by objectClass&#34;</span>),
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>openldap</span>.<span style=color:#a6e22e>NewErrorValidation</span>(<span style=color:#e6db74>&#34;&#39;mail&#39; is not allowed by objectClass&#34;</span>),
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>openldap</span>.<span style=color:#a6e22e>NewErrorValidation</span>(<span style=color:#e6db74>&#34;&#39;myObjeClass&#39; objectClass is not defined&#34;</span>),
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>openldap</span>.<span style=color:#a6e22e>NewErrorValidation</span>(<span style=color:#e6db74>&#34;&#39;posixAccount&#39; objectClass requires &#39;cn&#39;&#34;</span>),
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>openldap</span>.<span style=color:#a6e22e>NewErrorValidation</span>(<span style=color:#e6db74>&#34;&#39;posixAccount&#39; objectClass requires &#39;uidNumber&#39;&#34;</span>),
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>openldap</span>.<span style=color:#a6e22e>NewErrorValidation</span>(<span style=color:#e6db74>&#34;&#39;street&#39; is not allowed by objectClass&#34;</span>),
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>openldap</span>.<span style=color:#a6e22e>NewErrorValidation</span>(<span style=color:#e6db74>&#34;no structural objectClass&#34;</span>),
</span></span><span style=display:flex><span>	},
</span></span><span style=display:flex><span>},
</span></span></code></pre></div><p>テストコードで次のように返ってくる error を unwrap することで検証できる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>tt</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>tests</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>tt</span>.<span style=color:#a6e22e>name</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Parallel</span>()
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>validator</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>openldap</span>.<span style=color:#a6e22e>NewObjectClassValidator</span>(<span style=color:#a6e22e>tt</span>.<span style=color:#a6e22e>objClasses</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>validator</span>.<span style=color:#a6e22e>Validate</span>(<span style=color:#a6e22e>tt</span>.<span style=color:#a6e22e>attr</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>actual</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>err</span>.(<span style=color:#66d9ef>interface</span>{ <span style=color:#a6e22e>Unwrap</span>() []<span style=color:#66d9ef>error</span> }); <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Log</span>(<span style=color:#e6db74>&#34;\n&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>diff</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>cmp</span>.<span style=color:#a6e22e>Diff</span>(<span style=color:#a6e22e>tt</span>.<span style=color:#a6e22e>expected</span>, <span style=color:#a6e22e>actual</span>.<span style=color:#a6e22e>Unwrap</span>(), <span style=color:#a6e22e>opts</span><span style=color:#f92672>...</span>); <span style=color:#a6e22e>diff</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>diff</span>)
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0828/>集中開発の1ヶ月間</a></h1><div class=post-meta><time class=post-date>2024-08-28</time></div><span class=post-tags>#<a href=/diary/tags/project-management/>project management</a>&nbsp;
#<a href=/diary/tags/issue-management/>issue management</a>&nbsp;
#<a href=/diary/tags/testing/>testing</a>&nbsp;</span><div class=post-content><h2 id=プロジェクトの進捗報告>プロジェクトの進捗報告</h2><p>出張したときの月例報告の19回目。<a href=/diary/posts/2024/0731/>前回の進捗報告はこちら</a> 。この開発フェーズは私が経営陣へ進捗報告するものの、引き継いだマネージャーにも同席してもらって、こんな打ち合わせをしているというのを知ってもらう機会にしている。この1ヶ月間の進捗やこの開発フェーズでやろうとしていることを一通り説明して、あとはざっくばらんに経営陣と雑談するといった機会にもなった。最低限、開発のボトルネックになりそうなところは私が集中開発して解消したので見た目上はよいペースで進捗している。</p><p>進捗報告して雑談しているうちに、もうこれ以上は私がお手伝い先へ提供できる新たな価値はなさそうに思えてきた。ここからは課題管理できている issue を優先度順にひたすら fix していく、よくないところはリファクタリングする、開発の負債やボトルネックを解消していくといった、より実践的な実務が求められる。課題管理を含むプロジェクトマネジメントやチームの情報共有を改善することで開発をうまくまわしていくフェーズは十分にメンバーが実践できるようになったと思える。自身の引き出しの中身を払い出してしまって、なにも残っていないような寂しさを感じるようになった。</p><p>いまマルチブラウザ／デバイスのテストの自動化のために <a href=https://www.browserstack.com/>BrowserStack</a> というプラットフォームを評価している。まだ評価中なので採用の可否はこれから判断するところだが、採用したらコストがかかるのでその話題も経営陣に伝えてその場で議論したりしていた。おそらくこのサービスは <a href=https://www.selenium.dev/ja/documentation/grid/>Selenium Grid</a> を使っているのではないか？と推測される。うちのプロジェクトだけでなく、社内インフラとして全社共通のテスト基盤を作るという施策もあるかもしれないと話しが発散したりもした。開発においてプラットフォーム的な投資も大事だと考えられている。うちのプロダクトで作る課題管理のメトリクスに、プラットフォーム投資のための見える化ができる機能もあるとよいのかもしれないと思ったりしていた。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0824/>multipart/form-data リクエストの扱い</a></h1><div class=post-meta><time class=post-date>2024-08-24</time></div><span class=post-tags>#<a href=/diary/tags/health/>health</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/testing/>testing</a>&nbsp;</span><div class=post-content><p>9時に起きて2度寝して10時頃に起きたものの、お昼までだらだらしていた。それからオフィスへ行って溜まっていた日記をまとめて書いて、<a href=https://nigewaka.run/>逃げ上手の若君</a> をみながら作業をしていた。来週は出張の週だから事前にやっておくことがいくつかある。</p><h2 id=ストレッチ>ストレッチ</h2><p><a href=/diary/posts/2024/0817/>先週は実家へ帰っていた</a> ために2週間ぶりのストレッチになる。とはいっても、いまは運動をしているので筋肉痛もない。しかし、机に向かってデスクワークする時間が増えている分の負荷がかかっている。トレーナーさんからも腰から背中にかけて硬いと指摘された。今日は硬くなっているカラダ全体をほぐしてもらった感じだった。おかげで今後も体調よく机に向かえる。今日の開脚幅は開始前149cmで、ストレッチ後155cmと普段通りの数値だった。</p><h2 id=multipartform-data-リクエストを扱う結合テスト>multipart/form-data リクエストを扱う結合テスト</h2><p>昨日の夜に汎用のファイル操作の api を実装した。今日はその結合テストを追加してマージリクエストを作成した。multipart/form-data のリクエストを作るのはちょっと面倒くさい。go のライブラリのテストコードや stackoverflow のサンプルコードなどを調べながら自分で実装した。次のような multipart/form-data リクエストを扱う writer や buffer を生成するためのユーティリティを作る。一通りの結合テストを実装するのに3時間ほどかかった。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>createMultiPartFormData</span>(
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fileBody</span> []<span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>formField</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>,
</span></span><span style=display:flex><span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>multipart</span>.<span style=color:#a6e22e>Writer</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>Buffer</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>b</span> <span style=color:#f92672>:=</span> new(<span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>Buffer</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mw</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>multipart</span>.<span style=color:#a6e22e>NewWriter</span>(<span style=color:#a6e22e>b</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>k</span>, <span style=color:#a6e22e>v</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>formField</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fw</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>mw</span>.<span style=color:#a6e22e>CreateFormField</span>(<span style=color:#a6e22e>k</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>b</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fw</span>.<span style=color:#a6e22e>Write</span>([]byte(<span style=color:#a6e22e>v</span>)); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>b</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fw</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>mw</span>.<span style=color:#a6e22e>CreateFormFile</span>(<span style=color:#e6db74>&#34;file&#34;</span>, <span style=color:#e6db74>&#34;path/to/file&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>b</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fw</span>.<span style=color:#a6e22e>Write</span>(<span style=color:#a6e22e>fileBody</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>b</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>mw</span>.<span style=color:#a6e22e>Close</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>b</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>mw</span>, <span style=color:#a6e22e>b</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>このユーティリティを使って http リクエストのテストデータを生成するのは次のようなコードになる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>u</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>url</span>.<span style=color:#a6e22e>URL</span>{
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Scheme</span>: <span style=color:#e6db74>&#34;http&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Host</span>:   <span style=color:#e6db74>&#34;localhost&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Path</span>:   <span style=color:#a6e22e>path</span>,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>mw</span>, <span style=color:#a6e22e>body</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>createMultiPartFormData</span>(<span style=color:#a6e22e>fileBody</span>, <span style=color:#a6e22e>formField</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to create multipart form data: %s&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>NewRequest</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>MethodPost</span>, <span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>String</span>(), <span style=color:#a6e22e>body</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;http create new request error. err: %s&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>Header</span>.<span style=color:#a6e22e>Set</span>(<span style=color:#e6db74>&#34;Content-Type&#34;</span>, <span style=color:#a6e22e>mw</span>.<span style=color:#a6e22e>FormDataContentType</span>())
</span></span></code></pre></div><p>あと結合テストでファイルをアップロードすると実際にファイルシステム上に保存されてしまうのでそれらを削除するには <a href=https://pkg.go.dev/testing#T.Cleanup>Cleanup</a> を使うと簡単に後始末できた。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>TestFileUpload</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Cleanup</span>(<span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>RemoveAll</span>(<span style=color:#a6e22e>file</span>.<span style=color:#a6e22e>FilesDir</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to remove files directory: %s&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div></article><div class=pagination><div class=pagination__buttons><a href=/diary/tags/testing/page/2/ class="button next"><span class=button__text>過去の日記</span>
<span class=button__icon>→</span></a></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2024 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>