<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>mermaid on forest nook</title><link>/diary/tags/mermaid/</link><description>Recent content in mermaid on forest nook</description><generator>Hugo -- gohugo.io</generator><language>ja-jp</language><copyright>© 2021 Tetsuya Morimoto</copyright><lastBuildDate>Mon, 03 Apr 2023 11:34:18 +0900</lastBuildDate><atom:icon>/diary/favicon.ico</atom:icon><icon>/diary/favicon.ico</icon><atom:link href="/diary/tags/mermaid/index.xml" rel="self" type="application/rss+xml"/><item><title>ローカルにコンテナレジストリを構築する</title><link>/diary/posts/2023/0403/</link><pubDate>Mon, 03 Apr 2023 11:34:18 +0900</pubDate><guid>/diary/posts/2023/0403/</guid><description>出張する日は寝ないで資料を作ったりバグ修正したりして始発の新幹線の中で寝てた。寝てなくて疲れているせいか、新幹線で寝るのに慣れたのか、わりと2-3時間ぐっすり新幹線で眠れるようになってきた。普通にベッドで寝ても3時間ぐらいしか眠れないので睡眠時間はあまり変わらない。
docker registry の構築 先日の調査 の続き。Deploy a registry server に書いてあることを実際にローカルで検証した。
tls の自己証明書の作成。subjectAltName という設定をするように書いてある。
$ openssl req -newkey rsa:4096 -nodes -sha256 -keyout certs/domain.key -addext &amp;#34;subjectAltName = DNS:myhost.mydomain.example.com&amp;#34; -x509 -days 365 -out certs/domain.crt basic 認証のための htpasswd の設定。htpasswd とか懐かしいなと思いながら実行した。
$ docker run --entrypoint htpasswd httpd:2 -Bbn user1 secret1 &amp;gt;&amp;gt; dot_htpasswd $ docker run --entrypoint htpasswd httpd:2 -Bbn user2 secret2 &amp;gt;&amp;gt; dot_htpasswd docker 社が提供する oss な docker registry サーバーを使って起動する。
$ mkdir /mnt/registry # docker image を永続化する場所 $ sudo docker run -d \ --restart=always \ --name registry \ -v &amp;#34;$(pwd)&amp;#34;/auth:/auth \ -e &amp;#34;REGISTRY_AUTH=htpasswd&amp;#34; \ -e &amp;#34;REGISTRY_AUTH_HTPASSWD_REALM=Registry Realm&amp;#34; \ -e &amp;#34;REGISTRY_AUTH_HTPASSWD_PATH=/auth/dot_htpasswd&amp;#34; \ -v &amp;#34;$(pwd)&amp;#34;/certs:/certs \ -e &amp;#34;REGISTRY_HTTP_ADDR=0.</description><content>&lt;p>出張する日は寝ないで資料を作ったりバグ修正したりして始発の新幹線の中で寝てた。寝てなくて疲れているせいか、新幹線で寝るのに慣れたのか、わりと2-3時間ぐっすり新幹線で眠れるようになってきた。普通にベッドで寝ても3時間ぐらいしか眠れないので睡眠時間はあまり変わらない。&lt;/p>
&lt;h2 id="docker-registry-の構築">docker registry の構築&lt;/h2>
&lt;p>&lt;a href="/diary/diary/posts/2023/0330/#外部向けコンテナレジストリ">先日の調査&lt;/a> の続き。&lt;a href="https://docs.docker.com/registry/deploying/">Deploy a registry server&lt;/a> に書いてあることを実際にローカルで検証した。&lt;/p>
&lt;p>tls の自己証明書の作成。subjectAltName という設定をするように書いてある。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>$ openssl req -newkey rsa:4096 -nodes -sha256 -keyout certs/domain.key -addext &lt;span style="color:#e6db74">&amp;#34;subjectAltName = DNS:myhost.mydomain.example.com&amp;#34;&lt;/span> -x509 -days &lt;span style="color:#ae81ff">365&lt;/span> -out certs/domain.crt
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>basic 認証のための htpasswd の設定。htpasswd とか懐かしいなと思いながら実行した。&lt;/p>
&lt;pre tabindex="0">&lt;code class="language-bsah" data-lang="bsah">$ docker run --entrypoint htpasswd httpd:2 -Bbn user1 secret1 &amp;gt;&amp;gt; dot_htpasswd
$ docker run --entrypoint htpasswd httpd:2 -Bbn user2 secret2 &amp;gt;&amp;gt; dot_htpasswd
&lt;/code>&lt;/pre>&lt;p>docker 社が提供する oss な docker registry サーバーを使って起動する。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>$ mkdir /mnt/registry &lt;span style="color:#75715e"># docker image を永続化する場所&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ sudo docker run -d &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --restart&lt;span style="color:#f92672">=&lt;/span>always &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --name registry &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> -v &lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>pwd&lt;span style="color:#66d9ef">)&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>/auth:/auth &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> -e &lt;span style="color:#e6db74">&amp;#34;REGISTRY_AUTH=htpasswd&amp;#34;&lt;/span> &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> -e &lt;span style="color:#e6db74">&amp;#34;REGISTRY_AUTH_HTPASSWD_REALM=Registry Realm&amp;#34;&lt;/span> &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> -e &lt;span style="color:#e6db74">&amp;#34;REGISTRY_AUTH_HTPASSWD_PATH=/auth/dot_htpasswd&amp;#34;&lt;/span> &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> -v &lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>pwd&lt;span style="color:#66d9ef">)&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>/certs:/certs &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> -e &lt;span style="color:#e6db74">&amp;#34;REGISTRY_HTTP_ADDR=0.0.0.0:443&amp;#34;&lt;/span> &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> -e &lt;span style="color:#e6db74">&amp;#34;REGISTRY_HTTP_TLS_CERTIFICATE=/certs/domain.crt&amp;#34;&lt;/span> &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> -e &lt;span style="color:#e6db74">&amp;#34;REGISTRY_HTTP_TLS_KEY=/certs/domain.key&amp;#34;&lt;/span> &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> -p 8443:443 &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> -v /mnt/registry:/var/lib/registry &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> registry:2
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>これで basic 認証付きで https で通信できる docker registry サーバーができた。&lt;/p>
&lt;p>外部のマシンから dokcer login しようとすると次のようなエラーが発生する。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>$ docker login myhost.mydomain.example.com:8443
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Username: user2
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Password: ***
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Error response from daemon: Get &lt;span style="color:#e6db74">&amp;#34;https://myhost.mydomain.example.com:8443/v2/&amp;#34;&lt;/span>: x509: certificate signed by unknown authority
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;a href="https://docs.docker.com/registry/insecure/">Test an insecure registry&lt;/a> によると、自己証明書を使って外部からアクセスできるようにするためには docker client 側にさっき作った domain.crt をコピーする必要がある。&lt;/p>
&lt;p>linux だとこんな設定。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>$ cp domain.crt /etc/docker/certs.d/myhost.mydomain.example.com:8443/ca.crt
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Docker Desktop for Mac を使っている場合はこんな感じ。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-zsh" data-lang="zsh">&lt;span style="display:flex;">&lt;span>&amp;gt; security add-trusted-cert -d -r trustRoot -k ~/Library/Keychains/login.keychain path/to/certs/domain.crt
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>これで外部からも docker login して任意の docker image を push/pull できるようになる。docker registry サーバーは Let’s Encrypt をサポートしているそうなので &lt;a href="https://letsencrypt.org/how-it-works/">How It Works&lt;/a> を参照して設定すればよいと書いてあった。&lt;/p>
&lt;h2 id="mdbook-の初期設定">mdbook の初期設定&lt;/h2>
&lt;p>mdbook は新しい rust のバージョンだとビルドできなかったりするので rustup を使ってローカルに rustc をインストールするのがよいかもしれない。プラグインとしては &lt;a href="https://github.com/badboy/mdbook-mermaid">mdbook-mermaid&lt;/a> を使う。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>$ curl --proto &lt;span style="color:#e6db74">&amp;#39;=https&amp;#39;&lt;/span> --tlsv1.2 -sSf https://sh.rustup.rs | sh
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ ~/.cargo/bin/rustc --version
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ cargo install mdbook mdbook-mermaid
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>mdbook-mermaid の設定も簡単でドキュメントルート配下に mermaid の js ファイルを配置すると動いた。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>$ vi book.toml
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">[&lt;/span>preprocessor.mermaid&lt;span style="color:#f92672">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>command &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#34;mdbook-mermaid&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">[&lt;/span>output.html&lt;span style="color:#f92672">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>additional-js &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">[&lt;/span>&lt;span style="color:#e6db74">&amp;#34;mermaid.min.js&amp;#34;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;mermaid-init.js&amp;#34;&lt;/span>&lt;span style="color:#f92672">]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></content></item><item><title>デジタルノマドへの関心</title><link>/diary/posts/2022/1116/</link><pubDate>Wed, 16 Nov 2022 08:00:27 +0900</pubDate><guid>/diary/posts/2022/1116/</guid><description>0時に寝て2時に起きて6時に起きた。いまは眠れる状態に落ち着きつつある。
pandoc と mermaid charts の扱い markdown のドキュメントに mermaid で図を描く機会が増えてきた。markdown を pdf に変換するツールがあって内部的に pandoc を使っている。そのツールで pdf 変換してみたら mermaid 記法がそのままテキストで出力されたので変換するときに図に置き換えられないかを調べてみた。例えば、次のようにして markdown から html に変換できる。
$ pandoc mydoc.md -f gfm -o mydoc.html 次のように mermaid 記法がそのまま出力される。
&amp;lt;pre class=&amp;#34;mermaid&amp;#34;&amp;gt;&amp;lt;code&amp;gt;flowchart TB subgraph cr [Container Registry] repo[repository] end ... mermaid を cli ツールとして mermaid-cli がある。markdown を直接渡しても mermaid のコードブロックを検出して画像変換してくれる。複数あってもよい。これはちょっと驚いた。
$ git clone git@github.com:mermaid-js/mermaid-cli.git $ cd mermaid-cli $ yarn add @mermaid-js/mermaid-cli $ npx mmdc --version 9.1.7 $ npx mmdc -i mydoc.</description><content>&lt;p>0時に寝て2時に起きて6時に起きた。いまは眠れる状態に落ち着きつつある。&lt;/p>
&lt;h2 id="pandoc-と-mermaid-charts-の扱い">pandoc と mermaid charts の扱い&lt;/h2>
&lt;p>markdown のドキュメントに &lt;a href="https://mermaid-js.github.io/mermaid/#/">mermaid&lt;/a> で図を描く機会が増えてきた。markdown を pdf に変換するツールがあって内部的に pandoc を使っている。そのツールで pdf 変換してみたら mermaid 記法がそのままテキストで出力されたので変換するときに図に置き換えられないかを調べてみた。例えば、次のようにして markdown から html に変換できる。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>$ pandoc mydoc.md -f gfm -o mydoc.html
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>次のように mermaid 記法がそのまま出力される。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-xml" data-lang="xml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">&amp;lt;pre&lt;/span> &lt;span style="color:#a6e22e">class=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;mermaid&amp;#34;&lt;/span>&lt;span style="color:#f92672">&amp;gt;&amp;lt;code&amp;gt;&lt;/span>flowchart TB
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>subgraph cr [Container Registry]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> repo[repository]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>end
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>...
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>mermaid を cli ツールとして &lt;a href="https://github.com/mermaid-js/mermaid-cli">mermaid-cli&lt;/a> がある。markdown を直接渡しても mermaid のコードブロックを検出して画像変換してくれる。複数あってもよい。これはちょっと驚いた。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>$ git clone git@github.com:mermaid-js/mermaid-cli.git
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ cd mermaid-cli
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ yarn add @mermaid-js/mermaid-cli
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ npx mmdc --version
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>9.1.7
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ npx mmdc -i mydoc.md -o mydiagram.png
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Found &lt;span style="color:#ae81ff">2&lt;/span> mermaid charts in Markdown input
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ✅ ./mydiagram-1.png
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ✅ ./mydiagram-2.png
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>cli でできるなら何とでもなるんじゃないかともう少し調べていたら次の gist をみつけた。&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://gist.github.com/letientai299/2c974b4f5e7b05be52d369ff8693c29a">Render PDF from Markdonw that using mermaid&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>&lt;a href="https://pandoc.org/filters.html">pandoc filters&lt;/a> という仕組みがあって、pandoc の ast を操作するためのインターフェースを提供している。その仕組みを使って mermaid の変換を行う &lt;a href="https://github.com/raghur/mermaid-filter">mermaid-filter&lt;/a> を誰かが作ってくれていた。このツールをインストールして次のように pandoc を実行すると base64 でエンコードした画像を使って html に変換できた。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>$ npm i -g mermaid-filter
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ pandoc mydoc.md -F mermaid-filter -f gfm -o mydoc.html
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ vi mydoc.html
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&amp;lt;p&amp;gt;システム構成図&amp;lt;/p&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&amp;lt;p&amp;gt;&amp;lt;img src&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;data:image/png;base64,iVBORw0KGgoAAAANSU...EnAAAAAElFTkSuQmCC&amp;#34;&lt;/span> alt&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&amp;#34;&lt;/span> /&amp;gt;&amp;lt;/p&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>mermaid-cli を使うか mermaid-filter を使うかは要件や好みにもよるけど、すでにツールがあるので組み合わせれば何とかできそうというところまで確認した。&lt;/p>
&lt;h2 id="コワーキングのオンラインイベント">コワーキングのオンラインイベント&lt;/h2>
&lt;p>月例のカフーツさんのオンラインイベントに参加した。&lt;a href="/diary/diary/posts/2022/1029/#コワーキングのオンラインイベント">先月の所感はここ&lt;/a> 。いとうさんが岩手県普代村のコワーキングスペースに行ってきてそのお話しから始まった。私はまだ岩手県に行ったことすらないんやけど、めっちゃ田舎の、断崖絶壁の眺めのよい高台にある国民宿舎にコワーキングスペースがあるらしい。&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://note.com/kanzan10to9/n/n7802c47b1174">人口2500人弱の村でコワーキング運営の研修をしてきた〜ローカルコワーキングこそ地方創生の鍵〜&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>研修の講師として、いとうさんは呼ばれてワークショップをしたらしい。参加者が付箋に課題を書き出してグループワークするといった作業に不慣れで、グループ内で話しはしているものの、あまり付箋に書いてくれなかったとかぼやいていた。&lt;a href="https://www.soumu.go.jp/main_sosiki/jichi_gyousei/c-gyousei/02gyosei08_03000066.html">地域おこし協力隊&lt;/a> として19歳の隊員が参加者にいたらしい。19歳で地域おこし協力隊になれるの？といとうさんが驚いていた。どうやら年齢は自治体の募集要項次第らしく、たまたま普代村の要項が18歳以上で自治体もまさかそんな若い人がくるとは思ってなかったと19歳の隊員が活躍していたという。若いから頭の回転も速いし活発でワークショップもてきぱきとこなしていたらしい。&lt;/p>
&lt;p>先月のお仕事探しでマネージャー実績のない私を雇う会社はほぼないという現実に直面した。いまのお仕事を終えた後で、地域おこし協力隊の要件を私が満たすなら課題管理を実践する場として行ってみてもいいかもしれないなと話しを聞いていて少し思った。ソフトウェア開発に特化した課題管理しかできないというスコープの狭さが私のスキルの欠点でもある。仮に地域おこし協力隊としてなにかに役立てられるなら、そのスコープをさらに広げられる可能性も出てくる。&lt;/p>
&lt;p>それから次の記事の話題に移っていった。&lt;a href="https://nomadlist.com/">Nomad List&lt;/a> というデジタルノマド向けポータル兼 sns のようなサイトを紹介してくれた。&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://workmill.jp/jp/webzine/future-coworking-20221108/">世界のデジタルノマドが集まるサイトはホスピタリティに満ちている　テクノロジーとヒトが持ち寄る情報の力&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>試しに &lt;a href="https://nomadlist.com/kobe">kobe&lt;/a> のスコアをみてみる。現時点のランキングは1182位と低い。日本はこの2年ほどコロナ禍で鎖国していたからノマドを受け入れてないのでどの都市もランキングは下がっているらしい。ざっとみてスコアがよくないのは次の項目。神戸に住んでいる私の感覚とも合致しているのでこのスコアは一定の信頼ができると思う。神戸の大半のお店は21時までには閉まるし、スタートアップ企業なんか数えるほどしかいない。とはいえ、全体としてはスコアは良好だし世界に誇れる都市の1つとしてデジタルノマドを受け入れる器はあると思う。&lt;/p>
&lt;ul>
&lt;li>Cost&lt;/li>
&lt;li>Vulnerability to climate change&lt;/li>
&lt;li>English speaking&lt;/li>
&lt;li>Nightlife&lt;/li>
&lt;li>Free WiFi in city&lt;/li>
&lt;li>Startup Score&lt;/li>
&lt;/ul>
&lt;figure>&lt;img src="/diary/diary/img/2022/1116_nomadlist-kobe.png"/>
&lt;/figure>
&lt;p>あと &lt;a href="https://livinganywherecommons.com/base/mima/">徳島県美馬市脇町&lt;/a> の町興しのようなコワーキングやデジタルノマド向けの取り組みの話しがあって関心をもって聞いていた。徳島県なら実家から近い。こんな場所あったんやと聞いていた。このサイトで紹介されているのどけやさんというゲストハウスはいつ行っても外国人がいるといとうさんが話されていた。そう言われると本当なんやろか？と確かめに行きたくなる。たぶん実家から車で1時間もあれば行けそうな気がする。&lt;/p></content></item><item><title>ログおじさん</title><link>/diary/posts/2022/1111/</link><pubDate>Fri, 11 Nov 2022 05:14:26 +0900</pubDate><guid>/diary/posts/2022/1111/</guid><description>23時に寝て3時半に起きて眠れそうになかったからそのまま5時からオフィスで作業してた。
システム構成の検討 コンサルタントから顧客要件のヒアリングを行い、プロダクトを提供するインフラのシステム概要を mermaid で書いた。オンプレとクラウド環境のそれぞれを同じコンテナアプリケーションで動かすための構成を検討した。クラウド環境の一例として aws の構成を考えていて、https と http のプロトコル変換のようなことをするには api gateway を経由しないといけないと考えていたら、alb に証明書を設定して api gateway なくてもいけるとはらさんに教えてもらった。昔からできたそうで、なぜか私が長い間ずっと勘違いしていた。また時間があるときに自分でもやってみようと思う。
AWS Certificate Managerを使用してインターネットからELBへの通信をHTTPS化してみた Logger の再実装 プロダクトのコアな部分の実装は私がみた方がよいだろうと考えていて、そのうちの1つ Logger の設計がよくなかったので私が作り直した。といっても cybozu-go/log を使った薄いラッパーを設けただけ。チームメンバーからどこでエラーが起きているか追跡しにくいという声があったのでログ出力したところのソースコードの情報を出力しようと考えた。ググればたくさん出てくる。スタックフレームにアクセスする標準パッケージとして runtime を使うとできる。runtime.Caller と runtime.Callers は似て非なる関数のようでファイル名と行番号だけでよければ Caller を使った方がシンプルになると思う。関数名もほしかったら Callers を使ったスタックフレーム自体から取得する必要がある。
func Trace(skip int) (file string, funcName string) { pc := make([]uintptr, 15) n := runtime.Callers(skip, pc) frames := runtime.CallersFrames(pc[:n]) frame, _ := frames.Next() _file := frame.File[strings.Index(frame.File, sourceRepositoryPath)+8:] file = fmt.Sprintf(&amp;#34;%s:%d&amp;#34;, _file, frame.Line) return file, frame.</description><content>&lt;p>23時に寝て3時半に起きて眠れそうになかったからそのまま5時からオフィスで作業してた。&lt;/p>
&lt;h2 id="システム構成の検討">システム構成の検討&lt;/h2>
&lt;p>コンサルタントから顧客要件のヒアリングを行い、プロダクトを提供するインフラのシステム概要を mermaid で書いた。オンプレとクラウド環境のそれぞれを同じコンテナアプリケーションで動かすための構成を検討した。クラウド環境の一例として aws の構成を考えていて、https と http のプロトコル変換のようなことをするには api gateway を経由しないといけないと考えていたら、alb に証明書を設定して api gateway なくてもいけるとはらさんに教えてもらった。昔からできたそうで、なぜか私が長い間ずっと勘違いしていた。また時間があるときに自分でもやってみようと思う。&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://dev.classmethod.jp/articles/for-begginer-ssl-communication-by-aws-certificate-manager/">AWS Certificate Managerを使用してインターネットからELBへの通信をHTTPS化してみた&lt;/a>&lt;/li>
&lt;/ul>
&lt;h2 id="logger-の再実装">Logger の再実装&lt;/h2>
&lt;p>プロダクトのコアな部分の実装は私がみた方がよいだろうと考えていて、そのうちの1つ Logger の設計がよくなかったので私が作り直した。といっても &lt;a href="https://github.com/cybozu-go/log">cybozu-go/log&lt;/a> を使った薄いラッパーを設けただけ。チームメンバーからどこでエラーが起きているか追跡しにくいという声があったのでログ出力したところのソースコードの情報を出力しようと考えた。ググればたくさん出てくる。スタックフレームにアクセスする標準パッケージとして runtime を使うとできる。&lt;a href="https://pkg.go.dev/runtime#Caller">runtime.Caller&lt;/a> と runtime.Callers は似て非なる関数のようでファイル名と行番号だけでよければ Caller を使った方がシンプルになると思う。関数名もほしかったら Callers を使ったスタックフレーム自体から取得する必要がある。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">func&lt;/span> &lt;span style="color:#a6e22e">Trace&lt;/span>(&lt;span style="color:#a6e22e">skip&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span>) (&lt;span style="color:#a6e22e">file&lt;/span> &lt;span style="color:#66d9ef">string&lt;/span>, &lt;span style="color:#a6e22e">funcName&lt;/span> &lt;span style="color:#66d9ef">string&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">pc&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> make([]&lt;span style="color:#66d9ef">uintptr&lt;/span>, &lt;span style="color:#ae81ff">15&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">n&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#a6e22e">runtime&lt;/span>.&lt;span style="color:#a6e22e">Callers&lt;/span>(&lt;span style="color:#a6e22e">skip&lt;/span>, &lt;span style="color:#a6e22e">pc&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">frames&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#a6e22e">runtime&lt;/span>.&lt;span style="color:#a6e22e">CallersFrames&lt;/span>(&lt;span style="color:#a6e22e">pc&lt;/span>[:&lt;span style="color:#a6e22e">n&lt;/span>])
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">frame&lt;/span>, &lt;span style="color:#a6e22e">_&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#a6e22e">frames&lt;/span>.&lt;span style="color:#a6e22e">Next&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">_file&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#a6e22e">frame&lt;/span>.&lt;span style="color:#a6e22e">File&lt;/span>[&lt;span style="color:#a6e22e">strings&lt;/span>.&lt;span style="color:#a6e22e">Index&lt;/span>(&lt;span style="color:#a6e22e">frame&lt;/span>.&lt;span style="color:#a6e22e">File&lt;/span>, &lt;span style="color:#a6e22e">sourceRepositoryPath&lt;/span>)&lt;span style="color:#f92672">+&lt;/span>&lt;span style="color:#ae81ff">8&lt;/span>:]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">file&lt;/span> = &lt;span style="color:#a6e22e">fmt&lt;/span>.&lt;span style="color:#a6e22e">Sprintf&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;%s:%d&amp;#34;&lt;/span>, &lt;span style="color:#a6e22e">_file&lt;/span>, &lt;span style="color:#a6e22e">frame&lt;/span>.&lt;span style="color:#a6e22e">Line&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#a6e22e">file&lt;/span>, &lt;span style="color:#a6e22e">frame&lt;/span>.&lt;span style="color:#a6e22e">Function&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>この情報を cybozu-go/log の map に追加するようなログ関数を提供するようにした。cybozu-go/log は標準の log パッケージに足りないところだけを追加していて、そのシンプルさと拡張性の高さを私は気に入ってよく使っている。私が気に入っているのでもっと有名になってほしい。&lt;/p>
&lt;p>前のお手伝いでもログ基盤を含めて Logger を作っていて、またいまも Logger を作り直していて、気付いたら私は Logger やログ出力に一家言あるような、ログおじさんになりつつある。&lt;/p></content></item><item><title>まずは定例会議から言語化する</title><link>/diary/posts/2022/1107/</link><pubDate>Mon, 07 Nov 2022 07:42:26 +0900</pubDate><guid>/diary/posts/2022/1107/</guid><description>23時ぐらいに寝て2回ぐらい起きて7時に起きた。やっぱり家だとうまく眠れない。
mermaid の er 図 メンバーが mermaid の Entity Relationship Diagrams でデータモデルの図を書いてくれてレビューしてた。見た目もすっきりしていて、テキストも書きやすい方だと思うので印象はよかった。gitlab でもリポジトリや wiki で mermaid で書いた図を表示できた。
定例会議の進め方 マネージャーっぽいお仕事の1つとして定例会議を週に1回行う。スクラムにあるデイリースクラムのような、毎日メンバー全員を集める会議するのが私は好みではない。そんなことしなくても定例会議が週1で 1on1 が週1回ならば5日のうち2回は話すし、あと個別の打ち合わせも1-2回やれば十分に話す機会を得られると考えている。定例会議の進め方というドキュメントを一通り書いてみた。私が忘れたときに見返したり、実際にやってみてよかったこと・わるかったことを振り返りながら改善するための、基準として設けた。基準があるから改善できる。最初の1-2ヶ月ぐらいはうまく成果がでなくて悩むことも想定しつつ、過去に書いたドキュメントがそういうときの拠り所になる場合もある。</description><content>&lt;p>23時ぐらいに寝て2回ぐらい起きて7時に起きた。やっぱり家だとうまく眠れない。&lt;/p>
&lt;h2 id="mermaid-の-er-図">mermaid の er 図&lt;/h2>
&lt;p>メンバーが mermaid の &lt;a href="https://mermaid-js.github.io/mermaid/#/entityRelationshipDiagram?id=entity-relationship-diagrams">Entity Relationship Diagrams&lt;/a> でデータモデルの図を書いてくれてレビューしてた。見た目もすっきりしていて、テキストも書きやすい方だと思うので印象はよかった。gitlab でもリポジトリや wiki で mermaid で書いた図を表示できた。&lt;/p>
&lt;h2 id="定例会議の進め方">定例会議の進め方&lt;/h2>
&lt;p>マネージャーっぽいお仕事の1つとして定例会議を週に1回行う。スクラムにあるデイリースクラムのような、毎日メンバー全員を集める会議するのが私は好みではない。そんなことしなくても定例会議が週1で 1on1 が週1回ならば5日のうち2回は話すし、あと個別の打ち合わせも1-2回やれば十分に話す機会を得られると考えている。定例会議の進め方というドキュメントを一通り書いてみた。私が忘れたときに見返したり、実際にやってみてよかったこと・わるかったことを振り返りながら改善するための、基準として設けた。基準があるから改善できる。最初の1-2ヶ月ぐらいはうまく成果がでなくて悩むことも想定しつつ、過去に書いたドキュメントがそういうときの拠り所になる場合もある。&lt;/p></content></item><item><title>資料作りと抜け・漏れ防止</title><link>/diary/posts/2022/0503/</link><pubDate>Tue, 03 May 2022 18:45:57 +0900</pubDate><guid>/diary/posts/2022/0503/</guid><description>marketplace への公開 pull request と push イベントに対応して基本機能は実装できたとみなし、v1 のタグ/ブランチを作成して marketplace に公開した。backlog と連携するカスタム action はすでにいくつかあるのだけど、pull request か push イベントのどちらかしか対応していなかったり、説明が日本語で書かれていて日本人向けしか対象としていないものしかない。グローバル向けの今後も要件次第で拡張可能なカスタム action はこれしかないと、ポジショントークも含めて言っておこう。ちょうどこみやさんも関心をもっているのでまた機会があれば使い方の説明とかやりますよと伝えた。まずは会社のメンバーに紹介してくれるらしい。使ってくれる人が増えると嬉しいなぁ。
https://github.com/marketplace/actions/backlog-github-integration-action リリース作業をしていてその内容について mermaid 記法を使って簡単なフローチャート図やシーケンス図も書いてみた。感覚的には plantuml で書くのと大差ないので github がサポートしているネットワーク効果を考えると、今後は mermaid を積極的に活用していくのもよいかもしれない。
打ち合わせ資料の作成 先日 第3期のふりかえり は行ったが、第4期の展望はできなかったので次回の打ち合わせのための資料を作った。今期も普通に業務委託をするだけではあるものの、今後のキャリアのために grpc の開発/運用経験を積む必要があることに気付いた。他人に話す機会があって、そのための資料を作ってみて、当たり前の抜け・漏れに自分自身で気付けるというのが思考の外在化のよいところと言える。誰かに指摘されればすぐ気付くことを自分自身で気付くのは意外と難しかったりする。特定技術を狙って案件を探すのはあまりうまくいかない。本来はビジネスがあって、それを実現するために技術を選ぶのであって、その逆ではないから。周りの友だちや知人に聞いてみるかなぁ。</description><content>&lt;h2 id="marketplace-への公開">marketplace への公開&lt;/h2>
&lt;p>pull request と push イベントに対応して基本機能は実装できたとみなし、v1 のタグ/ブランチを作成して marketplace に公開した。backlog と連携するカスタム action はすでにいくつかあるのだけど、pull request か push イベントのどちらかしか対応していなかったり、説明が日本語で書かれていて日本人向けしか対象としていないものしかない。グローバル向けの今後も要件次第で拡張可能なカスタム action はこれしかないと、ポジショントークも含めて言っておこう。ちょうどこみやさんも関心をもっているのでまた機会があれば使い方の説明とかやりますよと伝えた。まずは会社のメンバーに紹介してくれるらしい。使ってくれる人が増えると嬉しいなぁ。&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://github.com/marketplace/actions/backlog-github-integration-action">https://github.com/marketplace/actions/backlog-github-integration-action&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>リリース作業をしていてその内容について &lt;a href="https://github.com/mermaid-js/mermaid">mermaid&lt;/a> 記法を使って簡単なフローチャート図やシーケンス図も書いてみた。感覚的には plantuml で書くのと大差ないので github がサポートしているネットワーク効果を考えると、今後は mermaid を積極的に活用していくのもよいかもしれない。&lt;/p>
&lt;h2 id="打ち合わせ資料の作成">打ち合わせ資料の作成&lt;/h2>
&lt;p>先日 &lt;a href="/diary/diary/posts/2022/0429/#隔週の雑談">第3期のふりかえり&lt;/a> は行ったが、第4期の展望はできなかったので次回の打ち合わせのための資料を作った。今期も普通に業務委託をするだけではあるものの、今後のキャリアのために &lt;a href="https://grpc.io/">grpc&lt;/a> の開発/運用経験を積む必要があることに気付いた。他人に話す機会があって、そのための資料を作ってみて、当たり前の抜け・漏れに自分自身で気付けるというのが思考の外在化のよいところと言える。誰かに指摘されればすぐ気付くことを自分自身で気付くのは意外と難しかったりする。特定技術を狙って案件を探すのはあまりうまくいかない。本来はビジネスがあって、それを実現するために技術を選ぶのであって、その逆ではないから。周りの友だちや知人に聞いてみるかなぁ。&lt;/p></content></item></channel></rss>