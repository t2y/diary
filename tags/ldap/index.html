<!doctype html><html lang=en><head><title>Ldap :: </title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/tags/ldap/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="Ldap"><meta property="og:description" content><meta property="og:url" content="/diary/tags/ldap/"><meta property="og:site_name" content><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/tags/ldap/index.xml rel=alternate type=application/rss+xml title></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><h1>Posts for: #Ldap</h1><div class=posts><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0906/>ldap スキーマの情報を返す web api の実装</a></h1><div class=post-meta><time class=post-date>2024-09-06</time></div><span class=post-tags>#<a href=/diary/tags/ldap/>ldap</a>&nbsp;
#<a href=/diary/tags/programming/>programming</a>&nbsp;</span><div class=post-content><p><a href=/diary/posts/2024/0904/>一昨日</a>、<a href=/diary/posts/2024/0905/>昨日</a> と ldap スキーマの parser について調査して実装した。最終的には構文解析した値をそのまますべて返すわけではなく、実際に ui や内部の処理で必要な情報のみを使いやすい構造にして web api として実装する。マージリクエストを作成してメンバーにコードレビューをしてもらっていて、スキーマ情報だけでは足りない仕様に1つ気付いた。たとえば、次の <code>cn</code> という属性の定義には SUP (super の略語で親の定義から派生していることを表す) として <code>name</code> が定義されている。</p><pre tabindex=0><code>attributetype ( 2.5.4.41 NAME &#39;name&#39;
       EQUALITY caseIgnoreMatch
       SUBSTR caseIgnoreSubstringsMatch
       SYNTAX 1.3.6.1.4.1.1466.115.121.1.15{32768} )

attributetype ( 2.5.4.3 NAME ( &#39;cn&#39; &#39;commonName&#39; )
       DESC &#39;RFC2256: common name(s) for which the entity is known by&#39;
       SUP name )
</code></pre><p><code>cn</code> の定義には SYNTAX は定義されていないが、これは <code>name</code> の定義にある SYNTAX 1.3.6.1.4.1.1466.115.121.1.15 (<code>Directory String</code> のこと) の oid を継承するという仕様になっている。自分で SUP を調べて継承元の情報を取得するのは面倒なので構文解析した後に SUP が指定されていれば Equality, Ordering, SubStr, Syntax を親から取得するように改善した。こういうところは自前で parser を実装しているので自分たちの都合にあわせてカスタマイズしやすい。</p><p>3日もかかってしまったが、これで ldap スキーマを返す web api の実装を完了できた。いまの開発フェーズにおける、私が機能拡張する issue はこれで完了にしようと考えている。来週からはテストや qa 向けの作業にのみ注力していこうと思う。本番導入前に少しでも運用トラブルの懸念を減らす、もしくは品質をあげるための取り組みをあと3週間やってからしっかり検証をしていく。ここ1ヶ月ほど深夜までコードを書いていることが多かった。終わってみれば、面倒で厄介な issue も大半を fix した。当たり前の話だけど、四六時中ずっとコードを書いていたら気付いたら成果として積み上がってきた。マネージャーを移管したことでその分の労力を開発にまわせているのもある。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0905/>go で parser を実装してみた</a></h1><div class=post-meta><time class=post-date>2024-09-05</time></div><span class=post-tags>#<a href=/diary/tags/ldap/>ldap</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;</span><div class=post-content><p><a href=/diary/posts/2024/0904/>昨日の ldap スキーマ parser 実装</a> の続き。parser generator は使わず自分で parser を実装してみることにした。go の標準ライブラリにある <a href=https://pkg.go.dev/text/scanner>text/scanner</a> を使って字句解析をしたら、次のカスタマイズを行うことでそれっぽく token に分解できた。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Mode</span> ^= <span style=color:#a6e22e>scanner</span>.<span style=color:#a6e22e>ScanFloats</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>IsIdentRune</span> = <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>ch</span> <span style=color:#66d9ef>rune</span>, <span style=color:#a6e22e>i</span> <span style=color:#66d9ef>int</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ch</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;.&#39;</span> <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>unicode</span>.<span style=color:#a6e22e>IsLetter</span>(<span style=color:#a6e22e>ch</span>) <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>unicode</span>.<span style=color:#a6e22e>IsDigit</span>(<span style=color:#a6e22e>ch</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>しかし、text/scanner はあくまで go のソースコードを字句解析するためのツールになる。ldap スキーマの字句解析も一応は意図したように分割できたが <code>'objectClass'</code> のようなシングルクォートで文字列を囲むような構文を go のソースコードでは記述できないため、エラーをチェックすると <code>invalid char literal</code> として必ずエラーになってしまう。これでは字句解析のエラーチェックをできなくなってしまうため text/scanner の利用は断念した。</p><p>そこで <a href=https://pkg.go.dev/bufio#Scanner>bufio#Scanner</a> を使って字句解析を実装した。字句解析を行うツールを lexer または tokenizer と呼ぶ。go ではこのツールを scanner と呼ぶ慣習になってるようにみえる。分割する token をカスタマイズするには <a href=https://pkg.go.dev/bufio#SplitFunc>SplitFunc</a> を定義する。ldap スキーマの字句解析は次のように定義できた。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>singleQuote</span> <span style=color:#66d9ef>byte</span> = <span style=color:#e6db74>&#39;\&#39;&#39;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>tokenize</span>(
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>data</span> []<span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>atEOF</span> <span style=color:#66d9ef>bool</span>,
</span></span><span style=display:flex><span>) (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>advance</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>token</span> []<span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>,
</span></span><span style=display:flex><span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>advance</span>, <span style=color:#a6e22e>token</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>bufio</span>.<span style=color:#a6e22e>ScanWords</span>(<span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>atEOF</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>token</span>) &gt; <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>token</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>==</span> <span style=color:#a6e22e>singleQuote</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>since</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>data</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>!=</span> <span style=color:#a6e22e>singleQuote</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>since</span> = <span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>IndexByte</span>(<span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>singleQuote</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>IndexByte</span>(<span style=color:#a6e22e>data</span>[<span style=color:#a6e22e>since</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>:], <span style=color:#a6e22e>singleQuote</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>bufio</span>.<span style=color:#a6e22e>ErrFinalToken</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>pos</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>since</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>pos</span>, <span style=color:#a6e22e>data</span>[<span style=color:#a6e22e>since</span>:<span style=color:#a6e22e>pos</span>], <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewScanner</span>(<span style=color:#a6e22e>src</span> <span style=color:#66d9ef>string</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>bufio</span>.<span style=color:#a6e22e>Scanner</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bufio</span>.<span style=color:#a6e22e>NewScanner</span>(<span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>NewReader</span>(<span style=color:#a6e22e>src</span>))
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Split</span>(<span style=color:#a6e22e>tokenize</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>s</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>次のような ldap スキーマの文字列は、</p><p><code>( 2.5.4.0 NAME 'objectClass' DESC 'RFC4512: object classes of the entity' EQUALITY objectIdentifierMatch SYNTAX 1.3.6.1.4.1.1466.115.121.1.38 )</code></p><p>次のように token として分割される。</p><pre tabindex=0><code>(
2.5.4.0
NAME
&#39;objectClass&#39;
DESC
&#39;RFC4512: object classes of the entity&#39;
EQUALITY
objectIdentifierMatch
SYNTAX
1.3.6.1.4.1.1466.115.121.1.38
)
</code></pre><p>あとはこれらの token から構文解析を行う parser を実装するだけ。AttributeTypeDescription の文法は次になる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-abnf data-lang=abnf><span style=display:flex><span><span style=color:#a6e22e>AttributeTypeDescription</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>&#34;(&#34;</span> <span style=color:#a6e22e>whsp</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>numericoid</span> <span style=color:#a6e22e>whsp</span>              <span style=color:#75715e>; AttributeType identifier</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;NAME&#34;</span> <span style=color:#a6e22e>qdescrs</span> ]             <span style=color:#75715e>; name used in AttributeType</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;DESC&#34;</span> <span style=color:#a6e22e>qdstring</span> ]            <span style=color:#75715e>; description</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;OBSOLETE&#34;</span> <span style=color:#a6e22e>whsp</span> ]
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;SUP&#34;</span> <span style=color:#a6e22e>woid</span> ]                 <span style=color:#75715e>; derived from this other</span>
</span></span><span style=display:flex><span>                                   <span style=color:#75715e>; AttributeType</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;EQUALITY&#34;</span> <span style=color:#a6e22e>woid</span>              <span style=color:#75715e>; Matching Rule name</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;ORDERING&#34;</span> <span style=color:#a6e22e>woid</span>              <span style=color:#75715e>; Matching Rule name</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;SUBSTR&#34;</span> <span style=color:#a6e22e>woid</span> ]              <span style=color:#75715e>; Matching Rule name</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;SYNTAX&#34;</span> <span style=color:#a6e22e>whsp</span> <span style=color:#a6e22e>noidlen</span> <span style=color:#a6e22e>whsp</span> ] <span style=color:#75715e>; Syntax OID</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;SINGLE-VALUE&#34;</span> <span style=color:#a6e22e>whsp</span> ]        <span style=color:#75715e>; default multi-valued</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;COLLECTIVE&#34;</span> <span style=color:#a6e22e>whsp</span> ]          <span style=color:#75715e>; default not collective</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;NO-USER-MODIFICATION&#34;</span> <span style=color:#a6e22e>whsp</span> ]<span style=color:#75715e>; default user modifiable</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;USAGE&#34;</span> <span style=color:#a6e22e>whsp</span> <span style=color:#a6e22e>AttributeUsage</span> ]<span style=color:#75715e>; default userApplications</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>whsp</span> <span style=color:#ae81ff>&#34;)&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>AttributeUsage</span> <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>&#34;userApplications&#34;</span>     <span style=color:#f92672>/</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>&#34;directoryOperation&#34;</span>   <span style=color:#f92672>/</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>&#34;distributedOperation&#34;</span> <span style=color:#f92672>/</span> <span style=color:#75715e>; DSA-shared</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>&#34;dSAOperation&#34;</span>          <span style=color:#75715e>; DSA-specific, value depends on server</span>
</span></span></code></pre></div><p>字句解析する scanner と組み合わせて実装した parser は次のようになる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>ParseAttributeTypeDescription</span>(
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>src</span> <span style=color:#66d9ef>string</span>,
</span></span><span style=display:flex><span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>AttributeTypeDescription</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>d</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>AttributeTypeDescription</span>{}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NewScanner</span>(<span style=color:#a6e22e>src</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Scan</span>() {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>token</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Text</span>()
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>token</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>leftParenthesis</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Scan</span>() {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>OID</span> = <span style=color:#a6e22e>OID</span>{<span style=color:#a6e22e>Value</span>: <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Text</span>()}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>rightParenthesis</span>:
</span></span><span style=display:flex><span>			<span style=color:#75715e>// do nothing
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;NAME&#34;</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Scan</span>() {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Name</span> = <span style=color:#a6e22e>ParseNAME</span>(<span style=color:#a6e22e>s</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;DESC&#34;</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Scan</span>() {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Desc</span> = <span style=color:#a6e22e>Unquote</span>(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Text</span>())
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;OBSOLETE&#34;</span>:
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Obsolete</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;SUP&#34;</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Scan</span>() {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Sup</span> = <span style=color:#a6e22e>NewWOID</span>(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Text</span>())
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;EQUALITY&#34;</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Scan</span>() {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Equality</span> = <span style=color:#a6e22e>NewWOID</span>(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Text</span>())
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;ORDERING&#34;</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Scan</span>() {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Ordering</span> = <span style=color:#a6e22e>NewWOID</span>(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Text</span>())
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;SUBSTR&#34;</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Scan</span>() {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>SubStr</span> = <span style=color:#a6e22e>NewWOID</span>(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Text</span>())
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;SYNTAX&#34;</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Scan</span>() {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Syntax</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>ParseNOIDLen</span>(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Text</span>())
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to parse SYNTAX: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;SINGLE-VALUE&#34;</span>:
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>SingleValue</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;COLLECTIVE&#34;</span>:
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Collective</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;NO-USER-MODIFICATION&#34;</span>:
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>NoUserModification</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;USAGE&#34;</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Scan</span>() {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>usage</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>GetAttributeTypeUsage</span>(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Text</span>())
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Usage</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>usage</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>HasPrefix</span>(<span style=color:#a6e22e>token</span>, <span style=color:#e6db74>&#34;X-&#34;</span>) {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Scan</span>() {
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Extension</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>						<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Extension</span> = make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>][]<span style=color:#66d9ef>string</span>)
</span></span><span style=display:flex><span>					}
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Extension</span>[<span style=color:#a6e22e>token</span>] = <span style=color:#a6e22e>ParseQuotedStrings</span>(<span style=color:#a6e22e>s</span>)
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>slog</span>.<span style=color:#a6e22e>Warn</span>(<span style=color:#e6db74>&#34;unsupported&#34;</span>, <span style=color:#e6db74>&#34;token&#34;</span>, <span style=color:#a6e22e>token</span>, <span style=color:#e6db74>&#34;oid&#34;</span>, <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>OID</span>, <span style=color:#e6db74>&#34;name&#34;</span>, <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Name</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Err</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to scan: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>d</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>昨日の調査で go 製の parser generator をあまりみつけられなかったことに気付いた。その理由を理解できた。go で初めて parser を実装してみて簡単に実装できることに気付いた。標準ライブラリにある text/scanner や bufio#Scanner を使うと簡単に字句解析できるため、自分で parser を実装する労力が小さい。したがって parser generator を使って実装するよりも、自分で parser を実装することを選ぶ開発者が多いのではないかと推測する。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0904/>openldap スキーマと parser generator</a></h1><div class=post-meta><time class=post-date>2024-09-04</time></div><span class=post-tags>#<a href=/diary/tags/ldap/>ldap</a>&nbsp;
#<a href=/diary/tags/programming/>programming</a>&nbsp;
#<a href=/diary/tags/meta-programming/>meta programming</a>&nbsp;</span><div class=post-content><p>この開発フェーズではあまり機能拡張を行わない方針としているが、できればやっておいた方がよい機能拡張の1つに openldap サーバーから ldap スキーマを取得する処理がある。ちょうどいま若いメンバーに実装してもらっている大きな機能のバリデーションにも ldap スキーマの情報があると便利そうなので私が対応することに決めた。</p><p>openldap サーバーで管理している ldap スキーマの定義は openldap サーバーの <a href=https://www.openldap.org/doc/admin26/schema.html>Schema Specification</a> と <a href=https://www.openldap.org/doc/admin25/schema.html>rfc 4512</a> の2つをみると仕様がわかる。たとえば、次のように AttributeTypeDescription というスキーマの定義は <a href=https://en.wikipedia.org/wiki/Augmented_Backus%E2%80%93Naur_form>Augmented Backus–Naur form (abnf)</a> という記法で定義されている。rfc などのネットワークプロトコルの世界では abnf のフォーマットで仕様を説明することが多いらしい。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-abnf data-lang=abnf><span style=display:flex><span><span style=color:#a6e22e>AttributeTypeDescription</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>&#34;(&#34;</span> <span style=color:#a6e22e>whsp</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>numericoid</span> <span style=color:#a6e22e>whsp</span>              <span style=color:#75715e>; AttributeType identifier</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;NAME&#34;</span> <span style=color:#a6e22e>qdescrs</span> ]             <span style=color:#75715e>; name used in AttributeType</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;DESC&#34;</span> <span style=color:#a6e22e>qdstring</span> ]            <span style=color:#75715e>; description</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;OBSOLETE&#34;</span> <span style=color:#a6e22e>whsp</span> ]
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;SUP&#34;</span> <span style=color:#a6e22e>woid</span> ]                 <span style=color:#75715e>; derived from this other</span>
</span></span><span style=display:flex><span>                                   <span style=color:#75715e>; AttributeType</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;EQUALITY&#34;</span> <span style=color:#a6e22e>woid</span>              <span style=color:#75715e>; Matching Rule name</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;ORDERING&#34;</span> <span style=color:#a6e22e>woid</span>              <span style=color:#75715e>; Matching Rule name</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;SUBSTR&#34;</span> <span style=color:#a6e22e>woid</span> ]              <span style=color:#75715e>; Matching Rule name</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;SYNTAX&#34;</span> <span style=color:#a6e22e>whsp</span> <span style=color:#a6e22e>noidlen</span> <span style=color:#a6e22e>whsp</span> ] <span style=color:#75715e>; Syntax OID</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;SINGLE-VALUE&#34;</span> <span style=color:#a6e22e>whsp</span> ]        <span style=color:#75715e>; default multi-valued</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;COLLECTIVE&#34;</span> <span style=color:#a6e22e>whsp</span> ]          <span style=color:#75715e>; default not collective</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;NO-USER-MODIFICATION&#34;</span> <span style=color:#a6e22e>whsp</span> ]<span style=color:#75715e>; default user modifiable</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;USAGE&#34;</span> <span style=color:#a6e22e>whsp</span> <span style=color:#a6e22e>AttributeUsage</span> ]<span style=color:#75715e>; default userApplications</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>whsp</span> <span style=color:#ae81ff>&#34;)&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>AttributeUsage</span> <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>&#34;userApplications&#34;</span>     <span style=color:#f92672>/</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>&#34;directoryOperation&#34;</span>   <span style=color:#f92672>/</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>&#34;distributedOperation&#34;</span> <span style=color:#f92672>/</span> <span style=color:#75715e>; DSA-shared</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>&#34;dSAOperation&#34;</span>          <span style=color:#75715e>; DSA-specific, value depends on server</span>
</span></span></code></pre></div><p>openldap サーバーに対して ldap スキーマを取得する方法は <a href=https://www.openldap.org/faq/data/cache/1366.html>How can I fetch schema information from the server?</a> の faq に書いてある。search base に対してサブスキーマサブエントリを返す dn を取得する。openldap サーバーの場合 ldap の root ツリーに対応するのは <code>cn=Subschema</code> がデフォルトとなる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ldapsearch -H ldap://localhost -x -LLL -b dc<span style=color:#f92672>=</span>example,dc<span style=color:#f92672>=</span>com -s base subschemaSubentry
</span></span><span style=display:flex><span>dn: dc<span style=color:#f92672>=</span>example,dc<span style=color:#f92672>=</span>com
</span></span><span style=display:flex><span>subschemaSubentry: cn<span style=color:#f92672>=</span>Subschema
</span></span></code></pre></div><p>この dn にスキーマ情報の属性が格納されているのでそれらを取得する。このスキーマ情報は operational attributes として管理されているので <code>+</code> という記号が operational attributes 属性群をまとめて取得するキーワードになっている。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ldapsearch -x -LLL -b cn<span style=color:#f92672>=</span>Subschema -s base <span style=color:#e6db74>&#39;(objectClass=subschema)&#39;</span> +
</span></span></code></pre></div><p>これでスキーマ情報を取得できる。先に書いた AttributeTypeDescription の実際のスキーマ情報は次のような内容になる。こういったスキーマのテキスト情報をたくさん取得できる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-abnf data-lang=abnf><span style=display:flex><span>( <span style=color:#f92672>2</span>.<span style=color:#f92672>5</span>.<span style=color:#f92672>4</span>.<span style=color:#f92672>0</span> <span style=color:#a6e22e>NAME</span> &#39;<span style=color:#a6e22e>objectClass</span>&#39; <span style=color:#a6e22e>DESC</span> &#39;<span style=color:#a6e22e>RFC4512</span>: <span style=color:#a6e22e>object</span> <span style=color:#a6e22e>classes</span> <span style=color:#a6e22e>of</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>entity</span>&#39; <span style=color:#a6e22e>EQUALITY</span> <span style=color:#a6e22e>objectIdentifierMatch</span> <span style=color:#a6e22e>SYNTAX</span> <span style=color:#f92672>1</span>.<span style=color:#f92672>3</span>.<span style=color:#f92672>6</span>.<span style=color:#f92672>1</span>.<span style=color:#f92672>4</span>.<span style=color:#f92672>1</span>.<span style=color:#f92672>1466</span>.<span style=color:#f92672>115</span>.<span style=color:#f92672>121</span>.<span style=color:#f92672>1</span>.<span style=color:#f92672>38</span> )
</span></span></code></pre></div><h2 id=go-の-parser-generator-調査>go の parser generator 調査</h2><p>この手のものは abnf から parser をコード生成するのが一般的なやり方かな？と、まずは go で使えそうな parser generator について調べてみた。意外と go 製の parser generator はみつからなかった。私が発見できたのは次の3つぐらい。</p><ul><li><a href=https://pkg.go.dev/golang.org/x/tools/cmd/goyacc>golang.org/x/tools/cmd/goyacc</a></li><li><a href=https://github.com/goccmack/gocc>goccmack/gocc</a></li><li><a href=https://github.com/antlr4-go/antlr>antlr4-go/antlr</a></li></ul><p>最後の antlr は java 製のツールだけれども、go のソースコードを出力できるので go 実装の parser をコード生成できるという意図で対象としている。goyacc は abnf の文法を yacc に変換しないといけない。<a href=https://github.com/yinyin/go-ldap-schema-parser/blob/master/parser.y>yacc で実装した ldap スキーマの parser</a> を公開しているのもみかけたが、yacc は違うなと思って除外した。antlr も abnf から専用の文法に変換しないといけないから不採用にした。</p><p>それで消去法的に bnf (ebnf) を扱える gocc で parser をコード生成できないかを調査してみた。しかし、半日ほど bnf を書いて実際にコード生成してみて不採用とした。ebnf の options 記法として <code>[...]</code> に gocc が対応していないようにみえた。この記法がないと ldap スキーマの文法定義が煩雑になる。<a href=https://github.com/goccmack/gocc/issues/21#issuecomment-216398402>issue のコメント</a> をみると、lexer は対応したが、parser は対応していないといったコメントがある。コード生成しようとするとエラーになるので未対応なのかもしれない。bnf でこの options 記法相当のものを自分で文法定義すると、1つ2つなら簡単に変換できるが、数個の組み合わせがあると途端に文法の複雑さが大きくなるように思える。abnf から bnf に変換する過程で文法が複雑になってしまうとその後の保守ができなくなる懸念が生じるので断念した。</p><p>今回の gocc の採用は却下したが、軽く触ってみて gocc 自体の感触はよかった。シンプルな bnf で表現できるものであれば機会があれば採用してもよいと思える。<a href=https://github.com/goccmack/gocc/tree/master/example>gocc example</a> をみればわかるが、bnf を書きながら単体テストのコードを実行して動作検証を小さく簡潔にできる。これは parser のコード生成の開発サイクルは速くできそうに感じた。こういう小さく単体で動くツールは好み。</p><p>最終的な結論としては parser generator は使わず、自前で parser を実装することを決めた。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0903/>case-insensitive という古くて厄介な問題</a></h1><div class=post-meta><time class=post-date>2024-09-03</time></div><span class=post-tags>#<a href=/diary/tags/ldap/>ldap</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;
#<a href=/diary/tags/refactoring/>refactoring</a>&nbsp;</span><div class=post-content><h2 id=casemap-によるリファクタリング>casemap によるリファクタリング</h2><p>ldap プロトコル (v3) は <a href=https://datatracker.ietf.org/doc/html/rfc2251>rfc 2251</a> で定義されていて属性へのアクセスは case-insensitive (大文字小文字を区別しない) に扱うという仕様になっている。</p><p>ldap サーバーへの問い合わせや検索は case-insensitive となるため、ldap エントリーを扱う他システムの処理もすべて case-insensitive にしないと整合性が取れなくて混乱する。これは利用者だけでなく開発者も同様であり、一部が case-insensitive なのに、一部を case-sensitive (大文字小文字を区別する) にすると、比較処理がマッチしたりしなかったりという混乱を生じる。そういう面倒くさい issue が過去にいくつか散見されてきた。この問題は場当たり的な修正ではなく、本質的な対応が求められた。</p><p>結論としては、すべてを case-insensitive に扱う必要があって、そのためにキーを case-insensitive として扱う map like なデータ構造を実装した。オリジナルのキー情報も保持しつつ、case-insensitive にアクセスできるよう小文字変換しておいた名前変換テーブルを内部にもつ。最初からこういったデータ構造を定義しておけば開発時に混乱は起きないが、こういうものは後になってわかってくる。うちは1年半経ってからこの問題の本質を理解した。そのため、関連する処理のインターフェースを見直して置き換えることになった。こういうリファクタリングは時間がかかる割に成果も地味なので労力に対して評価されないことが多い。私もやっていてあまり楽しくはないが、こういうところをきっちり作ると品質に寄与するのを経験的に知っている。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>CaseMap</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>keyValue</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>][]<span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>nameConv</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>CaseMap</span>) <span style=color:#a6e22e>String</span>() <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;%v&#34;</span>, <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>keyValue</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>CaseMap</span>) <span style=color:#a6e22e>Values</span>(<span style=color:#a6e22e>name</span> <span style=color:#66d9ef>string</span>) []<span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>origName</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>nameConv</span>[<span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>ToLower</span>(<span style=color:#a6e22e>name</span>)]
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>values</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>keyValue</span>[<span style=color:#a6e22e>origName</span>]
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>values</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>CaseMap</span>) <span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>name</span> <span style=color:#66d9ef>string</span>) ([]<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>bool</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>origName</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>nameConv</span>[<span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>ToLower</span>(<span style=color:#a6e22e>name</span>)]
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>values</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>keyValue</span>[<span style=color:#a6e22e>origName</span>]
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>values</span>, <span style=color:#a6e22e>ok</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>CaseMap</span>) <span style=color:#a6e22e>Set</span>(<span style=color:#a6e22e>name</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>values</span> []<span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>keyValue</span>[<span style=color:#a6e22e>name</span>] = <span style=color:#a6e22e>values</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>nameConv</span>[<span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>ToLower</span>(<span style=color:#a6e22e>name</span>)] = <span style=color:#a6e22e>name</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>CaseMap</span>) <span style=color:#a6e22e>Len</span>() <span style=color:#66d9ef>int</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> len(<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>keyValue</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>CaseMap</span>) <span style=color:#a6e22e>Iter</span>() <span style=color:#a6e22e>iter</span>.<span style=color:#a6e22e>Seq2</span>[<span style=color:#66d9ef>string</span>, []<span style=color:#66d9ef>string</span>] {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>yield</span> <span style=color:#66d9ef>func</span>(<span style=color:#66d9ef>string</span>, []<span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>bool</span>) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>k</span>, <span style=color:#a6e22e>v</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>keyValue</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>yield</span>(<span style=color:#a6e22e>k</span>, <span style=color:#a6e22e>v</span>) {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>CaseName</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Original</span>  <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>LowerName</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>CaseMap</span>) <span style=color:#a6e22e>IterWithLower</span>() <span style=color:#a6e22e>iter</span>.<span style=color:#a6e22e>Seq2</span>[<span style=color:#a6e22e>CaseName</span>, []<span style=color:#66d9ef>string</span>] {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>yield</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>CaseName</span>, []<span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>bool</span>) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>lowerName</span>, <span style=color:#a6e22e>origName</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>nameConv</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>name</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>CaseName</span>{
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>Original</span>:  <span style=color:#a6e22e>origName</span>,
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>LowerName</span>: <span style=color:#a6e22e>lowerName</span>,
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>yield</span>(<span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>keyValue</span>[<span style=color:#a6e22e>origName</span>]) {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>CaseMap</span>) <span style=color:#a6e22e>ToMap</span>() <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>][]<span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>keyValue</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>length</span> <span style=color:#66d9ef>int</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>CaseMap</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>CaseMap</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>keyValue</span>: make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>][]<span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>length</span>),
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>nameConv</span>: make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>length</span>),
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewFrom</span>(<span style=color:#a6e22e>attr</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>][]<span style=color:#66d9ef>string</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>CaseMap</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>m</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>New</span>(len(<span style=color:#a6e22e>attr</span>))
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>k</span>, <span style=color:#a6e22e>v</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>attr</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>Set</span>(<span style=color:#a6e22e>k</span>, <span style=color:#a6e22e>v</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>m</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0425/>よく働きよく動く</a></h1><div class=post-meta><time class=post-date>2024-04-25</time></div><span class=post-tags>#<a href=/diary/tags/ldap/>ldap</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;
#<a href=/diary/tags/health/>health</a>&nbsp;
#<a href=/diary/tags/exercise/>exercise</a>&nbsp;</span><div class=post-content><p>今日の運動は腕立て,スクワット,縄跳び(両足跳),散歩をした。統計を <a href="https://docs.google.com/spreadsheets/d/1bg85QtM-LciUgey8I79uI7vW2PEwsP6TVdeIRVkACBg/edit?usp=sharing">運動の記録</a> にまとめる。</p><h2 id=ou-エントリーの更新対応>ou エントリーの更新対応</h2><p>ここ2週間ほどずっと、お仕事のある機能開発で <a href=/diary/posts/2024/0422/>テンパった開発状況</a> でやってきたものがようやく終わった。私は自社の経営だったり、プロジェクトのマネージャーだったりで、普通の開発メンバーのような集中した開発を時間的にできないものの、それでも私が1つの機能に2週間もかける開発はそうそうない。想定以上にこの対応のために、扱う LDAP エントリーのデータ定義や既存システムの実装変更を余儀なくされた。逆に言えば、既存の実装にそういった考慮が当初の設計に足りなかったと言える。この改修において ID 連携におけるノウハウをメンバーと共有したとも言える。</p><p>運用視点からは出来て当然の、しかし、開発視点からは厄介な仕様変更の開発を完了できた。いまの時点では完璧に作ったので将来的な拡張も含めて、さまざまな要件に対応できる設計になったと思う。自画自賛だが、時間をかけた分のよいものができたと思う。</p><h2 id=みなとのもりの運動>みなとのもりの運動</h2><p>今週の前半は雨降りだったり、雨が断続的に降ったりやんだりでお出掛けできなかった。お仕事も一区切りついた開放感と久しぶりによい天気だったのもあって <a href=https://kobe-machiguide.com/park/minatonomori-park/>みなとのもり公園</a> へ行って縄跳びしてきた。運動できない日々が続いて体力を回復していたせいか、15分間のワークアウトで過去最高の 1113 回となった。前回よりも大きく回数が増えたので、もしかしたら100ほど計測ミスがあるのかもしれない。いまの目標としては15分間で最低800回跳ぶことを想定している。跳んでいるうちにカラダが慣れてきて、ミスしなくなったり、フロー状態に入って速く巧く跳べて回数が増えたりする。</p><p>縄跳びの前後にストレッチをできるよう、大きめのレジャーシートも買った。100円ショップなどで売っているレジャーシートに比べたら少し厚手になる。折り畳んで持ち運びできるのがいいなと思って購入した。公園へ持っていくのに便利。1人なら完全に寝転がって広々とストレッチできる。よいと思う。</p><figure><img src=/diary/img/2024/0425_sheet.jpg></figure><p><a href=https://amzn.to/49Ur0YS target=_blank><img src=https://m.media-amazon.com/images/I/71jz9VPb9TL._AC_SX679_.jpg width=240></a></p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0401/>4月1日の月曜日</a></h1><div class=post-meta><time class=post-date>2024-04-01</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/ldap/>ldap</a>&nbsp;
#<a href=/diary/tags/project-management/>project management</a>&nbsp;
#<a href=/diary/tags/issue-management/>issue management</a>&nbsp;
#<a href=/diary/tags/team-building/>team building</a>&nbsp;</span><div class=post-content><p>23時頃に寝て4時に起きて6時に起きた。変な寝方した。私はわりと月曜日は好き。休み明けで元気だから、世の中的には逆かもしれないが。月曜日に加えて、今日は4月1日で新年度とあってさらに新鮮な気持ちになって晴れ晴れしい。</p><p>今日の運動は腹筋ローラー,腕立て,縄跳び(両足跳)をした。統計を <a href="https://docs.google.com/spreadsheets/d/1bg85QtM-LciUgey8I79uI7vW2PEwsP6TVdeIRVkACBg/edit?usp=sharing">運動の記録</a> にまとめる。</p><h2 id=go-ldap-のコントリビュート>go-ldap のコントリビュート</h2><p>過去に私がコントリビュートした非同期検索の機能のなかで context によるキャンセルと channel の操作のところで効率のよい方法を提案してくれた方がいた。私が開発していて気付かなかったところをリファクタリングした。指摘されればその通りだと思う。開発していて non-blocking な select 文を書くことに気を取られているとその認識が漏れていたといった程度のリファクタリングになる。ちょうどいま go-ldap ライブラリを使うアプリケーションのデバッグをやっていて、特定のケースにおいてブロックしてしまう現象に遭遇していて、この context と channel の select 文の扱いが参考になった。issue をあげてくれた方に感謝。</p><ul><li><a href=https://github.com/go-ldap/ldap/pull/496>Refactor the context handling with receiving an ldap response in searchAsync() #496</a></li></ul><h2 id=アウトプットがない開発者への対応>アウトプットがない開発者への対応</h2><p>お手伝い先でフルタイムの新規開発者が1ヶ月たっても機能開発の issue を1つも fix できていない。svelte で新規の一覧画面を作ってもらう、相対的に簡単な issue なのだけども1ヶ月かけてマージリクエストを出せるレベルにはなっていない。そして今日は休暇をとっている。普通の開発者の感覚として、どんな理由があろうと1ヶ月で issue を1つも fix できていない状況は異常だと思う。ほかメンバーだとそれぞれ16と8つの issue を fix している。もちろん開発者によってやっていることや取り組んでいることの複雑さが異なるため、単純に数が多ければよいというわけでもない。そして内容については私が課題管理を介して把握しているので他のメンバーの働き方になんの問題もない。どんな issue に取り組んでいても1週間に1つも fix できないという状況にはなっていない。1ヶ月かけて開発の issue を1つも fix できないというのがどれだけ異常な状況かはわかると思う。明日から出張で経営陣と進捗について話すときに大きな問題の1つとして共有して対策を検討する必要がある。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0215/>致命的バグをみつけた</a></h1><div class=post-meta><time class=post-date>2024-02-15</time></div><span class=post-tags>#<a href=/diary/tags/ldap/>ldap</a>&nbsp;
#<a href=/diary/tags/debug/>debug</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;
#<a href=/diary/tags/tax/>tax</a>&nbsp;</span><div class=post-content><p>2時頃に寝て5時過ぎに起きた。お風呂に入るときに fitbit を外して、その後付けるの忘れて寝てしまったから睡眠時間を計測できなかった。</p><p>今日の運動はレッグレイズ(椅子),腹筋ローラー,腕立て,スクワットをした。統計を <a href="https://docs.google.com/spreadsheets/d/1bg85QtM-LciUgey8I79uI7vW2PEwsP6TVdeIRVkACBg/edit?usp=sharing">運動の記録</a> にまとめる。</p><h2 id=agent-の致命的なバグ>agent の致命的なバグ</h2><p>先週から QA テストをしていて agent の致命的なバグに気付いた。もともとあった java 製の agent から私が設計して作り直した go 製の agent になる。<a href=/diary/posts/2024/0115/#ldap-エントリーの更新リクエストをランダムに行うツール>ldap エントリーの更新リクエストのテストツール</a> を作ったことでシビアなタイミングによるバグを検出できた。</p><p>ツールを使ってテストしていて、成功するはずのリクエストが失敗して、ログを調査しながらデバッグしていた。ldap エントリーを扱う難しさの1つに、ldap サーバーはエントリー間の依存関係やデータの整合性といったものを検証しない。そういった用途はアプリケーションの役割であって、ldap プロトコルはあくまで id を管理することに特化したものという役割分担になっているのだと推測する。そうすると、(open) ldap サーバーへ登録できたエントリーが次の agent や api サーバーといったアプリケーションのレイヤーでエラーになることがある。このとき、ldap サーバーではエラーが発生していないため、直接的なエラーを検知することができなくて、デバッグや調査に時間がかかる。</p><p>agent の実装として、ユーザーエントリのストリームとグループエントリーのストリームの2つに分割して、非同期にそれぞれのエントリーを id 連携する設計にしていた。というのは、ldap エントリーにはユーザーやグループといった概念は原則として存在しない。そのエントリーがユーザーなのか、グループなのかはアプリケーションが判断している。アプリケーションの用途としてはこの2つを明確にわけないと不便なことから、ワークアラウンドもしくは実務的な解決策として検索するときのフィルターと base dn で管理するようにしていた。そして、これらをそれぞれ別のストリームとして扱うよう、私が設計していた。このことがタイミングによってはユーザーエントリーとグループエントリーに依存関係がある場合、データの整合性を保証できないことに気付いた。なぜならば、ユーザーエントリーとグループエントリーそれぞれ非同期／並行に処理されてしまうから。</p><p>結論としては、ldap サーバーからエントリーの更新の順序を保証するには1つのストリームを subscribe しないといけない。そして、ストリームから取り出したエントリーがユーザーなのか、グループなのかはアプリケーションが判別しないといけない。テストツールを作ったことでシビアなバグも検出できた。</p><h2 id=定額減税>定額減税</h2><p><a href=https://www.nta.go.jp/users/gensen/teigakugenzei/index.htm>定額減税 特設サイト</a> が公開されたらしいというニュースをあちこちでみつける。従業員の税金が安くなるので経営者としての私がなにかしないといけないと思っているけれども、まだ何をしていいのかよくわかっていない。時間をみつけて調べないといけない。税制が変わるとこういった事務手続きが突発的に入ってくるのがマイクロ法人の面倒なところ。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0212/>ホットクックのレシピを upnote で書く</a></h1><div class=post-meta><time class=post-date>2024-02-12</time></div><span class=post-tags>#<a href=/diary/tags/founding/>founding</a>&nbsp;
#<a href=/diary/tags/recipe/>recipe</a>&nbsp;
#<a href=/diary/tags/health/>health</a>&nbsp;
#<a href=/diary/tags/upnote/>upnote</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/ldap/>ldap</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;</span><div class=post-content><p>2時半に寝て５時過ぎに起きた。それから二度寝して7時に起きた。</p><p>今日の運動はレッグレイズ(椅子),腹筋ローラー,腕立て,散歩をした。統計を <a href="https://docs.google.com/spreadsheets/d/1bg85QtM-LciUgey8I79uI7vW2PEwsP6TVdeIRVkACBg/edit?usp=sharing">運動の記録</a> にまとめる。</p><h2 id=トランクルームの契約>トランクルームの契約</h2><p>家電を購入すると大きな箱が付いてきて物理的にその置き場所がない。箱を捨てるという戦略もあるが、オリジナルの箱があると引っ越しや売買／処分するときに便利なのでできれば残しておきたい。これまでデスクトップマシンの箱やオフィス備え付けの椅子などをマンションの部屋に保管したりしていたけど、家電の箱が増えてくると邪魔になってきて、トランクルームを借りることにした。面倒なのであまり調べていないが、<a href=https://spalab-chintai.uk-corp.co.jp/>スペラボ</a> というサービスの屋内型トランクルームをレンタルすることにした。0.7畳で6,450円/月(税込)になる。会社の経費だしこのぐらいの金額ならいいかと思って、朝から内見に行って問題なさそうなので即決した。</p><h2 id=ホットクックレシピの公開>ホットクックレシピの公開</h2><p>ホットクックのレシピをどこかに整理したい。スマホ上でも調理しながら簡単に確認したいとなると web よりもアプリの方がよい。そこで <a href=/diary/posts/2024/0108/#upnote-への移行>evernote から移行した upnote</a> に書くことにした。実際に調理してみて、デスクトップマシンでレシピを編集・整理して、写真はスマホアプリからアップロードするといった使い方ができる。<a href=https://help.getupnote.com/import-export-share-and-print/share-notes-via-web-link#view-shared-notes>View shared notes</a> によると、ノート単位で web 公開もできる。試しに次のレシピを公開してみた。ノートブック単位で公開設定して一覧ページがあるともっとよいが、その機能はないみたい。公開リンクを作成する一手間はあるけれど、そんなにレシピノートを書くわけでもないから気にはならない。</p><ul><li><a href=https://getupnote.com/share/notes/3ztcTpBat7RA2IpEjuoFzq1JKMf2/49d1c703-60b0-4a27-b379-0b9da98c4a8f>野菜スープ</a></li><li><a href=https://getupnote.com/share/notes/3ztcTpBat7RA2IpEjuoFzq1JKMf2/8b321682-006e-4408-ae03-2aaf112a76cc>玄米ごはん</a></li><li><a href=https://getupnote.com/share/notes/3ztcTpBat7RA2IpEjuoFzq1JKMf2/96b9c543-a134-4773-8b1e-25cd2969f2f6>豚肉のトマト煮こみ</a></li></ul><p>ホットクック調理は材料入れてボタン押したら終わりではないか？と思うかもしれない。いや、そうでもないようだ。たしかに材料を内鍋に入れてボタン押したら人間ができることは何もない。だからこそ、ボタンを押す前の過程が大事になってくる。どんな切り方をするのか、素材のサイズはどうか、初期配置はどうか。例えば、豚ロース肉の生姜焼き用を買ってきて、適当に切って3枚4枚重なった状態で投入したらそのままの状態で出来上がった。かき混ぜ棒があるからうまいこと豚肉もバラけるだろうと期待したが、ぴったりくっついているようなお肉をバラかすほどのパワーはないようだ。人間が最初からバラかした状態で内鍋に投入すると、出来上がりのときに豚肉のかたまりがなくなってよいと思う。</p><p>あと気付いたこととして、野菜もお肉も素材を少し小さめに切った方がおいしいように感じる。というのは、ホットクックは圧力鍋ほどの火力で調理しない。圧力鍋に慣れていると、少し大きめに切っても原形がなくなって溶けてしまったり、出来上がり時点で原形があっても混ぜたりしているうちに角がとれて、どんどん小さくなっていく。小さくならなくても口の中でとろけるので大きいままでも問題ない。相対的にホットクックはそこまでの火力はないから、小さめで味が染み込むような出来上がりになるため、小さめに切っても原形は保ったままで溶けてなくなってしまうことはない。これは良い悪いではなくて、それぞれの製品の特徴と言えるだろう。ホットクック調理は素材を小さめに切るというのが、いまところ、私が作ったレシピではうまくいっている。ホットクックでは、小さく切った複数の素材をほお張って食べるのがおいしい。</p><h2 id=go-ldap-への-context-導入の考察>go-ldap への context 導入の考察</h2><p>go-ldap の issue は subscribe しているので、たまたま <a href=https://github.com/go-ldap/ldap/pull/406#issuecomment-1930953422>initial cut of context support #406</a> の draft pr のコメントに気付いた。過去に context を導入しようとして途中で断念した残骸みたいな pr になっている。いまの go の api は context を受け取るのが当たり前になっているので確かにほしいというのは理解できる。</p><p>代わりに私がやってみようかとソースコードを読んでみた。オリジナルの draft pr は client の interface に <em>WithContext</em> なメソッドを追加しようというもの。go の context の扱いとしてもっとも基本的なもの。それでもよいけれど、net/http の実装はどうなっているのかを調べていたら <a href=https://pkg.go.dev/net/http@go1.22.0#Request>Request</a> 構造体のメンバーとして context を保持していることがわかった。このやり方は原則のルールに反するものだけど、context を状態として扱わず、限定的な用途にのみ使っている。これは既存の interface を変えずに context 導入をしようという意図があると推測する。この考え方でいくと、go-ldap の Request 構造体に context を保持するように変更する方が既存の API の変更を少なくして net/http の Request も同様にやっているからと説明もしやすいように思えた。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Request</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ctx is either the client or server context. It should only
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// be modified via copying the whole Request using Clone or WithContext.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// It is unexported to prevent people from using Context wrong
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// and mutating the contexts held by callers of the same request.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>今日のところは go-ldap と net/http のソースコードを読んで設計をしていた。また明日余裕があったらサンプル実装してみる。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0118/>ローカルに window server をインストールした</a></h1><div class=post-meta><time class=post-date>2024-01-18</time></div><span class=post-tags>#<a href=/diary/tags/ldap/>ldap</a>&nbsp;
#<a href=/diary/tags/cli/>cli</a>&nbsp;
#<a href=/diary/tags/virtualization/>virtualization</a>&nbsp;
#<a href=/diary/tags/windows/>windows</a>&nbsp;
#<a href=/diary/tags/active-directory/>active directory</a>&nbsp;
#<a href=/diary/tags/event/>event</a>&nbsp;</span><div class=post-content><p>1時過ぎに寝て6時半に起きた。久しぶりによく眠れた。6時半に起きてたのに8時ぐらいまでだらだらしてた。</p><p>今日の筋トレは腹筋:20x1,腕立て:15x1,スクワット20x1をした。</p><h2 id=windows-server-2022-試用版のインストール>windows server 2022 試用版のインストール</h2><p><a href=https://www.microsoft.com/ja-jp/evalcenter/evaluate-windows-server-2022>Windows Server 2022</a> の試用版が提供されていると知ったのでローカルの <a href=https://www.virtualbox.org/>VirtualBox</a> 環境にインストールしてみた。Active Directory の検証に使うのでディレクトサービスや ldaps 接続のための証明書サービスなどを設定する。メンバーがインストールして課題管理システムにメモを残してくれてあったのでそれを見ながらインストールや設定自体はすぐにできた。1つだけうまく接続できないことがあった。</p><p>ホスト os から ldapsearch で ldaps で接続しようとすると次のようなエラーになる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ldapsearch -x -H <span style=color:#e6db74>&#34;ldaps://192.168.56.101&#34;</span> -W -b <span style=color:#e6db74>&#34;CN=Users,DC=myad,DC=com&#34;</span> -D <span style=color:#e6db74>&#34;CN=Administrator,CN=Users,DC=myad,DC=com&#34;</span>
</span></span><span style=display:flex><span>ldap_sasl_bind<span style=color:#f92672>(</span>SIMPLE<span style=color:#f92672>)</span>: Can<span style=color:#960050;background-color:#1e0010>&#39;</span>t contact LDAP server <span style=color:#f92672>(</span>-1<span style=color:#f92672>)</span>
</span></span></code></pre></div><p>ldap では接続できるので tls の検証のチェックに失敗していることは自明だったが、メンバーは接続できているようにみえたので私の環境の設定が誤っているのかどうかを調べていた。2時間ぐらいデバッグしたりしながら調べてもよくわからなくて、たまたまチーム勉強会があったので終わったときにメンバーに聞いてみた。すぐに完結した。ldapsearch は <code>LDAPTLS_REQCERT</code> という環境変数で tls のリクエストの振る舞いを制御できる。次のように明示的に指定すると接続できる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ LDAPTLS_REQCERT<span style=color:#f92672>=</span>never ldapsearch -x -H <span style=color:#e6db74>&#34;ldaps://192.168.56.101&#34;</span> ...
</span></span></code></pre></div><p>この設定はいくつかの方法で設定ファイルに書いておくこともできる。メンバーが使っている環境には <code>ldap.conf</code> でこの設定を有効にしていたので ldaps 接続できていたというオチだった。私が openldap について明るくないのでこういった背景知識をもっていなくてはまっていただけだった。</p><pre tabindex=0><code>Thus the following files and variables are read, in order:
    variable     $LDAPNOINIT, and if that is not set:
    system file  /etc/openldap/ldap.conf,
    user files   $HOME/ldaprc,  $HOME/.ldaprc,  ./ldaprc,
    system file  $LDAPCONF,
    user files   $HOME/$LDAPRC, $HOME/.$LDAPRC, ./$LDAPRC,
    variables    $LDAP&lt;uppercase option name&gt;.
Settings late in the list override earlier ones.
</code></pre><h2 id=明石海峡大橋海上ウォーク>明石海峡大橋海上ウォーク</h2><p>神戸ジャーナルの記事をみかけて、そういうイベントがあるのは知っていた。</p><ul><li><a href=https://kaijo-uzushio-walk.jp/>神戸淡路鳴門自動車道 2橋ウォーク同時開催！ 明石海峡大橋海上ウォーク/大鳴門橋うずしおウォーク 令和6年3月9日(土)・10日(日)</a></li></ul><p>開発合宿の翌週だし、わざわざ行くほどでもないかとスルーしていたものの、関東から知人がわざわざ歩きに来るという話しを聞いて、せっかくの機会なので私も参加することにした。土曜日の午前中に明石海峡大橋を歩いてくる。まだ申込みが始まったばかりなので希望の時間帯を選択できると思う。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1120/>生活リズムが崩れた月曜日</a></h1><div class=post-meta><time class=post-date>2023-11-20</time></div><span class=post-tags>#<a href=/diary/tags/animation/>animation</a>&nbsp;
#<a href=/diary/tags/economy/>economy</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/ldap/>ldap</a>&nbsp;
#<a href=/diary/tags/hugo/>hugo</a>&nbsp;</span><div class=post-content><p>1時に寝て2時半に起きて5時に起きて7時に起きた。朝から昼過ぎまで寝てたのでトータルでは睡眠時間をたくさん取っているのになんか疲れている。生活のリズムを崩すのがよくないのかも。</p><h2 id=ガンダムに学ぶ経営学>ガンダムに学ぶ経営学</h2><p>教えてもらって寝る前にみたらおもしろかった。入山先生がガンダム大好きなことが伝わってくる。おもしろいのはそうだけど、まじレスすると、アニメの世界の組織や経済に学ぶというのは誤りで、当時の組織や経済のリアルを参考にして、ガンダムの世界観は作られていると推測する。だから入山先生はユーモアで盛り上げているのだと思うけれど、ガンダムから学ぶのではなく歴史から学べが正解だと思う。でも、ガンダムの世界観を知るよい番組だと思う。</p><div class=video-container><iframe src=https://www.youtube.com/embed/w7Hhimmu26c allowfullscreen title="ガンダムに学ぶ経営学 【まとめ】【テレ東経済ニュースアカデミー　GWセレクション３】"></iframe></div><h2 id=go-ldap-へのプルリクエスト>go-ldap へのプルリクエスト</h2><p>2週間ほど前に送った pr がまだレビューすらしてもらえていない。github actions のテストがいくつか落ちていて、この pr の修正によるものではないところでエラーになっている。メンテナーの1人が再実行してくれたんだけど、たくさんあるマトリックステストのどこかが落ちてまた再実行しないといけない。</p><ul><li><a href=https://github.com/go-ldap/ldap/pull/471>IsErrorAnyOf should match the given result code even if the error is wrapped #471</a></li></ul><p>それを待っている間に、テストがエラーになる本当の原因の問題を直そうと2-3日前に issue 登録していた。この issue の対応を本当は昨日やろうと思っていたのに、思いの外、寝てしまって、その後もいろいろ書きものをしていて時間を使ってしまってできていなかった。今朝からそれを片付けた。業務の一環なので日曜日にプルリクエストを送らなくてもよいのだけど、コントリビューションなので空き時間に終わらせて、業務の時間は別のことに使いたいという思いもあったりする。</p><ul><li><a href=https://github.com/go-ldap/ldap/pull/473>Fix DATA RACE as a result of changing ber&rsquo;s module global variable for fuzz tests #473</a></li></ul><p>さらに github actions のログに deprecated ワーニングが出ていたのでついでにそれも直した。</p><ul><li><a href=https://github.com/go-ldap/ldap/pull/474>Fix deprecated warning on GitHub Actions #474</a></li></ul><p>473, 474, 471 の順番にマージされていくのが望ましい。そろそろコミット権をくれたりしないかな？と思ったりもする。というのは、タイミングの問題で action の job が落ちたり、バージョン上げるだけの pr とか、自分でマージしてしまえばいいと思ったりする。</p><h2 id=hugo-で書いた記事に目次を生成する>hugo で書いた記事に目次を生成する</h2><p>お手伝い先のテックブログは hugo で運用されている。記事の目次がないなと気付いて追加してみた。hugo v0.60.0 以降のバージョンなら標準で目次生成の機能をもっている。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#f92672>aside</span>&gt;
</span></span><span style=display:flex><span>  {{ .TableOfContents }}
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>aside</span>&gt;
</span></span></code></pre></div><ul><li><a href=https://gohugo.io/content-management/toc/>Table of contents</a></li></ul><p>デフォルトはヘッダー2レベルより下の目次を生成する。レベル1も生成したい場合は config.toml に次の設定を追加する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>[<span style=color:#a6e22e>markup</span>]
</span></span><span style=display:flex><span>  [<span style=color:#a6e22e>markup</span>.<span style=color:#a6e22e>tableOfContents</span>]
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>startLevel</span> = <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>endLevel</span> = <span style=color:#ae81ff>3</span>
</span></span></code></pre></div></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1106/>考えないという傷のある現場</a></h1><div class=post-meta><time class=post-date>2023-11-06</time></div><span class=post-tags>#<a href=/diary/tags/ldap/>ldap</a>&nbsp;
#<a href=/diary/tags/communication/>communication</a>&nbsp;
#<a href=/diary/tags/team-building/>team building</a>&nbsp;</span><div class=post-content><p>2時に寝て7時半に起きた。昨日からよく寝た。また心機一転。</p><h2 id=ldap-エントリーの-crud-api>ldap エントリーの crud api</h2><p>先週から ldap クライアントや <a href=/diary/posts/2023/1102/#コネクションを共有しないプール>そのプール</a> を実装して結合テストも一通り書いていた。今日はそれらを使った crud な web api を一通り実装した。クライアント実装もテストもしっかり出来ているので後は時間の問題で1つずつ確認しながらコードを書いていくだけだった。こういう作業になると、まとまった時間があればすぐに終わる。他のメンバーのコードレビューをみたり、設計の話しをしたり、他に意識を取られてあまり自分の作業に集中できなかった。</p><h2 id=言葉が通じないもどかしさ>言葉が通じないもどかしさ</h2><p>先週「参考にして」と指示したものが「全コピー」で驚いてしまった。私がいくつか指摘したらすぐに削除し始めてさらに落胆した。自分の頭で考えて作業していないようにみえる。</p><p>開発というお仕事は自分で考えて、コードの1つ1つに明確な意図や根拠をもって書くものだ。もちろん、情報不足や設計に自信がもてなくて一時的に曖昧な実装にするときもあるけれど、それは懸念事項として把握しておくことで将来対応すればよい。基本的に追加するコードにはすべて意味がある。</p><p>他人が分からなくても自分が理解できているのなら、自分の考えを説明し、それが論理的であったり筋が通っていれば、私は自分の考えと違っていても構わない。説明できないコードを追加して、ツッコミを受けてなにも説明できない状況をみているのは本当に悲しい。</p><p>山田ズーニーさんの著書に書いてあった「考えないという傷」を思い出した。</p><ul><li><a href=https://www.1101.com/essay/2010-03-17.html>「働きたくない」というあなたへ ７</a></li></ul></div></article><div class=pagination><div class=pagination__buttons><a href=/diary/tags/ldap/page/2/ class="button next"><span class=button__text>過去の日記</span>
<span class=button__icon>→</span></a></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2024 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>