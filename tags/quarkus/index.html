<!doctype html><html lang=en><head><title>quarkus :: forest nook</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/tags/quarkus/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="quarkus"><meta property="og:description" content><meta property="og:url" content="/diary/tags/quarkus/"><meta property="og:site_name" content="forest nook"><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/tags/quarkus/index.xml rel=alternate type=application/rss+xml title="forest nook"></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><div class=posts><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0925/>quarkus のアプリ開発が楽しくなってきた</a></h1><div class=post-meta><time class=post-date>2022-09-25 (Sun.) ::</time></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/java/>java</a>&nbsp;
#<a href=/diary/tags/quarkus/>quarkus</a>&nbsp;
#<a href=/diary/tags/backlog/>backlog</a>&nbsp;</span><div class=post-content><p>4時に寝て8時に起きた。昨日は久しぶりに夜更しして quarkus の調べものをしてた。新しいものを学ぶのはおもしろい。</p><h2 id=ストレッチ>ストレッチ</h2><p>今週末は本当は実家に帰る予定だったのが、台風による雨で田んぼのコンディションがよくないので断念した。日曜日の夜、田んぼ仕事を終えて筋肉痛のところにストレッチしてもらう予定は変わってしまった。今日の開脚幅は開始前155cmで、ストレッチ後160cmだった。いつもは朝測っているのが夜になるので数値はよくなかった。とはいえ、あまり規則正しく寝てないわりには体調がよい。気候が涼しいせいかな。トレーナーさんに来週はもう10月ですよと言われて9月は過ぎさるのが早いと改めて思った。</p><h2 id=quarkus-アプリケーションと認可フロー>quarkus アプリケーションと認可フロー</h2><p>昨日の続き。お昼前ぐらいからずっと quarkus のアプリケーション開発をしていた。なんやらかんやらで3日間ずっと bolt や quarkus のソースやドキュメントを読んでいた。徐々に理解度が増えてきて、できることも増えてきて楽しくなってきた。web 系だと di に <a href=https://github.com/google/guice>google/guice</a> を使うものも多いけど、エンタープライズ系だと <a href=https://quarkus.io/guides/cdi>cdi</a> なのかなぁとか思ってた。わからんけど。以前にも cdi のドキュメントを読んで関心があった。cdi は本当によく出来ていると思う。一方で難し過ぎて、そこまでコンテキストを厳密に管理する必要があるアプリケーションもそうないのかもなぁとは思ってた。今日 quarkus でアプリケーション開発していてドキュメントを読みながらやってみたところが次になる。</p><ul><li><a href=https://quarkus.io/guides/cdi-reference>CONTEXTS AND DEPENDENCY INJECTION</a></li><li><a href=https://quarkus.io/guides/rest-client>USING THE REST CLIENT</a></li><li><a href=https://quarkus.io/guides/rest-json>WRITING JSON REST SERVICES</a></li></ul><p>だいたい雰囲気は理解できてきたので backlog の <a href=https://developer.nulab.com/docs/backlog/auth/>Authentication & Authorization</a> に書いてある oauth2 の <em>Authorization Code Grant</em> のフローを実装していた。access token の取得と refresh はできたのでこれを db に保存するのを明日以降にやってみる。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0924/>quarkus のビルド環境に手間取った</a></h1><div class=post-meta><time class=post-date>2022-09-24 (Sat.) ::</time></div><span class=post-tags>#<a href=/diary/tags/java/>java</a>&nbsp;
#<a href=/diary/tags/quarkus/>quarkus</a>&nbsp;</span><div class=post-content><p>1時に寝て7時に起きた。休みだとやっぱりだらだらしてしまうな。</p><h2 id=bolt-for-java-on-quarkus>bolt for java on quarkus</h2><p>昨日の続き。スクラッチから quarkus のアプリケーションの設定を gradle で行う。quarkus の上で slack apps としてのコマンドとイベントの振る舞いだけ確認した。</p><ul><li><a href=https://github.com/t2y/bolt-java-sample>https://github.com/t2y/bolt-java-sample</a></li></ul><p>私は新規に開発する java アプリケーションは <a href=https://gradle.org/>gradle</a> を使うようにしている。これは java のよくないところだろうけれど、言語コミュニティが提供するパッケージマネージャやビルドツールがないから複数のツールが乱立している。maven から gradle に緩やかに移行していくのかな？と私は考えていたけれど、昔からあるライブラリのビルドツールを変更するのは労力に見合うメリットがないのか、maven も依然としてずっと使われ続けていくのかもしれない。maven と gradle の両対応という保守コストは、この先しばらく java コミュニティが抱えていく保守コストと言えるのかもしれない。quarkus はさらに独自の <a href=https://quarkus.io/guides/cli-tooling>Quarkus CLI</a> というビルドツールを提供している。そのため、ビルドのための設定だけで quarkus cli, maven, gradle の3つの方法があり、ドキュメントにもそれぞれの設定方法が書いてある。これを保守する方も使う方もややこしくて大変だなぁという印象を受けた。</p><p><a href=https://quarkus.io/guides/gradle-tooling>BUILDING QUARKUS APPS WITH GRADLE</a> をみながら次の maven cli で作った gradle プロジェクトのテンプレートをみながら build.gradle の設定をした。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ mvn io.quarkus.platform:quarkus-maven-plugin:2.12.3.Final:create <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -DprojectGroupId<span style=color:#f92672>=</span>my-groupId <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -DprojectArtifactId<span style=color:#f92672>=</span>my-artifactId <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -Dextensions<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;resteasy-reactive,resteasy-reactive-jackson&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -DbuildTool<span style=color:#f92672>=</span>gradle
</span></span></code></pre></div><p>あと私は設定ファイルを yaml で管理したいので次の拡張も追加した。gradle タスクでも定義されていて次のように実行する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./gradlew addExtension --extensions<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;quarkus-config-yaml&#34;</span>
</span></span></code></pre></div><p>この cli がやっていることは基本的に dependencies に次の1行を追加するだけ。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=display:flex><span>dependencies <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  implementation <span style=color:#e6db74>&#39;io.quarkus:quarkus-config-yaml&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>設定ファイルを yaml から読み込めるようになると初期設定は次のようになる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ vi app/src/main/resources/application.yaml 
</span></span><span style=display:flex><span>quarkus:
</span></span><span style=display:flex><span>  http:
</span></span><span style=display:flex><span>    port: <span style=color:#ae81ff>3000</span>
</span></span><span style=display:flex><span>  log:
</span></span><span style=display:flex><span>    level: INFO
</span></span><span style=display:flex><span>    category:
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;com.slack.api&#34;</span>:
</span></span><span style=display:flex><span>        level: DEBUG
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;tutorial.bolt.sample&#34;</span>:
</span></span><span style=display:flex><span>        level: DEBUG
</span></span><span style=display:flex><span>  package:
</span></span><span style=display:flex><span>    type: uber-jar
</span></span></code></pre></div><p>開発サーバーは次のようにして起動する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ./gradlew quarkusDev
</span></span></code></pre></div><blockquote><p>quarkusDev enables hot deployment with background compilation, which means that when you modify your Java files or your resource files and refresh your browser these changes will automatically take effect. This works too for resource files like the configuration property file. The act of refreshing the browser triggers a scan of the workspace, and if any changes are detected the Java files are compiled, and the application is redeployed, then your request is serviced by the redeployed application. If there are any issues with compilation or deployment an error page will let you know.</p><p><a href=https://quarkus.io/guides/gradle-tooling#dev-mode>https://quarkus.io/guides/gradle-tooling#dev-mode</a></p></blockquote><p>hot deployment 機能のおかげでソースや設定ファイルを変更すると自動的に反映される。他の言語なら普通の機能かもしれないけど、java でもそういう仕組みが普通になったんだなと思って感心した。変化に付いていけない開発者のような気持ちになった。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0923/>slack apps 開発に着手</a></h1><div class=post-meta><time class=post-date>2022-09-23 (Fri.) ::</time></div><span class=post-tags>#<a href=/diary/tags/java/>java</a>&nbsp;
#<a href=/diary/tags/slack/>slack</a>&nbsp;
#<a href=/diary/tags/quarkus/>quarkus</a>&nbsp;</span><div class=post-content><p>0時に寝て6時に起きた。あまりうまく眠れなかった。</p><h2 id=bolt-for-java>bolt for java</h2><p>slack apps を開発するためのフレームワークとして <em>bolt</em> と呼ばれる高レベルのフレームワークが提供されている。このフレームワークは <em>slack sdk</em> を使って作られていて、slack apps の開発が簡単になるようにユーティリティが提供されている。<a href=https://api.slack.com/tools/bolt>The Bolt family of SDKs</a> によると、javascript, python, java 向けに提供されている。以前 bizpy でも slack アプリ開発のチュートリアルの勉強会をしたことがある。そのときは bolot for python を使っていた。</p><ul><li><a href=https://github.com/t2y/python-study/tree/master/BizPy/slack>python-study/BizPy/slack</a></li></ul><p>一度触ったことがあったので <em>bolt</em> がどういうものかはすでに知っている。その java 版を使って slack apps を作ってみようと取り組み始めた。まずはチュートリアルを一通りやってみようと次のリポジトリでやってみた。</p><ul><li><a href=https://github.com/t2y/bolt-java-sample>https://github.com/t2y/bolt-java-sample</a></li></ul><p>チュートリアルの内容を動かすだけならすぐできた。次に java の waf は何を使おうかを調べてた。<a href=https://slack.dev/java-slack-sdk/guides/supported-web-frameworks>Supported Web Frameworks</a> によると、次の4つがある。</p><ul><li>spring boot</li><li>micronaut</li><li>quarkus undertow</li><li>helidon se</li></ul><p>さらに <a href=https://github.com/slackapi/java-slack-sdk#modules>slackapi/java-slack-sdk#modules</a> をみると、次の2つも追加されている。どちらも kotlin 向けのフレームワークらしい。</p><ul><li>http4k</li><li>ktor</li></ul><p>それぞれのフレームワークの説明を読んだり、この機に kotlin をやってみることも検討してみた。長期間の保守を前提にすると、一時的に触るだけの言語を使うのもどうかな？と思うところはあってやはり java でやることにした。spring boot はお仕事でよく使っていてどういうものかを理解しているので選択するなら他の3つのどれか。</p><blockquote><p>Quarkus was created to enable Java developers to create applications for a modern, cloud-native world. Quarkus is a Kubernetes-native Java framework tailored for GraalVM and HotSpot, crafted from best-of-breed Java libraries and standards. The goal is to make Java the leading platform in Kubernetes and serverless environments while offering developers a framework to address a wider range of distributed application architectures.</p><p><a href=https://quarkus.io/about/>https://quarkus.io/about/</a></p></blockquote><p>いま kubernetes に好印象をもっていることもあり、この説明を読んで <a href=https://quarkus.io/>quarkus</a> を選択することに決めた。そんなことをつぶやいていたら、せらさんからいくつかアドバイスをいただけた。slack について何かをつぶやくと100%返信がくる (ソースは私の経験) 。感謝。</p><p><blockquote class=twitter-tweet><p lang=ja dir=ltr>そうですね。App クラス側は servlet やその他のライタイム含め、何にも依存していないので標準でアダプターがない場合にも自分で書けば任意の Web フレークワークで動かせます。 <a href="https://twitter.com/hashtag/SlackDevJP?src=hash&ref_src=twsrc%5Etfw">#SlackDevJP</a></p>&mdash; Kazuhiro Sera (瀬良) (@seratch_ja) <a href="https://twitter.com/seratch_ja/status/1573205191071240192?ref_src=twsrc%5Etfw">September 23, 2022</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script><blockquote class=twitter-tweet><p lang=ja dir=ltr>Quarkus いいですよ！ただ、GraalVM については少なくとも短期的にはサポート予定ありません。 <a href=https://t.co/0cVGgohLez>https://t.co/0cVGgohLez</a> <a href="https://twitter.com/hashtag/SlackDevJP?src=hash&ref_src=twsrc%5Etfw">#SlackDevJP</a></p>&mdash; Kazuhiro Sera (瀬良) (@seratch_ja) <a href="https://twitter.com/seratch_ja/status/1573205502808686598?ref_src=twsrc%5Etfw">September 23, 2022</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script></p><p>java アプリケーションを実行可能なバイナリにコンパイルする機能を <a href=https://www.graalvm.org/>graalvm</a> が提供している。graalvm ではこのバイナリのことを <a href=https://www.graalvm.org/22.1/reference-manual/native-image/>native image</a> と呼んでいる。quarkus は java の web アプリケーションフレームワークであり、graalvm を使って native image を作ることも考慮して設計されている。コンテナでデプロイすることを想定したフレームワークと言える。残念ながら slack sdk が使っているライブラリである gson はリフレクションを多用していて、それが graalvm とは相性が悪いだろうという話しで現時点では native image 化は難しいみたい。たしか native image でリフレクションを使うには使っている箇所を設定にすべて列挙しないといけなかった気がする。リフレクションのような動的に用いるものと静的な設定は相性が悪く、がんばれば特定のバージョンで動くものは設定できるかもしれないけど、ライブラリのようなものでバージョンアップに追随するのはしんどいという話しなのかなと思う。</p></div></article><div class=pagination><div class=pagination__buttons></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>© 2021 Tetsuya Morimoto</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>