<!doctype html><html lang=en><head><title>Network :: </title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/tags/network/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="Network"><meta property="og:description" content><meta property="og:url" content="/diary/tags/network/"><meta property="og:site_name" content><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/tags/network/index.xml rel=alternate type=application/rss+xml title></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><h1>Posts for: #Network</h1><div class=posts><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/1121/>ipv6 による疎通検証</a></h1><div class=post-meta><time class=post-date>2024-11-24</time></div><span class=post-tags>#<a href=/diary/tags/network/>network</a>&nbsp;
#<a href=/diary/tags/infrastructure/>infrastructure</a>&nbsp;</span><div class=post-content><p>今日は神戸へ帰ってきてバテバテでしんどかったのでバドミントン練習はおやすみ。出張で体調を崩してしんどい。</p><h2 id=ipv6-とリバースプロキシと-xff-ヘッダーの扱い>ipv6 とリバースプロキシと xff ヘッダーの扱い</h2><p>要件の1つに ipv6 での通信ができることという項目がある。<a href=https://ja.wikipedia.org/wiki/OSI%E5%8F%82%E7%85%A7%E3%83%A2%E3%83%87%E3%83%AB>OSI参照モデル</a> の概念から言うと ipv6 は第3層であるネットワーク層の話しになる。実際に世の中で運用されている tcp/ip のプロトコルスタックにおいてもネットワーク層の話しであり、レイヤーが異なることからアプリケーション層では影響を受けないはずではある。アプリケーション層からみたら ipv4 であろうと ipv6 であろうと、ネットワーク周りのライブラリやフレームワークが対応していれば問題ないだろうと考えていた。それ自体の認識は誤っていない。</p><p>プロキシを経由するときに <a href=https://developer.mozilla.org/ja/docs/Web/HTTP/Headers/X-Forwarded-For>X-Forwarded-For</a> (以下 xff) ヘッダーをセットすると、そのプロキシへアクセスしてきたリクエスト元の ip アドレスを保持できる。api サーバーでは xff ヘッダーを参照すれば ipv4 または ipv6 でアクセスしてきたクライアントの ip アドレスがわかる。<a href=/diary/posts/2024/0901/#x-forwarded-for-ヘッダーの制御>フレームワークの echo における対応</a> も過去に行っていた。1つ対応漏れがあって xff ヘッダーはプロキシを経由するごとに途中の ip アドレスを追加していく。原則として信頼できるネットワークのアクセス元の ip アドレスを使う。例えば、次のような xff ヘッダーを考える。</p><pre tabindex=0><code>X-Forwarded-For: 203.0.113.3, 192.0.2.5, 198.51.100.7&#34;
</code></pre><p>このとき信頼できるネットワークが 198.51.100.0/24 である場合は xff ヘッダーによるクライアントの ip アドレスは 192.0.2.5 となる。信頼できるネットワークが 192.0.2.0/24 と 198.51.100.0/24 の2つである場合は 203.0.113.3 の ip アドレスを使う。基本的には信頼できるネットワークの左側にある ip アドレスを使うと考えればよい。一方で途中経路のネットワークを知っていて信頼できるネットワークであることを設定しないと、意図したクライアントの ip アドレスを取得することはできない。</p><p>さらにリバースプロキシでアクセス制限をしたいという要件がある。docker compose を使うと通常は NAT の構成となり、コンテナネットワークのリバースプロキシ (nginx) からホスト os のリクエスト元の ip アドレスを参照できない。コンテナネットワークのゲートウェイ (172.18.0.1) からアクセスを受けたようにみえる。この振る舞い自体も正しくはあるが、調査したところ、docker の <a href=https://docs.docker.com/engine/security/rootless/>rootless</a>　モードだとリクエスト元の ip アドレスを参照できないということがわかった。次の issue によると port forwarder と呼ばれるモジュールがあり、デフォルトものから <a href=https://github.com/rootless-containers/slirp4netns>slirp4netns</a> に変更すれば参照できると次の issue で紹介されていた。</p><pre tabindex=0><code>Environment=&#34;DOCKERD_ROOTLESS_ROOTLESSKIT_PORT_DRIVER=slirp4netns&#34;
</code></pre><ul><li><a href=https://github.com/moby/moby/issues/41789>Rootless mode overwrites public IP to Docker&rsquo;s IP #41789</a><ul><li><a href=https://rootlesscontaine.rs/getting-started/docker/#changing-the-port-forwarder>Changing the port forwarder</a></li></ul></li></ul><p>実際にやってみて ipv4 の ip アドレスを参照することはできたものの ipv6 は未対応らしい。</p><ul><li><a href=https://github.com/rootless-containers/slirp4netns/issues/253>Support IPv6 port forwarding (libslirp 4.5) #253</a></li></ul><p>他のやり方も調査してコンテナネットワーク内の nginx から ipv6 の ip アドレスを参照することができなかった。要件を満たせないことからリバースプロキシをコンテナネットワークから外出しして構築することに決めた。rootless モードでなければ ipv4/ipv6 の両方を取得できるという話しもお手伝い先の同僚から聞いた。こんなところではまるとは思わなかった。</p><p>ping や curl コマンドも ipv6 対応されていてオプションを付けなくてもよいけど、ipv6 であることを明示する上では <code>-6</code> とオプションを付けてもよいかもしれない。それにしても検証するときに ipv6 アドレスを手打ちするのは煩雑なのでいちいちアドレスをコピペすることになって面倒だなと感じた。</p><pre tabindex=0><code>$ ping -6 2001:DB8:0:0:8:800:200C:417A
$ curl -s -6 &#39;http://[2001:DB8:0:0:8:800:200C:417A]:8080/api&#39;
</code></pre></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/1114/>久しぶりにコードリーティングイベントに参加</a></h1><div class=post-meta><time class=post-date>2024-11-14</time></div><span class=post-tags>#<a href=/diary/tags/event/>event</a>&nbsp;
#<a href=/diary/tags/code-reading/>code reading</a>&nbsp;
#<a href=/diary/tags/network/>network</a>&nbsp;
</span><img src=/diary/img/2024/1114_go-drink.jpg class=post-cover alt=久しぶりにコードリーティングイベントに参加 title="Cover Image"><div class=post-content><p>今日のバドミントン練習はメイビス2で壁当てを15分した。勉強会帰りで疲れていたせいか、夜遅くのせいか、あまりカラダが動かなかった。日付が変わってから <a href=/diary/posts/2024/1014/#中学校体育館の夜間開放>中学校体育館の12月予約</a> で4つ抽選申し込みをしていたが、すべて落選していた。2ヶ月続けてすべて落選したことからそうそう予約は取れないことがわかってきた。</p><p>昼間は昨日の続きで mongodb のトランザクション導入のマージリクエストをレビューしてもらって、テスト環境へデプロイして検証していた。id 連携のシステム間連携において意図した振る舞いにならなくてその調査をしていた。チーム勉強会で mongodb のトランザクション周りのいろいろをメンバーに共有した。17時前にお仕事を終えて定期歯科検診へ行ってきた。前回対応してくれたスタッフさんで「また少し痩せました？」と聞かれた。8月からだとほとんど変わっていないと思うが、今週は普段より多く運動できているのでその影響もあるのかもしれない。30分ほどですんなり終わった。</p><h2 id=コードリーティング>コードリーティング</h2><p>歯医者を終えてから <a href=https://kobego.connpass.com/event/332586/>KOBE.go #7 - コードリーディング会</a> へ行ってきた。移転したハックバーへ行くのも初めて。三ノ宮駅から10分ほど歩いた場所の、こじんまりしたバーだった。10人程度入ったらいっぱいかな。おそらく集客や家賃などを考えたら妥当なサイズと立地なのだと推測する。いまは水-日の18-23時、月・火がお休みという営業時間らしい。私が着いたときはカウンターが埋まっていたのでテーブル席で発表を聞きながらコメントしたりしていた。私以外の参加者の大半は学生さん、みんな20代の方ばかりだったと思う。kyoto.go で発表したりしていたせいか、kobe.go のスタッフさんにも名前を覚えてもらえていた。若い人がコミュニティを運営しているのはよいことだと私は考えている。年寄りの役割としてなにかしらコンテンツを提供することで協力できればと思う。</p><p>コードリーティングはおくたにさんという方が実装している gomoqt という Media over QUIC (MOQ) のサーバー／クライアントを題材とした。京都大学の学生さんで学生起業しているのかな？音声配信サービスをやりたいから moq ライブラリを開発していると話されていて、プロトコルを勉強して自前でサーバー／クライアントのライブラリを実装しようとするの、すごいなと思って聞いていた。quic のライブラリを使ってサーバー／クライアントを実装しているようにみえた。ソケット (トランスポート層) より上のレイヤーを実装すればよいならそんなに難しくはない。</p><ul><li><a href=https://www.canva.com/design/DAGWblHSGeg/iAhvEHKme9u4m6OhW_yflg/edit>発表資料: gomoqt Media over QUIC in Golang</a></li><li><a href=https://github.com/OkutaniDaichi0106/gomoqt>github: gomoqt</a></li></ul><p>私が想定するコードリーティングのイベントではなかったものの、参加者は誰も moq プロトコルを知らないので moq の背景や現状、プロトコル仕様を共有するようなイベントになっていた。それはそれで私は知らないことばかりなのでへーと思いながら聞いていた。21時半頃にはイベントも終わり、イベント告知や雑談モードになっていって、若い人たちの中におっさんがいても迷惑かなと22時前には退出した。帰る前にワンドリンク (Go という名前の柑橘系カクテル) の料金として700円を支払う。個人的にお酒を飲みながらの勉強会はあまり好きではない。気分や雰囲気でぐだぐだになる印象があって学ぶときは学び、終わってから飲みに行って雑談するといった切り替えが私は好み。バーで勉強会をするという雰囲気もあまり馴染めない。単純に狭いし暗いし椅子よくないし作業に集中しにくいという所感かな。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0901/>ぱっとしない休日</a></h1><div class=post-meta><time class=post-date>2024-09-01</time></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/network/>network</a>&nbsp;</span><div class=post-content><p>9月に入ってしまった。8月は開発者の生活を思い出すための試行錯誤の月だった。よくもわるくもかな。</p><h2 id=キャンセル料の支払い>キャンセル料の支払い</h2><p>この前の金曜日は <a href=https://www.cospa-wellness.co.jp/corp/kobefukushi-sc/facility/>しみん福祉スポーツセンター</a> の体育館を借りてバドミントンを行う予定だった。<a href=/diary/posts/2024/0829/>木曜日は戻ってこれない可能性</a> があったし、前日の天気予報では金曜日の夕方が神戸に台風が来る予報になっていた。そこで木曜日の夜に参加者も少なかったしキャンセルすることに決めた。キャンセルは1週間前でないとできないため、これは自然災害だから仕方がないと体育館のキャンセル料金3,000円を支払うことにした。直接、しみん福祉スポーツセンターの窓口でないと支払いできない。窓口へ行って paypay で支払いしてきた。しみん福祉スポーツセンターの体育館を借りるのは値段が高いので参加者数が増えてから借りる運用を変えようと思う。</p><h2 id=x-forwarded-for-ヘッダーの制御>X-Forwarded-For ヘッダーの制御</h2><p><a href=/diary/posts/2024/0830/>先日の作業の続き</a> 。本当は土曜日にやろうと思っていて、全然やる気がなくて、なにもやらないよりはちょっとでもやった方がよいかと、今日やり始めたら集中できて2-3時間で調査と対応を完了した。もともと構築しているリバースプロキシとしての nginx には次のヘッダーを扱う設定が追加されていた。</p><pre tabindex=0><code>proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_set_header X-Forwarded-Proto $scheme;
proxy_set_header X-Forwarded-Host $server_name;
</code></pre><p>追加で <code>remote_addr</code> を置き換える設定を入れてみれば、リバースプロキシ経由でリクエストを受ける go の http Request が参照する RemoteAddr の値も置き換わるのかな？と検証してみた。</p><pre tabindex=0><code>set_real_ip_from 172.29.0.0/16;
real_ip_header X-Forwarded-For;
real_ip_recursive on;
proxy_set_header REMOTE_ADDR $remote_addr;
</code></pre><p>結論としては RemoteAddr の値は置き換わらなかった。nginx の <code>real_ip_header</code> モジュールは nginx 環境における <code>remote_addr</code> の値を変更する設定であり、転送するときにパケットの値を置き換えるものではないようにみえる。そこで api サーバー側で <code>X-Forwarded-For</code> ヘッダーを参照するのが正しい対応方法だと理解できた。このヘッダーを参照することは一般的な用途に思えるので調べたら echo の <a href=https://echo.labstack.com/docs/ip-address>IP Address</a> のドキュメントにその設定方法やユーティリティの扱いなどが書いてあってすぐに参照できることもわかった。</p><p><code>X-Forwarded-For</code> ヘッダーはクライアントが任意で偽装できる。デフォルトでは内部ネットワークから転送されたヘッダーの値のみを信頼するように設定されている。それが次の IPExtractor の設定になる。デフォルトの制約を変更することもできるが、コンテナで運用するとすべての通信はコンテナネットワークの gateway からリクエストされているようにみえるのでアクセス制御という側面ではこの設定そのものにあまり意味はない。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>e</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>New</span>()
</span></span><span style=display:flex><span><span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>IPExtractor</span> = <span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>ExtractIPFromXFFHeader</span>()
</span></span></code></pre></div><p><code>X-Forwarded-For</code> ヘッダーの値を実際に参照するときは <code>c.Request().RemoteAddr</code> ではなく <code>c.RealIP()</code> を使う。api サーバーはこのぐらいの変更で実際のクライアントから転送されてきた ip アドレスを知ることができた。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0714/>wifi ルーターの規格調査</a></h1><div class=post-meta><time class=post-date>2024-07-14</time></div><span class=post-tags>#<a href=/diary/tags/device/>device</a>&nbsp;
#<a href=/diary/tags/network/>network</a>&nbsp;
#<a href=/diary/tags/community/>community</a>&nbsp;
#<a href=/diary/tags/coworking/>coworking</a>&nbsp;
#<a href=/diary/tags/animation/>animation</a>&nbsp;</span><div class=post-content><p>今日の運動は腹筋ローラー,腕立て,スクワット,ハンドグリップをした。今日も全般的に雨降りだったので筋トレをメインにした。統計を <a href="https://docs.google.com/spreadsheets/d/1bg85QtM-LciUgey8I79uI7vW2PEwsP6TVdeIRVkACBg/edit?usp=sharing">運動の記録</a> にまとめる。オフィスで軽く <a href=/diary/posts/2024/0707/#右股関節をよくするための体操>右股関節の改善体操</a> をした。</p><h2 id=wifi-ルーターの規格>wifi ルーターの規格</h2><p>引っ越しした機会に wifi ルーターを wifi 6 対応のバッファローの WSR-1500AX2L/N に変更した。wifi 6 の速度があれば十分だろうと手頃な価格帯 (6,280円) のモデルを購入した。</p><p><a href=https://amzn.to/4bK4Lpo target=_blank><img src=https://m.media-amazon.com/images/I/61veZLRtl3L._AC_SX522_.jpg width=120></a></p><p>業者さんから光クロス対応ルーターを用意してほしいと言われていた。<a href=https://flets.com/next/router/buffalo.html>フレッツ光クロス対応ルーター</a> をみると、どうやらこのモデルは違うようだ。光クロス対応ってなんのことを言っているのか理解できていなかった。おそらく 10GBASE-T のことだと思う。最近のネットワークは家庭でも 10Gbps になっているのか。WSR-1500AX2L/N のインターフェースは 1Gbps なので光クロス回線の帯域をフル活用できない。それでも 5GHz だと 200 Mbps 前後、2.4GHz でも 50 Mbps 前後の速度が出ていて私の用途なら十分に速い。とはいえ、ネットワークは速ければ速いほどいいから、またお金の余裕があるときに wifi ルーターを買い替えてもよいかなと思う。INTERNET / LAN 両方とも 10Gbps 対応ポートを備えたモデルは <a href=https://www.buffalo.jp/product/detail/wxr18000be10p_n.html>WXR18000BE10P/N</a> になる。実勢価格は5-6万円とけっこう高い。1-2年先でもいいかな。</p><p>wifi ルーターのアクセスポイントの SSID やパスワード、管理画面へのパスワードを初期設定から変更してカスタマイズした。たまにネットワーク設定やらないといろいろ忘れてしまう。</p><h2 id=ホットクックの無線設定>ホットクックの無線設定</h2><p>wifi ルーターのカスタマイズを完了したのでホットクックをインターネットに接続した。ホットクックが接続できる wifi のアクセスポイントは 2.4 GHz の WPA2 Personal になる。暗号方式は AES を選択する。ホットクックのために wifi ルーターの 2.4 GHz も有効にしないといけない。そして、ホットクックの wifi ルーターの接続設定がすごくわかりにくい。初めてやったときも苦労したけど、今回の再設定も苦労したので要項を書いておく。</p><ol><li>(ホットクック) 無線 LAN 接続設定を開く</li><li>(ホットクック) 「アプリで接続」という状態にする</li><li>(スマホアプリ) アプリ設定から機器を追加する</li><li>(スマホアプリ) アプリ設定を進めて、スマホの wifi のアクセスポイントをホットクックの AP に接続させる</li><li>(スマホ) ローカルネットワークの wifi ルーターに接続させる</li><li>(ホットクック) 音声で接続できたことがわかる</li><li>(スマホ) wifi のアクセスポイントをローカルネットワークの wifi ルーターに切り替える</li><li>(スマホアプリ) アプリ設定の機器登録ができていることを確認する</li></ol><p>一時的にホットクックを無線 LAN のアクセスポイントにするという手順が直感的にわかりにくい。本体から無線 LAN 接続設定を行う (wifi 接続のパスワード入力する) 方法がないから苦肉の策でこういう仕様になっているように思える。</p><h2 id=迷惑をかけない死に方>迷惑をかけない死に方</h2><p><a href=/diary/posts/2024/0705/#隔週の雑談>居場所の雑談</a> と関連して、自分の死に方も少し意識するようになってきた。<a href=/diary/posts/2023/0103/#追悼>父が亡くなったとき</a> はあまりショックを受けることはなかった。昔から父とは距離があったのと、病院で寝たきりの生活が5年もあったから心の準備ができていたのかもしれない。母とはちょいちょい電話したりもするし、実家に帰ったときはご飯を食べに行ったりもするし、一緒に田んぼ作業をしたり、父よりはずっと私にとって身近な存在であると言える。親が亡くなったときに大きなショックを受けた知人の話しをたまに聞く。母が亡くなると私も孤独感を感じるんやろか？と考えるときもある。</p><ul><li><a href=https://nordot.app/1178899890481578055>「孤独死が発生しています」憧れだったマンション群でまさかの掲示　都心の一等地なのに超高齢社会…日本の未来の縮図で起きた悲しい現実</a></li></ul><p>こういった記事をみかけるとついつい読んでしまう。読んでなにかが変わるわけでもないが、たまにショックを受けて辛くもなりつつ、避けられない未来を考えるきっかけになる。母は私が看取るとして自分は孤独死になるだろうからその対策を漠然を考えたりするときもある。カフーツさんでそういう話しをしていたときに <a href=https://www.facebook.com/rokken.happy.home>はっぴーの家ろっけん</a> というシェアハウスを教えてもらった。訳ありっぽい老若男女の大家族が一緒に住むといった暮らしをしている。これからの日本において孤独死する老人は増えていくだろうから、こういった取り組みやコミュニティの在り方はもっと一般化していくと推測される。</p><ul><li><a href=https://note.com/happy_house/n/n5925993a0658>【随時採用やってまーす。】日常の登場人物になりたい方へ(2024.2月現在)</a></li></ul><p>こういう取り組みを自分でやるかどうかは別として、私もいつかはお世話したりされたりの互助的なコミュニティに関わることになるのだろうと漠然と考えている。自分が死んだときにいくらか財産が残っていると仮定して、甥や姪に寄贈するという考え方もあるけど、こういった施設やコミュニティが長く続くよう寄付するというのもよいかもしれない。居場所の延長上で死に場所も一緒に考えていけるとよい。いまコミュニティやコワーキングについて研究していることがいずれ役に立つ気がする。</p><h2 id=ガールズバンドクライ>ガールズバンドクライ</h2><p>おすすめされて <a href=/diary/posts/2024/0709/#響けユーフォニアムをたくさんみた>響け！ユーフォニアム</a> に続いて <a href=https://girls-band-cry.com/>ガールズバンドクライ</a> というアニメを一気にみた。個人的にはこちらの方が私は楽しめた作品だった。思春期特有の葛藤や逡巡を表現していて、痛い感じの少女が成長していくような、王道の青春ストーリーになっている。ロックバンドと痛い感じの女の子たちがマッチしていて、ロックってそういう鬱屈した気持ちをストレートに吐き出すなにかと相性がよいのだなとも感じた。この作品をみていて私が感じたことの1つに、追い求めているときが一番楽しいという気持ちを思い起こさせてくれた。最近 <a href=/diary/posts/2024/0627/>いくつか目標を達成して燃え尽き</a> になっていた。十分に休養をとったのでだいぶ回復してきたところでもある。</p><p>この作品は、声優がバンドをやるのではなく、<a href=https://au.utapass.auone.jp/lp/girlsbandcry>バンドをやりたい人たちに声優をさせる</a> というアプローチで作られているらしい。すでに楽曲はいくつもリリースされている。ちょうど運動するときの音楽を探していたところなのでしばらくガールズバンドクライの楽曲を聞きながらやってみようと思う。仁菜の歌う空の箱 (VOID) や運命の華 (I&rsquo;m here) などが好み。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0514/>引っ越しの準備を少しずつ始める</a></h1><div class=post-meta><time class=post-date>2024-05-14</time></div><span class=post-tags>#<a href=/diary/tags/founding/>founding</a>&nbsp;
#<a href=/diary/tags/network/>network</a>&nbsp;
#<a href=/diary/tags/exercise/>exercise</a>&nbsp;</span><div class=post-content><p>今日の運動は腹筋ローラー,背筋,縄跳び(両足跳),散歩,ハンドグリップ,ダンベルをした。統計を <a href="https://docs.google.com/spreadsheets/d/1bg85QtM-LciUgey8I79uI7vW2PEwsP6TVdeIRVkACBg/edit?usp=sharing">運動の記録</a> にまとめる。</p><h2 id=インターネット回線の申し込み>インターネット回線の申し込み</h2><p>転居先のインターネット回線を申し込みした。コンシェルジュから <a href=https://chintainet.jp/>賃貸ねっと</a> を紹介されて値段も安かったのでそれでいいやと決めた。いま iijmio のモバイルとひかり回線をセット割で契約している。社宅に引っ越ししたら、携帯電話は法人契約でインターネット回線は個人契約に変更する。どうせセット割できないのでどこでもいいやという所感。家で使うインターネットは映画やアニメをみるぐらいだから 1 Gbps もあれば十分やと思う。マンションのネット回線は光クロス対応らしく 10 Gbps の速度が出るのかな？ひとまず月々の料金が高くなるなら 1 Gbps で十分ですとは伝えた。さらに光クロス対応 wifi ルーターを買えと言われて、調べたらバッファロー WiFi ルーターが一番いいらしく、Wi-Fi 6 対応のエントリーモデルを選択した。光クロス対応って単純に速度の速いルーターのことであってる？全然いまのネットワークの規格やハードウェアについていけていない。引っ越しやってそういった設備をアップデートとして学ぶことが多い。定期的に移動することも大事。
￼
<a href=https://amzn.to/4bABTjv target=_blank><img src=https://m.media-amazon.com/images/I/61veZLRtl3L._AC_SX569_.jpg width=120></a></p><h2 id=みなとのもりの運動>みなとのもりの運動</h2><p><a href=/diary/posts/2024/0513/#みなとのもりの運動>前回の所感</a> 。昨日は足を休めて少しよくなったので今日はがんばろうと意気込んで行ったものの、人が多くてよい場所が見当たらなくて、少し狭い場所をとって縄跳びを始めたものの、そこにフライングディスクの <a href=https://www.jfda.or.jp/introduction/ultimate/>アルティメット / Ultimate</a> の練習をしているチームが寄せてきて、距離が近くて危なくて縄跳びやりにくくなった。おそらく大学のサークルの練習だったのではないかと思う。すぐ隣で走り回っているのに嫌気がさして集中力を欠いてしまった。心が弱い。</p><h2 id=駐車場散策>駐車場散策</h2><p>いま住んでいるところの駐車場の解約申請を管理人さんに手渡した。転居先に駐車場そのものはあるものの、いまは満車でそこを借りることはできない。近所の駐車場を借りる必要がある。あらかじめ google map で付近の駐車場を探してあった。運動を終えた後に歩いていって、候補の駐車場がそれぞれどんな雰囲気かをみてきた。私の要件はこんなところ。管理人がいるような駐車場だと0時から朝7時までは閉鎖されてしまう。</p><ul><li>屋内で雨風を防げる</li><li>24時間出し入れできる</li><li>車庫はなるべく広い方がよい</li></ul><p>2つ候補があって実際に現地でみて確認した。善は急げでよい方に帰ってきてすぐ申し込みした。免許、車検証、保険の写しなど、必要な書類をオンラインでアップロードした。行政手続きに慣れたせいか、この手の書類をいくつか提出しないといけない手続きを苦に思わず手早くできるようになった。書類も整理して保管してあるから探すことなく30分ほどで申し込みを終えた。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0208/>小さい会社の採用は難しい</a></h1><div class=post-meta><time class=post-date>2024-02-08</time></div><span class=post-tags>#<a href=/diary/tags/blog/>blog</a>&nbsp;
#<a href=/diary/tags/event/>event</a>&nbsp;
#<a href=/diary/tags/founding/>founding</a>&nbsp;
#<a href=/diary/tags/health/>health</a>&nbsp;
#<a href=/diary/tags/biztrip/>biztrip</a>&nbsp;
#<a href=/diary/tags/network/>network</a>&nbsp;</span><div class=post-content><p>1時頃に寝て2時半に起きて7時半に起きた。昨日は飲み歩いたのもあって寝不足気味で体調よくなかった。これも歳なんやろな。</p><p>今日の運動はレッグレイズ(椅子),スクワット,背筋,散歩をした。統計を <a href="https://docs.google.com/spreadsheets/d/1bg85QtM-LciUgey8I79uI7vW2PEwsP6TVdeIRVkACBg/edit?usp=sharing">運動の記録</a> にまとめる。</p><h2 id=社内版テックブログを読む会の3回目>社内版テックブログを読む会の3回目</h2><p>新しい取り組みの3回目。<a href=/diary/posts/2024/0201/#社内版テックブログを読む会の2回目>前回の所感はここ</a> 。</p><p>3回目なのでメンバーも慣れてうまくイベントをこなしていた。普段はオンラインでやっているけど、今日はオフラインで初めてやってみた。やはりオフラインの方が話しやすい。私はずっと svelte を「すべるて」と呼んできたのだけど、実はこれは「すべると」と発音するらしいと初めて知った。</p><p>今日は営業社員さんがこのチャンネルをみつけて参加してくれた。別に技術に特化しなくてもよいのでこういった他部署や他業種の人たちとも一緒にやれるのがこのイベントのよいところの1つでもある。営業さんらしく次の記事を共有してくれた。</p><ul><li><a href=https://baigie.me/officialblog/2023/08/28/sales-team-super-phoenix/>営業の崩壊と再生～営業の問題を解決する14の処方箋</a></li></ul><p>web 制作会社でいい感じに売上が増えてきて、コロナ禍になったときにリモートワークならオフィスの制約なく社員を増やせると気付いて、急採用して社員を増やした結果、経費があがって利益率が悪化して、結果的に会社がうまくまわらなくなって改革したという話しみたい。社員を増やしたら会社の各種 kpi が悪化したというのがおもしろいところ。要は社員数が増えるとそれだけ受注や利益を多くあげないといけないが、組織の体制が出来ていないと右肩上がりにはならなかったという。取引の業績は悪くなっていないのに社員数が増えた分で会社の業績は悪化してしまった。会社の採用って本当に難しいと思う。うちの会社はいつになったら社員を雇用できるのだろうか。</p><h2 id=ホテル付近を散歩>ホテル付近を散歩</h2><p><a href=/diary/posts/2024/0204/>格闘家に学ぶ体脂肪コントロール</a> 本に週に200分は有酸素運動をしろと書いてあって、1日あたり30分程度だという。散歩をするのがもっとも簡単でいいだろうと、大崎駅周辺のホテル近辺を散策して歩いた。ちょうど30分ほど歩いた。</p><p>今日は <a href=https://www.daiwaroynet.jp/osaki/>ダイワロイネットホテル東京大崎</a> に泊まっている。私は大崎という場所を気に入っていて、駅から直結でいけるこのホテルもよい。ビジネスホテルとしてはやや割高だけど、うまいこと安い時期が探して何度か泊まっている。部屋は広いし、お風呂も広いし、立地もよい。周りの飲食店も良さげなお店がたくさんあるのに混雑していない。</p><p>唯一イケてないのが wifi の遅さ。昨日の夜は全然つながらなくて、途中からスマホのテザリングに切り替えた。朝使っていると400Mbps程度の速度は出ている。おそらくネットワークの設計や dns サーバーのパフォーマンスなどが悪いのだと推測する。大きいホテルだからお客さんが何十人か同時に接続すると一気にパフォーマンスを悪化させているのだと思う。同時接続を考慮したネットワークの分割、ボトルネックの排除をやっていかないといけない。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0119/>年明けからコーポレート業務いろいろ</a></h1><div class=post-meta><time class=post-date>2024-01-19</time></div><span class=post-tags>#<a href=/diary/tags/founding/>founding</a>&nbsp;
#<a href=/diary/tags/tax/>tax</a>&nbsp;
#<a href=/diary/tags/finance/>finance</a>&nbsp;
#<a href=/diary/tags/coworking/>coworking</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/debug/>debug</a>&nbsp;
#<a href=/diary/tags/network/>network</a>&nbsp;</span><div class=post-content><p>23時に寝て4時半頃に起きてそのまま6時半までだらだらして起きた。早寝早起き。</p><p>今日の筋トレは腹筋:20x1,腕立て:15x1,スクワット20x1をした。</p><h2 id=隔週の雑談>隔週の雑談</h2><p>顧問のはらさんと隔週の打ち合わせ。今日の議題はこれら。内容が多くて1時間超えた。</p><ul><li><a href=/diary/posts/2024/0105/#事務処理規定の叩き台作成>電子帳簿保存法対応の事務処理規定の共有</a><ul><li>まだ始まったばかりで税理士さんの温度感も低い</li><li>事務処理規定が省令に沿っているかどうかの判断はプロセス監査で行われる</li><li>電子帳簿保存法には規定されていないため、事務処理規定の妥当性の検証は行われない</li></ul></li><li><a href=/diary/posts/2024/0107/#経営の価値観と財務>融資を受ける構想作り</a><ul><li>日本政策金融公庫のみで検討していたが、融資実績を作りたいなら信用金庫も加えた方がよい</li><li>借金のメンタリティ、担当者との折衝や審査など余裕のあるときに経験を積んでおくことはよいように思えた</li></ul></li><li><a href=/diary/posts/2024/0113/#ファイナンシャルプランナーとの打ち合わせ>ファイナンシャルプランナーさんとのやり取り</a><ul><li>会社の経費で役員のための保険に入ろうと考えている</li><li>個人の保険控除は8万円らしい</li></ul></li><li><a href=https://note.com/kanzan10to9/n/n49d8fe09ad5b>ローカル複業化プロジェクトの考察</a><ul><li>IT コミュニティに老人や子どもたちは入りにくい。農業なら老若男女誰でも入れる気がする</li><li>農業や地元の特産品を切り口にコワーキング (コミュニティ) で街の人たちと田舎の人たちをつなげるのはすごいことだと思う (関係人口の創出)</li><li>地元の有力者と仲良くなると、行政の口利きもしてくれて活動しやすくなる</li></ul></li></ul><p>はらさんが <a href=https://yorihiroi-frontend.engineer/ja>よりひろいフロントエンド</a> を始めたそうでその話しも聞いていた。個人のブログサイトにするのか、複数人で記事を共有するサイトにするのかもまだ曖昧だという。<a href=https://www.contentful.com/>Contentful</a> + Next.js + Cloudflare Pages という構成らしい。Contentful というツールを私が知らなかったのでまた時間のあるときに調べてみようと思う。</p><p>母が一人暮らしをしていて体調もよくないことから要介護状態になるリスクがそこそこあると考えている。最悪の場合、会社を休眠させてしばらく介護をするかもしれない。はらさんが仰るには休眠はよいアイディアだという。会社員に例えると退職した日の帰り道を想像するとよいと話されていたのだけど、私は過去の記憶があまりないというのもあるが、これまで6回も退職してきたのに退職日を特別に思ったことはあまりない。退職日と他の日に大きな違いはなくて、次のお仕事の準備や調査をしていることが私は多かったと思う。それでも退職にあわせて有休を1-2ヶ月とってゆっくり過ごしていたことには変わりない。私もそういう、メリハリのある働き方が好きだ。</p><h2 id=smtp-接続のタイムアウト>smtp 接続のタイムアウト</h2><p>たまたまメンバーが誤った設定で smtp サーバーに接続したときにタイムアウトするまで5分ほどかかるという現象を発見した。タイムアウトの設定をせずに接続しようとするからそんなことが起きるのかな？と考えて smtp クライアントのタイムアウト設定を調べてみると <a href=https://pkg.go.dev/net#DialTimeout>net.DialTimeout</a> を使えばよいという。</p><ul><li><a href=https://github.com/golang/go/issues/16436#issuecomment-233829112>https://github.com/golang/go/issues/16436#issuecomment-233829112</a></li></ul><p>多めに見積もって30秒のタイムアウトを設定して接続するようにして再度メンバーに再現検証してもらったら直っていないという。接続そのものは出来ていたのだ。ソースを読んでみると、smtp クライアントを生成するときに <code>220</code> というレスポンスを読むことがわかる。誤った接続設定でもコネクションは確立するが、レスポンスが返ってこなくて待ち状態になっていた。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewClient</span>(<span style=color:#a6e22e>conn</span> <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>Conn</span>, <span style=color:#a6e22e>host</span> <span style=color:#66d9ef>string</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>Client</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>text</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>textproto</span>.<span style=color:#a6e22e>NewConn</span>(<span style=color:#a6e22e>conn</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>text</span>.<span style=color:#a6e22e>ReadResponse</span>(<span style=color:#ae81ff>220</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>text</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>c</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>Client</span>{<span style=color:#a6e22e>Text</span>: <span style=color:#a6e22e>text</span>, <span style=color:#a6e22e>conn</span>: <span style=color:#a6e22e>conn</span>, <span style=color:#a6e22e>serverName</span>: <span style=color:#a6e22e>host</span>, <span style=color:#a6e22e>localName</span>: <span style=color:#e6db74>&#34;localhost&#34;</span>}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>tls</span> = <span style=color:#a6e22e>conn</span>.(<span style=color:#f92672>*</span><span style=color:#a6e22e>tls</span>.<span style=color:#a6e22e>Conn</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>c</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>調べてみると Conn インターフェースにデッドラインを設定する API が提供されている。注意事項としては接続した後にデッドラインをリセットしないといけない。</p><blockquote><p>デッドラインとは、I/O操作がブロックされずに失敗する絶対時間のことである。デッドラインは、ReadやWriteを呼び出した直後のI/Oだけでなく、将来の保留中の I/O すべてに適用される。デッドラインを超過した後は、未来にデッドラインを設定することで、接続をリフレッシュすることができる。</p><p>デッドラインを超えた場合、ReadやWrite、その他のI/Oメソッドの呼び出しは、os.ErrDeadlineExceeded をラップしたエラーを返します。これは、errors.Is(err, os.ErrDeadlineExceeded)を使用してテストすることができます。errorのTimeoutメソッドはtrueを返しますが、期限を超過していなくてもTimeoutメソッドがtrueを返すエラーが他にもあることに注意してください。</p><p>アイドルタイムアウトは、ReadまたはWrite呼び出しに成功した後、デッドラインを繰り返し延長することで実装できる。tの値が0であれば、I/O操作はタイムアウトしない。</p><p><a href=https://pkg.go.dev/net#Conn>https://pkg.go.dev/net#Conn</a></p></blockquote><p>次のように <code>SetReadDeadline()</code> を使ってタイムアウトを5分から30秒に短縮できた。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Clinet</span>) <span style=color:#a6e22e>connectWithReadDeadline</span>(<span style=color:#a6e22e>conn</span> <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>Conn</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>smtp</span>.<span style=color:#a6e22e>Client</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>SetReadDeadline</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>().<span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>dialTimeout</span>)); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to set read deadline: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>smtp</span>.<span style=color:#a6e22e>NewClient</span>(<span style=color:#a6e22e>conn</span>, <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>Host</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to connect to the smtp server: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// clear read deadline
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>SetReadDeadline</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>{}); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to reset read deadline: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>c</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0102/>MBTI 性格診断とか</a></h1><div class=post-meta><time class=post-date>2024-01-02</time></div><span class=post-tags>#<a href=/diary/tags/day-off/>day off</a>&nbsp;
#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/network/>network</a>&nbsp;</span><div class=post-content><p>2時過ぎに寝て6時半に起きて7時半に起きた。夜に相棒の元旦スペシャルをみていて、最後の方でニュースに切り替わって、その後、相棒の別の再放送？がまた始まるみたいな変な番組編成になっていた。起きてから神棚にお供えをしたり親戚を迎える準備をしていた。</p><p>今日の筋トレは腹筋:10x1,腕立て:10x1,スクワット10x1のように毎日書いていけば1ヶ月ぐらいは継続できるのではないか？</p><h2 id=親戚とお昼ご飯>親戚とお昼ご飯</h2><p>毎年2日は親戚がやってきてお昼ご飯を食べる。昨年は訃報でやらなかったので2年ぶり。今年は離れのスペースにダイニングテーブルを2つ入れた。この形態でやるのは初めて。鍋にすき焼きをつくり、あとお寿司とお刺身を7人で食べた。このぐらいの人数でご飯を食べるのはとくに問題なさそう。ご飯を食べたりするなら電子レンジもあった方が便利だと気付いた。11時から準備して12時頃から食べ始めて14時前ぐらいで解散。お年玉をあげたり、親戚の姪や甥の話しを聞いたりしていた。</p><p>この春から働き始める姪が言うには <a href=https://www.16personalities.com/ja>MBTI 性格診断</a> というのが流行っていて、就職活動で適正診断の1つとしてやるようなものになる。なぜかそれが一般にも流行っていて、若い人だとこのタイプをインスタのプロフィールに書いてあったりもするらしい。試しにやってみたら私は <a href=https://www.16personalities.com/ja/intj%E5%9E%8B%E3%81%AE%E6%80%A7%E6%A0%BC>建築家 INTJ-A</a> タイプだった。タイプが16個あるので複数人でやったらタイプがバラけて盛り上がるのかもしれない。今度の開発合宿でもネタの1つにみんなにやってもらってもよいかもしれない。</p><h2 id=iphone-のテザリングの自動切断>iphone のテザリングの自動切断</h2><p>iphone を wifi ルーター代わりにテザリングをしていると気付かないときに切断していることがある。調べてみると、通信がないと約90秒で自動切断するという仕様になっているらしい。これはテザリング接続のアクセスポイントの電波も停止してしまっていることから、iphone の設定を開いてインターネット共有の on/off をしないといけないという面倒さがある。</p><p>この振る舞いはバッテリーを節約したいデバイス側と通信帯域を節約したいキャリア側の思惑が一致するせいか、ユーザー設定でこの振る舞いをカスタマイズすることはできないようにみえる。</p><ul><li><a href=https://note.com/runisan/n/n81c34518e1e0>iPhone-iPad間テザリングの接続切れ問題を解消したので解説したい</a></li></ul><p>なにかしら通信していれば自動切断はしない仕様にみえるので ping コマンドで icmp パケットを定期的に (次の例では60秒ごと) に送るといったことをしていれば切断はされないようにみえる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-zsh data-lang=zsh><span style=display:flex><span>&gt; ping -i <span style=color:#ae81ff>60</span> www.yahoo.co.jp
</span></span></code></pre></div><p>開発者ならすぐワークアラウンドを思いつくが、一般ユーザー向けに iphone のテザリングが自動切断されない接続アプリのようなものを作ってあげると一般ユーザーにウケるんじゃないかと考えたりもした。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1215/>おいしい 🦀 を食べに行く</a></h1><div class=post-meta><time class=post-date>2023-12-15</time></div><span class=post-tags>#<a href=/diary/tags/docker/>docker</a>&nbsp;
#<a href=/diary/tags/container/>container</a>&nbsp;
#<a href=/diary/tags/network/>network</a>&nbsp;
#<a href=/diary/tags/workcation/>workcation</a>&nbsp;
#<a href=/diary/tags/community/>community</a>&nbsp;
#<a href=/diary/tags/slack/>slack</a>&nbsp;</span><div class=post-content><p>22時頃に寝てしまって1時に起きて5時に起きて6時過ぎに起きた。とくになにもしていないのにバテている気がする。今週はずっと mongodb のレプリカセットの調査やインフラの移行作業などをやっていたせいか、普段よりもエネルギーを消費しているのかもしれない。朝から疲労困憊でオフィスへ向かった。</p><h2 id=docker-のコンテナネットワークの調査>docker のコンテナネットワークの調査</h2><p>docker のコンテナネットワークから解決できる名前がなになのか、よくわかってなくて、その調査のためにサンプルの compose サービスを作った。</p><ul><li><a href=https://github.com/t2y/docker-compose-sample>https://github.com/t2y/docker-compose-sample</a></li></ul><p>myimage から nginx のコンテナの名前解決がどうなるかを試してみる。</p><pre tabindex=0><code>c67a5ca94a77:/app# dig +short 00c719491558
192.168.240.3
c67a5ca94a77:/app# dig +short mynginx
192.168.240.3
c67a5ca94a77:/app# dig +short nginx
192.168.240.3
c67a5ca94a77:/app# dig +short yournginx
192.168.240.3
</code></pre><p>基本的にはサービス名、コンテナ名 (container_name)、コンテナー ID、ホスト名 (hostname) はすべて名前解決できる。hostname があるときはそのコンテナの /etc/hosts にその名前が追加され、ないときはコンテナ ID が追加されていた。</p><pre tabindex=0><code>yourcontainer:/app# cat /etc/hosts
127.0.0.1	localhost
...
172.18.0.3	yourcontainer
</code></pre><h2 id=冬の開発合宿の準備>冬の開発合宿の準備</h2><p><a href=/diary/posts/2023/0526/#開発合宿の日程確定>日程を決めたのが5月末</a> で、うちの会社のワークスペースに slack のチャンネルを開設したのが10月。現時点で7人の参加者がいる。もうこのメンバーでいいかなと考えている。今回はコミュニティのワーケーションイベントというより、自社の開発合宿という体をとっている。スポンサーとしていくらか会社からお金も出す。その理由の1つは slack チャンネルにログを残したいという意図がある。コミュニティの slack だとフリープランになるので3ヶ月以上過去のログがみえなくなってしまう。それを解消するには自社の有料プランの slack チャンネルに置いておくのがもっともログを制御できて嬉しい。</p><p>城崎温泉では11月から 🦀 が解禁となって、今年は冬に行くので 🦀 を食べるというのも目的の1つ。チャンネルで盛り上げようと、たまに城崎温泉の記事を貼り付けたりしていた。そろそろ、メンバーと顔合わせの情報共有の打ち合わせをしようと思って調整さんを作った。他の人たちは、わざわざうちの slack のワークスペースにゲスト参加しているから、あまり無理強いをせずに情報共有できるようにしておきたい。たった1つの、ほとんどやり取りしないチャンネルのために slack のワークスペースをオープンしておかないといけないという用途はなかなか面倒だ。私が逆の立場でもそう思う。どうにか普段使っているワークスペースから、必要なときだけ連携できるような仕組みがないだろうか？</p><p>年末・年始の情報共有の打ち合わせへ向けて旅のしおりも準備していく。日々の業務に忙殺されて後回しにしがちなので自分を追い込むためにも予定を入れた。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1013/>標準ライブラリに XOAUTH2 の実装がない</a></h1><div class=post-meta><time class=post-date>2023-10-13</time></div><span class=post-tags>#<a href=/diary/tags/founding/>founding</a>&nbsp;
#<a href=/diary/tags/team-building/>team building</a>&nbsp;
#<a href=/diary/tags/network/>network</a>&nbsp;
#<a href=/diary/tags/auth/>auth</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;</span><div class=post-content><p>0時に寝て3時に起きて5時ぐらいまでネットで遊んでて6時半に起きた。昨日の夜に洗濯しようと思って忘れていたので朝から洗濯した。</p><h2 id=隔週の雑談>隔週の雑談</h2><p>顧問のはらさんと隔週の打ち合わせ。今日の議題はこれら。</p><ul><li>税理士さんとの打ち合わせのふりかえり</li><li>昔お手伝いした会社の開発体制の話</li><li><a href=/diary/posts/2023/1005/>新しいチーム勉強会</a> の導入</li></ul><p>3人の税理士さんと打ち合わせしてみて最終的に顧問契約をお願いする方を決めた。話してみてやり取りした雰囲気だと、その税理士さんもスキルやこちらの要件対応については全く問題なさそうに思えた。あとは報酬とうちの会社の規模などを考慮して選択した。</p><p>昔お手伝いした会社で2年経ってちょっと相談にのってほしいという打ち合わせをした。私がいた2年前と開発体制はまったく変わってなくて、未だにテックリードがほぼ1人で開発している状況らしい。私が辞めてから以降も何人かは開発者が入っては辞めを繰り返しているのだと推測する。私も2度とその開発者と一緒に働きたくないと思うぐらいには信頼してなくて、開発者が引く手あまたな世の中の状況において、人間として信頼されないリーダーって致命的なんだなということを改めて実感した。おそらくテックリードを追放しない限り、あの開発体制 (と言ってもほぼ独り開発) は何も変わらないのだろうと思う。</p><h2 id=oauth-20-で認証して-google-の-smtp-サーバーを使う>oauth 2.0 で認証して google の smtp サーバーを使う</h2><p><a href=/diary/posts/2023/1012/>昨日の続き</a> 。</p><p>リフレッシュトークンを使って取得したアクセストークンで smtp の AUTH コマンドで XOAUTH2 で認証すればよい。仕様は次のドキュメントに書いてある。</p><ul><li><a href=https://developers.google.com/gmail/imap/xoauth2-protocol>Home > Google Workspace > Gmail > Guides > OAuth 2.0 Mechanism</a></li><li><a href=https://tex2e.github.io/rfc-translater/html/rfc7628.html>RFC 7628 - A Set of Simple Authentication and Security Layer (SASL) Mechanisms for OAuth 日本語訳</a></li></ul><p>なぜか go の標準ライブラリの net/smtp には Plain と CRAM-MD5 の2つしか実装されていない。AUTH コマンドの実装は smtp.Auth インターフェースで定義されている。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Auth</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Start</span>(<span style=color:#a6e22e>server</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ServerInfo</span>) (<span style=color:#a6e22e>proto</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>toServer</span> []<span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Next</span>(<span style=color:#a6e22e>fromServer</span> []<span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>more</span> <span style=color:#66d9ef>bool</span>) (<span style=color:#a6e22e>toServer</span> []<span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>正常系の雑な実装だとこんな感じ。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>oauth2</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>user</span>        <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>tokenType</span>   <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>accessToken</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>o</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>oauth2</span>) <span style=color:#a6e22e>Start</span>(<span style=color:#a6e22e>server</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>smtp</span>.<span style=color:#a6e22e>ServerInfo</span>) (<span style=color:#66d9ef>string</span>, []<span style=color:#66d9ef>byte</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>server</span>.<span style=color:#a6e22e>TLS</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;need tls&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>resp</span> <span style=color:#f92672>:=</span> []byte(<span style=color:#e6db74>&#34;user=&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>o</span>.<span style=color:#a6e22e>user</span> <span style=color:#e6db74>&#34;\001auth=&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>o</span>.<span style=color:#a6e22e>tokenType</span>  <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; &#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>o</span>.<span style=color:#a6e22e>accessToken</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\001\001&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;XOAUTH2&#34;</span>, <span style=color:#a6e22e>resp</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>o</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>oauth2</span>) <span style=color:#a6e22e>Next</span>(<span style=color:#a6e22e>fromServer</span> []<span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>more</span> <span style=color:#66d9ef>bool</span>) ([]<span style=color:#66d9ef>byte</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>more</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>New</span>(<span style=color:#e6db74>&#34;unexpected server challenge&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ググるとサンプルコードを実装している人たちがちらほらいるので、そのうち標準ライブラリに誰か実装してくれると思う。</p><ul><li><a href=https://github.com/jacobalberty/smtpoauth2>https://github.com/jacobalberty/smtpoauth2</a></li></ul><p>go 本体に pr を送るチャンスでもあるけど、<a href=https://go.dev/doc/contribute>Contribution Guide</a> を少し眺めて大変そうと思って、いまそこまでのモチベーションないなって感じ。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1012/>xoauth2 という smtp の認証</a></h1><div class=post-meta><time class=post-date>2023-10-12</time></div><span class=post-tags>#<a href=/diary/tags/network/>network</a>&nbsp;
#<a href=/diary/tags/auth/>auth</a>&nbsp;</span><div class=post-content><p>0時に寝て何度か起きて6時に起きた。昨日、凡人が天才に挑むという状況で、キングダムの <a href=https://dic.pixiv.net/a/%E8%92%99%E9%A9%81>蒙驁</a> 将軍が廉頗に挑むみたいな状況を思い出して見返していた。史実では蒙驁が魏を攻めて東郡を置いたというのは事実だが、廉頗と戦ったという記録はなく、おそらくは蒙驁と廉頗に因縁があって雪辱戦としたというのはキングダムの創作だろうと推測される。</p><h2 id=oauth-20-で認証して-google-の-smtp-サーバーを使う>oauth 2.0 で認証して google の smtp サーバーを使う</h2><p>google さんの smtp.gmail.com の smtp サーバーを使ってメールを送信したい。</p><ul><li><a href=https://workspaceupdates.googleblog.com/2019/12/less-secure-apps-oauth-google-username-password-incorrect.html>Turning off less secure app access to G Suite accounts</a></li><li><a href=https://workspaceupdates.googleblog.com/2023/09/winding-down-google-sync-and-less-secure-apps-support.html>Beginning September 30, 2024: third-party apps that use only a password to access Google Accounts and Google Sync will no longer be supported</a></li></ul><p>2019年にパスワード認証は廃止するので oauth 2.0 へ移行してくださいといった、最初のアナウンスが行われて、もうできないかと思ったら2024年9月30日に完全廃止するのかな？まだパスワード認証は動くかもしれない。一方で oauth 2.0 へ移行しないといけないのでその調査をメンバーにしてもらっていた。結局、途中からは私も本気になって調べていた。</p><p>oauth 2.0 で認証してアクセストークンとリフレッシュトークンを取得するためのサンプルコードとして <a href=https://github.com/google/gmail-oauth2-tools/wiki/OAuth2DotPyRunThrough>OAuth2DotPyRunThrough</a> が用意されている。このトークンを取得するときに callback の url にユーザーが明示的にアクセスして同意する必要がある。ここで得たアクセストークンは1時間で有効期限がきれる。しかし、リフレッシュトークンはユーザーが revoke しない限りは永続的に使えるそうで、このリフレッシュトークンを使って必要なときにアクセストークンを取得するというのが google さんの oauth 2.0 のアプリケーションの運用になるみたい。つまりリフレッシュトークンをアプリケーション側で管理することでアクセストークンは何度でも取得できる。</p><p><a href=https://developers.google.com/gmail/imap/xoauth2-protocol>OAuth 2.0 Mechanism</a> によると、取得したアクセストークンを使って <code>XOAUTH2</code> という smtp の認証方式で認証すれば smtp サーバーに対して smtp でメールを送信できる。gmail 以外でメールをやり取りする機会がなくなって数年たつ。smtp の仕組みとか、まったく忘れてしまって関心もない。たったこれだけなんだけど、右往左往してあちこち調べることになった。ややこしいのは google のクラウド api 経由でメールを送ることもできて、そのやり方と混同するとまったく違う方向に行ってしまう。そこだけ注意。</p></div></article><div class=pagination><div class=pagination__buttons><a href=/diary/tags/network/page/2/ class="button next"><span class=button__text>過去の日記</span>
<span class=button__icon>→</span></a></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2024 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>