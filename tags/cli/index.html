<!doctype html><html lang=en><head><title>Cli :: forest nook</title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/tags/cli/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="Cli"><meta property="og:description" content><meta property="og:url" content="/diary/tags/cli/"><meta property="og:site_name" content="forest nook"><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/tags/cli/index.xml rel=alternate type=application/rss+xml title="forest nook"></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><h1>Posts for: #Cli</h1><div class=posts><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0118/>ローカルに window server をインストールした</a></h1><div class=post-meta><time class=post-date>2024-01-18</time></div><span class=post-tags>#<a href=/diary/tags/ldap/>ldap</a>&nbsp;
#<a href=/diary/tags/cli/>cli</a>&nbsp;
#<a href=/diary/tags/virtualization/>virtualization</a>&nbsp;
#<a href=/diary/tags/windows/>windows</a>&nbsp;
#<a href=/diary/tags/active-directory/>active directory</a>&nbsp;
#<a href=/diary/tags/event/>event</a>&nbsp;</span><div class=post-content><p>1時過ぎに寝て6時半に起きた。久しぶりによく眠れた。6時半に起きてたのに8時ぐらいまでだらだらしてた。</p><p>今日の筋トレは腹筋:20x1,腕立て:15x1,スクワット20x1をした。</p><h2 id=windows-server-2022-試用版のインストール>windows server 2022 試用版のインストール</h2><p><a href=https://www.microsoft.com/ja-jp/evalcenter/evaluate-windows-server-2022>Windows Server 2022</a> の試用版が提供されていると知ったのでローカルの <a href=https://www.virtualbox.org/>VirtualBox</a> 環境にインストールしてみた。Active Directory の検証に使うのでディレクトサービスや ldaps 接続のための証明書サービスなどを設定する。メンバーがインストールして課題管理システムにメモを残してくれてあったのでそれを見ながらインストールや設定自体はすぐにできた。1つだけうまく接続できないことがあった。</p><p>ホスト os から ldapsearch で ldaps で接続しようとすると次のようなエラーになる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ldapsearch -x -H <span style=color:#e6db74>&#34;ldaps://192.168.56.101&#34;</span> -W -b <span style=color:#e6db74>&#34;CN=Users,DC=myad,DC=com&#34;</span> -D <span style=color:#e6db74>&#34;CN=Administrator,CN=Users,DC=myad,DC=com&#34;</span>
</span></span><span style=display:flex><span>ldap_sasl_bind<span style=color:#f92672>(</span>SIMPLE<span style=color:#f92672>)</span>: Can<span style=color:#960050;background-color:#1e0010>&#39;</span>t contact LDAP server <span style=color:#f92672>(</span>-1<span style=color:#f92672>)</span>
</span></span></code></pre></div><p>ldap では接続できるので tls の検証のチェックに失敗していることは自明だったが、メンバーは接続できているようにみえたので私の環境の設定が誤っているのかどうかを調べていた。2時間ぐらいデバッグしたりしながら調べてもよくわからなくて、たまたまチーム勉強会があったので終わったときにメンバーに聞いてみた。すぐに完結した。ldapsearch は <code>LDAPTLS_REQCERT</code> という環境変数で tls のリクエストの振る舞いを制御できる。次のように明示的に指定すると接続できる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ LDAPTLS_REQCERT<span style=color:#f92672>=</span>never ldapsearch -x -H <span style=color:#e6db74>&#34;ldaps://192.168.56.101&#34;</span> ...
</span></span></code></pre></div><p>この設定はいくつかの方法で設定ファイルに書いておくこともできる。メンバーが使っている環境には <code>ldap.conf</code> でこの設定を有効にしていたので ldaps 接続できていたというオチだった。私が openldap について明るくないのでこういった背景知識をもっていなくてはまっていただけだった。</p><pre tabindex=0><code>Thus the following files and variables are read, in order:
    variable     $LDAPNOINIT, and if that is not set:
    system file  /etc/openldap/ldap.conf,
    user files   $HOME/ldaprc,  $HOME/.ldaprc,  ./ldaprc,
    system file  $LDAPCONF,
    user files   $HOME/$LDAPRC, $HOME/.$LDAPRC, ./$LDAPRC,
    variables    $LDAP&lt;uppercase option name&gt;.
Settings late in the list override earlier ones.
</code></pre><h2 id=明石海峡大橋海上ウォーク>明石海峡大橋海上ウォーク</h2><p>神戸ジャーナルの記事をみかけて、そういうイベントがあるのは知っていた。</p><ul><li><a href=https://kaijo-uzushio-walk.jp/>神戸淡路鳴門自動車道 2橋ウォーク同時開催！ 明石海峡大橋海上ウォーク/大鳴門橋うずしおウォーク 令和6年3月9日(土)・10日(日)</a></li></ul><p>開発合宿の翌週だし、わざわざ行くほどでもないかとスルーしていたものの、関東から知人がわざわざ歩きに来るという話しを聞いて、せっかくの機会なので私も参加することにした。土曜日の午前中に明石海峡大橋を歩いてくる。まだ申込みが始まったばかりなので希望の時間帯を選択できると思う。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0110/>vhs コマンドの使い方</a></h1><div class=post-meta><time class=post-date>2024-01-10</time></div><span class=post-tags>#<a href=/diary/tags/svelte/>svelte</a>&nbsp;
#<a href=/diary/tags/cli/>cli</a>&nbsp;</span><div class=post-content><p>23時過ぎに寝始めて何度か起きて7時半に起きた。</p><p>今日の筋トレは腹筋:10x1,腕立て:10x1,スクワット15x1をした。</p><h2 id=sveltekit-で-context-のデータを扱う>sveltekit で context のデータを扱う</h2><p>ui 側でページに依存しない形で設定情報などを扱いたいとする。svelte の store と context api を組み合わせて sveltekit として context を管理するサンプルコードが紹介されている。</p><ul><li><a href=https://kit.svelte.jp/docs/state-management#using-stores-with-context>context と共に store を使う</a></li></ul><p>これだけですぐ動くのだけど、このときに <code>LayoutData</code> はサーバー側で作るとバックエンドの仕組みを隠蔽できて嬉しい。そういったときは <code>src/routes/+layout.server.ts</code> にバックエンドの api 呼び出しを隠蔽することで意図した振る舞いになる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#66d9ef>type</span> { <span style=color:#a6e22e>LayoutServerLoad</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;./$types&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>load</span>: <span style=color:#66d9ef>LayoutServerLoad</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>async</span> () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>r</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>fetch</span>(<span style=color:#e6db74>`localhost:18080/myapi`</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>json</span>();
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><h2 id=アニメ-gif-をスクリプトから作る>アニメ gif をスクリプトから作る</h2><p><a href=https://zenn.dev/kou_pg_0131/articles/favorite-cli-tools>お気に入りのコマンドラインツールを淡々と紹介する</a> をみていて <a href=https://github.com/charmbracelet/vhs>vhs</a> という cli でアニメ gif を作ってくれることを知った。試しにやってみた。ターミナルを録画するようなやり方と比べて、録画時にタイプミスしてしまうようなミスを防げる。次のようなスクリプトファイルを新規作成する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ vhs new bf.tape 
</span></span></code></pre></div><pre tabindex=0><code>Output bf.gif

Require echo

Set Shell &#34;bash&#34;
Set FontSize 14
Set Width 800
Set Height 380

Type &#34;genact -m bruteforce&#34; Sleep 500ms  Enter

Sleep 10s
</code></pre><p>あとはこの設定でアニメ gif を作る。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ vhs bf.tape 
</span></span></code></pre></div><figure><img src=/diary/img/2024/0110_bf.gif></figure><p>これで 4.8 MiB なのでサイズはまぁまぁ大きい。サイズやカラーの調整をすればもう1桁は縮小できるかもしれない。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ls -lh img/2024/0110_bf.gif 
</span></span><span style=display:flex><span>-rw-rw-r-- <span style=color:#ae81ff>1</span> 4.8M  1月 <span style=color:#ae81ff>10</span> 19:48 img/2024/0110_bf.gif
</span></span></code></pre></div></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0511/>gitlab issues と mongodb による分析</a></h1><div class=post-meta><time class=post-date>2023-05-11</time></div><span class=post-tags>#<a href=/diary/tags/gitlab/>gitlab</a>&nbsp;
#<a href=/diary/tags/mongodb/>mongodb</a>&nbsp;
#<a href=/diary/tags/cli/>cli</a>&nbsp;</span><div class=post-content><p>0時に寝て何度か起きて7時に起きた。今日も一日資料作りをしていた。</p><h2 id=gitlab-issues-の解析>gitlab issues の解析</h2><p>ふりかえりの資料を作っていて gitlab issues の解析を始めた。gitlab にも分析系機能は提供されているが、大半が有償機能で free では使えない。実質 free で役に立ちそうなレポートを私はみつけられなかった。</p><ul><li><a href=https://docs.gitlab.com/ee/user/analytics/>Analyze GitLab usage</a></li></ul><p>gitlab は <a href=https://gitlab.com/gitlab-org/cli>glab cli</a> というツールを提供している。試しに glab を使って issues の解析ができないかとやってみたが、グループ単位ではなくプロジェクト単位でしか操作できないようにみえた。そこで rest api を呼び出すための便利ツールとして使うことにした。要は rest api で任意のデータを取得してそれを使ってローカルで解析することにした。例えば、次のようにして特定ラベルを除外した特定グループのマイルストーンごとの issues をすべて取得できる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ mygrpid<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;xxx&#34;</span>
</span></span><span style=display:flex><span>$ milestones<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;2022-11 2022-12 2023-01 2023-02 2023-03 2023-04&#34;</span>
</span></span><span style=display:flex><span>$ <span style=color:#66d9ef>for</span> i in $milestones; <span style=color:#66d9ef>do</span> echo $i; glab api --paginate <span style=color:#e6db74>&#34;groups/</span><span style=color:#e6db74>${</span>mygrpid<span style=color:#e6db74>}</span><span style=color:#e6db74>/issues?milestone=</span><span style=color:#e6db74>${</span>i<span style=color:#e6db74>}</span><span style=color:#e6db74>&amp;not[labels]=Duplicate,Invalid,Wontfix&#34;</span> | jq -c <span style=color:#e6db74>&#39;.[]&#39;</span> &gt; <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>i<span style=color:#e6db74>}</span><span style=color:#e6db74>-issues.json&#34;</span>; <span style=color:#66d9ef>done</span>
</span></span></code></pre></div><p>あとはこの json データをそのまま分析のためのデータベースに取り込む。今回は mongodb にインポートしてみた。mongodb だとスキーマを定義しなくても json データをそのままインポートできてアドホックな分析に便利そうに思えた。オブジェクトの入れ子構造をもつ json データのようなものを rdbms にインポートするのはひと工夫必要なことから json データをそのままインポートできるドキュメントデータベースの有効性を理解できた。インポートしたら <a href=https://www.mongodb.com/products/shell>MongoDB Shell</a> を使うとてっとり早い。例えば、マイルストーンごとの issues の件数などは次のようにして集計できる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gitlab&gt; db.issues.aggregate<span style=color:#f92672>([{</span> $group: <span style=color:#f92672>{</span> <span style=color:#e6db74>&#34;_id&#34;</span>: <span style=color:#e6db74>&#34;</span>$milestone<span style=color:#e6db74>.title&#34;</span>, count: <span style=color:#f92672>{</span> <span style=color:#e6db74>&#34;</span>$sum<span style=color:#e6db74>&#34;</span>: <span style=color:#ae81ff>1</span> <span style=color:#f92672>}</span> <span style=color:#f92672>}</span> <span style=color:#f92672>}</span>, <span style=color:#f92672>{</span> $sort: <span style=color:#f92672>{</span> _id: <span style=color:#ae81ff>1</span> <span style=color:#f92672>}}])</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>{</span> _id: <span style=color:#e6db74>&#39;2022-11&#39;</span>, count: <span style=color:#ae81ff>348</span> <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>{</span> _id: <span style=color:#e6db74>&#39;2022-12&#39;</span>, count: <span style=color:#ae81ff>346</span> <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>{</span> _id: <span style=color:#e6db74>&#39;2023-01&#39;</span>, count: <span style=color:#ae81ff>338</span> <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>{</span> _id: <span style=color:#e6db74>&#39;2023-02&#39;</span>, count: <span style=color:#ae81ff>357</span> <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>{</span> _id: <span style=color:#e6db74>&#39;2023-03&#39;</span>, count: <span style=color:#ae81ff>347</span> <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>{</span> _id: <span style=color:#e6db74>&#39;2023-04&#39;</span>, count: <span style=color:#ae81ff>336</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>]</span>
</span></span></code></pre></div><p>担当者別に <code>Enhance</code> ラベルが付いた issues の件数を数えるときには次のようになる。sql を使えないというデメリットを json データをそのままインポートできるメリットの方が上回るときは mongodb のクエリを学ぶ機会になる。私も mongodb の aggregation の実行方法をドキュメントみながらやってた。全然わからないので慣れが必要になる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gitlab&gt; db.issues.aggregate<span style=color:#f92672>([{</span> $group: <span style=color:#f92672>{</span> <span style=color:#e6db74>&#34;_id&#34;</span>: <span style=color:#f92672>{</span> assignee: <span style=color:#e6db74>&#34;</span>$assignee<span style=color:#e6db74>.username&#34;</span>, enhance: <span style=color:#f92672>{</span>$in: <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;Enhance&#34;</span>, <span style=color:#e6db74>&#34;</span>$labels<span style=color:#e6db74>&#34;</span><span style=color:#f92672>]}</span> <span style=color:#f92672>}</span>, count: <span style=color:#f92672>{</span> <span style=color:#e6db74>&#34;</span>$sum<span style=color:#e6db74>&#34;</span>: <span style=color:#ae81ff>1</span> <span style=color:#f92672>}</span> <span style=color:#f92672>}</span> <span style=color:#f92672>}</span>, <span style=color:#f92672>{</span>$match: <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;_id.enhance&#34;</span>: true<span style=color:#f92672>}}</span>, <span style=color:#f92672>{</span> $sort: <span style=color:#f92672>{</span> _id: <span style=color:#ae81ff>1</span> <span style=color:#f92672>}}])</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>{</span> _id: <span style=color:#f92672>{</span> assignee: <span style=color:#e6db74>&#39;bob&#39;</span>, enhance: true <span style=color:#f92672>}</span>, count: <span style=color:#ae81ff>84</span> <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>{</span> _id: <span style=color:#f92672>{</span> assignee: <span style=color:#e6db74>&#39;john&#39;</span>, enhance: true <span style=color:#f92672>}</span>, count: <span style=color:#ae81ff>143</span> <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>{</span> _id: <span style=color:#f92672>{</span> assignee: <span style=color:#e6db74>&#39;mary&#39;</span>, enhance: true <span style=color:#f92672>}</span>, count: <span style=color:#ae81ff>53</span> <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>{</span> _id: <span style=color:#f92672>{</span> assignee: <span style=color:#e6db74>&#39;parks&#39;</span>, enhance: true <span style=color:#f92672>}</span>, count: <span style=color:#ae81ff>78</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>]</span>
</span></span></code></pre></div></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0412/>ローカルのゲスト os に開発環境を作る</a></h1><div class=post-meta><time class=post-date>2023-04-12</time></div><span class=post-tags>#<a href=/diary/tags/virtualization/>virtualization</a>&nbsp;
#<a href=/diary/tags/cli/>cli</a>&nbsp;</span><div class=post-content><p>0時に寝て7時に起きた。いろいろうまくいってない。</p><h2 id=vagrant-再び>vagrant 再び</h2><p>rpm でパッケージングされた openldap サーバーの動作検証をするために vagrant で <a href=https://app.vagrantup.com/rockylinux/boxes/8>rockylinux/8 Vagrant box</a> の環境を構築する。 rockylinux 8 だと次のようなエラーが発生した。</p><pre tabindex=0><code>VBoxManage: error: Failed to open OVF file &#39;path/to/.vagrant.d/boxes/rockylinux-VAGRANTSLASH-8/7.0.0/virtualbox/box.ovf&#39; (VERR_FILE_NOT_FOUND)
</code></pre><p>既知のバグとして次の forum にワークアラウンドが書かれている。</p><ul><li><a href=https://forums.rockylinux.org/t/vagrant-box-rockylinux-8-fails-for-virtualbox-provider-with-error-vbox-e-object-not-found/8228/4>Vagrant box rockylinux/8 fails for virtualbox provider with error VBOX_E_OBJECT_NOT_FOUND</a></li></ul><p>uefi なマシンのせいなのかな？詳細を理解していないけど Vagrantfile を次のようにする。</p><pre tabindex=0><code>Vagrant.configure(&#34;2&#34;) do |config|
  config.vm.box = &#34;rockylinux/8&#34;
  config.vm.provider &#34;virtualbox&#34; do |domain|
    domain.customize [&#34;modifyvm&#34;, :id, &#34;--firmware&#34;, &#34;efi&#34;]
  end
end
</code></pre><p>修正済みのイメージをダウンロードするようにメタデータを作成する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ vi box-metadata.json
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;name&#34;</span> : <span style=color:#e6db74>&#34;rockylinux/8&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;description&#34;</span> : <span style=color:#e6db74>&#34;Rocky Linux 8 7.0.0 Bugfix&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;versions&#34;</span> : [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;version&#34;</span> : <span style=color:#e6db74>&#34;7.0.1-20221213.0&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;providers&#34;</span> : [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;name&#34;</span> : <span style=color:#e6db74>&#34;virtualbox&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;url&#34;</span> : <span style=color:#e6db74>&#34;http://dl.rockylinux.org/pub/rocky/8/images/x86_64/Rocky-8-Vagrant-Vbox-8.7-20221213.0.x86_64.box&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      ]
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>再度 vagrant の環境を作り直す。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ vagrant box add box-metadata.json
</span></span><span style=display:flex><span>$ rm -rf .vagrant/  <span style=color:#75715e># 古い設定を削除</span>
</span></span><span style=display:flex><span>$ vagrant up
</span></span></code></pre></div><p>vagrant を使うのも4年ぶりになるかな。コンテナに慣れてしまうと久しぶり感がある。使い方を忘れていて調べながらやってた。</p><h3 id=vagrant-にポートフォワーディングの設定を追加>vagrant にポートフォワーディングの設定を追加</h3><pre tabindex=0><code>$ vi Vagrantfile
...
  config.vm.network &#34;forwarded_port&#34;, guest: 389, host: 1389   # ldap
  config.vm.network &#34;forwarded_port&#34;, guest: 636, host: 1636   # ldaps
...
</code></pre><p>これでホスト os からゲスト os へ接続できる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>==&gt; default: Forwarding ports...
</span></span><span style=display:flex><span>    default: 389 (guest) =&gt; 1389 (host) (adapter 1)
</span></span><span style=display:flex><span>    default: 636 (guest) =&gt; 1636 (host) (adapter 1)
</span></span><span style=display:flex><span>    default: 22 (guest) =&gt; 2222 (host) (adapter 1)
</span></span></code></pre></div><p>ここでは ldap サーバーに対して <a href=https://directory.apache.org/studio/>Apache Directory Studio</a> で接続できるように ssh のポートフォワーディングを設定している。</p><h3 id=scp-でファイルを転送>scp でファイルを転送</h3><p>config を出力する。ssh の秘密鍵へのパス設定をしてくれるので scp のオプションに指定しなくて済む。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ vagrant ssh-config &gt; ssh.config
</span></span></code></pre></div><p>ポート番号も config に記載されているけれど、それは指定しないと scp できなかった。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ scp -P <span style=color:#ae81ff>2200</span> -F ssh.config path/to/myfile vagrant@localhost:
</span></span></code></pre></div><p>vagrant ユーザーのパスワードも聞かれて vagrant を指定すればコピーできた。config を作ってもあまり便利ではなかった。</p><p><a href=https://github.com/invernizzi/vagrant-scp>vagrant-scp</a> というプラグインがあるのでインストールしてみる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ vagrant plugin install vagrant-scp
</span></span></code></pre></div><p>次のようにして使う。この方が簡単。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ vagrant scp path/to/myfile ./  <span style=color:#75715e># 仮想マシンのホームディレクトリにコピーされる</span>
</span></span></code></pre></div></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0405/>rsync に daemon モードがあるらしい</a></h1><div class=post-meta><time class=post-date>2023-04-05</time></div><span class=post-tags>#<a href=/diary/tags/cli/>cli</a>&nbsp;
#<a href=/diary/tags/security/>security</a>&nbsp;
#<a href=/diary/tags/event/>event</a>&nbsp;
#<a href=/diary/tags/gpt/>gpt</a>&nbsp;</span><div class=post-content><p>23時に寝て2時半に起きて4時や5時に起きて7時に起きた。泊まっているホテルの低反発枕の寝心地がよい。</p><h2 id=rsync-daemon-over-ssh>rsync daemon over ssh</h2><p>外部向けのドキュメントを公開するための gitlab ci/cd を構築した。web サーバにドキュメントをアップロードする手段として rsync を使っている。rsync over ssh でデータを転送するときにさらに daemon モード (rsyncd) という仕組みがあって、権限や書き込み先の acl なども細かく制御できる。手順や設定は古の古臭い雰囲気はするけれど、実用的には ssh の秘密鍵を使ってちょっと高機能なアップロードを実現できる。ssh agent で鍵登録できていれば次のような cli でセキュアに rsync できる。全然知らない方法だったので学びの1つになった。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ rsync <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --verbose <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --rsh ssh <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --stats <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --compress-choice<span style=color:#f92672>=</span>zstd <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --compress-level<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --itemize-changes <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --recursive <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --checksum <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --delete <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    local/ <span style=color:#e6db74>${</span>USER<span style=color:#e6db74>}</span>@<span style=color:#e6db74>${</span>HOST<span style=color:#e6db74>}</span>::<span style=color:#e6db74>${</span>RSYNC_DIR<span style=color:#e6db74>}</span>
</span></span></code></pre></div><ul><li><a href=https://jyn.jp/rsync-daemon-over-ssh/>rsync+sshはdaemonモードを使うと更に安全になる</a></li></ul><h2 id=llmを使ってみる会>LLMを使ってみる会</h2><p><a href=https://fin-py.connpass.com/event/279271/>LLMを使ってみる会</a> に参加した。私も chatgpt に調べものやちょっとしたことを聞くようになったりしているが、他の人たちがどんな用途に使っているのかも知りたくて参加してみた。fin-py のイベントだったのでみんな金融系のドキュメントの要約に使っているのが多そうにみえた。あとは研究テーマとして gpt/llm を取り上げている人たちも何人かいた。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0327/>docker/compose のモジュールの使い方がわかってきた</a></h1><div class=post-meta><time class=post-date>2023-03-27</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/docker/>docker</a>&nbsp;
#<a href=/diary/tags/cli/>cli</a>&nbsp;</span><div class=post-content><p>0時に寝て7時に起きた。前日はバテてだらだらしていたので寝過ぎた。</p><h2 id=案ずるよりもツールできた>案ずるよりもツールできた</h2><p>先週末に <a href=/diary/posts/2023/0324/>docker/compose 関連のライブラリ調査</a> を終えて実際のツール作りをしていた。本当は日曜日に作ってしまおうと思いつつ休んでしまった。なぜか今日はメンバーが全員お休みでチームで私しか働いていなかった。年度末で有休消化しているのかな？問い合わせ対応やメンバーのサポートが不要だったので1日中、自分の開発に集中できた。そして開発に集中できた結果、一通りツールの機能の開発を終えられた。火曜日までには仕上げたいと思っていたのでぎりぎり間に合った。</p><p>最終的に testcontainers-go の compose モジュールを使うのは断念して compose cli のみ go 標準の <a href=https://pkg.go.dev/os/exec>os/exec</a> パッケージを使ってプロセスを fork するようにした。また docker image をコンテナレジストリから取得するときに認証が必要な場合、最初の <a href=https://docs.docker.com/engine/reference/commandline/login/>docker login</a> すると credentials store にパスワード (またはトークン) 情報が記録される。設定情報は <code>$HOME/.docker/config.json</code> からも確認できる。この仕組みを使ってコンテナレジストリへのログインを自動化できる。私の環境では macbook に docker desktop をインストールしているが、普通に使っていると次のように credentials が保存されてその内容を確認できる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ docker-credential-desktop list | jq .
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;https://index.docker.io/v1/&#34;</span>: <span style=color:#e6db74>&#34;t2y1979&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;https://index.docker.io/v1/access-token&#34;</span>: <span style=color:#e6db74>&#34;t2y1979&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;https://index.docker.io/v1/refresh-token&#34;</span>: <span style=color:#e6db74>&#34;t2y1979&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>$ echo <span style=color:#e6db74>&#34;https://index.docker.io/v1/access-token&#34;</span> | docker-credential-desktop get
</span></span><span style=display:flex><span><span style=color:#f92672>{</span><span style=color:#e6db74>&#34;ServerURL&#34;</span>:<span style=color:#e6db74>&#34;https://index.docker.io/v1/access-token&#34;</span>,<span style=color:#e6db74>&#34;Username&#34;</span>:<span style=color:#e6db74>&#34;t2y1979&#34;</span>,<span style=color:#e6db74>&#34;Secret&#34;</span>:<span style=color:#e6db74>&#34;***&#34;</span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>これと同じことを docker のライブラリで行うには次のようにする。取得したい docker image の uri を参照すればコンテナレジストリがわかる。そこからこの cli でやっているようなことを順番にやっていけばよい。これらのユーティリティは3つのリポジトリで管理されていて、この雰囲気をみただけでもこのモジュール分割が本当に適切なんやろか？とか思ったりもする。</p><ul><li><a href=https://github.com/distribution/distribution>https://github.com/distribution/distribution</a></li><li><a href=https://github.com/docker/cli>https://github.com/docker/cli</a></li><li><a href=https://github.com/moby/moby>https://github.com/moby/moby</a></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>getRegistryAuthFromImage</span>(
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>imageURI</span> <span style=color:#66d9ef>string</span>,
</span></span><span style=display:flex><span>) (<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ref</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>reference</span>.<span style=color:#a6e22e>ParseNormalizedNamed</span>(<span style=color:#a6e22e>imageURI</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to parse image uri: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>repo</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>ParseRepositoryInfo</span>(<span style=color:#a6e22e>ref</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to parse repository: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>dcli</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>command</span>.<span style=color:#a6e22e>NewDockerCli</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to create docker cli: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>auth</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>command</span>.<span style=color:#a6e22e>ResolveAuthConfig</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>dcli</span>, <span style=color:#a6e22e>repo</span>.<span style=color:#a6e22e>Index</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>encoded</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>command</span>.<span style=color:#a6e22e>EncodeAuthToBase64</span>(<span style=color:#a6e22e>auth</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to encode auth: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>encoded</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0926/>postgresql の json データ型</a></h1><div class=post-meta><time class=post-date>2022-09-26</time></div><span class=post-tags>#<a href=/diary/tags/postgresql/>postgresql</a>&nbsp;
#<a href=/diary/tags/java/>java</a>&nbsp;
#<a href=/diary/tags/cli/>cli</a>&nbsp;</span><div class=post-content><p>1時に寝て6時半に起きた。連休中に夜更ししてたから生活が乱れた。</p><h2 id=ロガー向けのログ保存-api-の開発>ロガー向けのログ保存 API の開発</h2><p>先週の休暇前にやっていた作業の開発に着手。一通り web api のエンドポイントの実装は終えてテストをあらかた書いたところ。いまのプロジェクトとしても、過去の私の経験としてもやったことのない新しい挑戦の1つとして postgresql の <a href=https://www.postgresql.jp/document/13/html/datatype-json.html>JSONデータ型</a> を使う。具体的には json 型と jsonb 型の2つがある。前者はテキストで保持する型で、後者は内部的にバイナリに変換されてインデックスも使える。バイナリに変換してインデックスを作る分、insert 時にテキストで保存するよりは少し余分なオーバーヘッドを要する。json のデータを参照用途で使うのか、検索するのかでこれらの型を使い分ければいいのかな。</p><p>実際の sql で json データの条件指定は次のようになる。<code>@></code> というみたこともない気持ち悪い演算子を使う。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>select</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> mytable <span style=color:#66d9ef>where</span> <span style=color:#66d9ef>data</span>  <span style=color:#f92672>@&gt;</span> <span style=color:#e6db74>&#39;{&#34;x&#34;: 1, &#34;y&#34;: 2}&#39;</span>;
</span></span></code></pre></div><p>java の jdbc で扱うには <em>PGobject</em> という型に変換して扱う必要がある。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> PGobject <span style=color:#a6e22e>convertData</span>(String value) <span style=color:#66d9ef>throws</span> SQLException {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> data <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> PGobject();
</span></span><span style=display:flex><span>    data.<span style=color:#a6e22e>setType</span>(<span style=color:#e6db74>&#34;jsonb&#34;</span>);
</span></span><span style=display:flex><span>    data.<span style=color:#a6e22e>setValue</span>(value);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> data;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>余談だけど、curl で json 文字列を query string としてリクエストするには url encode しないといけない。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -s --get --data-urlencode <span style=color:#e6db74>&#39;data={&#34;x&#34;: 1, &#34;y&#34;: 2}&#39;</span> http://localhost/path | jq .
</span></span></code></pre></div></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0622/>k8s の cronjob を検証中</a></h1><div class=post-meta><time class=post-date>2022-06-22</time></div><span class=post-tags>#<a href=/diary/tags/kubernetes/>kubernetes</a>&nbsp;
#<a href=/diary/tags/cli/>cli</a>&nbsp;</span><div class=post-content><p>0時に寝て6時に起きた。寝不足を解消して体調が戻ってきた。</p><h2 id=k8s-の-cronjob>k8s の cronjob</h2><p>バッチ処理を <a href=https://kubernetes.io/docs/concepts/workloads/controllers/cron-jobs/>Kubernetes: CronJob</a> で作る。一通り設定して minikube で検証して eks 上でも動くようになった。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>batch/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>CronJob</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>my-app-hourly-job</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>schedule</span>: <span style=color:#e6db74>&#34;5 */1 * * *&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>concurrencyPolicy</span>: <span style=color:#ae81ff>Forbid</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>startingDeadlineSeconds</span>: <span style=color:#ae81ff>600</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>jobTemplate</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>backoffLimit</span>: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>app</span>: <span style=color:#ae81ff>my-app-hourly</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>annotations</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>dapr.io/enabled</span>: <span style=color:#e6db74>&#34;true&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>dapr.io/app-id</span>: <span style=color:#e6db74>&#34;my-app-hourly&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>          - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>my-app-hourly-job</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>image</span>: <span style=color:#ae81ff>my-app-image</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>imagePullPolicy</span>: <span style=color:#ae81ff>Always</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>env</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>BATCH_ENV</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#34;dev&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>command</span>:
</span></span><span style=display:flex><span>            - <span style=color:#e6db74>&#34;/bin/sh&#34;</span>
</span></span><span style=display:flex><span>            - <span style=color:#e6db74>&#34;/app/scripts/my-app.sh&#34;</span>
</span></span><span style=display:flex><span>            - <span style=color:#e6db74>&#34;param1&#34;</span>
</span></span><span style=display:flex><span>            - <span style=color:#e6db74>&#34;param2&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>restartPolicy</span>: <span style=color:#ae81ff>Never</span>
</span></span></code></pre></div><p>command の設定がわかりにくい。さらに k8s のドキュメントのサンプル設定も誤解を招くような例になっている。どうも実行できるのは1つの cli だけで、複数コマンドを指定できるわけではない。シェルスクリプトを docker イメージに含めて、そこで任意のスクリプトを実装した方がよいだろう。</p><ul><li>&ldquo;/bin/sh&rdquo;</li><li>&ldquo;/app/scripts/my-app.sh&rdquo;</li><li>&ldquo;param1&rdquo;</li><li>&ldquo;param2&rdquo;</li></ul><p>この設定は次の cli として実行される。</p><blockquote><p>/bin/sh /app/scripts/my-app.sh param1 param2</p></blockquote><p><a href=https://stackoverflow.com/questions/51657105/how-to-ensure-kubernetes-cronjob-does-not-restart-on-failure>How to ensure kubernetes cronjob does not restart on failure</a> によると、バッチ処理が失敗したときに再実行したくないときは次の3つの設定をする。</p><ul><li>concurrencyPolicy: Forbid</li><li>backoffLimit: 0</li><li>restartPolicy: Never</li></ul><p>restartPolicy が Never 以外だと、エラーが発生すると永遠に再実行されてしまうので障害時に2次被害を増やしてしまう懸念があったような気がする。</p><p>あと、うちの環境は dapr 経由で他の pod サービスと通信しているので dapr を有効にしないと pod 間通信ができない。dapr はデーモンでずっと起動しているからバッチ処理の終了時に daprd も shutdown してやらないといけない。<a href=https://docs.dapr.io/operations/hosting/kubernetes/kubernetes-job/>Running Dapr with a Kubernetes Job</a> にその方法が書いてある。daprd を shutdown しないと、pod のステータスが NotReady のままで Completed にならない。</p><p>まだまだよくわかってないので <a href=https://kubernetes.io/docs/concepts/workloads/controllers/job/>Jobs</a> のドキュメントに一通り目を通そうと思っている。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0621/>maven で executable jar を作る</a></h1><div class=post-meta><time class=post-date>2022-06-21</time></div><span class=post-tags>#<a href=/diary/tags/cli/>cli</a>&nbsp;
#<a href=/diary/tags/maven/>maven</a>&nbsp;
#<a href=/diary/tags/java/>java</a>&nbsp;</span><div class=post-content><p>4時に寝て7時に起きた。</p><h2 id=maven-での-executable-jar-の作り方>maven での executable jar の作り方</h2><p>gradle では作ったことがあったけど、maven では初めてなので要領がわかっていない。</p><ul><li><a href=https://www.baeldung.com/executable-jar-with-maven>How to Create an Executable JAR with Maven</a></li><li><a href=https://stackoverflow.com/questions/574594/how-can-i-create-an-executable-jar-with-dependencies-using-maven>How can I create an executable JAR with dependencies using Maven?</a></li></ul><p>これらの記事を読むと、<a href=https://maven.apache.org/plugins/maven-assembly-plugin/>maven-assembly-plugin</a> を使えばいいのかな？とまずはこのプラグインで検証を始めた。古くからあるプラグインなので実績は十分なのだけど、もうあまり保守されていないのか、他プラグインから jar のマニフェストに書き込んで git のリビジョン番号が連携できてなかったり、通常の jar の生成処理を置き換えられなかったりと、あまり使い勝手のよいものではなかった。あと log4j2 と相性が悪くて意図したように設定ファイルを読み込んで初期化ができない。</p><pre tabindex=0><code>main ERROR Error processing element EcsLayout: CLASS_NOT_FOUND
main ERROR Unable to locate plugin type for EcsLayout
main ERROR Unable to locate plugin for EcsLayout
main ERROR Could not create plugin of type class org.apache.logging.log4j.core.appender.ConsoleAppender for element Console:
  java.lang.NullPointerException: Cannot invoke &#34;org.apache.logging.log4j.core.config.plugins.util.PluginType.getElementName()&#34;
  because &#34;childType&#34; is null java.lang.NullPointerException:
    Cannot invoke &#34;org.apache.logging.log4j.core.config.plugins.util.PluginType.getElementName()&#34; because &#34;childType&#34; is null
</code></pre><p>この厄介な問題をデバッグするよりも、すでにうまくいくことがわかっている <a href=https://docs.spring.io/spring-boot/docs/current/maven-plugin/reference/htmlsingle/>spring-boot-maven-plugin</a> を使った方が簡単そうだったのでそうすることにした。不要な spring boot 関連の jar なども executable jar や docker イメージに含まれてしまうことだけがデメリット。そこだけ目を瞑れば log4j2 の初期化エラーも起きず、正常に動作した。やっぱり最近のアプリケーションで使われているプラグインはちゃんとしてるねみたいな話しにしておく。次の設定だけでうまくいった。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;plugin&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>spring-boot-maven-plugin<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;configuration&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;mainClass&gt;</span>com.example.myapp.Main<span style=color:#f92672>&lt;/mainClass&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/configuration&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;executions&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;execution&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;goals&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;goal&gt;</span>repackage<span style=color:#f92672>&lt;/goal&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;/goals&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;/execution&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/executions&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/plugin&gt;</span>
</span></span></code></pre></div></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0620/>log4j2 の設定ファイルの動的な読み込み</a></h1><div class=post-meta><time class=post-date>2022-06-20</time></div><span class=post-tags>#<a href=/diary/tags/java/>java</a>&nbsp;
#<a href=/diary/tags/cli/>cli</a>&nbsp;
#<a href=/diary/tags/logging/>logging</a>&nbsp;
#<a href=/diary/tags/tax/>tax</a>&nbsp;</span><div class=post-content><p>0時に寝て7時に起きた。</p><h2 id=バッチ処理モジュール>バッチ処理モジュール</h2><p>cli でバッチ処理モジュールを作った。コマンドラインの引数パーサーと yml のパーサーを使うことにした。</p><ul><li><a href=https://picocli.info/>picocli</a></li><li><a href=https://bitbucket.org/snakeyaml/>snakeyaml</a></li></ul><p>ロガー実装に <a href=https://logging.apache.org/log4j/2.x/>log4j2</a> を使っているので設定ファイルはアプリケーションの設定ファイルと log4j2 の設定ファイルの2つになる。それぞれ環境ごとに用意してエントリーポイントから起動したタイミングで明示的に設定ファイルを読み込むようにした。</p><p>log4j2 の yml 設定ファイルを動的にどうやって設定するかはドキュメントにもとくに書いてなかった気がする。log4j2 のソースコードやテストコードを読みながら次のようにしたら反映された。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> Config <span style=color:#a6e22e>load</span>(BatchEnvironment env) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> path <span style=color:#f92672>=</span> String.<span style=color:#a6e22e>format</span>(<span style=color:#e6db74>&#34;config-%s.yml&#34;</span>, env.<span style=color:#a6e22e>getName</span>());
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> inputStream <span style=color:#f92672>=</span> ConfigUtil.<span style=color:#a6e22e>class</span>.<span style=color:#a6e22e>getClassLoader</span>().<span style=color:#a6e22e>getResourceAsStream</span>(path);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> yaml <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Yaml(<span style=color:#66d9ef>new</span> Constructor(Config.<span style=color:#a6e22e>class</span>));
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> yaml.<span style=color:#a6e22e>load</span>(inputStream);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>アプリケーションの設定は yml 設定に対応する <code>Config</code> クラスを定義しておいて次のようにして読み込む。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>initializeLogSettings</span>(BatchEnvironment env) <span style=color:#66d9ef>throws</span> IOException {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> path <span style=color:#f92672>=</span> String.<span style=color:#a6e22e>format</span>(<span style=color:#e6db74>&#34;log4j2-%s.yml&#34;</span>, env.<span style=color:#a6e22e>getName</span>());
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> inputStream <span style=color:#f92672>=</span> ConfigUtil.<span style=color:#a6e22e>class</span>.<span style=color:#a6e22e>getClassLoader</span>().<span style=color:#a6e22e>getResourceAsStream</span>(path);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> source <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ConfigurationSource(inputStream);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> configuration <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> YamlConfigurationFactory().<span style=color:#a6e22e>getConfiguration</span>(<span style=color:#66d9ef>null</span>, source);
</span></span><span style=display:flex><span>    Configurator.<span style=color:#a6e22e>initialize</span>(configuration);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ちょっとした cli を作るときにちょっとしたライブラリがあると楽でよい。</p><h2 id=欠損金の繰り戻し還付の申請の誤り>欠損金の繰り戻し還付の申請の誤り</h2><p>国税局から電話がかかってきた。初めて提出した欠損金の繰り戻し還付の申請があちこち間違ってますよと。申請書類と一緒に法人税の申告書もみてもらっていて、還付申請した金額も申告の別表1に記入する必要があって、それも一緒に修正してねという話し。法人税の修正申告と還付の訂正依頼の2つが必要とのこと。税務署の人たちは本当に丁寧で親切にあれが間違っている、これが間違っていると教えてくれる。素人が法人決算やっているので初めて行う手続きの間違いはつきものだけど、税務署の人たちが教えてくれるので本当に助かる。感謝。</p></div></article><div class=pagination><div class=pagination__buttons></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>© 2021 Tetsuya Morimoto</span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>