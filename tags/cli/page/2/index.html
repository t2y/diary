<!doctype html><html lang=en><head><title>cli :: forest nook</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/tags/cli/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="cli"><meta property="og:description" content><meta property="og:url" content="/diary/tags/cli/"><meta property="og:site_name" content="forest nook"><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/tags/cli/index.xml rel=alternate type=application/rss+xml title="forest nook"></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><div class=posts><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0621/>maven で executable jar を作る</a></h1><div class=post-meta><time class=post-date>2022-06-21 (Tue.) ::</time></div><span class=post-tags>#<a href=/diary/tags/cli/>cli</a>&nbsp;
#<a href=/diary/tags/maven/>maven</a>&nbsp;
#<a href=/diary/tags/java/>java</a>&nbsp;</span><div class=post-content><p>4時に寝て7時に起きた。</p><h2 id=maven-での-executable-jar-の作り方>maven での executable jar の作り方</h2><p>gradle では作ったことがあったけど、maven では初めてなので要領がわかっていない。</p><ul><li><a href=https://www.baeldung.com/executable-jar-with-maven>How to Create an Executable JAR with Maven</a></li><li><a href=https://stackoverflow.com/questions/574594/how-can-i-create-an-executable-jar-with-dependencies-using-maven>How can I create an executable JAR with dependencies using Maven?</a></li></ul><p>これらの記事を読むと、<a href=https://maven.apache.org/plugins/maven-assembly-plugin/>maven-assembly-plugin</a> を使えばいいのかな？とまずはこのプラグインで検証を始めた。古くからあるプラグインなので実績は十分なのだけど、もうあまり保守されていないのか、他プラグインから jar のマニフェストに書き込んで git のリビジョン番号が連携できてなかったり、通常の jar の生成処理を置き換えられなかったりと、あまり使い勝手のよいものではなかった。あと log4j2 と相性が悪くて意図したように設定ファイルを読み込んで初期化ができない。</p><pre tabindex=0><code>main ERROR Error processing element EcsLayout: CLASS_NOT_FOUND
main ERROR Unable to locate plugin type for EcsLayout
main ERROR Unable to locate plugin for EcsLayout
main ERROR Could not create plugin of type class org.apache.logging.log4j.core.appender.ConsoleAppender for element Console:
  java.lang.NullPointerException: Cannot invoke &#34;org.apache.logging.log4j.core.config.plugins.util.PluginType.getElementName()&#34;
  because &#34;childType&#34; is null java.lang.NullPointerException:
    Cannot invoke &#34;org.apache.logging.log4j.core.config.plugins.util.PluginType.getElementName()&#34; because &#34;childType&#34; is null
</code></pre><p>この厄介な問題をデバッグするよりも、すでにうまくいくことがわかっている <a href=https://docs.spring.io/spring-boot/docs/current/maven-plugin/reference/htmlsingle/>spring-boot-maven-plugin</a> を使った方が簡単そうだったのでそうすることにした。不要な spring boot 関連の jar なども executable jar や docker イメージに含まれてしまうことだけがデメリット。そこだけ目を瞑れば log4j2 の初期化エラーも起きず、正常に動作した。やっぱり最近のアプリケーションで使われているプラグインはちゃんとしてるねみたいな話しにしておく。次の設定だけでうまくいった。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;plugin&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>spring-boot-maven-plugin<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;configuration&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;mainClass&gt;</span>com.example.myapp.Main<span style=color:#f92672>&lt;/mainClass&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/configuration&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;executions&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;execution&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;goals&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;goal&gt;</span>repackage<span style=color:#f92672>&lt;/goal&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;/goals&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;/execution&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/executions&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/plugin&gt;</span>
</span></span></code></pre></div></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0620/>log4j2 の設定ファイルの動的な読み込み</a></h1><div class=post-meta><time class=post-date>2022-06-20 (Mon.) ::</time></div><span class=post-tags>#<a href=/diary/tags/java/>java</a>&nbsp;
#<a href=/diary/tags/cli/>cli</a>&nbsp;
#<a href=/diary/tags/logging/>logging</a>&nbsp;
#<a href=/diary/tags/tax/>tax</a>&nbsp;</span><div class=post-content><p>0時に寝て7時に起きた。</p><h2 id=バッチ処理モジュール>バッチ処理モジュール</h2><p>cli でバッチ処理モジュールを作った。コマンドラインの引数パーサーと yml のパーサーを使うことにした。</p><ul><li><a href=https://picocli.info/>picocli</a></li><li><a href=https://bitbucket.org/snakeyaml/>snakeyaml</a></li></ul><p>ロガー実装に <a href=https://logging.apache.org/log4j/2.x/>log4j2</a> を使っているので設定ファイルはアプリケーションの設定ファイルと log4j2 の設定ファイルの2つになる。それぞれ環境ごとに用意してエントリーポイントから起動したタイミングで明示的に設定ファイルを読み込むようにした。</p><p>log4j2 の yml 設定ファイルを動的にどうやって設定するかはドキュメントにもとくに書いてなかった気がする。log4j2 のソースコードやテストコードを読みながら次のようにしたら反映された。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> Config <span style=color:#a6e22e>load</span><span style=color:#f92672>(</span>BatchEnvironment env<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    var path <span style=color:#f92672>=</span> String<span style=color:#f92672>.</span><span style=color:#a6e22e>format</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;config-%s.yml&#34;</span><span style=color:#f92672>,</span> env<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    var inputStream <span style=color:#f92672>=</span> ConfigUtil<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getClassLoader</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getResourceAsStream</span><span style=color:#f92672>(</span>path<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    var yaml <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Yaml<span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> Constructor<span style=color:#f92672>(</span>Config<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> yaml<span style=color:#f92672>.</span><span style=color:#a6e22e>load</span><span style=color:#f92672>(</span>inputStream<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>アプリケーションの設定は yml 設定に対応する <code>Config</code> クラスを定義しておいて次のようにして読み込む。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>initializeLogSettings</span><span style=color:#f92672>(</span>BatchEnvironment env<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    var path <span style=color:#f92672>=</span> String<span style=color:#f92672>.</span><span style=color:#a6e22e>format</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;log4j2-%s.yml&#34;</span><span style=color:#f92672>,</span> env<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    var inputStream <span style=color:#f92672>=</span> ConfigUtil<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getClassLoader</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getResourceAsStream</span><span style=color:#f92672>(</span>path<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    var source <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ConfigurationSource<span style=color:#f92672>(</span>inputStream<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    var configuration <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> YamlConfigurationFactory<span style=color:#f92672>().</span><span style=color:#a6e22e>getConfiguration</span><span style=color:#f92672>(</span><span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> source<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    Configurator<span style=color:#f92672>.</span><span style=color:#a6e22e>initialize</span><span style=color:#f92672>(</span>configuration<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>ちょっとした cli を作るときにちょっとしたライブラリがあると楽でよい。</p><h2 id=欠損金の繰り戻し還付の申請の誤り>欠損金の繰り戻し還付の申請の誤り</h2><p>国税局から電話がかかってきた。初めて提出した欠損金の繰り戻し還付の申請があちこち間違ってますよと。申請書類と一緒に法人税の申告書もみてもらっていて、還付申請した金額も申告の別表1に記入する必要があって、それも一緒に修正してねという話し。法人税の修正申告と還付の訂正依頼の2つが必要とのこと。税務署の人たちは本当に丁寧で親切にあれが間違っている、これが間違っていると教えてくれる。素人が法人決算やっているので初めて行う手続きの間違いはつきものだけど、税務署の人たちが教えてくれるので本当に助かる。感謝。</p></div></article><div class=pagination><div class=pagination__buttons><a href=/diary/tags/cli/ class="button previous"><span class=button__icon>←</span>
<span class=button__text>最近の日記</span></a></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>© 2021 Tetsuya Morimoto</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>