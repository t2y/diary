<!doctype html><html lang=en><head><title>普通の休日の翌日 :: </title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="5時に寝て10時に起きた。昨日は夕方に2-3時間寝てたのでその分、夜に調べものをしていた。休みたい気持ちもあるけど、調べるものが多過ぎて全然時間が足りない。
bizpy 勉強会の資料作り 昨日 の続き。昨日サンプルコードを実装したので、その設定や要点を 資料 に作成した。現時点で Python で Slack のインテグレーションをやってみる勉強会 #2 の参加者は10人。連続シリーズは回を重ねるごとに減っていくものなのでこんなもんかな。あともう1回やったら終わりにする。
udemy: Kubernetes入門 友だちから udemy の k8s のコースがよいと聞いたんだけど、そのコースはいまは提供されていなくて、せっかくなので適当に検索してヒットした Kubernetes入門 を受講することに決めた。本当は英語の本格的なコースを受講した方がよいのだろうけど、余裕のあるときはそれでいいけど、いま数日で概要を把握して使えるようにしたいので日本語のコースにしてみた。
Udemy の Learning Docker and Kubernetes by Lab がとてもよい Docker, Kubernetes 学習とツールとコンピュータサイエンス 昨日インストールした minikube のクラスターを使って「Kubernetes入門」のセクション1からセクション5までやった。だいたい半分ぐらい。所感としては、全く何も知らない人には要点をかいつまんで教えてくれるのと、最初に覚えるとよい基本的な CLI のコマンドとその振る舞いや設定を紹介してくれるのでよかった。初めて k8s に挑戦する自分にとってはちょうどよいレベル感だった。全体像の概念を捉えてコンテキストに沿って順番にハンズオン形式で学習していくスタイル。nakamasato/kubernetes-basics を使って自分でも CLI でコマンドを打ちながら進めてみた。yaml ファイルを定義するのもこれはこれで面倒だけど、この辺は慣れの問題かな？とも思う。いくつか学んだことを整理しておく。
セクション1 Introduction k8s には2つのコンポーネントがあり、これを k8s クラスターと呼んでいる。
Control Plane (API サーバー) 複数の Worker (Kubelet) yaml で設定する Desired State (理想状態) と呼ばれる設定が登録されると、Control Plane の API サーバーと Worker の kubelet が通信してそれを実現しようとする。pod とは k8s のデプロイの最小単位となる。コンテナ、ポート、レプリカ数などを設定する。pod をそれぞれの Worker にデプロイしたり、Worker がダウンしたときに別の Worker で起動させたりする。"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/posts/2021/1107/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="普通の休日の翌日"><meta property="og:description" content="5時に寝て10時に起きた。昨日は夕方に2-3時間寝てたのでその分、夜に調べものをしていた。休みたい気持ちもあるけど、調べるものが多過ぎて全然時間が足りない。
bizpy 勉強会の資料作り 昨日 の続き。昨日サンプルコードを実装したので、その設定や要点を 資料 に作成した。現時点で Python で Slack のインテグレーションをやってみる勉強会 #2 の参加者は10人。連続シリーズは回を重ねるごとに減っていくものなのでこんなもんかな。あともう1回やったら終わりにする。
udemy: Kubernetes入門 友だちから udemy の k8s のコースがよいと聞いたんだけど、そのコースはいまは提供されていなくて、せっかくなので適当に検索してヒットした Kubernetes入門 を受講することに決めた。本当は英語の本格的なコースを受講した方がよいのだろうけど、余裕のあるときはそれでいいけど、いま数日で概要を把握して使えるようにしたいので日本語のコースにしてみた。
Udemy の Learning Docker and Kubernetes by Lab がとてもよい Docker, Kubernetes 学習とツールとコンピュータサイエンス 昨日インストールした minikube のクラスターを使って「Kubernetes入門」のセクション1からセクション5までやった。だいたい半分ぐらい。所感としては、全く何も知らない人には要点をかいつまんで教えてくれるのと、最初に覚えるとよい基本的な CLI のコマンドとその振る舞いや設定を紹介してくれるのでよかった。初めて k8s に挑戦する自分にとってはちょうどよいレベル感だった。全体像の概念を捉えてコンテキストに沿って順番にハンズオン形式で学習していくスタイル。nakamasato/kubernetes-basics を使って自分でも CLI でコマンドを打ちながら進めてみた。yaml ファイルを定義するのもこれはこれで面倒だけど、この辺は慣れの問題かな？とも思う。いくつか学んだことを整理しておく。
セクション1 Introduction k8s には2つのコンポーネントがあり、これを k8s クラスターと呼んでいる。
Control Plane (API サーバー) 複数の Worker (Kubelet) yaml で設定する Desired State (理想状態) と呼ばれる設定が登録されると、Control Plane の API サーバーと Worker の kubelet が通信してそれを実現しようとする。pod とは k8s のデプロイの最小単位となる。コンテナ、ポート、レプリカ数などを設定する。pod をそれぞれの Worker にデプロイしたり、Worker がダウンしたときに別の Worker で起動させたりする。"><meta property="og:url" content="/diary/posts/2021/1107/"><meta property="og:site_name" content><meta property="og:image" content="/diary/"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:published_time" content="2021-11-07 11:21:21 +0900 +0900"></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=/diary/posts/2021/1107/>普通の休日の翌日</a></h1><div class=post-meta><time class=post-date>2021-11-07</time></div><span class=post-tags>#<a href=/diary/tags/bizpy/>bizpy</a>&nbsp;
#<a href=/diary/tags/kubernetes/>kubernetes</a>&nbsp;</span><div class=post-content><div><p>5時に寝て10時に起きた。昨日は夕方に2-3時間寝てたのでその分、夜に調べものをしていた。休みたい気持ちもあるけど、調べるものが多過ぎて全然時間が足りない。</p><h2 id=bizpy-勉強会の資料作り>bizpy 勉強会の資料作り<a href=#bizpy-勉強会の資料作り class=hanchor arialabel=Anchor>&#8983;</a></h2><p><a href=/diary/posts/2021/1106/#slack-apps-の調査>昨日</a> の続き。昨日サンプルコードを実装したので、その設定や要点を <a href=https://github.com/t2y/python-study/tree/master/BizPy/slack/20211027>資料</a> に作成した。現時点で <a href=https://bizpy.connpass.com/event/229091/>Python で Slack のインテグレーションをやってみる勉強会 #2</a> の参加者は10人。連続シリーズは回を重ねるごとに減っていくものなのでこんなもんかな。あともう1回やったら終わりにする。</p><h2 id=udemy-kubernetes入門>udemy: Kubernetes入門<a href=#udemy-kubernetes入門 class=hanchor arialabel=Anchor>&#8983;</a></h2><p>友だちから udemy の k8s のコースがよいと聞いたんだけど、そのコースはいまは提供されていなくて、せっかくなので適当に検索してヒットした <a href=https://www.udemy.com/course/kubernetes-basics-2021/>Kubernetes入門</a> を受講することに決めた。本当は英語の本格的なコースを受講した方がよいのだろうけど、余裕のあるときはそれでいいけど、いま数日で概要を把握して使えるようにしたいので日本語のコースにしてみた。</p><ul><li><a href=https://blog.ayakumo.net/entry/2018/01/27/010000>Udemy の Learning Docker and Kubernetes by Lab がとてもよい</a></li><li><a href=https://blog.ayakumo.net/entry/2018/02/15/232918>Docker, Kubernetes 学習とツールとコンピュータサイエンス</a></li></ul><p>昨日インストールした minikube のクラスターを使って「Kubernetes入門」のセクション1からセクション5までやった。だいたい半分ぐらい。所感としては、全く何も知らない人には要点をかいつまんで教えてくれるのと、最初に覚えるとよい基本的な CLI のコマンドとその振る舞いや設定を紹介してくれるのでよかった。初めて k8s に挑戦する自分にとってはちょうどよいレベル感だった。全体像の概念を捉えてコンテキストに沿って順番にハンズオン形式で学習していくスタイル。<a href=https://github.com/nakamasato/kubernetes-basics>nakamasato/kubernetes-basics</a> を使って自分でも CLI でコマンドを打ちながら進めてみた。yaml ファイルを定義するのもこれはこれで面倒だけど、この辺は慣れの問題かな？とも思う。いくつか学んだことを整理しておく。</p><h3 id=セクション1-introduction>セクション1 Introduction<a href=#セクション1-introduction class=hanchor arialabel=Anchor>&#8983;</a></h3><p>k8s には2つのコンポーネントがあり、これを k8s クラスターと呼んでいる。</p><ul><li>Control Plane (API サーバー)</li><li>複数の Worker (Kubelet)</li></ul><p>yaml で設定する Desired State (理想状態) と呼ばれる設定が登録されると、Control Plane の API サーバーと Worker の kubelet が通信してそれを実現しようとする。pod とは k8s のデプロイの最小単位となる。コンテナ、ポート、レプリカ数などを設定する。pod をそれぞれの Worker にデプロイしたり、Worker がダウンしたときに別の Worker で起動させたりする。</p><h3 id=セクション2-kubernets-概要>セクション2 Kubernets 概要<a href=#セクション2-kubernets-概要 class=hanchor arialabel=Anchor>&#8983;</a></h3><p>k8s はコンテナ化したアプリケーションのデプロイ、スケーリング、管理を行うためのオープンソースのコンテナオーケストレーションシステムである。</p><ul><li>コンテナ<ul><li>独立した環境でアプリケーションを実行する仕組み</li><li>コンテナの実態はプロセス</li><li>Kernel Namespaces を利用し、プロセスID、ネットワークインターフェース、リソースなどを分離してコンテナ間で干渉しない</li><li>ホストマシンへの依存度を最小化してアプリケーションをどこでも実行可能にする<ul><li>従来のやり方の最大の違いはライブラリがホストマシンにインストールされるのではなく、コンテナの内部にインストールされる</li></ul></li></ul></li><li>オーケストレーション<ul><li>デプロイ、スケーリング、管理などの仕組み</li></ul></li></ul><p>1つのアプリケーションは複数のマシン上で動かすことで可用性を高めたいが、コンテナを動かすために考えることが増えていくと管理コストも増えていく。コンテナオーケストレーション機能により次のようなシステム管理者が行っていたことが自動化される。</p><ul><li>デプロイメント</li><li>スケジューリング</li><li>オートスケーリング<ul><li>負荷に応じてコンテナ数やマシン数を増減させる</li></ul></li><li>ネットワーク</li><li>リソースマネジメント</li><li>セキュリティ<ul><li>ネットワークポリシーやリソースの権限定義</li></ul></li></ul><p>k8s クラスターの構造は次になる。</p><ul><li>Control Plane<ul><li>api: kubelet と通信するサーバー</li><li>etcd: 設定などを格納するキーバリューストア</li><li>shed: kube スケジューラー</li><li>c-m: コントロールマネージャー</li><li>c-c-m: クラウドプロバイダと api 連携する<ul><li>ローカルで使うときは必要ない</li></ul></li></ul></li><li>Worker ノードはコンテナランタイムをいインストールしておく必要がある<ul><li>kubelet は Control Plane と通信するためのエージェントとして動作する</li></ul></li></ul><p>一番需要なこととして、k8s は理想状態と現実状態を比較して、理想状態に近づけようとする。app.yaml の理想状態を kubectl を用いて api サーバーを介して etcd に格納する。現実状態は kubelet から api サーバーを介して etcd に格納される。c-m は理想状態と現実状態のチェックを行い、異なっていれば理想状態に近づけることをしていく。</p><h3 id=セクション4-kubectl>セクション4 kubectl<a href=#セクション4-kubectl class=hanchor arialabel=Anchor>&#8983;</a></h3><p>minikube で最初に起動しているのは Control Plane を起動していることが理解できた。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ minikube start
</span></span><span style=display:flex><span>$ kubectl config current-context
</span></span><span style=display:flex><span>minikube
</span></span></code></pre></div><p>同時に ~/.kube/config に kubectl の設定も追加される。<code>minikube</code> という名前でクラスター、ユーザー、コンテキストが設定される。</p><p>リソース一覧の確認。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl api-resources
</span></span></code></pre></div><p>出力フォーマットも様々。例えば、デフォルトの表示は次になる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl get node
</span></span><span style=display:flex><span>NAME       STATUS   ROLES                  AGE     VERSION
</span></span><span style=display:flex><span>minikube   Ready    control-plane,master   7m21s   v1.22.2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ kubectl get node -o wide
</span></span><span style=display:flex><span>NAME       STATUS   ROLES                  AGE     VERSION   INTERNAL-IP    EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION      CONTAINER-RUNTIME
</span></span><span style=display:flex><span>minikube   Ready    control-plane,master   8m38s   v1.22.2   192.168.49.2   &lt;none&gt;        Ubuntu 20.04.2 LTS   5.11.0-38-generic   docker://20.10.8
</span></span></code></pre></div><p>より詳細な情報をそれぞれのフォーマットで表示する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl get node -o json
</span></span><span style=display:flex><span>$ kubectl get node -o yaml
</span></span></code></pre></div><p>namespace を確認する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl get namespace
</span></span><span style=display:flex><span>NAME              STATUS   AGE
</span></span><span style=display:flex><span>default           Active   10m
</span></span><span style=display:flex><span>kube-node-lease   Active   10m
</span></span><span style=display:flex><span>kube-public       Active   10m
</span></span><span style=display:flex><span>kube-system       Active   10m
</span></span></code></pre></div><p>namespace を指定して pod 一覧を取得する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl get pod --namespace kube-system
</span></span><span style=display:flex><span>NAME                               READY   STATUS    RESTARTS      AGE
</span></span><span style=display:flex><span>coredns-78fcd69978-qxqbn           1/1     Running   <span style=color:#ae81ff>0</span>             11m
</span></span><span style=display:flex><span>etcd-minikube                      1/1     Running   <span style=color:#ae81ff>0</span>             11m
</span></span><span style=display:flex><span>kube-apiserver-minikube            1/1     Running   <span style=color:#ae81ff>0</span>             11m
</span></span><span style=display:flex><span>kube-controller-manager-minikube   1/1     Running   <span style=color:#ae81ff>0</span>             11m
</span></span><span style=display:flex><span>kube-proxy-g55hg                   1/1     Running   <span style=color:#ae81ff>0</span>             11m
</span></span><span style=display:flex><span>kube-scheduler-minikube            1/1     Running   <span style=color:#ae81ff>0</span>             11m
</span></span><span style=display:flex><span>storage-provisioner                1/1     Running   <span style=color:#ae81ff>1</span> <span style=color:#f92672>(</span>10m ago<span style=color:#f92672>)</span>   11m
</span></span></code></pre></div><p>グローバルな CLI のオプションを確認する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl options
</span></span></code></pre></div><p>ノードの詳細を表示する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl describe node
</span></span></code></pre></div><p>describe は名前の接頭辞を指定できるので namespace ならこんな感じに実行できる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl describe namespace kube-
</span></span></code></pre></div><h3 id=セクション5-kubernetes-リソース>セクション5 Kubernetes リソース<a href=#セクション5-kubernetes-リソース class=hanchor arialabel=Anchor>&#8983;</a></h3><p>pod とは k8s 上のデプロイの最小単位である。</p><ul><li>1つまたは複数のコンテナをもつ</li><li>ネットワークやストレージを共有リソースとしてもつ</li><li>コンテナの実行方法に関する仕様をもつ</li></ul><p>pod が使えなくなった場合に他のノードにデプロイされることもある。1つのアプリケーションを複数の pod でデプロイすることが多い。なるべく複数のアプリケーションを1つの pod に入れない。個別の pod を直接操作しない。</p><p>共有コンテキスト</p><ul><li>同一 pod 内のコンテナは同じストレージにアクセスできる</li><li>同一 pod 内のコンテナは ip アドレスとポートを含むネットワーク名前空間を共有する</li></ul><p>k8s オブジェクト</p><ul><li>クラスタの状態を表現する</li><li>2つのフィールドをもつ<ul><li>spec: 理想状態 (desired status)</li><li>status: 現実状態 (current status)</li></ul></li></ul><p>pod の作成は k8s オブジェクトを作成している。オブジェクト作成時の必須フィールドが4つある。</p><ul><li>apiVersion</li><li>kind</li><li>metadata</li><li>spec</li></ul><p>namespace は同一クラスター上で複数の仮想クラスターの動作をサポートする。</p><ul><li>仮想クラスターとは、物理的には同じマシンで動いているかもしれないが、仮想的に環境を分離している<ul><li>1つのクラスターを論理的にわける</li><li>チームや部署ごとにわけて使い分けたりすることも多い</li></ul></li></ul><p>namespace を使うメリットは次になる。</p><ul><li>pod やコンテナのリソースの範囲設定</li><li>namespace 全体の総リソース制限</li><li>権限管理</li></ul><p>初期の namespace として4つあるが、初心者は最初の2つだけをまず覚えておく。</p><ul><li>default:</li><li>kube-system:</li><li>kube-public:</li><li>kube-node-lease</li></ul><p>namespace と cluster の違い。</p><ul><li>Namespace-scoped リソース<ul><li>namespace に属しているリソース</li></ul></li><li>Cluster-scoped リソース<ul><li>クラスター全体で使われるもの</li></ul></li></ul><p>次のコマンドで確認できる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl api-resources --namespaced<span style=color:#f92672>=</span>true 
</span></span></code></pre></div><p>namespace の作成</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl create namespace my-namespace
</span></span></code></pre></div><p>ワークロードリソースとは複数の pod を作成・管理するためのリソース。ワークロードリソースは pod テンプレートを使って pod を作成する。</p><ul><li>ReplicaSet<ul><li>常に指定したレプリカ数の pod を保つ</li></ul></li><li>Deployment<ul><li>ローリングアップデートやロールバックなどのアップデート機能を提供</li><li>ReplicaSet のロールアウト</li><li>不安定な場合の前のバージョンへロールバック</li><li>使用頻度が高い<ul><li>ほとんどのアプリケーションは Deployment で管理</li></ul></li></ul></li><li>Secret<ul><li>機密情報を保存・管理し、Pod から参照可能</li><li>主な使用方法としてコンテナの環境変数の設定<ul><li>アプリケーションの DB のパスワードなどに使う</li></ul></li></ul></li><li>Service<ul><li>pod の集合を抽象化して公開する<ul><li>pod の集合に対する DNS 名</li><li>pod の集合に対する負荷分散</li></ul></li></ul></li></ul></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=/diary/posts/2021/1108/><span class=button__icon>←</span>
<span class=button__text>Kubernetes 使い始めの雑感</span>
</a></span><span class="button next"><a href=/diary/posts/2021/1106/><span class=button__text>普通の休日</span>
<span class=button__icon>→</span></a></span></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2024 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>