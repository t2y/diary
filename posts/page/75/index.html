<!doctype html><html lang=en><head><title>Posts :: </title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/posts/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="Posts"><meta property="og:description" content><meta property="og:url" content="/diary/posts/"><meta property="og:site_name" content><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/posts/index.xml rel=alternate type=application/rss+xml title></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><div class=posts><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0501/>chatbot やめて slack apps</a></h1><div class=post-meta><time class=post-date>2022-05-01 (Sun.) ::</time></div><span class=post-tags>#<a href=/diary/tags/slack/>slack</a>&nbsp;</span><div class=post-content><h2 id=slack-と-backlog-の連携>slack と backlog の連携</h2><p>backlog の rest api を使って課題一覧に定型的なフィルター処理を実行してその結果を slack に通知したい。日々のスクラムイベントで画面をぽちぽちしながらチェックするのにそろそろ飽きてきた。運用が熟れて、みないといけない課題のフィルター条件が明確になったとも言える。こういうのを人間が手作業でフィルターするのをやめて誰でも操作できて、頻繁に目に付くようにすることでメンバーの運用に変化をもたらす。人間の行動や運用を変えるのは並大抵のことではないので、こういった小さな気づきを絶え間なく与え続けることが大事だと私は考えている。気付く人はすぐに気付く。もちろんそうじゃない人もいるが。</p><p><a href=https://backlog.com/integrations/slack/>backlog 公式 slack app</a> は backlog で発生したイベントに対するデータを通知することしかできない。たぶん機能拡張されることもなさそうなので足りない機能は自分で作るしかない。当初は知人が働いている会社の次の記事を読んで <a href=https://aws.amazon.com/jp/chatbot/>aws chatbot</a> を使おうと考えていた。</p><ul><li><a href=https://note.com/nissan_nkm_blog/n/na30a8150ac5d>プロジェクトにChatOpsを導入してみる</a></li></ul><p>いろいろ調べてみると、chatbot は基本的に aws とのサービス連携を前提としたものだとわかった。もちろん lambda と連携することで backlog の rest api を呼び出すことはできるだろうけど、backlog にアクセスしたいだけなら最初から slack apps を自前で作ってそこから backlog の rest api を使った方が構成がシンプルでカスタマイズもしやすいのではないかと思えてきた。slack apps をどこにどうやってデプロイするかは検討課題と言える。lambda にデプロイすることもできるし、専用に ec2 インスタンスを設けてもいいかもしれない。すぐには結論が出ないのでデプロイは作った後で考えることにする。</p><p>次にサードパーティの slack apps のセキュリティはどうやって担保するのだろう？と調べてみた。slack 社もレビューはするけど、セキュリティを保証するものではない。適当にググってみつかった記事を読んでみても、基本的に悪意のない slack apps かどうかを検証する方法はなさそう。slack のメッセージを不正な用途に使われる可能性があるというリスクを受け入れつつ、サードパーティの slack apps をインストールするときに権限が適切かどうかを確認するぐらいしかできない。</p><ul><li><a href=https://api.slack.com/security-review>Slack App Security Review</a></li><li><a href=https://www.polymerhq.io/blog/third-party-apps-on-slack-lurking-data-security-threat/>Third-Party Apps on Slack: Lurking Data Security Threat</a></li></ul><p>従って、サードパーティ製の backlog slack apps を作ろうと思ったらソースコードを公開して悪意がないことを訴求するぐらいしかできることはなさそうにみえる。ソースコードを公開しておけば、それぞれの組織内でデプロイする手段も取れる。当社のプロダクトとしてクラウド上にパブリックに公開するかどうかはある程度、作り込んでから後で考えることにする。github のカスタム action は java で作ったけど、今回は go で作ろうと思う。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0430/>テックブログを更新した</a></h1><div class=post-meta><time class=post-date>2022-04-30 (Sat.) ::</time></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/blog/>blog</a>&nbsp;</span><div class=post-content><p>23時に寝て1時に起きて3時に起きて7時に起きた。</p><h2 id=ストレッチ>ストレッチ</h2><p>今日の開脚幅は開始前162cmで、ストレッチ後163cmだった。先週より少し数値がよくなった。相変わらず背中や腰の張りは強くてストレッチしてもらっていてなかなか辛かった。昨日は祝日だから早めに切り上げてゆっくりしてたし、ワクチン接種後というのもあるけど、最近は睡眠時間を多く取るようにして安静な生活を送ってたりする。それでもどこかしら張りがあったりする。ストレッチを受けると毎日座ってお仕事をすることの負荷を実感できる。</p><p>今日で1年以上ストレッチをしていただいた <a href=/diary/posts/2022/0402/#ストレッチ>トレーナーさんが転勤</a> で最後。おかげで私は健康に過ごせているので感謝しかない。新しい環境でも活躍してほしい。来週から新しいトレーナーさんになる。それはそれで相対比較ができるのでトレーナーさんの違いもわかると思うから楽しみ。</p><h2 id=コミット連携機能の紹介>コミット連携機能の紹介</h2><p>少し前に対応したんだけど、<a href=/diary/posts/2022/0327/#backlog-と-github-のインテグレーション-action>backlog-github-integration-action</a> でコミット連携ができるようになった。</p><ul><li><a href=https://github.com/kazamori/backlog-github-integration-action/pull/2>Add Push subcommand to integrate commits with backlog #2</a></li><li><a href=https://github.com/kazamori/backlog-github-integration-action/pull/3>Add a feature to change the issue status with commit messages (fix, close) #3</a></li></ul><p>そのことをブログの記事にも書くことにした。1時間もあれば書いてしまえる内容なのに英語で書くというだけで後回しにしてしまう。私は英語を書くときは <a href=https://www.grammarly.com/>Grammarly</a> と <a href=https://www.deepl.com/>DeepL</a> を使って書いている。自分の言いたいことを Grammarly で構文チェックしながら書いて、それを DeepL で日本語訳して意味がとれるかどうかで内容があっているかの確認をするといった感じ。</p><ul><li><a href=https://blog.kazamori.jp/commits-integrate-with-backlog-issue>Commits integrate with Backlog issue</a></li></ul></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0429/>第3期のふりかえり</a></h1><div class=post-meta><time class=post-date>2022-04-29 (Fri.) ::</time></div><span class=post-tags>#<a href=/diary/tags/founding/>founding</a>&nbsp;
#<a href=/diary/tags/reflection/>reflection</a>&nbsp;</span><div class=post-content><p>23時に寝て5時に起きた。本当は夜に打ち合わせの資料を作らないといけなかったが、なんかだらだらやってそのまま寝て朝起きてから資料を作り始めた。今日は祝日だから業務委託のお仕事は完全に休むと決めた (非稼働日もデイリースクラムには参加するし、なんだかんだで軽いチケット整理や作業などはしている) 。その分の余裕が資料の作成を先延ばしにした気がする。</p><h2 id=隔週の雑談>隔週の雑談</h2><p>顧問のはらさんと隔週の打ち合わせ。今日の議題は会社の第3期 (前期) のふりかえりにした。半分ぐらいは資料はできていたものの、5時半ぐらいにはオフィスに行って6時過ぎから残りの部分を作り始めた。8時前には完成した。いつもは2-3日前には資料を提示するようにしていたが、今日は祝日でだらだらモードで1時間前 (打ち合わせは9時から) となった。はらさんも直前で資料に目を通してもらったが、こういうのはよくなかったと後で反省した。</p><p>資料を作っていて、ふと思い浮かんだ気づきの1つをあげる。</p><blockquote><p>会社の銀行口座と自分の銀行口座残高がダブルでただひたすらに減額しているさまを見るのって普通にメンタルに良くないんですよね。しかも事業も全然伸びていきませんし…。</p><p><a href=https://note.com/iktakahiro/n/ne90610ffc0ed>ソフトウェアエンジニア社長として起業してから会社清算するまでの4年間の振り返り （完結編）</a></p></blockquote><p>前期は3ヶ月ほど仕事をせずに遊んでいた。数字だけをみたら6ヶ月ほど遊んでいてもよい余裕はあったと言える。それでも3ヶ月ほど経ってから次のお仕事を探して、いま受託開発をしているのは <strong>銀行口座の残高がダブルで減り続ける恐怖に抗うのが難しい</strong> からと言える。会社が倒産するわけでも、生活に困るわけでもなく、銀行口座の残高が減り続ける毎日が怖いという話し。「死の恐怖は死そのものよりも怖ろしい」と誰かの名言があるが、その経営者バージョンかもしれない。難しい判断は心身ともに落ち着いていて余裕をもった状態で下すのが望ましいと、誰もが頭では理解できるだろうが、実際に銀行の口座がずっと減り続けている状態でそう在れるかというのは別問題だという話し。無計画に仕事せずに遊ぶのは、うちの会社の場合は3ヶ月程度が限界だと分かった、というのが今期の財務における収穫と言える。</p><p>そんな1年を通したふりかえりを雑談してたら2時間ほど経過していた。また2週間後に第4期の展望をやることにした。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0428/>jvm の脆弱性対応</a></h1><div class=post-meta><time class=post-date>2022-04-28 (Thu.) ::</time></div><span class=post-tags>#<a href=/diary/tags/java/>java</a>&nbsp;
#<a href=/diary/tags/security/>security</a>&nbsp;</span><div class=post-content><p>23時に寝て3時に起きて5時に起きて7時に起きた。なんか調子が微妙。</p><h2 id=jvm-の脆弱性対応>jvm の脆弱性対応</h2><p>少し前だけど、jvm のセキュリティアナウンスがあった。</p><ul><li><a href=https://openjdk.java.net/groups/vulnerability/advisories/2022-04-19>OpenJDK Vulnerability Advisory: 2022/04/19</a></li></ul><p>java 11 向けの docker イメージのビルドはあまり緊急度が高くなかったせいか、17よりは優先度が低かったようにみえる。docker イメージビルドの作業状況は次の issue で管理されている。</p><ul><li><a href=https://github.com/adoptium/adoptium/issues/140>April 2022 Release Status per Platform, Version & Binary Type #140</a></li></ul><p>これまで <a href="https://hub.docker.com/r/adoptopenjdk/openjdk11/tags?page=1&name=alpine-jre">adoptopenjdk/openjdk11:alpine-jre</a> という docker イメージを使っていた。<a href=https://blog.adoptopenjdk.net/2021/03/transition-to-eclipse-an-update/>Transition to Eclipse - An Update</a> によると、Eclipse Temurin という組織が管理する <a href=https://adoptium.net/>Adoptium</a> というプロジェクトに移管されたらしい。この機会に docker イメージも <a href="https://hub.docker.com/_/eclipse-temurin?tab=tags&page=1&name=11-jre-alpine">eclipse-temurin:11-jre-alpine</a> に移行した。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0427/>障害調査と先入観</a></h1><div class=post-meta><time class=post-date>2022-04-27 (Wed.) ::</time></div><span class=post-tags>#<a href=/diary/tags/cdk/>cdk</a>&nbsp;
#<a href=/diary/tags/infrastructure/>infrastructure</a>&nbsp;</span><div class=post-content><p>23時に寝て5時過ぎに起きた。</p><h2 id=インフラの不具合調査>インフラの不具合調査</h2><p>本番環境に初回デプロイして ecs から secrets manager のアクセスに失敗しているエラーが出ていたので調査した。エラーメッセージでググるとクラスメソッドさんの記事が出てきた。</p><ul><li><a href=https://dev.classmethod.jp/articles/tsnote-ecs-resourceinitializationerror/>ECSでコンテナ環境変数をSecretManagerから取得する際にResourceInitializationErrorが発生したときの対処方法</a></li></ul><p>この記事によると、次のどちらかの原因かなと推測していた。</p><ul><li>実行 IAM ロールの権限不足</li><li>SecretsManager エンドポイントへの不到達</li></ul><p>調べども調べどもテスト環境との違いがわからなくてはまってしまった。ある検証をしていたときに、テスト環境を手動で構築した担当者から datadog の api key を設定してないんじゃない？と言われて、まさにそれが原因だった。cdk のコード上は設定済みのものとして ecs の datadog のサイドカーに設定していた。先入観で rds の credential 情報を取得できずにエラーになっていると思い込んでいたが、サイドカーの datadog の api key が原因ではまるべくしてはまったという感じ。</p><p>一方で secrets manager に登録するサードパーティの api key をどこで管理するかというのは難しい問題でもある。cdk のコードの中に書いてしまうというのも1つのやり方ではあるが、昨今の github 関連のサードパーティから派生したセキュリティインシデントで private リポジトリのソースコードにアクセスされることも発生しているのでソースコードには書きたくない。で、手動で secrets manager に設定しないといけないから、今回みたいな初回デプロイ時に誰も気付かないみたいなことが起きる。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0426/>開発は生きもの</a></h1><div class=post-meta><time class=post-date>2022-04-26 (Tue.) ::</time></div><span class=post-tags>#<a href=/diary/tags/founding/>founding</a>&nbsp;
#<a href=/diary/tags/scrum/>scrum</a>&nbsp;</span><div class=post-content><p>0時に寝て5時過ぎに起きた。</p><h2 id=事例紹介>事例紹介</h2><p>いまやっているお仕事の事例紹介の承諾をいただいたので掲載した。感謝。この事例紹介は私の自己満足なところも大きい。世の中に対して自社が貢献しているということを再確認するための手順の1つと捉えている。もちろん複合的に宣伝にもなるので自社にとってメリットもあるが、それ以上に自分に向けて書いているという思いがある。それはこれまで私にとっての、意義のない開発をし経験から、そういうお仕事はしないようにしようという戒めでもある。これまで組織の論理が自分の想いや方向性とズレてしまったときに退職してきたが、業務委託だと契約を終了できるので転職するよりは補正しやすいという側面もある。</p><ul><li><a href=https://kazamori.jp/news/2022/04/26/subcontract-hoshino-resorts/>事例紹介に星野リゾート様を追加しました</a></li></ul><h2 id=ふりかえり>ふりかえり</h2><p>スクラムのふりかえりで pull request のルール適用による成果について共有した。ルール適用前まで pull request のレビューに正社員のレビューを必須としていた。開発チームは協力会社主体であり、正社員は1人しかいなかった。そのため、レビュー負荷がその正社員に集中し、その人が多忙だと pull request のレビューが2-3日停滞するというのが常だった。そこで協力会社の approve でもマージできるような条件を設定したり、そもそも approve を必要としない pull request の条件を追加したり、pull request を作らずに main に直接コミットしてよい内容なども作った。ルール適用の前後で1ヶ月間のチームの平均値を比較した。</p><p>その結果、findy teams の pull request の作成からクローズにかかる時間が30%に短縮された。3倍近くクローズが早くなった。私個人の「1プルリクあたりの平均マージ・クローズ時間」においても 14.7h → 4.1h に短縮された。平均で1日待たないと approve をもらえなかったのがその日中にもらえるようになったと言える。ふりかえりで成果を共有したところ、わりと成果の大きさに驚かれたのに私が驚いた。経験が浅いチームの当たり前には価値基準や手順などに乖離があるんだろうなと思えた。私にとっては当たり前のことをやって、当たり前の成果が出て、当然こうなるって話しでしかないのだが、開発を数字でしか把握できない人たちにとっては斬新にみえるのかもしれない。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0425/>本番環境反映の監督</a></h1><div class=post-meta><time class=post-date>2022-04-25 (Mon.) ::</time></div><span class=post-tags>#<a href=/diary/tags/cdk/>cdk</a>&nbsp;
#<a href=/diary/tags/infrastructure/>infrastructure</a>&nbsp;</span><div class=post-content><p>昨日は思いっきり昼寝してしまったせいか、夜に眠れなくて3時ぐらいまで起きてて、寝たのか寝てのかよくわからない雰囲気で7時前に起きた。</p><h2 id=インフラ作業の本番反映>インフラ作業の本番反映</h2><p>先週対応した <a href=/diary/posts/2022/0419/>api gateway のコード化</a> を本番環境に反映した。手動で作成されていた api gateway, vpc link, セキュリティグループとそれに関連するリソース群を cdk 管理のコードで置き換える。既存のリソースを削除してから cdk でデプロイするため、失敗しても切り戻しできないのでプレッシャーがかかる。とはいえ、想定通りに作業が進捗して2時間ほどで完了した。それと並行してテスト環境では、手動で作成された rds を cdk 管理のコードで置き換える移行作業をしていた。これも一筋縄ではいかなくて右往左往しながら作業してた。これを本番環境でやるのもまた億劫だなぁと思いながら発生したエラーや事象を書き綴っていた。あと本番環境で行う大きな移行作業はこれだけ。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0424/>個人開発楽しい</a></h1><div class=post-meta><time class=post-date>2022-04-24 (Sun.) ::</time></div><span class=post-tags>#<a href=/diary/tags/github/>github</a>&nbsp;
#<a href=/diary/tags/ci/cd/>ci/cd</a>&nbsp;</span><div class=post-content><p>0時に寝て7時に起きた。朝から雨降りだったのでだらだらしながら家を出たけど、オフィスに着いたのは9時頃だったと思う。午前中にコードを書いてテストして、それからお昼ご飯食べて、家に戻って、ちょっとゆっくりしてからオフィスに戻ろうと思ってたら3時間ほど寝てた。</p><h2 id=backlog-のコミット連携の反応>backlog のコミット連携の反応</h2><p>たまたまツィートしていたらこみやさんが関心をもってくれた。fix, close などでチケットのステータスを変えたいという要望をもらったので作ることにした。</p><blockquote class=twitter-tweet><p lang=ja dir=ltr>同じ構成なのでちょっと気になる</p>&mdash; tk0miya (@tk0miya) <a href="https://twitter.com/tk0miya/status/1517681854539001856?ref_src=twsrc%5Etfw">April 23, 2022</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script><p>3時間ほどとわりとすぐに実装できた。いまのプロジェクトでは使わない機能なので当初は乗り気ではなかったけど、やっぱり使いたいという人がいると開発のモチベーションになる。</p><ul><li><a href=https://github.com/kazamori/backlog-github-integration-action/pull/3>Add a feature to change the issue status with commit messages (fix, close) #3</a></li></ul><p>機能拡張して、テストしたり、ドキュメント書いたりしてた。github discussions も積極的に使ってみようと思っていてちょっとした faq も書いてみた。</p><ul><li><a href=https://github.com/kazamori/backlog-github-integration-action/discussions/4>About Internationalization (i18n) #4</a></li></ul><p>1-2週間ほど試験運用して問題なさそうだったら v1 のタグをつけて marketplace などに公開してもよいかもしれない。ブログにも書かないとな。まだまだタスクは残っている。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0423/>個人開発の日</a></h1><div class=post-meta><time class=post-date>2022-04-23 (Sat.) ::</time></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/event/>event</a>&nbsp;</span><div class=post-content><p>0時に寝て6時に起きた。午後から昨日作った機能拡張のテストをしながらコードの修正やテストコードを追加したりしていた。</p><h2 id=ストレッチ>ストレッチ</h2><p>今日の開脚幅は開始前161cmで、ストレッチ後161cmだった。先週はワクチン接種後にダウンして寝込んでいて数値が悪かったのが元に戻った感じ。それでもまだ復調にはいたらないのか、右の肩甲骨が硬いのと腰の張りもすごかった。3月からずっとだらだらした生活を送っているのでもうちょっと生活をびしっとしないといけない。インフラエのお仕事を引き受けてから深夜早朝に作業する機会が増えて生活のリズムを崩しているのもあるとは思う。歳をとって体調がよくない日が増えるという話しを聞いたけど、私もストレッチを始める前はそうだったような気がするけど、毎週ストレッチに通うようになってからそういう印象が解消した。もう1年以上通っているから間違っていないと思う。毎週どこそこが悪いといったことも書いたりはしているけど、それはストレッチをする上でのよくないところや前週よりも成果が出ないところの話しであって、日常生活を送る上ではまったく影響はない。ストレッチは正義。</p><h2 id=go-conference-2022-spring-online>Go Conference 2022 Spring Online</h2><p>ストレッチを終えてから <a href=https://gocon.jp/2022spring/ja/>Go Conference 2022 Spring Online</a> に参加した。いくつか発表を聞きながらコードを書いたりもしていた。一番よかったのはたいちさんの <a href=https://drive.google.com/file/d/1lsF7q74o0Akewk-5rUb9Jt9nA2MqpDDw/view>DBアクセスライブラリkra</a> の発表かな。<a href=https://github.com/taichi/kra>taichi/kra</a> というライブラリも知らなかったので機会があれば今度使ってみようという気になった。私も sql 好きだし、orm の弊害の話しも共感できてよかったと思う。orm 使うなという話しではなく、それぞれの用途にあわせて使い分けたい。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0422/>カスタム action の開発再開</a></h1><div class=post-meta><time class=post-date>2022-04-22 (Fri.) ::</time></div><span class=post-tags>#<a href=/diary/tags/workcation/>workcation</a>&nbsp;
#<a href=/diary/tags/github/>github</a>&nbsp;
#<a href=/diary/tags/ci/cd/>ci/cd</a>&nbsp;</span><div class=post-content><p>22時に寝て0時に起きて3時に起きて5時半に起きた。</p><h2 id=ワーケーションのリトライ>ワーケーションのリトライ</h2><p>オミクロン株の流行で延期していた開発合宿を行う。レンタカーと <a href=https://kinosaki-kinoie.com/>きのいえ</a> の予約を6月3-5日で確定させた。3回目のワクチンを接種したばかりだし、世の中の雰囲気も with コロナへの取り組みになってきている気がする。行き先は同じなので前回作った旅のしおりをコピーしていくつか修正しながら再計画していく。<a href=https://goto.jata-net.or.jp/>Go To トラベル</a> 再開が6月ではないかという噂もある。</p><h2 id=backlog-github-integration-action-の機能拡張>backlog-github-integration-action の機能拡張</h2><p>先日作った <a href=/diary/posts/2022/0327/>backlog-github-integration-action</a> に push という新たなサブコマンドを追加した。コミットをリポジトリに push したときのイベントをフックしてカスタム action を実行する。インプットが github から取得できるデータになるため、<a href=https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows>GitHub Events</a> 単位にサブコマンドを作ればトリガーと扱えるインプットデータが一致してわかりやすい機能分割になるんじゃないかと思えた。ひとまずそれでやってみる。今日のところはローカルで動かしてコミット連携ができることを確認して、いくつかテストを書いていた。また明日、結合レベルのテストをやってみる。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0421/>rds の再作成</a></h1><div class=post-meta><time class=post-date>2022-04-21 (Thu.) ::</time></div><span class=post-tags>#<a href=/diary/tags/cdk/>cdk</a>&nbsp;
#<a href=/diary/tags/infrastructure/>infrastructure</a>&nbsp;</span><div class=post-content><p>23時に寝て5時半に起きた。久しぶりによく眠れた気がする。</p><h2 id=rds-を独立したスタックに分離>rds を独立したスタックに分離</h2><p>昨日の続き。ライフサイクルにあわせたスタックに分割し、スタック間の依存関係を適切に定義することで堅牢なインフラコードになる。最後に残った DatabaseStack を分離するところを朝からやっていた。</p><ul><li>DatabaseStack<ul><li>BackendStack<ul><li>GatewayStack<ul><li>FrontendStack</li></ul></li></ul></li></ul></li></ul><p>rds を壊して、バージョンを aurora postgresql 最新の 13.x にアップグレードして、cf のテンプレートで小細工をしながら既存の環境を移行したりしていた。<a href=https://www.postgresql.org/docs/13/app-pgdump.html>pg_dump</a> を使ってテキストに dump したデータを、psql を使ってリストアしたりもした。データ量が少なかったらこれで移行してもいいかもしれない。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pg_dump --host mydb.xxx.ap-northeast-1.rds.amazonaws.com --username user mydb &gt; mydb.dump
</span></span><span style=display:flex><span>$ psql --host mydb.xxx.ap-northeast-1.rds.amazonaws.com --username user --dbname mydb --file ./mydb.dump
</span></span></code></pre></div></div></article><div class=pagination><div class=pagination__buttons><a href=/diary/posts/page/74/ class="button previous"><span class=button__icon>←</span>
<span class=button__text>最近の日記</span>
</a><a href=/diary/posts/page/76/ class="button next"><span class=button__text>過去の日記</span>
<span class=button__icon>→</span></a></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2024 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>