<!doctype html><html lang=en><head><title>Posts :: forest nook</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/posts/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="Posts"><meta property="og:description" content><meta property="og:url" content="/diary/posts/"><meta property="og:site_name" content="forest nook"><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/posts/index.xml rel=alternate type=application/rss+xml title="forest nook"></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><div class=posts><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0409/>ubuntu の環境構築</a></h1><div class=post-meta><time class=post-date>2023-04-09 (Sun.) ::</time></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/linux/>linux</a>&nbsp;
#<a href=/diary/tags/device/>device</a>&nbsp;</span><div class=post-content><p>0時に寝て8時に起きた。昨日は出張から遅くに帰ってきたのでバテた。</p><h2 id=ストレッチ>ストレッチ</h2><p>昨日はもくもく会で遅くに帰ってきたので毎週のストレッチを土曜日から日曜日に変更していた。ここ1-2ヶ月ほどでは最も調子がよかった。今週は出張していて普段より健康的な生活をしていた。というのは、お手伝い先のオフィスでは原則として私は9-18時でしか働けないため、業務の都合でずっと座りっぱなしにならない。例えば、自社のオフィスだとだいたい8時から始業して遅いと23時ぐらいまでずっと座りっぱなしになってしまう。たまたまホテルもいつもよりも離れた場所にとり、10分ほど歩く距離だったのでちょうどよかった。帰ってからホテルで2-3時間作業していたりもするのだが、それでも同じ姿勢でずっと座り続けている方が体にとってはよくないことがわかる。今日の開脚幅は開始前152cmで、ストレッチ後156cmだった。座っている時間が短かったために腰の張りはほとんどなかった。</p><h2 id=ubuntu-2204-lts-の環境構築>ubuntu 22.04 lts の環境構築</h2><p>先日 <a href=/diary/posts/2023/0325/#dell-マシンに-ubuntu-をインストール>マシンに ubuntu をインストールした</a> 続きの話し。東京出張があったり、開発の終盤でいろいろやっている中で開発環境を作り直すインセンティブが低かったので環境構築が遅くなった。過去の環境構築の issue が残っているのでそれをみながらやれば5-6時間もあれば作り直せた。結論から言って、マシンスペックが上がって、os も新しいものに変わったので開発環境としてはめちゃくちゃ快適になった。好みだが、私はリソースの潤沢なデスクトップマシンに linux をインストールして開発するのが一番しっくりくる。主観的に感情的にその構成が好きだというもの。</p><p>realforce の bluetooth キーボードの設定をするのにもう1つキーボードが必要なことに気付いた。私は <a href=http://www.bluez.org/>bluez</a> というツールを使って bluetooth キーボードのペアリングをしている。ペアリングするためには bluez の bluetoothctl という cli から操作してペアリングを行う。realforce のキーボードは有線/bluetooth 接続を両方同時につなぐことはできないため、bluetooth 接続するためには別のキーボードを接続して cli 操作しないといけない。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ bluetoothctl
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>bluetooth<span style=color:#f92672>]</span><span style=color:#75715e># power on</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>bluetooth<span style=color:#f92672>]</span><span style=color:#75715e># agent on</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>bluetooth<span style=color:#f92672>]</span><span style=color:#75715e># scan on</span>
</span></span></code></pre></div><p>bluetooth キーボードから接続要求を送る。</p><pre tabindex=0><code>...
[NEW] Device F6:9D:A5:41:B7:1F REALFORCE_2
...
[bluetooth]# info F6:9D:A5:41:B7:1F
Device F6:9D:A5:41:B7:1F (random)
	Name: REALFORCE_2
	Alias: REALFORCE_2
	Appearance: 0x03c1
	Icon: input-keyboard
	Paired: no
	Trusted: no
	Blocked: no
	Connected: no
	LegacyPairing: no
	UUID: Human Interface Device    (00001812-0000-1000-8000-00805f9b34fb)
	RSSI: -51
</code></pre><p>マシンからデバイスを検出したらデバイス情報を確認してペアリングを実行する。</p><pre tabindex=0><code>[bluetooth]# pair F6:9D:A5:41:B7:1F
Attempting to pair with F6:9D:A5:41:B7:1F
[CHG] Device F6:9D:A5:41:B7:1F Connected: yes
[agent] Passkey: ***
</code></pre><p>これでペアリングが実行されて bluetooth 接続できるようになる。ubuntu 20.04 lts の頃より進化しているのは接続／切断時に電池の残量も表示されるようになった。キーボードには充電池を使っているので地味に嬉しい。残量が少なくなってきたら帰るときに充電を仕掛けて帰れる。</p><p>今回の環境構築で1つはまったものがある。vagrant の仮想環境として virtualbox を使う。<a href=https://wiki.ubuntu.com/UEFI/SecureBoot>secure boot</a> のために virtualbox をインストールするときにパスワードを mok (Machine-Owner Key) に登録しないといけない。この作業手順が分からなくて右往左往していた。インストール時に mok のダイアログが表示されてパスワードを登録するが、この後に os を再起動して bios 起動時に特別なダイアログが表示されて mok に登録したいパスワードを入力する。アプリケーションのインストール時に bios の設定が必要という概念が私の頭の中になくて分からなかった。これをやらないと virtualbox サービスが正常に起動しない。調べていると ubuntu 標準の virtualbox は壊れていて 3rd party の contrib なパッケージを使えという古い記事も出てくる。22.04 なら ubuntu 標準の virtualbox でも問題なく、mok の登録後に systemd から virtualbox サービスが起動することを確認した。再起動後の mok のダイアログは1度しか出てこないのでうっかり見逃してしまったら再設定しないといけない。次の cli で再設定できる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo dpkg-reconfigure virtualbox-dkms
</span></span></code></pre></div><blockquote class=twitter-tweet><p lang=ja dir=ltr>dell の xps 8950 に ubuntu 22.04 lts をインストールして開発環境を一通り構築した。ほとんどトラブルなく構築できた。いろいろ快適になったので集中力が上がる。開発の追い込みなのでちょうどよい。</p>&mdash; Tetsuya Morimoto (@t2y) <a href="https://twitter.com/t2y/status/1646055812224417792?ref_src=twsrc%5Etfw">April 12, 2023</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0408/>気分転換のもくもく会</a></h1><div class=post-meta><time class=post-date>2023-04-08 (Sat.) ::</time></div><span class=post-tags>#<a href=/diary/tags/event/>event</a>&nbsp;</span><div class=post-content><p>0時に寝て4時に起きて6時に起きてだらだらして7時半から広いお風呂入ってきた。</p><h2 id=the-b-水道橋>the b 水道橋</h2><p>昨日は <a href=https://www.theb-hotels.com/theb/suidobashi>the b 水道橋</a> に宿泊した。the b というホテルブランドらしい。初めて宿泊した。あまり新しい施設ではないし、部屋も狭かったけれど、受付でアイスクリームが無料というサービスをしていたり、大浴場があったりと限られたリソースでがんばろうとしている雰囲気がみえておもしろいホテルだと思う。値段も他のビジネスホテルより少し割安だった。水道橋駅から10分ほどだとは思うが、微妙に歩く立地が割安にしているのではないかと思う。水道橋はどこに行くにもアクセスがよいのでよい場所だと思う。晩ご飯に近くの <a href=https://tabelog.com/tokyo/A1310/A131003/13213953/>つどい酒場えすと。</a> という居酒屋にふらっと入ったらよいお店だった。お店もほぼ満席だった。部屋は普通もしくは手狭なのだけど、全体としてはよい宿泊体験だったと思う。また機会があったら泊まるかもしれない。</p><h2 id=もくもく会>もくもく会</h2><p><a href=https://kazamori.connpass.com/event/277481/>出張もくもく会</a> を開催した。3月は週末にお仕事していなければバテて家で寝ているといった、あまりよくない状態だったので気分転換も兼ねてのもくもく会だった。いつもと違う場所、違う人たちとやり取りすることそのものがマンネリを解消する上でもよかったように思う。12人が参加してくれた。20人ぐらいが入れる広い場所を借りてみたものの、思ったより集まらなかった。前回来てくれた方たちも何人かいた。レンタルスペースなので参加費いらないですか？と問い合わせしてくれた方もいた。もくもく会イベントはうちの会社の交際費を使う手段の1つでもある。</p><p>会場は <a href=https://www.instabase.jp/space/2544621780>VILLENT 秋葉原</a> というレンタルスペースを借りた。10時00分から17時30分まで7.5時間を借りて税込20,988円。<a href=/diary/posts/2023/0109/#もくもく会>前回の会場</a> は定員が10人なものの、窮屈で狭かったため、今度は広い場所を借りることにした。定員は24人なものの参加者は私を含めて13人だった。だいたい4人座れる机に2人ずつ、たすきに座ってスペース的には余裕があってちょうどよかった。次回またもくもく会をやるときは20人ぐらいのスペースに対して10人程度の募集にしようと思う。</p><p>会場はサイトの写真をみて想像したよりも汚い (古い) 施設だった。あとで参加者と話していて借りるときに google map でビルの外観をみればいいと教えてもらった。電源タップはないと書いてあったが棚を探すと3つほど見つけた。インターネット接続にちょっとしたトラブルがあった。wifi ルーターには接続できるけど、インターネットにアクセスできない。あれー？と思って問い合わせしたら自動音声でルーターの電源の on/off を試せと流れて、wifi ルーターを探してみたら、その後ろに置いてあった onu (光回線終端装置) の電源が入ってなかった。wifi ルーターだけ電源が入っていて onu だけ電源を切ることはないと思うので前に使った人たちのいたずらかもしれない。くそーって気分だった。wifi 速度は7人接続している状態で240Mbpsほどあったので十分に速かった。</p><p>あとで施設のレビューをみてみると「清潔感」が 4.0 と低くはないけれど、他の項目に比べて明らかに低い点数となっている。私ならこの項目に 3.0 をつけるかなと思う。価格が割安なのでそんなものと言えるが、特定の項目だけ統計の値が低いのならなにか理由があると考えてよいということを学んだ。ちなみにそれでも 4.0 と点数が高いのはすべての項目を 5.0 に付けているレビューアがいるためだと考えられる。ちゃんと点数を付けているレビューアは 2.0-4.0 を付けていたようにみえる。</p><figure><img src=/diary/img/2023/0408_review.png></figure><p>午前中に10人ほど参加して、午後から2人参加して、参加者の大半は web 系の人たちにみえた。午後から来た2人組は期待したものと違ったのか1-2時間作業してすぐに帰られた。窓を開けておくと周りの工事の音が少し騒々しい。途中で少し寒いということで窓を閉めたら騒音はそれほど気にならなくなった。私は日記を書いたり、お仕事のドキュメントを書いたりしていた。図書館で勉強するような雰囲気になっていて作業に集中できてよかった。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0407/>一日中リファクタリング</a></h1><div class=post-meta><time class=post-date>2023-04-07 (Fri.) ::</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/docker/>docker</a>&nbsp;
#<a href=/diary/tags/mongodb/>mongodb</a>&nbsp;</span><div class=post-content><p>0時に寝て7時に起きた。昨日は夜にホテルで作業しようと思いながらテレビをみているうちに寝落ちしてた。朝から夜までずっとリファクタリングのためにコードを書いたり、コンテナ環境の設定を変更したりしていた。</p><h2 id=mongodb-のコネクションプール>mongodb のコネクションプール</h2><p>MongoDB Drivers の <a href=https://www.mongodb.com/docs/drivers/go/current/fundamentals/connection/#connection-example>Connection Example</a> に次のようなことが書いてある。</p><blockquote><p>Reuse Your Client</p><p>We recommend that you reuse your client across sessions and operations. You can use the same Client instance to perform multiple tasks, instead of creating a new one each time. The Client type is safe for concurrent use by multiple goroutines. To learn more about how connection pools work in the driver, see the <a href=https://www.mongodb.com/docs/drivers/go/current/faq/#std-label-golang-faq-connection-pool>FAQ</a> page.</p></blockquote><p>mongodb drivers の client は goroutine safe なので再利用することを推奨している。内部的にはコネクションプールをもっていて mongodb とのコネクションを再利用できる。具体的にはライブラリ内部に次のようなコードがみつかる。context にセッション情報があればそれを使い、なければクライアントの sessionPool (コネクションプール) を使ってセッションを取得して mongodb にアクセスする関数の終わりで終了処理を行う。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>sess</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sessionFromContext</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sess</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>coll</span>.<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>sessionPool</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sess</span> = <span style=color:#a6e22e>session</span>.<span style=color:#a6e22e>NewImplicitClientSession</span>(<span style=color:#a6e22e>coll</span>.<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>sessionPool</span>, <span style=color:#a6e22e>coll</span>.<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>id</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>sess</span>.<span style=color:#a6e22e>EndSession</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>既存のコードはコネクションプールのことを考慮していないコードになっていたので大きくリファクタリングして効率化した。</p><h2 id=docker-hub-の-pull-制限>docker hub の pull 制限</h2><p>午前中はリファクタリング、午後は docker compose 環境の変更と再構築、午後はバグ修正と一日中 docker image を取得する作業をしていた。gitlab ci/cd が動くとテストと docker image 生成の処理が動くのでその過程で関連する docker image を pull する。夕方になって gitlab ci/cd で初めて次のエラーが発生することに気付いた。前にお手伝いしていた職場でもそういう現象が起こると聞いて、docker login するコードを github actions のスクリプトに追加していたので、rate limit がかかることは知っていた。</p><pre tabindex=0><code>You have reached your pull rate limit. You may increase the limit by authenticating and upgrading: https://www.docker.com/increase-rate-limits.
</code></pre><p><a href=https://www.docker.com/increase-rate-limits/>Understanding Your Docker Hub Rate Limit</a> によると、6時間あたり匿名アクセスは100、
free ユーザーは200を上限としているらしい。匿名アクセスは ip アドレスでカウントしているのだろうから場合によっては会社内からのアクセスをすべてカウントされたりするかもしれない。課金するとこの上限が24時間あたり5000になる。docker hub のプライベートリポジトリを利用する意図で team プランの課金を検討していたが、docker hub のアクセス制限を緩和するために課金する必要があるかもしれない。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0406/>リリース後の展望</a></h1><div class=post-meta><time class=post-date>2023-04-06 (Thu.) ::</time></div><span class=post-tags>#<a href=/diary/tags/project-management/>project management</a>&nbsp;
#<a href=/diary/tags/issue-management/>issue management</a>&nbsp;
#<a href=/diary/tags/communication/>communication</a>&nbsp;</span><div class=post-content><p>0時に寝て7時半に起きた。そろそろ出張バテしてきた。</p><h2 id=プロジェクトの進捗報告>プロジェクトの進捗報告</h2><p>出張したときの月例報告の5回目。<a href=/diary/posts/2023/0309/>前回の進捗報告はこちら</a> 。私のマネジメントの不手際で1ヶ月延期 (元の計画通り) して、未だに開発は完了していないものの、今月末にリリースできる見通しでプロジェクトを進めている。おそらくあと1-2回は私が休出するのだろう。これからメンバーにはできる限りの QA テストを3週間に渡って行ってもらう。</p><p>チームが fix した3月の issue 数は47、そのうちの34を、enhance ラベルが付いたものは12でそのうちの9を私が担当した。クリティカルパスになりそうなものは、一旦はメンバーにアサインするものの、進捗をみて遅れていれば私が issue を引き取って対応している。先月から引き続き、やばそうな芽が出てきたら私が本気出して対応する。見た目上のスケジュールには影響を与えないようにしている。先月の反省で早めに引き取ることにしたのでずるずる後ろへ延びることはない。このやり方をすると、私がボトルネックになりかねないが、私の工数は調整次第でメンバーよりも大きくできるのでいまのところ問題ない。リリースまで1ヶ月を切った中で取り得る手段は限られてくる。</p><p>2月から <a href=/diary/posts/2023/0202/#ハドルと雑談>ハドルと雑談</a> の試験運用をしていた。ほぼ毎日午前中は私が slack のハドルに在籍 (オフィスアワーに近い取り組み) するようにして、メンバーから雑談する機会は増えるかどうかを試していた。約2ヶ月やって結果は次の通りとなった。</p><ul><li>対象日数: 34日</li><li>雑談人数: 10人</li><li>雑談時間: 5.75時間</li></ul><p>3日に1日ぐらい軽く雑談するといった結果になった。おそらく私がハドルにいなかったら話す機会はなかったのでこの価値をどう見積もるかは人によって分かれると思う。うちのチームはリモートワークが中心なので雑談する機会があるほど望ましい。それほど強く提案するわけではないが、slack のハドル活用をもっと展開してもよいのではないかと経営者に推奨した。</p><p>聞いた話では着任前にこのプロダクト開発は2年近く迷走していたらしい。それによって要件は整理されていたと言える。私がこの半年でリリース (予定) できる状態にしたのを評価してもらえているようにはみえる。余談だが、自分のスキルを社会の役に立てられるのがいまは嬉しい。前職では、誰でもできる簡単なお仕事しかできず、開発もあまりつまらなかった。いまは自分がよいと思うものを一定の裁量で判断し、さらにマネージャー経験も積めて、今回のお仕事は私の中でも達成感は高い方でもある。</p><p>あとは今後の開発の話し、販売戦略の話しなどもしていた。4月末で初期開発の区切りもつく。今後は毎月1週間も出張しなくてよいのではないかという話しもして、5月は会議を2-3日に集中してやったらいいんじゃないかということになった。出張はそろそろ疲れてきたのと、私がオフィスにいてもメンバーは半分以上リモートワークなのでオフィスに来る意義があまりない。うちのチームはリモートワークで開発に支障が出ない仕組みを構築できているとは思う。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0405/>rsync に daemon モードがあるらしい</a></h1><div class=post-meta><time class=post-date>2023-04-05 (Wed.) ::</time></div><span class=post-tags>#<a href=/diary/tags/cli/>cli</a>&nbsp;
#<a href=/diary/tags/security/>security</a>&nbsp;
#<a href=/diary/tags/event/>event</a>&nbsp;
#<a href=/diary/tags/gpt/>gpt</a>&nbsp;</span><div class=post-content><p>23時に寝て2時半に起きて4時や5時に起きて7時に起きた。泊まっているホテルの低反発枕の寝心地がよい。</p><h2 id=rsync-daemon-over-ssh>rsync daemon over ssh</h2><p>外部向けのドキュメントを公開するための gitlab ci/cd を構築した。web サーバにドキュメントをアップロードする手段として rsync を使っている。rsync over ssh でデータを転送するときにさらに daemon モード (rsyncd) という仕組みがあって、権限や書き込み先の acl なども細かく制御できる。手順や設定は古の古臭い雰囲気はするけれど、実用的には ssh の秘密鍵を使ってちょっと高機能なアップロードを実現できる。ssh agent で鍵登録できていれば次のような cli でセキュアに rsync できる。全然知らない方法だったので学びの1つになった。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ rsync <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --verbose <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --rsh ssh <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --stats <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --compress-choice<span style=color:#f92672>=</span>zstd <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --compress-level<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --itemize-changes <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --recursive <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --checksum <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --delete <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    local/ <span style=color:#e6db74>${</span>USER<span style=color:#e6db74>}</span>@<span style=color:#e6db74>${</span>HOST<span style=color:#e6db74>}</span>::<span style=color:#e6db74>${</span>RSYNC_DIR<span style=color:#e6db74>}</span>
</span></span></code></pre></div><ul><li><a href=https://jyn.jp/rsync-daemon-over-ssh/>rsync+sshはdaemonモードを使うと更に安全になる</a></li></ul><h2 id=llmを使ってみる会>LLMを使ってみる会</h2><p><a href=https://fin-py.connpass.com/event/279271/>LLMを使ってみる会</a> に参加した。私も chatgpt に調べものやちょっとしたことを聞くようになったりしているが、他の人たちがどんな用途に使っているのかも知りたくて参加してみた。fin-py のイベントだったのでみんな金融系のドキュメントの要約に使っているのが多そうにみえた。あとは研究テーマとして gpt/llm を取り上げている人たちも何人かいた。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0404/>考えているとストリームが発生する</a></h1><div class=post-meta><time class=post-date>2023-04-04 (Tue.) ::</time></div><span class=post-tags>#<a href=/diary/tags/project-management/>project management</a>&nbsp;
#<a href=/diary/tags/issue-management/>issue management</a>&nbsp;
#<a href=/diary/tags/team-building/>team building</a>&nbsp;
#<a href=/diary/tags/postmortem/>postmortem</a>&nbsp;</span><div class=post-content><p>18時から20時半ぐらいまで寝て、それから晩ご飯を食べに出掛けて、23時頃に戻ってきてまた寝て、4時に起きて、6時に起きた。出張の初日は不規則な寝方になる。</p><h2 id=定例会議とふりかえり>定例会議とふりかえり</h2><p>リリースまであと3週間。一部の開発がまだ完了していないことに大きなストレスと懸念を感じつつ、進捗はしているそうなのでその対応が完了するのを待つ。いまは日々の進捗や発生する事象に注意を配りつつ、メンバーは QA レベルのテストを、私は淡々とリリースの準備をしている。外部からアクセスできるプライベートなコンテナレジストリを docker hub でお金を払うか、自社で運用するかの決めの問題や外部向けにドキュメントを公開するための決めごとなどを確認したりしていた。</p><p>毎月のマイルストーン終了後にふりかえりをしている。今月は対応した issue のうち、70%超を私が fix しているのであまり話題がないかなぁとか思っていたけど、全然そんなことはなく、活発にふりかえりのコメント (付箋に書く) が出てよかった。当初は付箋に書いた内容に対して関心のあるものをメンバーに投票してもらっていた。そして、メンバーの関心の高いマークがたくさん付いたものから掘り下げて聞くようにしていた。最近は3人でふりかえりをやっているため、すべての付箋をみていっても10個未満程度、すべてヒアリングしても時間がちょうどよいので投票をやめた。そうすると、メンバーが自分のやったことや思ったことを他者へ話す機会になっていて、これは内省を促す意図でとてもよいことじゃないかと思うようになってきた。</p><blockquote><p>ふりかえりをしない人やチームは成長しない</p></blockquote><p>これは私の持論だ。うまくいかなかったときにふりかえりすると、当事者が嫌な気持ちになったりしんどかったり、責任を感じたりとネガティブなイメージから、私の経験則ではふりかえりを行わないチームの方がずっと多かった。こういう小さい積み重ねを継続的にやるのは後になってその人の価値観や成長に影響を与えるのではないかと最近は思う。うちのチームでは厳しく責任追及はしないのでメンバーが率直的にこれができなかったとふりかえることはできるようになっているとは思う。</p><p>ふとふりかえりをしていてこんな言葉が私の口から出た。</p><blockquote><p>作業の進捗をストリームとして確認できると嬉しい、ストリームを眺めているとメンバーが考えているのかどうかが分かる</p></blockquote><p><a href=https://gihyo.jp/book/2018/978-4-7741-9605-3>エンジニアリング組織論への招待</a> に次のような節がある。</p><blockquote><p>「悩む」と「考える」の違い</p><p>「考える」は行動であり、「悩む」は状態なのです。考えているのであれば、それはメンターがその行動を見ることができます。しかし、「悩む」であれば、メンターは心の状態を観察することはできません。</p></blockquote><p>悩んでいる状態は手が止まっていて、頭の中で思考がぐるぐる巡っていて、もやもやしている状態。考えているとは、課題を書き出したり、分解したり、調査したりと忙しく行動していると言える。当然、考えないと優れた品質のアウトプットは出せない。正に私がやっている課題管理も、そのための課題管理システムも考えていることを確認・監視するために有効な手法とシステムであることが伺える。チームのふりかえりをしながら、そういった話しをメンバーに共有したりしていた。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0403/>ローカルにコンテナレジストリを構築する</a></h1><div class=post-meta><time class=post-date>2023-04-03 (Mon.) ::</time></div><span class=post-tags>#<a href=/diary/tags/docker/>docker</a>&nbsp;
#<a href=/diary/tags/packaging/>packaging</a>&nbsp;
#<a href=/diary/tags/mdbook/>mdbook</a>&nbsp;
#<a href=/diary/tags/document/>document</a>&nbsp;
#<a href=/diary/tags/mermaid/>mermaid</a>&nbsp;</span><div class=post-content><p>出張する日は寝ないで資料を作ったりバグ修正したりして始発の新幹線の中で寝てた。寝てなくて疲れているせいか、新幹線で寝るのに慣れたのか、わりと2-3時間ぐっすり新幹線で眠れるようになってきた。普通にベッドで寝ても3時間ぐらいしか眠れないので睡眠時間はあまり変わらない。</p><h2 id=docker-registry-の構築>docker registry の構築</h2><p><a href=/diary/posts/2023/0330/#外部向けコンテナレジストリ>先日の調査</a> の続き。<a href=https://docs.docker.com/registry/deploying/>Deploy a registry server</a> に書いてあることを実際にローカルで検証した。</p><p>tls の自己証明書の作成。subjectAltName という設定をするように書いてある。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ openssl req -newkey rsa:4096 -nodes -sha256 -keyout certs/domain.key -addext <span style=color:#e6db74>&#34;subjectAltName = DNS:myhost.mydomain.example.com&#34;</span> -x509 -days <span style=color:#ae81ff>365</span> -out certs/domain.crt
</span></span></code></pre></div><p>basic 認証のための htpasswd の設定。htpasswd とか懐かしいなと思いながら実行した。</p><pre tabindex=0><code class=language-bsah data-lang=bsah>$ docker run --entrypoint htpasswd httpd:2 -Bbn user1 secret1 &gt;&gt; dot_htpasswd
$ docker run --entrypoint htpasswd httpd:2 -Bbn user2 secret2 &gt;&gt; dot_htpasswd
</code></pre><p>docker 社が提供する oss な docker registry サーバーを使って起動する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ mkdir /mnt/registry  <span style=color:#75715e># docker image を永続化する場所</span>
</span></span><span style=display:flex><span>$ sudo docker run -d <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --restart<span style=color:#f92672>=</span>always <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --name registry <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -v <span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>pwd<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>/auth:/auth <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -e <span style=color:#e6db74>&#34;REGISTRY_AUTH=htpasswd&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -e <span style=color:#e6db74>&#34;REGISTRY_AUTH_HTPASSWD_REALM=Registry Realm&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -e <span style=color:#e6db74>&#34;REGISTRY_AUTH_HTPASSWD_PATH=/auth/dot_htpasswd&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -v <span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>pwd<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>/certs:/certs <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -e <span style=color:#e6db74>&#34;REGISTRY_HTTP_ADDR=0.0.0.0:443&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -e <span style=color:#e6db74>&#34;REGISTRY_HTTP_TLS_CERTIFICATE=/certs/domain.crt&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -e <span style=color:#e6db74>&#34;REGISTRY_HTTP_TLS_KEY=/certs/domain.key&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -p 8443:443 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -v /mnt/registry:/var/lib/registry <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  registry:2
</span></span></code></pre></div><p>これで basic 認証付きで https で通信できる docker registry サーバーができた。</p><p>外部のマシンから dokcer login しようとすると次のようなエラーが発生する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ docker login myhost.mydomain.example.com:8443
</span></span><span style=display:flex><span>Username: user2
</span></span><span style=display:flex><span>Password: ***
</span></span><span style=display:flex><span>Error response from daemon: Get <span style=color:#e6db74>&#34;https://myhost.mydomain.example.com:8443/v2/&#34;</span>: x509: certificate signed by unknown authority
</span></span></code></pre></div><p><a href=https://docs.docker.com/registry/insecure/>Test an insecure registry</a> によると、自己証明書を使って外部からアクセスできるようにするためには docker client 側にさっき作った domain.crt をコピーする必要がある。</p><p>linux だとこんな設定。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cp domain.crt /etc/docker/certs.d/myhost.mydomain.example.com:8443/ca.crt 
</span></span></code></pre></div><p>Docker Desktop for Mac を使っている場合はこんな感じ。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-zsh data-lang=zsh><span style=display:flex><span>&gt; security add-trusted-cert -d -r trustRoot -k ~/Library/Keychains/login.keychain path/to/certs/domain.crt
</span></span></code></pre></div><p>これで外部からも docker login して任意の docker image を push/pull できるようになる。docker registry サーバーは Let’s Encrypt をサポートしているそうなので <a href=https://letsencrypt.org/how-it-works/>How It Works</a> を参照して設定すればよいと書いてあった。</p><h2 id=mdbook-の初期設定>mdbook の初期設定</h2><p>mdbook は新しい rust のバージョンだとビルドできなかったりするので rustup を使ってローカルに rustc をインストールするのがよいかもしれない。プラグインとしては <a href=https://github.com/badboy/mdbook-mermaid>mdbook-mermaid</a> を使う。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl --proto <span style=color:#e6db74>&#39;=https&#39;</span> --tlsv1.2 -sSf https://sh.rustup.rs | sh
</span></span><span style=display:flex><span>$ ~/.cargo/bin/rustc --version
</span></span><span style=display:flex><span>$ cargo install mdbook mdbook-mermaid
</span></span></code></pre></div><p>mdbook-mermaid の設定も簡単でドキュメントルート配下に mermaid の js ファイルを配置すると動いた。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ vi book.toml
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>preprocessor.mermaid<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>command <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;mdbook-mermaid&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>output.html<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>additional-js <span style=color:#f92672>=</span> <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;mermaid.min.js&#34;</span>, <span style=color:#e6db74>&#34;mermaid-init.js&#34;</span><span style=color:#f92672>]</span>
</span></span></code></pre></div></div></article><div class=pagination><div class=pagination__buttons><a href=/diary/posts/page/13/ class="button previous"><span class=button__icon>←</span>
<span class=button__text>最近の日記</span></a>
<a href=/diary/posts/page/15/ class="button next"><span class=button__text>過去の日記</span>
<span class=button__icon>→</span></a></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>© 2021 Tetsuya Morimoto</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>