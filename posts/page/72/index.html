<!doctype html><html lang=en><head><title>Posts :: </title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/posts/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="Posts"><meta property="og:description" content><meta property="og:url" content="/diary/posts/"><meta property="og:site_name" content><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/posts/index.xml rel=alternate type=application/rss+xml title></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><div class=posts><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0710/>放置していたバグを直した</a></h1><div class=post-meta><time class=post-date>2022-07-10 (Sun.) ::</time></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/government/>government</a>&nbsp;
#<a href=/diary/tags/github/>github</a>&nbsp;
#<a href=/diary/tags/ci/cd/>ci/cd</a>&nbsp;</span><div class=post-content><p>1時に寝て7時に起きた。寝ていて夜中に吐き気して眠れなくて上体を起こすしかなかった。たまにある <a href=/diary/posts/2021/1114/#傾斜枕>胃食道逆流症</a> のひどいやつ。</p><h2 id=参議院選挙>参議院選挙</h2><p>普段は期日前投票で済ませるのだけど、今週は他のことに注意を取られていたせいか、当日行ってきた。場所が期日前と違ったので勝手がわからなかったけど、とくに混雑もしてなかったのですぐに完了できた。タイムラインを眺めると、私のタイムライン上では投票したと発言する人が増えてきたように思う。投票率が50%程度で半分ぐらいの人が投票していない状況に懸念をもつ人たちの可視化がされている。</p><figure><img src=/diary/img/2022/0710_voted.jpg></figure><p>ふと父の選挙はどうなるんだろう？と思って検索してみた。意思表示できない状態だと選挙はできないみたい。</p><blockquote><p>選挙人本人が投票所に行き自らの意思で投票することが原則であることから、意思表示が困難である場合には投票することはできません。これは投票所の係員が選挙人の投票を補助する代理投票においても同様です。したがって、家族の方が本人に代わって投票することはできません。</p><p><a href=https://help.city.kobe.lg.jp/hc/ja/articles/4488187002767-%E6%84%8F%E6%80%9D%E8%A1%A8%E7%A4%BA%E3%81%8C%E5%9B%B0%E9%9B%A3%E3%81%AA%E9%81%B8%E6%8C%99%E4%BA%BA%E3%81%AB%E4%BB%A3%E3%82%8F%E3%81%A3%E3%81%A6-%E5%AE%B6%E6%97%8F%E3%81%8C%E6%8A%95%E7%A5%A8%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95%E3%81%AF%E3%81%82%E3%82%8A%E3%81%BE%E3%81%99%E3%81%8B->神戸市 FAQ > 市政情報 > 選挙</a></p></blockquote><p>70歳以上は傷病で選挙権を行使できない人たちもいるだろうから減るのかな？と、総務省の <a href=https://www.soumu.go.jp/senkyo/senkyo_s/news/sonota/nendaibetu/>年代別投票率</a> のグラフを確認してみた。直近だと、70歳以上が61.96, 60歳代が71.43、50歳代が62.96だった。60歳代と比べて減ってはいるけど、50歳代とそう変わらないのをみると、元気な人たちに選挙へ行こうと呼びかけるのは正しい気がした。</p><h2 id=backlog-github-integration-action-のバグ修正>backlog-github-integration-action のバグ修正</h2><p>運用してすぐにコミットメッセージ中にシングルクォートやダブルクォートが含まれると引数を正しくパースできなくてエラーになることがわかっていた。いま運用している環境の用途だと、それほど重要ではないので後回しにしているうちに面倒になって放置していた。晩ご飯を食べてからデバッグしていたら7時間ぐらいやってた。</p><ul><li><a href=https://github.com/kazamori/backlog-github-integration-action/issues/6>push subcommand is failed when a commit message includes single quote or double quote #6</a></li></ul><p>bash 上の文字列の扱いと action.yml の inputs の args に引数渡しするときの振る舞いの勘違いもあって、issue の見た目以上に複雑な振る舞いをしていることがわかった。github actions 上のコンテキストに依存したくなかったため、<code>github.event.commits</code> の json をそのまま cli パラメーターとして渡している。bash 上の json 文字列と cli パラメーターとしての扱いが煩雑になるのでこのやり方は失敗だったかもしれない。ローカルでのテストもやりにくい。私はそのことをよく理解していたはずなのに github actoins 上のアンチパターンにはまってしまった。カスタムアクションのユーザーが簡単に使えるように cli パラメーターの設定を簡単にする意図で json 渡しにしたんだけど、エスケープの振る舞いが想像以上にややこしくなって、エスケープしたいユーザーには簡単ではなくなってしまった。それでもデバッグをがんばったおかげでシングルクォートは完全に使えるように実装できた。ダブルクォートは制限付きでエラーにならなくできるが、事実上は使わないでくださいといった仕様制限にしてしまおうと思う。引用するときはダブルクォートじゃなくてシングルクォートを使ってくださいと啓蒙することに決めた。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0709/>github actions の push イベントワークフロー改善</a></h1><div class=post-meta><time class=post-date>2022-07-09 (Sat.) ::</time></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/github/>github</a>&nbsp;
#<a href=/diary/tags/ci/cd/>ci/cd</a>&nbsp;</span><div class=post-content><p>23時に寝て6時に起きた。今週はサービスインで凸凹していて疲れた。</p><h2 id=ストレッチ>ストレッチ</h2><p>今日の開脚幅は開始前161cmで、ストレッチ後164cmだった。ちょっと数値がよくなった。一昨日の日本酒イベントで4時間ほど立ち呑みをしていた疲労で腰に張りが少しあった。それ以外はとくに問題はなくて調子がよかった。右股関節の詰まりも2-3週間前よりもよくなっている気がする。これはトレーナーさんも注意を払って詰まりを取り除くようにストレッチのメニューを組んでくれているのでその成果が徐々に出始めている気がする。以前よりも可動領域が広がってきている気がして安心感を得た。</p><h2 id=github-actions-の-push-イベントワークフロー改善>github actions の push イベントワークフロー改善</h2><p>午後からビルド・デプロイの最適化のために github actions のワークフローを改善作業をしていた。</p><p>今週はサービスインにより、本番環境への緊急リリースを何回もやっているのを傍からみていて、ビルド・デプロイが速くなればなるほど、その回数を増やせるし、修正後の検証に時間を多く割ける。あるリポジトリが7つのモジュールをまとめてビルド・デプロイしている。これはあるモジュールの微修正の反映には向かないので改善することにした。結果として最大で50%ぐらいのビルド時間の削減、モジュールに依っては、具体的には10分かかっていたものを4分台でビルドできるようにした。</p><p>ワークフロー改善のためのデバッグしている間はビルド・デプロイが出来なくなることから開発者が使っていない時間帯が望ましい。必然的にサービス休日出勤して github actions のワークフローを改善していた。デバッグと動作の検証も兼ねて午後から半日以上やっていたので休日にやったのは正解だと言えるだろう。</p><p>push イベントの github コンテキストの <code>github.event.commits</code> にコミット情報が入っていて、そこにコミットのリビジョンがある。例えば、次のようなオブジェクトで <code>id</code> がコミットのリビジョンに相当する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>[
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;author&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;email&#34;</span>: <span style=color:#e6db74>&#34;...&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;...&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;username&#34;</span>: <span style=color:#e6db74>&#34;t2y&#34;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;committer&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;email&#34;</span>: <span style=color:#e6db74>&#34;...&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;...&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;username&#34;</span>: <span style=color:#e6db74>&#34;t2y&#34;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;distinct&#34;</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#e6db74>&#34;f8df1f77ffec9ef234e7321b2e237b663256b01c&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;message&#34;</span>: <span style=color:#e6db74>&#34;コミットログのメッセージ&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;timestamp&#34;</span>: <span style=color:#e6db74>&#34;2022-07-08T12:32:33+09:00&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;tree_id&#34;</span>: <span style=color:#e6db74>&#34;37b066734e58779c5d2c687d40b4cc43af177cb2&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;url&#34;</span>: <span style=color:#e6db74>&#34;https://github.com/OWNER/REPO/commit/f8df1f77ffec9ef234e7321b2e237b663256b01c&#34;</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>...</span>
</span></span><span style=display:flex><span>]
</span></span></code></pre></div><p>このリビジョンを使って <a href=https://docs.github.com/en/rest/commits/commits#get-a-commit>github rest api</a> からファイル情報を取得できる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ gh api -H <span style=color:#e6db74>&#34;Accept: application/vnd.github+json&#34;</span> /repos/OWNER/REPO/commits/f8df1f77ffec9ef234e7321b2e237b663256b01c
</span></span></code></pre></div><p>いろんなデータが返ってくるけど、ここでは変更したファイルのパスを知りたい。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;sha&#34;</span>: <span style=color:#e6db74>&#34;...&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;node_id&#34;</span>: <span style=color:#e6db74>&#34;...&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;commit&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>...</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;files&#34;</span>: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;sha&#34;</span>: <span style=color:#e6db74>&#34;...&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;filename&#34;</span>: <span style=color:#e6db74>&#34;module1/path/to/src&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#960050;background-color:#1e0010>...</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;sha&#34;</span>: <span style=color:#e6db74>&#34;...&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;filename&#34;</span>: <span style=color:#e6db74>&#34;module2/path/to/src&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#960050;background-color:#1e0010>...</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>この <code>filename</code> のトップディレクトリがモジュール名と同じなのでここだけ取り出して、管理対象のモジュールかどうかを比較する。bash でも <code>=~</code> をサブ文字列のマッチングができる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ targets<span style=color:#f92672>=(</span>mymodule1 mymodule2<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>$ echo <span style=color:#e6db74>&#34; </span><span style=color:#e6db74>${</span>targets[@]<span style=color:#e6db74>}</span><span style=color:#e6db74> &#34;</span>
</span></span><span style=display:flex><span> mymodule1 mymodule2 
</span></span><span style=display:flex><span>$ <span style=color:#f92672>[[</span> <span style=color:#e6db74>&#34; </span><span style=color:#e6db74>${</span>targets[@]<span style=color:#e6db74>}</span><span style=color:#e6db74> &#34;</span> <span style=color:#f92672>=</span>~ <span style=color:#e6db74>&#34; mymodule1 &#34;</span> <span style=color:#f92672>]]</span> <span style=color:#f92672>&amp;&amp;</span> echo <span style=color:#e6db74>&#34;match&#34;</span>
</span></span><span style=display:flex><span>match
</span></span><span style=display:flex><span>$ <span style=color:#f92672>[[</span> <span style=color:#e6db74>&#34; </span><span style=color:#e6db74>${</span>targets[@]<span style=color:#e6db74>}</span><span style=color:#e6db74> &#34;</span> <span style=color:#f92672>=</span>~ <span style=color:#e6db74>&#34; mymodule2 &#34;</span> <span style=color:#f92672>]]</span> <span style=color:#f92672>&amp;&amp;</span> echo <span style=color:#e6db74>&#34;match&#34;</span>
</span></span><span style=display:flex><span>match
</span></span></code></pre></div><p>さらにマッチしたモジュールを <a href=https://docs.github.com/en/actions/learn-github-actions/expressions>github actions の expressions</a> で制御しやすいように json の array に変換する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ jq --compact-output --null-input <span style=color:#e6db74>&#39;$ARGS.positional&#39;</span> --args -- <span style=color:#e6db74>${</span>targets[@]<span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span><span style=color:#e6db74>&#34;mymodule1&#34;</span>,<span style=color:#e6db74>&#34;mymodule2&#34;</span><span style=color:#f92672>]</span>
</span></span></code></pre></div><p>これを step の outputs として格納する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>echo <span style=color:#e6db74>&#34;::set-output name=modules::</span><span style=color:#e6db74>${</span>json_array<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span></code></pre></div><p>例えば、後続の job で実行条件としてモジュールの有無を調べたいときは expressions を使って次のように記述できる。if 文は <code>${{ ... }}</code> のブラケットを省略できるようだけど、ここだけ省略すると返って混乱するかなと思って私は記述するようにしている。その方が統合性があってコードが読みやすいように私は考えている。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>  mymodule1-job:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>: <span style=color:#e6db74>${</span>{ contains(fromJSON(needs.build.outputs.mymodule_target.modules), <span style=color:#e6db74>&#39;mymodule1&#39;</span>) <span style=color:#e6db74>}</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    needs:
</span></span><span style=display:flex><span>      - build
</span></span></code></pre></div><p>ちなみに workflow レベルの env は job の if 文には使えない。outputs を使って動的な値を扱うようにしている。どうも workflow レベルの env はいろいろ問題があるみたいでなかなか issue がクローズされないのをみると取り扱い注意なのかもしれない。</p><ul><li><a href=https://github.com/actions/runner/issues/480>Workflow level env does not work properly in all fields. #480</a></li><li><a href=https://github.com/actions/runner/issues/1661>workflow level env. is unrecognised on job level&rsquo;s &lsquo;if&rsquo;-expression when calling reusable workflow #1661</a></li></ul><p>最終的なモジュールを判別するための step は次のようなものになった。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span>  <span style=color:#f92672>build</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>outputs</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>mymodule_target</span>: <span style=color:#ae81ff>${{ steps.mymodule-target.outputs.modules }}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>steps</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>コミットログからビルド対象のモジュールを設定</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>id</span>: <span style=color:#ae81ff>mymodule-target</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>run</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        declare -A modules
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        target_modules=${{ env.TARGET_MODULES }}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        revisions=$(jq --raw-output &#39;.[].id&#39; &lt;&lt;&lt; &#39;${{ env.COMMITS }}&#39;)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        for revision in ${revisions}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        do
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          names=$(gh api -H &#34;${{ env.ACCEPT_HEADER }}&#34; ${{ env.COMMITS_PATH }}/${revision} | jq --raw-output &#39;.files[].filename&#39; | cut -d&#34;/&#34; -f1 | sort -u)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          for name in $names
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          do
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            if [[ &#34; ${target_modules[@]} &#34; =~ &#34; ${name} &#34; ]]; then
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              modules[${name}]=true
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            fi
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          done
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        done
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        targets=$(jq --compact-output --null-input &#39;$ARGS.positional&#39; --args -- &#34;${!modules[@]}&#34;)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        echo &#34;::set-output name=modules::${targets}&#34;</span>        
</span></span><span style=display:flex><span>      <span style=color:#f92672>env</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>TARGET_MODULES</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          (
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &#39;mymodule1&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &#39;mymodule2&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          )</span>          
</span></span><span style=display:flex><span>        <span style=color:#f92672>ACCEPT_HEADER</span>: <span style=color:#e6db74>&#34;Accept: application/vnd.github+json&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>COMMITS_PATH</span>: <span style=color:#ae81ff>/repos/${{ github.repository }}/commits</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>COMMITS</span>: <span style=color:#ae81ff>${{ toJSON(github.event.commits) }}</span>
</span></span></code></pre></div><p>処理も理屈も簡単なんだけど、実際の運用コードはもう少しだけ複雑なものの、デバッグは github actions を実行しないといけない。ちょっとした typo のために実は2時間ほどはまっていたのは内緒。シェルの配列や連想配列を使うと、記号が多くてわかりにくい。配列の閉じブラケットを忘れていたがために EOF のエラーが発生していた。閉じブラケットのミスだけにエラーが発生しているところと実際のコードがズレていて、それに気付くのに少しずつコードを足したり消したりしてデバッグするみたいな原始的なやり方で些細な typo を気付くのに時間がかかった。</p><pre tabindex=0><code>xxx.sh: line 47: unexpected EOF while looking for matching `&#34;&#39;
</code></pre></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0708/>ゾンビスクラムを教えてもらった</a></h1><div class=post-meta><time class=post-date>2022-07-08 (Fri.) ::</time></div><span class=post-tags>#<a href=/diary/tags/founding/>founding</a>&nbsp;
#<a href=/diary/tags/scrum/>scrum</a>&nbsp;
#<a href=/diary/tags/book/>book</a>&nbsp;</span><div class=post-content><p>2時に寝て7時に起きた。今週はバテた。金曜日は非稼働日だけど、バタバタしているから普通に働いていた。</p><h2 id=隔週の雑談>隔週の雑談</h2><p>顧問のはらさんと隔週の打ち合わせ。今週はお手伝い先がサービスインでバタバタしていて議題の準備がほとんどできなかった。少し前に参加したアトラシアンさんのウェブセミナーのスライド資料が公開されたのでそれを眺めながら雑談していた。</p><iframe class=speakerdeck-iframe frameborder=0 src=https://speakerdeck.com/player/18fafd386a534aa3b8cab2807af37b68 title="チャット連携で問い合わせ対応にスピードと透明性を ー Jira Service Managementで実現する対話型チケット管理/JSM-Chat-Webinar-20220629" allowfullscreen mozallowfullscreen=true webkitallowfullscreen=true style="border:0;background:padding-box padding-box rgba(0,0,0,.1);margin:0;padding:0;border-radius:6px;box-shadow:rgba(0,0,0,.2)0 5px 40px;width:560px;height:314px" data-ratio=1.78343949044586></iframe><p>jira の有料プランのサービスに jsm chat という <a href=https://www.atlassian.com/software/halp/jira>halp</a> の技術を活かした新機能が追加されたらしい。既存プランの延長上で使えるらしい。質疑応答のときに halp とは別プロダクトだと明確に回答していたので halp が今後どうなっていくのかの将来にはかなり懸念がある。チャットと課題管理システムの双方向連携という、slack や teams といったチャットサービスがよく使われるようになった昨今のビジネス事情にあわせたサービスと言えるだろう。</p><p>私も以前からその領域に課題意識をもっていたし、ベンチャーでは <a href=https://www.workstreams.ai/>workstreams.ai</a> も同様のサービスを提供している。満を持してというのか、(私にとっての) 課題管理システムのベースラインとなる jira にその機能が入ったことで競合製品も同様に機能拡張を提供していく気がする。1-2年後にはチャットと課題管理システムが双方向連携しているのが当たり前の開発スタイルになるのかもしれない。非開発者にとってはチケットを扱うよりも敷居が下がるのでそれは適切な世の中の変化だと私は考えている。</p><h2 id=ゾンビスクラム>ゾンビスクラム</h2><p>jsm chat と課題管理の話しをしているうちにスクラムの話題になった。Zombie Scrum Survival Guide という書籍があって形骸化したスクラムの特徴をまとめているらしい。ある記事で2021年から翻訳していると書いてあったので翻訳版が出版されたら読んでみようと思う。</p><ul><li><a href=https://agnozingdays.hatenablog.com/entry/2020/11/17/183803>「ゾンビスクラムサバイバルガイド」読んだ飼育係の日記</a></li><li><a href=https://takaokimura.medium.com/%E3%82%BE%E3%83%B3%E3%83%93%E3%82%B9%E3%82%AF%E3%83%A9%E3%83%A0%E3%81%AE4%E3%81%A4%E3%81%AE%E7%97%87%E7%8A%B6-45efd6e9c655>ゾンビスクラムの4つの症状</a></li><li><a href=https://www.servantworks.co.jp/posts/10-success-factors-to-resolve-zombie-scrum/>ゾンビスクラムを解決するための10の成功要因</a></li></ul><p>ブログ記事の所感を読んだ感じだと、私がいま関わっているスクラムにも一部通じるところがあるなと思って関心がある。</p><p>うちのチームは1週間スプリントをもう1年近く続けているのだけど、これは検査が早い段階でできるというメリットがあるものの、開発のメリハリがないなぁとずっと思ってた。それはただ与えられたタスクを無理なくこなすだけというルーチンになってしまっているのと、昨今の労務管理を徹底する働き方改革？のせいか、残業・休出を一切やらない開発スタイルが開発者の自律性や意欲を削いでしまっているのではないかとも思う。もちろん「余白」があれば、業務時間内に好きなことをやったらよいと思うけれど、うちの場合は半分ぐらいのスプリントゴールが未達で、スプリントに達成できないタスクを盛り込むからスプリントゴール未達の状態で他のことをやるのが憚られる空気がある。もっとも好き勝手やっている私がそれを感じるのだから、若い開発者には相応のプレッシャーになっていると思う。結果として、指示されたタスク (プランニングで決めたこと) 以外のことはやらない雰囲気になってしまっている。試しに直近3ヶ月のスプリントバックログアイテムの種別のみで開発者のチケット登録した数をカウントすると次のようになった。</p><ul><li>私: 66件</li><li>開発リーダー: 17件</li><li>開発者1: 14件</li><li>開発者2: 12件</li><li>開発者3: 1件</li><li>開発者4: 6件</li></ul><p>これは課題管理システムに慣れていて、業務をタスク分解しながら作業していくというワークフローに私が最も習熟しているから、適度な粒度のチケットをいくつも作りながら作業をやっているという背景もある。しかし、いまやらなくてもいずれ必要なタスクも、業務をやりながら気付いたときに私は随時登録している。憚られる空気を感じている私が週4日労働で控えめにやっても3ヶ月でもこれだけの数が開く。要はゾンビスクラムだと開発者の自律性は期待できないという話し。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0707/>七夕と日本酒</a></h1><div class=post-meta><time class=post-date>2022-07-07 (Thu.) ::</time></div><span class=post-tags>#<a href=/diary/tags/event/>event</a>&nbsp;
#<a href=/diary/tags/community/>community</a>&nbsp;
#<a href=/diary/tags/drinking/>drinking</a>&nbsp;
#<a href=/diary/tags/kobe/>kobe</a>&nbsp;
#<a href=/diary/tags/sake/>sake</a>&nbsp;</span><div class=post-content><p>1時に寝て7時に起きた。</p><h2 id=障害対応の手伝い>障害対応の手伝い</h2><p>昨日の続きで定期処理を k8s の cronjob へすべて移行した。その後、チケット整理したり、他メンバーの手がまわっていない作業を手伝ったりしてた。バッチ処理の在庫チェックの数字があわなくて「俺たちは雰囲気で在庫チェックをやっている」みたいな状況に陥っていた。とはいえ、サービスイン3日目でも致命的な運用の問題は発生していないということでこのリリースはもう完了したと断言してしまってもよいだろう。今後、数ヶ月かけてさらに他施設へのサービスインが続いていくわけだけど、見通しはみえてきた感じはする。まぁ大丈夫そう。</p><h2 id=灘五郷酒所イベント>灘五郷酒所イベント</h2><p>なにかのきっかけで <a href=https://camp-fire.jp/projects/view/585844>クラウドファンディングの灘五郷酒所</a> をみつけた。地元の応援をしとくかと思って5,000円を支援した。いまみたら271人の支援者から1,472,900円の支援金が集まったみたい。その支援金のお礼イベントがあって、せっかくの機会なので行ってきた。5,000円ってちょっとよい居酒屋さんで使うぐらいの金額だけど、その場で飲める2,000円分の金券とお腹いっぱい食べられたビッフェ形式で十分に飲み食いできた。写真にある料理をもう1皿もらってきてお腹いっぱいになった。料理はなくなっても補充されていたので十分に用意されていた。支払った支援金を考慮すると十分に良心的なイベントだった。小耳に聞いた話だと80人ほど参加者がいたらしい。</p><p>飲んだお酒はこれら。あと竹酒と呼ばれる竹の筒に入れて主催者がついでまわっていたのを2杯ほど飲んだ。</p><ul><li>福寿 純米酒「御影郷」 (神戸酒心館)</li><li>琥泉 純米吟醸おりがらみ無濾過生酒原酒 (泉酒造)</li><li>黒松剣菱 (剣菱酒造)</li><li>浜福鶴 生酛純米辛口 (小山本家酒造 灘浜福鶴蔵)</li></ul><p><figure><img src=/diary/img/2022/0707_sake1.jpg></figure><figure><img src=/diary/img/2022/0707_sake2.jpg></figure><figure><img src=/diary/img/2022/0707_sake3.jpg></figure></p><p>1人で行ったのでぼっちだったらどうしよう？みたいな不安もあったんだけど、たまたま隣り合わせた人が <a href=https://www.instagram.com/nihonsyu_kai/>プライズ日本酒会</a> というコミュニティのメンバーで4人組で参加していた。その人たちと雑談してた。ご近所さんでとてもよい人たちだった。三ノ宮でお酒イベントをやっているそうで、また機会があればそちらにも参加してみようと思う。私は地元の人たちとのコネがほとんどない。今後会社のマーケティングをやっていく上でも地元の人たちともなにかしら繋がりをもてるとよいなとは考えている。お仕事がバタバタしてたから朝の時点では行くのをやめようかと考えていたけど、午後から落ち着いていたのもあって行ってよかった。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0706/>lambda から cronjob へ</a></h1><div class=post-meta><time class=post-date>2022-07-06 (Wed.) ::</time></div><span class=post-tags>#<a href=/diary/tags/cdk/>cdk</a>&nbsp;
#<a href=/diary/tags/kubernetes/>kubernetes</a>&nbsp;</span><div class=post-content><p>0時に6時に起きた。今日は晴れたので自転車通勤。</p><h2 id=優雅にドキュメントを書きながら障害対応>優雅にドキュメントを書きながら障害対応</h2><p>昨日は凸凹しながら乗り切ってサービスイン2日目。今日から外部システムとの連携なども絡んでくる。昨日の今日なんで何か起こるだろうと思いつつ、暇だったらドキュメント書くタスクがいくつも溜まっているのでそれを片付けるかと業務を始めた。私ぐらいの人間になると、いつ凸凹が発生してもよいように、この日のために取っておいたようなドキュメントタスクがいくつも溜まっている。午前中に私の出番はなく、優雅にドキュメントの1つを完成させた。</p><p>以前から定期実行やバッチ処理は lambda 関数をトリガーに作られていた。それらを <a href=/diary/posts/2022/0609/#serverless-framework-から-cdk-移行の背景>serverless framework から cdk へ移行した</a> んだけど、その後にバッチ処理を <a href=/diary/posts/2022/0622/>k8s の cronjob で実装した</a> 。この cronjob が思いの外、うまくいって、私がフルスクラッチで cli を作っているのだから、私からみてさいきょうのばっちしょりの土台を実装している。定期実行もすべて cronjob でやればいいやんと気付いて、過去に lambda 関数 (cdk/python) で実装したものをすべて移行することに決めた。昨日の流れからわかるように過去に作成済みの一連の lambda 関数はまだ本番環境にデプロイされていない。<a href=/diary/posts/2022/0704/>m1 chip macbook 問題</a> で同僚のマシンからデプロイできないという不運もあったんだけど、もうデプロイしなくていいよ、すべて cronjob で置き換えるからと伝えて2つ移行した。あと半日もあれば完了できそうな見通し。</p><p>lambda 関数から cronjob への移行作業をしていると、本番環境でのバッチ処理の一部のロジックが誤っているとわかってそれを修正したり、当然のようにテスト環境のデータも誤っているので正しいかどうかは本番環境にデプロイするしかないみたいな凸凹した状況を横切りながら本日の作業を終えた。いくつか残課題は残っているものの、明日中には平常業務に戻れるぐらいの状況にはなりつつあるのかもしれない。サービスイン2日目を終えて致命的な問題は起こっていないようにみえる。ひとまずはよかったという感じ。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0705/>サービスインは突然に</a></h1><div class=post-meta><time class=post-date>2022-07-05 (Tue.) ::</time></div><span class=post-tags>#<a href=/diary/tags/cdk/>cdk</a>&nbsp;
#<a href=/diary/tags/infrastructure/>infrastructure</a>&nbsp;</span><div class=post-content><p>1時に寝て6時に起きた。暑くてあまり眠れない。今朝も雨降りで徒歩通勤。</p><h2 id=cdk-の-ecs-サービスに紐づくセキュリティグループの設定>cdk の ECS サービスに紐づくセキュリティグループの設定</h2><p>明日がサービスイン初日だと思っていたら、私の勘違いで今日だった。私が直近でやっている作業はアプリケーションの直接的な機能ではなく、インフラやバッチ処理などの間接的な機能を作っているわけだけど、それでも1日調整を間違えていて、あれーって感じでサービスインが始まった。とはいえ、私は本番環境にアクセスできなければ、ログすらもみれないので同僚ががんばっているのを傍から応援しつつ、平常通りタスクをこなしていくだけのはずであった。</p><p>のほほんと通常通りのタスクをやっていたら、本番環境の ecs サービスと通信できないという連絡がくる。私が前任者から引き継いで構築したインフラなので何だろう？と調査していて、本番環境でセキュリティグループの設定が漏れていることがわかった。これはわかりにくい問題で cdk の FargateService で ecs サービスを構築している。このプロパティは securityGroups のパラメーターをもっている。このパラメーターを指定しない場合、新規にセキュリティグループそのものは作成してくれるけれど、その ecs サービスへ通信するポートへのインバウンドルールは作ってくれない。</p><blockquote><p>securityGroups?</p><p>Type: ISecurityGroup[] (optional, default: A new security group is created.)</p><p>The security groups to associate with the service.
If you do not specify a security group, a new security group is created.</p><p><a href=https://docs.aws.amazon.com/cdk/api/v2/docs/aws-cdk-lib.aws_ecs.FargateService.html#securitygroups>https://docs.aws.amazon.com/cdk/api/v2/docs/aws-cdk-lib.aws_ecs.FargateService.html#securitygroups</a></p></blockquote><p>テスト環境はセキュリティグループに対して、インバウンドルールを管理画面から手動で追加していたために疎通できていた。セキュリティグループは ecs サービスに紐付いているものだから、ecs サービスを再作成しない限りはインバウンドルールが消えることもなくてこの作業漏れに気付けなかったという落ちだった。さらに、そのセキュリティグループのインバウンドルールを設定したのは私ではない。その説明欄に次のコメントが書かれていた。</p><blockquote><p>atode-kesu</p></blockquote><p>今すぐ消してやろうかという気持ちを抑えつつ、cdk でインバウンドルールを設定したセキュリティグループを紐付けるようにして解決した。疎通ができないと、ロードバランサーのヘルスチェックが通らず、ecs のタスクが延々と再起動を繰り返すというわかりにくい障害となっていた。1時間ぐらい唸っていた。</p><h2 id=未検証の本番環境>未検証の本番環境</h2><p>前節で障害の原因自体はわかりにくいものだが、なぜサービスインの初日にこんなことが起こるのだろうか？という当然の疑問。そう。これまでこのインフラの本番環境は一切検証されていなかった。4月から5月にかけて構築されたインフラだった。この後にデータを格納するための s3 bucket がない、一部の設定はテスト環境の設定しかない、アプリケーションのコード中にテスト環境の設定がハードコードされているとか。追加であちこち直してデプロイしていた。私は本番環境に一切アクセスできないので過去にこれらの検証をすることはできなかったわけではあるけど、いろいろ思うところはあるなぁと感慨に浸っていた。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0704/>m1 chip macbook と cdk の追加調査</a></h1><div class=post-meta><time class=post-date>2022-07-04 (Mon.) ::</time></div><span class=post-tags>#<a href=/diary/tags/cdk/>cdk</a>&nbsp;
#<a href=/diary/tags/infrastructure/>infrastructure</a>&nbsp;</span><div class=post-content><p>0時に寝て7時に起きた。昨日はずっと寝てて、今朝は雨降りで徒歩通勤。週始めからしんどい。</p><h2 id=デバッグ調査を断念>デバッグ調査を断念</h2><p>以前 <a href=/diary/posts/2022/0630/#m1-chip-macbook-で-aws-lambda-python-alpha-のデプロイができない>m1 chip macbook で aws-lambda-python-alpha のデプロイができない</a> ことについて書いた。同僚がそのためにデプロイできないと運用上の不都合があるので調査してみることにした。ワークアラウンドの1つとして、ビルドに使う Docker イメージを任意のものに置き換える仕組みを使えば、arm64 アーキテクチャでビルド処理のプロセス自体は通ることを確認していた。しかし、その後の python distribution が生成されていなかった。同僚にデバッグを手伝ってもらってログをみていると、python distribution をバンドルする処理のログが出ていない。</p><p>おそらく docker イメージのビルド処理ではなく、aws-cdk の core 側の bundling のところに原因がありそうに思える。core のライブラリをみると、たしかにいくつか条件次第で bundling をスキップする実装はあったし、ログが出力されていないことからも意図したステップが実行されていないことだけはわかった。その周辺から当たりをつけて aws-cdk の issues なども検索してみたけど、それっぽい issue をみつけることはできなかった。何よりも私がもっていないマシン環境の、様々な環境設定を調べることもできず、aws-cdk の core をデバッグするのも大変かなと午前中いっぱい調べて断念することに決めた。もしかしたら同僚のホスト環境に特化した問題が発生している可能性もある。</p><p>アプリケーションレベルで再現できた問題を解決できないというのは情けないけど、自分でデバッグできないものは仕方ないかと諦めることにした。本当に悔しいけれど。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0703/>夏休み</a></h1><div class=post-meta><time class=post-date>2022-07-03 (Sun.) ::</time></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/day-off/>day off</a>&nbsp;</span><div class=post-content><p>0時に寝て7時に起きたけど、昨日から体調よくなくてしんどくて寝てた。</p><p>開発やら決算の事務手続きやらのタスクが一段落して余裕時間ができたことでぼーっとしてた。まぁたまにはそういう日もあるか。何も作業せず休んだ日は <a href=/diary/tags/day-off/>day off</a> というタグを付ける。あとで何日ぐらい休んだか、どのぐらいの期間で休んだかの確認にもなるかもしれない。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0702/>夏バテ</a></h1><div class=post-meta><time class=post-date>2022-07-02 (Sat.) ::</time></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;</span><div class=post-content><p>0時に寝て7時に起きた。途中で吐き気がして何度も起きた。夜うまく眠れない。</p><h2 id=ストレッチ>ストレッチ</h2><p>今日の開脚幅は開始前160cmで、ストレッチ後163cmだった。先週とほぼ同じでよい状態を維持できている。外が暑くなってその比較から dr.stretch さんの事務所はエアコンがよくきいていて涼しい。うちのオフィスはエアコンの設定温度を上げる人がいて気付くと26.5℃とかに設定されていて私にとっては暑い。とくにどこか張りの強い部位や痛いところはなかった。夜にあまり眠れないわりには身体的には負荷がかかっているところはなさそう。</p><p>ストレッチを終えてからオフィスに戻って軽く調べものして、眠くなって仮眠して、そのまま家に帰って寝てた。とくに急ぎでやるタスクがなかったせいか、なんか一気にバテた。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0701/>法人決算の会計処理を終えた</a></h1><div class=post-meta><time class=post-date>2022-07-01 (Fri.) ::</time></div><span class=post-tags>#<a href=/diary/tags/founding/>founding</a>&nbsp;
#<a href=/diary/tags/tax/>tax</a>&nbsp;
#<a href=/diary/tags/web3/>web3</a>&nbsp;
#<a href=/diary/tags/event/>event</a>&nbsp;</span><div class=post-content><p>0時に寝て6時に起きた。夜あまり眠れない。</p><h2 id=算定基礎届>算定基礎届</h2><p><a href=https://shinsei.e-gov.go.jp/>e-gov電子申請</a> を使って初めて電子申請してみた。昨年もやろうと挑戦したけど、macos からだと不具合があってエラーになるから断念してた。今年は windows マシンがあるので windows アプリケーションをインストールして問題なく申請できた。うちは社員1人なので csv 取り込みを使わず、手入力で申請した。申請した書類は pdf 出力できるし、申請後に送信したデータは xml で控えとして保持できる。本当に紙でやっていたものを文書データと数値データに置き換えたようなアプリケーションになっている。紙の書類と比べて、アプリケーションがよいところは申請の進捗状況がわかるところ。算定基礎届で問題が発生することは過去にないけど、審査開始、審査終了、手続終了のステータスをアプリケーションから確認できる。それはそれで申請者にとって状況の追跡ができて安心感になる。</p><h2 id=振替伝票の使い方>振替伝票の使い方</h2><p>前期は赤字決算だったので中間申告で支払った税金が還付される。中間申告というのは、前年度の納税金額から翌年の税金の半分を納めるという仕組み。前年度の法人税額が20万円を超えると中間申告が必要となる。前年度と同じ法人税が今年度もあるという前提で半分納めるけれど、その納めた金額よりも確定申告のタイミングで実際の納税金額が少ない場合は還付金という形で返ってくる。今回は赤字決算となったものの、それも初めてだったので税務署からの還付金をどう会計処理するのかも初めての機会でよくわからなくて調べながら作業した。</p><p>会計システムとして普通に行う処理ではないので freee のドキュメントも断片的にしか説明されていない。基本的な操作の考え方を理解した上で自分がやりたい会計処理に変更しないといけない。</p><ul><li><a href=https://support.freee.co.jp/hc/ja/articles/360000917903-%E5%8F%96%E5%BC%95%E3%82%92%E9%A0%90%E3%82%8A%E9%87%91%E3%82%84%E4%BB%AE%E6%89%95%E9%87%91%E3%81%A7%E6%B1%BA%E6%B8%88%E3%81%99%E3%82%8B%E3%81%AB%E3%81%AF-%E3%81%A9%E3%81%86%E3%81%99%E3%82%8C%E3%81%B0%E3%81%84%E3%81%84%E3%81%A7%E3%81%99%E3%81%8B->取引を預り金や仮払金で決済するには、どうすればいいですか？</a></li><li><a href=https://support.freee.co.jp/hc/ja/articles/204614754#4>還付を受ける場合の処理</a></li></ul><p>まず中間申告のタイミングで振込した納付金額は「仮払金」として登録される。本来は確定申告のタイミングで確定した納付額に対して「仮払金」を相殺するような会計処理を行う必要がある。freee では取引データの決済欄に「+更新」というボタンがあってそこから仮払金から引き落とすようなデータ登録が可能となる。今回は赤字決算ですでに支払った「仮払金」が還付金として戻ってくるときの会計処理をしなければいけない。その手続きのために使うのが「振替伝票」になる。例として金額を10万円とすると次のような振替伝票を作成する。</p><ul><li>借方<ul><li>勘定科目: 未収入金</li><li>税区分: 対象外</li><li>金額: 10万円</li></ul></li><li>貸方<ul><li>勘定科目: 仮払金</li><li>税区分: 対象外</li><li>金額: 10万円</li></ul></li></ul><p>「仮払金」を相殺するための勘定科目は「未収入金」になる。この「未収入金」を還付金の取引 (税務署から銀行口座に振り込まれた金額) で消し込むことで会計システム上の辻褄があう。一般的に還付金の勘定科目は「雑収入」として扱うらしい。還付金は消費税がかからない取引であるので不課税取引となる。ややこしいのは還付金が振り込まれる際に還付加算金というお金も一緒に振り込みされる場合がある。還付加算金というのは、納め過ぎた税金に対する金利のようなものになる。試しに計算してみると金利が 0.46% になった。ある銀行の定期が 0.002% だったので税務署に税金を納め過ぎるとめちゃくちゃ金利のよい貯金みたいな扱いになる。話しを元に戻すと、還付加算金は課税対象になるので「雑収入」の課税売上として会計処理する。</p><p>うちの会社では、振替伝票は決算のタイミングでしか使わない。振替伝票の使い方を忘れていてたまに使うときに右往左往する。</p><h2 id=はんなりdao>はんなりDAO</h2><p><a href=https://hannari-python.connpass.com/event/251671/>はんなりDAOをはじめてみます</a> に参加した。イベントで話した内容は notion で公開されている。</p><ul><li><a href=https://chomoku.notion.site/chomoku/hannali-dao-080626065e614df89beb15c4b1272762>hannali-dao</a></li></ul><p>まだ全然、計画段階で段取りの計画も目処もたっていない。dao が良いものかどうか、私はまだよくわかっていないが、実際に自分で試してみることには肯定的である。そして組織の取り組みは実際に複数人いないとあまり実用的ではないことからコミュニティのような、一定以上の信頼のある実際の人間が関わってくれるならそれはそれで実証実験の場としてはおもしろい取り組みになるかもしれない。初回だったので dao とは何かとか、dao や web3 を取り巻く世の中の状況はどうかとか、はんなり dao の目的をどうするかとか、計画段階の雑談が主だった。最初はそんなもんかもしれない。私もスマートコントラクトとか、何が嬉しいのかよくわかってないので dao を運営する中で実際に実装してみる機会があれば、それはそれで学びの機会としてよいかもしれないと考えている。</p><p><a href=https://aragon.org/>aragon</a> という dao を作るためのプラットフォームがあって、これを使うと dao そのものはすぐに準備できるらしい。あとは組織運営のルールやスマートコントラクトを実装していくだけみたいな話し。ethereum で動かすと手数料がかかる。しばらくは testnet であーでもないこーでもないみたいなやり取りをしながら dao の運営を学んでいこうみたいな話しをしていた。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0630/>m1 chip macbook と cdk/aws-lambda は相性が悪い</a></h1><div class=post-meta><time class=post-date>2022-06-30 (Thu.) ::</time></div><span class=post-tags>#<a href=/diary/tags/cdk/>cdk</a>&nbsp;
#<a href=/diary/tags/infrastructure/>infrastructure</a>&nbsp;</span><div class=post-content><p>0時に寝て6時に起きた。</p><h2 id=m1-chip-macbook-で-aws-lambda-python-alpha-のデプロイができない>m1 chip macbook で aws-lambda-python-alpha のデプロイができない</h2><p>少し前に aws lambda の管理を <a href=/diary/posts/2022/0609/#serverless-framework-から-cdk-移行の背景>serverless framework から cdk 移行した</a> 。lambda 関数は python スクリプトで実装されているので <a href=https://www.npmjs.com/package/@aws-cdk/aws-lambda-python-alpha>@aws-cdk/aws-lambda-python-alpha</a> を使っている。このライブラリでは python distribution を作るときの python インタープリターをローカルのものではなく docker イメージを使って管理しているようにみえる。私の環境 (linux, x86_64) では何の問題もなかったのだけど、同僚が m1 chip macbook を使っていて、そのマシンからだと docker イメージを使ったビルド処理でエラーが発生する。それは既知の問題で次の issue で報告されている。</p><ul><li><a href=https://github.com/aws/aws-cdk/issues/18696>(lambda-python): arm64 architecture is not respected #18696</a></li><li><a href=https://github.com/aws/aws-cdk/issues/20907>(aws-lambda): Ability to specify CPU architecturefor building image #20907</a></li></ul><p>このワークアラウンドの1つとして <a href=https://docs.aws.amazon.com/cdk/api/v2/docs/aws-lambda-python-alpha-readme.html#custom-bundling>Custom Bundling</a> の仕組みがある。任意の Dockerfile を指定することで任意の Docker イメージやプラットフォーム向けにビルド用の python インタープリターを設定できる。そうしたらビルド処理そのものは通るようになったけど、python distribution (python の依存関係を含めたスクリプト群) が asset として生成されない。この現象自体も cdk でよくある issue として報告されていて <code>cdk.out</code> を削除して再実行したら直ったという報告もいくつかあるものの、同僚のマシンではそれでは解決しなかった。</p><ul><li><a href=https://github.com/aws/aws-cdk/issues/18459>(aws-lambda-nodejs): Uploaded file must be a non-empty zip #18459</a></li></ul><p>私が m1 chip macbook をもっていないので cdk のコードを修正して push して同僚に git pull して実行してもらうみたいな作業になっている。このデバッグはなかなか大変。</p></div></article><div class=pagination><div class=pagination__buttons><a href=/diary/posts/page/71/ class="button previous"><span class=button__icon>←</span>
<span class=button__text>最近の日記</span>
</a><a href=/diary/posts/page/73/ class="button next"><span class=button__text>過去の日記</span>
<span class=button__icon>→</span></a></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2024 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>