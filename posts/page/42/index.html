<!doctype html><html lang=en><head><title>Posts :: forest nook</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/posts/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="Posts"><meta property="og:description" content><meta property="og:url" content="/diary/posts/"><meta property="og:site_name" content="forest nook"><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/posts/index.xml rel=alternate type=application/rss+xml title="forest nook"></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><div class=posts><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0814/>スクラムの悪いところをあげてみる</a></h1><div class=post-meta><time class=post-date>2022-08-14 (Sun.) ::</time></div><span class=post-tags>#<a href=/diary/tags/scrum/>scrum</a>&nbsp;</span><div class=post-content><p>1時に寝て7時に起きて午前中はだらだらしていた。午後からオフィスでちょっと作業して夜はドラクエタクトしてた。</p><h2 id=スクラムの悪いところ>スクラムの悪いところ</h2><p>金曜日に <a href=https://hannari-python.connpass.com/event/255877/>メタバース雑談会</a> に参加してチームビルディングや課題管理の雑談になった。そのときに課題管理やスクラムの概要を話してみたけど、多様なメンバーだといま一つ手応えがなくてコンテキストを揃えないと組織論の話しは難しいなと思えた。コンテキストが共有できていない状況ではあまり雑談に向く話題ではなかった。そんな中でスクラムの悪いところを考える機会が最近多いので簡単にまとめてみようと思う。もちろん、スクラムにはよいところもたくさんあって世の中に普及しているのはそれがためだと思う。よいところはすでにあちこちで言われているだろうから、あえて、ここでは悪いところを整理してみようと思う。</p><ul><li>心理的安全性のないチームではぬるま湯と化す</li><li>プロダクトオーナーに超人を要求する</li><li>スクラムイベントが時間とともに形骸化していく</li></ul><p>スクラムが悪いのではなくチーム (組織) が悪いということもできるが、スクラムを1年近くやっていて陥っているのでスクラムの影響は大きいと考える。</p><h3 id=心理的安全性のないチームではぬるま湯と化す>心理的安全性のないチームではぬるま湯と化す</h3><p>スクラムでは個人の責任を問われることはなく、名前の通り、チーム一丸となって課題に取り組むことを意図するプラクティスなので、悪く言えば、個人の怠慢が問われることもまずない。ここでいう怠慢は悪意をもったものではないとしても <a href=https://ja.wikipedia.org/wiki/%E7%A4%BE%E4%BC%9A%E7%9A%84%E6%89%8B%E6%8A%9C%E3%81%8D>社会的手抜き</a> を容易に発生させる。個々のメンバーの責任を減少させると必然的に裁量も減少してしまう気がしている。ある課題がうまくいかなくても自分の責任とは言えない状況であればそのまま放置してチームが解決してくれるのを待つという選択が合理的になるケースが出てくる。これは人間の習性として抗いがたいと私は考えている。楽をしたいのが人間だと思う。必然的に楽な方に引き寄せられていく。克己心とまで言わなくても自分を律して課題に取り組んでいないとスクラムの枠組みではいくらでも楽をしてしまえる。業務としてその品質や納期に一定の厳しさをもっていないチームは簡単にぬるま湯と化してしまう。</p><h3 id=プロダクトオーナーに超人を要求する>プロダクトオーナーに超人を要求する</h3><p>以前、こみやさんと話していたときに出た話題。スクラムはすべての責任はプロダクトオーナーが負うことになっている。プロダクトオーナーは開発者でないことが多いと思われる。建前としては開発がうまくいかないことの責任をすべてプロダクトオーナーが負うことになるが、これはフェアとは言い難い状況もある。はらさんと話していると、プロダクトオーナーは無茶苦茶な要求を開発者にしてしまいがちなのでそれをなだめたり指導したりするポジションとしてスクラムマスターがいるという話しも聞く。うちのプロダクトオーナーは人格者でまったく無茶な要求をしない。おそらく現場出身の方なのでシステムに疎いことは周りも理解していて開発責任を問われていないのではないか推測する。プロダクトオーナーに責任が集中している割にスクラムマスターが盾になることで開発への口出しは制限される。またスクラムマスターも業務上の責任をなんら負っていない。スクラムマスターの助言を遂行する責任はすべてプロダクトオーナーに求められる。スクラムは業務の役割分担としてプロダクトオーナー、スクラムマスター、開発リーダーの三位一体のような構成を取るものの、責任をプロダクトオーナーに押し付けつつ、プロダクトオーナーの権限を奪う構成ともみれる。</p><h3 id=スクラムイベントが時間とともに形骸化していく>スクラムイベントが時間とともに形骸化していく</h3><p>スクラムに不慣れなチームがスクラムガイドに書いてあることを実践していくには少し時間がかかるし、スクラムマスターのようなスクラムガイドを熟知しているメンバーに指導を仰ぐのは理に適っている。しかし、半年もやればスクラムガイドの手順やワークフローをメンバーは習熟する。実際にうちのスクラムマスターはふりかえりのファシリテーション以外にやることがないとちょくちょく発言していて、実際にデイリースクラムも半分ぐらい休んでいる。ファシリテーション以外で業務のイニシアティブを取ることはない。スクラムマスターがドメイン知識を身につけるべきかどうか、私はまだわからないが、うちのスクラムマスターはドメイン知識を習得していないので業務の話にはまったく入ってこれない。少し前に <a href=/diary/posts/2022/0708/#ゾンビスクラム>ゾンビスクラム</a> という言葉を教えてもらったが、スクラムイベントのいくつかはただこなすだけの業務になりつつある。うちのチームのスプリントの実態やストーリーポイント運用は私からみたら課題だらけだが、ダメなところも含めてその予定調和に慣れてしまって複雑で難しい問題を改善しようとしていないように私からはみえている。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0813/>戦略シミュレーションと特性</a></h1><div class=post-meta><time class=post-date>2022-08-13 (Sat.) ::</time></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/game/>game</a>&nbsp;</span><div class=post-content><h2 id=ストレッチ>ストレッチ</h2><p>今日の開脚幅は開始前158cmで、ストレッチ後161cmだった。先週よりやや数字が悪くなった。それでも先週はストレッチを受けていても体全体のだるさのようなものを感じていたのが、今回はちゃんと筋を伸ばしている感覚があって先週の体調の悪さはなくなったように思える。右股関節周りの詰まりに加えて、右前ももの張りがいつもより大きかった気がする。毎週ストレッチを受けていると物理的な体調の良し悪しもわかるのがよい。</p><h2 id=わざと負ける理由>わざと負ける理由</h2><p><a href=/diary/posts/2022/0812/#ドラクエタクトのリアルタイム対戦>一昨日からリアルタイム対戦</a> にはまっている。数をこなしていてわかってきたことがたくさんある。戦略シミュレーションゲームはやればやるほど学びがある。</p><ul><li>パーティーの特性によって相性のよい対戦相手とそうじゃないのがある<ul><li>リアルタイム対戦のマッチングは選択できないのでマッチングしないと相手がわからない</li><li>相性の悪い相手だとマッチング時点で辞退する (負けを認める) 相手もいる</li></ul></li><li>こっちの戦略に呼び込むための布石がいる<ul><li>3つぐらい戦略を用意して最終的にどの戦略に呼び込むかを相手の動きをみながら考えないといけない</li><li>キャラを動かす制限時間が15秒なのでわりと忙しい</li><li>こちらの布石にはめて最終的に勝てると達成感がある<ul><li>中盤まで負けていて向こうに勝ったと思わせて逆転できるとなお嬉しい</li><li><a href=https://game8.jp/dqtact/395606>ダークドレアム</a> は奇数ターン (1, 3, 5, 7 &mldr;) ごとに攻撃力・守備力・すばやさ・かしこさが1段階上がるバフがかかる<ul><li>ダークドレアムはすばやさが低いので徐々にすばやさが上がっていって先制できるようになると最後の1手違いで勝つ状況が出来上がる</li><li>ダークドレアムで5ターンまで戦闘を継続できれば勝率が高い</li></ul></li></ul></li></ul></li><li>すばやさの高いパーティーには何もできないから勝てない<ul><li>高すばやさ (且つ、高火力または状態異常) パーティーには絶対に勝てない<ul><li>リアルタイム対戦でダークドレアムがあまり使われていない理由だと思う</li></ul></li><li>初手前にパーティーの半分ぐらいがやられている</li><li>相手の攻撃が届かない初期配置がないので絶対に防げない</li></ul></li><li>状態異常攻撃の主体パーティーは対戦していておもしろくない<ul><li>混乱・麻痺・眠り・魅了といった状態異常になると2ターン何もできない</li><li>状態異常攻撃 + 高すばやさのキャラの攻撃を防ぐ方法はない<ul><li><a href=https://game8.jp/dqtact/455291>創造神マデサゴーラ</a> が出てきたら高い確率で勝てない</li></ul></li></ul></li><li>パーティー編成のウェイト制限がうまく調整されている<ul><li>高ランク (ステータス高い) のキャラばかりを編成できないようにウェイト制限がある</li><li>これにより、パーティー編成が4人か5人かにわかれる</li><li>低ランク (ステータス低い) のキャラはウェイトも低いので5人目には入れやすい<ul><li><a href=https://game8.jp/dqtact/390466>たたかいのベホイム</a> が使える <a href=https://game8.jp/dqtact/344037>ホイミスライム</a> が活躍したりする</li></ul></li></ul></li></ul><p>本題のわざと負ける理由だが、わかってきた。リアルタイム対戦のマッチングは同じランク内で行われる。上位のランクになればなるほど、対戦相手も強くなる (強くなければ上位のランクに上がれない) 。一定量のポイントを獲得するとランクアップしていけるが、負けるとポイントが下がるペナルティがつく。一定のランクで勝ち負けを繰り返すとそのランクに留まり続けるということができる。私も自分の限界までランクアップしてみて気付いたのは周りも強いので限界に到達すると勝ったり負けたりを繰り返す。ここで別のルールで勝った回数に応じてコインが支払われるボーナスがある。強い人が低いランクで勝ち数を稼ぐのは限界に近いランクで勝ったり負けたりを繰り返すよりもはるかに効率がよい。それはリアルタイム対戦のマッチングに時間制限があるからなおさらそうなる。実力が均衡した相手と時間をたくさん使って2勝3敗を繰り返すよりも、わざと負けながら弱い相手に勝ち続ける5勝?敗を繰り返す方が絶対数としての勝ち数を稼ぐには効率がよい。おそらく負けたときのペナルティがあるランクからわざと負ける人が現れ始めていると思う。なるほどなぁ。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0812/>dto に対するリフレクションの是非</a></h1><div class=post-meta><time class=post-date>2022-08-12 (Fri.) ::</time></div><span class=post-tags>#<a href=/diary/tags/game/>game</a>&nbsp;
#<a href=/diary/tags/java/>java</a>&nbsp;</span><div class=post-content><p>1時に寝て7時に起きた。</p><h2 id=ドラクエタクトのリアルタイム対戦>ドラクエタクトのリアルタイム対戦</h2><p>もう2年間もずっとゲームし続けている。最近 <a href=https://game8.jp/dqtact/462546>リアルタイム対戦</a> モードがリリースされた。全然やる気なかったんやけど、リアルタイム対戦で得たコインでもらえるアイテムが魅力的なのでやることにした。そして、実際にアルタイム対戦をやってみるとはまる。運営の手の平でゲームさせられている。</p><ul><li>人間が相手で狡猾な戦略で負けると悔しい</li><li>人間が相手の戦略の方が創意工夫があって学びになる</li><li>実際にやり始めるとおもしろくなってきてずっとやってしまう</li></ul><p>できる時間を制限しているというのもうまいやり方だなと思っている。朝・昼・晩の7-9時、12-14時、19-22時に制限している。そこまでしてリアルタイムに人間同士をマッチングしてゲームさせる必要があるのか？という素朴な疑問に私は辿りつくが、おそらくゲーム開発者からみたらそうじゃない大事なユーザー体験があるのだろうと推測する。あと不思議なことが1つ。マッチングしていると、たまにわざと負けてくれる人がマッチングされる。チームのメンバーが1人で向こうが先行なら戦いを辞退 (こちらの勝ちになる) するし、こちらが先行でもすぐにやっつけられる。ちゃんと統計をとってないけど、20回に1回ぐらいの頻度でわざと負けてくれる人とマッチングする。あの人たちは一体どういう理由でわざと負けているんだろう？</p><h2 id=リフレクションのユーティリティを作った>リフレクションのユーティリティを作った</h2><p>いまお手伝いで開発している api サーバーは外界と内部のデータの境界を明確にわけていて、外向けのオブジェクト定義と内部向けのオブジェクト定義が異なる。ほとんど同じデータであっても dto を介して値を受け渡ししないといけない。そうすると、次のような dto と他のオブジェクトとの値渡しのための処理が型ごとにあちこちに実装されている。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> MyRecord <span style=color:#a6e22e>toMyRecord</span><span style=color:#f92672>(</span>MyDataInput in<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    var record <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> MyRecord<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    record<span style=color:#f92672>.</span><span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> in<span style=color:#f92672>.</span><span style=color:#a6e22e>id</span>
</span></span><span style=display:flex><span>    record<span style=color:#f92672>.</span><span style=color:#a6e22e>name</span> <span style=color:#f92672>=</span> in<span style=color:#f92672>.</span><span style=color:#a6e22e>name</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    record<span style=color:#f92672>.</span><span style=color:#a6e22e>someId1</span> <span style=color:#f92672>=</span> in<span style=color:#f92672>.</span><span style=color:#a6e22e>someId1</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    record<span style=color:#f92672>.</span><span style=color:#a6e22e>someId2</span> <span style=color:#f92672>=</span> in<span style=color:#f92672>.</span><span style=color:#a6e22e>someId2</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    record<span style=color:#f92672>.</span><span style=color:#a6e22e>someId3</span> <span style=color:#f92672>=</span> in<span style=color:#f92672>.</span><span style=color:#a6e22e>someId3</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    record<span style=color:#f92672>.</span><span style=color:#a6e22e>sortOrder</span> <span style=color:#f92672>=</span> in<span style=color:#f92672>.</span><span style=color:#a6e22e>sortOrder</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    record<span style=color:#f92672>.</span><span style=color:#a6e22e>createUser</span> <span style=color:#f92672>=</span> in<span style=color:#f92672>.</span><span style=color:#a6e22e>createUser</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    record<span style=color:#f92672>.</span><span style=color:#a6e22e>updateUser</span> <span style=color:#f92672>=</span> in<span style=color:#f92672>.</span><span style=color:#a6e22e>updateUser</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>メンバー数が20-30ぐらいあると、たまに値のセット忘れがあったり、あとから追加したメンバーの保守ができてないとか、たまにトラブルが起きる。これ自体は間違っているわけじゃなくて境界を明確にわけるメリットもあるのでプログラミングの煩雑さとトレードオフと言える。</p><p>最近、私が管理系の web api のエンドポイントを作る機会が多いせいか、dto と外部向けのオブジェクトを明確にわける必要のない要件もあったりする。試しにリフレクションを使って同名のフィールド間の値の受け渡しは自動でやってみたらどんな感じかな？と思って作ってみた。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ReflectionUtil</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>ReflectionUtil</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> AssertionError<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;ReflectionUtil is a utility class&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> Field <span style=color:#a6e22e>getField</span><span style=color:#f92672>(</span>Class<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> klass<span style=color:#f92672>,</span> String fieldName<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> klass<span style=color:#f92672>.</span><span style=color:#a6e22e>getDeclaredField</span><span style=color:#f92672>(</span>fieldName<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>NoSuchFieldException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#f92672>&lt;</span>T1<span style=color:#f92672>,</span> T2<span style=color:#f92672>&gt;</span> T2 <span style=color:#a6e22e>mapFieldValues</span><span style=color:#f92672>(</span>T1 fromInstance<span style=color:#f92672>,</span> T2 toInstance<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        var fromClass <span style=color:#f92672>=</span> fromInstance<span style=color:#f92672>.</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>var toField <span style=color:#f92672>:</span> toInstance<span style=color:#f92672>.</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getDeclaredFields</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            toField<span style=color:#f92672>.</span><span style=color:#a6e22e>setAccessible</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            var fromField <span style=color:#f92672>=</span> getField<span style=color:#f92672>(</span>fromClass<span style=color:#f92672>,</span> toField<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>fromField <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                fromField<span style=color:#f92672>.</span><span style=color:#a6e22e>setAccessible</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    toField<span style=color:#f92672>.</span><span style=color:#a6e22e>set</span><span style=color:#f92672>(</span>toInstance<span style=color:#f92672>,</span> fromField<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>fromInstance<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IllegalAccessException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span>e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> toInstance<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>これを使うと、先のコードがこれだけで済む。煩わしい値の受け渡しだけのコードを削減できる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>var record <span style=color:#f92672>=</span> ReflectionUtil<span style=color:#f92672>.</span><span style=color:#a6e22e>mapFieldValues</span><span style=color:#f92672>(</span>in<span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> MyRecord<span style=color:#f92672>());</span>
</span></span></code></pre></div><p>こんなことやると、セキュリティ的によくないとか反論されるかな？と思いながら pr を出してみたら思いの外、好評だったのでちょっと使ってみようと思う。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0811/>次のお仕事探し</a></h1><div class=post-meta><time class=post-date>2022-08-11 (Thu.) ::</time></div><span class=post-tags>#<a href=/diary/tags/book/>book</a>&nbsp;
#<a href=/diary/tags/gig/>gig</a>&nbsp;</span><div class=post-content><p>22時に寝て5時に起きた。前日はあまり寝てなかったら眠くなった。午前中に昨日やり残した開発のお仕事を4時間ほどやってから自分の会社の雑務をしていた。</p><h2 id=智将諸葛孔明の兵法>智将・諸葛孔明の兵法</h2><p><a href=https://hipstergate.jp/column/zhuge-liang-kongming/>智将・諸葛孔明の兵法の書評</a> をみかけた。<a href=https://www.amazon.co.jp/%E6%99%BA%E5%B0%86%E3%83%BB%E8%AB%B8%E8%91%9B%E5%AD%94%E6%98%8E%E3%81%AE%E5%85%B5%E6%B3%95-%E9%AB%98%E7%95%A0-%E7%A9%A3/dp/4837913504>amazon.co.jp</a> に本の情報があることは確認できたが、1987年に出版された本なので在庫はないから諦めていた。たまたま先日メルカリで売っているのをみつけたので購入した (300円) 。第一部生涯 7.馬謖を斬るのところで第一次北伐の背景や概要が説明されている。馬謖が山の上に陣取ったのは短期決戦を意図してその優位性を取ろうとしたのだろうと著者の推察が述べられている。また馬謖を斬るにいたったのは軍律を守ることをすべてに優先したと説明されている。みずからが軍律を破ってしまうと蜀全体の維持が不可能になるだろうと著者も推察が述べられている。そのときに涙したことも触れているが、涙した理由の詳細については言及していない。</p><h2 id=リモートワーク前提のお仕事>リモートワーク前提のお仕事</h2><p><a href=/diary/posts/2021/0930/#カジュアル面談準備>以前、登録した人材紹介プラットフォーム</a> に <a href=https://remogu.jp/>remogu</a> さんがある。待遇のよい案件はほぼ東京か、あっても大阪になる。私は神戸に住んでいるので基本的にリモートワークでないとお仕事を探すのは難しい。remogu さんはリモートワーク前提なのでフィルター条件が1つ減るので検索しやすい。11月から新しいお仕事を探さないといけない。remogu さんのプロフィール情報を求職のステータスに更新しておいた。すると翌日に過去に面談したエージェントさんから連絡があって、すぐに希望に沿った案件を4つほど提案してくれた。その業務内容を今日みていたらどれも私の希望した業務内容に合致するものだったので優先順位とともに職務経歴書を更新して返信した。以前、面談したときもこのエージェントさんの印象はよかった。なにかしら相性があるのか、よい印象をもつエージェントさんだとよい提案をしてくれる。この前、初めて登録した人材紹介会社のエージェントさんとの面談はいまひとつだったのでなにかしらエージェントさんの質なのか、人間力の差による違いがあるんだなと思う。順番に面談していってマネジメントのキャリアを得られるかどうか、私にとっては大きな挑戦の1つになるので求職活動をがんばりたい。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0810/>アプリケーションとジョブの違いと一時停止</a></h1><div class=post-meta><time class=post-date>2022-08-10 (Wed.) ::</time></div><span class=post-tags>#<a href=/diary/tags/kubernetes/>kubernetes</a>&nbsp;</span><div class=post-content><p>2時に寝て5時に起きた。たった3時間しか寝てないのに夜中に1回は起きている。スポットで9時から会議が入ったのでそれまでに朝のお仕事を終わらせようと思ったら早起きできた。6時前にはオフィスに行ってお仕事を始められた。</p><h2 id=アプリケーションからジョブへの移行>アプリケーションからジョブへの移行</h2><p>k8s の cronjob を活用する前は spring の <a href=https://www.baeldung.com/spring-scheduled-tasks>Scheduled</a> アノテーションで定期実行処理を書いていた。アプリケーションサーバー内の1スレッドが定期実行していた。これはスケールアウト前提のアプリケーションサーバーには向いてなくて、複数のアプリケーションサーバーをスケールアウトさせてデプロイすると、定期処理も複数実行されてしまい、同時実行できない類の処理だと問題になる。k8s の cronjob は同時実行しない設定などもあるため、k8s の cronjob へ移行している。</p><p>移行作業の準備をしていてアプリケーションサーバーの pod は <code>replicas</code> を調整することで一時停止の代替となるオペレーションができる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl scale --replicas<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> deployment/my-app
</span></span><span style=display:flex><span>deployment.apps/my-app scaled
</span></span></code></pre></div><p>移行時のアプリケーションサーバーはこれで無効にしておき、cronjob に入れ替えるといった切り戻し可能な状態で移行できる。cronjob も <code>suspend</code> のフラグを使うことで一時停止できるので検証しながら双方を切り替えることができる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl patch cronjob my-batch-job1 -p <span style=color:#e6db74>&#39;{&#34;spec&#34;: {&#34;suspend&#34;: true}}}&#39;</span>
</span></span><span style=display:flex><span>cronjob.batch/my-batch-job1 patched
</span></span></code></pre></div></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0809/>ストーリーポイント捨てた方がよい</a></h1><div class=post-meta><time class=post-date>2022-08-09 (Tue.) ::</time></div><span class=post-tags>#<a href=/diary/tags/scrum/>scrum</a>&nbsp;
#<a href=/diary/tags/issue-tracking-system/>issue tracking system</a>&nbsp;</span><div class=post-content><p>2時に寝て5時に起きて7時半に起きた。夜も眠れなくなってきた。</p><h2 id=ストーリーポイント改善への再考>ストーリーポイント改善への再考</h2><p>プランニングしていたときに調査チケットをスパイクにしようという話題がでたときにストーリーポイントを割り振るかどうかという話しになった。スクラムマスターは5ポイント割り振ればよいと以前話していた気がする。そのときは時間がなかったから反論しなかったけど、ポイントと工数は別だからそれはよくないと反論した。割り当てたストーリーポイントに対して「○○さんならどのぐらいの時間でできますか？」と質問しているのがすでにおかしい。便宜上、ストーリーポイントはベロシティを計測して時間にマッピングされるかもしれないが、ストーリーポイントを直接時間にマッピングし始めると、担当者の個人差で大きく運用が変わってきてしまう。ストーリーポイントとスケジュールのアンマッチな部分を実際のスクラム運用でどう改善するのか？をつぶやいていたら、みずおちさんが返信してくれた。</p><blockquote class=twitter-tweet><p lang=ja dir=ltr>うーん、なるほど。。文脈によって色々ですが基本的に3か月以上先の見積もりについては妄想のようなもので、当てられないのではと自分は考えてますね。当てられるとしたら、何の技術的挑戦もないプロダクトなんだろうなと思ってしまいます。</p>&mdash; Mizuochi Keita 水落 啓太 (@mizuochikeita) <a href="https://twitter.com/mizuochikeita/status/1556966333723512832?ref_src=twsrc%5Etfw">August 9, 2022</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script><p>見積もる期間をなるべく小さくしてスケジュールを提示しないというのが戦略として正しいと思う。</p><p>あと実際には、打ち合わせの日程調整やレビュー待ちなどの待ち時間もあり、ストーリーポイントの複雑さや開発の工数だけでなく、リードタイムの概念もある。スケジュールは納期が決まっているけれど、リードタイムが伸びてしまったときに納期は伸びてくれないのでそのギャップもなにかしら反映する必要はあるが、ストーリーポイントではチケットの依存関係やリードタイムの遅れを反映することはできない。</p><h3 id=リファレンス>リファレンス</h3><ul><li><a href=https://www.ryuzee.com/contents/blog/7121>スクラムにおける技術的スパイクの進め方</a></li></ul></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0808/>k8s クラスターの service account とロール</a></h1><div class=post-meta><time class=post-date>2022-08-08 (Mon.) ::</time></div><span class=post-tags>#<a href=/diary/tags/kubernetes/>kubernetes</a>&nbsp;</span><div class=post-content><p>23時に寝て6時に起きた。前日は夕方からだらだらしてた。</p><h2 id=k8s-クラスターの権限管理>k8s クラスターの権限管理</h2><p>初期のクラスターを私が構築したわけではないため、権限周りはあまりよくわかっていない。k8s には2つのユーザーアカウントがある。</p><ul><li>user account: 人向け</li><li>service account: アプリケーション向け</li></ul><blockquote><p>In this regard, Kubernetes does not have objects which represent normal user accounts. Normal users cannot be added to a cluster through an API call.</p><p><a href=https://kubernetes.io/docs/reference/access-authn-authz/authentication/#users-in-kubernetes>https://kubernetes.io/docs/reference/access-authn-authz/authentication/#users-in-kubernetes</a></p></blockquote><p>但し、ユーザーアカウントを表すオブジェクトはなく、api 経由でクラスターにユーザーを追加したりはできない。ユーザーは存在しないけど、認証はできる仕組みを私は知らないので関心がある。それはまた今度調べるとして、今回は service account の権限を変更した。service account は pod 内から k8s の api サーバーにアクセスするときの認証などに使われる。デフォルトの権限だと、api サーバーのエンドポイントへの書き込み権限がない (?) ようなので追加する。</p><blockquote><p>In order from most secure to least secure, the approaches are:</p><ol><li>Grant a role to an application-specific service account (best practice)</li><li>Grant a role to the &ldquo;default&rdquo; service account in a namespace</li><li>Grant a role to all service accounts in a namespace</li><li>Grant a limited role to all service accounts cluster-wide (discouraged)</li><li>Grant super-user access to all service accounts cluster-wide (strongly discouraged)</li></ol><p><a href=https://kubernetes.io/docs/reference/access-authn-authz/rbac/#service-account-permissions>ServiceAccount permissions</a></p></blockquote><p>セキュアな順番として上から自分たちの環境にあうかどうかを判断すればよい。私の場合、わざわざ新規に service account を作るほどの要件ではないため、2番目の <code>default</code> の service account にロールを与えることにした。<code>RoleBinding</code> というキーワードがあるので既存のクラスターロールから <code>edit</code> という権限を与える。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl create rolebinding default-edit-role --clusterrole<span style=color:#f92672>=</span>edit --serviceaccount<span style=color:#f92672>=</span>default:default --namespace default
</span></span><span style=display:flex><span>rolebinding.rbac.authorization.k8s.io/default-edit-role created
</span></span></code></pre></div><p>ここでは <code>default-edit-role</code> という RoleBinding を作成した。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl get rolebinding default-edit-role -o yaml
</span></span><span style=display:flex><span>apiVersion: rbac.authorization.k8s.io/v1
</span></span><span style=display:flex><span>kind: RoleBinding
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  creationTimestamp: <span style=color:#e6db74>&#34;2022-08-08T08:27:12Z&#34;</span>
</span></span><span style=display:flex><span>  name: default-edit-role
</span></span><span style=display:flex><span>  namespace: default
</span></span><span style=display:flex><span>  resourceVersion: <span style=color:#e6db74>&#34;152660975&#34;</span>
</span></span><span style=display:flex><span>  uid: 6de13b71-3103-448c-805a-66e9400f61c3
</span></span><span style=display:flex><span>roleRef:
</span></span><span style=display:flex><span>  apiGroup: rbac.authorization.k8s.io
</span></span><span style=display:flex><span>  kind: ClusterRole
</span></span><span style=display:flex><span>  name: edit
</span></span><span style=display:flex><span>subjects:
</span></span><span style=display:flex><span>- kind: ServiceAccount
</span></span><span style=display:flex><span>  name: default
</span></span><span style=display:flex><span>  namespace: default
</span></span></code></pre></div><p>これで cronjob から job を作成する権限が付与された。<a href=https://kubernetes.io/docs/reference/access-authn-authz/rbac/#write-access-for-endpoints>Write access for Endpoints</a> によると、新規に作成した v1.22 以降のクラスターではエンドポイントに対する write アクセス権限が異なるように記載されている。一方で v1.22 にアップグレードしたクラスターは影響を受けないとも記述されている。私がいま運用しているクラスターは v1.21 から v1.22 にアップグレードしたクラスターなので <code>edit</code> ロールでうまくいったのかもしれない。クラスターのバージョンによって設定が異なるかもしれない。</p></div></article><div class=pagination><div class=pagination__buttons><a href=/diary/posts/page/41/ class="button previous"><span class=button__icon>←</span>
<span class=button__text>最近の日記</span></a>
<a href=/diary/posts/page/43/ class="button next"><span class=button__text>過去の日記</span>
<span class=button__icon>→</span></a></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>© 2021 Tetsuya Morimoto</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>