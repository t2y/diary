<!doctype html><html lang=en><head><title>Posts :: </title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/posts/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="Posts"><meta property="og:description" content><meta property="og:url" content="/diary/posts/"><meta property="og:site_name" content><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/posts/index.xml rel=alternate type=application/rss+xml title></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><div class=posts><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1104/>筋肉痛の翌日</a></h1><div class=post-meta><time class=post-date>2023-11-04 (Sat.) ::</time></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/event/>event</a>&nbsp;
#<a href=/diary/tags/kobe/>kobe</a>&nbsp;
#<a href=/diary/tags/tax/>tax</a>&nbsp;</span><div class=post-content><p>昨日は山登りで筋肉痛になって夕方からずっと寝ていて7時に起きて8時半に起きた。それでも寝たら筋肉痛はある程度は直った。寝ると回復するもんや。</p><h2 id=ストレッチ>ストレッチ</h2><p>昨日から全身筋肉痛になっている。それでも夕方からずっと安静にしていたせいか、昨日の一番ひどかった頃よりずっと回復していた。さらにストレッチでそういった話しをしたら、トレーナーさんも筋肉痛を気遣った形でストレッチをしてくれた。筋肉痛の状態だと筋肉は伸びないらしい。あまり筋を押さず、ほぐすようなストレッチにしてくれたという。筋肉痛にも関わらず、いつもよりも関節や筋肉の負荷が小さかったように思える。今日の開脚幅は開始前153cmで、ストレッチ後155cmだった。</p><h2 id=カフーツさん訪問>カフーツさん訪問</h2><p>たまたま見かけたので <a href=https://www.facebook.com/events/302759626024469>ブログJelly Vol.135</a> に参加してきた。<a href=https://www.kenbishi.co.jp/product/sake5/>瑞祥 黒松剣菱</a> というお酒をもっていった。こういうイベントで灘のお酒を飲む機会にしようと思ったものの、今回は周りの人たちにあわせてワインとビールを飲むだけで終わってしまった。次回のイベントのときに飲みましょうとお酒を置いてきた。私自身、家で日本酒を飲まない。カジュアルに日本酒を飲もうという空気や雰囲気がない。入り口を変えるため、日本酒にあう食事やつまみも用意していくのがよいと気付いた。次回は日本酒向けの食べものをもっていこうと思う。</p><figure><img src=/diary/img/2023/1104_sake.jpg></figure><p>昨日の山登りの下山中もマネジメントや気付きについて2時間ほど一緒に行った人たちと話していた。ここでもお酒が入ったらその延長の話しをだらだらやってしまった。気付きがないという事象に対して、どうやれば気付きを得られるようになるか、その背景や変化、人の特性・性格・成長などについて、私はいま関心をもっている。人に依るというのも多分にあると思う。教えてできることなのかどうかすら、私はわかっていない。私の立場としては、仕組みとプラクティスで気付きを与えて、教育によって成長することを願いたい。</p><p>いとうさんに note のオンラインコンテンツの領収書にインボイスの登録番号を設定してほしいとお願いした。さらにコワーキングスペースのサービス料がいま1,000円になっている。よくみると、90円の消費税を含んで税込み価格になっている。こういうとき、1,000円をサービス料、100円を消費税、税込みで1,100円にすればいいとアドバイスした。次回からそうするといとうさんも話されていた。免税事業者が課税事業者になっても事業者の損益には影響を与えない状態を支持したい。</p><h2 id=インボイスの少額特例>インボイスの少額特例</h2><p>freee の「修正待ちリスト一覧」にインボイスの少額特例に該当する明細があるという通知が出ている。次の条件に当てはまる事業者は少額特例の対象になるという。</p><blockquote><p>「前々年度の課税売上高が1億円以下」または「前年度の開始から6ヶ月間の課税売上高が5,000万円以下」のどちらかに当てはまる事業者で、税込1万円未満の仕入や経費は、インボイス（適格請求書）があるかどうかにかかわらず仕入税額を控除できます。</p></blockquote><ul><li><a href=https://www.nta.go.jp/publication/pamph/shohi/kaisei/202304/02.htm>少額特例（一定規模以下の事業者に対する事務負担の軽減措置の概要）の概要</a></li></ul><p>うちは消費税の申告に <a href=https://www.nta.go.jp/taxes/shiraberu/taxanswer/shohi/6505.htm>簡易課税制度</a> を選択しているため、事実上、インボイスの有無で消費税の仕入れ控除に影響はない。実際の消費税の納税には影響を与えないが、税制の理解を深めるために取引明細や税区分の処理などをちゃんと記帳しようとは考えている。将来的に簡易課税制度が廃止されたり、その条件を満たさないようになる可能性もある。消費税のようなシンプルな税金にも関わらず、事業者は本質的に損益に影響を与えないものにも関わらず、取引先との関係、政治や社会的な事情によって税制が混乱している。</p><p>消費税の逆進性についての問題も見聞きはする。次の記事では生活必需品に低い税率を適用することで緩和するという対策を述べている。さまざまな条件で時限的な特例を多重に発令するよりも、すでに軽減税率があるのだから食品は5%にするとか、そういったシンプルな税制で対策を取れないのだろうかと考えてしまう。</p><ul><li><a href="https://www.nli-research.co.jp/report/detail/id=39892?site=nli">消費税の逆進性は大問題か？</a></li></ul></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1103/>ハイキング山登り</a></h1><div class=post-meta><time class=post-date>2023-11-03 (Fri.) ::</time></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/kobe/>kobe</a>&nbsp;
</span><img src=/diary/img/2023/1103_map.jpg class=post-cover alt=ハイキング山登り title="Cover Image"><div class=post-content><p>4時に寝て8時に起きた。久しぶりに深夜過ぎまでコードを書いて、あと文章を書いて、気付いたら3時をまわっていた。</p><h2 id=新神戸駅からのハイキング>新神戸駅からのハイキング</h2><p>新神戸駅に10時集合、遅刻もあって少し出発は遅れたが、10時半には駅を出発した。駅を出たらすぐに登山道に入れる。これはすごい立地だと思う。通常、登山道までは市街地から1-2時間かけて移動することが多いと思う。新神戸駅という市街地からすぐに山登りできるというのは神戸観光の1つとして十分によいと思えた。11月としては高めの最高気温23℃とやや暑いぐらいだったが、山登りにはちょうどいい気候だった。寒い時期や暑い時期を避けるという意味で11月はよい時期の選択にみえる。まだ暖かいせいか、紅葉は始まったばかりで、もう少し遅い時期だと紅葉も楽しめてよいかもしれない。</p><ul><li><a href=https://kobe-rokko.jp/toreko/>トレイルステーション</a></li></ul><h4 id=布引の滝-雄滝>布引の滝 (雄滝)</h4><p>ハイキングマップの B 布引ゾーンは、山道もコンクリートで舗装されていて歩きやすい。布引の滝は雌と雄の2つがあり、雄滝は整備されているのもあって観光向けになっている。</p><figure><img src=/diary/img/2023/1103_waterfall.jpg></figure><h4 id=布引五本松堰堤>布引五本松堰堤</h4><p>ダムの1つ。周囲をぐるっと回りながらハイキングを続ける。この辺りも舗装された道路が続くので初心者向けコースの延長にある。紅葉はほとんどなかった。</p><figure><img src=/diary/img/2023/1103_dam.jpg></figure><h4 id=再度山-ふたたびやま-山頂>再度山 (ふたたびやま) 山頂</h4><p>大龍寺から30分ぐらいかな？ここは初心者向けではなく、やや険しい山道を登っていく必要がある。道路は整備されなくて、かろうじて1人が歩けるような狭い山道を、所々、よじ登るような感覚でやや体力がいる。体力のない人や子どもはちょっと難しいと思う。私がいっぱいいっぱいだったので (山登りに慣れていない) 高齢な人には無理だと思う。山頂には 470m という置きものがあって神戸の町並みを展望できる。ここまでは舗装された道路のハイキングなので山登りが好きな人はこのぐらいの負荷をかけた方が楽しめるかもしれない。</p><figure><img src=/diary/img/2023/1103_mountain.jpg></figure><p>山頂から下って再度山公園へ到着した。上るのが山道だったから下るのも山道で、下手すると崖から滑ってしまうので降りるのも注意が必要になる。</p><h4 id=再度山公園>再度山公園</h4><p>ここは車でも来れるそうで、のどかな公園になっていた。紅葉もちらほらみえて、あと2-3週間したらよい時期かもしれない。また車でも行ってみようかと思う。ここで休憩しているときに13時をまわっていたと思う。登りは所々でうちらは休憩をとってゆっくり進んでいたので一般よりは遅いペースだったと思う。</p><figure><img src=/diary/img/2023/1103_park.jpg></figure><h4 id=下山>下山</h4><p>ここからは一気に下山してきた。なだらかな下りがずっと続くコースだったので体力的にはそうしんどくなく一気に降りてきた。だいたい2時間ぐらいで県庁駅まで来れた。そこで15時ぐらいになっていた。これはこれで山道を眺めながら歩くのも気持ちがよいし、登る方が好きな人はもっと登ってロープウェイで降りてくるというのもよいかもしれない。私は太ももの負荷が限界なぐらい体力的にしんどかったのでこのぐらいの行程が限界だというのもわかってよかった。歩ける距離としては3時間程度を目安に、なだらかなハイキングコースを探すとよさそうに思う。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1102/>論理の通じない人たち</a></h1><div class=post-meta><time class=post-date>2023-11-02 (Thu.) ::</time></div><span class=post-tags>#<a href=/diary/tags/sns/>sns</a>&nbsp;
#<a href=/diary/tags/writing/>writing</a>&nbsp;
#<a href=/diary/tags/communication/>communication</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;</span><div class=post-content><p>23時に寝て何度か起きて8時に起きた。ホテルの部屋が暗いと朝になった気がしなくて2度寝したら寝坊した。</p><h2 id=組織の対応と-sns-の議論>組織の対応と sns の議論</h2><p><a href=/diary/posts/2023/1030/>先日の sns 騒ぎ</a> の続き。公式からの声明も出たので軽くまとめておく。</p><ul><li><a href=https://pyconjp.blogspot.com/2023/11/pyconapac2023-statement.html>PyCon APAC 2023におけるNOCコンテンツに関するご指摘について</a></li></ul><p>簡潔な文章に事実の記述、責任の所在、関係者への配慮が含まれていて十分な内容にみえる。法律なども関係するため、弁護士チェックが必要なことを考慮すると、こんな短期間で組織の見解を出せたことは運営側の体制を鑑みることができる。それが適正かどうかは人によって判断は異なるかもしれないが、私はコミュニティ運営というボランティア主体の組織であれば十分なものだと思えた。その後のネット上の議論も、ちゃんと終えてはいないが、様々な見解で議論は進んでいるようにみえる。</p><p>今回みていて感じたことの1つに、コミュニケーションが成り立たない人が世の中にはたくさんいるということ。議論の前提や論理の出発点が異なる人たちは、一定の論理を含む全体や大局を理解できず、細部や詳細のところだけを拠り所に自身の論理を組み立てる。意見の差異があることはなんら問題はないが、論理が通じないのは議論の余地すらないようにみえた。そういう人たちを会話するときは前提条件を同じにしたり、思想の背景を共有したり、もっと時間をかけて丁寧にすり合わせていく作業が必要になる。そして sns のような、流れが速い不特定多数の議論はそういった丁寧な作業にまったく向いていない。だから sns で議論することは時間の無駄である。</p><h2 id=コネクションを共有しないプール>コネクションを共有しないプール</h2><p>go の非同期処理であまり使われることはないが、<a href=https://pkg.go.dev/golang.org/x/sync/semaphore>semaphore</a> が準公式ライブラリとして提供されている。私はセマフォを気に入っていてたまに使う。</p><p>ldap プロトコルではコネクションの確立とログインに相当する bind の操作が分かれている。コネクションを確立したまま、ログアウトに相当する処理ができればプールを設けることでコネクションの再利用ができる。</p><ul><li><a href=https://ldap.com/the-ldap-unbind-operation/>The LDAP Unbind Operation</a></li></ul><p>しかし、このドキュメントの説明によると、unbind という操作は用意されているものの、ログアウトに相当する機能ではなく、クローズする前に通知するといった用途だと書いてある。unbind のリクエストをした後にはクローズするしかないといったものになる。それを踏まえて、プールはセマフォで同時接続数のみを制御するのでよいのではないかと思う。そんなワーカープールを実装してみた。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ClientPool</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>config</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>LDAP</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sem</span>    <span style=color:#f92672>*</span><span style=color:#a6e22e>semaphore</span>.<span style=color:#a6e22e>Weighted</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ClientPool</span>) <span style=color:#a6e22e>Get</span>(
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>,
</span></span><span style=display:flex><span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>LDAPClient</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>sem</span>.<span style=color:#a6e22e>TryAcquire</span>(<span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to acquire, wait and get later&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>client</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NewLDAPClient</span>(<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>config</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Connect</span>(<span style=color:#a6e22e>ctx</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>sem</span>.<span style=color:#a6e22e>Release</span>(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to connect: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>client</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ClientPool</span>) <span style=color:#a6e22e>GetAuthenticated</span>(
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>,
</span></span><span style=display:flex><span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>LDAPClient</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>client</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to get: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>dn</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>BindDN</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>passwd</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>BindPasswd</span>.<span style=color:#a6e22e>String</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Bind</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>dn</span>, <span style=color:#a6e22e>passwd</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>sem</span>.<span style=color:#a6e22e>Release</span>(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to bind: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>client</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ClientPool</span>) <span style=color:#a6e22e>Close</span>(<span style=color:#a6e22e>client</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>LDAPClient</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>sem</span>.<span style=color:#a6e22e>Release</span>(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewClientPool</span>(<span style=color:#a6e22e>cfg</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>LDAP</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>ClientPool</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>ClientPool</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>config</span>: <span style=color:#a6e22e>cfg</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>sem</span>:    <span style=color:#a6e22e>semaphore</span>.<span style=color:#a6e22e>NewWeighted</span>(<span style=color:#a6e22e>cfg</span>.<span style=color:#a6e22e>ClientPoolSize</span>),
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1101/>穴場のビアバー</a></h1><div class=post-meta><time class=post-date>2023-11-01 (Wed.) ::</time></div><span class=post-tags>#<a href=/diary/tags/food/>food</a>&nbsp;
#<a href=/diary/tags/project-management/>project management</a>&nbsp;
#<a href=/diary/tags/mongodb/>mongodb</a>&nbsp;
#<a href=/diary/tags/drinking/>drinking</a>&nbsp;
</span><img src=/diary/img/2023/1101_autumn.jpg class=post-cover alt=穴場のビアバー title="Cover Image"><div class=post-content><p>0時に寝て何度か起きて6時半に起きた。移動日の疲れもあってか、いつもよりよく眠れた気がする。</p><h2 id=朝食バイキング>朝食バイキング</h2><p><a href=/diary/posts/2023/0919/#大崎に泊まる>先々月から大崎探索</a> をしていて <a href=https://www.newotani-inntokyo.jp/>ニューオータニイン東京</a> に泊まってみた。川沿いの道を歩きながら朝食バイキングもおいしい。食品の品数があると満足度が高い。</p><figure><img src=/diary/img/2023/1101_breakfast.jpg></figure><h2 id=プロジェクトの進捗報告>プロジェクトの進捗報告</h2><p>出張したときの月例報告の11回目。<a href=/diary/posts/2023/0920/>前回の進捗報告はこちら</a> 。</p><p>まだ開発の序盤なので <a href=/diary/posts/2023/1028/#近況報告の資料作り>事前に準備した資料</a> の内容を一通り終えて雑談の時間も多かったように思う。3回目の開発フェーズになるのもあり、メンバーの練度も上がって、開発の手際はかなりよくなっているように私からはみえている。それらも含めて、メンバーが自律的に issue を作ったり、タスクを自分に割り当てたりしながら開発が進むようになっていると報告した。プロジェクトオーナーからも、最近のマイルストーン定例をみていて、メンバーが気付きが増えている、自律的によくないところを改善しようという意思がみえるといった話題も出ていた。課題管理のプラクティスを実践してきて、着実によい開発者の習慣を身につけて、よい開発チームに育ってきているように、私からもみえている。あとは課題管理についてのコンテンツを私が書かないといけないのを、バーンナウトの影響もあってか、先月はさぼってしまっていたので、今月こそなんか書きますと、自分を追い込む意図でもその場で話題にした。</p><h2 id=mongo-とトランザクションとレプリカセット>mongo とトランザクションとレプリカセット</h2><p>mongo には <a href=https://www.mongodb.com/docs/manual/core/transactions/>トランザクション</a> の機能が提供されている。しかし、トランザクションを使うためには <a href=https://www.mongodb.com/docs/v7.0/replication/>レプリケーション</a> を有効にしないといけない。レプリケーションは通常は複数台のマシンでクラスタリングを構築するものになる。うちらはシングルノードの mongo を扱っているのでレプリケーションを必要としていない。それでも、ドキュメントを読んでいると、スタンドアローンでも本番環境ではレプリカセットを使う方がよいといった説明もみつかる。</p><ul><li><a href=https://www.mongodb.com/docs/manual/tutorial/convert-standalone-to-replica-set/>Convert a Standalone mongod to a Replica Set</a></li></ul><p>ちょうど開発の要件としてトランザクションを必要とする状況も出てきた。mongo のレプリケーションやトランザクションの仕組みを理解するよい機会かもしれない。11月中には調査したいというところ。</p><h2 id=エビスバー>エビスバー</h2><p>大崎探検の2日目。<a href=https://www.ginzalion.jp/shop/brand/yebisubar/shop60.html>YEBISU BAR 大崎店</a> へ行ってみた。大崎駅横の駅ビルの2階にある。アクセスもよい。水曜日なのに20-21時半ぐらいまでいて、お客さんは3組ぐらしかいなかった。よい意味で空いてて静かにゆっくり飲めてよかった。穴場のバーをみつけた。ビール2杯とつまみ2品でちょうど3000円程度。ちょっと割高かもしれないけど、場所とお店の雰囲気とゆっくりできたことを考慮するとちょうどよい価格帯にも思える。またゆっくり軽く飲みたいときに行こうと思う。</p><p><figure><img src=/diary/img/2023/1101_beer.jpg></figure><figure><img src=/diary/img/2023/1101_salad.jpg></figure><figure><img src=/diary/img/2023/1101_potate.jpg></figure></p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1031/>アイマスク効果</a></h1><div class=post-meta><time class=post-date>2023-10-31 (Tue.) ::</time></div><span class=post-tags>#<a href=/diary/tags/health/>health</a>&nbsp;
#<a href=/diary/tags/project-management/>project management</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/event/>event</a>&nbsp;</span><div class=post-content><p>1ヶ月と2週間ぶりの出張。</p><p>0時に寝て2時半に起きた。なにも準備していないのが悪いけれど、出張前夜は寝坊したらどうしようというのが気になってあまり眠れない。起きてから出張の準備をして5時過ぎに出た。電車に乗るまで少し時間があったので朝からなか卯で <a href=https://www.nakau.co.jp/jp/menu/detail/in/116>まぐろのたたき丼</a> を初めて食べた。値段を考えると親子丼を食べた方がお得なように思えた。出張の日は夕方眠くて集中できないことが多い。新幹線の中で眠れるよう、ダイソーでアイマスクを買ってみた。その成果もあって、わりとよく眠れた。アイマスクの効果は確かにあったと思うが、なぜか寝違えて首を痛めた。新幹線でよく眠れたように考えていたが、15-16時は眠気に襲われた。やはり3-5時ぐらいから起きているとそのぐらいの時間に眠くなってしまうんやろか？</p><h2 id=マイルストーン定例>マイルストーン定例</h2><p>いつもの定例会議をやって、開発状況の共有や設計レビューなどを行う。私は権限管理の仕組み作りをちょっとずつ作っているのであまり全体を見渡せていないが、メンバーが主体となって段取りを進めてくれた。あと新規メンバーが先週から開発に参加する予定が、別プロジェクトの段取りがうまく行っていないようでまた仕切り直しになった。もう2週間ほど様子をみるという。3回目のスケジュール調整になる。こういう五月雨式に直前に遅れていくパターンを私は信用しない。スケジュールを自分で制御できる状態にない、または制御できたとしてもやる気がないようにみえる。いずれにしても、私が制御できないプロジェクトの影響で、うちのプロジェクトの成果物に影響が出ないようにしたい。機能開発を3ヶ月と見積もっているうちの、1ヶ月がすでに過ぎた。もう新規メンバーの受け入れは諦めて、既存メンバーだけで成果物ができるような体制へ移行することに決めた。幸いにも既存メンバーは十分にタスクをこなせるようになってきているし、私も10月後半ぐらいからバーンアウトを消化して開発の集中力も戻ってきた。11月にちょっと本気出してサーバーサイドの開発をしてもよいかもしれない。</p><h2 id=go-のオンライン勉強会>go のオンライン勉強会</h2><p><a href=https://gocon.connpass.com/event/299108/>Go 1.21 リリースパーティ & GopherCon 2023 報告会</a> をオンラインで参加した。ホテルについて少し寝てからアラームで起きて視聴してた。始まる前に30分ほど仮眠しても、移動日はしんどくて、みながら半分ぐらいは寝てた。最初と後半2つぐらいのセッションしか覚えていない。メルカリの社員さんたちは <a href=https://gophercon.org/>GopherCon 2023</a> に参加して、その内容などを紹介していた。もう私は海外カンファレンスへわざわざ行こうというモチベーションはない。たぶんもう行くことはないのだろうけど、そういった場に行って学んでいる開発者にはもう追いつけないのだろうなとも思えた。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1030/>sns の百害</a></h1><div class=post-meta><time class=post-date>2023-10-30 (Mon.) ::</time></div><span class=post-tags>#<a href=/diary/tags/sns/>sns</a>&nbsp;
#<a href=/diary/tags/communication/>communication</a>&nbsp;</span><div class=post-content><p>1時過ぎに寝て4時に起きて7時に起きて8時に起きた。夜更ししてネットをみてて寝坊した。先週に引き続き、いくつかリファクタリングしつつ、午後からはコードレビューして、それが終わったからまたコードを書いてた。</p><h2 id=正義の追及>正義の追及</h2><p>もう何年も前から twitter はやめようと考えながら、なんかだらだら続けてきていた。イーロンマスクが買収して、課金しないと機能がなくなったり、利用者も減ったりしていて、私もよいタイミングだと twitter をやめることにした。本当はアカウントをアーカイブモードのように凍結できればよいが、それは故人向けにしか提供していないみたいなのでアカウントを削除するといったことはしていない。というのは、削除すると一定期間を経て他人が同じ id でアカウントを作れるそうなので、なんとなくそれは嫌だなと思ってアカウントだけは残している。</p><p>たまたまあるイベントで、運営側の不手際で参加者のプライバシー侵害になるかもしれないといったトラブルが起きたらしい。起きてしまったものは仕方ないが、その不手際に気付いた人が sns (x) で大げさに拡散して、衆知の知るところになって、実被害や問題の大小とは関係なく、そういった不手際があったことがことさら悪いことかのように、また運営の対応も悪かったかのように、(おそらく) 実被害もないのに大きな問題であるかのように喧伝されてしまった。少なくとも運営が対応して以降は被害が出ないことから、それ以上の言及については本人の承認欲求でやっているようにしかみえなかった。醜かった。</p><blockquote class=twitter-tweet><p lang=ja dir=ltr>SNSで晒すのはトラブル解決の手段としては最悪で全面戦争宣言に等しいという認識 <a href=https://t.co/Xrp7zu1ocJ>https://t.co/Xrp7zu1ocJ</a></p>&mdash; 大平 之人(Yukito Ohira) | フリーランスエンジニア完全攻略バイブルの人 (@yohira_dev) <a href="https://twitter.com/yohira_dev/status/1718828976418979981?ref_src=twsrc%5Etfw">October 30, 2023</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script><p>昔からインターネット上でのトラブルというのはあったけれど、sns は数の暴力が強過ぎるように数年間から感じるようになった。とくに正義の力が強過ぎる。一見それはよいことのように思えるが、正義が現実や事実ではない場面もあるかもしれない。今回もなんらかの実被害や迷惑を被ったという話しはいまのところ1つも見聞きしていない。それに対して、自分たちの主張が正しいからと言って、運営を強く非難するような多くの人からの言動というのはやり過ぎにみえた。sns 上での流布の速度が速過ぎるせいで組織の対応は追いつかない。私は組織の人たちをよく知っているので、待っていれば然るべき謝罪や声明が出ることを信頼できる。この信頼がない人たちにとって、いま起こっている炎上に対して組織が即時で対応しないと、組織の怠慢や隠蔽を疑う声がちらほら上がっていた。sns の速さに人間が慣れてしまったのだろう。信頼がない人にとっては悪意のある組織かもしれないと疑って予防的に慎重にコメントするのも仕方ないのかもしれない。しかし、それが問題をより分かりにくく複雑にしてしまう遠因にもなっているように思えた。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1029/>読んだり書いたり</a></h1><div class=post-meta><time class=post-date>2023-10-29 (Sun.) ::</time></div><span class=post-tags>#<a href=/diary/tags/book/>book</a>&nbsp;
#<a href=/diary/tags/writing/>writing</a>&nbsp;</span><div class=post-content><p>0時に寝て何度か起きて8時半に起きた。もう熱もおさまって平時に戻った感じ。今月の請求書を作ったり、ネットの記事を読んだり、のんびりしていた。</p><h2 id=頁をめくる音で息をする>頁をめくる音で息をする</h2><p><a href=/diary/posts/2023/1025/#コワーキングのオンラインイベント>いとうさんに教えてもらった本</a> を読み始めた。「見えない手」というタイトルのエッセイで、妙見幸子さんという、生まれながら脳性マヒの障害をもっていて、四肢が不自由な方が書いた詩集にまつわるエピソードが書いてあった。</p><blockquote><p>いい詩とは何かという話をお客さんと時々する。そのたびに僕は悩みながらこう答える。それは「切実さと誠実さ」なのではないかと。それを語らざるを得なかった詩人の切実さと、言葉に対する、あるいはその詩を手にする人びとへの誠実さ。</p><p>見えない手</p></blockquote><p>詩集に限らず、どんな商品でも事業でも「切実さと誠実さ」を併せ持つようなモノに出会うことは滅多にない。読んでいて、そういうモノに出会えることそのものが幸せに思えた。こういう文章をさらっと書ける人の頭のよさとか、語彙の豊富さとかがうらやましい。</p><h2 id=はてな匿名ダイアリーの書き方>はてな匿名ダイアリーの書き方</h2><p><a href=https://anond.hatelabo.jp/20151219074050>はてな匿名ダイアリーの書き方</a> がいくつも投稿されるぐらい、ui がわかりにくい。匿名なのにログインしないといけないというアクションがそもそも相反する概念でわかりにくい。ログインすると、自分のアカウントの日記のように管理される。この時点で本当に匿名なんやろか？と不安にもなる。どうやらログインしたら自分の書いた匿名ダイアリーを管理できるようになっている。</p><blockquote><p>はてな匿名ダイアリー > xxx の日記</p></blockquote><p><a href=https://anond.hatelabo.jp/help>はてな匿名ダイアリーのヘルプ</a> もこれだけ。おそらく古いダイアリーのプロダクトだから記法に markdown も使えない。匿名ダイアリーがはてな社にとってどういったプロダクトかは知らないけど、明らかに保守されていないようなことがわかってしまうのは印象が悪いなと思えた。別に匿名ダイアリーを書く気はなかったんだけど、よい機会なので既存の記事に言及したり、自分で新規の記事を書いたりしてみた。記事を書く ui 体験はよくない。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1028/>副反応でバテていた</a></h1><div class=post-meta><time class=post-date>2023-10-28 (Sat.) ::</time></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/project-management/>project management</a>&nbsp;</span><div class=post-content><p>0時に寝て4時に起きて7時に起きて8時に起きた。一晩中、熱を測りながら寝てた。37度前後で推移して朝に37.8度でピークを迎えた。今日は日中37度前後で推移した。それほどしんどくはない。</p><h2 id=ストレッチ>ストレッチ</h2><p>ワクチンの発熱がある中、ストレッチぐらいなら大丈夫だろうといつも通り行ってみたが、発熱のせいかどうかはわからないけど、いつもよりストレッチを受けていてもしんどかった。体がきしむような、いつもとは違う張りを感じた。左の太ももの前と後ろ、腰の後ろ辺りがひどくて、右足の股関節周りもかなりきつくて耐え難い感じだった。なぜか上半身の肩周りも堅くて、今週も座っている時間が長かった方ではあるからそんなもんかもしれない。今日の開脚幅は開始前153cmで、ストレッチ後155cmだった。熱が出て体がだるかったのでそのせいかもしれない。</p><h2 id=近況報告の資料作り>近況報告の資料作り</h2><p>新しい開発が始まって、初めての東京出張が来週になる。ふりかえりと要件整理のマイルストーンを1つ入れたので1ヶ月以上の期間が空いての出張となる。言っても1ヶ月と10日ぶりぐらいの違いでしかないけど、久しぶりに近況報告の資料を作ったような錯覚に陥った。あとホテルの宿泊予約を、これまでは1ヶ月前に予約するようにしていたのを最近は3ヶ月前に予約するようにした。日程と泊まるホテルが決まっているなら3ヶ月前に予約する方が同じ部屋でも1000-3000円程度は安くなるような気がする。ホテルは直前にキャンセルできるので3-6ヶ月前に予約して、予定が変わったらキャンセルするといった運用がよいことに改めて気付いた。1ヶ月前予約で十分と思っていた、自分の古い考え方をアップデートした。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1027/>税理士さんと雑談</a></h1><div class=post-meta><time class=post-date>2023-10-27 (Fri.) ::</time></div><span class=post-tags>#<a href=/diary/tags/founding/>founding</a>&nbsp;
#<a href=/diary/tags/tax/>tax</a>&nbsp;
#<a href=/diary/tags/workcation/>workcation</a>&nbsp;
#<a href=/diary/tags/health/>health</a>&nbsp;</span><div class=post-content><p>23時に寝て1時半に起きて、起きてたのか寝ていたのか覚えてないうちに5時半になってた。あまりない時間の飛び方をしたので驚いた。</p><h2 id=隔週の雑談>隔週の雑談</h2><p>今日は特別な雑談で、顧問のはらさんに加え、<a href=/diary/posts/2023/1016/>新たに契約した税理士さん</a> の3人で行った。税理士選定のときに何人かと打ち合わせをしていて、面談する回数で毎月の顧問料の金額が変わるという話しを伺った。契約した税理士さんはもっとも毎月のコストが低かった。本当は税理士さんとも、いまはらさんと話しているように月1回ぐらい雑談できれば望ましいが、それはいまのコストに含まれていないサービスだろうからそこは断念することにした。今日の議題はこれら。</p><ul><li>みんなで自己紹介大会</li><li>会社の前期のふりかえりと今期の展望の紹介</li><li>ワーケーションの経費の共有と確認</li><li>未収還付法人税の扱いについての訂正依頼</li><li>電子帳簿保存法への対応</li></ul><p>うちの会社としてのイベントとして毎年ワーケーションを行うことを考えている。昨年はあくまで個人として企画して仲のよい人たちと一緒に参加した。一般の会社なら開発合宿と呼ばれるものだが、うちには社員がいないので1人で開発合宿しても仕方がない。そこで知人やコミュニティを巻き込んでワーケーションという、コワーキングなイベントにしてしまって、他者からの刺激やフィードバックを受ける機会にしたいという意図がある。コワーキングやコミュニティの価値を検証する poc にもなるかもしれない。以前、いとうさんに教えてもらった <a href=/diary/posts/2022/0618/#カフーツさん訪問>「余白」</a> という概念を検証するのもワーケーションという非日常の機会が望ましい。たった1人の会社でもこういったイベントができるということ自体も、なんか孤独ではなくて嬉しかったりする。</p><p>2021 の赤字決算のときに「欠損金の繰り返し還付」をその年で計上していなかったために、2022年は還付によって得たお金があり、それが2023年の帳簿では「未収還付法人税」として数字がマイナスで残ってしまっている。会計処理も税務処理も数字自体は誤っていないはずだが、この数値がずっと貸借対照表の資産として残り続けるのも気持ち悪いので訂正しないといけない。それを税理士さんへお願いしようと考えていた。税理士さんに伺ったところ、それは次の法人税の申告のときにまとめて直すという。別表4, 5, 5-1 あたりを修正すればよいという。法人税法をちゃんと理解しておかないと修正できないが、税理士さんは得意な作業の1つだという。</p><p>電子帳簿保存法についてまったくよく分かっていないけど、2024年1月から運用が変わるらしい。これまでは紙に印刷して保存しておけばよかったのが電子データでの保存が義務化される。それは問題ないのだが、電子データが改ざんされていないことを保証するためにはタイムスタンプ (電子署名のようなもの？) を付けて、さらに暗号化しないといけないといったシステム要件があるみたい。</p><blockquote><p>2021年度の改正により、取引先と電子データでやりとりした書類の書面保存が禁止されました。2024年1月1日からは、決められた保存方法にもとづいて、データのまま保存しなければなりません。</p><p><a href=https://www.freee.co.jp/kb/kb-trend/when-electronic-ledger-start/>電子帳簿保存法の電子保存義務化はいつから？2024年までに必要な対応を解説</a></p></blockquote><p>なにかしらうちの会社も対応しないといけないと思われる。厳密に電子帳簿保存法に定められたシステム要件を守らなくても、内規を設けてそれぞれの会社のルールで運用する分には問題ないと税理士さんが仰っていた。なにかしら電子データ保存のための内規を作らないといけないのかもしれない。今後、税理士さんと詰めていきたい。</p><h2 id=ワクチン接種>ワクチン接種</h2><p>15時から5回目のワクチン接種へ行ってきた。14時59分に受け付けを済ませたものの、タイミングがよくなくて、15分ほど待ってワクチン接種して、待っている間に外は雷雨になって、雷を避けながら帰ってくることになった。その後、普通にお仕事して摂取直後はとくに身体への負担はなかった。21時頃に熱を測ると37.0度になっていた。ほぼ1年ぶりのワクチン接種になる。</p><p>こんなことあるんやという失敗談を書く。体温計の使い方を忘れた。電源ボタンが見当たらなくて、電池切れたのかと思って100円ショップに購入へ行ってきて、電池交換のために上部を取り外ししていて電源ボタンに気付いた。ほぼ1年体温計を使わないでいると、電源ボタンの位置すら忘れていた。イメージとしては眼鏡をおでこにかけて、眼鏡がないと探している人みたいな失敗。日々の記憶もほとんど覚えていないような生活ではあるけれど、体温計の使い方を忘れるみたいなこともあるんやと実感した。自分もそういう失敗をするのだから他者にも優しくなろうと思えた。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1026/>権限管理ができるようになった</a></h1><div class=post-meta><time class=post-date>2023-10-26 (Thu.) ::</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;
#<a href=/diary/tags/auth/>auth</a>&nbsp;
#<a href=/diary/tags/node.js/>node.js</a>&nbsp;</span><div class=post-content><p>1時に寝て何度か起きて7時半に起きた。なんかしんどい夢をみたが、もう覚えていない。</p><h2 id=rbac-なミドルウェアの実装>rbac なミドルウェアの実装</h2><p><a href=/diary/posts/2023/1025/#interface-はデシリアライズできない>昨日の続き</a> 。rbac (role-based access control) なライブラリが一通り実装できたのでそれを使って <a href=/diary/posts/2023/1023/>echo のミドルウェア</a> を実装した。やりたいことは次のようなこと。たったこれだけだが、これを実装するために、ここ1週間ほど、あれやこれやの実装をしてきた。ようやくそれが動くようになったというところ。私にとってはミドルウェアの仕組みは過去に何度も実装してきたものだが、頭に描いたイメージのまま、実装できたのがよかったと思う。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>rbacWithConfig</span>(<span style=color:#a6e22e>cfg</span> <span style=color:#a6e22e>rbacConfig</span>) <span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>MiddlewareFunc</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>next</span> <span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>HandlerFunc</span>) <span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>HandlerFunc</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>c</span> <span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>cfg</span>.<span style=color:#a6e22e>Skipper</span>(<span style=color:#a6e22e>c</span>) {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>next</span>(<span style=color:#a6e22e>c</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>req</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Request</span>()
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>Context</span>()
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>sessionStore</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>keySession</span>).(<span style=color:#a6e22e>session</span>.<span style=color:#a6e22e>Store</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>userName</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#e6db74>&#34;username&#34;</span>).(<span style=color:#66d9ef>string</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>s</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>session</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>sessionStore</span>, <span style=color:#a6e22e>userName</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to get session: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Role</span>.<span style=color:#a6e22e>CanAccess</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>URL</span>.<span style=color:#a6e22e>Path</span>, <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>Method</span>) {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>ErrForbidden</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>next</span>(<span style=color:#a6e22e>c</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=nodejs-のアップグレード>node.js のアップグレード</h2><p>ちょうど管理画面も少し触ろうと思って環境を構築し始めた。たまたま node.js のバージョンをみると、ちょうど10月18日で 18 (LTS) の active support 期間が終了していた。security support は2025年4月まであるのでそんな急がなくてもよいが、それに気付いたついでなので 20 (LTS) にアップグレードすることにした。幸い、大半のライブラリは 20 (LTS) でもそのまま動いた。しかし、依存ライブラリのアップデートをしていて、一部 conflict してうまく動かないライブラリもあった。細かい原因調査をしていないが、フロントエンドの方がこまめにバージョンを上げていかないと何が原因でアプリケーションが正常に動かなくなるのか、分からなくなる気がする。</p><ul><li><a href=https://endoflife.date/nodejs>https://endoflife.date/nodejs</a></li></ul></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1025/>非日常を提供するという価値</a></h1><div class=post-meta><time class=post-date>2023-10-25 (Wed.) ::</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;
#<a href=/diary/tags/event/>event</a>&nbsp;
#<a href=/diary/tags/coworking/>coworking</a>&nbsp;
#<a href=/diary/tags/book/>book</a>&nbsp;</span><div class=post-content><p>1時半に寝て3時に起きてもう1回起きて6時半に起きた。</p><h2 id=interface-はデシリアライズできない>interface はデシリアライズできない</h2><p><a href=/diary/posts/2023/1024/#rbac-なライブラリの実装>昨日の続き</a> 。rbac なライブラリを使ってアプリケーションを実装していく。ログイン時にユーザーにロールを割り当ててセッションにロールを保持するのが都合よさそうに思えた。ロールの実装で一部の型は interface にして後から拡張できるような設計にしていた。例えば <a href=https://pkg.go.dev/encoding/json>encoding/json</a> ライブラリだと、Marshaler/Unmarshaler の interface を満たすことで任意の json のシリアライズ/デシリアライズをフックできる。調べたり、実際に動かしていていて気付いたのだけど、interface の場合はシリアライズは任意にできるけど、デシリアライズはできない。当たり前と言えば当たり前だが、interface を満たす複数の型がある中で json ライブラリがどの型でデシリアライズしていいか判別できないからだ。当初の interface を用いた設計が誤りだったことに気付いて、一部の型を汎用の構造体で設計し直すようなことをしていた。</p><p>またデシリアライズするときに一部の値を初期化したいといった要件がある。例えば mutex を初期化したい。このときに処理の内部で派生型を宣言して、それにキャストした上でデシリアライズの処理を実行した上で差分の処理を実装するというテクニックを学んだ。スコープが限定されて、コードがシンプルになって保守性も高い、久しぶりに頭のよいスマートなコードをみた。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Role</span>) <span style=color:#a6e22e>UnmarshalJSON</span>(<span style=color:#a6e22e>b</span> []<span style=color:#66d9ef>byte</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Alias</span> <span style=color:#a6e22e>Role</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Unmarshal</span>(<span style=color:#a6e22e>b</span>, (<span style=color:#f92672>*</span><span style=color:#a6e22e>Alias</span>)(<span style=color:#a6e22e>r</span>)); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>mu</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Mutex</span>{}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li><a href=https://stackoverflow.com/questions/56400734/custom-unmarshalbson-in-mongo-go-driver>Custom UnmarshalBSON in mongo-go-driver</a></li></ul><h2 id=コワーキングのオンラインイベント>コワーキングのオンラインイベント</h2><p>月例のカフーツさんのオンラインイベントに参加した。<a href=/diary/posts/2023/0927/#コワーキングのオンラインイベント>前回の所感はここ</a> 。今日は参加者が2人だけだった。コワーキングスペースを運営するコワーキングスペースマネージャーの連携を強化することで、コワーキングスペースの付加価値が上がったりしないか？といった内容を話したりしていた。コワーキングスペースマネージャーは、普通はお仕事で自分のコワーキングスペースにいないといけないから、なかなか他所のコワーキングスペースへ訪問すること自体が難しい。コワーキングスペース同士の連携により、お仕事でコワーキングスペースマネージャーが自分ところのコワーキングスペースの利用者を連れて、他所のコワーキングスペースへ訪問して、そこでイベントをしたりすればいいんじゃないかという案が出た。</p><p>いとうさんがよく <a href="https://cahootz.jp/?cat=21">コワーキングツアー</a> と称して、全国各地のコワーキングスペースへ訪問して、そこでイベント開催をしたり、その地域の取り組みなどを紹介したりしている。それと全く同じことを、コワーキングスペースの利用者に対してもその付加価値というのはあるかもしれないと私もよいアイディアだと思った。例えば、大阪のコワーキングスペースの利用者を広島へ連れていって、そこでイベントやって交流する。その逆も然り。通常のコワーキングスペースの利用者は自ら広島のコワーキングスペースへ行ってコラボレーションを行ったりしない。いや、いとうさんみたいに自らやる人もいるんだけど、そんな人は対象の利用者ではない。自分からは行かないが、誘われたら行ってもいいかなと考える人 (私もそんな1人だ) を移動させることで、新しい価値やアイディアが生まれるかもしれないと思える。私もいまはフルタイムのお仕事があるから自由に移動はできないが、いずれ会社の投資期間に入って、自分でスケジュールを決められる状況になれば、コワーキングツアーにも出掛けてみようと思う。</p><p>あと勉強会やイベント以外でコワーキングスペースで出来ることはないか？という話題でも盛り上がった。私は主催者の準備が大変だと出来ないから、主催者のコストが低いものという視点から考えて猫コワーキングがいいんじゃないかと提案してみた。ある週だけコワーキングスペースに猫が10匹ぐらいいますといった取り組み。課題は猫をどこから連れてくるかだけだが、そういう機会があれば確かに私も行ってみたい。そのアイディアの発散で非日常の体験ができるような取り組みがよいんじゃないかとまとめられていた。</p><ul><li>猫コワーキング (猫がたくさんいる)</li><li>深夜コワーキング (深夜に開いている)</li></ul><p>深夜コワーキングスペースのモデルとなる <a href=https://20db.stores.jp/>弐拾dB</a> さんというコワーキングスペースが広島の尾道にあるらしい。23-翌5時という営業時間だという。いとうさんが絶賛していたのでおもしろいオーナーが運営されているのだと思う。そのオーナーが執筆したエッセイの <a href=https://20db.stores.jp/items/61869c960548e03fb98a95ac>頁をめくる音で息をする</a> を購入してみた。</p></div></article><div class=pagination><div class=pagination__buttons><a href=/diary/posts/page/16/ class="button previous"><span class=button__icon>←</span>
<span class=button__text>最近の日記</span>
</a><a href=/diary/posts/page/18/ class="button next"><span class=button__text>過去の日記</span>
<span class=button__icon>→</span></a></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2024 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>