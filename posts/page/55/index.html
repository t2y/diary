<!doctype html><html lang=en><head><title>Posts :: forest nook</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/posts/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="Posts"><meta property="og:description" content><meta property="og:url" content="/diary/posts/"><meta property="og:site_name" content="forest nook"><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/posts/index.xml rel=alternate type=application/rss+xml title="forest nook"></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><div class=posts><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0420/>堅牢なインフラコード</a></h1><div class=post-meta><time class=post-date>2022-04-20 (Wed.) ::</time></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/cdk/>cdk</a>&nbsp;
#<a href=/diary/tags/infrastructure/>infrastructure</a>&nbsp;</span><div class=post-content><p>23時に寝て5時に起きた。</p><h2 id=駐輪場の定期更新>駐輪場の定期更新</h2><p>3ヶ月ごとの更新。ちょうどいまのお仕事の契約と同じ更新月になっている。前回と同じ金額だったのでまだ駐輪場の料金は値上げされていない。世界的にインフレしているのに日本が全然インフレしていない理由の1つとして不動産が値上げしていないからというのを日銀の記事で見かけた気がする。どこかのタイミングで不動産関連の値上げも始まるのかもしれない。</p><h2 id=インフラコードの抜本的リファクタリング>インフラコードの抜本的リファクタリング</h2><p>約2週間かけて、新規インフラ環境の構築、既存インフラの cdk/cf と同期されていなかったインフラ (rds, security group, croudfront, api gateway, waf) の同期など、インフラコードの大きな変更をやり終えた。一部 <code>fromLookup</code> でインポートしているリソースもあるが、いま完全に cdk/cf 管理なインフラとなった。ここからはせっかく cdk でコードを書いているので、モジュール化や共通化など、再利用可能なリソースとして定義して、複数の Stack でコードを再利用するといったリファクタリングをしていく。ひとまずこのことをボーナスステージと呼ぼう。いま完全に同期されたインフラがあるため、インフラ上のリソースの差分が出なければリファクタリングは正しいことが保証される。cdk は <a href=https://docs.aws.amazon.com/cdk/api/v2/docs/aws-cdk-lib-readme.html#dependencies>Stack 間の依存関係</a> も定義できるため、適切な依存関係を定義することでより堅牢なインフラコードとなるはずである。具体的には次のような依存関係になる。然るべき堅牢なインフラコードに書き換えていく。</p><ul><li>DatabaseStack<ul><li>BackendStack<ul><li>GatewayStack<ul><li>FrontendStack</li></ul></li></ul></li></ul></li></ul></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0419/>api gateway のデプロイ検証</a></h1><div class=post-meta><time class=post-date>2022-04-19 (Tue.) ::</time></div><span class=post-tags>#<a href=/diary/tags/cdk/>cdk</a>&nbsp;
#<a href=/diary/tags/infrastructure/>infrastructure</a>&nbsp;</span><div class=post-content><p>0時に寝て6時に起きた。</p><h2 id=api-gateway-のデプロイ検証>api gateway のデプロイ検証</h2><p>昨日の続き。api gateway を再作成すると、当然、既存のテスト環境は疎通できなくなってしまう。他の開発者を妨害しないようにまた21時から深夜にかけて作業しようと考えていたら、いまは閑散期でテスト環境を使わないといけないような開発の状況にはないと他の開発者から教えてもらった。PO の人たちも検証は一段落しているとのこと。午後からテスト環境壊してもよいという確認が取れたので13時からインフラ作業をしていた。早ければ1時間ぐらい、遅ければ4時間と見積もって、実際にデプロイしてみると、あれやこれやの抜け・漏れ、手動で設定されていたリソースの弊害などもあって、3時間ぐらいかかった。もう2週間ほどインフラの作業ばかりやっているせいか、何が起こっても4時間ぐらいあれば調査とリストアを完了できるぐらいの自信がついてきた。最終的に cdk で再作成した api gateway を使って cloudfront の distribution 経由で web api 呼び出しが繋がった。当たり前の話なんだけど、繋がる瞬間、ローカルで web api のエンドポイントを叩いてレスポンスが返ってくるときが嬉しい。最後の大物だったインフラもたった2日でやっつけることができた。これからはボーナスステージ。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0418/>api gateway のコード化</a></h1><div class=post-meta><time class=post-date>2022-04-18 (Mon.) ::</time></div><span class=post-tags>#<a href=/diary/tags/cdk/>cdk</a>&nbsp;
#<a href=/diary/tags/infrastructure/>infrastructure</a>&nbsp;</span><div class=post-content><p>1時に寝て7時に起きた。</p><h2 id=api-gateway-のコード化>api gateway のコード化</h2><p>いま cdk で管理していない大きなインフラとして <a href=https://aws.amazon.com/jp/api-gateway/>api gateway</a> がある。さらに restful api ではなく http api という新しい仕組みを使っているため、cdk 側も experimental な機能として提供されている。experimental と言っても本番環境で使われいるので十分に production ready と言える。弊害としては cdk のサンプルコードが少なく、公式の api reference に付いているサンプルコードぐらいしか参考になるものがなく、適当にコードを書いてでデプロイし、管理画面で意図した設定になっているかを確認するといったトライ&エラーみたいなやり方しかない。今日の時点では pr まで作ってデプロイと検証は翌日にまわることにした。</p><p>さらに cdk の v2 系では <code>-alpha</code> というパッケージが experimental 向けの機能を提供している。バージョン番号ではなく、パッケージ名に alpha が付くという分かりにくさに拍車をかけている。お手伝い先で使っている設定は次の3つのパッケージを使うことで実現できた。api gateway, vpc link, integration, route, authorization, stage など、複数のリソースを連携して設定しないといけないのでちょっとややこしい。</p><ul><li><a href=https://www.npmjs.com/package/@aws-cdk/aws-apigatewayv2-alpha>https://www.npmjs.com/package/@aws-cdk/aws-apigatewayv2-alpha</a></li><li><a href=https://www.npmjs.com/package/@aws-cdk/aws-apigatewayv2-authorizers-alpha>https://www.npmjs.com/package/@aws-cdk/aws-apigatewayv2-authorizers-alpha</a></li><li><a href=https://www.npmjs.com/package/@aws-cdk/aws-apigatewayv2-integrations-alpha>https://www.npmjs.com/package/@aws-cdk/aws-apigatewayv2-integrations-alpha</a></li></ul></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0417/>草稿書き</a></h1><div class=post-meta><time class=post-date>2022-04-17 (Sun.) ::</time></div><span class=post-tags>#<a href=/diary/tags/founding/>founding</a>&nbsp;</span><div class=post-content><p>0時に寝て7時に起きた。昨日もだらだらしていたので体調は完全に回復した。</p><h2 id=事例紹介の草稿作成>事例紹介の草稿作成</h2><p>お仕事で手伝っている会社の開発を事例紹介として紹介してよいという許諾をいただいた。草稿を提出して確認してもらわないといけないが、もう2週間前から放置してしまっていた。若い人には信じられないことだと思うけど、やろうと思った作業を後回しにしていると2週間ぐらいすぐに経つ。別にやる時間がないほど忙しいというわけではなく、なんとなく気乗りしないとか、割り込みでやるのが面倒くさいとか、今日は疲れたからまた明日やろうとかの延長で2週間が経ってしまう。若い人からみておっさんは仕事が遅いとか思われるわけだと思う。放置している2週間のうちに2回ほどちょこちょこ文章を書いたり、資料集めしたりはしていたので何もしていないわけではないが、本気を出せば2-3時間で終えることに2週間かかるのがおっさんのスピード感だと言っていいのだろうと思えた。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0416/>病み上がり</a></h1><div class=post-meta><time class=post-date>2022-04-16 (Sat.) ::</time></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;</span><div class=post-content><p>半日寝込んでいて3時に起きて7時に起きた。午後から、昨日寝込んでいたときに届いていたレビュー依頼の内容をレビューして、コードのリファクタリングをした。その後、病み上がりで調子が出ないので今日は気分転換しようと決めた。ストレッチを受けているときの、トレーナーさんの同じ体勢でいるのはよくないという言葉を思い出して、自転車でちょっとサイクリングして、その後、漫画喫茶に行って漫画読んでた。</p><h2 id=ストレッチ>ストレッチ</h2><p>今日の開脚幅は開始前158cmで、ストレッチ後160cmだった。昨日は発熱でずっと寝込んでいたせいか、体が硬くなってしまっていていつもよりストレッチを受けていて辛い部位が多かった。トレーナーさん曰く、ずっと同じ体勢でいるのが体にとってよくないとのこと。普段よりも肩甲骨まわりの筋肉が硬くなってしまっていたらしい。病み上がりで体調が整っていないときにストレッチを受けるのも復調させるための準備としてちょうどよかったのかもしれない。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0415/>ワクチンの副反応でダウン</a></h1><div class=post-meta><time class=post-date>2022-04-15 (Fri.) ::</time></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/founding/>founding</a>&nbsp;</span><div class=post-content><p>3時に寝て6時に起きた。1時までインフラ作業して帰ってきて、ワクチン接種のせいか、あまりうまく眠れなかった。朝に熱を測ったら37.2℃だったのでぎりぎり平熱だった。</p><h2 id=隔週の雑談>隔週の雑談</h2><p>顧問のはらさんと隔週の打ち合わせ。今日の議題は次の通り。徐々に熱が出てきてしんどかったせいか、情報共有の報告程度で終えた。</p><ul><li>今期の予算策定</li><li>次のお仕事を探す段取りの見通し<ul><li>現プロジェクトの区切りが5月末にあることから次の契約更新のタイミング (7月末) で契約終了する可能性がある</li></ul></li><li><a href=/diary/posts/2022/0115/#ワーケーション延期>延期したワーケーション</a> の再計画<ul><li>6月か7月ぐらいがよさそう</li></ul></li></ul><h2 id=ワクチンの副反応>ワクチンの副反応</h2><p>朝オフィスで測ったときは37.2℃でこのぐらいなら普通にお仕事できるかなと始めたんだけど、段々体温が上がってきて10時ぐらいには37.9℃になって、しんどいから一旦家に帰って横になって、デイリースクラムだけ家から参加した。その後もずっと寝込んでた。何回か起きて熱を測ったら最高38.5℃まで上がった。厚労省のサイトによると、3回目の副反応は2回目と同等とある。私は2回目の副反応はここまでひどくなかったのでこの差はファイザーとモデルナの違いなのかもしれない。熱が出て寝込むとか、数年に1回ぐらいの頻度でしか起きない。病気になったらこのぐらいしんどいんだなという、しんどさを思い出すのにちょうどよかったのかもしれない。</p><ul><li><a href=https://www.cov19-vaccine.mhlw.go.jp/qa/0101.html>追加（3回目）接種ではどのような副反応がありますか。2回目より重いのでしょうか。</a></li></ul></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0414/>コロナワクチン3回目</a></h1><div class=post-meta><time class=post-date>2022-04-14 (Thu.) ::</time></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/infrastructure/>infrastructure</a>&nbsp;</span><div class=post-content><p>22時に寝て3時に起きた6時に起きた。季節の変わり目のせいか、いつも眠い。</p><h2 id=ワクチン3回目接種>ワクチン3回目接種</h2><p><a href=/diary/posts/2021/0927/#コロナワクチン2回目摂取>2回目は昨年の9月27日</a> に接種した。6ヶ月以上経たないといけないので3月27日以降に接種資格を得て、実際に接種券が届いたのが4月7日だった。神戸市は初回のときにまごまごしたので他の自治体よりも遅れている。これまでファイザーを2回接種したので今回はモデルナを受けてみることにした。モデルナを扱っていてネット予約できるもっとも近くの診療所を予約した。オフィスから自転車で15分ぐらいのところ。16:30の予約なのに16時過ぎぐらいに行ったら普通に受け付けしてくれてすぐに接種もできた。16:05に接種終えて16:20まで待機してオフィスに戻ってきて普通にお仕事してた。その1時間半後に熱を測ったら37.0℃だった。その後もやや熱っぽいけど、平気とは言えば平気。</p><h2 id=インフラ移行作業>インフラ移行作業</h2><p>昨日の続き。フロントエンドのテスト環境が壊れる可能性があるため、他メンバーが使っていない夜に移行作業を行う。POの人たちがQA検証を19-21時ぐらいにやっていることが多いので21時以降に作業すると連絡しておいた。なかなか大変だった。最悪の場合、数時間テスト環境を使えませんと伝えていたものの、その通りで4時間ぐらい検証作業をしていた。cloudfront の distribution 設定を CloudFrontWebDistribution から Distribution へ移行して、新しいやり方であるマネージドポリシーを使うようにした。この設定が意図した振る舞いにならなくて検証作業に時間を割いた。</p><p>cloudfront 経由で web api を呼び出すルートがあってキャッシュを無効にしたいのだが、無効にしたキャッシュポリシー (ttl をゼロにする) を作るとヘッダーの設定ができない。次のようなエラーになる。</p><pre tabindex=0><code>The parameter HeaderBehavior is invalid for policy with caching disabled.
</code></pre><p><a href=https://github.com/aws/aws-cdk/issues/13441>(cloudfront): Cache Policy cannot forward Authorization header. #13441</a> によると、maxTTL を1秒にして <code>Authorization</code> ヘッダーをオリジンに転送するようには設定できる。キャッシュメソッドは GET と HEAD なので実運用上は問題ないとは思うが、この回避策がないかどうかを調べて検証していた。結果としてはなかった。<a href=https://docs.amazonaws.cn/en_us/AmazonCloudFront/latest/DeveloperGuide/add-origin-custom-headers.html#add-origin-custom-headers-forward-authorization>Configuring CloudFront to forward the Authorization header</a> には <code>Authorization</code> ヘッダーを転送する方法は次の2通りとある。</p><ol><li>cache key に含める</li><li>Managed-AllViewer という origin request policy をすべての viewer requests に含める</li></ol><p>最終的には1番目のやり方で対応はしたが、2番目のオリジンリクエストポリシーを設定する方法も検証してみた。オリジンリクエストポリシーを単体で設定することはできなくて、キャッシュポリシーも一緒に設定しないといけないことからキャッシュポリシーの設定の影響を受けて意図したように <code>Authorization</code> ヘッダーの転送はできなかった。</p><ul><li>cache policy: Managed-CachingDisabled</li><li>origin request policy: Managed-AllViewer</li></ul></div></article><div class=pagination><div class=pagination__buttons><a href=/diary/posts/page/54/ class="button previous"><span class=button__icon>←</span>
<span class=button__text>最近の日記</span></a>
<a href=/diary/posts/page/56/ class="button next"><span class=button__text>過去の日記</span>
<span class=button__icon>→</span></a></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>© 2021 Tetsuya Morimoto</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>