<!doctype html><html lang=en><head><title>Posts :: forest nook</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/posts/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="Posts"><meta property="og:description" content><meta property="og:url" content="/diary/posts/"><meta property="og:site_name" content="forest nook"><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/posts/index.xml rel=alternate type=application/rss+xml title="forest nook"></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><div class=posts><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0210/>windows の調査を開始</a></h1><div class=post-meta><time class=post-date>2023-02-10 (Fri.) ::</time></div><span class=post-tags>#<a href=/diary/tags/windows/>windows</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/issue-management/>issue management</a>&nbsp;
#<a href=/diary/tags/book/>book</a>&nbsp;</span><div class=post-content><p>1時に寝て7時過ぎに起きた。やや飲み過ぎて、2日酔いではないけど起きたときは気分が悪かった。</p><h2 id=go-winio-を触ってみた>go-winio を触ってみた</h2><p>windows 向けのモジュールを作り直すにあたり、有識者のサポートをお願いしているものの、私も最低限の知識はないとあかんやろと調査を開始した。<a href=https://github.com/microsoft/go-winio>microsoft/go-winio</a> というライブラリが ms 社のリポジトリで公開されている。公式ならよいのだろうと安易に考えて触ってみたものの、ドキュメントがほとんどなくて、まず使い方がわからん。いまのところ、windows に詳しい人向けのライブラリみたい。ひとまずリポジトリにある pipe_test.go のテストコードを読みながら名前付きパイプを介したプロセス間通信をやってみた。一応は動いたのでここから内部の windows api の仕様や設定などをみていく。その過程で go-winio のチュートリアルがないのであれば、私がテックブログを書いてもよいのかもしれない。</p><p>チュートリアル的に書いてみたコードは次の通り。</p><ul><li><a href=https://gitlab.com/t2y/misc/-/tree/main/winio-send>https://gitlab.com/t2y/misc/-/tree/main/winio-send</a></li><li><a href=https://gitlab.com/t2y/misc/-/tree/main/winio-receive>https://gitlab.com/t2y/misc/-/tree/main/winio-receive</a></li></ul><h2 id=課題管理勉強会>課題管理勉強会</h2><p>出張のときに毎月の課題管理勉強会。とくにネタが思いつかなかったので <a href=https://gihyo.jp/book/2018/978-4-7741-9605-3>エンジニアリング組織論への招待</a> を題材にしてみた。<a href=/diary/posts/2023/0205/>資料はすでに作ってあった</a> 。私にとっては課題管理をやる意義や価値の大半がこの書籍の中で解説されている。用語や考え方のところでとても参考になるし、いまメンタリングの技術の章を読み直したりもしている。昔はマネージャーやってなかったからその章は読み飛ばしてた。開発組織向けの組織論を解説した書籍でこれ以上のものは、いまのところ、私が読んだ本の中では知らない。4年前に読んだ本を、今回の勉強会を開く機会でまた読み直すきっかけにもなってよかった。本はコンテキストがきれいに構成されているので他の人の所感や意見を聞いたり雑談したりする題材としてもよさそうに思える。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0209/>リリースの前倒し</a></h1><div class=post-meta><time class=post-date>2023-02-09 (Thu.) ::</time></div><span class=post-tags>#<a href=/diary/tags/project-management/>project management</a>&nbsp;
#<a href=/diary/tags/team-building/>team building</a>&nbsp;
#<a href=/diary/tags/communication/>communication</a>&nbsp;</span><div class=post-content><p>23時に寝て何度か起きて5時半に起きた。</p><h2 id=プロジェクトの進捗報告>プロジェクトの進捗報告</h2><p>出張したときの月例報告の3回目。<a href=/diary/posts/2023/0112/>前回の進捗報告はこちら</a> 。1月はバックエンド開発を完了させてフロントエンド開発に着手した。当初は6ヶ月の開発期間を設けていたものの、1ヶ月前倒しの5ヶ月でフェーズ1の開発を完了させる見通しを報告した。管理画面も機能的にはすでに一通り実装できている。これから2月は使いやすさの ui を改善していくところや品質をあげるためのリファクタリングを行い、3月は運用レベルのテストをしてバグ修正を行う。ソースコードの品質も私がチェックしているので、どういう修正が必要かも予測できていて、十分に余裕のあるスケジュールだと私は考えている。油断も慢心もなく、いまできるだけの知識とスキルをつぎ込んで品質の高いプロダクトに仕上げるのに努める。</p><p>先月に宣言した通り、フェーズ1の開発はもう私の中では終わっていて次のフェーズ2への準備や計画をこれから考えていく。業務的に区切りがよいのでフェーズ1で契約終了する可能性もあったけれど、4月以降も開発のマネジメントをしてほしいとのこと。フェーズ1の開発と並行して、余裕をみてフェーズ2以降の計画も立てていく。フェーズ2以降に予定している、少なくともあと2つの機能開発に私は責任をもとうと契約の有無に関係なくもともと考えていた。それらを実装すれば大半のお客さんのニーズにあうプロダクトになるはずなのでそれ以降の開発は引き継いでいいかなと思う。言うても野心的に言えば3ヶ月強といったところか。チームも成長しているので3ヶ月前よりは開発速度が上がっている。</p><p>さらにいま私が担当しているプロジェクトとは別に、他にもやってほしいお仕事があるらしい。もしかしたらそれも含めて来季の半期以上のお手伝いになるのかもしれない。しばらく次のお仕事探しはしなくてよい状況にある。3月のリリースを終えたら会社の事例紹介を書きたい。今回は会社として初めてのプロジェクトマネジメントの実績になる。周りにも喧伝していきたい。</p><h2 id=出張晩ご飯>出張晩ご飯</h2><p>たまたま1月末に課題管理についてチャットで議論していたら盛り上がったのでこみやさんと晩ご飯に行ってきた。ざっくばらんに近況やチームのマネジメントについて話してきて楽しかった。19時半過ぎから始めて23時過ぎまで飲んでた。帰路の途中で新宿駅構内で人身事故が発生して、電車が止まってしまい、復旧に1時間ぐらいかかるというのでタクシーで帰った。タクシー料金も region pay で「ただいま東京プラス」のクーポンが使えたので金銭的に損はしなかった。</p><p>こみやさんのチームの話しからは、対話重視のスクラムのイベントが si におけるメンバーの教育にもうまくいっているように聞こえた。メンバー間で質問し合うのを促していて、質問者と回答者の双方の理解度をあげることを狙いとしている。質問が現状をふりかえるよいきっかけになっているとのこと。</p><p>あとメンバーに自律的に勉強会をしてもらうにはどうしたらいいかという話題も盛り上がった。私もいま毎週勉強会をやっていて、これはよい開発文化を作る上で大事だと思っているものの、いずれメンバーが自律的にやるようになってほしい。いまは私がお手本をみせるという意図もあって勉強会の運営をやっているのだけど、それをどうやってメンバーもできるように巻き込んでいくかを考えている。こみやさんや私が勉強会をやると、一定の水準で運営してしまうから、それがメンバーにとって逆に気後れさせてしまわないかという視点も話したりしていた。勉強会は準備に工数がかかると発表者が大変になって続かなくなるので、毎週やろうと思ったら準備に工数をかけないという仕掛けは重要になる。もしくは情報共有やコミュニケーションの場としての勉強会を考えるならもっと身近な内容を話す場になってもよいのでは？という考え方もある。例えば、最近の時事ネタで関心をもったニュースや技術などを取り上げて雑談するのでもかまわない。</p><p>いずれにしても、うちらがやれと指示してしまうと、業務命令として業務だからやっているだけになってしまい、よい開発文化を作るという、結果的に業務に大きな価値をもたらすなにかとは違うものになってしまうのがこの問題の難しいところ。開発をよりよくしたい。技術を深めたい。品質をあげたい。なにかしら開発そのものに対して関心をもって自律的にそういう活動をする開発者を増やしていく。言葉にすればたったこれだけのこと。しかし、このことを教えるのは相当に難しい。まだ私がマネージャーとして働く時間はあるのでこれからも挑戦していきたい。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0208/>車で行きたい場所</a></h1><div class=post-meta><time class=post-date>2023-02-08 (Wed.) ::</time></div><span class=post-tags>#<a href=/diary/tags/windows/>windows</a>&nbsp;
#<a href=/diary/tags/life/>life</a>&nbsp;</span><div class=post-content><p>23時に寝て5時に起きて7時半に起きた。軽く二度寝しようと思ったらちょっと寝坊した。</p><h2 id=windows-アプリケーション開発に関わる>windows アプリケーション開発に関わる</h2><p>ある windows モジュールの開発をやり直しことにしたのでその仕切り直しのキックオフに参加する。もう10年以上前の sier にいた頃は windows サーバーで oracle を動かしたり、vb6 のアプリケーション開発をやっていたりしたけれど、その後は windows アプリケーションの開発に関わったことはないのでまったく windows サーバーの知見はない。別チームから有識者に入ってもらって既存のモジュールを開発し直すことになった。私が実装するわけではないけれど、せっかくなので最近の windows の振る舞いを調べて仕組みを再確認する機会としたい。</p><h2 id=ニッポンの絶景>ニッポンの絶景</h2><p>たまたま帰ったときにテレビでやっていた <a href=https://syufufuu.com/hayasi-haruzekei230208/>林修のニッポンドリル 学者が選ぶ！春に見るべきニッポンの絶景ベスト24</a> をみた。
コロナ禍がひと段落したらインバウンドも戻るのかなという話題にあう、日本で観光するとよいところを紹介していた。出てくる風景がすごいのもあって、死後の世界だとか、桃源郷だとか、たしかにこんな場所あるんやなと思えておもしろかった。</p><p>この中に <a href=https://www.city.asago.hyogo.jp/takeda/>兵庫県朝来市の竹田城跡</a> が出てくる。本題じゃないけど、このサイトの構成がややおかしいと思う。スマホファーストなのは分かるけど、ちゃんとした業者に作ってもらえばよいのにと思ってしまった。閑話休題。竹田城跡は天空の城とも呼ばれる、知る人ぞ知る名勝であることは間違いなくて、私も1度は行ってみたいと考えている。ちょうど車も入手したところなので今年こそは行ってみたいと思う。それでよかったら会社の開発合宿やコミュニティのイベントなどにも応用していきたいと思う。都会にはない、地元のよいところや観光資源を活かして地域に貢献できるようにしたいという想いは歳を経るごとに感謝の気持ちとセットで実感できるようになってきた気がする。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0207/>1週間を管理しようとしない</a></h1><div class=post-meta><time class=post-date>2023-02-07 (Tue.) ::</time></div><span class=post-tags>#<a href=/diary/tags/issue-management/>issue management</a>&nbsp;
#<a href=/diary/tags/communication/>communication</a>&nbsp;
#<a href=/diary/tags/team-building/>team building</a>&nbsp;
#<a href=/diary/tags/postmortem/>postmortem</a>&nbsp;</span><div class=post-content><p>1時に寝て5時に起きた。ホテルのテレビを付けっぱなしで寝たら朝のニュースで起きた。なんとなくニュースをみながら7時ぐらいまでのんびりしてた。</p><h2 id=1週間のイテレーションはナンセンス>1週間のイテレーションはナンセンス？</h2><p>毎月行っているマイルストーンのふりかえり。今回で3回目なのでメンバーもだいぶ慣れてきた。11, 12, 1月と3ヶ月に渡って課題管理をメンバーに実践してもらいながら開発してきた。当初、開発のイテレーションを1週間で行うか、2週間で行うかの話し合いで短い方がいいんじゃないかとなり、あまり深く考えずに1週間のイテレーションで開発をまわしてきた。しかし、いまとなってはこれは開発のイテレーションとは違うものになっている。</p><p>最初の1ヶ月はメンバーにとって慣れないワークフローだから、1週間のイテレーションでこの issue をやる・やらないといった厳密な取り決めはしなかった。その後、徐々に慣れてきたのを見越して、定例会議のときに issue 一覧をみながら、メンバーに2-3個ぐらいの issue をアサインしたり、issue の優先順位付けを明確にしたりしてきた。必ず issue を完了させるという強い制約を課していないものの、だいたい毎週アサインしたものをメンバーは対応してくれていたので、マネージャーとしての私の視点からもとくに問題はないようにみえた。要はうまくまわっているのでそれ以上の管理をしなくてもいい状態だったと言える。</p><p>一方で、本来の課題管理のイテレーションとは異なる開発のワークフローになっていて、それがよいことなのかどうか、私自身にも明確な答えがなかった。それでメンバーに尋ねてみた。いまの1週間単位のイテレーション (開発のワークフロー) をどう思いますか？</p><p>メンバーからは、1週間の作業内容を厳密に決めなくてもいいんじゃないかという意見が出た。それは私の考えとも一致していたものの、開発のイテレーションを2週間に伸ばすことについて話しているときに、そうしたとしても、定例会議は毎週やりたいという意見が出た。要件確認や仕様共有のために重要だという。通常、イテレーションの成果共有のために定例会議とイテレーションの長さは一致している。仮にイテレーションを2週間にしたら定例会議は2週間に1回となる。しかし、メンバーの視点からはイテレーションを1週間にするか2週間にするかについて関心はないものの、毎週の定例会議で行っている情報共有は重要だという認識があった。</p><p>ここで開発のイテレーションと定例会議の頻度は別にあわせなくてもいいんじゃないかと考えるきっかけを私は得られた。スクラムもスプリントと会議体の頻度はセットになっているのでこの発想はなかった。ちなみにアリエル時代は1つのイテレーションが3ヶ月で定例会議もなかった。そして、うちのチームは1ヶ月のマイルストーンに対してふりかえりをセットにしている。これはもはやイテレーション開発の文脈でいえば、実質うちのチームはマイルストーンと呼んでいる1ヶ月が1つのイテレーションになっていて、1つのイテレーション内に4回の定例会議があるというイテレーション開発のワークフローになっていることに気付いた。課題管理の考え方やワークフローがもっと洗練されていくと、毎週の定例会議をやらなくてもよいようになっていくのが私の経験から自明である。しかし、うちの開発は私も含めて8割以上がフルリモートワークなので、メンバー全員の顔を合わせる機会を作るという観点から毎週の定例会議は大事な場にもなっている。</p><p>実際の開発のマネジメントをしてみると、私自身、分かっていなかったことや新たな発見があって、まだまだ自分自身も修行の身であることを実感する。ここでの結論としてわかったことは次の通りで、ロードマップにおける最初のフェーズが完了する3月末までは現状のワークフローを継続してみることに決めた。</p><ul><li>開発のイテレーションとして1週間は短過ぎて管理対象としてあわない</li><li>開発のイテレーションと定例会議の頻度をあわせなくてもよい</li><li>フルリモートワークの場合、メンバー全員を集める目的は情報共有だけではない</li></ul></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0206/>集中のち寝不足</a></h1><div class=post-meta><time class=post-date>2023-02-06 (Mon.) ::</time></div><span class=post-tags>#<a href=/diary/tags/gitlab/>gitlab</a>&nbsp;
#<a href=/diary/tags/ci/cd/>ci/cd</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;</span><div class=post-content><p>1時に帰ってきてそのまま寝ないで6時10分の新幹線に乗ってから2時間半ほど寝た。これはこれで時間の使い方が有意義な気がする。午前中は翌日の定例会議の準備を着々と進めて、ci/cd 環境の改善、午後からリファクタリングなどをやっていた。15時をまわると眠くなってきて散歩したりして気分転換しつつも体調悪いなと思って17時半にお仕事を終えてホテルへ戻って2-3時間ほど寝てた。その後、晩ご飯食べるかなと出掛けたものの、あまり食欲もなくて、2時間ほど付近を散歩して運動していた。たまにはそういうのもいいか。飲食店が多い地域なので外から眺めているだけでもわりと楽しい。</p><h2 id=ssh-経由のデプロイ>ssh 経由のデプロイ</h2><p>これまで ci/cd でテストして docker イメージをビルドしてコンテナレジストリに登録するところまでやっていた。実際にテスト環境にデプロイするときは、テスト環境にログインして更新用のスクリプトを私が手動実行していた。そんなに頻繁にテスト環境を更新する必要がなかったのでそれでも十分ではあるものの、ci/cd の完成形を目指すなら自動化すべきという考え方もあってデプロイの部分を作ることにした。</p><p>もっとも簡単な方法として <a href=https://docs.gitlab.com/ee/ci/ssh_keys/>Using SSH keys with GitLab CI/CD</a> をみながら、ssh でテスト環境にデプロイすることにした。すでに更新用のスクリプトがあって、テスト環境にログインして実行すればできる状態なので ssh さえ使えればすぐに移行できるという話しでもある。openssh-client を使うためにベースイメージを alpine から ubuntu にしてパッケージをインストールしないといけない。実行時間がややかかるというコスト以外には気にならないかな。ssh の秘密鍵を <code>file</code> 種別でもつのか通常の環境変数でもつのかで扱いが異なって、それに少しはまったぐらいですぐできた。今後は docker イメージのビルド単位に自動的にデプロイされるようになる。</p><h2 id=interface-の型エイリアスとしての-any>interface{} の型エイリアスとしての any</h2><p>go のコードをリファクタリングしていて json.Marshal の引数が <code>any</code> となっていることに気付いた。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Marshal</span>(<span style=color:#a6e22e>v</span> <span style=color:#a6e22e>any</span>) ([]<span style=color:#66d9ef>byte</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>go 1.18 以降で <code>interface{}</code> の型エイリアスとして <code>any</code> が定義されているらしい。任意の型を扱えるシグネチャとして、メソッドの振る舞いのみを規定する <code>interface{}</code> を使うというのは型システムとしては正しい。他言語でいえば object に相当するものが go はオブジェクト指向言語ではないのでそれがない。そういう間違っていないけど、わかりにくいなと思っていたものに <code>any</code> という名前の型エイリアスが導入されてとてもしっくりきた。プログラミングしていて、実務的にどうかというところをちゃんと改善していくところがみえるのは楽しい。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>any</span> = <span style=color:#66d9ef>interface</span>{}
</span></span></code></pre></div><ul><li><a href=https://zenn.dev/syumai/articles/c6q5un1j0msim0aj0ca0>Go 1.18 で interface{} の代わりに any が使えるようになる話</a></li></ul></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0205/>資料作りを丸半日</a></h1><div class=post-meta><time class=post-date>2023-02-05 (Sun.) ::</time></div><span class=post-tags>#<a href=/diary/tags/issue-management/>issue management</a>&nbsp;
#<a href=/diary/tags/book/>book</a>&nbsp;</span><div class=post-content><p>23時に寝て何度か起きて7時に起きた。起きたものの、なんかしんどくてお昼前まで寝てた。</p><h2 id=課題管理勉強会の資料作り>課題管理勉強会の資料作り</h2><p>出張前の定例作業になりつつある。本当は余裕をもって事前に資料作りしておけばよいのに、日々の余裕がないから出張直前の日曜日に資料作りしている。これはよくない兆し。次の課題管理勉強会は <a href=https://gihyo.jp/book/2018/978-4-7741-9605-3>エンジニアリング組織論への招待</a> を取り上げる。Chapter 1 の思考のリファクタリングから、私が関心のあるところ、もしくは課題管理で解決できそうな話題などを重点的に取り上げる。たたき台はできた。構成や進行をさらに練りたいので少し寝かせてからもうちょっと考える。読み返していると忘れていたことを思い出したり、課題管理と密接な内容を再発見したり、本の内容をずっと覚えているとかないから自分の勉強にもなる。本当は参加者同士で内容の議論ができるといいんじゃないかと思うけど、少人数の勉強会ではないから発言しにくい空気がある。もしくは発言するのは一部のメンバーに限られてしまう。とくにリモート参加が多いと勉強会は盛り上がらない。それは <a href=/diary/posts/2023/0203/#隔週の雑談>オンライン飲み会が盛り上がらない理由</a> と同じ。</p><p>12時頃にオフィス来て、途中に休憩を取っているけど、ひと段落して気付いたら23時まわってた。明日は始発で新幹線に乗る。このまま起きたまま夜通し出張の準備をして新幹線で寝る作戦に移行する。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0204/>go の学び直し 静的解析編</a></h1><div class=post-meta><time class=post-date>2023-02-04 (Sat.) ::</time></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/static-analysis/>static analysis</a>&nbsp;
#<a href=/diary/tags/event/>event</a>&nbsp;</span><div class=post-content><p>23時に寝て2時に起きて5時ぐらいにも起きて7時に起きた。昨日は podcast 収録でたくさん話して疲れてしまってそのまま帰ってすぐ寝た。すぐ起きるんだけど。</p><h2 id=ストレッチ>ストレッチ</h2><p>今日の開脚幅は開始前157cmで、ストレッチ後159cmだった。朝出かける前に開脚のストレッチしたら数値よくなるかな？と思ってやってみたらいつもより少しよくなった。ストレッチはいつも通りとも言えるし、腰の張りがまだまだ残っていることも確認できた。疲労が溜まっているんよな。毎週ストレッチしているからこの程度の疲労で済んでいるとも思える。お正月に実家から戻ってきてから1月の東京出張と35日は終えた。来週はまた2月の東京出張とその週末に49日がある。ここまで体力がもてばその次の法要は初盆なので少し空く。体力的に第4四半期の山場と言えるかもしれない。ただがんばる。</p><h2 id=go-の学び直し>go の学び直し</h2><p><a href=https://tenntenn.connpass.com/event/271533/>Gopher塾 #3 - 静的解析を使ったGoの開発ツール制作 入門編 - DAY 1</a> に参加した。</p><p>過去にも <a href=https://t2y.hatenablog.jp/entry/2015/03/11/025123>Python とマクロ、インポートフックと抽象構文木</a> や <a href=https://kazamori.jp/blogs/2020/07/12/java-annotation-processor/>Java のアノテーションプロセッサを試す</a> など、メタプログラミングのアプローチやコード生成などを実務で使ってきたので静的解析にも関心がある。講義内容の詳細は書かないけど、静的解析のような難しい話題に対して4時間という短い時間でとてもよい講義になっていたと思う。go の静的解析の要点や提供されているツールなどを一通り学ぶことができた。もちろん、実用するには試行錯誤や習熟を必要とするけど、取っ掛かりとして十分な内容に思えた。</p><p><a href=https://github.com/gostaticanalysis/skeleton>skeleton</a> というツールを使って静的解析のための analyzer プロジェクトのひな形を作る。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ go install github.com/gostaticanalysis/skeleton/v2@latest
</span></span><span style=display:flex><span>$ skeleton myanalyzer
</span></span><span style=display:flex><span>$ tree myanalyzer
</span></span><span style=display:flex><span>myanalyzer
</span></span><span style=display:flex><span>├── cmd
</span></span><span style=display:flex><span>│   └── myanalyzer
</span></span><span style=display:flex><span>│       └── main.go
</span></span><span style=display:flex><span>├── go.mod
</span></span><span style=display:flex><span>├── myanalyzer.go
</span></span><span style=display:flex><span>├── myanalyzer_test.go
</span></span><span style=display:flex><span>└── testdata
</span></span><span style=display:flex><span>    └── src
</span></span><span style=display:flex><span>        └── a
</span></span><span style=display:flex><span>            ├── a.go
</span></span><span style=display:flex><span>            └── go.mod
</span></span></code></pre></div><p>意図的にテストが落ちるようになっていてすぐ動作確認できる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ go mod tidy
</span></span><span style=display:flex><span>$ go test                                          
</span></span><span style=display:flex><span>--- FAIL: TestAnalyzer <span style=color:#f92672>(</span>0.05s<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    analysistest.go:448: a/a.go:5:6: diagnostic <span style=color:#e6db74>&#34;identifier is gopher&#34;</span> does not match pattern <span style=color:#e6db74>&#34;pattern&#34;</span>
</span></span><span style=display:flex><span>    analysistest.go:512: a/a.go:5: no diagnostic was reported matching <span style=color:#e6db74>&#34;pattern&#34;</span>
</span></span><span style=display:flex><span>FAIL
</span></span><span style=display:flex><span>exit status <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>FAIL	myanalyzer	0.349s
</span></span></code></pre></div><p>いろいろ説明を端折るけど、試しに FuncDecl の ast ノードに対して関数の行数をカウントする処理を実装してみた。<a href=https://pkg.go.dev/golang.org/x/tools/go/analysis#hdr-Pass>analysis パッケージの Pass</a> を使うと便利なユーティリティが提供されていて、静的解析をするときに面倒な処理をショートカットできて簡単に実装できることが理解できた。ここで作った analyzer は go vet で実行できるそうなのでプロジェクトの独自ルールを analyzer で実装して ci でチェックするといった運用もできる。応用範囲は広そう。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>case</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ast</span>.<span style=color:#a6e22e>FuncDecl</span>:
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>Name</span>, <span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>Pos</span>(), <span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>End</span>())
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>start</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>pass</span>.<span style=color:#a6e22e>Fset</span>.<span style=color:#a6e22e>Position</span>(<span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>Pos</span>()).<span style=color:#a6e22e>Line</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>end</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>pass</span>.<span style=color:#a6e22e>Fset</span>.<span style=color:#a6e22e>Position</span>(<span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>End</span>()).<span style=color:#a6e22e>Line</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;the number of lines:&#34;</span>, <span style=color:#a6e22e>end</span><span style=color:#f92672>-</span><span style=color:#a6e22e>start</span>)
</span></span></code></pre></div></div></article><div class=pagination><div class=pagination__buttons><a href=/diary/posts/page/32/ class="button previous"><span class=button__icon>←</span>
<span class=button__text>最近の日記</span></a>
<a href=/diary/posts/page/34/ class="button next"><span class=button__text>過去の日記</span>
<span class=button__icon>→</span></a></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>© 2021 Tetsuya Morimoto</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>