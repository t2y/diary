<!doctype html><html lang=en><head><title>Posts :: </title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/posts/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="Posts"><meta property="og:description" content><meta property="og:url" content="/diary/posts/"><meta property="og:site_name" content><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/posts/index.xml rel=alternate type=application/rss+xml title></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><div class=posts><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1223/>アクセシビリティを考える機会</a></h1><div class=post-meta><time class=post-date>2023-12-23 (Sat.) ::</time></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/event/>event</a>&nbsp;
#<a href=/diary/tags/web-design/>web design</a>&nbsp;
#<a href=/diary/tags/accessibility/>accessibility</a>&nbsp;
#<a href=/diary/tags/coworking/>coworking</a>&nbsp;</span><div class=post-content><p>0時に寝て3時半に起きて5時半に起きて8時に起きた。</p><h2 id=ストレッチ>ストレッチ</h2><p>先週は実家に帰っていて通常とは異なる日程だったのでアラームを解除していた。ストレッチの時間のアラームを聞いてから出掛けていたので危うく遅刻するところだった。</p><p>今日はとくにどこも悪くなくて、可もなく不可もなくといった感じだった。
トレーナーさんによると、冬は寒くて丸くなってしまうせいか背中が硬くなりやすいという。背中のツボをあちこち押されて痛かった。たまたまトレーナーさんと物価の話しをしていて、いま物の値段がピークアウトしてサービスの値段が上がってきていて、よいインフレの傾向になっているといった記事の共有をした。</p><ul><li><a href=https://note.com/goto_finance/n/nd2587229a2a3>日本の値上げに構造変化</a></li></ul><p>ストレッチもサービス業だから値上げしてトレーナーさんの給料も上がるとよいですねと。トレーナーさんによると、定期昇給といったものはなく、歩合給はあるもののそれほど大きくなく、給料をあげようと思ったら店長になるといった役職をつけないといけないらしい。あとトレーナーさんのスキルレベルによってお客さんが支払う金額も違う。昇給していくことが見込めないと、若い人しかトレーナーさんはできないのかな？という印象も受けた。スキルの高いプログラマは単価が上がっていくことが社会的に認識されているから将来に不安はないけれど、新しい職業や業態のキャリアモデルを作るのは難しいと思えた。今日の開脚幅は開始前155cmで、ストレッチ後157cmだった。</p><h2 id=アクセシビリティの話し>アクセシビリティの話し</h2><p>以前からはらさんが登壇されるという話しは聞いていた。ちょうど法事で実家に帰っていた日にイベントがあったようだ。</p><ul><li><a href=https://kansock.industries/ja/articles/20231222_01/>XR やクローラーについて話した次世代 Web カンファレンス A11y セッションが無事終了しました</a></li></ul><p>1:31:00 ぐらいから A11y (Accessibility) のセッションが始まる。はらさんが登壇されているので一通りみた。アクセシビリティわからない人がみてもおもしろかった。</p><div class=video-container><iframe src=https://www.youtube.com/embed/JSxwRcfJoYU allowfullscreen title="次世代 Web カンファレンス 2023"></iframe></div><p>20代、30代、40代の登壇者がいてバランスがよいようにみえた。また全盲の登壇者が A11y について話しているのはかなりの説得力をもっている。多くの人にとってアクセシビリティはあまり関心がない分野であり、プログラマーだけが注意すればよい問題でもないという。プログラマー、デザイナー、組織、エンドユーザーといった、プロダクトに関係するすべての人の認識や意識を調整してアクセシビリティは成り立つ。そして、障害当事者と出会う機会があるということそのものがアクセシビリティを考えることについてのプラスになるのではないかと話していて共感できた。登壇者にとっては、目の不自由な方がスマホをどう使うのかの動画が sns でバズっているのをみて、一般の人たちは (その登壇者にとって当たり前のことを) こんなに驚くのかと驚いたという。</p><p>私はフロントエンドの画面の開発に関して、たまに手伝う程度なのでアクセシビリティを意識して作ることはあまりない。しかし、使いにくいものは使いにくいとはっきり言うので、仕様や規格に準拠しているからとか、こういったデザインが流行りだとか、そういった物差しに関係なく意見は言う。登壇者の中にも自分の頭で使いやすい・使いにくいといったことを考えてほしいというメッセージを発していた。</p><h2 id=差し入れ>差し入れ</h2><p>私は出掛けていたので参加する予定はなかったが、<a href=https://www.facebook.com/events/1415020322425147>ブログJelly Vol.137</a> に三ノ宮.dev のメンバーが参加しているというのをみかけて差し入れしてきた。若い人はいろいろな経験を積んでどんどん挑戦してほしい。たまたま出先から帰ってきたのが19時前で <a href=/diary/posts/2023/0727/#神戸阪急百貨店のデパ地下>デパ地下のお寿司</a> を買いに行った。割引になるのを待っていたら19時を過ぎると20%引きのラベルを付け始めた。それをみて、サーモン詰め合わせ、マグロ鉄火巻、握り盛り合わせの3折箱を購入した。3-4人でつまむ程度の量。20%割引で3395円だったから定価だと4244円となる。これまでは720ml (四合瓶) のお酒をもっていくことが多かった。お土産用の、ちょっとよいお酒だとだいたい3000円前後かな。お寿司の方がやや値がはる。物価も上がっているのにあわせて手土産に使う金額も3000円程度という基準から5000円ぐらいまでは引き上げてもよいかもしれない。</p><ul><li><a href=https://www.facebook.com/kanzan10to9/posts/pfbid0SM2VrVpLcFkLDxwsayFVmQStUv2FrCzTxT3wJfB4m8JSxeLq1WouZv5AxpB9TxUgl>いとうさんのコメント</a></li></ul></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1222/>マネジメントは変わっていく、変わり続けるもの</a></h1><div class=post-meta><time class=post-date>2023-12-22 (Fri.) ::</time></div><span class=post-tags>#<a href=/diary/tags/founding/>founding</a>&nbsp;
#<a href=/diary/tags/issue-management/>issue management</a>&nbsp;
#<a href=/diary/tags/event/>event</a>&nbsp;</span><div class=post-content><p>晩ご飯食べて21時頃から横になっていた。なんか寒くてなにもやる気がしない。1時に寝て何度か起きて7時に起きた。</p><h2 id=隔週の雑談>隔週の雑談</h2><p>顧問のはらさんと隔週の打ち合わせ。今日は議題を準備するのを忘れていて、ふりかえりをしながらフリートークのような雑談をした。</p><ul><li><a href=/diary/posts/2023/1210/>2023年ふりかえり</a></li></ul><p>昨日の <a href=/diary/posts/2023/1221/>組織論の動画</a> なども共有しながら課題管理の文脈でマネジメントやリーダーシップの原則として思うことを言語化していた。次のような価値観をメンバーにもってほしい。</p><ul><li>常に人間は学ぶ<ul><li>どのポジションの人も、どんな役割でも、人それぞれのペースで学ぶのは当たり前である</li><li>組織に学ばない人がいると足を引っ張るようになってしまう</li></ul></li><li>人間は時間とともに成長して変わっていく<ul><li>同じことを何年もずっとやり続ければよいという時代ではない</li><li>成長することでやり方もやることも責任も変わっていく</li></ul></li><li>プロジェクトは一期一会<ul><li>人は学び成長することから同じプロジェクトを再現することは本当の意味でできない</li><li>そのときそのメンバーで、その知識や習熟度で取り組むプロジェクトはその人の人生において1度しかない</li><li>本当の意味でプロジェクトマネジメントに再現性などないし、そのときの状況で最適解を考えて実践しないといけない</li></ul></li></ul><h2 id=知の創造研究部会第63回>知の創造研究部会第63回</h2><p><a href=https://kmsj20231222.peatix.com/>知の創造研究部会第63回</a> に参加した。内容は悪くなかったが、私が関心のあるテーマではなかった。</p><p>最初の30分ほど、会そのものの紹介やイベントの宣伝、登壇者の自己紹介が延々と続いて、ちょっと長過ぎてうんざりした。自分たちのことをちゃんと知ってもらった方が内容がわかりやすくなるというのはやや前時代的な考えだと私からは思えた。私がイベントに登壇するとき、ほとんど自己紹介を省いて本題へ入るようにしている。それはおっさんの経歴を多くの聴衆は関心がないというのもあるが、本題を聞きたいのに関係ない話しをされるのを私自身もしんどく思うようになったのがある。映画館で映画をみるとき開始前に他の映画の宣伝が10分ぐらいあるのをうんざりする気持ちと同じ。</p><p><a href=https://www.facebook.com/groups/204376119725736>知の創造部会</a> というクローズドな facebook グループがあると聞いたので参加申請した。翌日には承認されていた。今後はイベント情報などをここでチェックすればよいのかもしれない。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1221/>うまくいかなくなった組織を立て直す難しさ</a></h1><div class=post-meta><time class=post-date>2023-12-21 (Thu.) ::</time></div><span class=post-tags>#<a href=/diary/tags/management/>management</a>&nbsp;
#<a href=/diary/tags/business/>business</a>&nbsp;
#<a href=/diary/tags/issue-management/>issue management</a>&nbsp;</span><div class=post-content><p>2時に寝て4時半に起きて7時半に起きた。昨日のオンラインイベントの後に課題管理についての質問を受けたらいろいろ調べ始めてしまって帰るのが遅くなった。</p><h2 id=組織論のあれこれと元凶>組織論のあれこれと元凶</h2><p>たまたま教えてもらってみたらおもしろかった。私もこの歳までに10社以上の組織をみてきたことから、組織の問題、あるいは組織であるがゆえに避けられない問題があることは理解できるし、自分の経験則でもダメな組織の特徴などいくつも思いつく。だいたい知っている内容ではあったけれども、若いのに書籍や論文を研究して、そういう現象にこういった名前がついているというのを言語化してくれていることは知識を共有する上で大事なことでもある。そこまでは知らなかったのでとても参考になる。</p><div class=video-container><iframe src=https://www.youtube.com/embed/W_b2vp19nWA allowfullscreen title="【組織崩壊のメカニズム】元DeNA人材育成責任者が日本のマネジメントに警鐘／大企業・メガベンチャーに共通する凡庸化すごろく／優秀なリーダーはこうして潰される【MANAGEMENT SKILL SET】"></iframe></div><div class=video-container><iframe src=https://www.youtube.com/embed/1DKaP396Ybg allowfullscreen title="【最も危険な上司はこの2種類】“かっこつけシャドーボクサー”と“承認欲求サンドバッグ”に気をつけろ／リクルートの「お前はどうしたい？」にまつわる誤解【MANAGEMENT SKILL SET】"></iframe></div><p>私が思う解決策の1つに役職や地位が固定化されないような組織設計というのがある。<strong>「権力は腐敗する」</strong> という言葉がある。権力を維持したまま、いまの人間社会でこれを避ける方法はないと私は考えている。どんな優秀な人であっても。上司も役員も社長でさえも、定期的に入れ替わる。どんなに成果をあげても優秀であっても一定期間以上とどまれない。そういう新陳代謝がいいんじゃないかと思う。実際にティール組織やホラクラシーといった組織形態はこの解決策を実現している。</p><p>動画の中で、心理的安全性の誤った解釈の文脈で組織がなぁなぁになっている世の中の流れがあって、私もずっと思っていたことの1つに自己肯定感を高めるのがよいというのは本当か？という問い。たしかに過去の行き過ぎたハラスメントは意味がないものではあったのは理解するが、できない人を然るべき内容で叱らないのもどうかという思いは私の中にもあった。坂井さんによると、自己肯定感が本当によいのかどうかという成果も怪しいという。</p><blockquote><p>成果が出ていない人に対して自尊心を高めると、逆に成果が悪くなったり、他者へ横柄になったりする。</p></blockquote><p>直感的に当たり前の話しだと思う。できない人を特別扱いする必要はない。そして、坂井さんは流行りのキーワードにとらわれず、自分たちの組織では本当にそうなのか？具体的で地に足の着いた制度や施策を見極めるべきだ、ちゃんと自分たちで考えましょうといったメッセージを発信していた。これは課題管理の文脈でも私もメンバーに常々言っている。自分たちのやり方にあうかどうかを考えるのが大事だ。</p><p>一方でうまくいっていない組織を立て直すのはとても難しい。それは組織のマネジメントというのは、上位の意思決定者、役員であったり部課長であったり、幹部社員の影響力がとても大きいため、うまくいっていないことを認めることそのものが役員や幹部社員へのダメ出しとなる。私もお手伝いをしていて、本質を追究すると経営陣への批判になってしまうため、お茶を濁すときもある。もちろん重要なことで言うべきところは言うが、それほど重要ではないところはお茶を濁してしまう。それは人間関係もあるし、取引関係もあるし、誰だって嫌な人になりたくないし、厳しいことも言いたくない。外部の人間ですら怯むところがあるのに、同じ会社の上下関係や人間関係ではもっと言いにくいことはあるだろうというのは容易に察することができる。優秀な若手が会社を去るのは至って自然だし、もっと言うと年配の人たちも若い人にポジションを譲って会社を去らないといけない。1つの会社で5-10年働くのはとても難しい時代にきているのだと私は思う。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1220/>リリースの延期</a></h1><div class=post-meta><time class=post-date>2023-12-20 (Wed.) ::</time></div><span class=post-tags>#<a href=/diary/tags/project-management/>project management</a>&nbsp;
#<a href=/diary/tags/failure/>failure</a>&nbsp;
#<a href=/diary/tags/event/>event</a>&nbsp;
#<a href=/diary/tags/coworking/>coworking</a>&nbsp;
#<a href=/diary/tags/agriculture/>agriculture</a>&nbsp;</span><div class=post-content><p>なんか疲れていて帰ってきて晩ご飯食べたらすぐに横になってた。0時に寝て5時半に起きて7時に起きた。</p><h2 id=プロジェクトのスケジュール調整>プロジェクトのスケジュール調整</h2><p>先週からお手伝い先の経営陣には一報を入れてあったのだけど、お昼にメンバーと 1on1 してスケジュール的に厳しそうという再確認をして正式にいまの開発スケジュールに対して1マイルストーン (2週間) を延期することに決めた。先週の時点で残タスクの状況と進捗をみていて厳しそうだとは私の視点からもみえていて、ある意味の予定調和ではある。いまの開発は昔のように残業したり休出したりしないため、遅れていることがわかった時点でできることは機能を減らすか、期日を延期するかの2択しかない。今回は内容的に機能を減らすことはやりにくいため、延期するという施策しか私には打ち手がなかった。</p><p>原因としてもっとも大きいことの1つは <a href=/diary/posts/2023/1128/#マイルストーン定例>新規メンバーが3ヶ月間なにもしなかった</a> ことであり、新規メンバー向けに用意した開発機能を既存メンバーで吸収しきれなかったことになる。既存メンバーに責任があるわけではなく、私がもう少し速く決断できなかったことの影響がこの遅延につながったというものではある。これはまた開発の大きなふりかえりの中でチームで議論したいと思う。</p><h2 id=コワーキングのオンラインイベント>コワーキングのオンラインイベント</h2><p>月例のカフーツさんのオンラインイベントに参加した。<a href=/diary/posts/2023/1115/#コワーキングのオンラインイベント>前回の所感はここ</a> 。今回は「今年よかったこと、来年やりたいこと」をそれぞれに発表する会になった。私は先日作成した <a href=/diary/posts/2023/1210/>2023年ふりかえりスライド</a> を参加者に共有して説明した。</p><ul><li>よかったこと: 課題管理の PoC を実務の開発で実践して成果が出ている</li><li>来年やりたいこと: 実家の離れにコワーキングスペースを作る</li></ul><p>参加者みんなが農業に関心をもっていて、IT x 農業という取り組みで新しい挑戦をすることに関心を示す人は多い。これは三ノ宮.dev においても同様で農業に関心をもっている人は多い。農業をビジネスにするのはとても難しいし、大変なことだと私は認識しているが、別にビジネスにならなくてもコミュニティ活動の一環やライフワークの1つとして、仲間たちと価値観を共有するための触媒もしくは土壌としてよさそうに考えている。いまのお手伝いのお仕事を終了したら、来年はいとうさんと一緒にコワーキング + 農業でうまく運営している先行事例を視察に行って、それらを研究して、なにかしら新しいことに取り組んでいきたいと思う。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1219/>結合テストのデバッグ</a></h1><div class=post-meta><time class=post-date>2023-12-19 (Tue.) ::</time></div><span class=post-tags>#<a href=/diary/tags/gitlab/>gitlab</a>&nbsp;
#<a href=/diary/tags/ci/cd/>ci/cd</a>&nbsp;
#<a href=/diary/tags/mongodb/>mongodb</a>&nbsp;
#<a href=/diary/tags/testing/>testing</a>&nbsp;</span><div class=post-content><p>1時に寝て5時半に起きて7時半に起きた。なんか週の前半からバテている。</p><h2 id=gitlab-cicd-の-dind-で-mongodb-のレプリカセット接続ができない>gitlab ci/cd の dind で mongodb のレプリカセット接続ができない</h2><p>先日対応した <a href=/diary/posts/2023/1214/>mongodb のレプリカセット対応</a> で残った最後の課題。ローカルで実行すれば結合テストは動くが、gitlab ci/cd 環境では動作しないという問題が残っていた。<a href=/diary/posts/2023/1218/>gitlab-runner をローカルで実行できる</a> ようにして、設定やパラメーターを変えたり、デバッグコードを埋め込んだり、コンテナに attach して振る舞いを確認したり、いろいろデバッグして原因はレプリカセット接続におけるホスト名の解決がコンテナ間でできていなかったことがわかった。</p><p>mongodb の結合テストは <a href=https://github.com/ory/dockertest>dockertest</a> を使って実装している。これを gitlab ci/cd で動かすには dind を有効にする必要がある。dind 環境では2つのコンテナを使って結合テストが実行されるわけだが、テストが実行されるコンテナと mongodb コンテナが起動するコンテナの2つが生成される。このときにテストが実行されるコンテナから実際に mongodb が起動するコンテナのホスト名の解決と、mongodb が起動するコンテナ上での自分のホスト名の解決の2つが成立していないとレプリカセット接続ができない。要は1台のローカルホスト上で結合テストを実行するのと、2つのコンテナ上で実行されるのでは設定を変更する必要があるということに気付いた。</p><p>具体的には dockertest の次のパラメーターを、実行環境から解決するホスト名を考慮して設定すればよいと気付いた。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>pool</span>.<span style=color:#a6e22e>RunWithOptions</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>dockertest</span>.<span style=color:#a6e22e>RunOptions</span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span> 
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Hostname</span>:   <span style=color:#a6e22e>executor</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Env</span>: []<span style=color:#66d9ef>string</span>{
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;MONGODB_ADVERTISED_HOSTNAME=%s&#34;</span>, <span style=color:#a6e22e>executor</span>),
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><p>たったこれだけの修正だし、現状の動作の振る舞いが分かればすぐに直せるものではあるけれど、このデバッグにはまた2-3時間を費やした。mongodb のレプリカセット接続はなかなか大変。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1218/>gitlab ci/cd のローカルデバッグ</a></h1><div class=post-meta><time class=post-date>2023-12-18 (Mon.) ::</time></div><span class=post-tags>#<a href=/diary/tags/gitlab/>gitlab</a>&nbsp;
#<a href=/diary/tags/ci/cd/>ci/cd</a>&nbsp;
#<a href=/diary/tags/debug/>debug</a>&nbsp;</span><div class=post-content><p>23時頃から寝始めて3時に起きて5時半に起きて8時過ぎに起きた。久しぶりに寝坊した。</p><h2 id=gitlab-runner-のデバッグ>gitlab-runner のデバッグ</h2><p>mongodb のレプリカセット対応して、ローカルでは結合テストが動くものの、gitlab ci/cd 環境では動かなくなった。gitlab ci/cd は <a href=https://docs.gitlab.com/runner/>GitLab Runner</a> によって提供されている。そのデバッグのため、ローカルに gitlab-runner をインストールして調査した。</p><p><a href=https://docs.gitlab.com/runner/install/>GitLab Runner のインストール</a> ドキュメントにそれぞれの OS 向けのドキュメントがある。Debian/Ubuntu/Mint 向けのインストール手順を行う。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -L <span style=color:#e6db74>&#34;https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.deb.sh&#34;</span> | sudo bash
</span></span><span style=display:flex><span>$ sudo apt-get install gitlab-runner
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ gitlab-runner --version
</span></span><span style=display:flex><span>Version:      16.6.1
</span></span><span style=display:flex><span>Git revision: f5da3c5a
</span></span><span style=display:flex><span>Git branch:   16-6-stable
</span></span><span style=display:flex><span>GO version:   go1.20.10
</span></span><span style=display:flex><span>Built:        2023-11-24T21:11:36+0000
</span></span><span style=display:flex><span>OS/Arch:      linux/amd64
</span></span></code></pre></div><p>.gitlab-ci.yml があるディレクトリへ移動して、ジョブを指定して実行する。ローカルでの変更内容を検証するときはブランチにコミットしないといけない。コミットしていないと次のワーニングが表示される。</p><pre tabindex=0><code>WARNING: You most probably have uncommitted changes. 
WARNING: These changes will not be tested.         
</code></pre><p>dind なジョブを実行するときは <code>--docker-privileged</code> で特権を付けて実行する。環境変数は <code>--env KEY=VALUE</code> で渡せるが、<code>CI_JOB_TOKEN</code> のような組み込みの環境変数は上書きできない。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cd path/to/repo
</span></span><span style=display:flex><span>$ gitlab-runner exec docker --docker-privileged <span style=color:#e6db74>${</span>ジョブ名<span style=color:#e6db74>}</span>
</span></span></code></pre></div></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1217/>田んぼ休暇</a></h1><div class=post-meta><time class=post-date>2023-12-17 (Sun.) ::</time></div><span class=post-tags>#<a href=/diary/tags/day-off/>day off</a>&nbsp;
#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/agriculture/>agriculture</a>&nbsp;
#<a href=/diary/tags/device/>device</a>&nbsp;</span><div class=post-content><p>1時に寝て5時半に起きてだらだらしてゲームをちょっとやって7時半に起きた。なぜか分からないけど、実家で寝ると普段3時間ぐらいしか睡眠できないのが4-5時間に伸びる。気圧？空気？土地の守りみたいなもん？夕方には神戸に戻ってきていたが、寒さで凍えたのもあってそれから作業する元気がなかった。</p><h2 id=田んぼ>田んぼ</h2><p>8時からトラクターで田んぼを耕す。昨日は暖かったのに一晩寝たら急に冷え込んだ。うちのトラクターは旧式なのでエアコンはついてなく、風を遮るものもないので風の強い気温の低い日はめっちゃ寒い。3時間ほど耕して畝を作った。写真は撮り忘れた。今回耕したところの畑は高低差ができてしまってよく耕せるところとそうじゃないところができて、あまりうまく耕せなかった。いずれ平坦にならさないといけない。</p><p>田んぼを終えてから近所の観光客向けの食堂でぶり丼を食べた。これで1,250円とやや割高ではあるけれど、ぶりの刺身は新鮮で質のよく、久しぶりにおいしいお刺身を食べた。若い子にとっては量が物足りないかも？だが、中年にとってはこのぐらいの量でちょうどよい。</p><figure><img src=/diary/img/2023/1217_buri-don.jpeg></figure><h2 id=スマートキーの電池交換>スマートキーの電池交換</h2><p>車のメーターパネルにスマートキーの電池残量低下という案内が出るようになった。調べてみると、スマートキーは常に電波を放出しているので短くて1年、長くても2年で電池が切れるという。ちょうどいま1年近く乗ったところなのでうちのスマートキーは1年程度で電池が切れるようだ。電池が切れたら車に乗れないのかな？と調べてみたらそうでもなくて、スマートキーに内蔵キーと呼ばれる物理キーも用意されていてそれでドアの施錠の開閉ができて、さらにエンジンのスタートも電池が切れていてもできる仕組みになっているそうな。そりゃそうか。電池切れる度に車に乗れなくなっていたら世の中もっと混沌としている。</p><ul><li><a href=https://www.honda.co.jp/ownersmanual/webom/jpn/fit/2020/details/136179090-4423.html>Hondaスマートキー</a></li><li><a href=https://www.honda.co.jp/ownersmanual/webom/jpn/fit/2020/details/136179090-14211.html>Hondaスマートキーの取り扱いと電池交換</a></li></ul><h2 id=ストレッチ>ストレッチ</h2><p>土日は実家に帰っていたので日曜日の夜にストレッチを受ける。土日に車で実家との往復をすると腰に負荷がかかる。さらに田んぼを耕すためにトラクターに数時間座って操作しているのでさらに追加で負荷がかかる。その目論見の通り、トレーナーさんの言葉からも、自他ともに今日は腰がもっとも疲弊していた。今日の開脚幅は開始前152cmで、ストレッチ後156cmだった。ストレッチ後に晩ご飯食べてからオフィスで作業するつもりが、外が寒くて出掛けるの億劫になってそのまま家でだらだらしていた。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1216/>一回忌</a></h1><div class=post-meta><time class=post-date>2023-12-16 (Sat.) ::</time></div><span class=post-tags>#<a href=/diary/tags/day-off/>day off</a>&nbsp;
#<a href=/diary/tags/life/>life</a>&nbsp;</span><div class=post-content><p>1時に寝て3時過ぎに起きた。あまり眠れないことのメリットとして普通に寝ても2-3時間で目が覚めるのだから朝早くに出掛けるときの寝坊リスクが減る。起きてから準備をして5時半過ぎには神戸を出て7時前には実家に着いた。6時半ぐらいまでは外は暗く、朝なのに暗い道を帰ることになった。</p><h2 id=夜は寝て朝に出掛ける>夜は寝て朝に出掛ける</h2><p>車があるのでいつでも帰れるのだが、最近は夜に帰るよりも朝に帰ることの方が多い。平日の夜はあまり時間がない。18-19時にお手伝い先のお仕事を終え、晩ご飯を食べ、次に自社のお仕事をしたり日記を書いたりしていると21-23時ぐらいになる。それから準備して帰るのは疲れていてやる気がしない。その日たくさん働いたーと思って帰ってきたらもう何もやる気はなくて、漫画読んだりアニメみたりゲームしてそのまま寝るというのが日常。翌日の出発準備すらやらない。</p><p>寝て起きたらまた新しい1日が始まるのですべてがリセットされる。この日常の生活のリズムを大きく崩さないという意図でも、朝起きてから行動するのが性にあう。</p><h2 id=一周忌>一周忌</h2><p>この前は <a href=/diary/posts/2023/0730/>初盆</a> だった。</p><figure><img src=/diary/img/2023/1216_hoyo1.jpg></figure><p>10時から住職に来ていただいてお経をあげていただく。今日は住職の斜め後ろに座ったので住職の様子を観察していた。お経をあげているときに折本をめくりながらお経を唱えている。あまり折本をみているようにはみえないが、進捗にあわせて折本をめくっていることに気付いた。いつも通り、住職にお経をあげてもらい、その後、出席者も真言の折本をみながら一緒に唱える。折本は裏表あるので、表面が終わったときにもう終わりかな？と油断していると、裏面のお経が始まるので初心者はちょっと驚くかもしれない。今日もってこられた真言の折本はいつもと違うものだった。</p><p>終わってから住職の法話を聞く。1年過ぎるのが早いといった趣旨でお話をされた。実は住職の父親の命日と父の命日は1日違いになる。住職にとっても近いうちに一回忌があるらしい。その想いも含めて話されていたのだろう。この人はこういう人だと型にはめて決めつけで話すことは多いが、人の本性のようなものを1つの側面から語ることは難しくて、さまざまな側面があることに、亡くなっていなくなってから気付くことも多いという。亡くなって1年たって、こんな人だったという輪郭もぼやけてきて、いろんな側面をもった人だという解釈でいいのではないかといった話だったような気がする。そして、1年経って、この場に来られた出席者の縁、来られなかった人たちの縁、いろんな縁があると話されていた。12月に会う人はみんな口癖のように1年が早かったと私の周りではいう。私もまたまったく同じ感覚で、この1年はなにをしていたか思い出せないぐらいに1年が足早に過ぎていく。幸い、いまは日記を書いているので過去の書いたものを読み返せばこんなことをやっていたなと思い出すきっかけにはなる。そうやってコンテンツを積み重ねることがいつかなにかの役に立つことも知っている。</p><p>11時から近所の和食料理屋さんに移動して法要の食事とする。だいたいいつも2時間ぐらいで早めに始めると13時に終わって、休日を潰すといったこともなくてよいと思う。</p><figure><img src=/diary/img/2023/1216_hoyo2.jpg></figure><p>前日に出席者の1人が来られ、腰を痛められて法事に参加できそうにないということだった。直前にキャンセルになってしまったので料理屋さんに電話して、お代は支払うが持ち帰れるお膳を作ってもらえないかと相談したら、立派な法要箱膳をこしらえてくれた。普通のお弁当のようなものを想定していたらその4倍ぐらいあるような箱膳にしてくれて、よい意味で期待を上回るものだった。お食事を解散してからその足で親戚の家に訪問して手渡ししてきた。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1215/>おいしい 🦀 を食べに行く</a></h1><div class=post-meta><time class=post-date>2023-12-15 (Fri.) ::</time></div><span class=post-tags>#<a href=/diary/tags/docker/>docker</a>&nbsp;
#<a href=/diary/tags/container/>container</a>&nbsp;
#<a href=/diary/tags/network/>network</a>&nbsp;
#<a href=/diary/tags/workcation/>workcation</a>&nbsp;
#<a href=/diary/tags/community/>community</a>&nbsp;
#<a href=/diary/tags/slack/>slack</a>&nbsp;</span><div class=post-content><p>22時頃に寝てしまって1時に起きて5時に起きて6時過ぎに起きた。とくになにもしていないのにバテている気がする。今週はずっと mongodb のレプリカセットの調査やインフラの移行作業などをやっていたせいか、普段よりもエネルギーを消費しているのかもしれない。朝から疲労困憊でオフィスへ向かった。</p><h2 id=docker-のコンテナネットワークの調査>docker のコンテナネットワークの調査</h2><p>docker のコンテナネットワークから解決できる名前がなになのか、よくわかってなくて、その調査のためにサンプルの compose サービスを作った。</p><ul><li><a href=https://github.com/t2y/docker-compose-sample>https://github.com/t2y/docker-compose-sample</a></li></ul><p>myimage から nginx のコンテナの名前解決がどうなるかを試してみる。</p><pre tabindex=0><code>c67a5ca94a77:/app# dig +short 00c719491558
192.168.240.3
c67a5ca94a77:/app# dig +short mynginx
192.168.240.3
c67a5ca94a77:/app# dig +short nginx
192.168.240.3
c67a5ca94a77:/app# dig +short yournginx
192.168.240.3
</code></pre><p>基本的にはサービス名、コンテナ名 (container_name)、コンテナー ID、ホスト名 (hostname) はすべて名前解決できる。hostname があるときはそのコンテナの /etc/hosts にその名前が追加され、ないときはコンテナ ID が追加されていた。</p><pre tabindex=0><code>yourcontainer:/app# cat /etc/hosts
127.0.0.1	localhost
...
172.18.0.3	yourcontainer
</code></pre><h2 id=冬の開発合宿の準備>冬の開発合宿の準備</h2><p><a href=/diary/posts/2023/0526/#開発合宿の日程確定>日程を決めたのが5月末</a> で、うちの会社のワークスペースに slack のチャンネルを開設したのが10月。現時点で7人の参加者がいる。もうこのメンバーでいいかなと考えている。今回はコミュニティのワーケーションイベントというより、自社の開発合宿という体をとっている。スポンサーとしていくらか会社からお金も出す。その理由の1つは slack チャンネルにログを残したいという意図がある。コミュニティの slack だとフリープランになるので3ヶ月以上過去のログがみえなくなってしまう。それを解消するには自社の有料プランの slack チャンネルに置いておくのがもっともログを制御できて嬉しい。</p><p>城崎温泉では11月から 🦀 が解禁となって、今年は冬に行くので 🦀 を食べるというのも目的の1つ。チャンネルで盛り上げようと、たまに城崎温泉の記事を貼り付けたりしていた。そろそろ、メンバーと顔合わせの情報共有の打ち合わせをしようと思って調整さんを作った。他の人たちは、わざわざうちの slack のワークスペースにゲスト参加しているから、あまり無理強いをせずに情報共有できるようにしておきたい。たった1つの、ほとんどやり取りしないチャンネルのために slack のワークスペースをオープンしておかないといけないという用途はなかなか面倒だ。私が逆の立場でもそう思う。どうにか普段使っているワークスペースから、必要なときだけ連携できるような仕組みがないだろうか？</p><p>年末・年始の情報共有の打ち合わせへ向けて旅のしおりも準備していく。日々の業務に忙殺されて後回しにしがちなので自分を追い込むためにも予定を入れた。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1214/>コンテナイメージの移行</a></h1><div class=post-meta><time class=post-date>2023-12-14 (Thu.) ::</time></div><span class=post-tags>#<a href=/diary/tags/mongodb/>mongodb</a>&nbsp;
#<a href=/diary/tags/infrastructure/>infrastructure</a>&nbsp;
#<a href=/diary/tags/container/>container</a>&nbsp;
#<a href=/diary/tags/life/>life</a>&nbsp;</span><div class=post-content><p>1時に寝て3時に起きて6時半に起きた。スマホで呪術廻戦のゲームを開いたまま寝てた。</p><h2 id=サードパーティの-mongodb-コンテナへの移行>サードパーティの mongodb コンテナへの移行</h2><p>昨日の <a href=/diary/posts/2023/1211/>mongodb のサードパーティのコンテナイメージ調査</a> の続き。</p><h3 id=レプリカセットの削除>レプリカセットの削除</h3><p>基本的に一度作ったレプリカセットを削除することはないせいか、レプリカセットを削除するユーティリティは提供されていない。なんらかの理由でレプリカセットを再作成したいときは、レプリカセットの設定が保存されている local database を削除する。</p><p>またレプリカセットの稼働中に local database を削除することはできないため、mongod サーバーを <code>--replSet</code> を指定していない状態で起動させ、そのときに次のようにして local database を削除できる。</p><pre tabindex=0><code>test&gt; use admin
admin&gt; db.grantRolesToUser(&#34;root&#34;, [&#34;__system&#34;]);
{ ok: 1 }
admin&gt; use local
switched to db local
local&gt; db.dropDatabase()
{ ok: 1, dropped: &#39;local&#39; }
local&gt; use admin
switched to db admin
admin&gt; db.revokeRolesFromUser(&#34;root&#34;, [&#34;__system&#34;]);
{ ok: 1 }
</code></pre><h3 id=コンテナを使ったレプリカセットの初期設定>コンテナを使ったレプリカセットの初期設定</h3><p><a href=https://hub.docker.com/r/bitnami/mongodb>bitnami/mongodb</a> を使うと、ローカルのシングルノードでレプリカセットを使うには次のような設定になる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>  <span style=color:#f92672>mongo</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>docker.io/bitnami/mongodb:7.0.1</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>user</span>: <span style=color:#ae81ff>root </span> <span style=color:#75715e># デフォルトは非 root ユーザーで起動するのでローカルの開発環境なら root で実行した方が手間がない</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>./volumes/mongodb:/bitnami/mongodb</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>MONGODB_ROOT_USER</span>: <span style=color:#e6db74>&#34;${MONGO_USER}&#34;</span>  <span style=color:#75715e># 認証ユーザー</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>MONGODB_ROOT_PASSWORD</span>: <span style=color:#e6db74>&#34;${MONGO_PASSWORD}&#34;</span>  <span style=color:#75715e># 認証ユーザーのパスワード</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>MONGODB_ADVERTISED_HOSTNAME</span>: <span style=color:#e6db74>&#34;mongo-primary&#34;</span>  <span style=color:#75715e># レプリカセットのノードを ip アドレスではなくホスト名で指定する</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>MONGODB_REPLICA_SET_NAME</span>: <span style=color:#e6db74>&#34;myrs&#34;</span>  <span style=color:#75715e># レプリカセットの名前</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>MONGODB_REPLICA_SET_MODE</span>: <span style=color:#e6db74>&#34;primary&#34;</span>  <span style=color:#75715e># プライマリノードとして設定</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>MONGODB_REPLICA_SET_KEY</span>: <span style=color:#e6db74>&#34;my/replication/common/key123&#34;</span>  <span style=color:#75715e># キーファイルのコンテンツ (base64 でデコードできる値)</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>MONGODB_SYSTEM_LOG_VERBOSITY</span>: <span style=color:#ae81ff>0</span>  <span style=color:#75715e># ログレベル</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>hostname</span>: <span style=color:#ae81ff>mongo-primary </span> <span style=color:#75715e># コンテナの内外から解決できるホスト名を指定</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>mongo </span> <span style=color:#75715e># コンテナ名 (docker container ls で表示される名前)</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>27017</span>:<span style=color:#ae81ff>27017</span>  <span style=color:#75715e># レプリカセットを運用する場合はポート番号のマッピングを一致させる必要がある</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restart</span>: <span style=color:#e6db74>&#34;always&#34;</span>
</span></span></code></pre></div><p>この設定でレプリカセットを初期した場合、レプリカセットの initialize 処理は、次のような config/member をもつ。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>members</span><span style=color:#f92672>:</span> [{ <span style=color:#a6e22e>_id</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>host</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;mongo-primary:27017&#34;</span>, <span style=color:#a6e22e>priority</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>5</span> }]
</span></span></code></pre></div><p>コンテナの内部からは mongo-primary というホスト名に対して、コンテナネットワーク内のローカル ip アドレスが解決される。</p><pre tabindex=0><code>c67a5ca94a77:/app# dig +short mongo-primary
192.168.240.3
</code></pre><p>ここで host os 上のアプリケーションから mongo コンテナに対してレプリカセット接続をする場合 <code>replicaSet=${レプリカセットの名前}</code> のパラメーターを追加する。</p><pre tabindex=0><code>mongodb://root:password@localhost:27017/?authMechanism=DEFAULT&amp;replicaSet=myrs
</code></pre><p>これは localhost:27017 にレプリカセットの接続を試行し、接続できるとレプリカセットのメンバーが返される。</p><p>レプリカセットのメンバーには <code>mongo-primary:27017</code> という設定が行われているため、mongo-primary というホスト名に対して host os 上で名前解決できる必要がある。そのために /etc/hosts に次の設定を行う。</p><pre tabindex=0><code>$ sudo vi /etc/hosts
...
127.0.0.1 	mongo-primary
</code></pre><p><a href=https://www.mongodb.com/products/tools/compass>compass</a> で接続した場合、レプリカセット接続であれば、レプリカセットの名前が接続情報として表示される。</p><h2 id=ダイニングテーブル引き取り>ダイニングテーブル引き取り</h2><p>実は火曜日にも長机を引き取りに行ってきて、今日はダイニングテーブルを引き取りに行ってきた。この3日間で2つもテーブルが手に入った。いつも目ぼしいと思ったものは、すぐに他の人と取り引きが成立してしまうのに、たまたま続けて私と取り引きが成立した。車で20分ぐらいの距離のマンションまで引き取りに行った。20時の予定を、19時10分には着いてしまって、先方も快く対応してくれた。私よりも見た目すこし年配の方で人当たりのよい感じの方だった。ジモティのやり取りはその人の性格が出るもので、受け渡しだけささっとやって余計な話しはしないパターンもあれば、愛想よく話しながら受け渡しをするパターンもある。先方によると、大事に使っていたテーブルのようにみえるので私も離れのオフィススペースで大事に使おうと思う。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1213/>mongodb のサードパーティのコンテナイメージ</a></h1><div class=post-meta><time class=post-date>2023-12-13 (Wed.) ::</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;
#<a href=/diary/tags/mongodb/>mongodb</a>&nbsp;
#<a href=/diary/tags/infrastructure/>infrastructure</a>&nbsp;
#<a href=/diary/tags/container/>container</a>&nbsp;</span><div class=post-content><p>23時に寝て3時に起きて寝たかどうか覚えていないうちに6時半になっていて7時半に起きた。</p><h2 id=json-を介した-go-の-bool-値のバリエーション>json を介した go の bool 値のバリエーション</h2><p><a href=https://github.com/go-playground/validator>go-playground/validator</a> のバリデータには <a href=https://pkg.go.dev/github.com/go-playground/validator/v10#hdr-Required>required</a> というバリデーションオプションがある。しかし、このオプションは go のゼロ値でないことをチェックするという仕様になっている。bool のゼロ値は false となるため、リクエストした JSON データに false を設定していたのか、未設定だったのかの違いを検出できない。これはバリデータの問題ではなく、go の json ライブラリの制約のようなもので使い勝手のよい仕様とは言えない。私もこの振る舞いに起因する不具合に遭遇したこともあるし、こういうときにどうしたらよいかも過去に3回ぐらいは調べている気がする。</p><ul><li><a href=https://github.com/go-playground/validator/issues/142>How to validate bool #142</a></li></ul><p>現時点での私の最適化は次のコードになる。データ構造として <code>*bool</code> 型にすれば、ポインタ型のゼロ値は nil となるため、true, false, nil の3値でバリデーションできる。しかし、私はこのデータ構造を好ましく思わない。というのは、内部的には true/false の2値でしか管理しないメンバーを、json のバリデーションのためだけに nil も許容する3値にすることがよい設計だと私は思えない。そこでバリデータによるバリデーションは諦めて、json の Unmarshal 処理をフックしてバリデーション相当の処理を自分で実装する。このやり方のデメリットはメンバーが追加されたときに自分で UnmarshalJSON() メソッドを保守する必要がある点になる。しかし、メリットとして内部のデータ構造の型は <code>bool</code> 型で扱える。一概にどちらがよいとは言いにくいかもしれないし、設計上の好みかもしれない。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>reqMyData</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Name</span>       <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;name&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>View</span>       <span style=color:#f92672>*</span><span style=color:#66d9ef>bool</span>  <span style=color:#e6db74>`json:&#34;view&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>MyData</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Name</span>       <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;name&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>View</span>       <span style=color:#66d9ef>bool</span>   <span style=color:#e6db74>`json:&#34;view&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>d</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>MyData</span>) <span style=color:#a6e22e>UnmarshalJSON</span>(<span style=color:#a6e22e>data</span> []<span style=color:#66d9ef>byte</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>tmp</span> <span style=color:#a6e22e>reqMyData</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Unmarshal</span>(<span style=color:#a6e22e>data</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>tmp</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to unmarshal as reqMyData&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>tmp</span>.<span style=color:#a6e22e>View</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;required view field&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Name</span> = <span style=color:#a6e22e>tmp</span>.<span style=color:#a6e22e>Name</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>View</span> = <span style=color:#f92672>*</span><span style=color:#a6e22e>tmp</span>.<span style=color:#a6e22e>View</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=サードパーティの-mongodb-コンテナイメージ>サードパーティの mongodb コンテナイメージ</h2><p>先日の <a href=/diary/posts/2023/1211/>mongodb のレプリカセット調査</a> の続き。コードレビューをしていて <a href=https://hub.docker.com/r/bitnami/mongodb>bitnami/mongodb</a> というサードパーティのコンテナイメージを使った方がよいのではないか？というコメントがあったのでその調査をしてみた。VMware 社が提供しているサードパーティのコンテナイメージらしい。</p><blockquote><p>MongoDB(R) is run and maintained by MongoDB, which is a completely separate project from Bitnami.</p></blockquote><p>まず MongoDB プロジェクトとはまったく別管理であることが書いてある。</p><blockquote><p>Bitnami イメージを使用する理由</p><ul><li>Bitnamiはアップストリームソースの変更を綿密に追跡し、自動化されたシステムを使用してこのイメージの新しいバージョンを迅速に公開します。</li><li>Bitnami イメージでは、最新のバグ修正と機能をできるだけ早く利用できます。</li><li>Bitnamiのコンテナ、仮想マシン、クラウドイメージは、同じコンポーネントと構成アプローチを使用しているため、プロジェクトのニーズに応じて形式を簡単に切り替えることができます。</li><li>Bitnamiのイメージはすべて、minideb（最小限のDebianベースのコンテナイメージ）またはscratch（明示的に空のイメージ）をベースにしています。</li><li>Docker Hubで利用可能なすべてのBitnamiイメージは、Docker Content Trust（DCT）で署名されています。DOCKER_CONTENT_TRUST=1 を使用して、イメージの完全性を確認できます。</li><li>Bitnamiコンテナイメージは定期的にリリースされ、最新のディストリビューションパッケージが利用可能です。</li></ul><p>MongoDB®を本番環境で使用したいですか？Bitnami Application Catalogのエンタープライズ版であるVMware Tanzu Application Catalogをお試しください。</p></blockquote><p><a href=https://hub.docker.com/_/mongo>mongo</a> の公式イメージは ubuntu をベースイメージにしている。ubuntu よりは minideb の方が軽いのかな？そしてちゃんと upstream にも追随しているみたい。このベースイメージの違いによるものかは定かではないが、結合テストのイメージも移行してみたところ、10-20秒ほど結合テストの実行時間が速くなった。割合にすると10%程度かな。</p><blockquote><p>KubernetesにMongoDB®をデプロイするには？</p><p>Bitnami アプリケーションを Helm Chart としてデプロイすることは、Kubernetes 上で当社のアプリケーションを使い始める最も簡単な方法です。インストールの詳細については、Bitnami MongoDB® Chart GitHub リポジトリを参照してください。</p><p>Bitnami コンテナは、クラスタへの Helm Charts のデプロイと管理に Kubeapps と一緒に使用できます。</p></blockquote><p>helm chart も提供しているようで、いずれクラウド版を作るときに MongoDB も k8s 上にデプロイする上でこのことは都合がよいように思える。</p><p>レプリケーションを前提とした初期設定があり、entrypoint スクリプトもいくつか読んでみた感じだと、きれいに管理されていて保守もちゃんとやってくれそうにみえる。</p><ul><li><a href=https://github.com/bitnami/containers/tree/main/bitnami/mongodb>https://github.com/bitnami/containers/tree/main/bitnami/mongodb</a></li></ul><p>昨日、導入したばかりの公式イメージ + 自作スクリプトによるレプリケーション設定を廃止して、Bitnami のコンテナイメージを使うことに決めた。</p></div></article><div class=pagination><div class=pagination__buttons><a href=/diary/posts/page/32/ class="button previous"><span class=button__icon>←</span>
<span class=button__text>最近の日記</span>
</a><a href=/diary/posts/page/34/ class="button next"><span class=button__text>過去の日記</span>
<span class=button__icon>→</span></a></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2025 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>