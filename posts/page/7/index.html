<!doctype html><html lang=en><head><title>Posts :: </title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/posts/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="Posts"><meta property="og:description" content><meta property="og:url" content="/diary/posts/"><meta property="og:site_name" content><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/posts/index.xml rel=alternate type=application/rss+xml title></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><div class=posts><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0917/>業務としてのリファクタリングへの集中力</a></h1><div class=post-meta><time class=post-date>2024-09-17 (Tue.) ::</time></div><span class=post-tags>#<a href=/diary/tags/refactoring/>refactoring</a>&nbsp;
#<a href=/diary/tags/motivation/>motivation</a>&nbsp;</span><div class=post-content><p>今週からメンバーが開発した、少し大きめの機能の品質改善のためにリファクタリングをしていく。本当は週末に進めておこうと思っていたものの、どうにもやる気がなくてまったく手をつけられていなかった。不思議なもので休日は朝起きられなかったりオフィスへ行ってもまったくコードを書けなかったのに、平日なら普通に朝8時までに起きてオフィスへ行って集中して作業できた。2日休んでいるので体力を回復していたというのはある。それでも休日と平日の業務としてのプログラミングへの集中力の違いは何なんだろう？とやぎさんに相談したら <a href=https://www.diamond.co.jp/book/9784478023211.html>反脆弱性［上］</a> という本にその答えが書いてあったと教えてもらった。この本を読まないとその答えは得られない。しかし、いまの私は本を読む元気がない。誰か読んだ人がいたら私にわかりやすく教えてほしい。</p><p>私が書いたコードに対する不備や欠陥は責任感からリファクタリングをする一定のモチベーションになる。しかし、他人が書いたコードのリファクタリングはそのモチベーションがいくらかレベルダウンするのではないか？という仮説もある。他人のコードを読んで理解するのはコストがかかるし、本質的には他人のコードを読むことはできても理解することはできない。コードの出典に起因するストレスもあるのかもしれない。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0916/>秋休み2</a></h1><div class=post-meta><time class=post-date>2024-09-16 (Mon.) ::</time></div><span class=post-tags>#<a href=/diary/tags/day-off/>day off</a>&nbsp;</span><div class=post-content><p>昨日に引き続き、やる気が出なくてなにもせずお休みしていた。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0915/>秋休み1</a></h1><div class=post-meta><time class=post-date>2024-09-15 (Sun.) ::</time></div><span class=post-tags>#<a href=/diary/tags/day-off/>day off</a>&nbsp;</span><div class=post-content><p>お昼はだらだらしていて夜にオフィスへ行ったものの、全然やる気が出なくてとくに作業は進められなかった。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0914/>連休の初日</a></h1><div class=post-meta><time class=post-date>2024-09-14 (Sat.) ::</time></div><span class=post-tags>#<a href=/diary/tags/health/>health</a>&nbsp;</span><div class=post-content><p>昨日も2時頃までコードを書いていて帰って寝たらお昼ぐらいまで寝ていた。ストレッチ終えてからコードを書こうと思っていたものの、モチベーションがあがらなくてだらだらしていた気がする。</p><h2 id=ストレッチ>ストレッチ</h2><p>今週もデスクワークの時間が長かったせいか、軽く腰の張りを感じた。トレーナーさんからも運動不足からカラダの硬さがみえるといった指摘があった。先週はレビューの時間が多くてあまり時間を時間を取れなくて業務があまり進捗しなかった。そのストレスもあってなのか、また生活の余裕がなくなってきた。今日の開脚幅も開始前149cmで、ストレッチ後153cmだった。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0913/>責任を扱うコミュニケーションの在り方</a></h1><div class=post-meta><time class=post-date>2024-09-13 (Fri.) ::</time></div><span class=post-tags>#<a href=/diary/tags/founding/>founding</a>&nbsp;
#<a href=/diary/tags/communication/>communication</a>&nbsp;
#<a href=/diary/tags/issue-management/>issue management</a>&nbsp;
#<a href=/diary/tags/business/>business</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/meta-programming/>meta programming</a>&nbsp;</span><div class=post-content><p>水曜日から継続していたメンバーのコードレビューをお昼頃に完了して、それからは自分の時間に集中して開発に取り組めた。途中、晩ご飯休憩もしながら翌2時頃までコードを書いていて issue を2つ fix した。</p><h2 id=隔週の雑談>隔週の雑談</h2><p>顧問のはらさんと隔週の打ち合わせ。ここ1-2ヶ月はあまり議題がなくて近況について雑談した。いまの開発フェーズが終わらないと、私が開発以外にリソースを割いていないので他のことに取り組む余裕はないかもしれない。開発プロジェクトにおける、議題の1つで次のインタビュー記事の内容について雑談した。</p><blockquote><p>責任をすぐに相手に投げてしまわないこと。責任をこちらで負えるように日頃から信頼貯金を貯めていくことが大事です。責任を負うこと自体はたいへんだけど、仕事は楽になるんです。</p><p>でも、人は責任を負いたくないと考えてしまうんですね。気持ちは分かりますよ、責任を負うのには胆力が必要ですから。そして責任を負いたくないから「いつまでですか？」と聞いてしまう。その途端、スケジュールを決めるのは相手の裁量になる。責任から降りて、自分から立場を下にして、受発注の関係にしてしまっています。</p><p><a href=https://findy-code.io/engineer-lab/naoya_ito>何が事業貢献なのか分からなくなっていた伊藤直也さんが再認識したユーザーエクスペリエンスへのコミット</a></p></blockquote><p>私自身、このインタビュー記事を読むまで相手に仕様や納期を決めてもらうことを、相手に責任を負わせるという視点をもっていないかった。しかし、その通りでもあると新たな気付きを得た記事でもあった。うちらはプログラマーという、システムを作る専門家なのでビジネス課題や解決したい業務課題について、その課題意識をもっている人 (ビジネスオーナー) から教えてもらうのを至極当然のように考えてしまう。そして、それ自体はいまの業務の在り方としてそうならざるを得ないところもある。</p><p>システム開発はそれぞれの専門職が分業によって行う。とくに規模が大きくなればそうなる。この構造そのものは一般的といえる。しかし、一緒にプロジェクトをやっていく働き方や考え方によってはその責任を分散させられるというのがこの記事に書いてあることだとわかる。そして、私自身これまで意識せずにそういった行動をいくらか取ってきているところもあり、それは「気付き」のレベルによって起こるものだとずっと考えていた。気付くからより多くの、より本質的な、より優れた改善のための行動ができる。そして、私の考え方も間違ってはいないと思うが、私は他人よりリスクを取りがちな性格があるから責任をこちらで負うという意識をあまりもっていなかった。つまり、私は自分の価値観でこうしたいと思って勝手にやっていたことを、別の見方では相手から責任を受け取って進めているという解釈もできる。</p><p>ちょうど <a href=/diary/posts/2024/0910/>兵庫県知事の百条委員会の答弁</a> もみていて感じたことだが、私はこういったコミュニケーションを本質的に好んでいない。自分の責任ではないという議論をしても、モノゴトは前に進まない。世間では百条委員会の後も知事の説明は十分ではなかったとみられている。その所以である。誰かが責任をもってモノゴトに取り組む必要がある。その責任の所在を明確にすることも大事ではあるが、自身の責任ではないという主張だけでは物足りなさを感じる。普段の業務においてもそういう姿勢やコミュニケーションを取る人が少なからずいる。はらさんの経験でもその点においては同意していた。よくある状況だと思える。自身に責任を負うことをためらわないコミュニケーションを取る人とそうではない人の2通りがあるのだと気付いた。そして、私は後者の人とコミュニケーションを続けていると疲弊したり苛々したりすることがある。それゆえに私自身も結果に対して潔くあろうと努めるし、潔い人たちとウマがあうのだろうともわかってきた。</p><p>課題管理の文脈においては、コミュニケーションのやり取りから責任の綱引きがどのような場所でどのぐらい起きるのか。人間であれば読み取れるが、ai はその意図を解釈できるか。そういった業務の責任という概念を見える化することに意味はあるかもしれない。責任の押し付け合い、または責任分散、本質的にどうあるべきだったかをなんらかの指標をもって数値化できればおもしろいのではないかと思えた。</p><h2 id=go-における簡単な式の評価>go における簡単な式の評価</h2><p>テスト自動化のツールを作っていて、テストデータでちょっとした式の評価をやりたくて調べたらまさに次の記事で解決した。</p><ul><li><a href=https://qiita.com/tenntenn/items/590caa61b9701d2ada23>もっと楽して式の評価器を作る</a></li></ul><p>この記事では <code>go/types</code> パッケージに定数や式の評価を行う機能がその使い方が紹介されている。簡単に使える。ふとサードパーティのパッケージならどうなるんだろう？とインターネットを検索したものの、自分ではみつけられなかった。chatgpt に問い合わせたら次のようなコードを紹介してくれた。そして、たしかにほとんどは正しくて意図したように動いた。次のコードでは http フレームワークの echo の定数を参照している。types.Package を生成するためのモジュールの読み込み方法について標準ライブラリはそのためのユーティリティが用意されているが、サードパーティのパッケージは用意されていなかった。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;go/token&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;go/types&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;golang.org/x/tools/go/packages&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>eval</span>(<span style=color:#a6e22e>expr</span> <span style=color:#66d9ef>string</span>) (<span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>TypeAndValue</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>cfg</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>packages</span>.<span style=color:#a6e22e>Config</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Mode</span>: <span style=color:#a6e22e>packages</span>.<span style=color:#a6e22e>NeedTypes</span> | <span style=color:#a6e22e>packages</span>.<span style=color:#a6e22e>NeedImports</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Fset</span>: <span style=color:#a6e22e>token</span>.<span style=color:#a6e22e>NewFileSet</span>(),
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>pkgs</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>packages</span>.<span style=color:#a6e22e>Load</span>(<span style=color:#a6e22e>cfg</span>, <span style=color:#e6db74>&#34;github.com/labstack/echo/v4&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>TypeAndValue</span>{}, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>pkgs</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>pkgs</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>Types</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>TypeAndValue</span>{}, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to load echo package&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mainPkg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>NewPackage</span>(<span style=color:#e6db74>&#34;main&#34;</span>, <span style=color:#e6db74>&#34;main&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mainPkg</span>.<span style=color:#a6e22e>Scope</span>().<span style=color:#a6e22e>Insert</span>(<span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>NewPkgName</span>(<span style=color:#a6e22e>token</span>.<span style=color:#a6e22e>NoPos</span>, <span style=color:#a6e22e>mainPkg</span>, <span style=color:#e6db74>&#34;echo&#34;</span>, <span style=color:#a6e22e>pkgs</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>Types</span>))
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>Eval</span>(
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>cfg</span>.<span style=color:#a6e22e>Fset</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>mainPkg</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>token</span>.<span style=color:#a6e22e>NoPos</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>expr</span>,
</span></span><span style=display:flex><span>	)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>このコードで expr に次のように echo の定数を指定するとその値を参照できる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>MIMEApplicationJSON</span>
</span></span></code></pre></div><p>動的型付けのノリで関数も実行できたりするのかな？と試してみたら (当たり前だが) できなかった。chatgpt になぜ関数実行できないかを尋ねたら次であるとのこと。静的型付けのコードを実行するには、本来コンパイルしないといけないのだから式の評価よりもずっとやることがある。</p><blockquote><p>packages.Load を使用してサードパーティパッケージをインポートできているにもかかわらず、expr からそのパッケージの関数を呼び出しても結果が取得できない原因は、go/types パッケージがサポートしているのは、型や定数のチェック、構文解析、式の評価であって、関数の実行そのものはサポートされていないためです。</p><p>go/types の Eval 関数はあくまでコンパイル時の型検査や式の評価を行うもので <strong>関数の実行や実行時の評価 (ランタイムの処理)</strong> は行いません。これは、Eval が式を評価して型と値を返すだけであり、動的な関数の実行などはできないためです。</p></blockquote></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0912/>つなぎの雑多な一日</a></h1><div class=post-meta><time class=post-date>2024-09-12 (Thu.) ::</time></div><span class=post-tags>#<a href=/diary/tags/programming/>programming</a>&nbsp;</span><div class=post-content><p>昨日の続きでメンバーのコードレビューをしながら、openldap スキーマの validator のバグ修正をしつつ、チーム勉強会で雑多な仕様や設計の議論をしていたらそれにも時間を取られて、1日としてはまあり開発を進捗させられなかった。コードを書くことに集中できる時間を2-3時間連続で確保できないとモチベーションにも影響が出てくる。それだけ取り組んでいる課題が複雑だったり煩雑だったりしているのもある。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0911/>openldap スキーマの validator と go のマルチエラー制御</a></h1><div class=post-meta><time class=post-date>2024-09-11 (Wed.) ::</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/testing/>testing</a>&nbsp;
#<a href=/diary/tags/ldap/>ldap</a>&nbsp;</span><div class=post-content><p>今日もメンバーのコードレビューに半日以上の時間を割いたので自分の時間をあまり取れなくて開発が進捗しなかった。</p><p>隙間時間で <a href=/diary/posts/2024/0906/>openldap スキーマの情報</a> を使って validator を実装していた。バリデーションのようなものはまとめてエラーを返せるのが望ましい。go でマルチエラーを制御する仕組みが少し前に追加されていたことを思い出した。<a href=https://future-architect.github.io/articles/20230126a/>Go 1.20 Wrapping multiple errors</a> のチュートリアル記事を読みながら openldap スキーマの validator を実装して複数のエラーを返すようにした。まだ抜け・漏れはあるかもしれないけど objectClass の validator は次のようになる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ObjectClassValidator</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>objectClassMap</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>ObjectClassDescription</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>v</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ObjectClassValidator</span>) <span style=color:#a6e22e>Validate</span>(<span style=color:#a6e22e>attr</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>][]<span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>errs</span> []<span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>objClassDescs</span> []<span style=color:#a6e22e>ObjectClassDescription</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>hasStructuralKind</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>allAttrMap</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>struct</span>{}{}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>lowerAttrNameMap</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>struct</span>{}, len(<span style=color:#a6e22e>attr</span>))
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>k</span>, <span style=color:#a6e22e>values</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>attr</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>lowerName</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>ToLower</span>(<span style=color:#a6e22e>ParseAttribute</span>(<span style=color:#a6e22e>k</span>))
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>lowerAttrNameMap</span>[<span style=color:#a6e22e>lowerName</span>] = <span style=color:#66d9ef>struct</span>{}{}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>lowerName</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;objectclass&#34;</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>objClassDescs</span> = make([]<span style=color:#a6e22e>ObjectClassDescription</span>, <span style=color:#ae81ff>0</span>, len(<span style=color:#a6e22e>values</span>))
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>objcName</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>values</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>lowerObjcName</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>ToLower</span>(<span style=color:#a6e22e>objcName</span>)
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>ocd</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>v</span>.<span style=color:#a6e22e>objectClassMap</span>[<span style=color:#a6e22e>lowerObjcName</span>]
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>msg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;&#39;%s&#39; objectClass is not defined&#34;</span>, <span style=color:#a6e22e>objcName</span>)
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>errs</span> = append(<span style=color:#a6e22e>errs</span>, <span style=color:#a6e22e>NewErrorValidation</span>(<span style=color:#a6e22e>msg</span>))
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ocd</span>.<span style=color:#a6e22e>Kind</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ocd</span>.<span style=color:#a6e22e>Kind</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>Structural</span> {
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>hasStructuralKind</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>objClassDescs</span> = append(<span style=color:#a6e22e>objClassDescs</span>, <span style=color:#a6e22e>ocd</span>)
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>mustAttr</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>ocd</span>.<span style=color:#a6e22e>GetMust</span>() {
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>allAttrMap</span>[<span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>ToLower</span>(<span style=color:#a6e22e>mustAttr</span>)] = <span style=color:#66d9ef>struct</span>{}{}
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>mayAttr</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>ocd</span>.<span style=color:#a6e22e>GetMay</span>() {
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>allAttrMap</span>[<span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>ToLower</span>(<span style=color:#a6e22e>mayAttr</span>)] = <span style=color:#66d9ef>struct</span>{}{}
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// require at least 1 structural objectClass
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>hasStructuralKind</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>errs</span> = append(<span style=color:#a6e22e>errs</span>, <span style=color:#a6e22e>NewErrorValidation</span>(<span style=color:#e6db74>&#34;no structural objectClass&#34;</span>))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// must in objectClass requires must attributes
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>ocd</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>objClassDescs</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>mustAttr</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>ocd</span>.<span style=color:#a6e22e>GetMust</span>() {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>lowerAttrNameMap</span>[<span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>ToLower</span>(<span style=color:#a6e22e>mustAttr</span>)]; !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>msg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;&#39;%s&#39; objectClass requires &#39;%s&#39;&#34;</span>, <span style=color:#a6e22e>ocd</span>.<span style=color:#a6e22e>GetName</span>(), <span style=color:#a6e22e>mustAttr</span>)
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>errs</span> = append(<span style=color:#a6e22e>errs</span>, <span style=color:#a6e22e>NewErrorValidation</span>(<span style=color:#a6e22e>msg</span>))
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// all attribute keys are allowed may/must in objectClass
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>attrName</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>lowerAttrNameMap</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>allAttrMap</span>[<span style=color:#a6e22e>attrName</span>]; !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>msg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;&#39;%s&#39; is not allowed by objectClass&#34;</span>, <span style=color:#a6e22e>attrName</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>errs</span> = append(<span style=color:#a6e22e>errs</span>, <span style=color:#a6e22e>NewErrorValidation</span>(<span style=color:#a6e22e>msg</span>))
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>Join</span>(<span style=color:#a6e22e>errs</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewObjectClassValidator</span>(
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>objectClasses</span> []<span style=color:#a6e22e>ObjectClassDescription</span>,
</span></span><span style=display:flex><span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>ObjectClassValidator</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ocm</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>ObjectClassDescription</span>, len(<span style=color:#a6e22e>objectClasses</span>))
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>v</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>objectClasses</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>n</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>v</span>.<span style=color:#a6e22e>Name</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>ocm</span>[<span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>ToLower</span>(<span style=color:#a6e22e>n</span>)] = <span style=color:#a6e22e>v</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>ObjectClassValidator</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>objectClassMap</span>: <span style=color:#a6e22e>ocm</span>,
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>次のように複数のエラーを返すテストケースを定義する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>name</span>:       <span style=color:#e6db74>&#34;multiple errors&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>objClasses</span>: <span style=color:#a6e22e>objectClasses1</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>attr</span>: <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>][]<span style=color:#66d9ef>string</span>{
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;objectClass&#34;</span>:           []<span style=color:#66d9ef>string</span>{<span style=color:#e6db74>&#34;top&#34;</span>, <span style=color:#e6db74>&#34;posixAccount&#34;</span>, <span style=color:#e6db74>&#34;myObjeClass&#34;</span>},
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;uid&#34;</span>:                   <span style=color:#66d9ef>nil</span>,
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;mail&#34;</span>:                  <span style=color:#66d9ef>nil</span>,
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;mail;lang-ja;phonetic&#34;</span>: <span style=color:#66d9ef>nil</span>,
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;employeeType;lang-ja&#34;</span>:  <span style=color:#66d9ef>nil</span>,
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;homeDirectory&#34;</span>:         <span style=color:#66d9ef>nil</span>,
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;GIDNumber&#34;</span>:             <span style=color:#66d9ef>nil</span>,
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;street&#34;</span>:                <span style=color:#66d9ef>nil</span>,
</span></span><span style=display:flex><span>	},
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>expected</span>: []<span style=color:#66d9ef>error</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>openldap</span>.<span style=color:#a6e22e>NewErrorValidation</span>(<span style=color:#e6db74>&#34;&#39;employeetype&#39; is not allowed by objectClass&#34;</span>),
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>openldap</span>.<span style=color:#a6e22e>NewErrorValidation</span>(<span style=color:#e6db74>&#34;&#39;mail&#39; is not allowed by objectClass&#34;</span>),
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>openldap</span>.<span style=color:#a6e22e>NewErrorValidation</span>(<span style=color:#e6db74>&#34;&#39;myObjeClass&#39; objectClass is not defined&#34;</span>),
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>openldap</span>.<span style=color:#a6e22e>NewErrorValidation</span>(<span style=color:#e6db74>&#34;&#39;posixAccount&#39; objectClass requires &#39;cn&#39;&#34;</span>),
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>openldap</span>.<span style=color:#a6e22e>NewErrorValidation</span>(<span style=color:#e6db74>&#34;&#39;posixAccount&#39; objectClass requires &#39;uidNumber&#39;&#34;</span>),
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>openldap</span>.<span style=color:#a6e22e>NewErrorValidation</span>(<span style=color:#e6db74>&#34;&#39;street&#39; is not allowed by objectClass&#34;</span>),
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>openldap</span>.<span style=color:#a6e22e>NewErrorValidation</span>(<span style=color:#e6db74>&#34;no structural objectClass&#34;</span>),
</span></span><span style=display:flex><span>	},
</span></span><span style=display:flex><span>},
</span></span></code></pre></div><p>テストコードで次のように返ってくる error を unwrap することで検証できる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>tt</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>tests</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>tt</span>.<span style=color:#a6e22e>name</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Parallel</span>()
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>validator</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>openldap</span>.<span style=color:#a6e22e>NewObjectClassValidator</span>(<span style=color:#a6e22e>tt</span>.<span style=color:#a6e22e>objClasses</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>validator</span>.<span style=color:#a6e22e>Validate</span>(<span style=color:#a6e22e>tt</span>.<span style=color:#a6e22e>attr</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>actual</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>err</span>.(<span style=color:#66d9ef>interface</span>{ <span style=color:#a6e22e>Unwrap</span>() []<span style=color:#66d9ef>error</span> }); <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Log</span>(<span style=color:#e6db74>&#34;\n&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>diff</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>cmp</span>.<span style=color:#a6e22e>Diff</span>(<span style=color:#a6e22e>tt</span>.<span style=color:#a6e22e>expected</span>, <span style=color:#a6e22e>actual</span>.<span style=color:#a6e22e>Unwrap</span>(), <span style=color:#a6e22e>opts</span><span style=color:#f92672>...</span>); <span style=color:#a6e22e>diff</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>diff</span>)
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0910/>結果に対する潔さ</a></h1><div class=post-meta><time class=post-date>2024-09-10 (Tue.) ::</time></div><span class=post-tags>#<a href=/diary/tags/politics/>politics</a>&nbsp;
#<a href=/diary/tags/failure/>failure</a>&nbsp;</span><div class=post-content><p>今日はマイルストーンの最終日で定例会議での確認事項が長引いたり、メンバーとのやり取りをしていたらあまり自分の時間を取れなかった。たまにはそういう日もあるか。</p><p>はてブですら兵庫県知事のパワハラ問題の記事がホットエントリーになる。自分の住んでいる自治体なのでちょくちょく読んでいる。先週に県議会の百条委員会の動画がアップされていた。すべてみたわけではないが、答弁のやり取りを少しみた。</p><ul><li>動画: <a href="https://www.youtube.com/watch?v=JoSnKfPZGAc">【兵庫県議会】令和6年9月6日午後　文書問題調査特別委員会（百条委員会）</a></li><li>記事: <a href=https://www3.nhk.or.jp/news/html/20240906/k10014573141000.html>【詳細】兵庫県知事 百条委で2回目の証人尋問「徹底調査指示」</a></li></ul><p>知事は元官僚なので自身の責任を問われないよう、答弁はうまいように聞こえる。基本的に自身の過失を認めず、微妙な問題の判断は議会に委ね、自身の対応に問題はなかったという姿勢を貫いていたと思う。自身の保身を図るという側面ではこういった姿勢は適切だろうし、知事の優秀さも伺えるし、知事の視点からは理解できる。一方で政治家として結果責任をとるという視点では、自殺者が2人も出ていて、百条委員会が開かれる状況になっていることを自身の責任だと受け入れる必要はあると思う。</p><p>たまたま今日もはてブでホットエントリーになっていて議会で不信任案に全会一致という状況になっていて悲惨にみえる。</p><blockquote><p>兵庫県議会の議員86人全員が斎藤知事に「辞職」を求めるという異例の事態となっています。</p><p><a href=https://news.yahoo.co.jp/articles/f9814bcb493ad4aca6ebc5315774a135e3066d36>斎藤知事に兵庫県議全員86人が「辞職要求」へ　全会派に無所属4人も　知事は改めて辞職否定「来年度予算の議論含めてしっかりやっていきたい」</a></p></blockquote><p>現時点で知事は辞職しないという姿勢をとっている。過去の事例を調べてみると、都道府県議会で不信任案が可決されたのは過去に4回しかなくて、さらに知事が辞職しなかった事例は1度もないという。その文脈を踏まえると、どこかで政治的な妥協案が取られて知事は辞職するのかもしれない。</p><blockquote><p>都道府県議会で実際に可決されたのは岐阜（昭和51年）、長野（平成14年）、徳島（15年）、宮崎（18年）の4回。いずれも知事が辞職か失職を選び、議会が解散されたことはない。</p><p><a href=https://www.sankei.com/article/20240906-ZWZXSMLYMFMBNGBEFGTYU6DAHY/>知事の不信任案可決、過去には「脱ダム」田中氏ら4例のみ　議会側の最終手段も高いハードル</a></p></blockquote><p>私は人を評価する視点の1つに「潔さ」をみている。かっこいい人は潔い。とくに失敗したときに潔いかどうかをみている。うまくいかなかったときにどのような行動を取れるか。百条委員会の答弁は知事の視点から自己弁護すること自体はわるくないと思う。しかし、実態はどうあれ、議会の議員全員が不信任案に賛成するという状況において辞職を決断できないのは潔くないという点のみで、私は知事を支持できない理由になっている。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0909/>コンテナー間のデータ通信はやはり http プロトコル</a></h1><div class=post-meta><time class=post-date>2024-09-09 (Mon.) ::</time></div><span class=post-tags>#<a href=/diary/tags/container/>container</a>&nbsp;
#<a href=/diary/tags/linux/>linux</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;</span><div class=post-content><p>過去に <a href=/diary/posts/2023/0829/>コンテナー間のデータ通信に named pipe を使って実装</a> した。機能的には問題なく運用できていたが、環境構築時に named pipe の設定がわかりにくいという課題があった。また docker compose は volumes に設定したパスが存在しないときに歴史的経緯でディレクトリを作成してしまう。初期設定時に named pipe を期待するリソースがディレクトリになってしまっているところの、エラー制御のわかりにくさもあった。またこの運用はオンプレミスの環境でしか利用できず、将来的にクラウド対応 (k8s) で運用することを考慮すると、http 通信できる方がよいと考えを改め、データ通信の仕組みを再実装した。http サーバーと比べて named pipe の方が優れているのはセキュリティとして物理的にその OS 上からしかアクセスできないところ。</p><p>go でフレームワークを使わず、シンプルな http サーバーを実装してみた。セキュリティの制約さえなければ、このぐらいの手間を惜しんで named pipe を実装することもなかったかと、いまとなっての学びとなった。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>newMux</span>(<span style=color:#a6e22e>cfg</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>MyConfig</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ServeMux</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mux</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>NewServeMux</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mux</span>.<span style=color:#a6e22e>HandleFunc</span>(<span style=color:#e6db74>&#34;/version&#34;</span>, <span style=color:#a6e22e>handler</span>.<span style=color:#a6e22e>HandleVersion</span>(<span style=color:#a6e22e>cfg</span>))
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>mux</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>stop</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>signal</span>.<span style=color:#a6e22e>NotifyContext</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(),
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>syscall</span>.<span style=color:#a6e22e>SIGINT</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>syscall</span>.<span style=color:#a6e22e>SIGTERM</span>,
</span></span><span style=display:flex><span>	)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>stop</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>cfg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>MyConfig</span>{}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>server</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Server</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Addr</span>:    <span style=color:#e6db74>&#34;:7099&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Handler</span>: <span style=color:#a6e22e>newMux</span>(<span style=color:#a6e22e>cfg</span>),
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>server</span>.<span style=color:#a6e22e>ListenAndServe</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ErrServerClosed</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>slog</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#e6db74>&#34;got an error providing http service&#34;</span>, <span style=color:#e6db74>&#34;err&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>slog</span>.<span style=color:#a6e22e>Info</span>(<span style=color:#e6db74>&#34;stopped http server normally&#34;</span>)
</span></span><span style=display:flex><span>	}()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Done</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>slog</span>.<span style=color:#a6e22e>Info</span>(<span style=color:#e6db74>&#34;caught the stop signal&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctxTimeout</span>, <span style=color:#a6e22e>cancel</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>WithTimeout</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#ae81ff>10</span><span style=color:#f92672>*</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>cancel</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>server</span>.<span style=color:#a6e22e>Shutdown</span>(<span style=color:#a6e22e>ctxTimeout</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>slog</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#e6db74>&#34;failed to shutdown normally&#34;</span>, <span style=color:#e6db74>&#34;err&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>slog</span>.<span style=color:#a6e22e>Info</span>(<span style=color:#e6db74>&#34;done graceful shutdown&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0908/>キャリア談義</a></h1><div class=post-meta><time class=post-date>2024-09-08 (Sun.) ::</time></div><span class=post-tags>#<a href=/diary/tags/career/>career</a>&nbsp;
#<a href=/diary/tags/drinking/>drinking</a>&nbsp;
#<a href=/diary/tags/founding/>founding</a>&nbsp;</span><div class=post-content><p>たまたまだけど、お昼にキャリアセミナーの動画をみて、夜にキャリア相談にのった一日だった。</p><h2 id=キャリアセミナーと転職>キャリアセミナーと転職</h2><p><a href=/diary/posts/2024/0310/#あんちぽサロン>あんちぽサロン</a> に参加されているメンバーがキャリアセミナーで話されている動画を紹介されていたのでみた。その方も5回転職していて、私と似たようなキャリア形成をされてきたようにみえた。そのせいもあって価値観も共感できるところが多かった。私もそうだが、一定回数以上の転職をする人は自身の好きなことに価値を見出す人が多いのかな？とその動画をみていて思った。転職について私自身の考えを考察してみる。</p><p>私の考える転職で得られるメリットは次になる。</p><ul><li>どんな組織にも良いところと悪いところがあるとわかる</li><li>多様な人間関係や価値観に触れるきっかけになる</li><li>新しい知識やスキルを身につけるきっかけになる</li><li>コンフォートゾーンを抜け出すことで変化に対応するスキルが身につく</li><li>年収をあげやすい</li></ul><p>一方でデメリットもある。</p><ul><li>10年とか時間のかかる知識やスキルを身につけられない</li><li>1度転職すると、その後も転職を繰り返しがちになる</li><li>転職後の変化に対応するストレスが大きい</li><li>転職が嫌なことからの逃げ道になってしまう</li><li>一定数を超えると長期のキャリア形成を望む組織に信頼されない</li></ul><p>いまの時代、転職におけるもっとも大きなメリットは変化に対応するスキルが身につくことだと個人的には思う。誰もが慣れた環境や人間関係、同じ業態・業種のお仕事をずっと続けていると、それが当たり前になってずっと続くような錯覚をしてしまう。そして、実際には3年、5年、10年と世の中は変わっていって普段しているお仕事がなくなっていく。個人と比べて組織はずっと変化に疎い。同じ組織にいると世の中の変化に鈍感になる傾向はあると思う。しかし、転職はリスクのある判断で一概に奨められるものでもない。とくに年齢が高くなると自身が求める待遇と先方から求められるスキルセットのマッチングが難しくなっていく。そしてマッチングで失敗するとキャリアにおけるダメージも大きい。私は20代の頃から転職してきたからリスクも折り込み済みで働いてきたが、過去を振り返るとよかった転職とわるかった転職は五分五分だと思う。そして40代になって転職先がなくなって自分で会社を経営するしかなくなった。その選択に後悔はないが、あまり他人へ奨められるようなキャリアではない。キャリアや働き方を大きく左右する転機の1つとして、若いときに転職するかどうかがあるように思う。</p><h2 id=キャリア相談>キャリア相談</h2><p>夜にコミュニティの仲のよいメンバーと飲みに行った。急に誘いがきたからなんとなくそういう系の話しかな？という予測はついていた。そのメンバーはスタートアップで働いていて、あまりうまくいっていないという話しを以前から聞いていた。どうやら創業者が体調不良で会社を清算するらしい。事業を他社に売却するものの、従業員はどうなるか分からないらしい。黒字化していない事業だからあまりよい値段がつくとも思えないことから従業員までは雇わないのではないかと推測する。予定通り事務手続きが進めば今月末に会社がなくなるらしい。</p><p>そこで個人事業主でやっていくか、転職するかの相談にのっていた。まだ30代の若い方なのでどうしてもやりたいことがあるなら自分でやるのも1つの手だけど、個人事業主はいつでもなれるから転職して経験を積んだ方がよいとお勧めした。<a href=https://logmi.jp/business/articles/326605>一番起業の成功率の高い年齢は、40代半ば</a> にもあるように、起業して成功する確率が高いのは統計的に40代になる。当たり前の話しだけど、経験のある方がうまく経営したり失敗を避ける上での知恵が働くのだと推測する。うちの会社が受託開発できるのも世の中にシニアエンジニアは少なく、30代で身につけたスキルの貯金で食いつないでいるといえる。</p><p>あと貯金が減っていくのは精神的によくないという実体験を話した。起業するなら3年ぐらいは収入がなくても生活できる貯金を用意した方がよいとアドバイスした。生活費がなくなると目先のことしか考えられなくなって判断を誤るというのは「貧すれば鈍する」と昔からの格言にある。脱サラした経営者がキャッシュフローをみてないといった失敗談もたまにみかけるが、想定外のことが起こっても資金繰りに困らないだけの十分な余力として3年ぐらいの生活費をみた方がよいと考えている。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0907/>集中力の正体</a></h1><div class=post-meta><time class=post-date>2024-09-07 (Sat.) ::</time></div><span class=post-tags>#<a href=/diary/tags/audio-media/>audio media</a>&nbsp;
#<a href=/diary/tags/exercise/>exercise</a>&nbsp;
#<a href=/diary/tags/health/>health</a>&nbsp;
#<a href=/diary/tags/programming/>programming</a>&nbsp;
#<a href=/diary/tags/motivation/>motivation</a>&nbsp;
#<a href=/diary/tags/psychology/>psychology</a>&nbsp;</span><div class=post-content><p>昨日は20時半頃にお仕事を終えて帰った。スーパーで買いものして、家に帰って晩ご飯を作って食べて、休んだらオフィスへ戻るつもりがそのまま寝てしまった。</p><h2 id=メッセージ作成>メッセージ作成</h2><p>年一ゲストとして出演している <a href=https://podcast.terapyon.net/>terapyon channel</a> の <a href=https://terapyon.connpass.com/event/326314/>100回記念公開収録</a> があった。いつもお世話になっているので私は参加できないがカンパ枠で応援していた。昨日てらださんから音声メッセージを作ってほしいと依頼され、本当は昨日の夜に作ろうと思っていたものの、疲れて寝てしまったので朝起きてから慌ててオフィスへ行って作成した。ubuntu の apt でインストールできるツールとして <a href=https://www.audacityteam.org/>audacity</a> を使って録音した。簡単に使えた。お祝いのメッセージを文章に書き出して、マイクテストも含めて最終的には7回撮り直した。文章を書いてから、話してみると、流れが悪かったり、語呂が悪かったり、途中で詰まったり、かんでしまったりと、なにか気になるところをみつけて、文章を推敲して録音しながら1時間ほどやってた。録音して聞き直すと、いかに自分の話し方が下手であるかがよくわかる。話し方を練習しないとうまくならないのだろうな。</p><h2 id=みなとのもりの運動>みなとのもりの運動</h2><p><a href=/diary/posts/2024/0724/#みなとのもりの運動>前回の所感</a> 。14時頃に作業を終えてストレッチまで1時間ほど時間が空いた。ふと運動してからストレッチへ行くとよさそうだと思い立ってジョギングと縄跳びをしてきた。前回が7月24日なので1ヶ月半ほど運動していなかった。1kmほどジョギングしてから縄跳びを15分間した。以前と比較したら軽めに流したにも関わらず、久しぶりに運動したら体力が落ちていてかなりバテた。習慣的に運動していないとすぐに衰える。久しぶりに運動できたので、また再開するきっかけになるかもしれない。</p><h2 id=ストレッチ>ストレッチ</h2><p>今日の開脚幅も開始前148cmで、ストレッチ後152cmとあまり数値は出なかった。直前に運動して行ったのでよく伸びるかな？と予測したものの、測ってみるとそうでもなかった。それでも運動した後にストレッチを受けるのはカラダによさそうにも思える。ここ1ヶ月半ほど運動できていないものの、体重は67kg台を維持していて体脂肪率や筋肉量はあまり変わっていない。トレーナーさんとそういう話をしていたら、筋肉は落ちにくくつきにくいから1ヶ月ではそんなもんとのこと。</p><h2 id=プログラミングの集中力と生産性への考察>プログラミングの集中力と生産性への考察</h2><p>ストレッチを受けているときにトレーナーさんと話していて思うことがあったのでまとめておく。いまの開発フェーズは開発者としてプロジェクトに参加している。平均すると1日10時間ぐらいお仕事していて、早く帰る日もあるから遅い日は日付が変わるぐらいまではコードを書いていることがある。家に帰ると休んでしまうからオフィスで晩ご飯を食べることも多い。なぜプログラミングに集中していると運動ができないのか？を考察してみた。</p><ul><li>他の余分なことを排除すると集中力が増す</li></ul><p>いまやっている開発のお仕事は1日で完了するような簡単な開発ではない。1年半開発しているので残っている課題は厄介で複雑な問題への対応であることが多い。新規機能を追加するときも既存機能や仕様や依存関係を考慮しないといけない。そうすると2-3日かけて課題を解決することが多い。そのときに他の余分なことを排除した方が脳のリソースを課題解決に割り当てられる。通勤しているときも、寝ているときも、ご飯を食べているときも取り組んでいる課題のことを四六時中考えている。他のことに脳のリソースを割くと課題解決の品質が下がる可能性が高い。ずっと考え続けることが複雑な問題の課題解決に重要となる。</p><ul><li>システム開発とはタイムアタック競技である</li></ul><p>システム開発のプロジェクトマネジメントにおいてもっとも重要な概念はタイムボックスだと私は考えている。適度な期間 (うちは2週間) を設け、モノゴトに取り組む最初と最後を作ること。認知心理学の研究からも記憶の仕組みからも期間の最初と最後がもっとも学習効果が高いことを示唆している。このことは私の経験則においてもシステム開発で当てはまる。作業期間が適切でないと人間はだらだらしてしまう (<a href=https://ja.wikipedia.org/wiki/%E3%83%91%E3%83%BC%E3%82%AD%E3%83%B3%E3%82%BD%E3%83%B3%E3%81%AE%E6%B3%95%E5%89%87>パーキンソンの法則</a>) 。プログラミングにおいて動くのは当たり前で、動いた上でいかに品質をあげられるかが腕の見せ所になる。エラー処理を適切に制御できているか、他人がコードを読んでも理解しやすく保守しやすいか、将来の拡張性を考慮して設計されているか、など品質をよくするための取り組みには答えがない。仕事ができる・できないを分ける行動の1つとして、答えのない問いにどれだけ準備できるか、考え続けられるかと言い換えられるかもしれない。答えがないからいくらでも品質をあげるための施策がある。しかし、現実の業務には期限があるため、期限内に最善の品質を目指すことになる。そのため、タイムボックスでシステム開発をマネジメントする限り、いつもタイムアタック競技をしているのと同義になるから時間が足りない。</p><p>プログラミングはいつも妥協を強いられる。完璧で最高のシステムなどありえない。その時々で開発途中における最善の動くものをスナップショットとしてバージョン管理しているに過ぎない。この妥協するレベルが私にとってはマネージャーと開発者という役割で大きく異なるのだろうと思う。マネージャーとしての遊撃なら先送りできても、開発者としては多少の負荷があっても解決してしまう。自身の基準を満たす働き方に違いがあるのではないかと思う。言語化してみると、この考え方はプログラミングに限らず、そのときに取り組む対象によって何にでも応用できそうに思う。</p></div></article><div class=pagination><div class=pagination__buttons><a href=/diary/posts/page/6/ class="button previous"><span class=button__icon>←</span>
<span class=button__text>最近の日記</span>
</a><a href=/diary/posts/page/8/ class="button next"><span class=button__text>過去の日記</span>
<span class=button__icon>→</span></a></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2024 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>