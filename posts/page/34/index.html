<!doctype html><html lang=en><head><title>Posts :: </title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/posts/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="Posts"><meta property="og:description" content><meta property="og:url" content="/diary/posts/"><meta property="og:site_name" content><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/posts/index.xml rel=alternate type=application/rss+xml title></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><div class=posts><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0621/>厄介なインフラ問題をやっつけた</a></h1><div class=post-meta><time class=post-date>2023-06-21 (Wed.) ::</time></div><span class=post-tags>#<a href=/diary/tags/infrastructure/>infrastructure</a>&nbsp;
#<a href=/diary/tags/operation/>operation</a>&nbsp;
#<a href=/diary/tags/podman/>podman</a>&nbsp;
#<a href=/diary/tags/event/>event</a>&nbsp;</span><div class=post-content><p>2時に寝て6時に起きて7時に起きた。夜に作業していたら遅くなった。</p><h2 id=厄介なインフラの問題-解決編>厄介なインフラの問題 解決編</h2><p><a href=/diary/posts/2023/0619/#運用のトラブルシューティング>運用のトラブルシューティング</a> の続き。アプリケーションアカウントを作って compose 環境を構築したら nginx のコンテナが起動して即時終了する状態になったという。これまで起きていた現象とまた違う問題が発生してさらに混迷をもたらすかに思えたが、私の中では nginx のコンテナでなにかがおかしいと問題の発生箇所を局所化できたのでそこからの調査はそんなに時間を必要としなかった。</p><p>結論からいうと podman の <a href=https://github.com/containers/aardvark-dns>aardvark-dns</a> の不具合だった。なんらかのトリガーでコンテナネットワーク内の名前解決が不整合な状態に陥る。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>vagrant@bookworm:$ podman-compose exec proxy /bin/bash
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>root@3742c45c7c60:/# dig app
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>; &lt;&lt;&gt;&gt; DiG 9.16.37-Debian &lt;&lt;&gt;&gt; app
</span></span><span style=display:flex><span>;; global options: +cmd
</span></span><span style=display:flex><span>;; Got answer:
</span></span><span style=display:flex><span>;; -&gt;&gt;HEADER<span style=color:#e6db74>&lt;&lt;- opco</span>de: QUERY, status: NOERROR, id: <span style=color:#ae81ff>56696</span>
</span></span><span style=display:flex><span>;; flags: qr rd ra ad; QUERY: 1, ANSWER: 8, AUTHORITY: 0, ADDITIONAL: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; OPT PSEUDOSECTION:
</span></span><span style=display:flex><span>; EDNS: version: 0, flags:; udp: <span style=color:#ae81ff>4096</span>
</span></span><span style=display:flex><span>; COOKIE: 37ff0fd63315d70e <span style=color:#f92672>(</span>echoed<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>;; QUESTION SECTION:
</span></span><span style=display:flex><span>;app.				IN	A
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; ANSWER SECTION:
</span></span><span style=display:flex><span>app.			86400	IN	A	10.89.0.36
</span></span><span style=display:flex><span>app.			86400	IN	A	10.89.0.36
</span></span><span style=display:flex><span>app.			86400	IN	A	10.89.0.136
</span></span><span style=display:flex><span>app.			86400	IN	A	10.89.0.136
</span></span><span style=display:flex><span>app.			86400	IN	A	10.89.0.146
</span></span><span style=display:flex><span>app.			86400	IN	A	10.89.0.146
</span></span><span style=display:flex><span>app.			86400	IN	A	10.89.0.156
</span></span><span style=display:flex><span>app.			86400	IN	A	10.89.0.156
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; Query time: <span style=color:#ae81ff>4</span> msec
</span></span><span style=display:flex><span>;; SERVER: 10.89.0.1#53<span style=color:#f92672>(</span>10.89.0.1<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>;; WHEN: Thu Jun <span style=color:#ae81ff>22</span> 02:45:26 UTC <span style=color:#ae81ff>2023</span>
</span></span><span style=display:flex><span>;; MSG SIZE  rcvd: <span style=color:#ae81ff>172</span>
</span></span></code></pre></div><p>podman 4.0 から aardvark-dns がコンテナネットワーク内での dns を提供する。nginx が app を名前解決したときに起動しているコンテナの ip アドレスではなく、削除された過去のコンテナの ip アドレスが返される状況が発生する。app という名前に対して複数の ip アドレスが返る。</p><p>このとき nginx は複数の ip アドレスのうちの1つに接続しようとするが、正しい ip アドレスでない場合、リクエストがタイムアウトする。タイムアウトした後に fallback で他の ip アドレスに接続しにいく。このときに正しい ip アドレスがみつかればクライアントにレスポンスが返る。この fallback のリトライの回数分だけリクエストのレイテンシの時間がかかっていた。</p><pre tabindex=0><code>vagrant@bookworm:$ podman logs -f proxy
...
2023/06/22 02:46:26 [error] 15#15: *41 connect() failed (113: No route to host) while connecting to upstream, client: 10.89.0.38, server: ucidmsv1-app, request: &#34;GET / HTTP/1.1&#34;, upstream: &#34;http://10.89.0.136:3000/&#34;, host: &#34;localhost:4430&#34;
2023/06/22 02:46:29 [error] 15#15: *41 connect() failed (113: No route to host) while connecting to upstream, client: 10.89.0.38, server: ucidmsv1-app, request: &#34;GET / HTTP/1.1&#34;, upstream: &#34;http://10.89.0.156:3000/&#34;, host: &#34;localhost:4430&#34;
2023/06/22 02:46:32 [error] 15#15: *41 connect() failed (113: No route to host) while connecting to upstream, client: 10.89.0.38, server: ucidmsv1-app, request: &#34;GET / HTTP/1.1&#34;, upstream: &#34;http://10.89.0.136:3000/&#34;, host: &#34;localhost:4430&#34;
10.89.0.38 - - [22/Jun/2023:02:46:32 +0000] &#34;GET / HTTP/1.1&#34; 200 2864 &#34;-&#34; &#34;curl/7.88.1&#34;
</code></pre><p>ワークアラウンドとして、次のファイルに複数の app の ip アドレスが登録されていれば不整合な状態なのでネットワークを削除して、このファイルも手動で削除してしまえばよい。</p><pre tabindex=0><code>$ cat /run/user/$(id -u)/containers/networks/aardvark-dns/mynetwork
</code></pre><p>ファイルを監視していると、どうやら mynetwork ファイルから名前と ip アドレスの情報が削除されるのは該当のコンテナが削除されるタイミングになる。なんらかのエラーにより、コンテナ削除時にマッピングの削除が実行されないと、古いコンテナのマッピング設定が残ったままとなり、compose サービスを起動したときに複数の ip アドレスの名前解決できる状態になってしまう。ちょっと調べても aardvark-dns に関する issue はたくさん登録されている。</p><ul><li><a href=https://github.com/containers/podman/issues/18783>https://github.com/containers/podman/issues/18783</a></li><li><a href=https://github.com/containers/podman/issues/18530>https://github.com/containers/podman/issues/18530</a></li><li><a href=https://github.com/containers/podman/issues/17370>https://github.com/containers/podman/issues/17370</a></li></ul><h2 id=コワーキングのオンラインイベント>コワーキングのオンラインイベント</h2><p>月例のカフーツさんのオンラインイベントに参加した。<a href=/diary/posts/2023/0517/#コワーキングのオンラインイベント>先月の所感はここ</a> 。今日はもともと予定していた話しをする参加者が急遽参加できなくなってしまったので他の参加者での雑談会になった。</p><p>いとうさん曰く、これまで外国人のデジタルノマドは自分で業務時間を選べるフリーランスの、さらにお金に余裕をもった人たちが多いと考えられていた。しかし、実際にコワーキングスペースに来られている外国人にキャリアを伺うと、大企業の普通の社員であることがわかってきた。グローバルな会社だと、働く場所に制限のない会社もあって、ただ日本へ行ってみたかった的な理由で日本へ来られて数ヶ月滞在して普通に会社のお仕事をするといったデジタルノマドもいるという。過去に私が働いていた職場の同僚も、コロナのときに会社がフルリモートワークの体制を設けて、airbnb で全国を旅しながら1年ほど働いていた。日本でもそういう社員はいるのだから外国人はなおさらという感じ。</p><p>そういった外国人のデジタルノマドが要求することが3つある。</p><ul><li>24時間利用できること (勤め先の会社と時差があるから)</li><li>セカンドモニターがあること</li><li>・・・ (あともう1つあったが、忘れてしまった)</li></ul><p>コワーキングスペースに外国人のデジタルノマドを呼び込むにはどうすればよいか。実際にコワーキングスペースへ来られた外国人に理由を伺うと英語のホームページをみて来ましたということらしい。至極、当たり前の話し。英語のホームページをちゃんと作ろうねみたいな話題で話していた。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0620/>go の channel 制御の学び</a></h1><div class=post-meta><time class=post-date>2023-06-20 (Tue.) ::</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;
#<a href=/diary/tags/refactoring/>refactoring</a>&nbsp;
#<a href=/diary/tags/rabbitmq/>rabbitmq</a>&nbsp;</span><div class=post-content><p>0時に寝て2時に起きて5時に起きて6時に起きた。久しぶりに夢をみたような気がする。</p><h2 id=go-の-channel-とクローズ制御>go の channel とクローズ制御</h2><p><a href=https://github.com/rabbitmq/amqp091-go>rabbitmq/amqp091-go</a> を使った pubsub の consumer の実装で次のような for ループでメッセージを取得していた。この場合 <code>deliveries</code> の channel が閉じられると内側の for ループが終了して、外側の for ループの接続処理へ遷移する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// コネクションの接続処理
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>d</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>deliveries</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// メッセージ処理
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>この処理を context を使ってキャンセルできるよう、次に書き換えた。channel の <a href=https://go.dev/ref/spec#Receive_operator>Receive operator</a> のドキュメントによると、channel は2値を返すことができて、戻り値の2番目の <code>ok</code> の値を調べることでその channel がクローズされているかどうかを判定できる。この仕組みを知っていれば select で ok を調べてエラー処理を実装できる。そうしないと <code>deliveries</code> の channel が閉じられれたときに select では常にゼロ値のメッセージが返るようになって意図したメッセージ処理とならない。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// コネクションの接続処理
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Done</span>():
</span></span><span style=display:flex><span>            <span style=color:#75715e>// context がキャンセルされたら終了処理
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>ch</span>.<span style=color:#a6e22e>Cancel</span>(<span style=color:#a6e22e>cid</span>, <span style=color:#66d9ef>false</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to cancel channel: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>d</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>deliveries</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// メッセージ処理
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// エラー処理
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// コネクションが閉じていればループを抜けて再接続
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>IsClosed</span>() <span style=color:#f92672>||</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>ch</span>.<span style=color:#a6e22e>IsClosed</span>() {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Info</span>(<span style=color:#e6db74>&#34;the session was closed, try to reconnect&#34;</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>同じ channel からメッセージを取り出すループ処理でも用途によって使い分けがあるなぁと今更ながら学んだ。というか、自分でバグを埋め込んで自分で直した (´・ω・｀)</p><h2 id=マージまで約1ヶ月>マージまで約1ヶ月</h2><p>先日送った <a href=/diary/posts/2023/0515/#amqp091-go-の-context-制御>amqp091-go の pr</a> が最終的にはほぼそのままマージされた。約1ヶ月ぐらいの議論やレビューがあって取り込まれた。新しいリリースバージョン (次は 1.9.0?) が出たらうちのアプリケーションでもこの新しいメソッドを使うようにして実績を積ませる。この pr は「あったら便利」程度の機能なのでそれほど重要ではない。</p><ul><li><a href=https://github.com/rabbitmq/amqp091-go/pull/192>Add Channel.ConsumeWithContext to be able to cancel delivering #192</a></li></ul><p>この成功体験をもって次は本命の <a href=/diary/posts/2023/0605/#レビュー対応>go-ldap の pr</a> のマージに向けて勢いをつける。こっちの pr は業務に直結しているので本気でやり取りしている。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0619/>運用トラブルの調査</a></h1><div class=post-meta><time class=post-date>2023-06-19 (Mon.) ::</time></div><span class=post-tags>#<a href=/diary/tags/infrastructure/>infrastructure</a>&nbsp;
#<a href=/diary/tags/operation/>operation</a>&nbsp;
#<a href=/diary/tags/web-design/>web design</a>&nbsp;</span><div class=post-content><p>0時に寝て5時に起きて7時に起きた。もう暑くて家でもエアコンを解禁した。エアコンがあると寝心地が違う、快適。</p><h2 id=運用のトラブルシューティング>運用のトラブルシューティング</h2><p><a href=/diary/posts/2023/0613/#厄介なインフラの問題-x-2>厄介なインフラの問題</a> のクリティカルな方から着手し始めた。<a href=https://github.com/containers/podman-compose>podman-compose</a> を使って rootless な環境構築をやってみたところ、nginx を tls 終端としてリバースプロキシとするアプリケーションサーバーとの通信が数回に1回ぐらいの頻度で遅くなる。通常は 100msec 程度でレスポンスが返るのが数秒から数十秒かかる。</p><p>もともと podman-compose はサポート対象外なのでそんながんばる必要はない。しかし、これも調査の過程でコンテナの技術を学ぶ1つだと考え再現環境を構築しようとした。vagrant の debian 12 と podman-compose をインストールして同様に環境構築してみたが、仮想環境では再現しない。どうやら環境要因のようだ。そこで問題が発生しているマシンで私のアカウントで環境構築してみたが、やはり再現しない。なんと個人アカウントの違いによって起きる現象のようだ。また質が悪いのは私のアカウントでは再現しないが、メンバー2人のアカウントでは再現している。一般ユーザーから他人のユーザーのプロセスやコンテナの情報にアクセスできるわけがないので調査ができない。個人アカウントで compose 環境を構築するのは諦めてアプリケーションアカウントを作ってやりましょうという話しにした。アプリケーションアカウントで再現すれば調査するし、再現しなければこんな環境要因のトラブルシューティングの優先度を下げてもいいかなぁとも考えている。どうなるかなぁ。</p><h2 id=サイトデザインのサンプルページ>サイトデザインのサンプルページ</h2><p><a href=/diary/posts/2023/0522/#サイトデザイン打ち合わせ>サイトデザイン打ち合わせ</a> の続き。実際のサンプルが出てきたのでデザインの雰囲気やコードも含めて確認していく。ざっとサンプルページを確認した。デザインはとても気に入っている。あとは私が hugo のテーマとしてテンプレートの組み込めるかどうか次第。今週末には実家帰らないといけないし、毎日やることがいっぱいいっぱい。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0618/>クラウド経由で tapo を制御する方法がわからない</a></h1><div class=post-meta><time class=post-date>2023-06-18 (Sun.) ::</time></div><span class=post-tags>#<a href=/diary/tags/smartplug/>smartplug</a>&nbsp;
#<a href=/diary/tags/device/>device</a>&nbsp;</span><div class=post-content><p>0時に寝て7時に起きて8時過ぎまでだらだらしてた。オフィスのエアコンの効き具合がよくなくて昼間暑くてやる気にならなかった。</p><h2 id=tp-link-cloud-api-で-tapo-の制御を調べる>tp-link cloud api で tapo の制御を調べる</h2><p>先日 <a href=/diary/posts/2023/0612/>ifttt で tapo p105 の制御</a> を行った。これが動くということはなんらかのクラウドの api 経由で tapo p105 を制御できている。次の記事をみながらやってみようと試してみた。結論から言ってクラウドの api 経由ではできなかった。</p><ul><li><a href=https://zenn.dev/book000/articles/tp-link-cloud-api>TP-Link cloud APIを使ってみる</a></li></ul><p>アクセストークンを取得する。terminalUUID は適当に生成すればよい。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -s -X POST -H <span style=color:#e6db74>&#34;Content-Type: application/json&#34;</span> -d <span style=color:#e6db74>&#39;{&#34;method&#34;: &#34;login&#34;, &#34;params&#34;: {&#34;appType&#34;: &#34;iphone&#34;, &#34;cloudUserName&#34;: &#34;xxx@example.com&#34;, &#34;cloudPassword&#34;: &#34;***&#34;, &#34;terminalUUID&#34;: &#34;bf63e1d0-d5dc-4636-abf1-7eeada585935&#34;}}&#39;</span> https://wap.tplinkcloud.com/ | jq .
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;error_code&#34;</span>: 0,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;result&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;accountId&#34;</span>: <span style=color:#e6db74>&#34;142785160&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;regTime&#34;</span>: <span style=color:#e6db74>&#34;2023-06-11 04:59:43&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;countryCode&#34;</span>: <span style=color:#e6db74>&#34;JP&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;riskDetected&#34;</span>: 0,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;email&#34;</span>: <span style=color:#e6db74>&#34;xxx@example.com&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;token&#34;</span>: <span style=color:#e6db74>&#34;***-***&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>ここで取得したアクセストークンを使ってデバイスの一覧を取得する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -s -X POST -H <span style=color:#e6db74>&#34;Content-Type: application/json&#34;</span> -d <span style=color:#e6db74>&#39;{&#34;method&#34;: &#34;getDeviceList&#34;}&#39;</span> https://wap.tplinkcloud.com/?token<span style=color:#f92672>=</span>***-*** | jq .
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;error_code&#34;</span>: 0,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;result&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;deviceList&#34;</span>: <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;deviceType&#34;</span>: <span style=color:#e6db74>&#34;SMART.TAPOPLUG&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;role&#34;</span>: 0,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;fwVer&#34;</span>: <span style=color:#e6db74>&#34;1.3.6 Build 20230308 Rel. 52591&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;appServerUrl&#34;</span>: <span style=color:#e6db74>&#34;https://aps1-wap.tplinkcloud.com&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;deviceRegion&#34;</span>: <span style=color:#e6db74>&#34;ap-southeast-1&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;deviceId&#34;</span>: <span style=color:#e6db74>&#34;802241DA5175CF114E567DE8D72A3094210CB12D&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;deviceName&#34;</span>: <span style=color:#e6db74>&#34;P105&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;deviceHwVer&#34;</span>: <span style=color:#e6db74>&#34;1.0.0&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;alias&#34;</span>: <span style=color:#e6db74>&#34;U21hcnQgUGx1ZyAoS2F6YW1vcmkgT2ZmaWNlKQ==&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;deviceMac&#34;</span>: <span style=color:#e6db74>&#34;482254AC1D25&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;oemId&#34;</span>: <span style=color:#e6db74>&#34;495AC9D888EB711C42A28BECF62071CF&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;deviceModel&#34;</span>: <span style=color:#e6db74>&#34;P105&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;hwId&#34;</span>: <span style=color:#e6db74>&#34;58070BD9D8ECC915CD3D6F20A2172712&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;fwId&#34;</span>: <span style=color:#e6db74>&#34;1D18AD293A25ABDE41405B20C6F98816&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;isSameRegion&#34;</span>: true,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;status&#34;</span>: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>ここまでは従来のスマートプラグと同様に動く。ここから先の手順は従来の hs105 と tapo p105 では手順が異なるみたい。<code>passthrough</code> というメソッドを呼び出してみてもエラーが返ってくる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -s -X POST -H <span style=color:#e6db74>&#34;Content-Type: application/json&#34;</span> -d <span style=color:#e6db74>&#39;{&#34;method&#34;:&#34;passthrough&#34;, &#34;params&#34;: {&#34;deviceId&#34;: &#34;802241DA5175CF114E567DE8D72A3094210CB12D&#34;, &#34;requestData&#34;: &#34;{\&#34;system\&#34;:{\&#34;get_sysinfo\&#34;:null},\&#34;emeter\&#34;:{\&#34;get_realtime\&#34;:null}}&#34;}}&#39;</span> https://wap.tplinkcloud.com/?token<span style=color:#f92672>=</span>***-*** | jq .
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;error_code&#34;</span>: -20571,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;Device is offline&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>どうやら tapo シリーズはスマートプラグ自体が web api のエンドポイントを提供していて、ローカルからデバイスの web api を呼び出して制御できるらしい。例えば、次の記事でその手順が書いてあって、同様のやり方で実装した野生のライブラリもたくさんみつかる。</p><ul><li><a href=https://guminote.sakura.ne.jp/archives/911>ESP8266 で Tp-Link のスマートプラグ『Tapo P105』を直接操作する</a></li></ul><p>うちのシェアオフィスのネットワークはローカルの ip アドレスへの通信をすべて拒否しているようなのでこのやり方はうちのオフィスでは検証できない。しかし、tp-link 社のスマホアプリと ifttt の webhook 経由で p105 の制御ができているため、おそらくローカルのエンドポイントに接続する以外の別の手段があるのだと推測する。それをインターネット上で数時間探してみたものの、発見できなかった。この前 interop の展示で聞いた話しだと ifttt は非公開 api を使ってインテグレーションを実装しているという話しだったけど、どうやってクラウド経由で通信しているのだろう？と不思議に思った。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0617/>課題管理の雑談会の準備</a></h1><div class=post-meta><time class=post-date>2023-06-17 (Sat.) ::</time></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/issue-management/>issue management</a>&nbsp;</span><div class=post-content><p>疲れて18時過ぎに帰ってきて軽く野菜サラダを食べてそのまま寝てた。22時に起きたのでそれからオフィスへ行って2時過ぎまで作業してた。3時から寝て6時半に起きてそのまま8時半まで寝てた。</p><h2 id=ストレッチ>ストレッチ</h2><p>出張から戻ってきた後の大事な体調管理の1つ。今回の出張はいつもより離れた場所にホテルをとってあちこち歩いたし、interop の展示会にも参加してたくさん歩いた。昨日はバテて早めにお仕事を終えて寝てたりもした。ストレッチを受けてみると、足の張りはいつもより大きかった。とくに右足すね・ふくらはぎの張りがひどかった。関節周りの痛みも気持ち分大きかったかもしれない。腰の張りは思ったよりひどくなかったのでそこまで歩き過ぎたというわけでもないみたい。ちょっと負荷の高い運動をしたぐらいかな。今日の開脚幅は開始前155cmで、ストレッチ後158cmだった。数値はほぼいつもとあまり変わらない。</p><h2 id=課題管理の雑談会へ向けての準備>課題管理の雑談会へ向けての準備</h2><p>来月、東京出張したときに <a href=/diary/posts/2023/0106/#隔週の雑談>コパイロツトさんと雑談会</a> を予定している。課題管理の雑談をしたいといっても一般の人にはなんのことか理解できないので事前に資料を送るために過去の資料を見返していた。過去に勉強会で使った資料と、直近のお仕事の内容も踏まえての課題管理についての資料をいくつか整理し直した。選択した3つの資料でスライド数は100を超えている。</p><ul><li><a href=/diary/posts/2022/1202/>スクラムと課題管理+イテレーション開発の比較</a></li><li><a href=/diary/posts/2023/0113/>ビッグテックのマネジメント</a></li><li>直近の話しも含めての課題管理の概要</li></ul><p>気付けばコンテンツは十分に蓄積しつつある。これからそれらのコンテンツを体系化したり整理したり、うちの会社がどういう切り口でビジネスしていくかのコンテキストを構成していかないといけない。これがとても難しいと私は考えていて、時間がかかる作業だし、もしかしたら実際にやってみてうまくできないということもあるかもしれない。来月はどんな雑談会になるのかまだわからないけど、課題管理の話しをできる人は少ないので新たな視点が出てくればいいな。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0616/>アイディアのコラボレーション</a></h1><div class=post-meta><time class=post-date>2023-06-16 (Fri.) ::</time></div><span class=post-tags>#<a href=/diary/tags/document/>document</a>&nbsp;
#<a href=/diary/tags/infrastructure/>infrastructure</a>&nbsp;
#<a href=/diary/tags/payment/>payment</a>&nbsp;
#<a href=/diary/tags/smartplug/>smartplug</a>&nbsp;
#<a href=/diary/tags/device/>device</a>&nbsp;</span><div class=post-content><p>2時に寝て何度か起きて7時に起きた。今日は勉強会の登板なのになにも準備できてなくてどうしようとか思いながら寝た。</p><h2 id=パッケージングとリリースのドキュメント>パッケージングとリリースのドキュメント</h2><p>5月の落ち穂拾いの時期にプロジェクトの開発ドキュメントを刷新していろいろな要項を書き残している。最後に残ったまだ書いていないドキュメントに次の2つがある。水曜日から課題管理やコードレビューの隙間時間に書き出していって3日ほどかけて一通り書き終えた。私は文章を書くのが遅いのと、1回ですべての内容を網羅できなくて、書いているうちに思い出して追記したり、寝かした文章をあとで見返して推敲したりすることが多い。そのため、ドキュメントを1週間ぐらいかけて書いたりする。</p><ul><li>パッケージング</li><li>リリース</li></ul><p>たまたまメンバーにあるモジュールをリファクタリングのために再実装してもらっている。その開発を完了したら古いモジュールと入れ替える必要があるので、開発だけではなく、パッケージングやリリース周りの作業を把握してもらう、よい機会と言える。これまでパッケージングやリリース周りのインフラはほとんど私が作って運用をまわしてきたので徐々にそれらを引き継ぐタイミングとも言える。開発者はインフラのことを気にせず、アプリケーションを開発してコミットすれば後はすべて ci/cd が自動的にいろいろやってくれて便利ぐらいの感覚で扱えるようにするのが、外資系などではプラットフォームに投資しろと言われたりするものだと推測する。うちらが開発しているプロダクトはコンテナ、RPM、Windows インストーラーとパッケージングする種類が多い。その要項に加えて QA 責任の考え方などについても書いておいた。主には私がいなくなった後に役に立つドキュメントとなるだろう。</p><h2 id=チーム勉強会>チーム勉強会</h2><p>本当は go の generics の勉強会をやりますと先週宣言していた。しかし、私が遊んでいて全然準備できなかったので代わりに決済とスマートプラグの話しをした。<a href=/diary/posts/2023/0612/>先週末と月曜日</a> に作った決済とスマートプラグを組み合わせたもの。サービスや仕組みを簡単に説明して、実際にデモを動かして電球を灯す。</p><figure><img src=/diary/img/2023/0616_payment-and-smartplug.png></figure><p>参加者からスマートプラグをラズベリーパイに置き換えてパワーリレーというモジュールを使えばもっとスマートにできるんじゃないかという意見が出た。たしかにラズベリーパイなら stripe の決済イベントを受け取るサーバーをデバイス内に同梱させることもできるかもしれない。そうすると、スマートプラグのような電源の on/off だけではなく、ラズベリーパイが扱えるセンサーとインテグレーションすることもできそう。また時間のあるときにやってみたい。コラボレーションって正にこういうことを言うとわかってきた。私が1人でこの仕組みを実装していたときにはラズベリーパイというキーワードはまったく頭の中になかった。他者の視点が加わるから新しいアイディアが広がる。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0615/>初 interop と初幕張メッセ</a></h1><div class=post-meta><time class=post-date>2023-06-15 (Thu.) ::</time></div><span class=post-tags>#<a href=/diary/tags/founding/>founding</a>&nbsp;
#<a href=/diary/tags/event/>event</a>&nbsp;</span><div class=post-content><p>23時頃から寝て何度か起きて7時に起きた。最近は家でもあまりうまく眠れないけれど、ホテルだともっとうまく眠れない感じで睡眠不足な感じ。</p><h2 id=初めての-interop>初めての interop</h2><p>午前中は ci/cd の修正をしたり、ドキュメントを書いたりして、午後から <a href=https://www.interop.jp/2023/>Interop Tokyo 2023</a> に参加してきた。いつかうちの会社も出展したい。将来のために所感を残しておく。幕張メッセの会場に着いたのが14時過ぎで、あらかじめマーキングしておいた10社弱のブースをまわって、8社ぐらいのブースでスタッフさんに製品や技術の説明を聞いて情報収集してきた。そんなもんと言えばそれまでだが、interop は過去に参加したことのある it 系の展示会の雰囲気とよく似ていた。</p><h3 id=幕張メッセまでの移動>幕張メッセまでの移動</h3><p>初めて幕張メッセへ行ってきた。</p><ul><li>東京駅の在来線から京葉線のホームが遠い<ul><li>京葉線のホーム近くのコインロッカーが空いてた</li><li>京葉線の車両は空いてて座れるから楽だった、寝てた</li></ul></li><li>海浜幕張駅から幕張メッセまでちょっと歩く、荷物多いとしんどそう<ul><li>電車の移動時間に加え、駅と会場間の歩く時間も考慮して予定を立てないといけない</li></ul></li><li>会場の雰囲気はビッグサイトとよく似ていた<ul><li>4-6 ホールの3つを使っていたけど、ビッグサイトの展示会イベントもそんな感じだった気がする</li></ul></li><li>混雑はしていないけど、そこそこ人がいて都心から遠いデメリットを考慮すると集客力はあるように思えた</li></ul><h3 id=会場イベントの所感>会場/イベントの所感</h3><p>4-6の3つのホールを使って展示されていた。</p><ul><li>interop パビリオンというエリアに出展していた<ul><li>出入り口に近くて中心にあったのでパビリオンそのもののの立地はよいと思う</li><li>interop パビリオンには37社がひしめいていることのメリット・デメリットはありそう<ul><li>メリット<ul><li>多くの会社の展示が狭いスペース内に集合しているので来場者からみて多種多様な展示をみれておもしろい</li><li>意図的に (？) 立地がよいので会場のどこからでもアクセスしやすい (また後で寄ろうといったモチベーションになりやすい)</li></ul></li><li>デメリット<ul><li>狭いので1社が応対できる相手は1人か2人程度</li><li>通路兼応対スペースになるので個々の展示を立ち止まってみるよりも歩きながら眺める感じ、関心がないと立ち止まってみられない</li><li>地図からどんな会社が出展しているかわからないので社名をみかけて行くといった導線にはならない？<ul><li>そういう人は社名で検索してからエリアを調べてから行くかも？</li></ul></li></ul></li></ul></li></ul></li><li>一通りぐるっとまわって、ブースのスタッフさんと話したのは8社ぐらいで1時間40分ほどかかった<ul><li>あらかじめ展示をみにいく企業を決めておけば1-2時間もあれば十分にまわれる</li></ul></li><li>地図をあらじかめ印刷しておいて蛍光ペンなどで印を付けてまわればもっと効率よくできた<ul><li>エリア番号から展示場所を探すのはわりと面倒くさかった</li></ul></li></ul><figure><img src=/diary/img/2023/0615_map.png></figure><h3 id=ユニークな技術の紹介>ユニークな技術の紹介</h3><p>1つおもしろかったのを紹介すると、フォスター電機さんの <a href=https://www.foster.co.jp/products/productdata/foster_hearabledevice.pdf>ヒアラブルデバイス</a> の展示。nec さんと一緒に <a href=https://jpn.nec.com/biometrics/ear-acoustic/index.html>耳音響認証</a> という技術のデバイスを作っているらしい。耳穴に音を送って反射した音で個人を認証するというもので指紋認証と変わらない精度だという。さらに人間の内部の情報を用いるので静脈認証のように詐称が困難という特性がある。あと耳に装着しておけば常時認証状態をチェックできる。一般用途で使うデバイスではないかもしれないけど、特定の業務や業種向けの応用例がありそうだなとか思って聞いていた。サーバーサイドのアプリケーションはすべて nec さんがやっているという話しでフォスター電機さん自体はハードウェア屋さんでアプリケーションに関心がないようにもみえた。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0614/>予定調和な会議</a></h1><div class=post-meta><time class=post-date>2023-06-14 (Wed.) ::</time></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/issue-management/>issue management</a>&nbsp;</span><div class=post-content><p>2時過ぎに起きて、3時過ぎにおきて、5時台に起きて、6時半に起きた。なんか1時間おきにトイレに起きるみたいな空気で寝てた。</p><h2 id=大門近くのホテル>大門近くのホテル</h2><p>いつもは五反田のホテルに泊まっているが、今回はたまたま系列ホテルの全国旅行支援適用の部屋が大門近くのホテルにしかなかったのでそちらに泊まってみた。五反田-大門間は都営浅草線で9分なので近い。過去に東京で働いていた頃、その近くに住んでいて、勤めていた会社もあったので、街そのものが懐かしくて、大門、浜松町、新橋のエリアをあちこち散策した。それでいつもの出張よりめっちゃ歩いた。15年前と変わらず残っているお店やビルもあれば、まったく違う店舗に変わってしまったお店もある。新橋とか、コロナ禍も過ぎたせいか、めっちゃ飲み歩いている人たちで活気があった。</p><h2 id=プロジェクトの進捗報告>プロジェクトの進捗報告</h2><p>出張したときの月例報告の7回目。<a href=/diary/posts/2023/0406/>前々回の進捗報告はこちら</a> 。5月の報告は書いてないな。そのときは他の会議がたくさんあったから省略してしまっている。他の会議と出席者も重複しているしな。</p><p>今回はわりとしっかり資料も作っていって、特異なネタもいれて、コンテンツとしては手応えをもって臨んだ。しかし、会議をしてみてそれほど盛り上がらなかったので私の自己満足だったのかもしれない。もう半年以上やっているからそんなものなのかもしれないが、肯定も否定もなくて、淡々と準備した資料の内容を説明して、ちょっと雑談して終わるといった、予定調和な会議になってきた。「本気でそんなことやるの？ちょっと待って！」みたいなツッコミが入るような取り組みをしないといけないのか？内容は悪くなかったと思うんだけど、会議が退屈だったら申し訳ないなとか思った。</p><p>課題管理ができると働き方がどう変わるかを示す GitLab のアクティビティ図があって、その図の利用許可をもらった。また後日、会社のコンテンツを作るときに活用する。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0613/>メリハリの付け直し</a></h1><div class=post-meta><time class=post-date>2023-06-13 (Tue.) ::</time></div><span class=post-tags>#<a href=/diary/tags/information-exchange/>information exchange</a>&nbsp;
#<a href=/diary/tags/issue-management/>issue management</a>&nbsp;
#<a href=/diary/tags/project-management/>project management</a>&nbsp;
#<a href=/diary/tags/virtualization/>virtualization</a>&nbsp;</span><div class=post-content><p>23時ぐらいまで作業して、1時から2時ぐらいまで仮眠した。いつも通り普通に寝ないで始発の新幹線に乗って寝てた。寝ていて体があちこち痛くて、月に1回ではあるけどこの生活を続けるのもよくないかもなと思い始めた。</p><h2 id=新しい定例会議の初日>新しい定例会議の初日</h2><p>6月から新しい開発がスタートして <a href=/diary/posts/2023/0607/>新しい定例会議の進め方</a> に変更した。ふりかえりと情報共有の定例を1時間に詰め込むので時間が足りないかも？と時間を意識しながら進めた。その甲斐もあってか、ちょうどぴったり1時間におさまった。これも一種のパーキンソンの法則のようなものが働いているのかもしれない。</p><blockquote><p>仕事は、完成までに利用可能な時間を使い果たすように拡大していく</p><p><a href=https://asana.com/ja/resources/parkinsons-law>パーキンソンの法則</a></p></blockquote><p>メンバーが2人なので機能開発が2つずつ並行に進む。1つは開発が完了し、もう1つも大半は完了している。完了できなかったことは残念だが、私からみても着実にステップアップしているのでそれほど問題視していない。<a href=/diary/posts/2023/0526/#ドッグフードテストと運用談義>ドッグフードテスト</a> の導入も完了こそしなかったが、これも社内インフラの都合や管理者の工数を調整してもらったりするので着実に進捗しているのであれば、それほど厳密にスケジュール管理しなくてよいのかもしれない。</p><p>イテレーション開発のルール的には優先度を付けた issue はそのイテレーション内でやり切るという目標をもつように促している。但し、まだ開発の序盤であるので現時点ではそれほど重要ではない。これも1つのメリハリだとみなすこともできる。また様々な状況の変化や調整をしながら期限を意識して働くのは一定のスキルと自律的な行動を取れる開発者に限られる。</p><p>なんのために働くかの答えを見い出せていない若い人にそれを求めるのもまた違うなと思えて、この状況を作り出しているのは、働く目的そのものを導くようなリーダーシップを取れていない私自身の責任だと実感した。つまり私が自身の規律を緩めているのがメンバーに伝わって、結果的にスケジュールを守ろうとする最後の底力を支えられていないと思えた。開発の仕切り直しに私自身も切り替えていかないといけない。</p><h2 id=厄介なインフラの問題-x-2>厄介なインフラの問題 x 2</h2><p>ちょうどインフラに関する、特定の状況においてパフォーマンスが劇的に劣化したり、意図しない振る舞いをしたりする事象を2つ確認している。これこそ私が面倒をみる issue だなと思って着手した。m2 macbook はこういったインフラの再現環境を作るのに向いていない。2022年に virtualbox 7.0 で m1/m2 に対応したという changelog があるけど、少し前にインストールしようとするとエラーになって動かなくて諦めた。</p><blockquote><p>macOS host: Providing a Developer Preview package for systems with an Apple silicon CPU. This is unsupported work in progress, and is known to have very modest performance.</p><p><a href=https://www.virtualbox.org/wiki/Changelog-7.0>Changelog for VirtualBox 7.0</a></p></blockquote><p>アプリケーションのコンテナイメージも、現時点では amd64 向けにしか提供していないため、どのみちコンテナでの検証が必要になったら m2 macbook では動作させられない。そういう厄介な issue を抱えた。帰ったらオフィスのデスクトップマシンで再現環境を作るところから始める。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0612/>ネットワークからスマートプラグの制御</a></h1><div class=post-meta><time class=post-date>2023-06-12 (Mon.) ::</time></div><span class=post-tags>#<a href=/diary/tags/smartplug/>smartplug</a>&nbsp;
#<a href=/diary/tags/device/>device</a>&nbsp;</span><div class=post-content><p>昨日は夕方に親が立ち寄るかもしれないというから待機していたのに空振りに終わった。0時に寝ようとしてあまり眠れなくて7時に起きた。ここ最近寝ているのか寝てないのかよく分からない眠り方になる。</p><h2 id=決済してスマートプラグを-on-にしろ>決済してスマートプラグを ON にしろ</h2><p><a href=/diary/posts/2023/0611/>昨日の続き</a> 。夕方に <a href=https://www.tp-link.com/jp/home-networking/smart-plug/tapo-p105/>Tapo P105</a> が届いたので業務を終えてからさっそく使ってみた。</p><figure><img src=/diary/img/2023/0612_smartplug.jpeg></figure><p>オフィスの wifi に接続して、tp-link 社のスマホアプリからデバイス登録する。スマホアプリからはすぐに on/off できた。スマホで電源の on/off を制御できてあまり嬉しいことはパッと思いつかないけど、プログラムから制御できるならなにか遊べそうな気もしてくる。<a href=https://ifttt.com>ifttt</a> というインテグレーションサービスがあって、それを使うと tp-link 社のデバイスと ifttt 社の web api 経由で制御できる。おそらくなんらかの web api が tp-link 社からも提供されているはず。それが公開されていれば ifttt を使う必要はないし、すでにハックされているものを使うのでもよいかもしれない。ひとまず動かすことを目的とするので ifttt を使う。スマートプラグに電球をつなげて、決済したら電球が灯って3秒後に消えるようなサンプルアプリを作った。一通り最後まで動かすことができておもしろかった。</p><ul><li><a href=https://github.com/kazamori/stripe-webhook-sample>https://github.com/kazamori/stripe-webhook-sample</a></li></ul></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0611/>スマートプラグ制御の調査</a></h1><div class=post-meta><time class=post-date>2023-06-11 (Sun.) ::</time></div><span class=post-tags>#<a href=/diary/tags/smartplug/>smartplug</a>&nbsp;
#<a href=/diary/tags/device/>device</a>&nbsp;
#<a href=/diary/tags/kobe/>kobe</a>&nbsp;
#<a href=/diary/tags/food/>food</a>&nbsp;</span><div class=post-content><p>23時に寝てうまく眠れなくて5時に起きた。そのまま10時ぐらいまでだらだらしてた。</p><h2 id=スマートプラグの通電テスター>スマートプラグの通電テスター</h2><p><a href=/diary/posts/2023/0610/>昨日の続き</a> 。スマートプラグを検索すると TP-Link 社の製品がよく出てくるのでミニスマート wi-fi プラグの <a href=https://www.tp-link.com/jp/home-networking/smart-plug/tapo-p105/>Tapo P105</a> を購入してみた。この製品だとネットワーク経由で電源の on/off ができそう。ifttt というサービスが <a href=https://ifttt.com/tplink_tapo>TP-Link Tapo</a> インテグレーションを公開している。TP-Link 社も自前で <a href=https://www.tplinkcloud.com/>TP-LINK Cloud</a> というサービスを提供していて、どうやらその web api は公開されていないようだけど、おそらくそこで使っている web api を調べてライブラリにしたのが <a href=https://www.npmjs.com/package/tplink-cloud-api>tplink-cloud-api</a> のようにみえる。サイトをみる限りはカメラしかサポートしていないようにもみえる。スマートプラグのようなデバイスがハックしやすい性質のせいか、書いてある情報が曖昧で実際にどうやってデバイスを制御したらよいのかネット上の記事からよくわからない。実際に購入したもので試してみるのが早そう。明日届く予定。</p><p>このスマートプラグによる電源 on/off のテスターに、ダイソーで電球を購入してきた。電源ソケットアダプタが100円、電球は100円、200円、300円とそれぞれあったんだけど、100円の差異でどうせ買うなら精度のよいものをと考えて300円のものを購入した。LED で電力消費も少ない。</p><figure><img src=/diary/img/2023/0611_light.jpeg></figure><p>試しにオフィスにあった amazon 純正スマートプラグ経由で接続して alexa アプリで on/off したら意図したように電球が灯ってテスターの代替にできた。デモのために使うのでそれぐらいわかりやすいのがよい。</p><h2 id=モロゾフ>モロゾフ</h2><p>昨日参加したもくもく会を借りていた <a href=https://www.kobe-bunka.jp/facilities/chuo/>中央区文化センター</a> には2フロアに渡って大小いくつかの会議室がある。それぞれの会議室には張り紙をしていて借り主の名前が外からわかる。たまたま通ったところに「モロゾフ労働組合」と書いてあって、どこかの会社の労組が会議しているんだなと覚えていた。今日になって来週の東京出張のお土産を探していたらモロゾフというお店があることに気付いた。<a href=https://www.morozoff.co.jp/company_ir/history_index.html>モロゾフの歩み</a> によると1931年創業の神戸本店の洋菓子の会社らしい。これもなにかの縁だと思って今回はモロゾフさんの神戸本店へ行って <a href=https://www.morozoff.co.jp/products/baked_sweets/15_3/>ブロードランド 15個入</a> をお土産用に購入した。</p><p>自分用にアーモンドケーキを買って食べてみた。しっとり食感で控え目にアーモンドの風味がして甘過ぎなくて後味のよいケーキでおいしかった。</p><figure><img src=/diary/img/2023/0611_armond-cake.png></figure></div></article><div class=pagination><div class=pagination__buttons><a href=/diary/posts/page/33/ class="button previous"><span class=button__icon>←</span>
<span class=button__text>最近の日記</span>
</a><a href=/diary/posts/page/35/ class="button next"><span class=button__text>過去の日記</span>
<span class=button__icon>→</span></a></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2024 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>