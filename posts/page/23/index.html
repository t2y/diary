<!doctype html><html lang=en><head><title>Posts :: forest nook</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/posts/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="Posts"><meta property="og:description" content><meta property="og:url" content="/diary/posts/"><meta property="og:site_name" content="forest nook"><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/posts/index.xml rel=alternate type=application/rss+xml title="forest nook"></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><div class=posts><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0329/>gitlab packages api の使い方</a></h1><div class=post-meta><time class=post-date>2023-03-29 (Wed.) ::</time></div><span class=post-tags>#<a href=/diary/tags/gitlab/>gitlab</a>&nbsp;
#<a href=/diary/tags/ci/cd/>ci/cd</a>&nbsp;
#<a href=/diary/tags/packaging/>packaging</a>&nbsp;</span><div class=post-content><p>0時に寝て何度か起きて6時半に起きた。先週より少し早く起きれるようになってきた。</p><h2 id=gitlab-cicd-で別プロジェクト-リポジトリ-の成果物を取得する>gitlab ci/cd で別プロジェクト (リポジトリ) の成果物を取得する</h2><p>gitlab では複数のパッケージリポジトリに対応しているが、それらに当てはまらない汎用の成果物向けに <a href=https://docs.gitlab.com/ee/user/packages/generic_packages/>GitLab Generic Packages Repository</a> というものがある。zip でもバイナリファイルでも何でも置くためのリポジトリと言える。但し、同じパッケージ名でバージョン管理するといった作りにはなっていなくて、同じパッケージ名でアップロードしても別のパッケージ id が割り当てられて管理される。他バージョンとの紐付け自体はできているので、おそらく歴史的経緯でそういう仕様なのだと思う。そのために、あるパッケージの最新のバージョンを取得したいときは作成日の降順でソートして最初のパッケージを取得するといったコードを書かないといけない。それは <a href=https://docs.gitlab.com/ee/api/packages.html>Packages API</a> を駆使して簡単なスクリプトを書くことになる。</p><p>もう1つ分からないことにトークンの使い分けがある。なるべく ci/cd での処理は <a href=https://docs.gitlab.com/ee/ci/jobs/ci_job_token.html>GitLab CI/CD job token</a> を使いたいところだが、どうも Packages API の呼び出しはできなくて別途プロジェクトでアクセストークンを作成して呼び出すようにしている。これはもしかしたら別の設定で CI/CD job token でも呼び出しできるかもしれない。rest api への呼び出し権限そのものがないのかもしれない。</p><p>最終的には次のようなスクリプトで任意のプロジェクトの generic リポジトリの最新の成果物を取得できた。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>rm -rf <span style=color:#e6db74>${</span>TARGET_DIR<span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span>mkdir -p <span style=color:#e6db74>${</span>TARGET_DIR<span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> project in $PROJECTS
</span></span><span style=display:flex><span><span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  prj<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>echo <span style=color:#e6db74>&#34;</span>$project<span style=color:#e6db74>&#34;</span> | jq -Rr @uri<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>  base<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>CI_API_V4_URL<span style=color:#e6db74>}</span><span style=color:#e6db74>/projects/</span><span style=color:#e6db74>${</span>prj<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>  pkg<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>curl -s -H <span style=color:#e6db74>&#34;PRIVATE-TOKEN: </span>$PROJECT_ACCESS_TOKEN<span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>base<span style=color:#e6db74>}</span><span style=color:#e6db74>/packages?order_by=created_at&amp;sort=desc&amp;per_page=1&#34;</span> | jq <span style=color:#e6db74>&#39;.[0]&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>  pkg_id<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>echo $pkg | jq -r .id<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>  pkg_name<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>echo $pkg | jq -r .name<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>  pkg_version<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>echo $pkg | jq -r .version<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>  file_names<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>curl -s -H <span style=color:#e6db74>&#34;PRIVATE-TOKEN: </span>$PROJECT_ACCESS_TOKEN<span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>base<span style=color:#e6db74>}</span><span style=color:#e6db74>/packages/</span><span style=color:#e6db74>${</span>pkg_id<span style=color:#e6db74>}</span><span style=color:#e6db74>/package_files&#34;</span> | jq -r <span style=color:#e6db74>&#39;.[].file_name&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> file_name in $file_names
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    dw_endpoint<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>base<span style=color:#e6db74>}</span><span style=color:#e6db74>/packages/generic/</span><span style=color:#e6db74>${</span>pkg_name<span style=color:#e6db74>}</span><span style=color:#e6db74>/</span><span style=color:#e6db74>${</span>pkg_version<span style=color:#e6db74>}</span><span style=color:#e6db74>/</span><span style=color:#e6db74>${</span>file_name<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    curl -s -H <span style=color:#e6db74>&#34;PRIVATE-TOKEN: </span>$PROJECT_ACCESS_TOKEN<span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>dw_endpoint<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> -o <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>TARGET_DIR<span style=color:#e6db74>}</span><span style=color:#e6db74>/</span><span style=color:#e6db74>${</span>file_name<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>find <span style=color:#e6db74>${</span>TARGET_DIR<span style=color:#e6db74>}</span> -type f
</span></span></code></pre></div></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0328/>財布の置き場所を忘れる</a></h1><div class=post-meta><time class=post-date>2023-03-28 (Tue.) ::</time></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;</span><div class=post-content><p>3時に寝て7時に起きた。</p><p>昨日の夜に <a href=https://anime.shochiku.co.jp/revenger/>リベンジャー</a> の最終回をみてよかった。</p><p>週次の定例会議を終えて、テスト環境の再作成を待ったり、compose.yml をデプロイするための rpm のパッケージングするための gitlab ci/cd の rest api などを調べたり、これといって特筆するようなことのない1日だった。</p><h2 id=財布を失いかけた>財布を失いかけた</h2><p>家に帰るときになって財布がないことに気付いた。お昼にお弁当を購入したときに財布を使ったのでお昼まではあった。お弁当を食べるために家に帰ったのでそのときに家に置き忘れたのかな？と思って、一旦家に帰ったけど、財布はない。財布を落としてしまったんだなとがっかりして家とオフィスの道中に財布が落ちていないかを確認しつつ、もう一度オフィスへ戻った。オフィスでも一通り調べていたところ、引き出しの中から出てきた。</p><p>お昼にレシートとクレジットカードの明細をホッチキスで閉じるときに引き出しからホッチキスを取り出して、そのときにホッチキスと一緒に財布を引き出しの中にしまっていたようだ。まったく記憶になくて無意識でそうしていた。歳をとるとたまにはそういうことがあるのか、そろそろ認知能力が落ちきているのか、そんなことも起きるんだという失敗談になった。まったく自分が信頼できない。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0327/>docker/compose のモジュールの使い方がわかってきた</a></h1><div class=post-meta><time class=post-date>2023-03-27 (Mon.) ::</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/docker/>docker</a>&nbsp;
#<a href=/diary/tags/cli/>cli</a>&nbsp;</span><div class=post-content><p>0時に寝て7時に起きた。前日はバテてだらだらしていたので寝過ぎた。</p><h2 id=案ずるよりもツールできた>案ずるよりもツールできた</h2><p>先週末に <a href=/diary/posts/2023/0324/>docker/compose 関連のライブラリ調査</a> を終えて実際のツール作りをしていた。本当は日曜日に作ってしまおうと思いつつ休んでしまった。なぜか今日はメンバーが全員お休みでチームで私しか働いていなかった。年度末で有休消化しているのかな？問い合わせ対応やメンバーのサポートが不要だったので1日中、自分の開発に集中できた。そして開発に集中できた結果、一通りツールの機能の開発を終えられた。火曜日までには仕上げたいと思っていたのでぎりぎり間に合った。</p><p>最終的に testcontainers-go の compose モジュールを使うのは断念して compose cli のみ go 標準の <a href=https://pkg.go.dev/os/exec>os/exec</a> パッケージを使ってプロセスを fork するようにした。また docker image をコンテナレジストリから取得するときに認証が必要な場合、最初の <a href=https://docs.docker.com/engine/reference/commandline/login/>docker login</a> すると credentials store にパスワード (またはトークン) 情報が記録される。設定情報は <code>$HOME/.docker/config.json</code> からも確認できる。この仕組みを使ってコンテナレジストリへのログインを自動化できる。私の環境では macbook に docker desktop をインストールしているが、普通に使っていると次のように credentials が保存されてその内容を確認できる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ docker-credential-desktop list | jq .
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;https://index.docker.io/v1/&#34;</span>: <span style=color:#e6db74>&#34;t2y1979&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;https://index.docker.io/v1/access-token&#34;</span>: <span style=color:#e6db74>&#34;t2y1979&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;https://index.docker.io/v1/refresh-token&#34;</span>: <span style=color:#e6db74>&#34;t2y1979&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>$ echo <span style=color:#e6db74>&#34;https://index.docker.io/v1/access-token&#34;</span> | docker-credential-desktop get
</span></span><span style=display:flex><span><span style=color:#f92672>{</span><span style=color:#e6db74>&#34;ServerURL&#34;</span>:<span style=color:#e6db74>&#34;https://index.docker.io/v1/access-token&#34;</span>,<span style=color:#e6db74>&#34;Username&#34;</span>:<span style=color:#e6db74>&#34;t2y1979&#34;</span>,<span style=color:#e6db74>&#34;Secret&#34;</span>:<span style=color:#e6db74>&#34;***&#34;</span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>これと同じことを docker のライブラリで行うには次のようにする。取得したい docker image の uri を参照すればコンテナレジストリがわかる。そこからこの cli でやっているようなことを順番にやっていけばよい。これらのユーティリティは3つのリポジトリで管理されていて、この雰囲気をみただけでもこのモジュール分割が本当に適切なんやろか？とか思ったりもする。</p><ul><li><a href=https://github.com/distribution/distribution>https://github.com/distribution/distribution</a></li><li><a href=https://github.com/docker/cli>https://github.com/docker/cli</a></li><li><a href=https://github.com/moby/moby>https://github.com/moby/moby</a></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>getRegistryAuthFromImage</span>(
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>imageURI</span> <span style=color:#66d9ef>string</span>,
</span></span><span style=display:flex><span>) (<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ref</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>reference</span>.<span style=color:#a6e22e>ParseNormalizedNamed</span>(<span style=color:#a6e22e>imageURI</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to parse image uri: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>repo</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>ParseRepositoryInfo</span>(<span style=color:#a6e22e>ref</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to parse repository: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>dcli</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>command</span>.<span style=color:#a6e22e>NewDockerCli</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to create docker cli: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>auth</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>command</span>.<span style=color:#a6e22e>ResolveAuthConfig</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>dcli</span>, <span style=color:#a6e22e>repo</span>.<span style=color:#a6e22e>Index</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>encoded</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>command</span>.<span style=color:#a6e22e>EncodeAuthToBase64</span>(<span style=color:#a6e22e>auth</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to encode auth: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>encoded</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0326/>春休み 2日目</a></h1><div class=post-meta><time class=post-date>2023-03-26 (Sun.) ::</time></div><span class=post-tags>#<a href=/diary/tags/day-off/>day off</a>&nbsp;
#<a href=/diary/tags/life/>life</a>&nbsp;</span><div class=post-content><p><a href=/diary/posts/2023/0312/>2週間前に引き続き</a> 今日も春休み。昨日まではお仕事のツール開発をしようと思っていたのだがバテた。</p><h2 id=人は変わる>人は変わる</h2><p>たまたまはてブで <a href=https://kawango.hatenablog.com/entry/2023/03/24/141701>立花さんとの対談について</a> というエントリを読んだ。この記事だけではなんのことかわからないので、川上さんと立花さんの対談の動画を検索してみた。動画は2時間半ぐらいあった。 いや、実際にはみていない。みようとしたが、みる価値がなさそうなので飛ばし飛ばしで15分ぐらいしかみていない。みなくてよいと思う。おっさん同士が並行線のまま口喧嘩しているだけの動画だった。ちゃんとみてないから間違っているかもしれないが。</p><p>ニコニコ動画が youtube と競っていた頃、2012年頃かな？それぐらいの時期のときにニコニコ動画を応援していたし、そのときに川上さんは時代の寵児のようにみえた。川上さんの対談や記事をたくさん読んだし、著書である <a href=https://www.nhk-book.co.jp/detail/000000884582015.html>コンテンツの秘密</a> も素晴らしい本だと思う。ある時からなんか時代にあわない発言をされるように感じていた。カドカワの後継者になって身の丈を超えてしまったのか、インターネット規制の議論で体制側になってしまったからなのか、私の価値観の方向性とはあわなくなってしまった。最近はあまり活躍をみないと思っていて、たまたまみたものが口喧嘩の動画でさらにがっかりした。</p><p>過去に偉大な実績を残された方が歳を経て退化するような現象は他にもいくつかある。自分が周りからみてどのようにみえているか、私にはわからないが、謙虚に真摯に目の前のことに向き合って取り組むようにしたい。相手に敬意をもって接するといった当たり前のことができなくならないよう、気をつけたいと思えた。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0325/>ubuntu のインストール</a></h1><div class=post-meta><time class=post-date>2023-03-25 (Sat.) ::</time></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/linux/>linux</a>&nbsp;
#<a href=/diary/tags/device/>device</a>&nbsp;</span><div class=post-content><p>1時に寝て5時に起きて7時に起きた。今週も開発に集中していたのでバテ気味。時間がなくて2ヶ月以上行ってなかった散髪に行ってきた。前髪が目にかかって鬱陶しかったのでいつもよりも短くしてもらった。頭が軽いと日々の生活のストレスも軽減しそう。</p><h2 id=ストレッチ>ストレッチ</h2><p>今日の開脚幅は開始前153cmで、ストレッチ後153cmだった。ストレッチ後の開脚幅はいつもとは計り方を変えたので数値は低くなっているが普段と同じぐらいのものだろう。すねの外側の筋は気にならないぐらいになったので復調したと言っていいだろう。今日は右股関節から太ももにかけての張りと右腰の張りが大きかった。今週も根を詰めて長時間オフィスで作業していたので座っているとかかる部位の負荷が高くなっていると想定される。納期が4月末なのでこの生活はもうしばらく続くといったところ。</p><h2 id=dell-マシンに-ubuntu-をインストール>dell マシンに ubuntu をインストール</h2><p>いつも通りオフィスで会社の事務手続きをしながら、並行して <a href=/diary/posts/2023/0323/>購入した dell マシン</a> に ubuntu をインストールする。いまお仕事で開発しているアプリケーションの成果物は amd64 をターゲットにしているのでローカルに amd64 の開発環境がないとインフラ周りやコンテナ周りの検証に一手間かかる。この状況を解消するために早くローカルの dell マシンを置き換えて開発環境を構築したい。dvd-r から ubuntu 22.04.01 (サイズ超過で dvd-r におさまらなくて 22.04.02 は断念) のインストールを行う。bios で一時的に secure boot の機能を無効にしないと署名チェックで起動しなかった。インストール作業中に予期せぬ不具合が発生しました的なポップアップが2-3回発生したけど、無視して継続できた。インストールして普通に起動すればいいやと緩い感覚で進めた。いつもはパーティションも自分で設定したりしているけれど、今回は windows 領域を残してデュアルブートな環境にしてみた。ディスク領域もインストーラーから windows 領域を 160GiB、残りをすべて ubuntu 領域にするといった設定ができた。すごい簡単。余裕があるときに windows の wsl を使うのも試してみれればと思う。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0324/>コンテナの運用ツールを作る</a></h1><div class=post-meta><time class=post-date>2023-03-24 (Fri.) ::</time></div><span class=post-tags>#<a href=/diary/tags/docker/>docker</a>&nbsp;
#<a href=/diary/tags/ci/cd/>ci/cd</a>&nbsp;</span><div class=post-content><p>1時に寝て明け方に起きて7時に起きた。あまり眠れてない雰囲気がある。</p><h2 id=dockercompose-の運用>docker/compose の運用</h2><p>いま作っているアプリケーションは <a href=https://docs.docker.com/compose/>docker compose</a> で構成している。マージ単位で gitlab ci/cd から docker image をビルドしていて、テスト環境のデプロイスクリプトで最新の docker image を取得してコンテナを再作成するようにしている。デプロイスクリプトは docker cli と docker compose cli の2つを組み合わせてシェルスクリプトで実装しているが、複数のアプリケーションやミドルウェアがあるのでそれらを統合的に扱うことはできないし、さまざまな状況を想定して動くようにもなっていない。がんばれば doccker/compose cli と jq とシェルスクリプトで細かい要件を実装することもできるけど、それをお客さんの本番環境においても使うには一定の cli 操作に慣れが必要な上、docker/compose の知識やスキルも要求してしまう。少なくとも頻繁にある運用作業として docker image の更新やコンテナの再作成が想定される。ローリングアップデートまでは実装しないけど、アプリケーションの要件にあわせた docker image の更新とコンテナの再作成 (アプリケーションの再起動) ぐらいはまとめてやってしまってよいと思う。</p><p>github.com/docker/docker は <a href=https://github.com/moby/moby>github.com/moby/moby</a> にリダイレクトされる。docker は開発ツール、moby はインフラやライブラリという住み分けでそれぞれに関心のあることに注力するようにモジュール構成を分離している。それが2019年に行われていまもおそらくまだ途上だと思う。あと docker のモジュール群は go modules に対応していない。大きなプロジェクトが移行するのが大変なのは理解できるけれど、依存解決のような複雑なところを放置するのはまったく賛成できない。そこが不健全だと依存ライブラリの整理やモジュール分割がうまく進まない気がする。docker の client は <a href=https://github.com/moby/moby/tree/master/client>https://github.com/moby/moby/tree/master/client</a> に定義されていて、readme のサンプルコードにあるようにすぐに使えるようになっている。一方で compose の spec は <a href=https://github.com/compose-spec/compose-go>github.com/compose-spec/compose-go</a> で定義されていて、<a href=https://github.com/docker/compose>github.com/docker/compose</a> はまだライブラリとして使いやすいようにはなっていない。仕様と実装が混在していて動いている状態。そういう issue もあげられている。</p><ul><li><a href=https://github.com/docker/compose/issues/9602>Using compose as library #9602</a></li></ul><p>testcontainers-go というアプリケーションが compose をライブラリとして使う実装をしている。このコードをみれば compose をどう使えばよいのかはわかる。</p><ul><li><a href=https://golang.testcontainers.org/features/docker_compose/>Using Docker Compose</a></li></ul><p>自分で compose を実装してもよいけれど、compose の service を扱うための project やオプションの設定が煩雑なことも伺える。仕様と実装が混在しているというのはそこら変の整理ができていないようにみえるからだ。testcontainers-go も自前の client を用意して使いやすいようにしているのでそれを再利用した方が運用ツールを作るのは簡単になる。testcontainers-go の compose client 経由で compose の up/down を制御する。その他のコンテナの操作は docker client を直接使って実装する。この組み合わせで自分たちのアプリケーション向けの運用ツールを作ろうと思う。</p><blockquote class=twitter-tweet><p lang=ja dir=ltr>コンテナを操作する運用ツールを作るために docker をライブラリとして使ってツールを作っている。関連するところの docker のソースを読んでいて、感覚的にあまり洗練されていない印象をうける。依存解決も意味不明な所感。</p>&mdash; Tetsuya Morimoto (@t2y) <a href="https://twitter.com/t2y/status/1639233150357471233?ref_src=twsrc%5Etfw">March 24, 2023</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0323/>デスクトップマシンの買い替え</a></h1><div class=post-meta><time class=post-date>2023-03-23 (Thu.) ::</time></div><span class=post-tags>#<a href=/diary/tags/founding/>founding</a>&nbsp;
#<a href=/diary/tags/device/>device</a>&nbsp;</span><div class=post-content><p>1時に寝て5時に起きて7時に起きた。昨日も吐き気がしてうまく眠れなかった。</p><h2 id=dell-マシンの買い替え>dell マシンの買い替え</h2><p><a href=/diary/posts/2023/0123/#デスクトップマシンの調子が悪い>1月頃からデスクトップマシンの調子が悪かった</a> 。ちょうど3年経ったところでそろそろ故障してもおかしくないと言える。ちょうど年度末なので dell の半期に一度の大感謝祭を待って購入することにした。これまでは <a href=https://www.dell.com/ja-jp/shop/%E8%A3%BD%E5%93%81%E3%82%B7%E3%83%AA%E3%83%BC%E3%82%BA/sf/vostro-desktops>vostro</a> を使っていた。そろそろメモリが16GiBだと厳しくなってきたところ。メモリが32GiBついているデスクトップマシンは限られてくる。
その制約もあって <a href=https://www.dell.com/ja-jp/shop/%E8%A3%BD%E5%93%81%E3%82%B7%E3%83%AA%E3%83%BC%E3%82%BA/sf/xps-desktops>xps</a> マシンを購入をすることにした。</p><p>昨日のお昼過ぎに注文したのに翌日の午前中にマシンが届いた。あまりの早さに驚いた。dell の配送のワークフローの凄さを実感した。デスクトップマシンを注文して1週間ぐらいで来たらいいと普通の感覚で思っていたら翌日なんやもんな。24時間も経ってなかったしな。</p><p>グラフィックボードからモニタに接続しようとしたら4つのインターフェースのうち3つが displayport で1つが hdmi になっていた。いまどきは displayport が主流なんやね。そんなことすらも知らなくて変換アダプタ買わないととか思っていたら、モニターも displayport をもっていて、モニターの箱にも displayport ケーブルが同梱されていて、そのまま接続できることに気付いた。3年ぐらいでマシンを買い替えないとハードウェアのデバイスの変更にもついていけないのだなということも実感した。</p><p>私はもう世の中についていけてなくて、たまに普段やらないことをやるとそこで起きることに驚いて右往左往している。windows を起動して dell update から bios やファームウェアを最新のもの更新したりしていた。windows 上からダウンロードして設定して、再起動時に自動的に bios の更新がかかるような振る舞いをする。uefi のなせる技なんだろうけど、こういうところにも驚いて感心したりする。</p><p>ubuntu 22.04.02 が 4.8GiB あって dvd-r にぎりぎりおさまらない。もう dvd-r でもインストールメディアを作ることができなくなったんやなと気付く。22.04.01 は 3.6 GiB なので1つ前のバージョンをインストールしてアップグレードすればいいかとやってみたらブート時に次のようなエラーになった。</p><blockquote><p>Verification failed:(0x1A) Security Violation</p></blockquote><p>bios に secure boot 機能なるものがあって 22.04.01 ではインストールできないように署名チェックが行われるらしい。古いディストリビューションをインストールするには secure boot を一時的に無効にするしかなさそう。</p><ul><li><a href=https://askubuntu.com/questions/1456460/verification-failed-0x1a-security-violation-while-installing-ubuntu>https://askubuntu.com/questions/1456460/verification-failed-0x1a-security-violation-while-installing-ubuntu</a></li></ul></div></article><div class=pagination><div class=pagination__buttons><a href=/diary/posts/page/22/ class="button previous"><span class=button__icon>←</span>
<span class=button__text>最近の日記</span></a>
<a href=/diary/posts/page/24/ class="button next"><span class=button__text>過去の日記</span>
<span class=button__icon>→</span></a></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>© 2021 Tetsuya Morimoto</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>