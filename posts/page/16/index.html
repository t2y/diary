<!doctype html><html lang=en><head><title>Posts :: </title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/posts/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="Posts"><meta property="og:description" content><meta property="og:url" content="/diary/posts/"><meta property="og:site_name" content><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/posts/index.xml rel=alternate type=application/rss+xml title></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><div class=posts><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1210/>2023年のふりかえりとコミュニティの価値</a></h1><div class=post-meta><time class=post-date>2023-12-10 (Sun.) ::</time></div><span class=post-tags>#<a href=/diary/tags/event/>event</a>&nbsp;
#<a href=/diary/tags/review/>review</a>&nbsp;
#<a href=/diary/tags/community/>community</a>&nbsp;
#<a href=/diary/tags/blog/>blog</a>&nbsp;</span><div class=post-content><p>23時に寝て2時に起きて4時半に起きて6時までゲームやって8時に起きた。朝からオフィスで発表資料を作ってた。</p><h2 id=2023年ふりかえり>2023年ふりかえり</h2><p><a href=https://kobe-sannomiya-dev.connpass.com/event/302551/>今年を振り返ろう！LT大会</a> に参加した。</p><p>昨日の夜に LT 資料を作ろうと思っていたものの、晩ご飯食べたら面倒になってそのまま家で休んでいた。朝からオフィスで作り始めたら徐々に興が乗ってきて想定した以上にちゃんと作ってしまった。やぎさんにレビューしてもらっていくつか気付きを得た。ちょうど <a href=/diary/posts/2023/1206/>レビューサービス</a> あったら依頼したいなと思ったところだったのでレビューしてくれる人の存在に感謝した。この資料はまたなにか他の機会のイベントでも再利用しようと思う。カフーツさんの忘年会で発表してもよいかもしれない。</p><ul><li><a href="https://docs.google.com/presentation/d/1LVYOqR7ynsRJlsAjsG1nZTV-0tnhfhxE_g-pUe3koQc/edit?usp=sharing">2023年ふりかえり</a></li></ul><p>北海道から <a href=https://www.docswell.com/user/tomio2480>西原さん</a> という方が参加されていた。全国あちこちのコミュニティに参加して、そこに集う人たちの支援や盛り上げ、ひいては日本の IT コミュニティを活性化させて、世の中をよくしようといった取り組みをされている。これは私も共感するところで大半の人はコミュニティ活動に関心がない。それ自体は個人の好みで構わないのだけど、プログラミングを学びたいと考えているのに行動できない人たちというのが一定数いて、そういう人たちの受け皿として IT コミュニティで始めるのはよいことだと思う。西原さんはまさにそういう活動をされている。とても尊いことだと思う。</p><p>短時間にも関わらず、いろいろな話しをして私自身収穫もあったし、西原さんから学ぶことも多かった。企業のテックブログを読む会を毎週30分、社内外でやっていると話されていた。これは素晴らしいなと思ってすぐに反応した。歳のせいか、私は自分で勉強しなくなっていて、本も仕事も課題も積みまくりで、毎日どうしよう？と途方に暮れながら帰っておいしい晩ご飯を食べてゲームしている。そんな自分で勉強しない人向けにこういったコストなく、無理なく、続けられるイベントはありがたい。やり方を学ぶためにオンラインで参加してみようと思う。</p><ul><li><a href=https://note.com/tomio2480/n/nf909bb77b4b7>ブログを見つけて読んで感想書いてそれを肴に交流する会を30分でやりきっています</a></li></ul><p>コミュニティ活動の価値というのは、多くの企業もコミュニティを盛り上げようとやっていることから明らかに大きな価値があるにも関わらず、その価値を十分に明文化できていない。私自身、コミュニティからたくさんのモノや影響を受けているにも関わらず、うまく明文化できていないところがある。課題管理の研究の延長上でコミュニティの価値にも追究していきたいと考えている。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1209/>4年目の創立記念日</a></h1><div class=post-meta><time class=post-date>2023-12-09 (Sat.) ::</time></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/founding/>founding</a>&nbsp;</span><div class=post-content><p>23時に寝て2時に起きて5時に起きて8時に起きた。税理士さんの件がもやもやしていてあまりよく眠れない。</p><h2 id=ストレッチ>ストレッチ</h2><p>今週もとくに負荷のかかることがあったわけではないため、とくにどこも悪くなく、張りや疲労を感じることはなかった。トレーナーさんもどこも悪くないという前提の上で上半身の肩が前屈みになってしまっているために肩甲骨周りが硬くなりがちであるとアドバイスしてくれた。寒くなると上半身の硬さが目立つようになるのかな。いつも通りの体調管理の一環としてストレッチを受けた。今日の開脚幅は開始前155cmで、ストレッチ後158cmだった。</p><h2 id=創立記念日>創立記念日</h2><p>今日が会社の創立記念日。無事に4周年を迎えた。過去20年、3年以上1つの会社で働いたことがない私が自分の会社では4年を迎えられたことも少し感慨深い。今日は土曜日なので創立記念日が休日ではあるけれど、やはりオフィスでいろいろ作業をしている。</p><p>2年目に経営的に大きな失敗をやらかして、その反省もあるせいか、3年目は財務が安定してきた。この3月で <a href=https://www.smrj.go.jp/kyosai/tkyosai/index.html>経営セーフティ共済</a> の掛金上限の800万円の積み立てを完了する。<a href=https://kazamori.jp/cases/>事例紹介</a> にも毎年1社新しい顧客が増えている。達人プログラマーではないが、毎年新しい顧客と取り引きをするというのもよいかもしれない。とはいえ、いまの取引先とのお仕事の契約が終了したら課題管理の研究や自社プロダクトの開発に取り組む。目安としては3年間を考えている。役員報酬をカットすれば財務的には5年はいける。意味もなく起業した私にとってはうちの会社は社会になにを還元するのかを問う期間として3-5年ぐらいを想定している。法人としてモラトリアムのようなものかもしれない。個人としても40代になって3年といった時間を自由に使えるというのはとても貴重な時間になるのではないかと考えている。自分で会社をやると年単位で時間を自由にできる。これだけでも起業する価値はあるのではないかと思う。</p><p>いまのお仕事でも課題管理の POC の1つとして実践している。想定通りと言えるほどの成果には至っていないが、時代背景や世の中の変化にも追随しながら私の頭の中にあるイメージと現実とのギャップを補正していく必要があるのかもしれない。</p><blockquote><p>完璧ではないが、最善は尽くしている。うぬぼれるな、矢口</p></blockquote><p>と赤坂先生に叱責されたい。</p><h3 id=過去の創立記念日>過去の創立記念日</h3><ul><li><a href=/diary/posts/2022/1209/>3年目</a></li><li><a href=/diary/posts/2021/1209/>2年目</a></li></ul></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1208/>税務相談のストレス</a></h1><div class=post-meta><time class=post-date>2023-12-08 (Fri.) ::</time></div><span class=post-tags>#<a href=/diary/tags/svelte/>svelte</a>&nbsp;
#<a href=/diary/tags/blog/>blog</a>&nbsp;
#<a href=/diary/tags/founding/>founding</a>&nbsp;
#<a href=/diary/tags/tax/>tax</a>&nbsp;</span><div class=post-content><p>23時に寝て2時に起きて6時に起きた。晩ご飯食べてから作業するつもりが、疲れて寝てしまった。今日は権限管理のバグ修正したり、昨日の mongodb の調査を継続していた。</p><h2 id=テックブログ公開>テックブログ公開</h2><p>先日 <a href=/diary/posts/2023/1206/>テックブログレビュー</a> を終えていた記事を公開した。</p><ul><li><a href=https://blog.osstech.co.jp/posts/2023/12/sveltekit-apps-integration/>SvelteKit アプリケーションの組み込みへの考察</a></li></ul><h2 id=隔週の雑談>隔週の雑談</h2><p>顧問のはらさんと隔週の打ち合わせ。今日の議題はこれら。</p><ul><li>テックブログ (↑) のふりかえり</li><li><a href=/diary/posts/2023/1203/>日本ナレッジ・マネジメント学会の年次大会の所感</a></li><li><a href=/diary/posts/2023/1016/>税理士さんと契約</a> して3ヶ月間やり取りした所感</li></ul><p>1ヶ月に1-2件ほど折りにふれて税務相談をする機会があったりする。税理士さんとは chatwork でやり取りしている。これがストレスになってきたのではらさんに相談にのってもらった。はらさん曰く、税理士さんの普通と it 業界のうちらとは業務の取り組み方への姿勢がまったく異なるため、最初の1年はストレスや不満がたまるのはあるという。士業という資格によって独占的に保護された業務のせいか、顧客に寄り添った対応をしてくれるわけではなく、質問の背景や意図を汲んでくれなくて質問に回答を返して終わりといった、チャットなのにメールのような一問一答のようなやり取りになっている。さらに回答が意図した内容ではなくて、追加で質問や背景の説明をしても、すぐにレスポンスが返ってくることはなく、数時間たってから回答が1つ届き、それも期待したものじゃないとさらに質問して、さらに数時間といったやり取りで5-6往復するのに数日かかるのがざらにある。はらさんがいうには税理士さんの回答を得るのに1週間ぐらいかかったり、問い合わせを数日放置されるのも普通とのことらしい。</p><p>先方も複数の顧客を相手にサポートしていて、やり取りに時間がかかることそのものは理解できるが、チャットのやり取りがコンテキストを理解しているようにみえなくてコミュニケーションが成立していない。例えば、当社への税理士報酬の支払いの対応について問い合わせたら次のような回答が戻ってくるだけ。</p><blockquote><p>報酬の額と消費税等の額が明確に区分されている場合には、その報酬の額のみを源泉徴収の対象とします。</p></blockquote><p>こんなことはググればすぐに分かるし、私も顧問報酬は原則として源泉徴収することを知っている。その上で税理士さん事務所の、当社への顧問報酬の明細について尋ねているのにこういった回答が返ってくるだけ。</p><ul><li><a href=https://www.nta.go.jp/law/tsutatsu/kobetsu/shotoku/gensen/111209/01.htm>インボイス制度開始後の報酬・料金等に対する源泉徴収</a></li></ul><p>インボイス対応もあるため、請求書に明細を書いて pdf で送ってくださいと依頼して2日間返信なく放置されている。税理士さん事務所の顧問報酬の明細や請求書について尋ねても即日に返信がこないような状況になる。はらさんが言うには税理士さんの対応とはそんなもんらしい。チャットでやり取りしている意味がないし、こんなググればわかるレベルのやり取りしかできないなら解約も検討している。もう1つ懸念に思っているのは本人がチャットで回答していないのではないか？と考えている。チャットなのに1問1答でしか返信がこないし、コンテキストが伝わっていないと感じることも多々ある。とてもベテランの税理士さんが答えているとは思えないコミュニケーションの齟齬がある。</p><p>ちょっと調べてみると、税理士は日本税理士会連合会に登録する必要があり、税理士試験に合格しても登録していない場合は税理士としての独占業務を行うことができないらしい。また税理士事務所で働いている人の中には無資格職員もいて税務補助をしている可能性もあるという。必ずしも税理士資格がなければダメだというわけでもない。無資格職員でも経験を積んで税務に詳しい人もいると思う。一方でチャットでベテランの税理士のふりをして職員が回答しているのであれば、それはそれで信頼関係や偽証などの問題がある。そこら辺も聞いてみようと思う。次の記事では無資格職員が税務相談をしている事務所もあると書いてある。</p><ul><li><a href=http://soei-tax.jp/15326648136918>税理士へ依頼したつもりが税理士でなかった</a></li></ul></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1207/>mongodb のレプリカセットのデプロイ調査</a></h1><div class=post-meta><time class=post-date>2023-12-07 (Thu.) ::</time></div><span class=post-tags>#<a href=/diary/tags/mongodb/>mongodb</a>&nbsp;
#<a href=/diary/tags/infrastructure/>infrastructure</a>&nbsp;
#<a href=/diary/tags/container/>container</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/testing/>testing</a>&nbsp;</span><div class=post-content><p>4時前に寝て6時半に起きた。1時過ぎまで作業して、帰って少しゲームして、うまく眠れなくてだらだらしていた。</p><h2 id=mongodb-のレプリカセットの調査>mongodb のレプリカセットの調査</h2><p>以前 <a href=/diary/posts/2023/1101/#mongo-とトランザクションとレプリカセット>mongodb でトランザクションを使うときにレプリカセットが必要</a> なことがわかった。他機能の開発途中だったので一旦後回しにしていたものを回収している。状況によってはメンバーに委譲してもよかったんだけど、私が遊撃で出張ってみることにした。実際に調べてみてコンテナの運用も考慮するとけっこう難しいことがわかってきた。</p><p><a href=https://www.mongodb.com/docs/mongodb-shell/>mongosh</a> からは <a href=https://www.mongodb.com/docs/v7.0/reference/method/js-replication/>Replication Methods</a> を使ってレプリカセットの操作ができる。これはユーティリティのようなもので mongodb としての低レベルのコマンド操作は <a href=https://www.mongodb.com/docs/manual/reference/command/nav-replication/>Replication Commands</a> になる。<a href=https://github.com/mongodb/mongo-go-driver>mongo-go-driver</a> はレプリカセット向けのユーティリティを提供していないため、Replication Commands を RunCommand() の低レベル API を使って自分で実装しないといけない。</p><p>例えば、レプリカセットの初期化をするときは次のように <code>replSetInitiate</code> というコマンドを適切なパラメーターで呼び出す。あまりドキュメントで丁寧に説明されていないので試行錯誤でエラーメッセージをみながら実装することになる。とくにはまるのが mongod のサーバーは <code>--replSet myrs</code> のようにレプリカセットを指定して起動させるものの、初期化コマンドを実行するときはまだレプリカセットを設定していないため、レプリカセットを指定せず、且つ <code>direct</code> パラメーターをセットしないと mongod サーバーに接続できない。この微妙な設定を把握するのにはまった。これが正しい手順かどうかもわからないが、ググったりしているとフォーラムでそういったコメントが散見されたりする。おそらく mongosh の Replication Methods を使うと、クライアントからサーバー接続は裏方でよしなにやってくれるのでそっちの方が簡単ではある。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ReplicaSet</span>) <span style=color:#a6e22e>Initiate</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>config</span> <span style=color:#a6e22e>bson</span>.<span style=color:#a6e22e>M</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>client</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>connectDirect</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to connect with direct: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Disconnect</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>result</span> <span style=color:#a6e22e>bson</span>.<span style=color:#a6e22e>M</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>cmd</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bson</span>.<span style=color:#a6e22e>D</span>{{<span style=color:#a6e22e>Key</span>: <span style=color:#e6db74>&#34;replSetInitiate&#34;</span>, <span style=color:#a6e22e>Value</span>: <span style=color:#a6e22e>config</span>}}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Database</span>(<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>db</span>).<span style=color:#a6e22e>RunCommand</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>cmd</span>).<span style=color:#a6e22e>Decode</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>result</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to run replSetInitiate(): %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>PrettyPrint</span>(<span style=color:#e6db74>&#34;completed to initiate&#34;</span>, <span style=color:#a6e22e>result</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ReplicaSet</span>) <span style=color:#a6e22e>connectDirect</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>mongo</span>.<span style=color:#a6e22e>Client</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>opts</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>Client</span>().
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>SetAuth</span>(<span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>Credential</span>{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Username</span>: <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>User</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Password</span>: <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>Passwd</span>.<span style=color:#a6e22e>String</span>(),
</span></span><span style=display:flex><span>		}).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>SetHosts</span>(<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>Hosts</span>).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>SetDirect</span>(<span style=color:#66d9ef>true</span>) <span style=color:#75715e>// must be true
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>mongo</span>.<span style=color:#a6e22e>Connect</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>opts</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>InitSingleReplicaSet</span>(
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>cfg</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>MongoDB</span>,
</span></span><span style=display:flex><span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>rs</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NewReplicaSet</span>(<span style=color:#a6e22e>cfg</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>initConfig</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bson</span>.<span style=color:#a6e22e>M</span>{
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;_id&#34;</span>: <span style=color:#a6e22e>cfg</span>.<span style=color:#a6e22e>ReplicaSet</span>,
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;members&#34;</span>: []<span style=color:#a6e22e>bson</span>.<span style=color:#a6e22e>M</span>{
</span></span><span style=display:flex><span>			{<span style=color:#e6db74>&#34;_id&#34;</span>: <span style=color:#ae81ff>0</span>, <span style=color:#e6db74>&#34;host&#34;</span>: <span style=color:#e6db74>&#34;localhost:27017&#34;</span>},
</span></span><span style=display:flex><span>		},
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>rs</span>.<span style=color:#a6e22e>Initiate</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>initConfig</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>さらに mongod サーバーを起動するときに <code>--replSet</code> と <code>--keyFile</code> (認証が必要な場合のみ？) という2つのパラメーターを指定する必要がある。<code>--replSet</code> はレプリカセットの識別子を指定する。そして <code>--keyFile</code> は共通鍵を指定する。この共通鍵を生成するには次のようにする。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ openssl rand -base64 <span style=color:#ae81ff>756</span> &gt; my-mongo-keyfile
</span></span><span style=display:flex><span>$ chown mongodb:mongodb my-mongo-keyfile
</span></span><span style=display:flex><span>$ chmod <span style=color:#ae81ff>400</span> my-mongo-keyfile
</span></span></code></pre></div><p>普通のサーバーインスタンスならすぐできることだが、コンテナの運用において面倒なのが owner とパーミッションを設定しないといけないところ。mongo のコンテナは mongodb ユーザーで起動するため、root でマウントされたファイルシステムには書き込みできなかったりして keyFile の配置をどう扱えばよいのかが難しい。docker hub の mongo の issues でもどうやって設定したらいいの？って議論が発散している。mongo 本体が公式のスクリプトや仕組みを提供していれば済む話しだけど、どうもそうではないみたい。だから泥臭い方法で自分でなんとかしないといけないようにみえる。</p><ul><li><a href=https://github.com/docker-library/mongo/issues/246>Creating a mongo image set with &ndash;replSet #246</a></li><li><a href=https://github.com/docker-library/mongo/issues/339>Cannot configure replica sets with entrypoint-initdb #339</a></li></ul><p>dockertest でもレプリカセットの設定について次の issue として登録されている。mongo のコンテナを使ったテストの場合、dockertest のレイヤーが挟まるのでさらにわかりにくくなっている。テストを動かすためにどういった設定が必要かは把握できたのでなにかよい方法を考えてコントリビュートしたい。</p><ul><li><a href=https://github.com/ory/dockertest/issues/480>Create an example for starting mongodb as a replica set #480</a></li></ul></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1206/>記事のレビューをしてもらえるサービス</a></h1><div class=post-meta><time class=post-date>2023-12-06 (Wed.) ::</time></div><span class=post-tags>#<a href=/diary/tags/writing/>writing</a>&nbsp;
#<a href=/diary/tags/review/>review</a>&nbsp;
#<a href=/diary/tags/business/>business</a>&nbsp;
#<a href=/diary/tags/life/>life</a>&nbsp;</span><div class=post-content><p>疲れて18時過ぎにはお仕事を終えて、帰ってきて晩ご飯も食べずにそのまま寝てた。22時頃に起きてそれから晩ご飯を作って食べて、また夜に寝て6時に起きた。</p><h2 id=テックブログレビュー>テックブログレビュー</h2><p>顧問のはらさんに昨日書いたテックブログのレビューをお願いした。一通り、調査した内容の範囲内で書いてはいるが、私はフロントエンドについて明るくないため、大きな勘違いや誤りを含んだ文章を書いてしまう可能性がある。本来テックブログは会社のブランディングにつながるものだが、誤った記事を書いてしまうと逆効果になってしまう。自社なら私の責任で済むが、他社のテックブログでブランドイメージを毀損するのは申し訳ない。</p><p>私が書いた記事をレビューしてもらえる有識者を、報酬をつけて広く募るみたいなサービスがあってもいいなと思えた。うちの会社がもう少し財務的に余裕ができたら、いくつかの分野の有識者と顧問契約して、技術に限定せず、いろんな分野で私の書いた記事のレビューをお願いできるような体制にしたい。余談だが、レビュー依頼して誰もレビューしてくれないというのも書いていて寂しい。よい開発文化をもつチームならそんなこと起きない。私を書いた記事をメンバーが率先してレビューしないという時点でまだまだうちのチームには改善の余地がある。</p><h2 id=円形テーブル受け取り>円形テーブル受け取り</h2><p>ジモティーで「籐 ラタン 木製丸テーブル」を500円で購入した。使わないときは折り畳みできる。省スペースでよさそうにみえた。現物を受け取ってみて、使用感はあるが傷んではいない。まだ実家の離れで使うか、自分の部屋で使うかは決めていない。しばらく部屋で使ってみてその用途や感触で決めようと思う。問い合わせしてから2日後に近所のローソン前で待ち合わせをして受け取りできた。近所だと、引き取りの調整もしやすいし、軽いものだったので自転車の荷台に乗せて運んできた。これまでジモティーで6件の取引を行ったが、いまのところ、トラブルはない。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1205/>全員採用のためのテックブログ</a></h1><div class=post-meta><time class=post-date>2023-12-05 (Tue.) ::</time></div><span class=post-tags>#<a href=/diary/tags/writing/>writing</a>&nbsp;
#<a href=/diary/tags/svelte/>svelte</a>&nbsp;
#<a href=/diary/tags/blog/>blog</a>&nbsp;
#<a href=/diary/tags/recruiting/>recruiting</a>&nbsp;</span><div class=post-content><p>2時に寝て6時に起きて9時前に起きた。寝るのがどんどん遅くなってきて生活のリズムが乱れてきた。</p><h2 id=sveltekit-に関するテックブログ執筆>sveltekit に関するテックブログ執筆</h2><p><a href=/diary/posts/2023/1204/#kitvite-アプリケーションのデバッグ>先日の続き</a> の続き。</p><p>調査は一区切りついたのでテックブログを執筆することにした。今日はほぼ丸一日記事を書いていた。本当はマネージャーの私が1-2週間も技術調査して、テックブログを一生懸命書くみたいなことをやるよりも、他に大事なプロジェクトの遊撃やマネジメントに時間を割くべきではある。一方でメンバーに課題に取り組むにあたり、設計をどうするのか？設計をするためには調査が必要であること、調査した内容をアウトプットする重要性などの模範を示したいという意図で書いた。そして、メンバーにも開発の隙間にテックブログを書くことを業務として指示しようと考えている。</p><p>なんのためにテックブログを書くか？という目的は、業務においては明確で採用のために書く。プログラマーが採用において協力できることは限られる。その中でもテックブログというのは費用対効果が高く、会社のブランディングにもつながり、よい開発文化を醸成することにもつながる。プログラマーの採用がとても難しくなった昨今「全員採用」というキーワードもよく聞くようになった。一見プログラマーは採用において無関係だし、実際にそういった業務をやらなくても咎められることはない。しかし、自分のできることで採用に協力したいと考えたとき、できることの1つにテックブログを書くというのは悪くない選択肢だと私は考えている。少なくともテックブログを書けない (書かない) 人たちにとやかく言われたくない。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1204/>svelte コンポーネントの実装は簡単</a></h1><div class=post-meta><time class=post-date>2023-12-04 (Mon.) ::</time></div><span class=post-tags>#<a href=/diary/tags/svelte/>svelte</a>&nbsp;
#<a href=/diary/tags/debug/>debug</a>&nbsp;
#<a href=/diary/tags/javascript/>javascript</a>&nbsp;</span><div class=post-content><p>1時に寝て何度か起きて7時に起きた。日曜日の夜に業務スーパーへ行ったら生鮮系は売り切れているのが多かった。日持ちするようなものを購入した。<a href=/diary/posts/2023/1123/>呪術廻戦ゲーム</a> の初心者ミッションをクリアしたのでゲームの時間を減らしていく。</p><h2 id=kitvite-アプリケーションのデバッグ>kit/vite アプリケーションのデバッグ</h2><p><a href=/diary/posts/2023/1130/#kitvite-アプリケーションのデバッグ>先日の続き</a> の続き。</p><p>ある kit アプリケーションの svelte コンポーネントから外部の kit アプリのコンポーネントやモジュールを埋め込むことができるかどうかを調査した。ドキュメントの <a href=https://kit.svelte.dev/docs/load>Loading data</a> をみながらコンポーネントを書いてみる。フロントエンドの開発はすべてメンバーに委譲しているので私はほとんど開発していない。ドキュメントみないとまったくどう実装していよいかわからない。</p><p>svelte コンポーネントをレンダリングするときにサーバー側で動かすのは +page.server.ts に、クライアント側で動かすのは +page.ts に実装する。今回の場合、外部の node.js プロセスに起動したサーバーに対してリクエストして index.html に相当するものを取得するのでサーバー側で取得したレスポンスから html を取り出して、それをコンポーネント側でレンダリングする。+page.server.ts は次のように実装する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#66d9ef>type</span> { <span style=color:#a6e22e>PageServerLoad</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;./$types&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>apps</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;$lib/index&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>load</span>: <span style=color:#66d9ef>PageServerLoad</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>async</span> ({ <span style=color:#a6e22e>params</span> }) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>res</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>fetch</span>(<span style=color:#a6e22e>apps</span>[<span style=color:#e6db74>&#39;kit-demo1&#39;</span>].<span style=color:#a6e22e>entrypoint</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>html</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>text</span>();
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> { <span style=color:#a6e22e>html</span> };
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>この html をクライアント側の +page.svelte から参照してレンダリングする。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#f92672>script</span> <span style=color:#a6e22e>lang</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;ts&#34;</span>&gt;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>import</span> <span style=color:#a6e22e>type</span> { <span style=color:#a6e22e>PageData</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;./$types&#39;</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>export</span> <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>data</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>PageData</span>;
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>script</span>&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>div</span>&gt;{@html data.html}&lt;/<span style=color:#f92672>div</span>&gt;
</span></span></code></pre></div><p>これで一応は意図した kit アプリケーションを埋め込むことはできるが、実際にはスクリプトなどはなにかが競合して動かないようだ。これは node.js から取得するスクリプトやスタイルなどが複数の kit アプリケーションで競合してしまうからではないかと推測する。</p><p>これが ssg ならば <a href=https://kit.svelte.dev/docs/adapter-static>adapter-static</a> を使ってビルドして、その成果物を static ディレクトリ配下に置くだけでそのまま動く。これは特別ななにかではなく、kit アプリケーションとして意図した振る舞いにはなる。これが出来て嬉しいことはあまり思いつかないが、想像した通りに動くかどうかの検証のために確認した。</p><p>次のリポジトリに調査した内容のサンプルコードを作った。ここまでの調査内容でまたテックブログを書いてみようと思う。</p><ul><li><a href=https://github.com/t2y/sveltekit-apps-integration-sample>github.com/t2y/sveltekit-apps-integration-sample</a></li></ul></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1203/>日本ナレッジ・マネジメント学会にオンライン参加した</a></h1><div class=post-meta><time class=post-date>2023-12-03 (Sun.) ::</time></div><span class=post-tags>#<a href=/diary/tags/event/>event</a>&nbsp;
#<a href=/diary/tags/academia/>academia</a>&nbsp;
#<a href=/diary/tags/information-exchange/>information exchange</a>&nbsp;
#<a href=/diary/tags/management/>management</a>&nbsp;</span><div class=post-content><p>0時に寝て5時に起きてゲームして9時に起きてまたゲームしていた。午前中は家でだらだらしていてお昼からオフィスで作業していた。</p><h2 id=ナレッジマネジメントの年次学会>ナレッジ・マネジメントの年次学会</h2><p>夏ごろに <a href=/diary/posts/2023/0715/#日本ナレッジ・マネジメント学会に加入申請を出した>日本ナレッジ・マネジメント学会へ加入</a> していた。学会誌を読んだりする程度しか活動できていなかったものの、年次大会をオンラインで視聴していた。</p><ul><li><a href=https://kmsj2023.peatix.com/>日本ナレッジ・マネジメント学会：第26回年次大会</a></li></ul><p>お昼からみたのでパネルディスカッションの後半と研究発表をいくつか視聴した。パネルディスカッションは ai についての議論をしていたが、私からみてとくに目新しい議論はなかったように思える。研究発表はいくつか関心のあるものがあって、自分たちの研究について話す前に先行研究としてこれやあれがあって、それらを踏まえて、自分たちはこういう研究をしていると聞ける。それまでの歴史や先行研究でわかっていることなども知ることができて、自分で一から調べるよりも調査時間を短縮できる。聞いていていくつかおもしろそうな論文もあった。また時間ができたときに調査するための issue として作っておいた。すでにそういった issue はたくさんあるのだけど。</p><p>おもしろかった発表内容の1つにリーダーシップ論は <a href=https://ja.wikipedia.org/wiki/%E9%87%8E%E4%B8%AD%E9%83%81%E6%AC%A1%E9%83%8E>野中郁次郎</a> 先生ともう1人 (名前を聞き取れなかった) を除いたら、すべて米国からきたものだという。日本の地域性の高い問題においては米国由来のリーダーシップ論ではうまくいかないケースがあるといった話しをされていた。他にも実践知と叡智の違いとか、賢慮がどうこう、気付きの定義、技術と技能の定義といった用語の定義を明確にして議論をするといったところが学術研究とビジネスの大きな違いのように思えた。そして、学術研究においてもそれが定説としての認知度または実績がなければ、さまざまな仮説や研究があることから、自分たちはこの単語をこのように解釈して使っているとか、それぞれの派閥によって同じ言葉を別の意味で解釈していたりする。知識に関する用語が乱立して、結果的になにについて話しているのか、わかりにくくなってしまうといった雰囲気も感じることができた。野中先生の提唱する「フロネティック・リーダーシップ」には、実践知の起源として、アリストテレスが分類した3つの知識の一つ、フロネシスにあり「賢慮」とも訳されるらしい。実践知の要素には倫理が含まれていて正しいことを行うための判断も指摘されていた。来年ぐらいからうちの会社もこういった研究に時間を割いていきたい。また資料が公開されたふりかえりをしてみようと思う。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1202/>ミニカンファレンスみながら作業してた</a></h1><div class=post-meta><time class=post-date>2023-12-02 (Sat.) ::</time></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/event/>event</a>&nbsp;</span><div class=post-content><p>1時に寝て7時に起きて朝からゲームしてた。お酒飲んだせいで眠りが浅かったような気がする。</p><h2 id=ストレッチ>ストレッチ</h2><p>先週は前日に車であちこち移動して、長時間運転していたのもあり腰に負担がかかっていた。今週は東京出張だったものの、すねの外側の筋やふくらはぎの張りをやや感じた程度でとくに悪いところのない状態に戻ったようにみえる。寒くなってきたのもあり、上半身の肩周りの動きが堅くなっているとトレーナーさんは話していた。今日の開脚幅は開始前153cmで、ストレッチ後158cmだった。</p><h2 id=ミニカンファレンスのオンライン参加>ミニカンファレンスのオンライン参加</h2><p>オンラインのミニカンファレンスを視聴しながらいつも通りの作業をしていた。あまりちゃんと聞いていたわけではないけど、要所要所でおもしろい発表もあった。</p><ul><li><a href=https://kyotogo.connpass.com/event/285351/>Go Conference mini 2023 Winter IN KYOTO</a></li></ul><p>tinygo の中の人が自作キーボードに関する発表をしていて、その人は明石市に住んでいるので、明石市から三ノ宮にかけてイベントをやりたいと話されていた。go について話す相手がいると私も嬉しい。またなにかの機会でご一緒できればと思う。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1201/>SakeBash と LT 発表</a></h1><div class=post-meta><time class=post-date>2023-12-01 (Fri.) ::</time></div><span class=post-tags>#<a href=/diary/tags/event/>event</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/community/>community</a>&nbsp;
#<a href=/diary/tags/drinking/>drinking</a>&nbsp;
#<a href=/diary/tags/management/>management</a>&nbsp;</span><div class=post-content><p>2時に寝て4時に起きて5時に起きて7時に起きた。<a href=/diary/posts/2023/1123/>呪術廻戦ゲーム</a> の初心者ミッションだけクリアしたらやめようと思って、なかなかミッションのレベルが高くて届かない。あともうちょっと。</p><h2 id=sakebash>SakeBash</h2><p>神戸に <a href=https://www.acall.inc/>acall (アコール)</a> さんという会社があって、コロナ禍が始まる前に SakeBash イベントを開催されていた。2019-2020年にかけてのとき。それ以来ずっと開催されていなかったイベントを復活させたみたい。コロナ禍が acall さんの転機になったようで、オフィスのオートメーションに関するプロダクトを開発していて会社が大きくなっているらしい。</p><ul><li><a href=https://acall.connpass.com/event/302038/>Kobe Engineer SakeBash #2 ~神戸のエンジニアコミュニティを盛り上げよう</a></li></ul><p>acall さんは go でプロダクト開発をしていると知っていたので神戸で go の話しができると思って次の LT 発表をした。発表したら向こうから声をかけてくれて go の話しができるかな？と期待したのだけど、あまりそういう雰囲気でもなかった。私はコミュ障なので知らない人に話すのが苦手。</p><iframe class=speakerdeck-iframe frameborder=0 src=https://speakerdeck.com/player/18d191169877476193d56bbd535a32a3 title="go-ldap Contribution" allowfullscreen style="border:0;background:padding-box padding-box rgba(0,0,0,.1);margin:0;padding:0;border-radius:6px;box-shadow:rgba(0,0,0,.2)0 5px 40px;width:600px;height:auto;aspect-ratio:560/315" data-ratio=1.7777777777777777></iframe><p>acall さんの社員でしやさんという方が宮崎県から来られて、始めて LT 発表するということで応援しながら聞いた。</p><ul><li><a href="https://docs.google.com/presentation/d/1R16dnV6ewhZWqe5mBKKIGf6jmZdNoNWDoE7tbX6APp8/edit#slide=id.gc6f73a04f_0_0">そろそろどうなん？Flutter</a></li></ul><p>私の周りでも flutter を採用している人たちがいるので気にはなっていた。最近は flutter web というのも出ていて、flutter でフロントエンドとスマホアプリの両方に対応できそうにも思えた。次にスマホアプリ対応が必要になったら flutter を採用してみてもいいなと思えた。acall さんの制度をみていてユニークだなと感じたものに「いまあい旅費」がある。リモートワーク前提の会社だからこそ、こういった制度の価値が出てきたとも言える。一昔前は出張するのが当たり前だったのでこんな制度に意味はなかったが、リモートワークにより出張しないことが当たり前になったのでこういう制度設計になったんだと思えた。</p><blockquote><p>いま、あいにいきます旅費</p><p>リモート勤務でオフラインで集うことが難しいメンバーと「会うこと」の価値を再認識し、オフィスで自社プロダクトのプラクティスを行うことで、製品のアップデートに貢献することを目的とした制度です。自宅から100km以上離れた神戸または東京オフィスに行くための旅費を支給します。（1往復分の交通費と宿泊費／ケ月）</p></blockquote><p>イベントに acall の社員さんが10人ぐらい参加していた。勢いのある会社は会社イベントに参加する人も多くてよい雰囲気にみえた。宮崎県から来られていたしやさんの他にも埼玉県から来られていたとしさんという方もいた。他にも遠方から来ていた方もいたのかもしれない。</p><h2 id=2次会>2次会</h2><p>いまひとつ飲み足りなかったので三ノ宮.dev の仲のよい人たちと飲みに行った。<a href=https://tabelog.com/hyogo/A2801/A280101/28037644/>RailRoad no.57</a> というバーでよい雰囲気のお店だった。またなにかの機会で使いたいと思う。葉っぱ (ハーブ？) がたくさん入っているはちみつカクテルがおいしかった。</p><figure><img src=/diary/img/2023/1201_drink.jpg></figure><p>そこで以前コミュニティで起業相談にのった方の経営について話題になった。創業してから1年弱かけて少し前にある web サービスをリリースした。その web サービスはコモディティで、すでに競合も数社ある。あまり新規のベンチャー企業にとって勝ち目のある分野だと私からはみえない。どうやってこの web サービスを黒字化するのだろう？と私は疑問に思っていた。創業者の相談に乗った方も今後の戦略について尋ねても明確な答えは返ってこなかったようでとても不安になったと話されていた。融資を受けたという話しを聞いていたのでしばらく会社を存続できるのかもしれないけど、作った web サービスを収益化しないと次の融資を受けられることはないだろうから先行きは厳しいのではないかと推測する。外部からみえる範囲内では今後の先行きは危ぶまれる。創業して1年もたつのに、若い開発者にすら心配されるような戦略しかもっていない経営者というのはちょっと想像できない。融資を受けることが出来たぐらいだから、起業や経営について相談にのってくれる人は周りにいるんじゃないかと思うんだけど、経営目線で厳しいことを言ってくれる人はいないのかもしれない。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1130/>複数の kit アプリケーションを共存させる仕組みの考察</a></h1><div class=post-meta><time class=post-date>2023-11-30 (Thu.) ::</time></div><span class=post-tags>#<a href=/diary/tags/svelte/>svelte</a>&nbsp;
#<a href=/diary/tags/debug/>debug</a>&nbsp;
#<a href=/diary/tags/node.js/>node.js</a>&nbsp;
#<a href=/diary/tags/javascript/>javascript</a>&nbsp;</span><div class=post-content><p>1時に寝て3時に起きて5時に起きて7時半に起きた。なんとなく布団に入らずにベッドの上でそのまま寝てた。それでもあまり寒くはなかった。</p><h2 id=kitvite-アプリケーションのデバッグ>kit/vite アプリケーションのデバッグ</h2><p><a href=/diary/posts/2023/1127/#kitvite-アプリケーションのデバッグ>先日の続き</a> の続き。</p><p>kit アプリケーションを kit アプリケーションに埋め込むといったことができないかどうかの調査をしている。いろいろ調べている中で kit の discussions でもそういった議論はいくつか行われている。マイクロフロントエンドというキーワードも出てくる。</p><ul><li><a href=https://github.com/sveltejs/kit/discussions/4151>MicroFrontends with Svelte + SvelteKit #4151</a></li><li><a href=https://github.com/sveltejs/kit/discussions/5003>Approach to embedding Kit #5003</a></li></ul><p>これらの議論をみていても kit の ssr はそれ自体が1つのアプリケーションとして動かすことを前提にビルドされているため、kit アプリケーション内に別の kit アプリケーションを埋め込んだり、一部のコンポーネントを外部のアプリケーションと組み合わせて動かすことはなかなか難しいようにみえる。マイクロフロントエンドのような思想で設計されていない。しかし、既存のアプリケーションを動かしつつ、少しずつ kit アプリケーションへ移行するといった運用をしたいという世の中のニーズも根強いことが伺える。</p><p>ここで svelte.config.js でエントリーポイントを置き換えるぐらいはできる。デフォルトは <code>/</code> がエントリーポイントになるのを <code>/myapp</code> に置き換えるには次のように設定する。relative は es モジュールのインポートを相対パスで行うか、絶対パスにするかの設定も変更できる。これもデプロイ先のインフラの都合にあわせて調整できるようになっている。この設定を切り替えられるのだからエンドポイントをハックすること自体はそう難しくないのかもしれない。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>kit</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>paths</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>relative</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>base</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;/myapp&#39;</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>さらに調査していて、adapter-node を使ってビルドするとデフォルトでは <a href=https://github.com/lukeed/polka>polka</a> というアプリケーションサーバーが起動するコードが生成される。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>polka</span> (<span style=color:#a6e22e>opts</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Polka</span>(<span style=color:#a6e22e>opts</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>path</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>env</span>(<span style=color:#e6db74>&#39;SOCKET_PATH&#39;</span>, <span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>host</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>env</span>(<span style=color:#e6db74>&#39;HOST&#39;</span>, <span style=color:#e6db74>&#39;0.0.0.0&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>port</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>env</span>(<span style=color:#e6db74>&#39;PORT&#39;</span>, <span style=color:#f92672>!</span><span style=color:#a6e22e>path</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#e6db74>&#39;3000&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>server</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>polka</span>().<span style=color:#a6e22e>use</span>(<span style=color:#a6e22e>handler</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>server</span>.<span style=color:#a6e22e>listen</span>({ <span style=color:#a6e22e>path</span>, <span style=color:#a6e22e>host</span>, <span style=color:#a6e22e>port</span> }, () =&gt; {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`Listening on </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>path</span> <span style=color:#f92672>?</span> <span style=color:#a6e22e>path</span> <span style=color:#f92672>:</span> <span style=color:#a6e22e>host</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;:&#39;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>port</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>ここで任意のアプリケーションサーバーを使いたいという issue があって、それに対する回答から adapter-node のドキュメントにカスタムサーバーについて書かれていることに気付く。</p><ul><li><a href=https://github.com/sveltejs/kit/issues/8794>Custom server options for adapter-node #8794</a></li><li><a href=https://kit.svelte.dev/docs/adapter-node#custom-server>Node servers: Custom server</a></li></ul><blockquote><p>アダプタは、ビルドディレクトリにindex.jsとhandler.jsの2つのファイルを作成します。index.js を実行すると (デフォルトのビルドディレクトリを使用している場合は node ビルドなど)、設定されたポートでサーバが起動します。</p><p>あるいは、Express、Connect、Polka（あるいは組み込みのhttp.createServer）に適したハンドラをエクスポートするhandler.jsファイルをインポートして、独自のサーバをセットアップすることもできます。</p></blockquote><p>handler.js さえインポートすればそのまま動くことはデバッグしていて知ってはいたのだけど、この自前のアプリケーションサーバーを <a href=https://kit.svelte.dev/docs/hooks>hooks</a> を使って起動すれば任意のサーバーに置き換えできると issue の中で回答されていた。kit アプリケーションは1つのサーバーが1つのシステムとして動かすことを前提に設計されているが、サーバーを複数起動することでそれらを共存できるのではないか？と考えた。検証のために node.js から子プロセスを生成するには次のようなコードで起動する。些事だけど adapter-node の生成したコードが shell を介しないとポート番号を設定できなかったので <code>shell: true</code> もセットしている。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>spawn</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;child_process&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>start_server() {</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;called start_server&#39;</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>opts</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>shell</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>env</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      ...<span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>PORT</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;3005&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ORIGIN</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;http://localhost:5174&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>NODE_ENV</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;production&#39;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>node</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>spawn</span>(<span style=color:#e6db74>&#39;node&#39;</span>, [<span style=color:#e6db74>&#39;apps/myapp/build/index.js&#39;</span>], <span style=color:#a6e22e>opts</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>stdout</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;data&#39;</span>, (<span style=color:#a6e22e>data</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>toString</span>());
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>stderr</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;data&#39;</span>, (<span style=color:#a6e22e>data</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>toString</span>());
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;exit&#39;</span>, (<span style=color:#a6e22e>code</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`Child exited with code </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>code</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>この node.js の子プロセスを起動する処理を hooks で呼び出すことである kit アプリケーションを起動したときに、別の kit アプリケーションを提供するアプリケーションサーバーの node.js プロセスも起動できる。そしてパスを解決できるようにするため、さらに es モジュールのインポートパスにあわせたプロキシを実装する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>start_server</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;$lib/index&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>start_server</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#66d9ef>type</span> { <span style=color:#a6e22e>Handle</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;@sveltejs/kit&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>handle</span>: <span style=color:#66d9ef>Handle</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>async</span> ({ <span style=color:#a6e22e>event</span>, <span style=color:#a6e22e>resolve</span> }) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>url</span>.<span style=color:#a6e22e>pathname</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#39;/myapp&#39;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>method</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;GET&#39;</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fetch</span>(<span style=color:#e6db74>&#39;http://localhost:3005&#39;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>url</span>.<span style=color:#a6e22e>pathname</span>);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>method</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;POST&#39;</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>data</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>formData</span>();
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>endpoint</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;http://localhost:3005&#39;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>url</span>.<span style=color:#a6e22e>pathname</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>url</span>.<span style=color:#a6e22e>search</span>;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fetch</span>(<span style=color:#a6e22e>endpoint</span>, { <span style=color:#a6e22e>method</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;POST&#39;</span>, <span style=color:#a6e22e>body</span>: <span style=color:#66d9ef>data</span> });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>response</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>resolve</span>(<span style=color:#a6e22e>event</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>response</span>;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>これは kit のデモアプリが動くことを確認するためだけに実装したプロキシで GET/POST のリクエストを localhost:3005 に起動した node.js のプロセスへプロキシしている。これで2つの kit アプリケーションが1つのサーバーで共存しているかのように振る舞うことは確認できた。この延長上に私のやりたいことが実現できるかどうかをさらに調査する必要がある。</p></div></article><div class=pagination><div class=pagination__buttons><a href=/diary/posts/page/15/ class="button previous"><span class=button__icon>←</span>
<span class=button__text>最近の日記</span>
</a><a href=/diary/posts/page/17/ class="button next"><span class=button__text>過去の日記</span>
<span class=button__icon>→</span></a></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2024 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>