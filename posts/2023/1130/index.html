<!doctype html><html lang=en><head><title>複数の kit アプリケーションを共存させる仕組みの考察 :: forest nook</title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="1時に寝て3時に起きて5時に起きて7時半に起きた。なんとなく布団に入らずにベッドの上でそのまま寝てた。それでもあまり寒くはなかった。
kit/vite アプリケーションのデバッグ 先日の続き の続き。
kit アプリケーションを kit アプリケーションに埋め込むといったことができないかどうかの調査をしている。いろいろ調べている中で kit の discussions でもそういった議論はいくつか行われている。マイクロフロントエンドというキーワードも出てくる。
MicroFrontends with Svelte + SvelteKit #4151 Approach to embedding Kit #5003 これらの議論をみていても kit の ssr はそれ自体が1つのアプリケーションとして動かすことを前提にビルドされているため、kit アプリケーション内に別の kit アプリケーションを埋め込んだり、一部のコンポーネントを外部のアプリケーションと組み合わせて動かすことはなかなか難しいようにみえる。マイクロフロントエンドのような思想で設計されていない。しかし、既存のアプリケーションを動かしつつ、少しずつ kit アプリケーションへ移行するといった運用をしたいという世の中のニーズも根強いことが伺える。
ここで svelte.config.js でエントリーポイントを置き換えるぐらいはできる。デフォルトは / がエントリーポイントになるのを /myapp に置き換えるには次のように設定する。relative は es モジュールのインポートを相対パスで行うか、絶対パスにするかの設定も変更できる。これもデプロイ先のインフラの都合にあわせて調整できるようになっている。この設定を切り替えられるのだからエンドポイントをハックすること自体はそう難しくないのかもしれない。
kit: { paths: { relative: false, base: &amp;#39;/myapp&amp;#39; }, } さらに調査していて、adapter-node を使ってビルドするとデフォルトでは polka というアプリケーションサーバーが起動するコードが生成される。
function polka (opts) { return new Polka(opts); } const path = env(&amp;#39;SOCKET_PATH&amp;#39;, false); const host = env(&amp;#39;HOST&amp;#39;, &amp;#39;0."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/posts/2023/1130/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="複数の kit アプリケーションを共存させる仕組みの考察"><meta property="og:description" content="1時に寝て3時に起きて5時に起きて7時半に起きた。なんとなく布団に入らずにベッドの上でそのまま寝てた。それでもあまり寒くはなかった。
kit/vite アプリケーションのデバッグ 先日の続き の続き。
kit アプリケーションを kit アプリケーションに埋め込むといったことができないかどうかの調査をしている。いろいろ調べている中で kit の discussions でもそういった議論はいくつか行われている。マイクロフロントエンドというキーワードも出てくる。
MicroFrontends with Svelte + SvelteKit #4151 Approach to embedding Kit #5003 これらの議論をみていても kit の ssr はそれ自体が1つのアプリケーションとして動かすことを前提にビルドされているため、kit アプリケーション内に別の kit アプリケーションを埋め込んだり、一部のコンポーネントを外部のアプリケーションと組み合わせて動かすことはなかなか難しいようにみえる。マイクロフロントエンドのような思想で設計されていない。しかし、既存のアプリケーションを動かしつつ、少しずつ kit アプリケーションへ移行するといった運用をしたいという世の中のニーズも根強いことが伺える。
ここで svelte.config.js でエントリーポイントを置き換えるぐらいはできる。デフォルトは / がエントリーポイントになるのを /myapp に置き換えるには次のように設定する。relative は es モジュールのインポートを相対パスで行うか、絶対パスにするかの設定も変更できる。これもデプロイ先のインフラの都合にあわせて調整できるようになっている。この設定を切り替えられるのだからエンドポイントをハックすること自体はそう難しくないのかもしれない。
kit: { paths: { relative: false, base: &amp;#39;/myapp&amp;#39; }, } さらに調査していて、adapter-node を使ってビルドするとデフォルトでは polka というアプリケーションサーバーが起動するコードが生成される。
function polka (opts) { return new Polka(opts); } const path = env(&amp;#39;SOCKET_PATH&amp;#39;, false); const host = env(&amp;#39;HOST&amp;#39;, &amp;#39;0."><meta property="og:url" content="/diary/posts/2023/1130/"><meta property="og:site_name" content="forest nook"><meta property="og:image" content="/diary/"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:published_time" content="2023-11-30 09:04:34 +0900 +0900"></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=/diary/posts/2023/1130/>複数の kit アプリケーションを共存させる仕組みの考察</a></h1><div class=post-meta><time class=post-date>2023-11-30</time></div><span class=post-tags>#<a href=/diary/tags/svelte/>svelte</a>&nbsp;
#<a href=/diary/tags/debug/>debug</a>&nbsp;
#<a href=/diary/tags/node.js/>node.js</a>&nbsp;
#<a href=/diary/tags/javascript/>javascript</a>&nbsp;</span><div class=post-content><div><p>1時に寝て3時に起きて5時に起きて7時半に起きた。なんとなく布団に入らずにベッドの上でそのまま寝てた。それでもあまり寒くはなかった。</p><h2 id=kitvite-アプリケーションのデバッグ>kit/vite アプリケーションのデバッグ<a href=#kitvite-アプリケーションのデバッグ class=hanchor arialabel=Anchor>&#8983;</a></h2><p><a href=/diary/posts/2023/1127/#kitvite-アプリケーションのデバッグ>先日の続き</a> の続き。</p><p>kit アプリケーションを kit アプリケーションに埋め込むといったことができないかどうかの調査をしている。いろいろ調べている中で kit の discussions でもそういった議論はいくつか行われている。マイクロフロントエンドというキーワードも出てくる。</p><ul><li><a href=https://github.com/sveltejs/kit/discussions/4151>MicroFrontends with Svelte + SvelteKit #4151</a></li><li><a href=https://github.com/sveltejs/kit/discussions/5003>Approach to embedding Kit #5003</a></li></ul><p>これらの議論をみていても kit の ssr はそれ自体が1つのアプリケーションとして動かすことを前提にビルドされているため、kit アプリケーション内に別の kit アプリケーションを埋め込んだり、一部のコンポーネントを外部のアプリケーションと組み合わせて動かすことはなかなか難しいようにみえる。マイクロフロントエンドのような思想で設計されていない。しかし、既存のアプリケーションを動かしつつ、少しずつ kit アプリケーションへ移行するといった運用をしたいという世の中のニーズも根強いことが伺える。</p><p>ここで svelte.config.js でエントリーポイントを置き換えるぐらいはできる。デフォルトは <code>/</code> がエントリーポイントになるのを <code>/myapp</code> に置き換えるには次のように設定する。relative は es モジュールのインポートを相対パスで行うか、絶対パスにするかの設定も変更できる。これもデプロイ先のインフラの都合にあわせて調整できるようになっている。この設定を切り替えられるのだからエンドポイントをハックすること自体はそう難しくないのかもしれない。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>kit</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>paths</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>relative</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>base</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;/myapp&#39;</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>さらに調査していて、adapter-node を使ってビルドするとデフォルトでは <a href=https://github.com/lukeed/polka>polka</a> というアプリケーションサーバーが起動するコードが生成される。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>polka</span> (<span style=color:#a6e22e>opts</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Polka</span>(<span style=color:#a6e22e>opts</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>path</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>env</span>(<span style=color:#e6db74>&#39;SOCKET_PATH&#39;</span>, <span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>host</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>env</span>(<span style=color:#e6db74>&#39;HOST&#39;</span>, <span style=color:#e6db74>&#39;0.0.0.0&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>port</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>env</span>(<span style=color:#e6db74>&#39;PORT&#39;</span>, <span style=color:#f92672>!</span><span style=color:#a6e22e>path</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#e6db74>&#39;3000&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>server</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>polka</span>().<span style=color:#a6e22e>use</span>(<span style=color:#a6e22e>handler</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>server</span>.<span style=color:#a6e22e>listen</span>({ <span style=color:#a6e22e>path</span>, <span style=color:#a6e22e>host</span>, <span style=color:#a6e22e>port</span> }, () =&gt; {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`Listening on </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>path</span> <span style=color:#f92672>?</span> <span style=color:#a6e22e>path</span> <span style=color:#f92672>:</span> <span style=color:#a6e22e>host</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;:&#39;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>port</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>ここで任意のアプリケーションサーバーを使いたいという issue があって、それに対する回答から adapter-node のドキュメントにカスタムサーバーについて書かれていることに気付く。</p><ul><li><a href=https://github.com/sveltejs/kit/issues/8794>Custom server options for adapter-node #8794</a></li><li><a href=https://kit.svelte.dev/docs/adapter-node#custom-server>Node servers: Custom server</a></li></ul><blockquote><p>アダプタは、ビルドディレクトリにindex.jsとhandler.jsの2つのファイルを作成します。index.js を実行すると (デフォルトのビルドディレクトリを使用している場合は node ビルドなど)、設定されたポートでサーバが起動します。</p><p>あるいは、Express、Connect、Polka（あるいは組み込みのhttp.createServer）に適したハンドラをエクスポートするhandler.jsファイルをインポートして、独自のサーバをセットアップすることもできます。</p></blockquote><p>handler.js さえインポートすればそのまま動くことはデバッグしていて知ってはいたのだけど、この自前のアプリケーションサーバーを <a href=https://kit.svelte.dev/docs/hooks>hooks</a> を使って起動すれば任意のサーバーに置き換えできると issue の中で回答されていた。kit アプリケーションは1つのサーバーが1つのシステムとして動かすことを前提に設計されているが、サーバーを複数起動することでそれらを共存できるのではないか？と考えた。検証のために node.js から子プロセスを生成するには次のようなコードで起動する。些事だけど adapter-node の生成したコードが shell を介しないとポート番号を設定できなかったので <code>shell: true</code> もセットしている。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>spawn</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;child_process&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>start_server() {</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;called start_server&#39;</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>opts</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>shell</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>env</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      ...<span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>PORT</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;3005&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ORIGIN</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;http://localhost:5174&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>NODE_ENV</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;production&#39;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>node</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>spawn</span>(<span style=color:#e6db74>&#39;node&#39;</span>, [<span style=color:#e6db74>&#39;apps/myapp/build/index.js&#39;</span>], <span style=color:#a6e22e>opts</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>stdout</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;data&#39;</span>, (<span style=color:#a6e22e>data</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>toString</span>());
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>stderr</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;data&#39;</span>, (<span style=color:#a6e22e>data</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>toString</span>());
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;exit&#39;</span>, (<span style=color:#a6e22e>code</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`Child exited with code </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>code</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>この node.js の子プロセスを起動する処理を hooks で呼び出すことである kit アプリケーションを起動したときに、別の kit アプリケーションを提供するアプリケーションサーバーの node.js プロセスも起動できる。そしてパスを解決できるようにするため、さらに es モジュールのインポートパスにあわせたプロキシを実装する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>start_server</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;$lib/index&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>start_server</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#66d9ef>type</span> { <span style=color:#a6e22e>Handle</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;@sveltejs/kit&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>handle</span>: <span style=color:#66d9ef>Handle</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>async</span> ({ <span style=color:#a6e22e>event</span>, <span style=color:#a6e22e>resolve</span> }) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>url</span>.<span style=color:#a6e22e>pathname</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#39;/myapp&#39;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>method</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;GET&#39;</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fetch</span>(<span style=color:#e6db74>&#39;http://localhost:3005&#39;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>url</span>.<span style=color:#a6e22e>pathname</span>);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>method</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;POST&#39;</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>data</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>formData</span>();
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>endpoint</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;http://localhost:3005&#39;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>url</span>.<span style=color:#a6e22e>pathname</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>url</span>.<span style=color:#a6e22e>search</span>;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fetch</span>(<span style=color:#a6e22e>endpoint</span>, { <span style=color:#a6e22e>method</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;POST&#39;</span>, <span style=color:#a6e22e>body</span>: <span style=color:#66d9ef>data</span> });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>response</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>resolve</span>(<span style=color:#a6e22e>event</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>response</span>;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>これは kit のデモアプリが動くことを確認するためだけに実装したプロキシで GET/POST のリクエストを localhost:3005 に起動した node.js のプロセスへプロキシしている。これで2つの kit アプリケーションが1つのサーバーで共存しているかのように振る舞うことは確認できた。この延長上に私のやりたいことが実現できるかどうかをさらに調査する必要がある。</p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=/diary/posts/2023/1201/><span class=button__icon>←</span>
<span class=button__text>SakeBash と LT 発表</span>
</a></span><span class="button next"><a href=/diary/posts/2023/1129/><span class=button__text>気付きというスキル</span>
<span class=button__icon>→</span></a></span></div></div></article></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>© 2021 Tetsuya Morimoto</span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>