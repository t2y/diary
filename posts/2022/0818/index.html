<!doctype html><html lang=en><head><title>spring boot におけるプロキシ実装 :: forest nook</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="0時に寝て7時に起きた。
spring boot における簡易的なミドルウェアの実装 bff (backend for frontend) の web api サーバーから別の web api サーバーのエンドポイントを呼び出す処理を書いていてただプロキシする処理のためだけに controller を書くのも面倒だなと気付いた。controller よりも低いレイヤで raw request を扱うにはどうしたらいいかを調べてみたら spring の Filter を使うのが最も簡単そうにみえた。その spring の Filter の1つである OncePerRequestFilter を使って簡易的なプロキシの処理を実装してみた。OncePerRequestFilter はリクエストに対して1度だけ呼ばれることが保証された Filter になる。これらのドキュメントがどこにあるかわからなかったので baeldung のチュートリアル What Is OncePerRequestFilter? をみた方が早いかもしれない。
Filter が複数あるときは実行順序を指定したいときは Order というアノテーションで制御できる。
@Component @Order(30) public class MyFilter extends OncePerRequestFilter { ... } OncePerRequestFilter の doFilterInternal メソッドをオーバーライドすれば任意のミドルウェアっぽい処理を実装できる。
@Override protected void doFilterInternal( HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException { // ここに任意の前処理を実装する filterChain."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/posts/2022/0818/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="spring boot におけるプロキシ実装"><meta property="og:description" content="0時に寝て7時に起きた。
spring boot における簡易的なミドルウェアの実装 bff (backend for frontend) の web api サーバーから別の web api サーバーのエンドポイントを呼び出す処理を書いていてただプロキシする処理のためだけに controller を書くのも面倒だなと気付いた。controller よりも低いレイヤで raw request を扱うにはどうしたらいいかを調べてみたら spring の Filter を使うのが最も簡単そうにみえた。その spring の Filter の1つである OncePerRequestFilter を使って簡易的なプロキシの処理を実装してみた。OncePerRequestFilter はリクエストに対して1度だけ呼ばれることが保証された Filter になる。これらのドキュメントがどこにあるかわからなかったので baeldung のチュートリアル What Is OncePerRequestFilter? をみた方が早いかもしれない。
Filter が複数あるときは実行順序を指定したいときは Order というアノテーションで制御できる。
@Component @Order(30) public class MyFilter extends OncePerRequestFilter { ... } OncePerRequestFilter の doFilterInternal メソッドをオーバーライドすれば任意のミドルウェアっぽい処理を実装できる。
@Override protected void doFilterInternal( HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException { // ここに任意の前処理を実装する filterChain."><meta property="og:url" content="/diary/posts/2022/0818/"><meta property="og:site_name" content="forest nook"><meta property="og:image" content="/diary"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:published_time" content="2022-08-18 10:27:56 +0900 +0900"></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=/diary/posts/2022/0818/>spring boot におけるプロキシ実装</a></h1><div class=post-meta><time class=post-date>2022-08-18</time></div><span class=post-tags>#<a href=/diary/tags/java/>java</a>&nbsp;
#<a href=/diary/tags/spring-boot/>spring boot</a>&nbsp;</span><div class=post-content><div><p>0時に寝て7時に起きた。</p><h2 id=spring-boot-における簡易的なミドルウェアの実装>spring boot における簡易的なミドルウェアの実装<a href=#spring-boot-における簡易的なミドルウェアの実装 class=hanchor arialabel=Anchor>&#8983;</a></h2><p>bff (backend for frontend) の web api サーバーから別の web api サーバーのエンドポイントを呼び出す処理を書いていてただプロキシする処理のためだけに <a href=https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#getting-started.first-application.code.mvc-annotations>controller</a> を書くのも面倒だなと気付いた。controller よりも低いレイヤで raw request を扱うにはどうしたらいいかを調べてみたら spring の <em>Filter</em> を使うのが最も簡単そうにみえた。その spring の Filter の1つである <em>OncePerRequestFilter</em> を使って簡易的なプロキシの処理を実装してみた。OncePerRequestFilter はリクエストに対して1度だけ呼ばれることが保証された Filter になる。これらのドキュメントがどこにあるかわからなかったので baeldung のチュートリアル <a href=https://www.baeldung.com/spring-onceperrequestfilter>What Is OncePerRequestFilter?</a> をみた方が早いかもしれない。</p><p>Filter が複数あるときは実行順序を指定したいときは <a href=https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#web.servlet.embedded-container.servlets-filters-listeners.beans>Order</a> というアノテーションで制御できる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Component</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Order</span><span style=color:#f92672>(</span><span style=color:#ae81ff>30</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyFilter</span> <span style=color:#66d9ef>extends</span> OncePerRequestFilter <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>OncePerRequestFilter の <em>doFilterInternal</em> メソッドをオーバーライドすれば任意のミドルウェアっぽい処理を実装できる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>doFilterInternal</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>        HttpServletRequest request<span style=color:#f92672>,</span> HttpServletResponse response<span style=color:#f92672>,</span> FilterChain filterChain<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throws</span> ServletException<span style=color:#f92672>,</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ここに任意の前処理を実装する
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        filterChain<span style=color:#f92672>.</span><span style=color:#a6e22e>doFilter</span><span style=color:#f92672>(</span>request<span style=color:#f92672>,</span> response<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ここに任意の後処理を実装する
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>あとは HttpServletRequest と HttpServletResponse を直接操作してリクエストから必要な情報を取り出して、クライアントでリクエストして返ってきたレスポンスをそのまま返してあげればよい。簡単に実装したものが次になる。クライアントには <a href=/diary/posts/2022/0722/>以前に少し調べたことを書いた WebClient</a> を使っている。WebClient じゃなければ、もう少しシンプルに書ける気もする。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Component</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Order</span><span style=color:#f92672>(</span><span style=color:#ae81ff>30</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RequestForwardFilter</span> <span style=color:#66d9ef>extends</span> OncePerRequestFilter <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> List<span style=color:#f92672>&lt;</span>RequestForwardMatcher<span style=color:#f92672>&gt;</span> matchers<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>doFilterInternal</span><span style=color:#f92672>(</span>HttpServletRequest request<span style=color:#f92672>,</span> HttpServletResponse response<span style=color:#f92672>,</span> FilterChain filterChain<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> ServletException<span style=color:#f92672>,</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        var matcher <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getMatcher</span><span style=color:#f92672>(</span>request<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>matcher<span style=color:#f92672>.</span><span style=color:#a6e22e>isEmpty</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            filterChain<span style=color:#f92672>.</span><span style=color:#a6e22e>doFilter</span><span style=color:#f92672>(</span>request<span style=color:#f92672>,</span> response<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        writeResponse<span style=color:#f92672>(</span>response<span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>forwardRequest</span><span style=color:#f92672>(</span>request<span style=color:#f92672>,</span> matcher<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getWebClient</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Optional<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>[]&gt;</span> <span style=color:#a6e22e>forwardRequest</span><span style=color:#f92672>(</span>HttpServletRequest request<span style=color:#f92672>,</span> WebClient webClient<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        var method <span style=color:#f92672>=</span> HttpMethod<span style=color:#f92672>.</span><span style=color:#a6e22e>resolve</span><span style=color:#f92672>(</span>request<span style=color:#f92672>.</span><span style=color:#a6e22e>getMethod</span><span style=color:#f92672>().</span><span style=color:#a6e22e>toUpperCase</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        var originalUri <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span><span style=color:#a6e22e>getRequestURI</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        var uri <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getUri</span><span style=color:#f92672>(</span>originalUri<span style=color:#f92672>,</span> request<span style=color:#f92672>.</span><span style=color:#a6e22e>getQueryString</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        var spec <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getSpec</span><span style=color:#f92672>(</span>method<span style=color:#f92672>,</span> webClient<span style=color:#f92672>,</span> uri<span style=color:#f92672>,</span> request<span style=color:#f92672>.</span><span style=color:#a6e22e>getReader</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> spec<span style=color:#f92672>.</span><span style=color:#a6e22e>retrieve</span><span style=color:#f92672>().</span><span style=color:#a6e22e>bodyToMono</span><span style=color:#f92672>(</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>[].</span><span style=color:#a6e22e>class</span><span style=color:#f92672>).</span><span style=color:#a6e22e>blockOptional</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>writeResponse</span><span style=color:#f92672>(</span>HttpServletResponse response<span style=color:#f92672>,</span> Optional<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>[]&gt;</span> bytes<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>bytes<span style=color:#f92672>.</span><span style=color:#a6e22e>isEmpty</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        var stream <span style=color:#f92672>=</span> response<span style=color:#f92672>.</span><span style=color:#a6e22e>getOutputStream</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        stream<span style=color:#f92672>.</span><span style=color:#a6e22e>write</span><span style=color:#f92672>(</span>bytes<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        stream<span style=color:#f92672>.</span><span style=color:#a6e22e>flush</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        stream<span style=color:#f92672>.</span><span style=color:#a6e22e>close</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> <span style=color:#a6e22e>getRequestBody</span><span style=color:#f92672>(</span>BufferedReader reader<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> reader<span style=color:#f92672>.</span><span style=color:#a6e22e>lines</span><span style=color:#f92672>().</span><span style=color:#a6e22e>collect</span><span style=color:#f92672>(</span>Collectors<span style=color:#f92672>.</span><span style=color:#a6e22e>joining</span><span style=color:#f92672>()).</span><span style=color:#a6e22e>getBytes</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String <span style=color:#a6e22e>getUri</span><span style=color:#f92672>(</span>String originalUri<span style=color:#f92672>,</span> String queryString<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        var path <span style=color:#f92672>=</span> originalUri<span style=color:#f92672>.</span><span style=color:#a6e22e>replace</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/api&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>StringUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>hasLength</span><span style=color:#f92672>(</span>queryString<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> String<span style=color:#f92672>.</span><span style=color:#a6e22e>format</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;%s?%s&#34;</span><span style=color:#f92672>,</span> path<span style=color:#f92672>,</span> queryString<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> path<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> WebClient<span style=color:#f92672>.</span><span style=color:#a6e22e>RequestHeadersSpec</span><span style=color:#f92672>&lt;?&gt;</span> getSpec<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>            HttpMethod method<span style=color:#f92672>,</span> WebClient webClient<span style=color:#f92672>,</span> String uri<span style=color:#f92672>,</span> BufferedReader reader<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>switch</span> <span style=color:#f92672>(</span>method<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> GET<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> webClient<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>().</span><span style=color:#a6e22e>uri</span><span style=color:#f92672>(</span>uri<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> POST<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> webClient<span style=color:#f92672>.</span><span style=color:#a6e22e>post</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>.</span><span style=color:#a6e22e>uri</span><span style=color:#f92672>(</span>uri<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>.</span><span style=color:#a6e22e>header</span><span style=color:#f92672>(</span>HttpHeaders<span style=color:#f92672>.</span><span style=color:#a6e22e>CONTENT_TYPE</span><span style=color:#f92672>,</span> MediaType<span style=color:#f92672>.</span><span style=color:#a6e22e>APPLICATION_JSON_VALUE</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>.</span><span style=color:#a6e22e>bodyValue</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getRequestBody</span><span style=color:#f92672>(</span>reader<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> PUT<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> webClient<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>.</span><span style=color:#a6e22e>uri</span><span style=color:#f92672>(</span>uri<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>.</span><span style=color:#a6e22e>header</span><span style=color:#f92672>(</span>HttpHeaders<span style=color:#f92672>.</span><span style=color:#a6e22e>CONTENT_TYPE</span><span style=color:#f92672>,</span> MediaType<span style=color:#f92672>.</span><span style=color:#a6e22e>APPLICATION_JSON_VALUE</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>.</span><span style=color:#a6e22e>bodyValue</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getRequestBody</span><span style=color:#f92672>(</span>reader<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> DELETE<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> webClient<span style=color:#f92672>.</span><span style=color:#a6e22e>delete</span><span style=color:#f92672>().</span><span style=color:#a6e22e>uri</span><span style=color:#f92672>(</span>uri<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span>String<span style=color:#f92672>.</span><span style=color:#a6e22e>format</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Unsupported HTTP method: %s&#34;</span><span style=color:#f92672>,</span> method<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Optional<span style=color:#f92672>&lt;</span>RequestForwardMatcher<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getMatcher</span><span style=color:#f92672>(</span>HttpServletRequest request<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>var matcher <span style=color:#f92672>:</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>matchers</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>matcher<span style=color:#f92672>.</span><span style=color:#a6e22e>match</span><span style=color:#f92672>(</span>request<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> Optional<span style=color:#f92672>.</span><span style=color:#a6e22e>of</span><span style=color:#f92672>(</span>matcher<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> Optional<span style=color:#f92672>.</span><span style=color:#a6e22e>empty</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>matcher のサンプル実装。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RequestForwardMatcher</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String ASTERISK <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;*&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Pattern pattern<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> List<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> methods<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> WebClient webClient<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>RequestForwardMatcher</span><span style=color:#f92672>(</span>String pattern<span style=color:#f92672>,</span> List<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> methods<span style=color:#f92672>,</span> WebClient webClient<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>pattern</span> <span style=color:#f92672>=</span> Pattern<span style=color:#f92672>.</span><span style=color:#a6e22e>compile</span><span style=color:#f92672>(</span>pattern<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>methods</span> <span style=color:#f92672>=</span> methods<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>webClient</span> <span style=color:#f92672>=</span> webClient<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>matchMethod</span><span style=color:#f92672>(</span>String method<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>methods</span><span style=color:#f92672>.</span><span style=color:#a6e22e>contains</span><span style=color:#f92672>(</span>ASTERISK<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>methods</span><span style=color:#f92672>.</span><span style=color:#a6e22e>contains</span><span style=color:#f92672>(</span>method<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>match</span><span style=color:#f92672>(</span>HttpServletRequest request<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>matchMethod<span style=color:#f92672>(</span>request<span style=color:#f92672>.</span><span style=color:#a6e22e>getMethod</span><span style=color:#f92672>()))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>pattern</span><span style=color:#f92672>.</span><span style=color:#a6e22e>matcher</span><span style=color:#f92672>(</span>request<span style=color:#f92672>.</span><span style=color:#a6e22e>getRequestURI</span><span style=color:#f92672>()).</span><span style=color:#a6e22e>matches</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> WebClient <span style=color:#a6e22e>getWebClient</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>webClient</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=/diary/posts/2022/0819/><span class=button__icon>←</span>
<span class=button__text>mvp とその目的</span></a></span>
<span class="button next"><a href=/diary/posts/2022/0817/><span class=button__text>たまには画面作り</span>
<span class=button__icon>→</span></a></span></div></div></article></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>© 2021 Tetsuya Morimoto</span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>