<!doctype html><html lang=en><head><title>url エンコーディングと uri の仕様 :: </title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="1時に寝ようとして、寝てたか起きてたかわからない時間を過ごして7時に起きた。
WebClient と query string のエンコーディング 以前にも WebClient の基本 について少し書いた。data={&amp;quot;x&amp;quot;: 1, &amp;quot;y&amp;quot;: 2} のような json 文字列を query string でリクエストしようとしたときに少しはまったので書いておく。java 標準ライブラリの URLEncoder を使ってエンコードするとスペースが + になる。これは html の仕様として正しいが、uri の仕様としては不正になる。そのため + を %20 に置き換える必要がある。
private String encode(String data) throws UnsupportedEncodingException { // NOTE: the URI doesn&amp;#39;t allow &amp;#39;+&amp;#39; character return URLEncoder.encode(data, StandardCharsets.UTF_8).replace(&amp;#34;+&amp;#34;, &amp;#34;%20&amp;#34;); } このロジックで {&amp;quot;x&amp;quot;: 1, &amp;quot;y&amp;quot;: 2} を url エンコードすると次の文字列になる。
%7B%22x%22%3A%201%2C%20%22y%22%3A%202%7D あらかじめ url エンコーディングした文字列を渡すと、今度は WebClient が % を %25 にさらにエンコーディングしてしまう。Spring WebClient Requests with Parameters 6."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/posts/2022/0928/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="url エンコーディングと uri の仕様"><meta property="og:description" content="1時に寝ようとして、寝てたか起きてたかわからない時間を過ごして7時に起きた。
WebClient と query string のエンコーディング 以前にも WebClient の基本 について少し書いた。data={&amp;quot;x&amp;quot;: 1, &amp;quot;y&amp;quot;: 2} のような json 文字列を query string でリクエストしようとしたときに少しはまったので書いておく。java 標準ライブラリの URLEncoder を使ってエンコードするとスペースが + になる。これは html の仕様として正しいが、uri の仕様としては不正になる。そのため + を %20 に置き換える必要がある。
private String encode(String data) throws UnsupportedEncodingException { // NOTE: the URI doesn&amp;#39;t allow &amp;#39;+&amp;#39; character return URLEncoder.encode(data, StandardCharsets.UTF_8).replace(&amp;#34;+&amp;#34;, &amp;#34;%20&amp;#34;); } このロジックで {&amp;quot;x&amp;quot;: 1, &amp;quot;y&amp;quot;: 2} を url エンコードすると次の文字列になる。
%7B%22x%22%3A%201%2C%20%22y%22%3A%202%7D あらかじめ url エンコーディングした文字列を渡すと、今度は WebClient が % を %25 にさらにエンコーディングしてしまう。Spring WebClient Requests with Parameters 6."><meta property="og:url" content="/diary/posts/2022/0928/"><meta property="og:site_name" content><meta property="og:image" content="/diary/"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:published_time" content="2022-09-28 08:20:18 +0900 +0900"></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=/diary/posts/2022/0928/>url エンコーディングと uri の仕様</a></h1><div class=post-meta><time class=post-date>2022-09-28</time></div><span class=post-tags>#<a href=/diary/tags/java/>java</a>&nbsp;
#<a href=/diary/tags/spring-boot/>spring boot</a>&nbsp;
#<a href=/diary/tags/medium/>medium</a>&nbsp;</span><div class=post-content><div><p>1時に寝ようとして、寝てたか起きてたかわからない時間を過ごして7時に起きた。</p><h2 id=webclient-と-query-string-のエンコーディング>WebClient と query string のエンコーディング<a href=#webclient-と-query-string-のエンコーディング class=hanchor arialabel=Anchor>&#8983;</a></h2><p>以前にも <a href=/diary/posts/2022/0722/#spring-webflux-とプロキシ>WebClient の基本</a> について少し書いた。<code>data={"x": 1, "y": 2}</code> のような json 文字列を query string でリクエストしようとしたときに少しはまったので書いておく。java 標準ライブラリの URLEncoder を使ってエンコードするとスペースが <code>+</code> になる。これは html の仕様として正しいが、uri の仕様としては不正になる。そのため <code>+</code> を <code>%20</code> に置き換える必要がある。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> String <span style=color:#a6e22e>encode</span>(String data) <span style=color:#66d9ef>throws</span> UnsupportedEncodingException {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// NOTE: the URI doesn&#39;t allow &#39;+&#39; character</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> URLEncoder.<span style=color:#a6e22e>encode</span>(data, StandardCharsets.<span style=color:#a6e22e>UTF_8</span>).<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;+&#34;</span>, <span style=color:#e6db74>&#34;%20&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>このロジックで <code>{"x": 1, "y": 2}</code> を url エンコードすると次の文字列になる。</p><pre tabindex=0><code>%7B%22x%22%3A%201%2C%20%22y%22%3A%202%7D
</code></pre><p>あらかじめ url エンコーディングした文字列を渡すと、今度は WebClient が <code>%</code> を <code>%25</code> にさらにエンコーディングしてしまう。<a href=https://www.baeldung.com/webflux-webclient-parameters#encoding-mode>Spring WebClient Requests with Parameters 6.Encoding Mode</a> によると、次の4つのエンコーディングモードをカスタマイズできる。デフォルトは <em>TEMPLATE_AND_VALUES</em> らしい。</p><ul><li>TEMPLATE_AND_VALUES: Pre-encode the URI template and strictly encode URI variables when expanded</li><li>VALUES_ONLY: Do not encode the URI template, but strictly encode URI variables after expanding them into the template</li><li>URI_COMPONENTS: Encode URI component value after expending URI variables</li><li>NONE: No encoding will be applied</li></ul><p>もとの url エンコード済みの文字列が次のようなものになってしまう。</p><pre tabindex=0><code>%257B%2522x%2522%253A%25...
</code></pre><p>既存の実装をあまり変えたくもなくてやや力技で実装した。局所的な変更だからまぁいっか。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>webClient.<span style=color:#a6e22e>get</span>().<span style=color:#a6e22e>uri</span>(uriBuilder <span style=color:#f92672>-&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>var</span> uriObj <span style=color:#f92672>=</span> uriBuilder.<span style=color:#a6e22e>path</span>(getControllerBasePath() <span style=color:#f92672>+</span> path).<span style=color:#a6e22e>queryParams</span>(query).<span style=color:#a6e22e>build</span>(pathParams);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (encodedData <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>var</span> uri <span style=color:#f92672>=</span> uriObj.<span style=color:#a6e22e>toString</span>();
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>var</span> connector <span style=color:#f92672>=</span> uri.<span style=color:#a6e22e>contains</span>(<span style=color:#e6db74>&#34;?&#34;</span>) <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;&amp;&#34;</span> : <span style=color:#e6db74>&#34;?&#34;</span>;
</span></span><span style=display:flex><span>      uriObj <span style=color:#f92672>=</span> URI.<span style=color:#a6e22e>create</span>(String.<span style=color:#a6e22e>format</span>(<span style=color:#e6db74>&#34;%s%sdata=%s&#34;</span>, uri, connector, encodedData));
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> uriObj;
</span></span><span style=display:flex><span>}).<span style=color:#a6e22e>retrieve</span>()
</span></span></code></pre></div><h2 id=よいエラーメッセージわるいエラーメッセージ>よいエラーメッセージ、わるいエラーメッセージ<a href=#よいエラーメッセージわるいエラーメッセージ class=hanchor arialabel=Anchor>&#8983;</a></h2><p>タイトルに惹かれてちょっと期待外れ。<em>art</em> というと日本人は芸術と高度なものを期待しがちだけど、<em>the art of</em> だと技術の体系といった意味合いもあるのでちょとしたノウハウを解説する技術ブログのようなものでも誤っていない。</p><ul><li><a href=https://medium.com/s/user-friendly/the-art-of-the-error-message-9f878d0bff80>The Art of the Error Message</a></li></ul><p>ユーザー体験をよくするためのエラーメッセージのコツとして次の3つを提案している。</p><ul><li>何が起きたのか、なぜ起きたのかを説明する</li><li>次のステップを提案する</li><li>適切なトーンで書く</li></ul><p>この3つの具体例としてどのようなものかを説明している。私にとってはそう目新しいものではないが、エラーメッセージにトーンという概念はなかったので最近の流行りなのかなと思った。</p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=/diary/posts/2022/0929/><span class=button__icon>←</span>
<span class=button__text>自分で自分を信用しない</span>
</a></span><span class="button next"><a href=/diary/posts/2022/0927/><span class=button__text>そして1年が経った</span>
<span class=button__icon>→</span></a></span></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2025 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>