<!doctype html><html lang=en><head><title>wiremock を使った kubernetes モックサーバーのテスト拡張 :: forest nook</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="2時に寝て7時に起きて9時までだらだらしてた。
Kubernetes Clients のライブラリ実装 昨日の続き 。ある程度、クライアントの振る舞いを確認できたので自前のライブラリを作ることにした。ライブラリなのでテストをちゃんと書きたいと思って単体テストのやり方を調べてたら Kubernetes Clients のリポジトリにも単体テストはほとんどなくて、どうも e2e テストの方を重視しているようにもみえた。github issues を検索してみたら次の issue をみつけた。
[DESIGN] Add k8s mock client and server test case #956 なにかしら単体テストの仕組みを作った方がいいんじゃないかという提案と一緒に issue の作者？かどうかはわからんけど、wiremock を使ったテストのサンプルコードをあげていた。名前だけは聞いたことがあったけど、過去に使ったこともなく、どういうものか全くわかってない。ドキュメントを軽く読んでみたら http モックサーバーらしい。issue の内容を参考にしながら wiremock のドキュメントをみて junit5 のテスト拡張を書いてみた。これが適切な実装かはあまり自信がないけど、こんな感じでモックサーバーとモッククライアントの junit5 のテスト拡張を実装した。これは static なモックサーバーの設定になるので wiremock 自体の起動コストは速く感じた。ライブラリのテストとしては申し分ない。いまのところは自画自賛。
@Documented @Target(ElementType.FIELD) @Retention(RetentionPolicy.RUNTIME) public @interface KubernetesApiClient { } public class SetupKubernetesWireMock implements BeforeAllCallback, BeforeEachCallback, ExtensionContext.Store.CloseableResource { private static final Logger logger = LogManager.getLogger(SetupKubernetesWireMock.class.getName()); private static int PORT = 8384; private static WireMockServer wireMockServer = new WireMockServer(options()."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/posts/2022/0807/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="wiremock を使った kubernetes モックサーバーのテスト拡張"><meta property="og:description" content="2時に寝て7時に起きて9時までだらだらしてた。
Kubernetes Clients のライブラリ実装 昨日の続き 。ある程度、クライアントの振る舞いを確認できたので自前のライブラリを作ることにした。ライブラリなのでテストをちゃんと書きたいと思って単体テストのやり方を調べてたら Kubernetes Clients のリポジトリにも単体テストはほとんどなくて、どうも e2e テストの方を重視しているようにもみえた。github issues を検索してみたら次の issue をみつけた。
[DESIGN] Add k8s mock client and server test case #956 なにかしら単体テストの仕組みを作った方がいいんじゃないかという提案と一緒に issue の作者？かどうかはわからんけど、wiremock を使ったテストのサンプルコードをあげていた。名前だけは聞いたことがあったけど、過去に使ったこともなく、どういうものか全くわかってない。ドキュメントを軽く読んでみたら http モックサーバーらしい。issue の内容を参考にしながら wiremock のドキュメントをみて junit5 のテスト拡張を書いてみた。これが適切な実装かはあまり自信がないけど、こんな感じでモックサーバーとモッククライアントの junit5 のテスト拡張を実装した。これは static なモックサーバーの設定になるので wiremock 自体の起動コストは速く感じた。ライブラリのテストとしては申し分ない。いまのところは自画自賛。
@Documented @Target(ElementType.FIELD) @Retention(RetentionPolicy.RUNTIME) public @interface KubernetesApiClient { } public class SetupKubernetesWireMock implements BeforeAllCallback, BeforeEachCallback, ExtensionContext.Store.CloseableResource { private static final Logger logger = LogManager.getLogger(SetupKubernetesWireMock.class.getName()); private static int PORT = 8384; private static WireMockServer wireMockServer = new WireMockServer(options()."><meta property="og:url" content="/diary/posts/2022/0807/"><meta property="og:site_name" content="forest nook"><meta property="og:image" content="/diary"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:published_time" content="2022-08-07 11:08:39 +0900 +0900"></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=/diary/posts/2022/0807/>wiremock を使った kubernetes モックサーバーのテスト拡張</a></h1><div class=post-meta><time class=post-date>2022-08-07</time></div><span class=post-tags>#<a href=/diary/tags/kubernetes/>kubernetes</a>&nbsp;
#<a href=/diary/tags/java/>java</a>&nbsp;
#<a href=/diary/tags/testing/>testing</a>&nbsp;</span><div class=post-content><div><p>2時に寝て7時に起きて9時までだらだらしてた。</p><h2 id=kubernetes-clients-のライブラリ実装>Kubernetes Clients のライブラリ実装<a href=#kubernetes-clients-のライブラリ実装 class=hanchor arialabel=Anchor>&#8983;</a></h2><p><a href=/diary/posts/2022/0806/#kubernetes-clients-のサンプル実装>昨日の続き</a> 。ある程度、クライアントの振る舞いを確認できたので自前のライブラリを作ることにした。ライブラリなのでテストをちゃんと書きたいと思って単体テストのやり方を調べてたら Kubernetes Clients のリポジトリにも単体テストはほとんどなくて、どうも e2e テストの方を重視しているようにもみえた。github issues を検索してみたら次の issue をみつけた。</p><ul><li><a href=https://github.com/apache/submarine/issues/956>[DESIGN] Add k8s mock client and server test case #956</a></li></ul><p>なにかしら単体テストの仕組みを作った方がいいんじゃないかという提案と一緒に issue の作者？かどうかはわからんけど、<a href=https://wiremock.org/>wiremock</a> を使ったテストのサンプルコードをあげていた。名前だけは聞いたことがあったけど、過去に使ったこともなく、どういうものか全くわかってない。ドキュメントを軽く読んでみたら http モックサーバーらしい。issue の内容を参考にしながら wiremock のドキュメントをみて junit5 のテスト拡張を書いてみた。これが適切な実装かはあまり自信がないけど、こんな感じでモックサーバーとモッククライアントの junit5 のテスト拡張を実装した。これは static なモックサーバーの設定になるので wiremock 自体の起動コストは速く感じた。ライブラリのテストとしては申し分ない。いまのところは自画自賛。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Documented</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Target</span><span style=color:#f92672>(</span>ElementType<span style=color:#f92672>.</span><span style=color:#a6e22e>FIELD</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Retention</span><span style=color:#f92672>(</span>RetentionPolicy<span style=color:#f92672>.</span><span style=color:#a6e22e>RUNTIME</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#a6e22e>@interface</span> KubernetesApiClient <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SetupKubernetesWireMock</span> <span style=color:#66d9ef>implements</span> BeforeAllCallback<span style=color:#f92672>,</span> BeforeEachCallback<span style=color:#f92672>,</span> ExtensionContext<span style=color:#f92672>.</span><span style=color:#a6e22e>Store</span><span style=color:#f92672>.</span><span style=color:#a6e22e>CloseableResource</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> Logger logger <span style=color:#f92672>=</span> LogManager<span style=color:#f92672>.</span><span style=color:#a6e22e>getLogger</span><span style=color:#f92672>(</span>SetupKubernetesWireMock<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> PORT <span style=color:#f92672>=</span> <span style=color:#ae81ff>8384</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> WireMockServer wireMockServer <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> WireMockServer<span style=color:#f92672>(</span>options<span style=color:#f92672>().</span><span style=color:#a6e22e>port</span><span style=color:#f92672>(</span>PORT<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>boolean</span> started <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> ApiClient apiClient<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>beforeAll</span><span style=color:#f92672>(</span>ExtensionContext context<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> Exception <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>started<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            wireMockServer<span style=color:#f92672>.</span><span style=color:#a6e22e>start</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            started <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>configureMockClient</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            var basePath <span style=color:#f92672>=</span> String<span style=color:#f92672>.</span><span style=color:#a6e22e>format</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;http://localhost:%d&#34;</span><span style=color:#f92672>,</span> wireMockServer<span style=color:#f92672>.</span><span style=color:#a6e22e>port</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>apiClient</span> <span style=color:#f92672>=</span> ClientBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>standard</span><span style=color:#f92672>().</span><span style=color:#a6e22e>setBasePath</span><span style=color:#f92672>(</span>basePath<span style=color:#f92672>).</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            logger<span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;started kubernetes wiremock: {}&#34;</span><span style=color:#f92672>,</span> basePath<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            context<span style=color:#f92672>.</span><span style=color:#a6e22e>getRoot</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getStore</span><span style=color:#f92672>(</span>GLOBAL<span style=color:#f92672>).</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;SetupKubernetesWireMock&#34;</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>beforeEach</span><span style=color:#f92672>(</span>ExtensionContext context<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> Exception <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>var instance <span style=color:#f92672>:</span> context<span style=color:#f92672>.</span><span style=color:#a6e22e>getRequiredTestInstances</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getAllInstances</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>var field <span style=color:#f92672>:</span> instance<span style=color:#f92672>.</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getDeclaredFields</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>field<span style=color:#f92672>.</span><span style=color:#a6e22e>isAnnotationPresent</span><span style=color:#f92672>(</span>KubernetesApiClient<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    field<span style=color:#f92672>.</span><span style=color:#a6e22e>setAccessible</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    field<span style=color:#f92672>.</span><span style=color:#a6e22e>set</span><span style=color:#f92672>(</span>instance<span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>apiClient</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>close</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> Throwable <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        wireMockServer<span style=color:#f92672>.</span><span style=color:#a6e22e>stop</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>configureMockClient</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// add static stubs for mock client
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        configureFor<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;localhost&#34;</span><span style=color:#f92672>,</span> PORT<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>stubForBatchGetCronjobs</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>stubForBatchGetSingleCronJob</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;my-job1&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>stubForBatchGetSingleCronJob</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;my-job2&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>stubForBatchGetSingleCronJob</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;my-job3&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>stubForBatchPostJob</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>stubForBatchGetJob</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> <span style=color:#a6e22e>getContents</span><span style=color:#f92672>(</span>String name<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        var json <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> File<span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getResource</span><span style=color:#f92672>(</span>name<span style=color:#f92672>).</span><span style=color:#a6e22e>getPath</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> Files<span style=color:#f92672>.</span><span style=color:#a6e22e>readAllBytes</span><span style=color:#f92672>(</span>Paths<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>json<span style=color:#f92672>.</span><span style=color:#a6e22e>getPath</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>stubForBatchGetCronjobs</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        var contents <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getContents</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/fixtures/kubernetes/batch/cronjobs.json&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        var path <span style=color:#f92672>=</span> urlPathEqualTo<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/apis/batch/v1/namespaces/default/cronjobs&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        stubFor<span style=color:#f92672>(</span>get<span style=color:#f92672>(</span>path<span style=color:#f92672>).</span><span style=color:#a6e22e>willReturn</span><span style=color:#f92672>(</span>aResponse<span style=color:#f92672>().</span><span style=color:#a6e22e>withStatus</span><span style=color:#f92672>(</span><span style=color:#ae81ff>200</span><span style=color:#f92672>).</span><span style=color:#a6e22e>withBody</span><span style=color:#f92672>(</span>contents<span style=color:#f92672>)));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>stubForBatchGetSingleCronJob</span><span style=color:#f92672>(</span>String jobName<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        var contents <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getContents</span><span style=color:#f92672>(</span>String<span style=color:#f92672>.</span><span style=color:#a6e22e>format</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/fixtures/kubernetes/batch/%s.json&#34;</span><span style=color:#f92672>,</span> jobName<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        var url <span style=color:#f92672>=</span> String<span style=color:#f92672>.</span><span style=color:#a6e22e>format</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/apis/batch/v1/namespaces/default/cronjobs/%s&#34;</span><span style=color:#f92672>,</span> jobName<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        var path <span style=color:#f92672>=</span> urlPathEqualTo<span style=color:#f92672>(</span>url<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        stubFor<span style=color:#f92672>(</span>get<span style=color:#f92672>(</span>path<span style=color:#f92672>).</span><span style=color:#a6e22e>willReturn</span><span style=color:#f92672>(</span>aResponse<span style=color:#f92672>().</span><span style=color:#a6e22e>withStatus</span><span style=color:#f92672>(</span><span style=color:#ae81ff>200</span><span style=color:#f92672>).</span><span style=color:#a6e22e>withBody</span><span style=color:#f92672>(</span>contents<span style=color:#f92672>)));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>stubForBatchPostJob</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        var name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/fixtures/kubernetes/batch/post-my-job.json&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        var contents <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getContents</span><span style=color:#f92672>(</span>name<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        var url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/apis/batch/v1/namespaces/default/jobs&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        var path <span style=color:#f92672>=</span> urlPathEqualTo<span style=color:#f92672>(</span>url<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        stubFor<span style=color:#f92672>(</span>post<span style=color:#f92672>(</span>path<span style=color:#f92672>).</span><span style=color:#a6e22e>willReturn</span><span style=color:#f92672>(</span>aResponse<span style=color:#f92672>().</span><span style=color:#a6e22e>withStatus</span><span style=color:#f92672>(</span><span style=color:#ae81ff>200</span><span style=color:#f92672>).</span><span style=color:#a6e22e>withBody</span><span style=color:#f92672>(</span>contents<span style=color:#f92672>)));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>stubForBatchGetJob</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        var name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/fixtures/kubernetes/batch/get-my-job.json&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        var contents <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getContents</span><span style=color:#f92672>(</span>name<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        var url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/apis/batch/v1/namespaces/default/jobs/my-job&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        var path <span style=color:#f92672>=</span> urlPathEqualTo<span style=color:#f92672>(</span>url<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        stubFor<span style=color:#f92672>(</span>get<span style=color:#f92672>(</span>urlPathEqualTo<span style=color:#f92672>(</span>url<span style=color:#f92672>)).</span><span style=color:#a6e22e>willReturn</span><span style=color:#f92672>(</span>aResponse<span style=color:#f92672>().</span><span style=color:#a6e22e>withStatus</span><span style=color:#f92672>(</span><span style=color:#ae81ff>200</span><span style=color:#f92672>).</span><span style=color:#a6e22e>withBody</span><span style=color:#f92672>(</span>contents<span style=color:#f92672>)));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=/diary/posts/2022/0808/><span class=button__icon>←</span>
<span class=button__text>k8s クラスターの service account とロール</span></a></span>
<span class="button next"><a href=/diary/posts/2022/0806/><span class=button__text>Kubernetes Clients のサンプル実装</span>
<span class=button__icon>→</span></a></span></div></div></article></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>© 2021 Tetsuya Morimoto</span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>