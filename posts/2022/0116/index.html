<!doctype html><html lang=en><head><title>JUnit5 のテスト拡張 :: </title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="1時に寝て5時に起きて2度寝して9時に起きた。前日呑んでたのであまり眠れなくて体調よくない。
JUnit5 的なロガーのテスト お仕事でログ管理の機能開発をしている。カスタムロガーを使って出力するメッセージを加工している。設計が固まってきて機能も作り込むようになってきたので出力内容が意図した構造化ログになっているかをテストしたい。JUnit5 の機能と log4j の機能を組み合わせてカスタムロガーのテストの仕組みを作ってみた。
まずログ出力した内容を取得するオブジェクトを特定するためのアノテーションを定義する。
@Documented @Target(ElementType.FIELD) @Retention(RetentionPolicy.RUNTIME) public @interface LoggerTestWriter { } JUnit5 の Declarative Extension Registration の仕組みを使って、テストケース非依存な setup/teadown のメソッドを定義する。ExtensionContext から拡張するテストケースのインスタンスを取得できる。テストケースインスタンスに定義されている @LoggerTestWriter アノテーションがついたオブジェクトを lgo4j の Appender としてインジェクションするようなコードを setup/teardown (beforeEach/afterEach メソッド) で定義する。Appender のインジェクション周りは Log4j 2でログ出力をテストするサンプルソース の記事を参考にした。
public class SetupLogAppender implements BeforeEachCallback, AfterEachCallback { private static String APPENDER_NAME = &amp;#34;logger-test-appender&amp;#34;; private Optional&amp;lt;Writer&amp;gt; getWriter(ExtensionContext context) throws IllegalAccessException { var testInstance = context.getRequiredTestInstance(); for (var field : testInstance.getClass().getDeclaredFields()) { if (field."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/posts/2022/0116/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="JUnit5 のテスト拡張"><meta property="og:description" content="1時に寝て5時に起きて2度寝して9時に起きた。前日呑んでたのであまり眠れなくて体調よくない。
JUnit5 的なロガーのテスト お仕事でログ管理の機能開発をしている。カスタムロガーを使って出力するメッセージを加工している。設計が固まってきて機能も作り込むようになってきたので出力内容が意図した構造化ログになっているかをテストしたい。JUnit5 の機能と log4j の機能を組み合わせてカスタムロガーのテストの仕組みを作ってみた。
まずログ出力した内容を取得するオブジェクトを特定するためのアノテーションを定義する。
@Documented @Target(ElementType.FIELD) @Retention(RetentionPolicy.RUNTIME) public @interface LoggerTestWriter { } JUnit5 の Declarative Extension Registration の仕組みを使って、テストケース非依存な setup/teadown のメソッドを定義する。ExtensionContext から拡張するテストケースのインスタンスを取得できる。テストケースインスタンスに定義されている @LoggerTestWriter アノテーションがついたオブジェクトを lgo4j の Appender としてインジェクションするようなコードを setup/teardown (beforeEach/afterEach メソッド) で定義する。Appender のインジェクション周りは Log4j 2でログ出力をテストするサンプルソース の記事を参考にした。
public class SetupLogAppender implements BeforeEachCallback, AfterEachCallback { private static String APPENDER_NAME = &amp;#34;logger-test-appender&amp;#34;; private Optional&amp;lt;Writer&amp;gt; getWriter(ExtensionContext context) throws IllegalAccessException { var testInstance = context.getRequiredTestInstance(); for (var field : testInstance.getClass().getDeclaredFields()) { if (field."><meta property="og:url" content="/diary/posts/2022/0116/"><meta property="og:site_name" content><meta property="og:image" content="/diary/"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:published_time" content="2022-01-16 10:08:01 +0900 +0900"></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=/diary/posts/2022/0116/>JUnit5 のテスト拡張</a></h1><div class=post-meta><time class=post-date>2022-01-16</time></div><span class=post-tags>#<a href=/diary/tags/java/>java</a>&nbsp;
#<a href=/diary/tags/testing/>testing</a>&nbsp;</span><div class=post-content><div><p>1時に寝て5時に起きて2度寝して9時に起きた。前日呑んでたのであまり眠れなくて体調よくない。</p><h2 id=junit5-的なロガーのテスト>JUnit5 的なロガーのテスト<a href=#junit5-的なロガーのテスト class=hanchor arialabel=Anchor>&#8983;</a></h2><p>お仕事でログ管理の機能開発をしている。カスタムロガーを使って出力するメッセージを加工している。設計が固まってきて機能も作り込むようになってきたので出力内容が意図した構造化ログになっているかをテストしたい。JUnit5 の機能と log4j の機能を組み合わせてカスタムロガーのテストの仕組みを作ってみた。</p><p>まずログ出力した内容を取得するオブジェクトを特定するためのアノテーションを定義する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Documented</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Target</span>(ElementType.<span style=color:#a6e22e>FIELD</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Retention</span>(RetentionPolicy.<span style=color:#a6e22e>RUNTIME</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#a6e22e>@interface</span> LoggerTestWriter {
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>JUnit5 の <a href=https://junit.org/junit5/docs/current/user-guide/#extensions-registration-declarative>Declarative Extension Registration</a> の仕組みを使って、テストケース非依存な setup/teadown のメソッドを定義する。<a href=https://junit.org/junit5/docs/current/api/org.junit.jupiter.api/org/junit/jupiter/api/extension/ExtensionContext.html>ExtensionContext</a> から拡張するテストケースのインスタンスを取得できる。テストケースインスタンスに定義されている <code>@LoggerTestWriter</code> アノテーションがついたオブジェクトを lgo4j の Appender としてインジェクションするようなコードを setup/teardown (beforeEach/afterEach メソッド) で定義する。Appender のインジェクション周りは <a href=https://qiita.com/kazurof/items/abbd42f11bfc125f3190>Log4j 2でログ出力をテストするサンプルソース</a> の記事を参考にした。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SetupLogAppender</span> <span style=color:#66d9ef>implements</span> BeforeEachCallback, AfterEachCallback {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> String APPENDER_NAME <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;logger-test-appender&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Optional<span style=color:#f92672>&lt;</span>Writer<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getWriter</span>(ExtensionContext context) <span style=color:#66d9ef>throws</span> IllegalAccessException {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> testInstance <span style=color:#f92672>=</span> context.<span style=color:#a6e22e>getRequiredTestInstance</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>var</span> field : testInstance.<span style=color:#a6e22e>getClass</span>().<span style=color:#a6e22e>getDeclaredFields</span>()) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (field.<span style=color:#a6e22e>isAnnotationPresent</span>(LoggerTestWriter.<span style=color:#a6e22e>class</span>)) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> Optional.<span style=color:#a6e22e>of</span>((Writer) field.<span style=color:#a6e22e>get</span>(testInstance));
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> Optional.<span style=color:#a6e22e>empty</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>beforeEach</span>(ExtensionContext context) <span style=color:#66d9ef>throws</span> Exception {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> writer <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getWriter</span>(context).<span style=color:#a6e22e>orElseThrow</span>(() <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>new</span> IllegalStateException(<span style=color:#e6db74>&#34;@LoggerTestWriter のアノテーションをもつ Writer を定義してください&#34;</span>));
</span></span><span style=display:flex><span>        addAppender(writer, APPENDER_NAME);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>afterEach</span>(ExtensionContext context) <span style=color:#66d9ef>throws</span> Exception {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> writer <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getWriter</span>(context).<span style=color:#a6e22e>orElseThrow</span>(IllegalStateException::<span style=color:#66d9ef>new</span>);
</span></span><span style=display:flex><span>        removeAppender(APPENDER_NAME);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (writer <span style=color:#66d9ef>instanceof</span> StringWriter) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>var</span> stringWriter <span style=color:#f92672>=</span> (StringWriter) writer;
</span></span><span style=display:flex><span>            stringWriter.<span style=color:#a6e22e>getBuffer</span>().<span style=color:#a6e22e>delete</span>(0, stringWriter.<span style=color:#a6e22e>getBuffer</span>().<span style=color:#a6e22e>length</span>());
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>実際にテストを書くテストクラスは次のようになる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@ExtendWith</span>(SetupLogAppender.<span style=color:#a6e22e>class</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyLoggerTest</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> MyLogger logger <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> MyLogger(MyLoggerTest.<span style=color:#a6e22e>class</span>.<span style=color:#a6e22e>getName</span>());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@LoggerTestWriter</span>
</span></span><span style=display:flex><span>    StringWriter writer <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> StringWriter();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>testDebugMap</span>() {
</span></span><span style=display:flex><span>        logger.<span style=color:#a6e22e>debug</span>(<span style=color:#e6db74>&#34;my-message&#34;</span>)
</span></span><span style=display:flex><span>        assertEquals(<span style=color:#e6db74>&#34;my-message&#34;</span> writer.<span style=color:#a6e22e>toString</span>());
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p><code>@ExtendWith</code> で指定した <code>SetupLogAppender</code> クラスの beforeEach や afterEach がそれぞれのテストメソッドごとに呼ばれて、Appender のインジェクションが <code>@LoggerTestWriter</code> のアノテーションをもつ writer を使って行われる。この writer にはログ出力した文字列が記録されるようになる。これで、テストメソッドで logger に対して出力したメッセージを writer から取得できるので意図したメッセージが出力されていることをテストできる。カスタムロガーのテストケースごとに再利用可能な拡張をきれいに実装できた。</p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=/diary/posts/2022/0117/><span class=button__icon>←</span>
<span class=button__text>国民健康保険の保険料</span>
</a></span><span class="button next"><a href=/diary/posts/2022/0115/><span class=button__text>ワーケーション延期</span>
<span class=button__icon>→</span></a></span></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2025 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>