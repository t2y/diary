<!doctype html><html lang=en><head><title>sql の group concat という組み込み関数 :: forest nook</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="2時に寝て7時に起きた。昨日の hannali dao が盛り上がった影響で夜更ししてた。
本番リリース後の緊急対応 昨日あるバッチ処理の本番リリースを行った。そのバッチ処理は本番環境のデータがないとテスト環境ではあまり有効な検証ができない。昨日は別のバグがあって実行できていなかったのを今日直して再実行したらまた別のバグを発見した。sql である集合を取得するときのグルーピングの条件が適切ではなかった。postgresql で mysql でいうところの group_concat に相当することをやりたい。How to Use string_agg() のチュートリアルをちょっとカスタマイズして引用する。次のようなデータがあると仮定する。
&amp;gt; select * from teams ; team_name | team_member | num -------------+-------------+----- Barcelona | Messi | 1 Barcelona | Piquet | 2 Barcelona | (null) | 3 Real Madrid | Ronaldo | 1 Real Madrid | Benzema | 2 Real Madrid | Ramos | 3 (6 行) このときに team_name に対して team_member も集約して数値の合計を取りたいときがある。string_agg という組み込み関数を使うとできる。null があっても無視して数値の合計はしてくれる。"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/posts/2022/1027/><link rel=stylesheet href=/diary/assets/style.css><link rel=stylesheet href=/diary/assets/green.css><link rel=stylesheet href=/diary/style.css><link rel=apple-touch-icon href=/diary/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="sql の group concat という組み込み関数"><meta property="og:description" content="2時に寝て7時に起きた。昨日の hannali dao が盛り上がった影響で夜更ししてた。
本番リリース後の緊急対応 昨日あるバッチ処理の本番リリースを行った。そのバッチ処理は本番環境のデータがないとテスト環境ではあまり有効な検証ができない。昨日は別のバグがあって実行できていなかったのを今日直して再実行したらまた別のバグを発見した。sql である集合を取得するときのグルーピングの条件が適切ではなかった。postgresql で mysql でいうところの group_concat に相当することをやりたい。How to Use string_agg() のチュートリアルをちょっとカスタマイズして引用する。次のようなデータがあると仮定する。
&amp;gt; select * from teams ; team_name | team_member | num -------------+-------------+----- Barcelona | Messi | 1 Barcelona | Piquet | 2 Barcelona | (null) | 3 Real Madrid | Ronaldo | 1 Real Madrid | Benzema | 2 Real Madrid | Ramos | 3 (6 行) このときに team_name に対して team_member も集約して数値の合計を取りたいときがある。string_agg という組み込み関数を使うとできる。null があっても無視して数値の合計はしてくれる。"><meta property="og:url" content="/diary/posts/2022/1027/"><meta property="og:site_name" content="forest nook"><meta property="og:image" content="/diary"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2022-10-27 08:49:12 +0900 +0900"></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=/diary/posts/2022/1027/>sql の group concat という組み込み関数</a></h1><div class=post-meta><span class=post-date>2022-10-27</span></div><span class=post-tags>#<a href=/diary/tags/postgresql/>postgresql</a>&nbsp;
#<a href=/diary/tags/scrum/>scrum</a>&nbsp;
#<a href=/diary/tags/event/>event</a>&nbsp;</span><div class=post-content><div><p>2時に寝て7時に起きた。昨日の hannali dao が盛り上がった影響で夜更ししてた。</p><h2 id=本番リリース後の緊急対応>本番リリース後の緊急対応<a href=#本番リリース後の緊急対応 class=hanchor arialabel=Anchor>&#8983;</a></h2><p>昨日あるバッチ処理の本番リリースを行った。そのバッチ処理は本番環境のデータがないとテスト環境ではあまり有効な検証ができない。昨日は別のバグがあって実行できていなかったのを今日直して再実行したらまた別のバグを発見した。sql である集合を取得するときのグルーピングの条件が適切ではなかった。postgresql で <a href=https://dev.mysql.com/doc/refman/8.0/en/aggregate-functions.html#function_group-concat>mysql でいうところの group_concat</a> に相当することをやりたい。<a href=https://bipp.io/sql-tutorial/postgresql/string_agg/>How to Use string_agg()</a> のチュートリアルをちょっとカスタマイズして引用する。次のようなデータがあると仮定する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>select</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> teams ;
</span></span><span style=display:flex><span>  team_name  <span style=color:#f92672>|</span> team_member <span style=color:#f92672>|</span> num
</span></span><span style=display:flex><span><span style=color:#75715e>-------------+-------------+-----
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> Barcelona   <span style=color:#f92672>|</span> Messi       <span style=color:#f92672>|</span>   <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span> Barcelona   <span style=color:#f92672>|</span> Piquet      <span style=color:#f92672>|</span>   <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span> Barcelona   <span style=color:#f92672>|</span> (<span style=color:#66d9ef>null</span>)      <span style=color:#f92672>|</span>   <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span> Real Madrid <span style=color:#f92672>|</span> Ronaldo     <span style=color:#f92672>|</span>   <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span> Real Madrid <span style=color:#f92672>|</span> Benzema     <span style=color:#f92672>|</span>   <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span> Real Madrid <span style=color:#f92672>|</span> Ramos       <span style=color:#f92672>|</span>   <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>(<span style=color:#ae81ff>6</span> <span style=color:#960050;background-color:#1e0010>行</span>)
</span></span></code></pre></div><p>このときに team_name に対して team_member も集約して数値の合計を取りたいときがある。<code>string_agg</code> という組み込み関数を使うとできる。null があっても無視して数値の合計はしてくれる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>select</span> team_name, string_agg(team_member, <span style=color:#e6db74>&#39;,&#39;</span>), <span style=color:#66d9ef>sum</span>(num) <span style=color:#66d9ef>from</span> teams <span style=color:#66d9ef>group</span> <span style=color:#66d9ef>by</span> team_name;
</span></span><span style=display:flex><span>  team_name  <span style=color:#f92672>|</span>      string_agg       <span style=color:#f92672>|</span> <span style=color:#66d9ef>sum</span>
</span></span><span style=display:flex><span><span style=color:#75715e>-------------+-----------------------+-----
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> Real Madrid <span style=color:#f92672>|</span> Ronaldo,Benzema,Ramos <span style=color:#f92672>|</span>   <span style=color:#ae81ff>6</span>
</span></span><span style=display:flex><span> Barcelona   <span style=color:#f92672>|</span> Messi,Piquet          <span style=color:#f92672>|</span>   <span style=color:#ae81ff>6</span>
</span></span><span style=display:flex><span>(<span style=color:#ae81ff>2</span> <span style=color:#960050;background-color:#1e0010>行</span>)
</span></span></code></pre></div><h2 id=送別会>送別会<a href=#送別会 class=hanchor arialabel=Anchor>&#8983;</a></h2><p>プロジェクトの区切りの打ち上げと、私が今週末で契約終了となるので送別会を兼ねて催してくれた。感謝。実はこれまでプロジェクトの打ち上げに私は参加してこなかった。それは複数の意図があった。オンライン飲み会だと人数が多いほど話しにくいし、若い人たちだけの方が年長者に配慮しなくてたくさん話せていいんじゃないかと考えていた。私のような老い先短いメンバーがチームに馴染んでなくても日々の業務に変わりはないし、業務で発言しにくいといったこともないし、他に山ほど仕事の積み上げがあって他のことに時間を使えるならそれに越したこともない。過去に2-3回打ち上げしていたと思うけど、私は今回が最初で最後の参加となった。</p><p>都合のある人はばらばら抜けたりもしていたけど、9人ほどずっと参加していて20時から始めて23時過ぎまでやっていた。この人数だと、みんなが話せるというわけでもなくて、本当に2つのグループに分けて雑談した方がよかったのかもしれない。私は1-2割ぐらいの時間を話していたと思うけど、ほとんど聞いているだけで話さないメンバーも半分ぐらいはいたと思う。それは年長者がたくさん話せるように配慮して若い人たちが話しにくいというのは実際にあるのではないかなとも思えた。終わりの時間を決めておかないと延々話しが続いてしまう。チキンレースみたいになってしまって誰かが抜けると言わないと終わらない雰囲気になってしまった。それが23時過ぎで、ある人がそろそろ抜けますと宣言して「私も」「僕も」と続いて、じゃあお開きにしましょみたいなノリで解散となった。いろいろな話しができて楽しかった。</p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button next"><a href=/diary/posts/2022/1026/><span class=button__text>hannali dao に参加した</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>© 2021 Tetsuya Morimoto</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=/diary/assets/main.js></script>
<script src=/diary/assets/prism.js></script></div></body></html>