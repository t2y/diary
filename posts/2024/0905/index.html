<!doctype html><html lang=en><head><title>go で parser を実装してみた :: </title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="昨日の ldap スキーマ parser 実装 の続き。parser generator は使わず自分で parser を実装してみることにした。go の標準ライブラリにある text/scanner を使って字句解析をしたら、次のカスタマイズを行うことでそれっぽく token に分解できた。
s.Mode ^= scanner.ScanFloats s.IsIdentRune = func(ch rune, i int) bool { return ch == &amp;#39;.&amp;#39; || unicode.IsLetter(ch) || unicode.IsDigit(ch) } しかし、text/scanner はあくまで go のソースコードを字句解析するためのツールになる。ldap スキーマの字句解析も一応は意図したように分割できたが 'objectClass' のようなシングルクォートで文字列を囲むような構文を go のソースコードでは記述できないため、エラーをチェックすると invalid char literal として必ずエラーになってしまう。これでは字句解析のエラーチェックをできなくなってしまうため text/scanner の利用は断念した。
そこで bufio#Scanner を使って字句解析を実装した。字句解析を行うツールを lexer または tokenizer と呼ぶ。go ではこのツールを scanner と呼ぶ慣習になってるようにみえる。分割する token をカスタマイズするには SplitFunc を定義する。ldap スキーマの字句解析は次のように定義できた。
const ( singleQuote byte = &amp;#39;\&amp;#39;&amp;#39; ) func tokenize( data []byte, atEOF bool, ) ( advance int, token []byte, err error, ) { advance, token, err = bufio."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/posts/2024/0905/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="go で parser を実装してみた"><meta property="og:description" content="昨日の ldap スキーマ parser 実装 の続き。parser generator は使わず自分で parser を実装してみることにした。go の標準ライブラリにある text/scanner を使って字句解析をしたら、次のカスタマイズを行うことでそれっぽく token に分解できた。
s.Mode ^= scanner.ScanFloats s.IsIdentRune = func(ch rune, i int) bool { return ch == &amp;#39;.&amp;#39; || unicode.IsLetter(ch) || unicode.IsDigit(ch) } しかし、text/scanner はあくまで go のソースコードを字句解析するためのツールになる。ldap スキーマの字句解析も一応は意図したように分割できたが 'objectClass' のようなシングルクォートで文字列を囲むような構文を go のソースコードでは記述できないため、エラーをチェックすると invalid char literal として必ずエラーになってしまう。これでは字句解析のエラーチェックをできなくなってしまうため text/scanner の利用は断念した。
そこで bufio#Scanner を使って字句解析を実装した。字句解析を行うツールを lexer または tokenizer と呼ぶ。go ではこのツールを scanner と呼ぶ慣習になってるようにみえる。分割する token をカスタマイズするには SplitFunc を定義する。ldap スキーマの字句解析は次のように定義できた。
const ( singleQuote byte = &amp;#39;\&amp;#39;&amp;#39; ) func tokenize( data []byte, atEOF bool, ) ( advance int, token []byte, err error, ) { advance, token, err = bufio."><meta property="og:url" content="/diary/posts/2024/0905/"><meta property="og:site_name" content><meta property="og:image" content="/diary/"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:published_time" content="2024-09-05 14:54:11 +0900 +0900"></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=/diary/posts/2024/0905/>go で parser を実装してみた</a></h1><div class=post-meta><time class=post-date>2024-09-05</time></div><span class=post-tags>#<a href=/diary/tags/ldap/>ldap</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;</span><div class=post-content><div><p><a href=/diary/posts/2024/0904/>昨日の ldap スキーマ parser 実装</a> の続き。parser generator は使わず自分で parser を実装してみることにした。go の標準ライブラリにある <a href=https://pkg.go.dev/text/scanner>text/scanner</a> を使って字句解析をしたら、次のカスタマイズを行うことでそれっぽく token に分解できた。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Mode</span> ^= <span style=color:#a6e22e>scanner</span>.<span style=color:#a6e22e>ScanFloats</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>IsIdentRune</span> = <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>ch</span> <span style=color:#66d9ef>rune</span>, <span style=color:#a6e22e>i</span> <span style=color:#66d9ef>int</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ch</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;.&#39;</span> <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>unicode</span>.<span style=color:#a6e22e>IsLetter</span>(<span style=color:#a6e22e>ch</span>) <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>unicode</span>.<span style=color:#a6e22e>IsDigit</span>(<span style=color:#a6e22e>ch</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>しかし、text/scanner はあくまで go のソースコードを字句解析するためのツールになる。ldap スキーマの字句解析も一応は意図したように分割できたが <code>'objectClass'</code> のようなシングルクォートで文字列を囲むような構文を go のソースコードでは記述できないため、エラーをチェックすると <code>invalid char literal</code> として必ずエラーになってしまう。これでは字句解析のエラーチェックをできなくなってしまうため text/scanner の利用は断念した。</p><p>そこで <a href=https://pkg.go.dev/bufio#Scanner>bufio#Scanner</a> を使って字句解析を実装した。字句解析を行うツールを lexer または tokenizer と呼ぶ。go ではこのツールを scanner と呼ぶ慣習になってるようにみえる。分割する token をカスタマイズするには <a href=https://pkg.go.dev/bufio#SplitFunc>SplitFunc</a> を定義する。ldap スキーマの字句解析は次のように定義できた。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>singleQuote</span> <span style=color:#66d9ef>byte</span> = <span style=color:#e6db74>&#39;\&#39;&#39;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>tokenize</span>(
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>data</span> []<span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>atEOF</span> <span style=color:#66d9ef>bool</span>,
</span></span><span style=display:flex><span>) (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>advance</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>token</span> []<span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>,
</span></span><span style=display:flex><span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>advance</span>, <span style=color:#a6e22e>token</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>bufio</span>.<span style=color:#a6e22e>ScanWords</span>(<span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>atEOF</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>token</span>) &gt; <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>token</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>==</span> <span style=color:#a6e22e>singleQuote</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>since</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>data</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>!=</span> <span style=color:#a6e22e>singleQuote</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>since</span> = <span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>IndexByte</span>(<span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>singleQuote</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>IndexByte</span>(<span style=color:#a6e22e>data</span>[<span style=color:#a6e22e>since</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>:], <span style=color:#a6e22e>singleQuote</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>bufio</span>.<span style=color:#a6e22e>ErrFinalToken</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>pos</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>since</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>pos</span>, <span style=color:#a6e22e>data</span>[<span style=color:#a6e22e>since</span>:<span style=color:#a6e22e>pos</span>], <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewScanner</span>(<span style=color:#a6e22e>src</span> <span style=color:#66d9ef>string</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>bufio</span>.<span style=color:#a6e22e>Scanner</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bufio</span>.<span style=color:#a6e22e>NewScanner</span>(<span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>NewReader</span>(<span style=color:#a6e22e>src</span>))
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Split</span>(<span style=color:#a6e22e>tokenize</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>s</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>次のような ldap スキーマの文字列は、</p><p><code>( 2.5.4.0 NAME 'objectClass' DESC 'RFC4512: object classes of the entity' EQUALITY objectIdentifierMatch SYNTAX 1.3.6.1.4.1.1466.115.121.1.38 )</code></p><p>次のように token として分割される。</p><pre tabindex=0><code>(
2.5.4.0
NAME
&#39;objectClass&#39;
DESC
&#39;RFC4512: object classes of the entity&#39;
EQUALITY
objectIdentifierMatch
SYNTAX
1.3.6.1.4.1.1466.115.121.1.38
)
</code></pre><p>あとはこれらの token から構文解析を行う parser を実装するだけ。AttributeTypeDescription の文法は次になる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-abnf data-lang=abnf><span style=display:flex><span><span style=color:#a6e22e>AttributeTypeDescription</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>&#34;(&#34;</span> <span style=color:#a6e22e>whsp</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>numericoid</span> <span style=color:#a6e22e>whsp</span>              <span style=color:#75715e>; AttributeType identifier</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;NAME&#34;</span> <span style=color:#a6e22e>qdescrs</span> ]             <span style=color:#75715e>; name used in AttributeType</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;DESC&#34;</span> <span style=color:#a6e22e>qdstring</span> ]            <span style=color:#75715e>; description</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;OBSOLETE&#34;</span> <span style=color:#a6e22e>whsp</span> ]
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;SUP&#34;</span> <span style=color:#a6e22e>woid</span> ]                 <span style=color:#75715e>; derived from this other</span>
</span></span><span style=display:flex><span>                                   <span style=color:#75715e>; AttributeType</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;EQUALITY&#34;</span> <span style=color:#a6e22e>woid</span>              <span style=color:#75715e>; Matching Rule name</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;ORDERING&#34;</span> <span style=color:#a6e22e>woid</span>              <span style=color:#75715e>; Matching Rule name</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;SUBSTR&#34;</span> <span style=color:#a6e22e>woid</span> ]              <span style=color:#75715e>; Matching Rule name</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;SYNTAX&#34;</span> <span style=color:#a6e22e>whsp</span> <span style=color:#a6e22e>noidlen</span> <span style=color:#a6e22e>whsp</span> ] <span style=color:#75715e>; Syntax OID</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;SINGLE-VALUE&#34;</span> <span style=color:#a6e22e>whsp</span> ]        <span style=color:#75715e>; default multi-valued</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;COLLECTIVE&#34;</span> <span style=color:#a6e22e>whsp</span> ]          <span style=color:#75715e>; default not collective</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;NO-USER-MODIFICATION&#34;</span> <span style=color:#a6e22e>whsp</span> ]<span style=color:#75715e>; default user modifiable</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;USAGE&#34;</span> <span style=color:#a6e22e>whsp</span> <span style=color:#a6e22e>AttributeUsage</span> ]<span style=color:#75715e>; default userApplications</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>whsp</span> <span style=color:#ae81ff>&#34;)&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>AttributeUsage</span> <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>&#34;userApplications&#34;</span>     <span style=color:#f92672>/</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>&#34;directoryOperation&#34;</span>   <span style=color:#f92672>/</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>&#34;distributedOperation&#34;</span> <span style=color:#f92672>/</span> <span style=color:#75715e>; DSA-shared</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>&#34;dSAOperation&#34;</span>          <span style=color:#75715e>; DSA-specific, value depends on server</span>
</span></span></code></pre></div><p>字句解析する scanner と組み合わせて実装した parser は次のようになる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>ParseAttributeTypeDescription</span>(
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>src</span> <span style=color:#66d9ef>string</span>,
</span></span><span style=display:flex><span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>AttributeTypeDescription</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>d</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>AttributeTypeDescription</span>{}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NewScanner</span>(<span style=color:#a6e22e>src</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Scan</span>() {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>token</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Text</span>()
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>token</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>leftParenthesis</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Scan</span>() {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>OID</span> = <span style=color:#a6e22e>OID</span>{<span style=color:#a6e22e>Value</span>: <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Text</span>()}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>rightParenthesis</span>:
</span></span><span style=display:flex><span>			<span style=color:#75715e>// do nothing
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;NAME&#34;</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Scan</span>() {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Name</span> = <span style=color:#a6e22e>ParseNAME</span>(<span style=color:#a6e22e>s</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;DESC&#34;</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Scan</span>() {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Desc</span> = <span style=color:#a6e22e>Unquote</span>(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Text</span>())
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;OBSOLETE&#34;</span>:
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Obsolete</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;SUP&#34;</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Scan</span>() {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Sup</span> = <span style=color:#a6e22e>NewWOID</span>(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Text</span>())
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;EQUALITY&#34;</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Scan</span>() {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Equality</span> = <span style=color:#a6e22e>NewWOID</span>(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Text</span>())
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;ORDERING&#34;</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Scan</span>() {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Ordering</span> = <span style=color:#a6e22e>NewWOID</span>(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Text</span>())
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;SUBSTR&#34;</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Scan</span>() {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>SubStr</span> = <span style=color:#a6e22e>NewWOID</span>(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Text</span>())
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;SYNTAX&#34;</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Scan</span>() {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Syntax</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>ParseNOIDLen</span>(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Text</span>())
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to parse SYNTAX: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;SINGLE-VALUE&#34;</span>:
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>SingleValue</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;COLLECTIVE&#34;</span>:
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Collective</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;NO-USER-MODIFICATION&#34;</span>:
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>NoUserModification</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;USAGE&#34;</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Scan</span>() {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>usage</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>GetAttributeTypeUsage</span>(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Text</span>())
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Usage</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>usage</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>HasPrefix</span>(<span style=color:#a6e22e>token</span>, <span style=color:#e6db74>&#34;X-&#34;</span>) {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Scan</span>() {
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Extension</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>						<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Extension</span> = make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>][]<span style=color:#66d9ef>string</span>)
</span></span><span style=display:flex><span>					}
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Extension</span>[<span style=color:#a6e22e>token</span>] = <span style=color:#a6e22e>ParseQuotedStrings</span>(<span style=color:#a6e22e>s</span>)
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>slog</span>.<span style=color:#a6e22e>Warn</span>(<span style=color:#e6db74>&#34;unsupported&#34;</span>, <span style=color:#e6db74>&#34;token&#34;</span>, <span style=color:#a6e22e>token</span>, <span style=color:#e6db74>&#34;oid&#34;</span>, <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>OID</span>, <span style=color:#e6db74>&#34;name&#34;</span>, <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Name</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Err</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to scan: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>d</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>昨日の調査で go 製の parser generator をあまりみつけられなかったことに気付いた。その理由を理解できた。go で初めて parser を実装してみて簡単に実装できることに気付いた。標準ライブラリにある text/scanner や bufio#Scanner を使うと簡単に字句解析できるため、自分で parser を実装する労力が小さい。したがって parser generator を使って実装するよりも、自分で parser を実装することを選ぶ開発者が多いのではないかと推測する。</p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=/diary/posts/2024/0906/><span class=button__icon>←</span>
<span class=button__text>ldap スキーマの情報を返す web api の実装</span>
</a></span><span class="button next"><a href=/diary/posts/2024/0904/><span class=button__text>openldap スキーマと parser generator</span>
<span class=button__icon>→</span></a></span></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2025 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>