<!doctype html><html lang=en><head><title>excel が utf-8 で保存する csv ファイルは bom 付き :: </title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="昨日の定例会議で csv ファイルのエンコーディングの話しになって excel 2016 以降では utf-8 で csv ファイルを保存できるようになった。もう cp932 対応しなくてよいといった話題が出た。そのときにうろ覚えだったものの、excel は byte order mark (bom) を付けていた気がして、実際にファイルを作ってもらったらそうだった。bom の有無は file コマンドや od コマンドでなどで調べられる。
$ file book1.csv book1.csv: Unicode text, UTF-8 (with BOM) text, with CRLF line terminators ファイルの先頭に 0xef 0xbb 0xbf の3バイトがつく。
$ head -1 | od -t x1 book1.csv 0000000 ef bb bf 68 65 61 64 65 72 31 2c 68 65 61 64 65 0000020 72 32 2c 68 65 61 64 65 72 33 2c 68 65 61 64 65 ."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/posts/2024/0925/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="excel が utf-8 で保存する csv ファイルは bom 付き"><meta property="og:description" content="昨日の定例会議で csv ファイルのエンコーディングの話しになって excel 2016 以降では utf-8 で csv ファイルを保存できるようになった。もう cp932 対応しなくてよいといった話題が出た。そのときにうろ覚えだったものの、excel は byte order mark (bom) を付けていた気がして、実際にファイルを作ってもらったらそうだった。bom の有無は file コマンドや od コマンドでなどで調べられる。
$ file book1.csv book1.csv: Unicode text, UTF-8 (with BOM) text, with CRLF line terminators ファイルの先頭に 0xef 0xbb 0xbf の3バイトがつく。
$ head -1 | od -t x1 book1.csv 0000000 ef bb bf 68 65 61 64 65 72 31 2c 68 65 61 64 65 0000020 72 32 2c 68 65 61 64 65 72 33 2c 68 65 61 64 65 ."><meta property="og:url" content="/diary/posts/2024/0925/"><meta property="og:site_name" content><meta property="og:image" content="/diary/"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:published_time" content="2024-09-25 23:50:37 +0900 +0900"></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=/diary/posts/2024/0925/>excel が utf-8 で保存する csv ファイルは bom 付き</a></h1><div class=post-meta><time class=post-date>2024-09-25</time></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/programming/>programming</a>&nbsp;
#<a href=/diary/tags/drink/>drink</a>&nbsp;
#<a href=/diary/tags/drinking/>drinking</a>&nbsp;</span><div class=post-content><div><p>昨日の定例会議で csv ファイルのエンコーディングの話しになって excel 2016 以降では utf-8 で csv ファイルを保存できるようになった。もう cp932 対応しなくてよいといった話題が出た。そのときにうろ覚えだったものの、excel は <a href=https://ja.wikipedia.org/wiki/%E3%83%90%E3%82%A4%E3%83%88%E9%A0%86%E3%83%9E%E3%83%BC%E3%82%AF>byte order mark (bom)</a> を付けていた気がして、実際にファイルを作ってもらったらそうだった。bom の有無は file コマンドや od コマンドでなどで調べられる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ file book1.csv
</span></span><span style=display:flex><span>book1.csv: Unicode text, UTF-8 <span style=color:#f92672>(</span>with BOM<span style=color:#f92672>)</span> text, with CRLF line terminators
</span></span></code></pre></div><p>ファイルの先頭に <code>0xef</code> <code>0xbb</code> <code>0xbf</code> の3バイトがつく。</p><pre tabindex=0><code>$ head -1 | od -t x1 book1.csv
0000000    ef  bb  bf  68  65  61  64  65  72  31  2c  68  65  61  64  65
0000020    72  32  2c  68  65  61  64  65  72  33  2c  68  65  61  64  65
...
</code></pre><p>印字可能な文字ではないため、テキストにするとわからないが、byte 列だと bom が付いているのがわかる。16進数の 0x68 が &lsquo;h&rsquo; になる。bom がついていると <code>header1</code> という文字列比較したときに別の文字列になってしまうので取り除かないといけない。</p><pre tabindex=0><code>文字列: &#39;header1&#39;
byte列: &#39;efbbbf68656164657231&#39;
</code></pre><p>いろんな対応方法があると思うが、<a href=https://stackoverflow.com/questions/21371673/reading-files-with-a-bom-in-go/76023436#76023436>so の回答</a> でみつけたこの方法がコードの見通しもよくて気に入った。次のように io.Reader をラップするようなコードになる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>newBOMAwaredCSVReader</span>(<span style=color:#a6e22e>reader</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>Reader</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>csv</span>.<span style=color:#a6e22e>Reader</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>transformer</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>unicode</span>.<span style=color:#a6e22e>BOMOverride</span>(<span style=color:#a6e22e>encoding</span>.<span style=color:#a6e22e>Nop</span>.<span style=color:#a6e22e>NewDecoder</span>())
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>csv</span>.<span style=color:#a6e22e>NewReader</span>(<span style=color:#a6e22e>transform</span>.<span style=color:#a6e22e>NewReader</span>(<span style=color:#a6e22e>reader</span>, <span style=color:#a6e22e>transformer</span>))
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><a href=https://pkg.go.dev/golang.org/x/text@v0.18.0/transform#Transformer>Transformer</a> という仕組みがあって、準標準ライブラリの golang.org/x/text/encoding で実装されている。so の回答をみただけでコードを追加するのもよくないかと思って <a href=https://pkg.go.dev/golang.org/x/text/encoding/unicode#BOMOverride>unicode#BOMOverride</a> が返す bomOverride transformer のコードを読んで把握した上でテストを書いてマージリクエストを送った。実際の変換処理は次のようなもの。</p><ul><li>fallback として <code>encoding.Nop</code> を使う<ul><li>ソースの byte 列をそのまま使う (実際には変換しない)</li><li><a href=https://pkg.go.dev/golang.org/x/text/encoding#Encoding>https://pkg.go.dev/golang.org/x/text/encoding#Encoding</a></li></ul></li><li>最初に呼ばれたときに d.current (fallback) をセットして、2回目以降は fallback が呼ばれる</li><li>与えられた byte 列が 2byte 以上のときに bom のチェックを行う</li><li>bom があるときはそのバイト数を読み飛ばして d.current (fallback) で変換する</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>d</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>bomOverride</span>) <span style=color:#a6e22e>Transform</span>(<span style=color:#a6e22e>dst</span>, <span style=color:#a6e22e>src</span> []<span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>atEOF</span> <span style=color:#66d9ef>bool</span>) (<span style=color:#a6e22e>nDst</span>, <span style=color:#a6e22e>nSrc</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>current</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>current</span>.<span style=color:#a6e22e>Transform</span>(<span style=color:#a6e22e>dst</span>, <span style=color:#a6e22e>src</span>, <span style=color:#a6e22e>atEOF</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>src</span>) &lt; <span style=color:#ae81ff>3</span> <span style=color:#f92672>&amp;&amp;</span> !<span style=color:#a6e22e>atEOF</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>transform</span>.<span style=color:#a6e22e>ErrShortSrc</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>current</span> = <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>fallback</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>bomSize</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>src</span>) <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>2</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>src</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>==</span> <span style=color:#ae81ff>0xFF</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>src</span>[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>==</span> <span style=color:#ae81ff>0xFE</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>current</span> = <span style=color:#a6e22e>utf16le</span>.<span style=color:#a6e22e>NewDecoder</span>()
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>bomSize</span> = <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>src</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>==</span> <span style=color:#ae81ff>0xFE</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>src</span>[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>==</span> <span style=color:#ae81ff>0xFF</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>current</span> = <span style=color:#a6e22e>utf16be</span>.<span style=color:#a6e22e>NewDecoder</span>()
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>bomSize</span> = <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>src</span>) <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>3</span> <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>src</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>==</span> <span style=color:#a6e22e>utf8BOM</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>src</span>[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>==</span> <span style=color:#a6e22e>utf8BOM</span>[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>src</span>[<span style=color:#ae81ff>2</span>] <span style=color:#f92672>==</span> <span style=color:#a6e22e>utf8BOM</span>[<span style=color:#ae81ff>2</span>] {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>current</span> = <span style=color:#a6e22e>transform</span>.<span style=color:#a6e22e>Nop</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>bomSize</span> = <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>bomSize</span> &lt; len(<span style=color:#a6e22e>src</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>nDst</span>, <span style=color:#a6e22e>nSrc</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>current</span>.<span style=color:#a6e22e>Transform</span>(<span style=color:#a6e22e>dst</span>, <span style=color:#a6e22e>src</span>[<span style=color:#a6e22e>bomSize</span>:], <span style=color:#a6e22e>atEOF</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>nDst</span>, <span style=color:#a6e22e>nSrc</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>bomSize</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>自分で実装してもなにも難しくないけど、すでに実績のあるコードがあるならそれを再利用した方が保守コストを削減できる。</p><h2 id=同期飲み会>同期飲み会<a href=#同期飲み会 class=hanchor arialabel=Anchor>&#8983;</a></h2><p>新卒入社した会社の同期との飲み会。<a href=/diary/posts/2024/0730/#同期との飲み会>2ヶ月前と同じメンバー</a> で飲んできた。4人で飲む予定が、また1人が障害対応でドタキャンになったから3人で飲んでた。<a href=https://sake-genkabar.com/>日本酒原価酒蔵</a> という、おいしい日本酒を原価で提供するお店があるみたい。プレミアム飲み放題プランだったのでよいお酒をいろいろ飲み比べできた。どれもおいしかったし、ちょっとずついろいろ飲み比べできておもしろかった。飲み放題メニューに神戸のお酒がなかったのがよいことなのか残念なのか。前半は辛口の日本酒を飲んで、だんだん酔っ払って味がわからなくなるから、後半にコクや甘みの強い日本酒を飲むとおいしく飲めると教えてもらった。本当にその通りで日本酒の飲み方のよい勉強になった。お店で飲んだお酒のカードがもらえる。酔っ払って忘れてしまっても後で思い出せる。</p><figure><img src=/diary/img/2024/0925_sake.jpg></figure><p>特徴的なお酒で記憶に残っているもので <a href=https://miinokotobuki.com/>三井の寿</a> がスラムダンクに出てくる三井寿に由来して命名されていて、その背番号である14番と同じアルコード度数14度、日本酒度 (辛口甘口の度合いを表す) +14 と意図的？にあっているとのこと。日本酒の中ではトップクラスの辛口らしい。たしかに過去に私が飲んだことがないキレだった。もう1つは <a href=https://contents.thedann.com/entry/%E8%AE%83%E5%B2%90%E3%81%8F%E3%82%89%E3%81%86%E3%81%A7%E3%81%83%E3%81%AE%E6%97%A5%E6%9C%AC%E9%85%92%E3%82%92%E5%BE%B9%E5%BA%95%E8%A7%A3%E8%AA%AC>讃岐くらうでぃ</a> という、カルピスのような風味に近い珍しいお酒。甘いので後半に飲むとよい。うちらは酔っ払って訳がわからなくなってきたときに口直しのように飲んでた。そういう飲み方をするものかどうかはわからないが、飲みやすいのでついつい飲んでしまい、さらに酔ってしまう典型的なお酒。同期飲みは記憶をなくす感じで飲む。この歳になってこんな飲み方する相手いないなと思うとまた楽しい。</p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=/diary/posts/2024/0926/><span class=button__icon>←</span>
<span class=button__text>非同期処理のキャンセルと中断待ち</span>
</a></span><span class="button next"><a href=/diary/posts/2024/0924/><span class=button__text>晩酌セット</span>
<span class=button__icon>→</span></a></span></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2024 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>