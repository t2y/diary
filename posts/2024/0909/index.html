<!doctype html><html lang=en><head><title>コンテナー間のデータ通信はやはり http プロトコル :: </title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="過去に コンテナー間のデータ通信に named pipe を使って実装 した。機能的には問題なく運用できていたが、環境構築時に named pipe の設定がわかりにくいという課題があった。また docker compose は volumes に設定したパスが存在しないときに歴史的経緯でディレクトリを作成してしまう。初期設定時に named pipe を期待するリソースがディレクトリになってしまっているところの、エラー制御のわかりにくさもあった。またこの運用はオンプレミスの環境でしか利用できず、将来的にクラウド対応 (k8s) で運用することを考慮すると、http 通信できる方がよいと考えを改め、データ通信の仕組みを再実装した。http サーバーと比べて named pipe の方が優れているのはセキュリティとして物理的にその OS 上からしかアクセスできないところ。
go でフレームワークを使わず、シンプルな http サーバーを実装してみた。セキュリティの制約さえなければ、このぐらいの手間を惜しんで named pipe を実装することもなかったかと、いまとなっての学びとなった。
func newMux(cfg config.MyConfig) *http.ServeMux { mux := http.NewServeMux() mux.HandleFunc(&amp;#34;/version&amp;#34;, handler.HandleVersion(cfg)) return mux } func main() { ctx, stop := signal.NotifyContext(context.Background(), syscall.SIGINT, syscall.SIGTERM, ) defer stop() cfg := config.MyConfig{} server := &amp;amp;http.Server{ Addr: &amp;#34;:7099&amp;#34;, Handler: newMux(cfg), } go func() { if err := server."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/posts/2024/0909/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="コンテナー間のデータ通信はやはり http プロトコル"><meta property="og:description" content="過去に コンテナー間のデータ通信に named pipe を使って実装 した。機能的には問題なく運用できていたが、環境構築時に named pipe の設定がわかりにくいという課題があった。また docker compose は volumes に設定したパスが存在しないときに歴史的経緯でディレクトリを作成してしまう。初期設定時に named pipe を期待するリソースがディレクトリになってしまっているところの、エラー制御のわかりにくさもあった。またこの運用はオンプレミスの環境でしか利用できず、将来的にクラウド対応 (k8s) で運用することを考慮すると、http 通信できる方がよいと考えを改め、データ通信の仕組みを再実装した。http サーバーと比べて named pipe の方が優れているのはセキュリティとして物理的にその OS 上からしかアクセスできないところ。
go でフレームワークを使わず、シンプルな http サーバーを実装してみた。セキュリティの制約さえなければ、このぐらいの手間を惜しんで named pipe を実装することもなかったかと、いまとなっての学びとなった。
func newMux(cfg config.MyConfig) *http.ServeMux { mux := http.NewServeMux() mux.HandleFunc(&amp;#34;/version&amp;#34;, handler.HandleVersion(cfg)) return mux } func main() { ctx, stop := signal.NotifyContext(context.Background(), syscall.SIGINT, syscall.SIGTERM, ) defer stop() cfg := config.MyConfig{} server := &amp;amp;http.Server{ Addr: &amp;#34;:7099&amp;#34;, Handler: newMux(cfg), } go func() { if err := server."><meta property="og:url" content="/diary/posts/2024/0909/"><meta property="og:site_name" content><meta property="og:image" content="/diary/"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:published_time" content="2024-09-09 12:12:58 +0900 +0900"></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=/diary/posts/2024/0909/>コンテナー間のデータ通信はやはり http プロトコル</a></h1><div class=post-meta><time class=post-date>2024-09-09</time></div><span class=post-tags>#<a href=/diary/tags/container/>container</a>&nbsp;
#<a href=/diary/tags/linux/>linux</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;</span><div class=post-content><div><p>過去に <a href=/diary/posts/2023/0829/>コンテナー間のデータ通信に named pipe を使って実装</a> した。機能的には問題なく運用できていたが、環境構築時に named pipe の設定がわかりにくいという課題があった。また docker compose は volumes に設定したパスが存在しないときに歴史的経緯でディレクトリを作成してしまう。初期設定時に named pipe を期待するリソースがディレクトリになってしまっているところの、エラー制御のわかりにくさもあった。またこの運用はオンプレミスの環境でしか利用できず、将来的にクラウド対応 (k8s) で運用することを考慮すると、http 通信できる方がよいと考えを改め、データ通信の仕組みを再実装した。http サーバーと比べて named pipe の方が優れているのはセキュリティとして物理的にその OS 上からしかアクセスできないところ。</p><p>go でフレームワークを使わず、シンプルな http サーバーを実装してみた。セキュリティの制約さえなければ、このぐらいの手間を惜しんで named pipe を実装することもなかったかと、いまとなっての学びとなった。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>newMux</span>(<span style=color:#a6e22e>cfg</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>MyConfig</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ServeMux</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mux</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>NewServeMux</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mux</span>.<span style=color:#a6e22e>HandleFunc</span>(<span style=color:#e6db74>&#34;/version&#34;</span>, <span style=color:#a6e22e>handler</span>.<span style=color:#a6e22e>HandleVersion</span>(<span style=color:#a6e22e>cfg</span>))
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>mux</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>stop</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>signal</span>.<span style=color:#a6e22e>NotifyContext</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(),
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>syscall</span>.<span style=color:#a6e22e>SIGINT</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>syscall</span>.<span style=color:#a6e22e>SIGTERM</span>,
</span></span><span style=display:flex><span>	)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>stop</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>cfg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>MyConfig</span>{}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>server</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Server</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Addr</span>:    <span style=color:#e6db74>&#34;:7099&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Handler</span>: <span style=color:#a6e22e>newMux</span>(<span style=color:#a6e22e>cfg</span>),
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>server</span>.<span style=color:#a6e22e>ListenAndServe</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ErrServerClosed</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>slog</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#e6db74>&#34;got an error providing http service&#34;</span>, <span style=color:#e6db74>&#34;err&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>slog</span>.<span style=color:#a6e22e>Info</span>(<span style=color:#e6db74>&#34;stopped http server normally&#34;</span>)
</span></span><span style=display:flex><span>	}()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Done</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>slog</span>.<span style=color:#a6e22e>Info</span>(<span style=color:#e6db74>&#34;caught the stop signal&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctxTimeout</span>, <span style=color:#a6e22e>cancel</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>WithTimeout</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#ae81ff>10</span><span style=color:#f92672>*</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>cancel</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>server</span>.<span style=color:#a6e22e>Shutdown</span>(<span style=color:#a6e22e>ctxTimeout</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>slog</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#e6db74>&#34;failed to shutdown normally&#34;</span>, <span style=color:#e6db74>&#34;err&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>slog</span>.<span style=color:#a6e22e>Info</span>(<span style=color:#e6db74>&#34;done graceful shutdown&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=/diary/posts/2024/0910/><span class=button__icon>←</span>
<span class=button__text>結果に対する潔さ</span>
</a></span><span class="button next"><a href=/diary/posts/2024/0908/><span class=button__text>キャリア談義</span>
<span class=button__icon>→</span></a></span></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2024 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>