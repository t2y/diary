<!doctype html><html lang=en><head><title>Posts :: </title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/posts/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="Posts"><meta property="og:description" content><meta property="og:url" content="/diary/posts/"><meta property="og:site_name" content><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/posts/index.xml rel=alternate type=application/rss+xml title></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><div class=posts><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0906/>ldap スキーマの情報を返す web api の実装</a></h1><div class=post-meta><time class=post-date>2024-09-06 (Fri.) ::</time></div><span class=post-tags>#<a href=/diary/tags/ldap/>ldap</a>&nbsp;
#<a href=/diary/tags/programming/>programming</a>&nbsp;</span><div class=post-content><p><a href=/diary/posts/2024/0904/>一昨日</a>、<a href=/diary/posts/2024/0905/>昨日</a> と ldap スキーマの parser について調査して実装した。最終的には構文解析した値をそのまますべて返すわけではなく、実際に ui や内部の処理で必要な情報のみを使いやすい構造にして web api として実装する。マージリクエストを作成してメンバーにコードレビューをしてもらっていて、スキーマ情報だけでは足りない仕様に1つ気付いた。たとえば、次の <code>cn</code> という属性の定義には SUP (super の略語で親の定義から派生していることを表す) として <code>name</code> が定義されている。</p><pre tabindex=0><code>attributetype ( 2.5.4.41 NAME &#39;name&#39;
       EQUALITY caseIgnoreMatch
       SUBSTR caseIgnoreSubstringsMatch
       SYNTAX 1.3.6.1.4.1.1466.115.121.1.15{32768} )

attributetype ( 2.5.4.3 NAME ( &#39;cn&#39; &#39;commonName&#39; )
       DESC &#39;RFC2256: common name(s) for which the entity is known by&#39;
       SUP name )
</code></pre><p><code>cn</code> の定義には SYNTAX は定義されていないが、これは <code>name</code> の定義にある SYNTAX 1.3.6.1.4.1.1466.115.121.1.15 (<code>Directory String</code> のこと) の oid を継承するという仕様になっている。自分で SUP を調べて継承元の情報を取得するのは面倒なので構文解析した後に SUP が指定されていれば Equality, Ordering, SubStr, Syntax を親から取得するように改善した。こういうところは自前で parser を実装しているので自分たちの都合にあわせてカスタマイズしやすい。</p><p>3日もかかってしまったが、これで ldap スキーマを返す web api の実装を完了できた。いまの開発フェーズにおける、私が機能拡張する issue はこれで完了にしようと考えている。来週からはテストや qa 向けの作業にのみ注力していこうと思う。本番導入前に少しでも運用トラブルの懸念を減らす、もしくは品質をあげるための取り組みをあと3週間やってからしっかり検証をしていく。ここ1ヶ月ほど深夜までコードを書いていることが多かった。終わってみれば、面倒で厄介な issue も大半を fix した。当たり前の話だけど、四六時中ずっとコードを書いていたら気付いたら成果として積み上がってきた。マネージャーを移管したことでその分の労力を開発にまわせているのもある。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0905/>go で parser を実装してみた</a></h1><div class=post-meta><time class=post-date>2024-09-05 (Thu.) ::</time></div><span class=post-tags>#<a href=/diary/tags/ldap/>ldap</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;</span><div class=post-content><p><a href=/diary/posts/2024/0904/>昨日の ldap スキーマ parser 実装</a> の続き。parser generator は使わず自分で parser を実装してみることにした。go の標準ライブラリにある <a href=https://pkg.go.dev/text/scanner>text/scanner</a> を使って字句解析をしたら、次のカスタマイズを行うことでそれっぽく token に分解できた。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Mode</span> ^= <span style=color:#a6e22e>scanner</span>.<span style=color:#a6e22e>ScanFloats</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>IsIdentRune</span> = <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>ch</span> <span style=color:#66d9ef>rune</span>, <span style=color:#a6e22e>i</span> <span style=color:#66d9ef>int</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ch</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;.&#39;</span> <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>unicode</span>.<span style=color:#a6e22e>IsLetter</span>(<span style=color:#a6e22e>ch</span>) <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>unicode</span>.<span style=color:#a6e22e>IsDigit</span>(<span style=color:#a6e22e>ch</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>しかし、text/scanner はあくまで go のソースコードを字句解析するためのツールになる。ldap スキーマの字句解析も一応は意図したように分割できたが <code>'objectClass'</code> のようなシングルクォートで文字列を囲むような構文を go のソースコードでは記述できないため、エラーをチェックすると <code>invalid char literal</code> として必ずエラーになってしまう。これでは字句解析のエラーチェックをできなくなってしまうため text/scanner の利用は断念した。</p><p>そこで <a href=https://pkg.go.dev/bufio#Scanner>bufio#Scanner</a> を使って字句解析を実装した。字句解析を行うツールを lexer または tokenizer と呼ぶ。go ではこのツールを scanner と呼ぶ慣習になってるようにみえる。分割する token をカスタマイズするには <a href=https://pkg.go.dev/bufio#SplitFunc>SplitFunc</a> を定義する。ldap スキーマの字句解析は次のように定義できた。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>singleQuote</span> <span style=color:#66d9ef>byte</span> = <span style=color:#e6db74>&#39;\&#39;&#39;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>tokenize</span>(
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>data</span> []<span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>atEOF</span> <span style=color:#66d9ef>bool</span>,
</span></span><span style=display:flex><span>) (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>advance</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>token</span> []<span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>,
</span></span><span style=display:flex><span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>advance</span>, <span style=color:#a6e22e>token</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>bufio</span>.<span style=color:#a6e22e>ScanWords</span>(<span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>atEOF</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>token</span>) &gt; <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>token</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>==</span> <span style=color:#a6e22e>singleQuote</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>since</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>data</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>!=</span> <span style=color:#a6e22e>singleQuote</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>since</span> = <span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>IndexByte</span>(<span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>singleQuote</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>IndexByte</span>(<span style=color:#a6e22e>data</span>[<span style=color:#a6e22e>since</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>:], <span style=color:#a6e22e>singleQuote</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>bufio</span>.<span style=color:#a6e22e>ErrFinalToken</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>pos</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>since</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>pos</span>, <span style=color:#a6e22e>data</span>[<span style=color:#a6e22e>since</span>:<span style=color:#a6e22e>pos</span>], <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewScanner</span>(<span style=color:#a6e22e>src</span> <span style=color:#66d9ef>string</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>bufio</span>.<span style=color:#a6e22e>Scanner</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bufio</span>.<span style=color:#a6e22e>NewScanner</span>(<span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>NewReader</span>(<span style=color:#a6e22e>src</span>))
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Split</span>(<span style=color:#a6e22e>tokenize</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>s</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>次のような ldap スキーマの文字列は、</p><p><code>( 2.5.4.0 NAME 'objectClass' DESC 'RFC4512: object classes of the entity' EQUALITY objectIdentifierMatch SYNTAX 1.3.6.1.4.1.1466.115.121.1.38 )</code></p><p>次のように token として分割される。</p><pre tabindex=0><code>(
2.5.4.0
NAME
&#39;objectClass&#39;
DESC
&#39;RFC4512: object classes of the entity&#39;
EQUALITY
objectIdentifierMatch
SYNTAX
1.3.6.1.4.1.1466.115.121.1.38
)
</code></pre><p>あとはこれらの token から構文解析を行う parser を実装するだけ。AttributeTypeDescription の文法は次になる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-abnf data-lang=abnf><span style=display:flex><span><span style=color:#a6e22e>AttributeTypeDescription</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>&#34;(&#34;</span> <span style=color:#a6e22e>whsp</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>numericoid</span> <span style=color:#a6e22e>whsp</span>              <span style=color:#75715e>; AttributeType identifier</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;NAME&#34;</span> <span style=color:#a6e22e>qdescrs</span> ]             <span style=color:#75715e>; name used in AttributeType</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;DESC&#34;</span> <span style=color:#a6e22e>qdstring</span> ]            <span style=color:#75715e>; description</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;OBSOLETE&#34;</span> <span style=color:#a6e22e>whsp</span> ]
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;SUP&#34;</span> <span style=color:#a6e22e>woid</span> ]                 <span style=color:#75715e>; derived from this other</span>
</span></span><span style=display:flex><span>                                   <span style=color:#75715e>; AttributeType</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;EQUALITY&#34;</span> <span style=color:#a6e22e>woid</span>              <span style=color:#75715e>; Matching Rule name</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;ORDERING&#34;</span> <span style=color:#a6e22e>woid</span>              <span style=color:#75715e>; Matching Rule name</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;SUBSTR&#34;</span> <span style=color:#a6e22e>woid</span> ]              <span style=color:#75715e>; Matching Rule name</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;SYNTAX&#34;</span> <span style=color:#a6e22e>whsp</span> <span style=color:#a6e22e>noidlen</span> <span style=color:#a6e22e>whsp</span> ] <span style=color:#75715e>; Syntax OID</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;SINGLE-VALUE&#34;</span> <span style=color:#a6e22e>whsp</span> ]        <span style=color:#75715e>; default multi-valued</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;COLLECTIVE&#34;</span> <span style=color:#a6e22e>whsp</span> ]          <span style=color:#75715e>; default not collective</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;NO-USER-MODIFICATION&#34;</span> <span style=color:#a6e22e>whsp</span> ]<span style=color:#75715e>; default user modifiable</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;USAGE&#34;</span> <span style=color:#a6e22e>whsp</span> <span style=color:#a6e22e>AttributeUsage</span> ]<span style=color:#75715e>; default userApplications</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>whsp</span> <span style=color:#ae81ff>&#34;)&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>AttributeUsage</span> <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>&#34;userApplications&#34;</span>     <span style=color:#f92672>/</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>&#34;directoryOperation&#34;</span>   <span style=color:#f92672>/</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>&#34;distributedOperation&#34;</span> <span style=color:#f92672>/</span> <span style=color:#75715e>; DSA-shared</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>&#34;dSAOperation&#34;</span>          <span style=color:#75715e>; DSA-specific, value depends on server</span>
</span></span></code></pre></div><p>字句解析する scanner と組み合わせて実装した parser は次のようになる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>ParseAttributeTypeDescription</span>(
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>src</span> <span style=color:#66d9ef>string</span>,
</span></span><span style=display:flex><span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>AttributeTypeDescription</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>d</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>AttributeTypeDescription</span>{}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NewScanner</span>(<span style=color:#a6e22e>src</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Scan</span>() {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>token</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Text</span>()
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>token</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>leftParenthesis</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Scan</span>() {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>OID</span> = <span style=color:#a6e22e>OID</span>{<span style=color:#a6e22e>Value</span>: <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Text</span>()}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>rightParenthesis</span>:
</span></span><span style=display:flex><span>			<span style=color:#75715e>// do nothing
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;NAME&#34;</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Scan</span>() {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Name</span> = <span style=color:#a6e22e>ParseNAME</span>(<span style=color:#a6e22e>s</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;DESC&#34;</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Scan</span>() {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Desc</span> = <span style=color:#a6e22e>Unquote</span>(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Text</span>())
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;OBSOLETE&#34;</span>:
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Obsolete</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;SUP&#34;</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Scan</span>() {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Sup</span> = <span style=color:#a6e22e>NewWOID</span>(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Text</span>())
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;EQUALITY&#34;</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Scan</span>() {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Equality</span> = <span style=color:#a6e22e>NewWOID</span>(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Text</span>())
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;ORDERING&#34;</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Scan</span>() {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Ordering</span> = <span style=color:#a6e22e>NewWOID</span>(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Text</span>())
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;SUBSTR&#34;</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Scan</span>() {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>SubStr</span> = <span style=color:#a6e22e>NewWOID</span>(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Text</span>())
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;SYNTAX&#34;</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Scan</span>() {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Syntax</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>ParseNOIDLen</span>(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Text</span>())
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to parse SYNTAX: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;SINGLE-VALUE&#34;</span>:
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>SingleValue</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;COLLECTIVE&#34;</span>:
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Collective</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;NO-USER-MODIFICATION&#34;</span>:
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>NoUserModification</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;USAGE&#34;</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Scan</span>() {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>usage</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>GetAttributeTypeUsage</span>(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Text</span>())
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Usage</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>usage</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>HasPrefix</span>(<span style=color:#a6e22e>token</span>, <span style=color:#e6db74>&#34;X-&#34;</span>) {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Scan</span>() {
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Extension</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>						<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Extension</span> = make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>][]<span style=color:#66d9ef>string</span>)
</span></span><span style=display:flex><span>					}
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Extension</span>[<span style=color:#a6e22e>token</span>] = <span style=color:#a6e22e>ParseQuotedStrings</span>(<span style=color:#a6e22e>s</span>)
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>slog</span>.<span style=color:#a6e22e>Warn</span>(<span style=color:#e6db74>&#34;unsupported&#34;</span>, <span style=color:#e6db74>&#34;token&#34;</span>, <span style=color:#a6e22e>token</span>, <span style=color:#e6db74>&#34;oid&#34;</span>, <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>OID</span>, <span style=color:#e6db74>&#34;name&#34;</span>, <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Name</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Err</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to scan: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>d</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>昨日の調査で go 製の parser generator をあまりみつけられなかったことに気付いた。その理由を理解できた。go で初めて parser を実装してみて簡単に実装できることに気付いた。標準ライブラリにある text/scanner や bufio#Scanner を使うと簡単に字句解析できるため、自分で parser を実装する労力が小さい。したがって parser generator を使って実装するよりも、自分で parser を実装することを選ぶ開発者が多いのではないかと推測する。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0904/>openldap スキーマと parser generator</a></h1><div class=post-meta><time class=post-date>2024-09-04 (Wed.) ::</time></div><span class=post-tags>#<a href=/diary/tags/ldap/>ldap</a>&nbsp;
#<a href=/diary/tags/programming/>programming</a>&nbsp;
#<a href=/diary/tags/meta-programming/>meta programming</a>&nbsp;</span><div class=post-content><p>この開発フェーズではあまり機能拡張を行わない方針としているが、できればやっておいた方がよい機能拡張の1つに openldap サーバーから ldap スキーマを取得する処理がある。ちょうどいま若いメンバーに実装してもらっている大きな機能のバリデーションにも ldap スキーマの情報があると便利そうなので私が対応することに決めた。</p><p>openldap サーバーで管理している ldap スキーマの定義は openldap サーバーの <a href=https://www.openldap.org/doc/admin26/schema.html>Schema Specification</a> と <a href=https://www.openldap.org/doc/admin25/schema.html>rfc 4512</a> の2つをみると仕様がわかる。たとえば、次のように AttributeTypeDescription というスキーマの定義は <a href=https://en.wikipedia.org/wiki/Augmented_Backus%E2%80%93Naur_form>Augmented Backus–Naur form (abnf)</a> という記法で定義されている。rfc などのネットワークプロトコルの世界では abnf のフォーマットで仕様を説明することが多いらしい。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-abnf data-lang=abnf><span style=display:flex><span><span style=color:#a6e22e>AttributeTypeDescription</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>&#34;(&#34;</span> <span style=color:#a6e22e>whsp</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>numericoid</span> <span style=color:#a6e22e>whsp</span>              <span style=color:#75715e>; AttributeType identifier</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;NAME&#34;</span> <span style=color:#a6e22e>qdescrs</span> ]             <span style=color:#75715e>; name used in AttributeType</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;DESC&#34;</span> <span style=color:#a6e22e>qdstring</span> ]            <span style=color:#75715e>; description</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;OBSOLETE&#34;</span> <span style=color:#a6e22e>whsp</span> ]
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;SUP&#34;</span> <span style=color:#a6e22e>woid</span> ]                 <span style=color:#75715e>; derived from this other</span>
</span></span><span style=display:flex><span>                                   <span style=color:#75715e>; AttributeType</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;EQUALITY&#34;</span> <span style=color:#a6e22e>woid</span>              <span style=color:#75715e>; Matching Rule name</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;ORDERING&#34;</span> <span style=color:#a6e22e>woid</span>              <span style=color:#75715e>; Matching Rule name</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;SUBSTR&#34;</span> <span style=color:#a6e22e>woid</span> ]              <span style=color:#75715e>; Matching Rule name</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;SYNTAX&#34;</span> <span style=color:#a6e22e>whsp</span> <span style=color:#a6e22e>noidlen</span> <span style=color:#a6e22e>whsp</span> ] <span style=color:#75715e>; Syntax OID</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;SINGLE-VALUE&#34;</span> <span style=color:#a6e22e>whsp</span> ]        <span style=color:#75715e>; default multi-valued</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;COLLECTIVE&#34;</span> <span style=color:#a6e22e>whsp</span> ]          <span style=color:#75715e>; default not collective</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;NO-USER-MODIFICATION&#34;</span> <span style=color:#a6e22e>whsp</span> ]<span style=color:#75715e>; default user modifiable</span>
</span></span><span style=display:flex><span>    [ <span style=color:#ae81ff>&#34;USAGE&#34;</span> <span style=color:#a6e22e>whsp</span> <span style=color:#a6e22e>AttributeUsage</span> ]<span style=color:#75715e>; default userApplications</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>whsp</span> <span style=color:#ae81ff>&#34;)&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>AttributeUsage</span> <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>&#34;userApplications&#34;</span>     <span style=color:#f92672>/</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>&#34;directoryOperation&#34;</span>   <span style=color:#f92672>/</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>&#34;distributedOperation&#34;</span> <span style=color:#f92672>/</span> <span style=color:#75715e>; DSA-shared</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>&#34;dSAOperation&#34;</span>          <span style=color:#75715e>; DSA-specific, value depends on server</span>
</span></span></code></pre></div><p>openldap サーバーに対して ldap スキーマを取得する方法は <a href=https://www.openldap.org/faq/data/cache/1366.html>How can I fetch schema information from the server?</a> の faq に書いてある。search base に対してサブスキーマサブエントリを返す dn を取得する。openldap サーバーの場合 ldap の root ツリーに対応するのは <code>cn=Subschema</code> がデフォルトとなる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ldapsearch -H ldap://localhost -x -LLL -b dc<span style=color:#f92672>=</span>example,dc<span style=color:#f92672>=</span>com -s base subschemaSubentry
</span></span><span style=display:flex><span>dn: dc<span style=color:#f92672>=</span>example,dc<span style=color:#f92672>=</span>com
</span></span><span style=display:flex><span>subschemaSubentry: cn<span style=color:#f92672>=</span>Subschema
</span></span></code></pre></div><p>この dn にスキーマ情報の属性が格納されているのでそれらを取得する。このスキーマ情報は operational attributes として管理されているので <code>+</code> という記号が operational attributes 属性群をまとめて取得するキーワードになっている。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ldapsearch -x -LLL -b cn<span style=color:#f92672>=</span>Subschema -s base <span style=color:#e6db74>&#39;(objectClass=subschema)&#39;</span> +
</span></span></code></pre></div><p>これでスキーマ情報を取得できる。先に書いた AttributeTypeDescription の実際のスキーマ情報は次のような内容になる。こういったスキーマのテキスト情報をたくさん取得できる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-abnf data-lang=abnf><span style=display:flex><span>( <span style=color:#f92672>2</span>.<span style=color:#f92672>5</span>.<span style=color:#f92672>4</span>.<span style=color:#f92672>0</span> <span style=color:#a6e22e>NAME</span> &#39;<span style=color:#a6e22e>objectClass</span>&#39; <span style=color:#a6e22e>DESC</span> &#39;<span style=color:#a6e22e>RFC4512</span>: <span style=color:#a6e22e>object</span> <span style=color:#a6e22e>classes</span> <span style=color:#a6e22e>of</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>entity</span>&#39; <span style=color:#a6e22e>EQUALITY</span> <span style=color:#a6e22e>objectIdentifierMatch</span> <span style=color:#a6e22e>SYNTAX</span> <span style=color:#f92672>1</span>.<span style=color:#f92672>3</span>.<span style=color:#f92672>6</span>.<span style=color:#f92672>1</span>.<span style=color:#f92672>4</span>.<span style=color:#f92672>1</span>.<span style=color:#f92672>1466</span>.<span style=color:#f92672>115</span>.<span style=color:#f92672>121</span>.<span style=color:#f92672>1</span>.<span style=color:#f92672>38</span> )
</span></span></code></pre></div><h2 id=go-の-parser-generator-調査>go の parser generator 調査</h2><p>この手のものは abnf から parser をコード生成するのが一般的なやり方かな？と、まずは go で使えそうな parser generator について調べてみた。意外と go 製の parser generator はみつからなかった。私が発見できたのは次の3つぐらい。</p><ul><li><a href=https://pkg.go.dev/golang.org/x/tools/cmd/goyacc>golang.org/x/tools/cmd/goyacc</a></li><li><a href=https://github.com/goccmack/gocc>goccmack/gocc</a></li><li><a href=https://github.com/antlr4-go/antlr>antlr4-go/antlr</a></li></ul><p>最後の antlr は java 製のツールだけれども、go のソースコードを出力できるので go 実装の parser をコード生成できるという意図で対象としている。goyacc は abnf の文法を yacc に変換しないといけない。<a href=https://github.com/yinyin/go-ldap-schema-parser/blob/master/parser.y>yacc で実装した ldap スキーマの parser</a> を公開しているのもみかけたが、yacc は違うなと思って除外した。antlr も abnf から専用の文法に変換しないといけないから不採用にした。</p><p>それで消去法的に bnf (ebnf) を扱える gocc で parser をコード生成できないかを調査してみた。しかし、半日ほど bnf を書いて実際にコード生成してみて不採用とした。ebnf の options 記法として <code>[...]</code> に gocc が対応していないようにみえた。この記法がないと ldap スキーマの文法定義が煩雑になる。<a href=https://github.com/goccmack/gocc/issues/21#issuecomment-216398402>issue のコメント</a> をみると、lexer は対応したが、parser は対応していないといったコメントがある。コード生成しようとするとエラーになるので未対応なのかもしれない。bnf でこの options 記法相当のものを自分で文法定義すると、1つ2つなら簡単に変換できるが、数個の組み合わせがあると途端に文法の複雑さが大きくなるように思える。abnf から bnf に変換する過程で文法が複雑になってしまうとその後の保守ができなくなる懸念が生じるので断念した。</p><p>今回の gocc の採用は却下したが、軽く触ってみて gocc 自体の感触はよかった。シンプルな bnf で表現できるものであれば機会があれば採用してもよいと思える。<a href=https://github.com/goccmack/gocc/tree/master/example>gocc example</a> をみればわかるが、bnf を書きながら単体テストのコードを実行して動作検証を小さく簡潔にできる。これは parser のコード生成の開発サイクルは速くできそうに感じた。こういう小さく単体で動くツールは好み。</p><p>最終的な結論としては parser generator は使わず、自前で parser を実装することを決めた。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0903/>case-insensitive という古くて厄介な問題</a></h1><div class=post-meta><time class=post-date>2024-09-03 (Tue.) ::</time></div><span class=post-tags>#<a href=/diary/tags/ldap/>ldap</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;
#<a href=/diary/tags/refactoring/>refactoring</a>&nbsp;</span><div class=post-content><h2 id=casemap-によるリファクタリング>casemap によるリファクタリング</h2><p>ldap プロトコル (v3) は <a href=https://datatracker.ietf.org/doc/html/rfc2251>rfc 2251</a> で定義されていて属性へのアクセスは case-insensitive (大文字小文字を区別しない) に扱うという仕様になっている。</p><p>ldap サーバーへの問い合わせや検索は case-insensitive となるため、ldap エントリーを扱う他システムの処理もすべて case-insensitive にしないと整合性が取れなくて混乱する。これは利用者だけでなく開発者も同様であり、一部が case-insensitive なのに、一部を case-sensitive (大文字小文字を区別する) にすると、比較処理がマッチしたりしなかったりという混乱を生じる。そういう面倒くさい issue が過去にいくつか散見されてきた。この問題は場当たり的な修正ではなく、本質的な対応が求められた。</p><p>結論としては、すべてを case-insensitive に扱う必要があって、そのためにキーを case-insensitive として扱う map like なデータ構造を実装した。オリジナルのキー情報も保持しつつ、case-insensitive にアクセスできるよう小文字変換しておいた名前変換テーブルを内部にもつ。最初からこういったデータ構造を定義しておけば開発時に混乱は起きないが、こういうものは後になってわかってくる。うちは1年半経ってからこの問題の本質を理解した。そのため、関連する処理のインターフェースを見直して置き換えることになった。こういうリファクタリングは時間がかかる割に成果も地味なので労力に対して評価されないことが多い。私もやっていてあまり楽しくはないが、こういうところをきっちり作ると品質に寄与するのを経験的に知っている。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>CaseMap</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>keyValue</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>][]<span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>nameConv</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>CaseMap</span>) <span style=color:#a6e22e>String</span>() <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;%v&#34;</span>, <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>keyValue</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>CaseMap</span>) <span style=color:#a6e22e>Values</span>(<span style=color:#a6e22e>name</span> <span style=color:#66d9ef>string</span>) []<span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>origName</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>nameConv</span>[<span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>ToLower</span>(<span style=color:#a6e22e>name</span>)]
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>values</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>keyValue</span>[<span style=color:#a6e22e>origName</span>]
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>values</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>CaseMap</span>) <span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>name</span> <span style=color:#66d9ef>string</span>) ([]<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>bool</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>origName</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>nameConv</span>[<span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>ToLower</span>(<span style=color:#a6e22e>name</span>)]
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>values</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>keyValue</span>[<span style=color:#a6e22e>origName</span>]
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>values</span>, <span style=color:#a6e22e>ok</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>CaseMap</span>) <span style=color:#a6e22e>Set</span>(<span style=color:#a6e22e>name</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>values</span> []<span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>keyValue</span>[<span style=color:#a6e22e>name</span>] = <span style=color:#a6e22e>values</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>nameConv</span>[<span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>ToLower</span>(<span style=color:#a6e22e>name</span>)] = <span style=color:#a6e22e>name</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>CaseMap</span>) <span style=color:#a6e22e>Len</span>() <span style=color:#66d9ef>int</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> len(<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>keyValue</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>CaseMap</span>) <span style=color:#a6e22e>Iter</span>() <span style=color:#a6e22e>iter</span>.<span style=color:#a6e22e>Seq2</span>[<span style=color:#66d9ef>string</span>, []<span style=color:#66d9ef>string</span>] {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>yield</span> <span style=color:#66d9ef>func</span>(<span style=color:#66d9ef>string</span>, []<span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>bool</span>) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>k</span>, <span style=color:#a6e22e>v</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>keyValue</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>yield</span>(<span style=color:#a6e22e>k</span>, <span style=color:#a6e22e>v</span>) {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>CaseName</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Original</span>  <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>LowerName</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>CaseMap</span>) <span style=color:#a6e22e>IterWithLower</span>() <span style=color:#a6e22e>iter</span>.<span style=color:#a6e22e>Seq2</span>[<span style=color:#a6e22e>CaseName</span>, []<span style=color:#66d9ef>string</span>] {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>yield</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>CaseName</span>, []<span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>bool</span>) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>lowerName</span>, <span style=color:#a6e22e>origName</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>nameConv</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>name</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>CaseName</span>{
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>Original</span>:  <span style=color:#a6e22e>origName</span>,
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>LowerName</span>: <span style=color:#a6e22e>lowerName</span>,
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>yield</span>(<span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>keyValue</span>[<span style=color:#a6e22e>origName</span>]) {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>CaseMap</span>) <span style=color:#a6e22e>ToMap</span>() <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>][]<span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>keyValue</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>length</span> <span style=color:#66d9ef>int</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>CaseMap</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>CaseMap</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>keyValue</span>: make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>][]<span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>length</span>),
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>nameConv</span>: make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>length</span>),
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewFrom</span>(<span style=color:#a6e22e>attr</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>][]<span style=color:#66d9ef>string</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>CaseMap</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>m</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>New</span>(len(<span style=color:#a6e22e>attr</span>))
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>k</span>, <span style=color:#a6e22e>v</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>attr</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>Set</span>(<span style=color:#a6e22e>k</span>, <span style=color:#a6e22e>v</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>m</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0902/>開発が進捗することの作用</a></h1><div class=post-meta><time class=post-date>2024-09-02 (Mon.) ::</time></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/motivation/>motivation</a>&nbsp;</span><div class=post-content><p><a href=/diary/posts/2024/0901/>昨日おこなった調査</a> の成果もあって、いろいろ他の開発作業も進捗して、今日はいくつか小さい issue を fix できて1日の成果としては満足できる内容になった。それで夕方に洗濯したり、晩ご飯を作ったり、家事をやる余裕があったり、さらにオフィスへ戻って作業をしてから外出してくることもできた。ここ数日にはなかった充実した1日だったように実感した。いまの生活に満足できなかったりモチベーションが上がらなかったりする背景の1つとして、溜まっている残タスクへのストレスがある。このストレスを解消するのは残タスクを fix することがもっとも効果的である。</p><p>結論はやる気がなくてもやるしかない。少しずつでも問題を解決していくしかない。</p><p>古い文章だが、いまでも覚えていてたまに引用する <a href=/diary/posts/2021/0929/#joel-on-software>Joel on Software</a> の格言の1つに <a href=https://megalodon.jp/2011-0824-1248-00/japanese.joelonsoftware.com/Articles/FireAndMotion.html>射撃しつつ前進</a> がある。いま自分が置かれている状況はまさにこれに相当するものなので地道な積み重ねをしていくしかない。そういうときもあって人生はちょうどよいのだろうと思う。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0901/>ぱっとしない休日</a></h1><div class=post-meta><time class=post-date>2024-09-01 (Sun.) ::</time></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/network/>network</a>&nbsp;</span><div class=post-content><p>9月に入ってしまった。8月は開発者の生活を思い出すための試行錯誤の月だった。よくもわるくもかな。</p><h2 id=キャンセル料の支払い>キャンセル料の支払い</h2><p>この前の金曜日は <a href=https://www.cospa-wellness.co.jp/corp/kobefukushi-sc/facility/>しみん福祉スポーツセンター</a> の体育館を借りてバドミントンを行う予定だった。<a href=/diary/posts/2024/0829/>木曜日は戻ってこれない可能性</a> があったし、前日の天気予報では金曜日の夕方が神戸に台風が来る予報になっていた。そこで木曜日の夜に参加者も少なかったしキャンセルすることに決めた。キャンセルは1週間前でないとできないため、これは自然災害だから仕方がないと体育館のキャンセル料金3,000円を支払うことにした。直接、しみん福祉スポーツセンターの窓口でないと支払いできない。窓口へ行って paypay で支払いしてきた。しみん福祉スポーツセンターの体育館を借りるのは値段が高いので参加者数が増えてから借りる運用を変えようと思う。</p><h2 id=x-forwarded-for-ヘッダーの制御>X-Forwarded-For ヘッダーの制御</h2><p><a href=/diary/posts/2024/0830/>先日の作業の続き</a> 。本当は土曜日にやろうと思っていて、全然やる気がなくて、なにもやらないよりはちょっとでもやった方がよいかと、今日やり始めたら集中できて2-3時間で調査と対応を完了した。もともと構築しているリバースプロキシとしての nginx には次のヘッダーを扱う設定が追加されていた。</p><pre tabindex=0><code>proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_set_header X-Forwarded-Proto $scheme;
proxy_set_header X-Forwarded-Host $server_name;
</code></pre><p>追加で <code>remote_addr</code> を置き換える設定を入れてみれば、リバースプロキシ経由でリクエストを受ける go の http Request が参照する RemoteAddr の値も置き換わるのかな？と検証してみた。</p><pre tabindex=0><code>set_real_ip_from 172.29.0.0/16;
real_ip_header X-Forwarded-For;
real_ip_recursive on;
proxy_set_header REMOTE_ADDR $remote_addr;
</code></pre><p>結論としては RemoteAddr の値は置き換わらなかった。nginx の <code>real_ip_header</code> モジュールは nginx 環境における <code>remote_addr</code> の値を変更する設定であり、転送するときにパケットの値を置き換えるものではないようにみえる。そこで api サーバー側で <code>X-Forwarded-For</code> ヘッダーを参照するのが正しい対応方法だと理解できた。このヘッダーを参照することは一般的な用途に思えるので調べたら echo の <a href=https://echo.labstack.com/docs/ip-address>IP Address</a> のドキュメントにその設定方法やユーティリティの扱いなどが書いてあってすぐに参照できることもわかった。</p><p><code>X-Forwarded-For</code> ヘッダーはクライアントが任意で偽装できる。デフォルトでは内部ネットワークから転送されたヘッダーの値のみを信頼するように設定されている。それが次の IPExtractor の設定になる。デフォルトの制約を変更することもできるが、コンテナで運用するとすべての通信はコンテナネットワークの gateway からリクエストされているようにみえるのでアクセス制御という側面ではこの設定そのものにあまり意味はない。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>e</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>New</span>()
</span></span><span style=display:flex><span><span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>IPExtractor</span> = <span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>ExtractIPFromXFFHeader</span>()
</span></span></code></pre></div><p><code>X-Forwarded-For</code> ヘッダーの値を実際に参照するときは <code>c.Request().RemoteAddr</code> ではなく <code>c.RealIP()</code> を使う。api サーバーはこのぐらいの変更で実際のクライアントから転送されてきた ip アドレスを知ることができた。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0831/>その後の台風の影響</a></h1><div class=post-meta><time class=post-date>2024-08-31 (Sat.) ::</time></div><span class=post-tags>#<a href=/diary/tags/health/>health</a>&nbsp;
#<a href=/diary/tags/comic/>comic</a>&nbsp;
#<a href=/diary/tags/history/>history</a>&nbsp;</span><div class=post-content><p>台風の影響で昨日も今日も終日、新幹線は取りやめになっていた。<a href=/diary/posts/2024/0829/>木曜日に帰ってこれた</a> ことには大きな意味があった。本当に助かった。</p><h2 id=ストレッチ>ストレッチ</h2><p>今日の開脚幅も開始前149cmで、ストレッチ後156cmと普段通りの数値だった。運動できていないので筋肉痛もなく、デスクワークの疲労ぐらいしかない。いつも通りトレーナーさんと雑談して硬くなったカラダをほぐしてもらう感じだった。今週は出張していたのと、出張中の業務時間も普段より少なかったのでとくに疲労がたまっているわけでもなかった。運動せず筋肉痛もなくストレッチを受けるともったいないような気分にもなってきた。いまの開発フェーズが終わったらまた運動を再開できるかなぁ。</p><h2 id=成就しない結末への期待>成就しない結末への期待</h2><p>今期のアニメで <a href=https://nigewaka.run/>逃げ上手の若君</a> を見始めた。最初は「ながら」でみていたせいか、あまりぱっとしなかったものの、改めてちゃんと数話を見返したらおもしろい作品だと思えた。もともと私は歴史漫画が好きなので歴史ジャンルというだけでもみてしまう。著者の <a href=https://ja.wikipedia.org/wiki/%E6%9D%BE%E4%BA%95%E5%84%AA%E5%BE%81>松井優征</a> さんの作品は過去に「暗殺教室」を読んだこともあって好きな漫画家の1人でもある。したがって、私はもともとこの作品を知っていたし、関心をもっていた。いままで読んでいなかっただけ。主人公は <a href=https://ja.wikipedia.org/wiki/%E5%8C%97%E6%9D%A1%E6%99%82%E8%A1%8C>北条時行</a> という、室町幕府が成立する時代の、鎌倉幕府最後の北条家の跡継ぎになる。<a href=https://ja.wikipedia.org/wiki/%E8%B6%B3%E5%88%A9%E5%B0%8A%E6%B0%8F>足利尊氏</a> は歴史の授業で習うが、北条時行を私は覚えていないから習わなかったのかもしれない。歴史の影というのか、この作品は敗者を描く作品になる。</p><p>余談だが、神戸駅のすぐ近くに <a href=/diary/posts/2022/0108/#初詣>湊川神社</a> がある。逃げ上手の若君の作品内でも出てくる <a href=https://ja.wikipedia.org/wiki/%E6%B9%8A%E5%B7%9D%E3%81%AE%E6%88%A6%E3%81%84>湊川の戦い</a> の、あの「湊川」であり、神戸という地元応援の文脈で <a href=https://ja.wikipedia.org/wiki/%E6%A5%A0%E6%9C%A8%E6%AD%A3%E6%88%90>楠木正成</a> も応援している。楠木正成は没後から江戸時代まで知名度は低かったが、なぜか徳川光圀公に評価され、その後、幕末の維新志士から崇敬の対象となり、歴史上の時間が経ってから知名度があがった稀有な武将でもある。そういう背景もあってなのか、逃げ上手の若君の作品内でも特異な武将として描かれていて、史実から湊川の戦いで足利尊氏に負けてしまうのだけれども、それでも格好よく戦って、その智謀を発揮している。この作品を読んでさらに楠木正成への関心が出てきた。</p><p>歴史漫画は結果がわかっているから予定調和で読み進める。主人公が勝者であれば安心して読めるが、この作品は敗者なので結末は悲劇となる。ある意味、敗者だからあまり史実の資料が残っていなくて創造性を発揮できるところもあるだろう。そこが漫画家の腕の見せ所だと思う。北条時行による「中先代の乱」があったから南北朝が生まれ、その後の室町幕府への影響も大きかったように、この作品内では描かれている。敗者も歴史を作っていく上での重要な役割を担っているという表現になっていて歴史の背景を想像して楽しみながら読める作品になっていると思う。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0830/>まる一日コードレビュー</a></h1><div class=post-meta><time class=post-date>2024-08-30 (Fri.) ::</time></div><span class=post-tags>#<a href=/diary/tags/programming/>programming</a>&nbsp;
#<a href=/diary/tags/review/>review</a>&nbsp;</span><div class=post-content><p>昨日は2時頃に帰ってきて、朝も昼も食べてなくて空港でおにぎりを食べただけだったので家に戻ってきてお腹が空いて軽食を食べてから寝た。お手伝い先の都合で朝から請求書を送る必要があったため、8時過ぎにはオフィスへ行って請求書を作成して送付した。9時からはらさんと隔週の雑談もあったのでスケジュール的にも早起きする理由があってちょうどよかった。</p><p>出張帰りの気分転換に nginx で <code>X-Forwarded-For</code> を設定する方法を <a href=https://christina04.hatenablog.com/entry/2016/10/25/190000>remote_addrとかx-forwarded-forとかx-real-ipとか</a> をみたりしながら調査していた。リバースプロキシがある前提であれば、api サーバーがそのヘッダーを参照するのではなく、nginx がそのヘッダーを <code>remote_addr</code> に設定するようにしてしまおうと思う。</p><p>今回の開発フェーズでは若いメンバーにサーバーサイドの大きな機能を開発してもらう。サーバーサイド開発の経験を積んでもらう機会にもする。レビューに私の時間が取られることを折り込んで工数を確保している。ある機能の初期実装ができたというのでそのレビューをしていた。そのコードレビューをしていてサーバーサイドの開発は難しいなと実感した。経験がないメンバーだと動けばいいコードしか書けない。効率やリソースの消費を考えながらコードを書いていないし、ライブラリやフレームワークのコードも読んでいないからサーバーサイドの運用に耐えるコードは書けない。あちこち指摘して直してもらう必要があった。なんやらかんやらでまる一日コードレビューしていて、自分の作業はまったくできなかった。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0829/>東京出張を新幹線に依存するリスク</a></h1><div class=post-meta><time class=post-date>2024-08-29 (Thu.) ::</time></div><span class=post-tags>#<a href=/diary/tags/biztrip/>biztrip</a>&nbsp;
#<a href=/diary/tags/failure/>failure</a>&nbsp;</span><div class=post-content><h2 id=新幹線から飛行機への変更>新幹線から飛行機への変更</h2><p>いつも出張帰りは18時19分 (品川発) 〜 20時53分 (新神戸着) の新幹線を使っている。朝の時点では台風が九州にいたので大丈夫そうと考えていた。しかし、16時頃に <a href=https://traininfo.jr-central.co.jp/shinkansen/sp/ja/index.html>東海道・山陽新幹線運行状況</a> をチェックしたら東京 - 静岡間が止まっていることに気付いた。火曜日の夕方も大雨で2時間半ほど遅れたとお手伝い先の社員さんから聞いていて、静岡県の一部の地域だけ局所的に雨が降ることは事前に知っていた。台風は遠かったから待てば遅れて動き出すかな？と静岡県の天気予報を眺めていた。17-19時に雨足は少し弱まる予報なものの、19時以降はまた強い雨になっていたので18時頃に動かない状況だったから新幹線は無理だなと諦めた。実際 18:50 に新幹線の終日運転取り止めの案内が発表された。</p><p>諦めつつ、なんとなくお手伝い先の cto に声をかけてみたら飛行機に変更したら？と教えてもらった。その場で検索してもらって関空行きならまだ予約を取れるという。私は普段、飛行機を使わないから航空券の手配の方法をよくわかっていない。航空券を取るためのアカウントすらあるかも怪しい。そこで cto に航空券を予約していただいた。それから慌てて羽田空港へ向かうことに。しかし、飛行機も約1時間出発が遅れたりして22時前に出発して23時過ぎに関空へ着いた。私は関空へ行くのも初めてだった。関空からの帰りのルートもよくわからない。三宮まで帰るときの電車の最終は 22:48 で、高速バスは 23:00 となる。残念ながら三宮までは帰れないものの、23:45 の梅田行き (最終) の高速バスには乗れた。</p><p>0時半頃に梅田に着いた。そのときはどこか適当に泊まる場所を探そうと考えていた。バスを降りて移動していたら、同じバスから降りた2人組がタクシー乗り場を探しながら相乗りする人を探そうと話していた。声をかけてみたら神戸までタクシーで行くというから、一緒に乗せてもらって3人でタクシーで帰ってきた。梅田から神戸までのタクシー料金 (深夜割増) は高速道路を使わずに1万5千円弱だった。時間は1時間半ぐらいかな。1人5千円程度なのでサウナや漫画喫茶に泊まってから電車で帰るのとそれほど変わらない金額に思える。三ノ宮駅で私は降りて2時前には自宅に着いたと思う。</p><p>もし私1人だったら18時の時点で帰れないと諦めていた。台風が接近するから金曜日も土曜日も新幹線は止まることが容易に推測できた。周りに尋ねて、他者の助けを得て東京から自宅に帰ることができた。たまにこういうことがあって世の中は助け合いであることを実感する。一方で私の準備不足で右往左往したり、余分にコストがかかったりしたのをふりかえりしておく。</p><ul><li>16時の時点で飛行機へ変更をしていたらもっと早く (安く) 帰れた可能性が高い</li><li>航空券の予約方法がわからないのを改める必要がある<ul><li>飛行機予約のためのアカウントを作る</li><li>航空券の予約手続きに慣れておく</li></ul></li><li>新幹線が止まっても飛行機は飛んでいる場合がある</li><li>慣れておくために飛行機で東京出張する機会をたまに設ける</li></ul></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0828/>集中開発の1ヶ月間</a></h1><div class=post-meta><time class=post-date>2024-08-28 (Wed.) ::</time></div><span class=post-tags>#<a href=/diary/tags/project-management/>project management</a>&nbsp;
#<a href=/diary/tags/issue-management/>issue management</a>&nbsp;
#<a href=/diary/tags/testing/>testing</a>&nbsp;</span><div class=post-content><h2 id=プロジェクトの進捗報告>プロジェクトの進捗報告</h2><p>出張したときの月例報告の19回目。<a href=/diary/posts/2024/0731/>前回の進捗報告はこちら</a> 。この開発フェーズは私が経営陣へ進捗報告するものの、引き継いだマネージャーにも同席してもらって、こんな打ち合わせをしているというのを知ってもらう機会にしている。この1ヶ月間の進捗やこの開発フェーズでやろうとしていることを一通り説明して、あとはざっくばらんに経営陣と雑談するといった機会にもなった。最低限、開発のボトルネックになりそうなところは私が集中開発して解消したので見た目上はよいペースで進捗している。</p><p>進捗報告して雑談しているうちに、もうこれ以上は私がお手伝い先へ提供できる新たな価値はなさそうに思えてきた。ここからは課題管理できている issue を優先度順にひたすら fix していく、よくないところはリファクタリングする、開発の負債やボトルネックを解消していくといった、より実践的な実務が求められる。課題管理を含むプロジェクトマネジメントやチームの情報共有を改善することで開発をうまくまわしていくフェーズは十分にメンバーが実践できるようになったと思える。自身の引き出しの中身を払い出してしまって、なにも残っていないような寂しさを感じるようになった。</p><p>いまマルチブラウザ／デバイスのテストの自動化のために <a href=https://www.browserstack.com/>BrowserStack</a> というプラットフォームを評価している。まだ評価中なので採用の可否はこれから判断するところだが、採用したらコストがかかるのでその話題も経営陣に伝えてその場で議論したりしていた。おそらくこのサービスは <a href=https://www.selenium.dev/ja/documentation/grid/>Selenium Grid</a> を使っているのではないか？と推測される。うちのプロジェクトだけでなく、社内インフラとして全社共通のテスト基盤を作るという施策もあるかもしれないと話しが発散したりもした。開発においてプラットフォーム的な投資も大事だと考えられている。うちのプロダクトで作る課題管理のメトリクスに、プラットフォーム投資のための見える化ができる機能もあるとよいのかもしれないと思ったりしていた。</p></div></article><article class="post on-list"><h1 class=post-title><a href=/diary/posts/2024/0827/>実際に動くようになってからわかること</a></h1><div class=post-meta><time class=post-date>2024-08-27 (Tue.) ::</time></div><span class=post-tags>#<a href=/diary/tags/programming/>programming</a>&nbsp;
#<a href=/diary/tags/business/>business</a>&nbsp;</span><div class=post-content><p>東京出張しての、隔週の定例会議にて、ある仕様について話しをした。これまでもずっとそういう仕様ではあったが、実際の本番運用が近づいてきて、実運用を考えているうちにある要件が出てきた。しかし、現状のシステムの構成上、その要件は満たせないことがわかった。1年半にわたって開発してきて初めてこの要件は現状のシステムの制約でできないと発言した。出来ないものは出来ないで仕方ない。それでも今更そんな要件が出てくるところに課題管理として出来ていなかった反省もあるし、気付きが足りなかった。私は20年も開発してきたからたいていの要件への対応は出来るだろうと、自身の経験から過信してしまっているところもあったなと思えた。やはりお仕事になるエンタープライズの要件はなかなか難しい。難しいからお客さんはお金を払って si 的なお仕事になるとも言える。自分への情けなさとそれでもできる範囲でやっていかないといけないという現実とを実感したひとときだった。</p></div></article><div class=pagination><div class=pagination__buttons><a href=/diary/posts/page/2/ class="button next"><span class=button__text>過去の日記</span>
<span class=button__icon>→</span></a></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2024 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>