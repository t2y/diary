<!doctype html><html lang=en><head><meta name=generator content="Hugo 0.101.0"><title>forest nook</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/><link rel=stylesheet href=/diary/assets/style.css><link rel=stylesheet href=/diary/assets/green.css><link rel=stylesheet href=/diary/style.css><link rel=apple-touch-icon href=/diary/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content="t2y"><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="forest nook"><meta property="og:description" content><meta property="og:url" content="/diary/"><meta property="og:site_name" content="forest nook"><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><link href=/diary/index.xml rel=alternate type=application/rss+xml title="forest nook"></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><div class=posts><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0812/>dto に対するリフレクションの是非</a></h1><div class=post-meta><span class=post-date>2022-08-12</span></div><span class=post-tags>#<a href=/diary/tags/game/>game</a>&nbsp;
#<a href=/diary/tags/java/>java</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#ドラクエタクトのリアルタイム対戦>ドラクエタクトのリアルタイム対戦</a></li><li><a href=#リフレクションのユーティリティを作った>リフレクションのユーティリティを作った</a></li></ul></nav></div><div class=post-content><p>1時に寝て7時に起きた。</p><h2 id=ドラクエタクトのリアルタイム対戦>ドラクエタクトのリアルタイム対戦</h2><p>もう2年間もずっとゲームし続けている。最近 <a href=https://game8.jp/dqtact/462546>リアルタイム対戦</a> モードがリリースされた。全然やる気なかったんやけど、リアルタイム対戦で得たコインでもらえるアイテムが魅力的なのでやることにした。そして、実際にアルタイム対戦をやってみるとはまる。運営の手の平でゲームさせられている。</p><ul><li>人間が相手で狡猾な戦略で負けると悔しい</li><li>人間が相手の戦略の方が創意工夫があって学びになる</li><li>実際にやり始めるとおもしろくなってきてずっとやってしまう</li></ul><p>できる時間を制限しているというのもうまいやり方だなと思っている。朝・昼・晩の7-9時、12-14時、19-22時に制限している。そこまでしてリアルタイムに人間同士をマッチングしてゲームさせる必要があるのか？という素朴な疑問に私は辿りつくが、おそらくゲーム開発者からみたらそうじゃない大事なユーザー体験があるのだろうと推測する。あと不思議なことが1つ。マッチングしていると、たまにわざと負けてくれる人がマッチングされる。チームのメンバーが1人で向こうが先行なら戦いを辞退 (こちらの勝ちになる) するし、こちらが先行でもすぐにやっつけられる。ちゃんと統計をとってないけど、20回に1回ぐらいの頻度でわざと負けてくれる人とマッチングする。あの人たちは一体どういう理由でわざと負けているんだろう？</p><h2 id=リフレクションのユーティリティを作った>リフレクションのユーティリティを作った</h2><p>いまお手伝いで開発している api サーバーは外界と内部のデータの境界を明確にわけていて、外向けのオブジェクト定義と内部向けのオブジェクト定義が異なる。ほとんど同じデータであっても dto を介して値を受け渡ししないといけない。そうすると、次のような dto と他のオブジェクトとの値渡しのための処理が型ごとにあちこちに実装されている。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> MyRecord <span style=color:#a6e22e>toMyRecord</span><span style=color:#f92672>(</span>MyDataInput in<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    var record <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> MyRecord<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    record<span style=color:#f92672>.</span><span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> in<span style=color:#f92672>.</span><span style=color:#a6e22e>id</span>
</span></span><span style=display:flex><span>    record<span style=color:#f92672>.</span><span style=color:#a6e22e>name</span> <span style=color:#f92672>=</span> in<span style=color:#f92672>.</span><span style=color:#a6e22e>name</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    record<span style=color:#f92672>.</span><span style=color:#a6e22e>someId1</span> <span style=color:#f92672>=</span> in<span style=color:#f92672>.</span><span style=color:#a6e22e>someId1</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    record<span style=color:#f92672>.</span><span style=color:#a6e22e>someId2</span> <span style=color:#f92672>=</span> in<span style=color:#f92672>.</span><span style=color:#a6e22e>someId2</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    record<span style=color:#f92672>.</span><span style=color:#a6e22e>someId3</span> <span style=color:#f92672>=</span> in<span style=color:#f92672>.</span><span style=color:#a6e22e>someId3</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    record<span style=color:#f92672>.</span><span style=color:#a6e22e>sortOrder</span> <span style=color:#f92672>=</span> in<span style=color:#f92672>.</span><span style=color:#a6e22e>sortOrder</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    record<span style=color:#f92672>.</span><span style=color:#a6e22e>createUser</span> <span style=color:#f92672>=</span> in<span style=color:#f92672>.</span><span style=color:#a6e22e>createUser</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    record<span style=color:#f92672>.</span><span style=color:#a6e22e>updateUser</span> <span style=color:#f92672>=</span> in<span style=color:#f92672>.</span><span style=color:#a6e22e>updateUser</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>メンバー数が20-30ぐらいあると、たまに値のセット忘れがあったり、あとから追加したメンバーの保守ができてないとか、たまにトラブルが起きる。これ自体は間違っているわけじゃなくて境界を明確にわけるメリットもあるのでプログラミングの煩雑さとトレードオフと言える。</p><p>最近、私が管理系の web api のエンドポイントを作る機会が多いせいか、dto と外部向けのオブジェクトを明確にわける必要のない要件もあったりする。試しにリフレクションを使って同名のフィールド間の値の受け渡しは自動でやってみたらどんな感じかな？と思って作ってみた。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ReflectionUtil</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>ReflectionUtil</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> AssertionError<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;ReflectionUtil is a utility class&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> Field <span style=color:#a6e22e>getField</span><span style=color:#f92672>(</span>Class<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> klass<span style=color:#f92672>,</span> String fieldName<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> klass<span style=color:#f92672>.</span><span style=color:#a6e22e>getDeclaredField</span><span style=color:#f92672>(</span>fieldName<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>NoSuchFieldException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#f92672>&lt;</span>T1<span style=color:#f92672>,</span> T2<span style=color:#f92672>&gt;</span> T2 <span style=color:#a6e22e>mapFieldValues</span><span style=color:#f92672>(</span>T1 fromInstance<span style=color:#f92672>,</span> T2 toInstance<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        var fromClass <span style=color:#f92672>=</span> fromInstance<span style=color:#f92672>.</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>var toField <span style=color:#f92672>:</span> toInstance<span style=color:#f92672>.</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getDeclaredFields</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            toField<span style=color:#f92672>.</span><span style=color:#a6e22e>setAccessible</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            var fromField <span style=color:#f92672>=</span> getField<span style=color:#f92672>(</span>fromClass<span style=color:#f92672>,</span> toField<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>fromField <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                fromField<span style=color:#f92672>.</span><span style=color:#a6e22e>setAccessible</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    toField<span style=color:#f92672>.</span><span style=color:#a6e22e>set</span><span style=color:#f92672>(</span>toInstance<span style=color:#f92672>,</span> fromField<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>fromInstance<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IllegalAccessException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span>e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> toInstance<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>これを使うと、先のコードがこれだけで済む。煩わしい値の受け渡しだけのコードを削減できる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>var record <span style=color:#f92672>=</span> ReflectionUtil<span style=color:#f92672>.</span><span style=color:#a6e22e>mapFieldValues</span><span style=color:#f92672>(</span>in<span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> MyRecord<span style=color:#f92672>());</span>
</span></span></code></pre></div><p>こんなことやると、セキュリティ的によくないとか反論されるかな？と思いながら pr を出してみたら思いの外、好評だったのでちょっと使ってみようと思う。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0811/>次のお仕事探し</a></h1><div class=post-meta><span class=post-date>2022-08-11</span></div><span class=post-tags>#<a href=/diary/tags/book/>book</a>&nbsp;
#<a href=/diary/tags/gig/>gig</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#智将諸葛孔明の兵法>智将・諸葛孔明の兵法</a></li><li><a href=#リモートワーク前提のお仕事>リモートワーク前提のお仕事</a></li></ul></nav></div><div class=post-content><p>22時に寝て5時に起きた。前日はあまり寝てなかったら眠くなった。午前中に昨日やり残した開発のお仕事を4時間ほどやってから自分の会社の雑務をしていた。</p><h2 id=智将諸葛孔明の兵法>智将・諸葛孔明の兵法</h2><p><a href=https://hipstergate.jp/column/zhuge-liang-kongming/>智将・諸葛孔明の兵法の書評</a> をみかけた。<a href=https://www.amazon.co.jp/%E6%99%BA%E5%B0%86%E3%83%BB%E8%AB%B8%E8%91%9B%E5%AD%94%E6%98%8E%E3%81%AE%E5%85%B5%E6%B3%95-%E9%AB%98%E7%95%A0-%E7%A9%A3/dp/4837913504>amazon.co.jp</a> に本の情報があることは確認できたが、1987年に出版された本なので在庫はないから諦めていた。たまたま先日メルカリで売っているのをみつけたので購入した (300円) 。第一部生涯 7.馬謖を斬るのところで第一次北伐の背景や概要が説明されている。馬謖が山の上に陣取ったのは短期決戦を意図してその優位性を取ろうとしたのだろうと著者の推察が述べられている。また馬謖を斬るにいたったのは軍律を守ることをすべてに優先したと説明されている。みずからが軍律を破ってしまうと蜀全体の維持が不可能になるだろうと著者も推察が述べられている。そのときに涙したことも触れているが、涙した理由の詳細については言及していない。</p><h2 id=リモートワーク前提のお仕事>リモートワーク前提のお仕事</h2><p><a href=/diary/posts/2021/0930/#カジュアル面談準備>以前、登録した人材紹介プラットフォーム</a> に <a href=https://remogu.jp/>remogu</a> さんがある。待遇のよい案件はほぼ東京か、あっても大阪になる。私は神戸に住んでいるので基本的にリモートワークでないとお仕事を探すのは難しい。remogu さんはリモートワーク前提なのでフィルター条件が1つ減るので検索しやすい。11月から新しいお仕事を探さないといけない。remogu さんのプロフィール情報を求職のステータスに更新しておいた。すると翌日に過去に面談したエージェントさんから連絡があって、すぐに希望に沿った案件を4つほど提案してくれた。その業務内容を今日みていたらどれも私の希望した業務内容に合致するものだったので優先順位とともに職務経歴書を更新して返信した。以前、面談したときもこのエージェントさんの印象はよかった。なにかしら相性があるのか、よい印象をもつエージェントさんだとよい提案をしてくれる。この前、初めて登録した人材紹介会社のエージェントさんとの面談はいまひとつだったのでなにかしらエージェントさんの質なのか、人間力の差による違いがあるんだなと思う。順番に面談していってマネジメントのキャリアを得られるかどうか、私にとっては大きな挑戦の1つになるので求職活動をがんばりたい。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0810/>アプリケーションとジョブの違いと一時停止</a></h1><div class=post-meta><span class=post-date>2022-08-10</span></div><span class=post-tags>#<a href=/diary/tags/kubernetes/>kubernetes</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#アプリケーションからジョブへの移行>アプリケーションからジョブへの移行</a></li></ul></nav></div><div class=post-content><p>2時に寝て5時に起きた。たった3時間しか寝てないのに夜中に1回は起きている。スポットで9時から会議が入ったのでそれまでに朝のお仕事を終わらせようと思ったら早起きできた。6時前にはオフィスに行ってお仕事を始められた。</p><h2 id=アプリケーションからジョブへの移行>アプリケーションからジョブへの移行</h2><p>k8s の cronjob を活用する前は spring の <a href=https://www.baeldung.com/spring-scheduled-tasks>Scheduled</a> アノテーションで定期実行処理を書いていた。アプリケーションサーバー内の1スレッドが定期実行していた。これはスケールアウト前提のアプリケーションサーバーには向いてなくて、複数のアプリケーションサーバーをスケールアウトさせてデプロイすると、定期処理も複数実行されてしまい、同時実行できない類の処理だと問題になる。k8s の cronjob は同時実行しない設定などもあるため、k8s の cronjob へ移行している。</p><p>移行作業の準備をしていてアプリケーションサーバーの pod は <code>replicas</code> を調整することで一時停止の代替となるオペレーションができる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl scale --replicas<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> deployment/my-app
</span></span><span style=display:flex><span>deployment.apps/my-app scaled
</span></span></code></pre></div><p>移行時のアプリケーションサーバーはこれで無効にしておき、cronjob に入れ替えるといった切り戻し可能な状態で移行できる。cronjob も <code>suspend</code> のフラグを使うことで一時停止できるので検証しながら双方を切り替えることができる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl patch cronjob my-batch-job1 -p <span style=color:#e6db74>&#39;{&#34;spec&#34;: {&#34;suspend&#34;: true}}}&#39;</span>
</span></span><span style=display:flex><span>cronjob.batch/my-batch-job1 patched
</span></span></code></pre></div></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0809/>ストーリーポイント捨てた方がよい</a></h1><div class=post-meta><span class=post-date>2022-08-09</span></div><span class=post-tags>#<a href=/diary/tags/scrum/>scrum</a>&nbsp;
#<a href=/diary/tags/issue-tracking-system/>issue tracking system</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#ストーリーポイント改善への再考>ストーリーポイント改善への再考</a><ul><li><a href=#リファレンス>リファレンス</a></li></ul></li></ul></nav></div><div class=post-content><p>2時に寝て5時に起きて7時半に起きた。夜も眠れなくなってきた。</p><h2 id=ストーリーポイント改善への再考>ストーリーポイント改善への再考</h2><p>プランニングしていたときに調査チケットをスパイクにしようという話題がでたときにストーリーポイントを割り振るかどうかという話しになった。スクラムマスターは5ポイント割り振ればよいと以前話していた気がする。そのときは時間がなかったから反論しなかったけど、ポイントと工数は別だからそれはよくないと反論した。割り当てたストーリーポイントに対して「○○さんならどのぐらいの時間でできますか？」と質問しているのがすでにおかしい。便宜上、ストーリーポイントはベロシティを計測して時間にマッピングされるかもしれないが、ストーリーポイントを直接時間にマッピングし始めると、担当者の個人差で大きく運用が変わってきてしまう。ストーリーポイントとスケジュールのアンマッチな部分を実際のスクラム運用でどう改善するのか？をつぶやいていたら、みずおちさんが返信してくれた。</p><blockquote class=twitter-tweet><p lang=ja dir=ltr>うーん、なるほど。。文脈によって色々ですが基本的に3か月以上先の見積もりについては妄想のようなもので、当てられないのではと自分は考えてますね。当てられるとしたら、何の技術的挑戦もないプロダクトなんだろうなと思ってしまいます。</p>&mdash; Mizuochi Keita (@mizuochikeita) <a href="https://twitter.com/mizuochikeita/status/1556966333723512832?ref_src=twsrc%5Etfw">August 9, 2022</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script><p>見積もる期間をなるべく小さくしてスケジュールを提示しないというのが戦略として正しいと思う。</p><p>あと実際には、打ち合わせの日程調整やレビュー待ちなどの待ち時間もあり、ストーリーポイントの複雑さや開発の工数だけでなく、リードタイムの概念もある。スケジュールは納期が決まっているけれど、リードタイムが伸びてしまったときに納期は伸びてくれないのでそのギャップもなにかしら反映する必要はあるが、ストーリーポイントではチケットの依存関係やリードタイムの遅れを反映することはできない。</p><h3 id=リファレンス>リファレンス</h3><ul><li><a href=https://www.ryuzee.com/contents/blog/7121>スクラムにおける技術的スパイクの進め方</a></li></ul></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0808/>k8s クラスターの service account とロール</a></h1><div class=post-meta><span class=post-date>2022-08-08</span></div><span class=post-tags>#<a href=/diary/tags/kubernetes/>kubernetes</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#k8s-クラスターの権限管理>k8s クラスターの権限管理</a></li></ul></nav></div><div class=post-content><p>23時に寝て6時に起きた。前日は夕方からだらだらしてた。</p><h2 id=k8s-クラスターの権限管理>k8s クラスターの権限管理</h2><p>初期のクラスターを私が構築したわけではないため、権限周りはあまりよくわかっていない。k8s には2つのユーザーアカウントがある。</p><ul><li>user account: 人向け</li><li>service account: アプリケーション向け</li></ul><blockquote><p>In this regard, Kubernetes does not have objects which represent normal user accounts. Normal users cannot be added to a cluster through an API call.</p><p><a href=https://kubernetes.io/docs/reference/access-authn-authz/authentication/#users-in-kubernetes>https://kubernetes.io/docs/reference/access-authn-authz/authentication/#users-in-kubernetes</a></p></blockquote><p>但し、ユーザーアカウントを表すオブジェクトはなく、api 経由でクラスターにユーザーを追加したりはできない。ユーザーは存在しないけど、認証はできる仕組みを私は知らないので関心がある。それはまた今度調べるとして、今回は service account の権限を変更した。service account は pod 内から k8s の api サーバーにアクセスするときの認証などに使われる。デフォルトの権限だと、api サーバーのエンドポイントへの書き込み権限がない (?) ようなので追加する。</p><blockquote><p>In order from most secure to least secure, the approaches are:</p><ol><li>Grant a role to an application-specific service account (best practice)</li><li>Grant a role to the &ldquo;default&rdquo; service account in a namespace</li><li>Grant a role to all service accounts in a namespace</li><li>Grant a limited role to all service accounts cluster-wide (discouraged)</li><li>Grant super-user access to all service accounts cluster-wide (strongly discouraged)</li></ol><p><a href=https://kubernetes.io/docs/reference/access-authn-authz/rbac/#service-account-permissions>ServiceAccount permissions</a></p></blockquote><p>セキュアな順番として上から自分たちの環境にあうかどうかを判断すればよい。私の場合、わざわざ新規に service account を作るほどの要件ではないため、2番目の <code>default</code> の service account にロールを与えることにした。<code>RoleBinding</code> というキーワードがあるので既存のクラスターロールから <code>edit</code> という権限を与える。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl create rolebinding default-edit-role --clusterrole<span style=color:#f92672>=</span>edit --serviceaccount<span style=color:#f92672>=</span>default:default --namespace default
</span></span><span style=display:flex><span>rolebinding.rbac.authorization.k8s.io/default-edit-role created
</span></span></code></pre></div><p>ここでは <code>default-edit-role</code> という RoleBinding を作成した。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl get rolebinding default-edit-role -o yaml
</span></span><span style=display:flex><span>apiVersion: rbac.authorization.k8s.io/v1
</span></span><span style=display:flex><span>kind: RoleBinding
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  creationTimestamp: <span style=color:#e6db74>&#34;2022-08-08T08:27:12Z&#34;</span>
</span></span><span style=display:flex><span>  name: default-edit-role
</span></span><span style=display:flex><span>  namespace: default
</span></span><span style=display:flex><span>  resourceVersion: <span style=color:#e6db74>&#34;152660975&#34;</span>
</span></span><span style=display:flex><span>  uid: 6de13b71-3103-448c-805a-66e9400f61c3
</span></span><span style=display:flex><span>roleRef:
</span></span><span style=display:flex><span>  apiGroup: rbac.authorization.k8s.io
</span></span><span style=display:flex><span>  kind: ClusterRole
</span></span><span style=display:flex><span>  name: edit
</span></span><span style=display:flex><span>subjects:
</span></span><span style=display:flex><span>- kind: ServiceAccount
</span></span><span style=display:flex><span>  name: default
</span></span><span style=display:flex><span>  namespace: default
</span></span></code></pre></div><p>これで cronjob から job を作成する権限が付与された。<a href=https://kubernetes.io/docs/reference/access-authn-authz/rbac/#write-access-for-endpoints>Write access for Endpoints</a> によると、新規に作成した v1.22 以降のクラスターではエンドポイントに対する write アクセス権限が異なるように記載されている。一方で v1.22 にアップグレードしたクラスターは影響を受けないとも記述されている。私がいま運用しているクラスターは v1.21 から v1.22 にアップグレードしたクラスターなので <code>edit</code> ロールでうまくいったのかもしれない。クラスターのバージョンによって設定が異なるかもしれない。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0807/>wiremock を使った kubernetes モックサーバーのテスト拡張</a></h1><div class=post-meta><span class=post-date>2022-08-07</span></div><span class=post-tags>#<a href=/diary/tags/kubernetes/>kubernetes</a>&nbsp;
#<a href=/diary/tags/java/>java</a>&nbsp;
#<a href=/diary/tags/testing/>testing</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#kubernetes-clients-のライブラリ実装>Kubernetes Clients のライブラリ実装</a></li></ul></nav></div><div class=post-content><p>2時に寝て7時に起きて9時までだらだらしてた。</p><h2 id=kubernetes-clients-のライブラリ実装>Kubernetes Clients のライブラリ実装</h2><p><a href=/diary/posts/2022/0806/#kubernetes-clients-のサンプル実装>昨日の続き</a> 。ある程度、クライアントの振る舞いを確認できたので自前のライブラリを作ることにした。ライブラリなのでテストをちゃんと書きたいと思って単体テストのやり方を調べてたら Kubernetes Clients のリポジトリにも単体テストはほとんどなくて、どうも e2e テストの方を重視しているようにもみえた。github issues を検索してみたら次の issue をみつけた。</p><ul><li><a href=https://github.com/apache/submarine/issues/956>[DESIGN] Add k8s mock client and server test case #956</a></li></ul><p>なにかしら単体テストの仕組みを作った方がいいんじゃないかという提案と一緒に issue の作者？かどうかはわからんけど、<a href=https://wiremock.org/>wiremock</a> を使ったテストのサンプルコードをあげていた。名前だけは聞いたことがあったけど、過去に使ったこともなく、どういうものか全くわかってない。ドキュメントを軽く読んでみたら http モックサーバーらしい。issue の内容を参考にしながら wiremock のドキュメントをみて junit5 のテスト拡張を書いてみた。これが適切な実装かはあまり自信がないけど、こんな感じでモックサーバーとモッククライアントの junit5 のテスト拡張を実装した。これは static なモックサーバーの設定になるので wiremock 自体の起動コストは速く感じた。ライブラリのテストとしては申し分ない。いまのところは自画自賛。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Documented</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Target</span><span style=color:#f92672>(</span>ElementType<span style=color:#f92672>.</span><span style=color:#a6e22e>FIELD</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Retention</span><span style=color:#f92672>(</span>RetentionPolicy<span style=color:#f92672>.</span><span style=color:#a6e22e>RUNTIME</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#a6e22e>@interface</span> KubernetesApiClient <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SetupKubernetesWireMock</span> <span style=color:#66d9ef>implements</span> BeforeAllCallback<span style=color:#f92672>,</span> BeforeEachCallback<span style=color:#f92672>,</span> ExtensionContext<span style=color:#f92672>.</span><span style=color:#a6e22e>Store</span><span style=color:#f92672>.</span><span style=color:#a6e22e>CloseableResource</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> Logger logger <span style=color:#f92672>=</span> LogManager<span style=color:#f92672>.</span><span style=color:#a6e22e>getLogger</span><span style=color:#f92672>(</span>SetupKubernetesWireMock<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> PORT <span style=color:#f92672>=</span> 8384<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> WireMockServer wireMockServer <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> WireMockServer<span style=color:#f92672>(</span>options<span style=color:#f92672>().</span><span style=color:#a6e22e>port</span><span style=color:#f92672>(</span>PORT<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>boolean</span> started <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> ApiClient apiClient<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>beforeAll</span><span style=color:#f92672>(</span>ExtensionContext context<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> Exception <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>started<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            wireMockServer<span style=color:#f92672>.</span><span style=color:#a6e22e>start</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            started <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>configureMockClient</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            var basePath <span style=color:#f92672>=</span> String<span style=color:#f92672>.</span><span style=color:#a6e22e>format</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;http://localhost:%d&#34;</span><span style=color:#f92672>,</span> wireMockServer<span style=color:#f92672>.</span><span style=color:#a6e22e>port</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>apiClient</span> <span style=color:#f92672>=</span> ClientBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>standard</span><span style=color:#f92672>().</span><span style=color:#a6e22e>setBasePath</span><span style=color:#f92672>(</span>basePath<span style=color:#f92672>).</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            logger<span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;started kubernetes wiremock: {}&#34;</span><span style=color:#f92672>,</span> basePath<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            context<span style=color:#f92672>.</span><span style=color:#a6e22e>getRoot</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getStore</span><span style=color:#f92672>(</span>GLOBAL<span style=color:#f92672>).</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;SetupKubernetesWireMock&#34;</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>beforeEach</span><span style=color:#f92672>(</span>ExtensionContext context<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> Exception <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>var instance <span style=color:#f92672>:</span> context<span style=color:#f92672>.</span><span style=color:#a6e22e>getRequiredTestInstances</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getAllInstances</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>var field <span style=color:#f92672>:</span> instance<span style=color:#f92672>.</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getDeclaredFields</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>field<span style=color:#f92672>.</span><span style=color:#a6e22e>isAnnotationPresent</span><span style=color:#f92672>(</span>KubernetesApiClient<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    field<span style=color:#f92672>.</span><span style=color:#a6e22e>setAccessible</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    field<span style=color:#f92672>.</span><span style=color:#a6e22e>set</span><span style=color:#f92672>(</span>instance<span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>apiClient</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>close</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> Throwable <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        wireMockServer<span style=color:#f92672>.</span><span style=color:#a6e22e>stop</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>configureMockClient</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// add static stubs for mock client
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        configureFor<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;localhost&#34;</span><span style=color:#f92672>,</span> PORT<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>stubForBatchGetCronjobs</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>stubForBatchGetSingleCronJob</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;my-job1&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>stubForBatchGetSingleCronJob</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;my-job2&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>stubForBatchGetSingleCronJob</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;my-job3&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>stubForBatchPostJob</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>stubForBatchGetJob</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> <span style=color:#a6e22e>getContents</span><span style=color:#f92672>(</span>String name<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        var json <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> File<span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getResource</span><span style=color:#f92672>(</span>name<span style=color:#f92672>).</span><span style=color:#a6e22e>getPath</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> Files<span style=color:#f92672>.</span><span style=color:#a6e22e>readAllBytes</span><span style=color:#f92672>(</span>Paths<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>json<span style=color:#f92672>.</span><span style=color:#a6e22e>getPath</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>stubForBatchGetCronjobs</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        var contents <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getContents</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/fixtures/kubernetes/batch/cronjobs.json&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        var path <span style=color:#f92672>=</span> urlPathEqualTo<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/apis/batch/v1/namespaces/default/cronjobs&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        stubFor<span style=color:#f92672>(</span>get<span style=color:#f92672>(</span>path<span style=color:#f92672>).</span><span style=color:#a6e22e>willReturn</span><span style=color:#f92672>(</span>aResponse<span style=color:#f92672>().</span><span style=color:#a6e22e>withStatus</span><span style=color:#f92672>(</span>200<span style=color:#f92672>).</span><span style=color:#a6e22e>withBody</span><span style=color:#f92672>(</span>contents<span style=color:#f92672>)));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>stubForBatchGetSingleCronJob</span><span style=color:#f92672>(</span>String jobName<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        var contents <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getContents</span><span style=color:#f92672>(</span>String<span style=color:#f92672>.</span><span style=color:#a6e22e>format</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/fixtures/kubernetes/batch/%s.json&#34;</span><span style=color:#f92672>,</span> jobName<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        var url <span style=color:#f92672>=</span> String<span style=color:#f92672>.</span><span style=color:#a6e22e>format</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/apis/batch/v1/namespaces/default/cronjobs/%s&#34;</span><span style=color:#f92672>,</span> jobName<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        var path <span style=color:#f92672>=</span> urlPathEqualTo<span style=color:#f92672>(</span>url<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        stubFor<span style=color:#f92672>(</span>get<span style=color:#f92672>(</span>path<span style=color:#f92672>).</span><span style=color:#a6e22e>willReturn</span><span style=color:#f92672>(</span>aResponse<span style=color:#f92672>().</span><span style=color:#a6e22e>withStatus</span><span style=color:#f92672>(</span>200<span style=color:#f92672>).</span><span style=color:#a6e22e>withBody</span><span style=color:#f92672>(</span>contents<span style=color:#f92672>)));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>stubForBatchPostJob</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        var name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/fixtures/kubernetes/batch/post-my-job.json&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        var contents <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getContents</span><span style=color:#f92672>(</span>name<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        var url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/apis/batch/v1/namespaces/default/jobs&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        var path <span style=color:#f92672>=</span> urlPathEqualTo<span style=color:#f92672>(</span>url<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        stubFor<span style=color:#f92672>(</span>post<span style=color:#f92672>(</span>path<span style=color:#f92672>).</span><span style=color:#a6e22e>willReturn</span><span style=color:#f92672>(</span>aResponse<span style=color:#f92672>().</span><span style=color:#a6e22e>withStatus</span><span style=color:#f92672>(</span>200<span style=color:#f92672>).</span><span style=color:#a6e22e>withBody</span><span style=color:#f92672>(</span>contents<span style=color:#f92672>)));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>stubForBatchGetJob</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        var name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/fixtures/kubernetes/batch/get-my-job.json&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        var contents <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getContents</span><span style=color:#f92672>(</span>name<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        var url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/apis/batch/v1/namespaces/default/jobs/my-job&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        var path <span style=color:#f92672>=</span> urlPathEqualTo<span style=color:#f92672>(</span>url<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        stubFor<span style=color:#f92672>(</span>get<span style=color:#f92672>(</span>urlPathEqualTo<span style=color:#f92672>(</span>url<span style=color:#f92672>)).</span><span style=color:#a6e22e>willReturn</span><span style=color:#f92672>(</span>aResponse<span style=color:#f92672>().</span><span style=color:#a6e22e>withStatus</span><span style=color:#f92672>(</span>200<span style=color:#f92672>).</span><span style=color:#a6e22e>withBody</span><span style=color:#f92672>(</span>contents<span style=color:#f92672>)));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0806/>Kubernetes Clients のサンプル実装</a></h1><div class=post-meta><span class=post-date>2022-08-06</span></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/kubernetes/>kubernetes</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#ストレッチ>ストレッチ</a></li><li><a href=#kubernetes-clients-のサンプル実装>Kubernetes Clients のサンプル実装</a></li></ul></nav></div><div class=post-content><p>23時に寝て7時半に起きた。夜中も2回ぐらい起きる。暑さでまいってきた。</p><h2 id=ストレッチ>ストレッチ</h2><p>今日の開脚幅は開始前159cmで、ストレッチ後162cmだった。数字は悪くない。いつもはストレッチを受けていると疲労しているところが伸びることで体が軽くなっていく感覚があるのだけど、今日は体全体がだるくてストレッチを受けていてもなんかしんどいなぁとだるさを感じていた。コロナに感染してないと思うけど、夏バテの状態をそのままストレッチにも持ち込んだような感覚があった。腰の張りや肩甲骨の硬さなどが少し気になったかな。トレーナーさんには立ったときの姿勢が少し前よりで重心のバランスがよくないといったアドバイスをされた。とくにどこが悪いというわけでもないのになんかしんどい。</p><h2 id=kubernetes-clients-のサンプル実装>Kubernetes Clients のサンプル実装</h2><p><a href=/diary/posts/2022/0804/>Kubernetes Clients の調査</a> の続き。java クライアントを使って minikube でいくつか動かしてみた。openapi で生成した rest api クライントが提供されている。デフォルト設定でも minikube で普通に動いたのでおそらく裏で <code>$HOME/.kube/config</code> をみたり <code>/var/run/secrets/kubernetes.io/serviceaccount/token</code> を読み込んで認証ヘッダーに設定してくれたりするのだと推測する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> ApiClient <span style=color:#a6e22e>getKubernetesClient</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    var client <span style=color:#f92672>=</span> Config<span style=color:#f92672>.</span><span style=color:#a6e22e>defaultClient</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    io<span style=color:#f92672>.</span><span style=color:#a6e22e>kubernetes</span><span style=color:#f92672>.</span><span style=color:#a6e22e>client</span><span style=color:#f92672>.</span><span style=color:#a6e22e>openapi</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Configuration</span><span style=color:#f92672>.</span><span style=color:#a6e22e>setDefaultApiClient</span><span style=color:#f92672>(</span>client<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> client<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>このクライアントを使って <a href=https://github.com/kubernetes-client/java/tree/master/kubernetes/docs>java/kubernetes/docs/</a> 配下にある api インスタンスを生成する。例えば、cronjob や job を扱うならば <code>BatchV1Api</code> というドキュメントがある。BatchApi だけでも3つのドキュメントがあるのでちょっとやり過ぎな気もする。</p><ul><li>BatchApi.md</li><li>BatchV1Api.md</li><li>BatchV1beta1Api.md</li></ul><p>kubectl コマンドで使う cronjob から手動で job を設定するのを実装してみる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl create job --from<span style=color:#f92672>=</span>cronjob/my-schedule-job my-manual-job
</span></span></code></pre></div><p>細かい設定はちゃんと調べないといけないけど、一応はこれで動いた。cronjob のオブジェクトを取得して job のオブジェクトを生成して create するだけ。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>var api <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> BatchV1Api<span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getKubernetesClient</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>var cronJob <span style=color:#f92672>=</span> api<span style=color:#f92672>.</span><span style=color:#a6e22e>readNamespacedCronJob</span><span style=color:#f92672>(</span>cronJobName<span style=color:#f92672>,</span> NAMESPACE_DEFAULT<span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>var ann <span style=color:#f92672>=</span> Map<span style=color:#f92672>.</span><span style=color:#a6e22e>of</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;cronjob.kubernetes.io/instantiate&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;manual&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>var metadata <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> V1ObjectMeta<span style=color:#f92672>().</span><span style=color:#a6e22e>name</span><span style=color:#f92672>(</span>newJobName<span style=color:#f92672>).</span><span style=color:#a6e22e>annotations</span><span style=color:#f92672>(</span>ann<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>var spec <span style=color:#f92672>=</span> cronJob<span style=color:#f92672>.</span><span style=color:#a6e22e>getSpec</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getJobTemplate</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getSpec</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>spec<span style=color:#f92672>.</span><span style=color:#a6e22e>setTtlSecondsAfterFinished</span><span style=color:#f92672>(</span>10<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>var job <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> V1Job<span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>apiVersion</span><span style=color:#f92672>(</span>cronJob<span style=color:#f92672>.</span><span style=color:#a6e22e>getApiVersion</span><span style=color:#f92672>())</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>kind</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Job&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>spec</span><span style=color:#f92672>(</span>cronJob<span style=color:#f92672>.</span><span style=color:#a6e22e>getSpec</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getJobTemplate</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getSpec</span><span style=color:#f92672>())</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>metadata</span><span style=color:#f92672>(</span>metadata<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>var result <span style=color:#f92672>=</span> api<span style=color:#f92672>.</span><span style=color:#a6e22e>createNamespacedJob</span><span style=color:#f92672>(</span>NAMESPACE_DEFAULT<span style=color:#f92672>,</span> job<span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
</span></span></code></pre></div><p>手動で作成した job の pod は終了後にゴミとして残ってしまうので ttl を設定すれば自動的に削除できることに気付いた。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>spec<span style=color:#f92672>.</span><span style=color:#a6e22e>setTtlSecondsAfterFinished</span><span style=color:#f92672>(</span>10<span style=color:#f92672>);</span>
</span></span></code></pre></div><p>k8s クラスターの内部、つまり pod 内からリクエストするには <a href=https://kubernetes.io/docs/reference/access-authn-authz/rbac/#service-account-permissions>ServiceAccount permissions</a> を適切に設定しないといけない。ひとまずローカルの minikube で super user 権限にしたらリクエストはできた。実運用では適切なロールを定義して適切に権限設定しないといけない。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl create clusterrolebinding serviceaccounts-cluster-admin <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --clusterrole<span style=color:#f92672>=</span>cluster-admin <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --group<span style=color:#f92672>=</span>system:serviceaccounts
</span></span></code></pre></div></div></div><div class=pagination><div class=pagination__buttons><span class="button previous"><a href=/diary/page/18/><span class=button__icon>←</span>
<span class=button__text>最近の日記</span></a></span>
<span class="button next"><a href=/diary/page/20/><span class=button__text>過去の日記</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>© 2021 Tetsuya Morimoto</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=/diary/assets/main.js></script>
<script src=/diary/assets/prism.js></script></div></body></html>