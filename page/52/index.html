<!doctype html><html lang=en><head><meta name=generator content="Hugo 0.123.1"><title></title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content="t2y"><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content><meta property="og:description" content><meta property="og:url" content="/diary/"><meta property="og:site_name" content><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/index.xml rel=alternate type=application/rss+xml title></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><div class=posts><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0830/>雰囲気だけで画面を作れた</a></h1><div class=post-meta><span class=post-date>2022-08-30 (Tue.)</span></div><span class=post-tags>#<a href=/diary/tags/vue.js/>vue.js</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#slots-で-v-data-table-のカラムを書き換える>slots で v-data-table のカラムを書き換える</a></li></ul></nav></div><div class=post-content><p>0時に寝て6時に起きた。</p><h2 id=slots-で-v-data-table-のカラムを書き換える>slots で v-data-table のカラムを書き換える</h2><p>昨日の続き。v-html で v-dta-table のカラム書き換えしてたら slots でやれと言われた続き。次のようなテンプレートのコードでカスタムカラムを配置するためのコンポーネントを作れば既存の vuejs の仕組みで保守もしやすそうに思う。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;my-wrapping-data-table&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;template</span> <span style=color:#960050;background-color:#1e0010>#[`item.data`]=&#34;{</span> <span style=color:#960050;background-color:#1e0010>item</span> <span style=color:#960050;background-color:#1e0010>}&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;my-custom-cell-layout</span> <span style=color:#a6e22e>:item=</span><span style=color:#e6db74>&#34;item&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;/template&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/my-wrapping-data-table&gt;</span>
</span></span></code></pre></div><p>vuejs のテンプレートのこの構文はどういう評価をされるのかが理解できない。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;template</span> <span style=color:#960050;background-color:#1e0010>#[`item.data`]=&#34;{</span> <span style=color:#960050;background-color:#1e0010>item</span> <span style=color:#960050;background-color:#1e0010>}&#34;</span><span style=color:#f92672>&gt;</span>
</span></span></code></pre></div><p>そしたら同僚がそれは次の構文のシンタックスシュガーだと教えてもらった。いずれにしても dsl 万歳って感じで私からは訳がわからない。雰囲気でテンプレート書いて動けばいいんだけど。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;template</span> <span style=color:#960050;background-color:#1e0010>v-slot:`item.data`=&#34;row&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;my-custom-cell-layout</span> <span style=color:#a6e22e>:item=</span><span style=color:#e6db74>&#34;row.item&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/template&gt;</span>
</span></span></code></pre></div><p>その後、要素の更新処理のモーダルダイアログ画面も作って1週間以上に渡って開発していた画面を一通り作り終えた。vuejs のことわかってない素人でも雰囲気だけで動く画面は作れた (pr のときにほとんどレビューで指摘を受けなかったので大半は間違ってはないのだろう) 。簡単と言えば簡単ではある。ちなみに私が作ったものが初のページング可能な一覧画面になる。検索フォームもページングに連動してクエリを実行できるようにすべてフルスクラッチでコンポーネントを作った。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0829/>v-html は使わなくてもよい</a></h1><div class=post-meta><span class=post-date>2022-08-29 (Mon.)</span></div><span class=post-tags>#<a href=/diary/tags/vue.js/>vue.js</a>&nbsp;
#<a href=/diary/tags/security/>security</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#任意のカラムの書き換え>任意のカラムの書き換え</a></li></ul></nav></div><div class=post-content><p>0時に寝て7時に起きた。また日曜日は寝てた。</p><h2 id=任意のカラムの書き換え>任意のカラムの書き換え</h2><p>v-data-table の、あるセルが複雑なデータをもっていて、単純にその値を表示するのではなく、一定の構造化やレイアウトを調整した状態で表示したい。セル内の構造を書き換える方法を私は知らなかったので <a href=https://v2.vuejs.org/v2/api/#v-html>v-html</a> という api を使って書き換えればよいのだと思った。しかし、これは間違いだった。間違いの訂正は翌日にやるとして仮に v-html を使うとしても xss の懸念があるのでスクリプトをエスケープしてあげないといけない。<a href=https://github.com/vuejs/vue/issues/6333>Sanitize v-html #6333</a> でも議論されていて vue3 はデフォルトでエスケープする仕組みが入るのかな？vue2 だと <a href=https://www.npmjs.com/package/sanitize-html>sanitize-html</a> を使って次のようにラップすればいいと書いてあった。実際に動かしてみるとスクリプトを実行できたので v-html は危険だというのはわかった。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;div</span> <span style=color:#a6e22e>v-html=</span><span style=color:#e6db74>&#34;$sanitize(value)&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span></code></pre></div><p>この仕組みを作って pr でレビューしてもらっていたら、カラムの構造を書き換えたいだけなら <a href=https://v2.vuejs.org/v2/guide/components-slots.html>slots</a> を使えば普通にできると教えてもらった。また明日へ。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0828/>夏休み2回目</a></h1><div class=post-meta><span class=post-date>2022-08-28 (Sun.)</span></div><span class=post-tags>#<a href=/diary/tags/day-off/>day off</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents></nav></div><div class=post-content><p>昨日は深夜も夕方もたくさん話して疲れたのか、ブログを書こうかと考えていたけど面倒になって休んでた。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0827/>eks クラスター障害のふりかえり</a></h1><div class=post-meta><span class=post-date>2022-08-27 (Sat.)</span></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/os/>os</a>&nbsp;
#<a href=/diary/tags/postmortem/>postmortem</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#ストレッチ>ストレッチ</a></li><li><a href=#os-雑談>os 雑談</a></li></ul></nav></div><div class=post-content><h2 id=ストレッチ>ストレッチ</h2><p>今日の開脚幅は開始前155cmで、ストレッチ後161cmだった。開始前の数値が悪いけど、とくに調子が悪いというわけでもなかったので計測の仕方がよくなかったか、たまたま足の開き方が悪かったかといったところだろう。昨日、高級時計と投資の話しを聞いたのでトレーナーさんとお金があったら何に使う話しが盛り上がった。トレーナーさんも庶民的な方でとくにお金があっても贅沢をしたいというものでもないらしい。私も改めてお金があったら何がしたいかを考えてみてもお金を使ってやりたいことはとくにないなというのが率直な思いでもある。私には自分がやったことのないことをやってみたいという思いしかなく、そのためにお金を使ってきた側面も多々あるけれど、お金を直接的に使って何かをやるというよりも、生活できるだけのお金があれば、その時間に自分がやったことのないことに挑戦して人生を楽しむということぐらいしかやることはないんだなと、トレーナーさんと話していて考えたりしていた。</p><h2 id=os-雑談>os 雑談</h2><p>午後から昨日の障害のふりかえりといくつか調査をして、夕方におがわさんに声をかけたら話し相手になってくれると返ってきた。障害のふりかえりをした後に課題管理の雑談もしていて4時間弱ぐらい話してた。私自身、反省しないといけないとは思っていたのでおがわさんはちゃんと指摘をしてくれた。この歳になると私を叱ってくれる人はいない。たまに失敗したときにおがわさんに話して然るべき指摘をしてもらえるのは本当にありがたい。</p><blockquote><p>kubernetes がどうやって動いているのかを理解して運用しているのか？</p><p>コンピューターがどうやって動いているのかを理解しているのか？</p></blockquote><p>私が未熟で理解できていなかったからこんな障害を見過ごしていた。システム障害が発生しても人生は終わりじゃない。反省してから次につなげる。おがわさんと話していて、os の仕組みや機能についていくつか教えてもらった。</p><ul><li>制限対象の違い<ul><li>ulimit はユーザーに対する制限</li><li>/proc ファイルシステムはシステムに対する制限</li></ul></li><li><code>/proc/sys/kernel/pid_max</code> は kernel のデフォルト値として 32768 が設定されているが、systemd を使っていれば値を変更している場合がある<ul><li>私の ubuntu マシンだと 4194304 が設定されていた</li></ul></li><li>コンテナ内から <code>/sys/fs/cgroup/memory/memory.usage_in_bytes</code> をみると、コンテナが使っているメモリ量なのか？<ul><li>cgroup の使い方次第で変わる、システムの値かもしれないしコンテナの値かもしれない</li></ul></li><li>ゾンビプロセスに残っている情報は親プロセスが子プロセスの統計情報を取得するために必要なもの<ul><li>どんな子プロセスも一時的にはゾンビプロセスになる</li><li>kernel の task_struct 構造体やその他の構造体、リンクしている情報などをすべて足すと1つのゾンビプロセスが10数 KiB 程度ではないか<ul><li>仮に 15 KiB として 32000 個のゾンビプロセスがあると約 469 MiB のメモリ量になるのでだいたい数字があう</li></ul></li></ul></li><li>ユーザー空間とカーネル空間の違いを理解できるようになった方がよい<ul><li>システムコールの fork がエラーになるのはシステムがおかしいとすぐに気付けるはず<ul><li>fork がエラーになる原因として考えられるのはメモリを確保できないか、pid_max に達したか、いずれにしてもエラーコードをみれば推測がつくのではないか</li></ul></li></ul></li><li>環境にログインできるのであれば <a href=https://strace.io/>strace</a> を使えば障害調査に役立つ<ul><li>私が普段使っていないツールなので障害のときにとっさに扱えるよう練習しておく</li></ul></li></ul></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0826/>簡単な現象の組み合わせ障害</a></h1><div class=post-meta><span class=post-date>2022-08-26 (Fri.)</span></div><span class=post-tags>#<a href=/diary/tags/kubernetes/>kubernetes</a>&nbsp;
#<a href=/diary/tags/datadog/>datadog</a>&nbsp;
#<a href=/diary/tags/operation/>operation</a>&nbsp;
#<a href=/diary/tags/drinking/>drinking</a>&nbsp;
#<a href=/diary/tags/tax/>tax</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#eks-クラスター障害の原因判明>eks クラスター障害の原因判明</a></li><li><a href=#呑み>呑み</a></li></ul></nav></div><div class=post-content><p>0時に寝て6時に起きた。</p><h2 id=eks-クラスター障害の原因判明>eks クラスター障害の原因判明</h2><p><a href=/diary/posts/2022/0820/#aws-インフラの調子が悪い>過去に2回発生していた eks クラスター障害</a> の原因がようやくわかった。テスト環境も本番環境は5日ごとに再現していて、datadog で k8s のダッシュボードでそれぞれの pod 単位のメモリ使用量をみると datadog-agent の pod がメモリリークしていることに気付いた。そこから当たりをつけて datadog-agent の issue を調べると次のバグに遭遇していた。</p><ul><li><a href=https://github.com/DataDog/datadog-agent/issues/12997>[BUG] agent leaves defunct processes with version 7.38.0 #12997</a></li></ul><p>ゾンビプロセスが生成されて、それが os のプロセス数上限に達してしまい、それによってプロセス (スレッド) が生成できなくなって、その結果として <a href=https://github.com/aws/amazon-vpc-cni-k8s>aws/amazon-vpc-cni-k8s</a> の <code>aws-node</code> という eks クラスターの管理アプリケーションが動かなくなって、それが動かないと k8s ノードのステータスが NotReady になってしまって、通常の pod のアプリケーションも動かなくなってしまうという現象が発生していた。datadog-agent のアップグレードは私が行ったものだし、その後の k8s ノードの監視や調査で気付きが足りなかったと反省した。</p><ul><li>datadog-agent の新しいバージョンをテスト環境でもうしばらく検証してもよかった</li><li>datadog-agent をリソースリークの可能性を私の中の調査対象から外していた<ul><li>世の中で使われているものに致命的なバグが起きないだろうという先入観があった</li></ul></li><li>プロセスを生成できない原因として考えられる背景を調査すべきだった<ul><li>ulimit を確認してリソース制限はないようにみえた</li><li>プロセス数やゾンビプロセスを調べていなかった</li><li>kernel に <code>/proc/sys/kernel/pid_max</code> という上限設定があることを知らなかった</li></ul></li><li>テスト環境と本番環境で5日程度で落ちるという周期性から気付くべきだった<ul><li>たしかにテスト環境から1日遅れて本番環境で障害が発生していた</li><li>周期性があることでリソースリークの可能性は高いとすぐに調査すべきだった</li></ul></li><li>datadog で k8s のダッシュボードを調べるべきだった<ul><li>すでに用意されているものがあったのでみようと思えばみえた</li></ul></li><li>aws のインフラ要因ではないかと疑っていた<ul><li>ごめんなさい</li></ul></li></ul><p>これは悔しい。自分の無能さや気付きの低さを実感した事件だった。私が注意深く観察していればもう1週間早く気付けた。そのせいで余分な障害と調査に時間を費やした。1つ1つは全く難しくない現象が巧妙に絡みあって隠蔽された結果としての状況に気付けなかった。注意して1つずつ観察して追跡していけばすぐに気付けた。本当に悔しい。</p><p>1つだけ言い訳をさせてもらうと、私は本番環境にアクセスできない。だからテスト環境と本番環境で発生している現象が同じかどうかを判断できず、調査を進める確証をもてなかった。</p><h2 id=呑み>呑み</h2><p>あまりに悔しかったのと調査してたら遅くなって晩ご飯食べる気力もなかったので気分転換に仲のよい焼き鳥屋さんに寄ってみた。あとから常連客のセブンイレブンの店長さんも来られて、私は初対面かなと思ってたんだけど先方は知っていると言ってたから以前にもカウンターでご一緒していたみたい。何気はなしに3人で2時前ぐらいまで雑談していた。</p><p>その店長さんがロレックスを購入しようと考えているという話しになって、資産または投資商品としてのロレックスの話しになった。たまたまヒカキンが1億円で買ったロレックスがいま2億円になっているといった話しがあったそうで、いまがバブルな状態らしいが、ロレックスをはじめとした高級時計の資産価値が上がっているらしい。私は腕時計を身につけないし高級時計もまったく興味はないが、投資商品の1つなんだというところに関心がもてた。</p><div class=video-container><iframe src=https://www.youtube.com/embed/1knsQZLeh7U allowfullscreen title=1億円で買った時計が大変なことになってしまいました…></iframe></div><p>中小企業の社長の一般的な節税方法の1つに外車を買ったり売ったりするという話しがある。儲かったときに経費で外車を買って、赤字のときに外車を売って雑所得に変える。車は社用車として経費で落とせるから可能なことだが、高級時計はどうなのだろうか？ 結論から言うと、普通の会社では高級時計は経費にできない。経費の原則は売上を上げるために必要な支出を経費とできる。普通の会社は高級時計で売上を上げることはできない。一方で経費として認められる職業もある。芸能人がそうだという。それは番組のために必要だという理屈で経費で落とせる。おそらくヒカキンも経費で高級時計を購入して、そのことを動画にしているのも仕事で必要だという言い訳作りの目的もあるのだと推測する。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0825/>vuetify のコンポーネント調査</a></h1><div class=post-meta><span class=post-date>2022-08-25 (Thu.)</span></div><span class=post-tags>#<a href=/diary/tags/vue.js/>vue.js</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#vuetify-で検索フォームのコンポーネント作成>vuetify で検索フォームのコンポーネント作成</a></li></ul></nav></div><div class=post-content><p>0時に寝て7時に起きた。</p><h2 id=vuetify-で検索フォームのコンポーネント作成>vuetify で検索フォームのコンポーネント作成</h2><p>ページング処理ができた。次に検索リクエストのための検索条件を扱うフォームを汎用コンポーネントで作ってみることにした。コンポーネントを生成するための検索条件のオブジェクトを外部から渡して、あとはよしなに <a href=https://vuetifyjs.com/en/components/grids/>grid</a> に構成要素を配置する。v-date-picker のところは本当はもっと凝った作りをしないといけない。ここでは型で分岐してコンポーネントを配置する概念を表しているだけ。v-col は cols は1から12までの数字を受け取る。この数値を調整して v-spacer を入れることで行の位置調整もできるのがひと工夫しているところ。イベントハンドラーは <code>click:search</code> とか <code>click:searchClear</code>のように名前を付け替えて、外部から意図したイベントのみをフックできるように考慮している。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span>&lt;<span style=color:#f92672>template</span>&gt;
</span></span><span style=display:flex><span>  &lt;<span style=color:#f92672>v</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#a6e22e>container</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>v</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#a6e22e>row</span> <span style=color:#a6e22e>dense</span>&gt;
</span></span><span style=display:flex><span>      &lt;<span style=color:#f92672>v</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#a6e22e>col</span> <span style=color:#a6e22e>v</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#a6e22e>for</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;item in conditions&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>cols</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;item.cols&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>key</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;item.label&#34;</span>&gt;
</span></span><span style=display:flex><span>        &lt;<span style=color:#f92672>v</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#a6e22e>switch</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>v</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#a6e22e>if</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Boolean === item.type&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>v</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#a6e22e>model</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;item.value&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>label</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;$t(item.label)&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>clearable</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;true&#34;</span>
</span></span><span style=display:flex><span>        /&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        &lt;<span style=color:#f92672>v</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#a6e22e>text</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#a6e22e>field</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>v</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#a6e22e>if</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;String === item.type&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>v</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#a6e22e>model</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;item.value&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>label</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;$t(item.label)&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>clearable</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;true&#34;</span>
</span></span><span style=display:flex><span>        /&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        &lt;<span style=color:#f92672>v</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#a6e22e>text</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#a6e22e>field</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>v</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#a6e22e>if</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Number === item.type&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>v</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#a6e22e>model</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;item.value&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;number&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>label</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;$t(item.label)&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>clearable</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;true&#34;</span>
</span></span><span style=display:flex><span>        /&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        &lt;<span style=color:#f92672>v</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#a6e22e>date</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#a6e22e>picker</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>v</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#a6e22e>if</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Date === item.type&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>v</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#a6e22e>model</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;item.value&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>clearable</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;true&#34;</span>
</span></span><span style=display:flex><span>        /&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        &lt;<span style=color:#f92672>v</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#a6e22e>spacer</span> <span style=color:#a6e22e>v</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#a6e22e>if</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;null === item.type&#34;</span>&gt;
</span></span><span style=display:flex><span>          <span style=color:#75715e>&lt;!--</span> <span style=color:#a6e22e>use</span> <span style=color:#a6e22e>an</span> <span style=color:#a6e22e>empty</span> <span style=color:#a6e22e>block</span> <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>grid</span> <span style=color:#a6e22e>layout</span> <span style=color:#f92672>--&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>/v-spacer&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>/v-col&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>/v-row&gt;</span>
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>v</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#a6e22e>row</span>&gt;
</span></span><span style=display:flex><span>      &lt;<span style=color:#f92672>v</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#a6e22e>col</span> <span style=color:#a6e22e>cols</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;4&#34;</span>&gt;
</span></span><span style=display:flex><span>        &lt;<span style=color:#f92672>v</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#a6e22e>btn</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>v</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#a6e22e>text</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;$t(&#39;label.clearSearchCondition&#39;)&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#960050;background-color:#1e0010>@</span><span style=color:#a6e22e>click</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;_searchClear&#34;</span>
</span></span><span style=display:flex><span>        /&gt;
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>/v-col&gt;</span>
</span></span><span style=display:flex><span>      &lt;<span style=color:#f92672>v</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#a6e22e>col</span> <span style=color:#a6e22e>cols</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;3&#34;</span>&gt;
</span></span><span style=display:flex><span>        &lt;<span style=color:#f92672>v</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#a6e22e>btn</span> <span style=color:#a6e22e>color</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;primary&#34;</span> <span style=color:#a6e22e>v</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#a6e22e>text</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;$t(&#39;label.search&#39;)&#34;</span> <span style=color:#960050;background-color:#1e0010>@</span><span style=color:#a6e22e>click</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;_search&#34;</span> /&gt;
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>/v-col&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>/v-row&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>/v-container&gt;</span>
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>template</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>script</span> <span style=color:#a6e22e>lang</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;ts&#34;</span>&gt;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>PropType</span>, <span style=color:#a6e22e>defineComponent</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;@vue/composition-api&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>SearchConditionItem</span>&lt;<span style=color:#f92672>T</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#a6e22e>any</span>&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>PropType</span>&lt;<span style=color:#f92672>T</span>&gt; <span style=color:#f92672>|</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>name</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>label?</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>col</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>value?</span>: <span style=color:#66d9ef>any</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>fromValue?</span>: <span style=color:#66d9ef>string</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>toValue?</span>: <span style=color:#66d9ef>string</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#a6e22e>defineComponent</span>({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>components</span><span style=color:#f92672>:</span> {},
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>props</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>conditions</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> Array <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>PropType</span>&lt;<span style=color:#f92672>SearchConditionItem</span><span style=color:#960050;background-color:#1e0010>[]</span>&gt;,
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span> () <span style=color:#f92672>=&gt;</span> [],
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>setup</span>(<span style=color:#a6e22e>props</span>, <span style=color:#a6e22e>context</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {};
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>methods</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>_search</span>(<span style=color:#a6e22e>value</span>: <span style=color:#66d9ef>any</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>$emit</span>(<span style=color:#e6db74>&#39;click:search&#39;</span>, <span style=color:#a6e22e>value</span>);
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>_searchClear</span>(<span style=color:#a6e22e>value</span>: <span style=color:#66d9ef>any</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>c</span> <span style=color:#66d9ef>of</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>conditions</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>value</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>fromValue</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>toValue</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>$emit</span>(<span style=color:#e6db74>&#39;click:searchClear&#39;</span>, <span style=color:#a6e22e>value</span>);
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>script</span>&gt;
</span></span></code></pre></div><p>呼び出し側ではこんな感じ。任意の conditions を渡し、検索ボタンをクリックしたときのイベントハンドラーを登録する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span>&lt;<span style=color:#f92672>search</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#a6e22e>condition</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#a6e22e>form</span>
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>conditions.sync</span><span style=color:#960050;background-color:#1e0010>=&#34;</span><span style=color:#a6e22e>searchCondition</span><span style=color:#960050;background-color:#1e0010>&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>@</span><span style=color:#a6e22e>click</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>search</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;search&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>v</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#a6e22e>on</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;$listeners&#34;</span>
</span></span><span style=display:flex><span>/&gt;
</span></span></code></pre></div><p>vuetify で初めてコンポーネントを作ってみた。雰囲気だけで実装している個人的な所感だけど、template, script, style を1つのファイルに同梱する考え方が私には馴染まない。1つのファイルに複数の構文が混在する認知負荷が気になるのと、1つのファイルに複数のコードを同梱しているメリットが私には感じられない。もしかしたら小さいシンプルなコンポーネントなら見通しがよいのかもしれない。しかし、業務での開発だと一定の複雑さをもつコンポーネントの方が大半だと思うので1ファイルが1画面におさまらない。どうせエディターを画面分割して複数画面でソースを読むのであれば、その画面のソースが1つのファイルでも別のファイルでも私にとってあまり大差ない。ファイル間の依存関係さえ適切に管理できればファイルは用途ごとに分割できた方が人間にとってわかりやすいのではないかとも思う。一方でフレームワーク側からみたら依存関係の解決はやや煩雑な処理になるので開発や依存管理がシンプルになってビルドが速くなるといったメリットがあったりするのかもしれない。どうなんだろう？</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0824/>vuejs の template 調査</a></h1><div class=post-meta><span class=post-date>2022-08-24 (Wed.)</span></div><span class=post-tags>#<a href=/diary/tags/operation/>operation</a>&nbsp;
#<a href=/diary/tags/vue.js/>vue.js</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#連日のサービスイン作業>連日のサービスイン作業</a></li><li><a href=#vuejs-の-template-と-expression>vuejs の template と expression</a></li></ul></nav></div><div class=post-content><p>0時に寝て6時に起きた。</p><h2 id=連日のサービスイン作業>連日のサービスイン作業</h2><p>引き続きサービスインの運用対応は大変そうでちゃんと検証していない修正を慌ててマージしようとしているからテスト環境まで壊れてて関係ない開発にも影響が出ていた。今日も別の施設のサービスインだったらしくて、ある機能がないとそのサービスインの切り替え作業ができないという話しだったそうで、当日に慌てて pr を作ってマージしてた。先週からわかっていた必要な機能を実装してなくて、週末は残業も休出もしてなくて、今日になって慌てて修正してマージしてた。昔の開発と比べてがんばっててできないのではなくて、いまの開発はがんばってないからできないという雰囲気になったなという印象。</p><h2 id=vuejs-の-template-と-expression>vuejs の template と expression</h2><p>あるフォームのコンポーネントを作ろうと思って interface を定義していてデフォルト値をテンプレート側に指定できるといいんじゃないかと考えた。というのは typescript の interface のメンバーは値を保持できないから。例えば、次のようなコードで <code>:cols="item.col ?? 2"</code> のように表現できたら嬉しいように思う。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;v-row</span> <span style=color:#960050;background-color:#1e0010>dense</span> <span style=color:#a6e22e>v-for=</span><span style=color:#e6db74>&#34;item in conditions&#34;</span> <span style=color:#a6e22e>:key=</span><span style=color:#e6db74>&#34;item.label&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;v-col</span> <span style=color:#a6e22e>:cols=</span><span style=color:#e6db74>&#34;item.col ?? 2&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>    {{ element }}
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;/v-col&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/v-row&gt;</span>
</span></span></code></pre></div><p>余談だけど、<code>??</code> は null 合体演算子という名前は知っていたけど、これを英語で何と呼ぶのか知らなかった。<a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Nullish_coalescing_operator>Nullish coalescing operator</a> と言う。ググってみると vuejs の issue でもそこそこ議論されていて vue3 からサポートするとしながら、根強い要望があるのか？ vue2 でも 2.7 でサポートしたらしい。こういうモダンな javascript の expression を ESNext syntax と呼んだりするみたい。それすらも知らなかった。</p><ul><li><a href=https://github.com/vuejs/vue/issues/11088>Optional chaining in templates does not seem to work #11088</a></li></ul><p>たまたまうちで使っているのは vue 2.6.14 なので vue 2.7 で動くのかどうか検証できないけど、いま使っている nuxtjs2 との依存関係があるのでそれ次第で vue 2.7 にアップグレードの可否が決まるらしい。全然フロントエンドの開発がわからないので、こういう基本的なところで引っかかると背景を調べるのに時間がかかる。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0823/>vuetify のイベントリスナーの調査</a></h1><div class=post-meta><span class=post-date>2022-08-23 (Tue.)</span></div><span class=post-tags>#<a href=/diary/tags/vue.js/>vue.js</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#vuetify-の-v-data-table-のページング処理>vuetify の v-data-table のページング処理</a></li></ul></nav></div><div class=post-content><p>4時に寝て7時に起きた。日曜日にたくさん寝たせいか、昨日は眠れなかった。サービスインの運用対応はまだまだドタバタしていてデータの不整合に苦しんでいるみたい。大変そうだけど、なにもやることない。</p><h2 id=vuetify-の-v-data-table-のページング処理>vuetify の v-data-table のページング処理</h2><p>昨日から vuetify のページング処理を調査している。コンポーネント的には2種類ある。</p><ul><li><a href=https://vuetifyjs.com/en/api/v-pagination/>v-pagination</a>: 汎用のページングコンポーネント</li><li><a href=https://vuetifyjs.com/en/api/v-data-table/>v-data-table</a>: data table のコンポーネント (ページング機能がある)</li></ul><p>既存のアプリケーションは nuxtjs で実装されているので vuetify や vue.js のサンプルコードをそのまま動かせるわけではない。丸1日、試行錯誤していてビューと値の束縛、イベントの伝搬などの振る舞いをだいたい理解できた。宣言的なフレームワークなので振る舞いを理解できれば開発量は少なく済む。但し、理解するまで振る舞いを理解するのに設定を試行錯誤で試して動かすのでデバッグは時間がかかる。一覧画面で使っている v-data-table のページング処理対応から始める。<a href=https://vuetifyjs.com/en/components/data-tables/#server-side-paginate-and-sort>Server-side paginate and sort</a> を参考にしながら v-data-table に加えた主な変更はこれら。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span>&lt;<span style=color:#f92672>v</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#a6e22e>data</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#a6e22e>table</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>...</span>
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>server</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#a6e22e>items</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#a6e22e>length</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;serverItemsLength&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>disable</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#a6e22e>pagination</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;disablePagination&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>hide</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#a6e22e>default</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#a6e22e>footer</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;hideDefaultFooter&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>options.sync</span><span style=color:#960050;background-color:#1e0010>=&#34;</span><span style=color:#a6e22e>options</span><span style=color:#960050;background-color:#1e0010>&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>footer</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#a6e22e>props</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    itemsPerPageOptions: [10, 20, 50, 100],
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  }&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>v</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#a6e22e>bind</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;$attrs&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>v</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#a6e22e>on</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;$listeners&#34;</span>
</span></span><span style=display:flex><span>&gt;
</span></span></code></pre></div><p>v-data-table をラップするコンポーネントでは次のようにイベントリスナーを登録する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span>&lt;<span style=color:#f92672>my</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#a6e22e>nice</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#a6e22e>component</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>...</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>￼</span> <span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>server</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#a6e22e>items</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#a6e22e>length</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;serverItemsLength&#34;</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>￼</span> <span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>disable</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#a6e22e>pagination</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;false&#34;</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>￼</span> <span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>hide</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#a6e22e>default</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#a6e22e>footer</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;false&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>@</span><span style=color:#a6e22e>update</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>options</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;dataOptionsHandler&#34;</span>
</span></span><span style=display:flex><span>&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>dataOptionsHandler</span>(<span style=color:#a6e22e>options</span>: <span style=color:#66d9ef>DataOptions</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>page</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>page</span> <span style=color:#f92672>??</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>limit</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>itemsPerPage</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>offset</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>limit</span> <span style=color:#f92672>*</span> (<span style=color:#a6e22e>page</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>    <span style=color:#75715e>// limit/offset を使った web api リクエスト
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  }
</span></span></code></pre></div><p><a href=https://v2.vuejs.org/v2/api/#vm-listeners>vm.$listeners</a> によると <code>v-on="$listeners"</code> のように書くと、ラップしているコンポーネントのイベントリスナーをよしなに伝搬してくれるみたい。これはこれで便利だけど、イベントリスナーの定義がどこにもでてこないのでコード検索ができなくなる。最近の宣言的なフレームワークの流行りと言えばそうだけど、知ってないとなんで動くのかわからないコードにはなる。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0822/>週明けのサービスイン</a></h1><div class=post-meta><span class=post-date>2022-08-22 (Mon.)</span></div><span class=post-tags>#<a href=/diary/tags/operation/>operation</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#3つ目のサービスイン>3つ目のサービスイン</a></li></ul></nav></div><div class=post-content><p>0時に寝て7時に起きた。</p><h2 id=3つ目のサービスイン>3つ目のサービスイン</h2><p>またまた私は勘違いしていて明日だと思っていたら今日が3つ目のサービスインだった。<a href=/diary/posts/2022/0719/#2つ目のサービスイン>約1ヶ月ぶりのサービスイン</a> になる。もう3回目なので要領よく切り替え作業やるのかなと眺めてたけど、新たなトラブルもいくつかあって、これまで同様、ドタバタしているようにみえる。私は本番環境にアクセスできないので何かトラブルがあっても聞いた内容から類推で助言を述べるしかできず、とはいえ、何かあったら質問がくるかもしれないからハドルに入って成り行きを見守ってないといけない。とくに手伝うこともないのにメンバーの作業が完了するまで待ってないといけない。この切り替え作業や運用対応をやっていると要件定義やコードレビューなどは放置されるのでまた作業のスケジュールが先送りになる。私は別に困らないけど、しばらくだらだらした開発が続く。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0821/>夏バテ</a></h1><div class=post-meta><span class=post-date>2022-08-21 (Sun.)</span></div><span class=post-tags>#<a href=/diary/tags/day-off/>day off</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents></nav></div><div class=post-content><p>だいぶ暑さはましになってきた感じはあるけど、なんか調子よくなくて寝てた。お腹空いたら外に出掛けるきっかけにもなるんだけど、暑さで食欲もあまりなくて珍しく1日中なにも食べなかった。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0820/>休日の本番障害</a></h1><div class=post-meta><span class=post-date>2022-08-20 (Sat.)</span></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/kubernetes/>kubernetes</a>&nbsp;
#<a href=/diary/tags/operation/>operation</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#ストレッチ>ストレッチ</a></li><li><a href=#aws-インフラの調子が悪い>aws インフラの調子が悪い？</a></li></ul></nav></div><div class=post-content><p>夕方から寝ていて何度か起きたものの、そのままずっと寝ていた。あまりないことなんだけど、珍しくたくさん眠れた。</p><h2 id=ストレッチ>ストレッチ</h2><p>今日の開脚幅は開始前160cmで、ストレッチ後163cmだった。計測の仕方がややいい加減だった気もしたが、先週より少しよくなったということにしておく。右腰の張りが強いのと肩が前に入りがちなので肩を開いて姿勢を保つように心がけるとよいとアドバイスをいただいた。もう通い始めて1年半ぐらい経つ。トレーナーさんも大半が入れ替わっていて通い始めたときに話しかけてくれた私が知っているトレーナーさんはほとんどいない。1年半も経つと人は変わっていくなというのを実感している。私の最初のトレーナーさんは社内制度で別の店舗の助っ人に行っているのでいなくなった人たちが辞めているわけでもないとは思うけど、1-2年で人が入れ替わってもサービスは継続していかないといけないし、会社ってそういうものだなと実感する機会でもある。</p><h2 id=aws-インフラの調子が悪い>aws インフラの調子が悪い？</h2><p>1-2週間ぐらい前からテスト環境を含めると複数回発生している <a href=/diary/posts/2022/0815/>eks クラスターの障害</a> がたまたま土曜日の夜という休日に発生した。いま eks クラスターのインフラの振る舞いを把握しているのは私だけなので、気付いてから指示を出して問題が発生している k8s ノードの削除 (ec2 インスタンスの削除) で復旧させるワークアラウンドで復旧させた。私は本番環境にアクセスできないので詳しい調査はできない。状況を正しく把握できてはいないけれど、k8s ノードが死んだり生き返ったりする不安定な状況に発生しているらしく、k8s ノードを削除して新規に作り直すと復旧することがわかっている。NotReady と Ready を繰り返したりしてアプリケーションの振る舞いが不安定になる。NotReady,SchedulingDisabled になれば、おそらく drain して k8s ノードが入れ替わってくれるのだけど、そうならない不安定な状況があるみたい。これ以上の調査は aws のサポートに問い合わせないとわからない。</p></div></div><div class=pagination><div class=pagination__buttons><a href=/diary/page/51/ class="button previous"><span class=button__icon>←</span>
<span class=button__text>最近の日記</span>
</a><a href=/diary/page/53/ class="button next"><span class=button__text>過去の日記</span>
<span class=button__icon>→</span></a></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2024 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>