<!doctype html><html lang=en><head><meta name=generator content="Hugo 0.109.0"><title>forest nook</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content="t2y"><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="forest nook"><meta property="og:description" content><meta property="og:url" content="/diary/"><meta property="og:site_name" content="forest nook"><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/index.xml rel=alternate type=application/rss+xml title="forest nook"></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><div class=posts><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0731/>久しぶりにブログを書いた</a></h1><div class=post-meta><span class=post-date>2022-07-31 (Sun.)</span></div><span class=post-tags>#<a href=/diary/tags/book/>book</a>&nbsp;
#<a href=/diary/tags/github/>github</a>&nbsp;
#<a href=/diary/tags/ci/cd/>ci/cd</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#もてなしだけではもう食えない>もてなしだけではもう食えない</a></li><li><a href=#backlog-github-integration-action-v101-リリース>backlog-github-integration-action v1.0.1 リリース</a></li></ul></nav></div><div class=post-content><p>2時過ぎに寝て7時に起きて9時まで寝てた。</p><h2 id=もてなしだけではもう食えない>もてなしだけではもう食えない</h2><p>読み進めておもしろかったし学びにもなったので書評を書いた。</p><ul><li><a href=https://note.com/t2y1979/n/nc5c156ae529e>もてなしだけではもう食えない -ホテル経営学の本質と実践-</a></li></ul><h2 id=backlog-github-integration-action-v101-リリース>backlog-github-integration-action v1.0.1 リリース</h2><p><a href=/diary/posts/2022/0710/#backlog-github-integration-action-のバグ修正>backlog-github-integration-action のバグ修正</a> した変更を v1.0.1 としてリリースした。2週間ほど検証環境でリグレッションがないかをみていた。問題なさそうなので v1 ブランチにマージして docker イメージを push して v1.0.1 タグを付けてリリース成果物を作成した。久しぶりにやると手順を忘れていてドキュメントを書かないといけないなとか思ったりした。</p><ul><li><a href=https://github.com/marketplace/actions/backlog-github-integration-action>backlog-github-integration-action</a></li></ul></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0730/>不思議の国のスモールオフィス</a></h1><div class=post-meta><span class=post-date>2022-07-30 (Sat.)</span></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/founding/>founding</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#ストレッチ>ストレッチ</a></li><li><a href=#スモールオフィスの内覧>スモールオフィスの内覧</a></li></ul></nav></div><div class=post-content><p>23時に寝て7時に起きた。今週は不規則な生活をしたのでバテた。</p><h2 id=ストレッチ>ストレッチ</h2><p>今日の開脚幅は開始前156cmで、ストレッチ後160cmだった。先週よりちょっと数値が悪くなった。自覚症状はなかったけど、ストレッチをしてみると右腰の張りがそこそこあることに気付いた。自覚症状のない疲労に気付けるのがストレッチのよいところの1つでもある。</p><h2 id=スモールオフィスの内覧>スモールオフィスの内覧</h2><p>たまたま <a href=https://www.kigyoplaza-hyogo.jp/>起業プラザひょうご</a> さんのスモールオフィスに空きがあるのをみつけたので内覧に行ってきた。電話したらとくに予約は取らなくてよいのでいつでも来てくださいと言われたのでアポなしで17時頃に行くことにした。現地のビルに行ってみたが、ビルが工事していて入れる状態ではない。なんかおかしいと思って調べたら地図には全然違う場所が示されていた。後で知ったことだが、<a href=https://www.kigyoplaza-hyogo.jp/news/%E7%A7%BB%E8%BB%A2%E3%81%AB%E4%BC%B4%E3%81%86%E4%B8%80%E6%99%82%E4%BC%91%E6%A5%AD%E3%81%AE%E3%81%8A%E7%9F%A5%E3%82%89%E3%81%9B/>2020年8月に移転していた</a> 。前に起業プラザひょうごさんに2-3回行ったことがあったけど、それは移転前だった。その後、移転したことを全く知らなかった。</p><p>このコワーキングスペース兼レンタルオフィスが三井住友銀行神戸本部ビルという旧居留地の真ん中に18F建ていう、この付近ではトップレベルの高層ビルと言える。そんなビルの2Fという「ん？」という場所にある。おそらくビルの名前から三井住友銀行の自社ビルだろう。1Fには銀行の窓口があり、窓口の前を横切る形でエスカレーターを上がると起業プラザひょうごさんのコワーキングスペースがあった。入り口には警備員さんが立っていて入ろうとすると「会員証をみせて」と止められた。内覧にきた旨を伝えると通してくれた。銀行のビルなので休日でも警備員さんが控えている。</p><p>2Fにエスカレーターで上がり、受付で内覧にきたことを伝えるとそのまま (おそらくアルバイトの) 若いお兄さんがあちこち案内してくれた。興味本位で「素朴な疑問なんだけど、どういう経緯で銀行の自社ビルの2Fの空きスペースみたいな場所を間借りできたんですか？」と聞いみたら、さすがにそれは分かりませんと返ってきたw</p><p>普通のオフィス (5.6㎡) と広いオフィス (8.4㎡) の2つに空きがある。</p><p><figure><img src=/diary/img/2022/0730_office1.jpg></figure><figure><img src=/diary/img/2022/0730_office2.jpg></figure></p><p>空きスペースをパーティションで区切っただけの簡易的なオフィスではあるけど、家賃は税込でそれぞれ 23,595 円と 33,275 円になる。登記さえできれば、オフィスの体裁は私にとってそこまで重要ではない。物理的なセキュリティの懸念として壁の上によじ登ることができるのはあるけれど、扉には鍵がかかる。床面積から比較するとレンタルオフィスとしては周りの平均よりも半額から1/4ぐらいの破格の価格設定と言える。一通り話しを聞いてみて引越し先として検討できるかどうかを確認していた。私にとっての一番の課題はこのビルに入れる時間帯が制限されていること。私は平日は7時台にはオフィスにいるし、夜も遅かったら3時ぐらいまで作業をするときもある。外的要因で時間の制約を課せられるのが私にとってはストレスとなる。22時をまわることは月に数回程度しかないからまだ譲歩できても朝9時というのは始業が遅過ぎる。</p><ul><li>平日: 9:00 - 22:00</li><li>土日祝: 10:00 - 20:00</li></ul><p>顧問のはらさんとも相談して懸念がなければ、審査を受けるだけ受けてみてもよいかもしれない。但し、三井住友銀行の拠点ビルとも言えるところにあるコワーキングスペースなのでうちみたいなマイクロ法人は審査が通らない可能性も高いと思われる。過去に三井住友銀行で法人口座開設の申請を出してお断りされた実績もあるのでそれを思い出してた。</p><p>外部の人を招いて無償の勉強会を開催してよいかどうかを確認したところ、会議室の予約さえとれれば開催してよいとのこと。さらに会議室の利用料は無料とのこと。会議室は定員6名が2部屋、10名が1部屋、20名は1部屋の合計で4部屋ある。定員20名の会議室と聞くと「はぁ？」って感じでそこもみせてもらった。広い部屋のスペースを贅沢に浪費した構成だった。「こんな広い部屋の会議室って普段使うんですかね？」と質問したら使っているところをみたことないと返ってきて笑ってしまった。定員20名の会議室でどんな会議をやるねん？オフラインの外部勉強会をやるとしたらスペースが広くて快適そうな場所ではあった。あと後ろの方はモニターみえないよね、おそらく。</p><figure><img src=/diary/img/2022/0730_office3.jpg></figure></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0729/>ストーリーポイント運用は信仰に近い</a></h1><div class=post-meta><span class=post-date>2022-07-29 (Fri.)</span></div><span class=post-tags>#<a href=/diary/tags/scrum/>scrum</a>&nbsp;
#<a href=/diary/tags/career/>career</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#ストーリーポイント見直し大会>ストーリーポイント見直し大会</a></li></ul></nav></div><div class=post-content><p>3時に寝て7時に起きた。一昨日からやっているリファクタリングが佳境なので1時ぐらいまでコードを書いてた。コミットするときにソースコードを自動整形したらリファクタリングと関係ないところに diff がたくさん出てしまって、数十箇所は diff と突き合わせながらフォーマットを手で直さないといけない状況になった。量が多かったので不満が溜まってコミットしたときに課題管理にこんなコメントをした。</p><blockquote><p>ソースコードがフォーマットされてないから自動フォーマットするとリファクタリングと関係ないところに差分が出るからそれを元のフォーマットに手作業で戻す作業を1時間ぐらいしてた。帰りたい。</p><p>2022/07/29 00:33:45</p></blockquote><p>翌朝に来た PO がたまたまコメントをみかけてデイリースクラムで質問を受けて恥ずかしかった。変なコメントしてごめんなさい。</p><h2 id=ストーリーポイント見直し大会>ストーリーポイント見直し大会</h2><p>導入前からもいまもずっと私は一貫してこのプロジェクトでストーリーポイントの運用は不向きではないかという姿勢をとっている。ストーリーポイントを嫌っているわけではなく、論理的にうまくいかない課題をどうやって解決して運用にのせるかの施策が何もないのに盲目的に運用しているところに懸念をもっている。私の懸念を解決する施策を誰かが責任をもって進めるなら反対することない。2時間という時間を設けていたのでストーリーポイントの是非も含めての見直し大会だと私は考えていた。しかし、そうではなかった。始まって30分ぐらいは見直し大会をどう進めるかの会議の進め方を議論していた。この時点では私はこの会議にやる気をなくした。誰もなにも準備してなく、ただ2時間という時間をとっただけの会議だった。次の1時間で直近の実際のチケットをもってきて、内容を説明してみんなでポイントを付けていく作業をしていた。その後の30分はプランニングポーカーやって遊んでただけ。ストーリーポイントの運用の見直しという視点は何もなくて、いまの数値はデタラメだから正しい数値がつくリファレンスストーリーを作り直せばいいというだけだった。誰も責任をもってないので時間を潰すだけの会議だったと思う。</p><p>ちょうど10月末でお手伝いを終了することを伝えたのもあって、プロジェクトから去る開発者があれこれ大勢側に疑義を申し上げるのもどうかという思いもあって、これ以上はストーリーポイントの運用に口出ししないことに決めた。おそらくチームというよりは組織としてどうしてもストーリーポイントを運用したい動機が別の理由からあるようにみえた。ストーリーポイントさえ付けておけば、プロジェクトのスケジュールがどうなっても誰も責任を追求されなくて責任者は楽なんだろうと推測する。</p><p>一方で、協力会社の若い開発者がチケットの内容を説明していて、何度か「コピペしただけ」という説明の仕方をした。私は違和感があって気になっていた。本人は悪気なく大した工数ではなかったと伝えたかったのだと思う。開発作業の説明でコピペしただけと発言して恥ずかしいという感覚もない。仮にコピペしたコードを扱うとしても、そのコードの拡張性や保守性を考慮して抽象化することはあるだろうし、論理にあわせて修正するからまったく完全なコピペなどあり得ない。この発言をプロの料理人に例えたら「既成品をレンジでチンしただけ」と言っているに等しい。推測だが、プロの料理人は仮に既成品を使ってもそのまま客に出すことはなく、必ずプロとしての付加価値をつけていると私は思う。プロの開発者として開発の姿勢に問題があることがわかってしまうのに加えて、ビジネスパーソンとしても適切な発言ではないことに気付いていないのが不憫に思えた。まともな会社で働いていれば、先輩に叱られたり指導を受けたりできるのが、そんなことすら知らずにキャリアを歩んでしまう懸念がある。このまま中堅になったときにどこかで失言して信頼をなくしてしまうのではないかと心配になった。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0728/>スクラムのふりかえりは感情に寄り添い過ぎ</a></h1><div class=post-meta><span class=post-date>2022-07-28 (Thu.)</span></div><span class=post-tags>#<a href=/diary/tags/founding/>founding</a>&nbsp;
#<a href=/diary/tags/scrum/>scrum</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#内覧前に>内覧前に…</a></li><li><a href=#大ふりかえり大会>大ふりかえり大会</a></li></ul></nav></div><div class=post-content><p>2時に寝て7時に起きた。前日はリファクタリングで0時過ぎぐらいまでコードを書いてた気がする。</p><h2 id=内覧前に>内覧前に…</h2><p><a href=/diary/posts/2022/0713/#窓付きオフィスの空きをみつけた>窓付きオフィスの空き</a> をみつけて内覧依頼をしていた。昨日入居者が退去したということで日程調整して今日の13時から内覧を申し込みしていた。朝起きて楽しみにしていたら、午前中に電話が掛かってきて昨日たまたま申し込みがあって成約してしまったとのこと。もちろん内覧前に成約があることは承知しているのでそれ自体は仕方ないことだと理解している。タイミングがよすぎて陰謀論のように妄想していた。本当はもっと事前に決まっていたのに連絡するのを忘れてたとか、私の場合は同じ施設間の移動になるので利益だけを考えると外部からのご新規さんを優先されたとか、いくつかパターンは考えられる。妄想遊びはともかく、最低でも1ヶ月前には空き情報がサイトに掲載されるので十分な時間があるので他のお客さんが申し込む可能性は高い。私はそれも含めて縁があるかどうかを試していたところはあった。これは縁がなかったということで受け入れた。契約はできないけど、今後のために内覧だけさせてほしいとお願いして行ってきた。普通に内覧してよい部屋だった。空いていれば内覧後にすぐ申し込みをしていたので1日の差で希望が叶わなかった。とはいえ、すでに内覧したので次に空きが出ているのをみつけたら内覧せずに申し込みできる状態になったとも言える。もしかしたら、昨日申し込みした人も私と同じように事前に内覧はしていたが、なんらかの理由で申し込みできなくて今回は縁があったのではないかとも考えられる。いずれにしても、また次の縁があるときを待つ。</p><p><figure><img src=/diary/img/2022/0728_office1.jpeg></figure><figure><img src=/diary/img/2022/0728_office2.jpeg></figure></p><h2 id=大ふりかえり大会>大ふりかえり大会</h2><p>サービスインが落ち着いたのでお手伝いしている開発プロジェクトの大きなふりかえりイベントがあった。スクラムのスプリントが1週間単位なのでふりかえり自体は毎週やっている。ホストがスクラムマスターで、どんな風に数ヶ月分の大きなふりかえりをするのか興味があったんだけど、とくに目新しいことはなく、総論として期待はずれだった。毎週のふりかえりイベントの延長でしかなく、区切りとしての総括もなければ、次の開発に向けての改善や展望もほとんどなかったと思う。スクラムマスターは業務を理解していないのでまともにファシリテーションできなかったとも言える。みんながんばった、サービスインできてよかった、これからもがんばっていこうのレベル。</p><p>スクラムマスターがこのプロジェクトに参加したのは昨年の10月で、私が11月からお手伝いしているのでほぼ同期だということもわかった。その開発プロジェクト自体はその1年前ぐらいからやっていたのかな？現時点で2年ぐらい経っているのだと推測する。私がイニシアティブをとったところで評判のよかった項目はこれら。コメントを求められたので、開発者が開発しやすい環境を作った方が開発のサイクルが早くなって結果的にプロダクトの品質が上がるという当たり前のことを話した。</p><ul><li>課題管理を backlog/github issues に分かれていた運用を backlog に一元化した</li><li><a href=/diary/posts/2022/0328/>backlog-github-integration-action の導入</a></li><li><a href=https://note.com/hoshino_technote/n/n6afff42aeee0>ビルド／デプロイのワークフロー改善</a></li></ul><p>1つがっかりしたのが、<a href=/diary/posts/2022/0726/>ストーリーポイントを用いたバーンダウンチャートの実績</a> のふりかえり。ネガティブな結果が出ているのに、そのバーンダウンチャートがあったから間に合わないということがわかって納期を延期できたみたいなことを話していて呆れてしまった。導入当初、納期が守れなくて五月雨式に延期してしまう課題への対応として導入したはずだった。導入時に私は2回スクラムマスターにストーリーポイントで納期を見積もるのは誤った運用だと指摘した。しかし、スクラムマスターが他プロジェクトでうまくいっているからと強引に導入した経緯がある。そして納期をまったく守ってもいないのにその事実を真剣に総括しようとしない姿勢が不誠実だった。また翌日ストーリーポイント見直し大会をするという話しがあったからこの場は丸くおさめた。</p><p>スクラムマスターはポジティブな内容とネガティブな内容を交互にふりかえるようにファシリテーションしていた。あとネガティブ内容の厳しい指摘は意図的に避けているようにもみえた。おそらく担当者の心情を慮ったのだろう。人を責めるわけではなく、ネガティブな事実や結果と向き合って、組織として仕組みで次の改善につなげるというのは、私が言うほど簡単ではないのかもしれない。私は sier 時代にお客さんからも社内からも怒られるのが日常だったからいまの若い人たちよりはネガティブな事実に対する耐性が高くてギャップに映るだけかもしれない。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0727/>無障害インフラ移行</a></h1><div class=post-meta><span class=post-date>2022-07-27 (Wed.)</span></div><span class=post-tags>#<a href=/diary/tags/infrastructure/>infrastructure</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#本番環境リリースのサポート>本番環境リリースのサポート</a></li></ul></nav></div><div class=post-content><p>0時に寝て6時に起きた。</p><h2 id=本番環境リリースのサポート>本番環境リリースのサポート</h2><p><a href=/diary/posts/2022/0719/#2つ目のサービスイン>サービスイン</a> のバタバタによって毎週の定例リリースを先週はやらなかった。そのため、今回は2週間分の変更をまとめてリリースすることになった。インフラの変更が複数あったので私も万全の準備をして作業に備えた。</p><ul><li><a href=/diary/posts/2022/0725/#waf-のカスタムレスポンス>waf を使ったメンテナンス切り替えの導入</a></li><li><a href=/diary/posts/2022/0720/>k8s のノードグループと nodeSelector の導入</a></li></ul><p>他にもいくつか本番のマスターデータの更新など、箇条書きにした作業項目は15個になった。今回はインフラとアプリケーションが相互に依存する変更を加えているので意図した順番で作業しないといけない。ノードグループ導入による k8s の作業内容は wiki にすべて作業方法を書いていたのでその通りに作業してもらった。メンテナンスモードに切り替える初動もうまくいったので現場の運用担当者が間違って使うこともない。意図した作業内容と順番でうまくリリース作業もできた。メンテナンス時間を2時間もらっていて、宿泊業だとその時間帯が12-14時になる。宿泊客のチェックアウト後、チェックイン前の空き時間だ。メンテナンス後に運用担当者にすぐ確認もしてもらえるし、リリース作業の時間帯としては深夜早朝にしなくてよいのは助かる。私が想定した通りに作業は進み、1時間でリリース作業を終えた。障害も一切なかった。インフラ担当者は想定外の障害に備えて、切り戻しやリスク管理をする。まったく問題なく想定内だったので晴れ晴れしい気持ちになった。こういう気持ちはインフラ担当者にしかわからないと思う。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0726/>ストーリーポイントの運用と現実</a></h1><div class=post-meta><span class=post-date>2022-07-26 (Tue.)</span></div><span class=post-tags>#<a href=/diary/tags/scrum/>scrum</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#ストーリーポイント再考>ストーリーポイント再考</a></li></ul></nav></div><div class=post-content><p>0時に寝て6時に起きた。</p><h2 id=ストーリーポイント再考>ストーリーポイント再考</h2><p>スクラムのふりかえりイベントでストーリーポイントの見直しをしようという話題が出た。この半年ほどストーリーポイントを使って実際に開発をやった事実から整理してみる。</p><ul><li>開発者のタスクも非開発者のタスクも同じ尺度のストーリーポイントを設定していた</li><li>あるチケットのタスクをやっていてチケット分割すると、最低でもストーリーポイントが1増えていた<ul><li>元チケットと分割したチケットのストーリーポイントの総数が同じであれば問題はないが、ストーリーポイント1が設定されたチケットを2つに分割するとそれぞれにストーリーポイント1をセットしても2倍になってしまう。タスク分割したのにストーリーポイントをゼロにセットするのもなんか違う</li></ul></li><li>ストーリーポイントの数値からバーンダウンチャートを生成した (みえる化)<ul><li>このバーンダウンチャートで運用して実際に2回の延期が発生し精度が低いことがわかった<ul><li>納期の2週間前に延期することがわかった</li><li>シニア開発者の勘と経験の方が精度が高かった</li></ul></li></ul></li></ul><p>これらの事実から私の所感をまとめてみる。</p><ul><li>開発者と非開発者 (プロダクトオーナー) の業務を同じ数値で表して合算するのは論理的におかしい</li><li>複雑な業務の開発プロジェクトでストーリーポイントの数値を設定するのは難しい<ul><li>複数のマイクロサービスを担当</li><li>複数の技術領域を担当 (インフラ、フロントエンド、バックエンド、要件定義)</li></ul></li><li>チケット駆動開発と相性が悪い<ul><li>チケット分割は担当者がタスクを完了させやすい粒度や内容で分割すればよかったのがストーリーポイントを考慮すると複雑さが増す</li><li>チケットの粒度はチームで統一されているのが理想的ではあるが、現実的にそのような運用の統制が取れているのを私はみたことがない<ul><li>チケットの粒度とストーリーポイントの合計に相関が出てしまい、それは個人差 (属人化) が生じやすい</li></ul></li></ul></li><li>安易なみえる化による弊害がある<ul><li>ストーリーポイントは開発の状況を表す指標の1つではあるが、現実をすべて表しているわけではない</li><li>多次元的なパラメーターからストーリーポイントというただ1つの指標を用いて2次元にすることで他の情報が欠落する<ul><li>偏ったデータによる意思決定に使われる懸念がある (その情報を外部に発信していればとくに)</li></ul></li></ul></li></ul><p>ストーリーポイントによる運用をうまくまわすにはいくつか制約があるように私からは思えた。</p><ul><li>開発プロジェクトのスコープや業務内容が一定の複雑さにおさめられる<ul><li>一定の制約や制限がないと論理的に説明可能な適切な数値を割り当てられない</li><li>例) 外部要因に影響をうけない1つのマイクロサービスを開発する</li><li>例) 開発者はフロントエンドだけの開発をする</li></ul></li><li>開発者と非開発者のタスクは別で管理する (合算しない)</li></ul></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0725/>メンテンナンス切り替えの設計</a></h1><div class=post-meta><span class=post-date>2022-07-25 (Mon.)</span></div><span class=post-tags>#<a href=/diary/tags/cdk/>cdk</a>&nbsp;
#<a href=/diary/tags/infrastructure/>infrastructure</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#waf-のカスタムレスポンス>waf のカスタムレスポンス</a></li></ul></nav></div><div class=post-content><p>0時に寝て6時に起きた。</p><h2 id=waf-のカスタムレスポンス>waf のカスタムレスポンス</h2><p>メンテンナンス時にエンドユーザーがアプリケーションにアクセスできないようにしたい。いろんなやり方があるけど、どういった手段で対応するのが最もシンプルで運用も容易かを少し前から頭を悩ませていた。</p><p>当初は cloudfront のディストリビューションをアプリケーションの assets とメンテナンスページの html の2つを作って、cdk のデプロイで切り替えできないかと考えた。cloudfront はドメイン名と密接に紐付いていて、同じドメイン名を2つのディストリビューションに設定することはできないようにみえる。あらかじめそれぞれのディストリビューションを2つ作っておいて route53 で必要に応じて向き先を切り替えるといった構成はできなかった。その次に waf について調べていたら waf がルールでカスタムレスポンスを返すことができることに気付いた。</p><ul><li><a href=https://aws.amazon.com/jp/blogs/news/customize-requests-and-responses-with-aws-waf/>AWS WAFによるリクエストとレスポンスのカスタマイズ</a></li></ul><p>ちょうどいまエンドユーザーからのアクセスは ipSet で許可し、それ以外のネットワークからのアクセスをブロックしていた。そのルールを更新して、メンテナンス時はエンドユーザーからのリクエストのみをブロックに変更してカスタムレスポンスを返せることに気付いた。waf を管理するスタックなら cdk デプロイで1分ぐらいで更新できた。このやり方のよいところの1つに開発者の ip アドレスを許可することで開発者だけはアクセスできるようにもできる。あと具体的に cdk でカスタムレスポンスをどう実装するかのドキュメントがわかりにくい。サンプルとしてはこんな感じ。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>acl</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>wafv2</span>.<span style=color:#a6e22e>CfnWebACL</span>(<span style=color:#66d9ef>this</span>, <span style=color:#e6db74>&#39;MyAcl&#39;</span>, {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>defaultAction</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>block</span><span style=color:#f92672>:</span> {} },
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;my-acl&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>scope</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;CLOUDFRONT&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>customResponseBodies</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>maintenanceInProgress</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>content</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;&lt;html lang=&#34;en&#34;&gt;Maintenance in progress&lt;/html&gt;&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>contentType</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;TEXT_HTML&#39;</span>,
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>rules</span><span style=color:#f92672>:</span> [{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>action</span><span style=color:#f92672>:</span> { 
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>block</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>customResponse</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>responseCode</span>: <span style=color:#66d9ef>503</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>customResponseBodyKey</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;maintenanceInProgress&#39;</span>,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>statement</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>ipSetReferenceStatement</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>arn</span>: <span style=color:#66d9ef>ipSet.attrArn</span>,
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }],
</span></span><span style=display:flex><span>});
</span></span></code></pre></div></div></div><div class=pagination><div class=pagination__buttons><a href=/diary/page/72/ class="button previous"><span class=button__icon>←</span>
<span class=button__text>最近の日記</span></a>
<a href=/diary/page/74/ class="button next"><span class=button__text>過去の日記</span>
<span class=button__icon>→</span></a></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>© 2021 Tetsuya Morimoto</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>