<!doctype html><html lang=en><head><meta name=generator content="Hugo 0.123.1"><title></title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content="t2y"><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content><meta property="og:description" content><meta property="og:url" content="/diary/"><meta property="og:site_name" content><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/index.xml rel=alternate type=application/rss+xml title></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><div class=posts><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0318/>gpt-4 に課金した</a></h1><div class=post-meta><span class=post-date>2023-03-18 (Sat.)</span></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/gpt/>gpt</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#ストレッチ>ストレッチ</a></li><li><a href=#gpt-4-談義>gpt-4 談義</a></li></ul></nav></div><div class=post-content><p>1時に寝て8時に起きた。昨日は久しぶりに飲みに行ってきてよい気分で寝た。</p><h2 id=ストレッチ>ストレッチ</h2><p>今日の開脚幅は開始前154cmで、ストレッチ後158cmだった。すねの外側の筋は大分よくなって通常の状態に近くなってきたと思う。今日の張りが強かったところは右股関節の内側と右腰になる。これまでもずっとよくない部分ではあるが、いつも体調に戻ってきたという見方もできる。あと右のお尻の後ろの筋もやや張りが強い気がした。2月中旬から納期に間に合わせるためにいくつかズルをしてきたところの埋め合わせというか、体調管理をこれから少しずつやっていく。結果的にその方が日々の活動のパフォーマンスが高くなる気がする。</p><h2 id=gpt-4-談義>gpt-4 談義</h2><p>タイムラインをみていると <a href=https://openai.com/research/gpt-4>GPT-4</a> がすごいという投稿が散見されるので課金して使ってみることにした。$20/月なので十分に安いと思う。会社のお金を自由にできると、技術調査や業務に関することの決済を即決できる。これは経験を積んでお金をかけるところとそうではないところに一家言もつようになってくるとそのストレスの度合いも違ってくる。まだ使い始めたばかりなので技術調査をするときにググる代わりに gpt-4 に尋ねて回答を確認するといった使い方しかしていない。具体的に言うとどう使ったらいいのかわからないので誰でもやる使い方から慣れていって、そのうちにもっと幅広い応用に気付くようになったらいい。</p><p>タイムラインをみてもどう使ったらいいかをあーだこーだと議論しているようにみえる。次の資料をみていて、対話形式というのは人間の質問や誤りの指摘をアノテーションとして gpt-4 はより正しい言葉選びをしているとある。ドメイン知識がある人が品質の高いアウトプットを得られるというのは、アノテーションを正しく gpt-4 に与えてあげないといけないという理屈で理解できた。</p><ul><li><a href=https://speakerdeck.com/eumesy/chatgpt-and-intro-of-ot-for-nlp>ChatGPT と自然言語処理 / 言語の意味の計算と最適輸送</a></li></ul><p>アノテーションの与え方が従来の検索のように lang=go のように構造化されたパラメーター指定ではなく、自然言語のまま非構造化データで与えられるというのが、従来の検索よりも進化したとも受け取れる。一方で gpt-4 に質問して文章を生成するのに1-2分かかるのでその待ち時間は検索よりも体験が悪い。私が大学のときはインターネット検索というのが普及し始めた時期だったから「どうやってその情報をみつけたの？」「検索するときにコツがあるんですよ」みたいな会話がよく聞かれた。いま gpt-4 を使っていて、その時代と同じような既視感を覚える。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0317/>syncrepl ことはじめ</a></h1><div class=post-meta><span class=post-date>2023-03-17 (Fri.)</span></div><span class=post-tags>#<a href=/diary/tags/ldap/>ldap</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#openldap-の-syncrepl>openldap の syncrepl</a></li></ul></nav></div><div class=post-content><p>1時に寝て5時に起きて7時に起きた。</p><h2 id=openldap-の-syncrepl>openldap の syncrepl</h2><p>openldap サーバー同士のレプリケーションの仕組みとして syncrepl (LDAP Sync Replication) と呼ばれる仕組みがある。experimental ではあるものの、仕様は rfc で提案されていてオープンになっている。実際には openldap サーバー (slapd) で実装されている参照実装が仕様みたいなものかもしれない。</p><ul><li><a href=https://www.rfc-editor.org/rfc/rfc4533.html>rfc-4533</a></li><li><a href=https://www.openldap.org/doc/admin25/replication.html>18. Replication</a></li></ul><p>既存の java のアプリケーションで syncrepl の機能を使うツールがあって、ソースコードを読むとかなりレガシーで、もっと言うと設計はひどく、コードも推定バグのような実装をみかけるのであまり使いたくない。go-ldap で syncrepl できれば作り直してしまえばよいのではないかと考えている。ドキュメントには provider (master) と consumer (slave) という用語で説明されているので pubsub に近いような仕組みで実装されているのではないかと推測する。slapd は provider にも consumer にもなる可能性があるのでどちらの実装ももっている。私がやりたいことは更新エントリを取得したいだけなので go-ldap で consumer として振る舞うモジュールのみを作ればよい。</p><p>基本的には openldap サーバーに接続して bind して、syncrepl に準拠したやり取りをすればよいのでそんな難しそうにはみえない。いくつかの定型的な通信の実装をすれば consumer ができるのではないかと思う。go-ldap のソースを grep してみる分には特別な機能はなさそうにみえる。ないならないで私が作ってもいいし、このライブラリでやらない方がよい背景があるのであれば、それに従う。ひとまず背景がわかっていないので issue を立てて聞いてみた。</p><ul><li><a href=https://github.com/go-ldap/ldap/issues/422>About implementing syncrepl (rfc-4533) consumer #422</a></li></ul></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0316/>ポインタの学び直し、参照とは違う</a></h1><div class=post-meta><span class=post-date>2023-03-16 (Thu.)</span></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/programming/>programming</a>&nbsp;
#<a href=/diary/tags/event/>event</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#go-の学び直し>go の学び直し</a></li></ul></nav></div><div class=post-content><p>2時に寝て7時に起きた。深夜に葬送のフリーレン10巻を読んでからなんとなく眠れなくて夜更かししてた。木曜日は会議がなくて自分のために時間を使える。機能開発に集中して実装していた。</p><h2 id=go-の学び直し>go の学び直し</h2><p><a href=https://tenntenn.connpass.com/event/275805/>Gopher塾 #4 - 私も解説できるポインタ - DAY1</a> に参加した。</p><p>今日のテーマはポインタ。tenntenn さんが話すのだから深い内部実装の話しなどもあるのかな？と期待していたけれど、これは基本的な go のポインタの扱いを学ぶ講義だった。私にとっては9割は知っていることだった。それでも1割は知らないことがあったので参加して勉強にはなった。この歳になると本やイベントから1-2割学べたら十分だと思う。go は内部的にすべて値渡しで何でもコピーするするといった振る舞いをする。ポインタを渡すと、ポインタの値であるアドレスをコピーすることでプログラムが動く。コピーなので大きな構造体をそのまま渡すとその分のメモリのオーバーヘッドがあって遅くなったりする。ポインタならアドレスだけのコピーで済む。</p><p>go には参照の概念はないという説明があって、ポインタと参照は別の概念なんだと今更ながらに気付いた。gpt-4 にポインタと参照の違いを尋ねたりしていた。参照は初期化後に変更できなかったり、null を参照できなかったり、ポインタ演算のようなことができなかったりすることで安全にプログラミングするための言語機能と言える。一般的には参照はポインタを使って実装される。ポインタの方が低レイヤで制約が少ないと言える。参照はポインタの一部の機能を安全にプログラマーに提供していると言える。</p><p>次に go のポインタの特徴をまとめる。</p><ul><li>型付け<ul><li>ポインタは型付けされていて、特定の型の変数のアドレスだけがその型のポインタに割り当てられる</li></ul></li><li>アドレス演算子とデリファレンス演算子<ul><li>これらを単項演算子と呼ぶ</li><li>アドレス演算子 (&) で変数のアドレスを取得してポインタを作成する</li><li>デリファレンス演算子 (*) でポインタが指すアドレスに格納されている値にアクセスする</li></ul></li><li>ポインタ演算制限</li><li>ポインタ演算は許可されていない、メモリアクセスの誤りやセキュリティ上の問題が軽減される</li><li>new と make 関数<ul><li>new 関数を使うと指定された型の新しい変数を作成してそのアドレスを返す</li><li>make 関数は、スライス、マップ、チャネルなどの複合データ構造を作成および初期化して、それらへのポインタを返す</li></ul></li><li>ポインタの nil 値<ul><li>ポインタは、無効なアドレスを表す特別な値である nil をもてる</li><li>nil ポインタにアクセスしようとすると、実行時に panic が発生する</li></ul></li><li>メソッドレシーバとしてのポインタ<ul><li>メソッドレシーバとしてポインタを使うとメソッド内でレシーバオブジェクトの変更ができる<ul><li>値レシーバは意図せぬ不具合を招く可能性があるから基本的にはポインタレシーバを使う方がよいのではないかといった話しもあった</li></ul></li></ul></li></ul></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0315/>キャッシュ機構の導入</a></h1><div class=post-meta><span class=post-date>2023-03-15 (Wed.)</span></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/tech-selection/>tech selection</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#キャッシュライブラリの選定>キャッシュライブラリの選定</a></li></ul></nav></div><div class=post-content><p>1時に寝て7時に起きた。リリース延期を決めたので3月末へのストレスやプレッシャーからは解放されていつもよりよく眠れた気がした。あくまで気がしただけ。</p><h2 id=キャッシュライブラリの選定>キャッシュライブラリの選定</h2><p>ある機能を作るための準備としてキャッシュ機構を作ることにした。<a href=https://github.com/avelino/awesome-go>avelino/awesome-go</a> を眺めて適当なキャッシュライブラリを選定する。シンプルな用途向け、オンメモリで goroutine-safe で保守されていて実績があるものでのバランスを取るときむらさんのキャッシュライブラリになった。</p><ul><li><a href=https://github.com/bluele/gcache>bluele/gcache</a></li></ul><p>ちょうどいまのお仕事を始める前に <a href=/diary/posts/2022/0920/#ブロックチェーンのお仕事の面談>スカウトをもらった会社</a> のテックリードがきむらさんだったので、いまはその会社にいるんだと思い出したのが半年前。きむらさんとはリアルで何年も会っていないし、仲がよいわけでもないけれど、なぜか facebook でも繋がっているので存在を忘れるということもない。</p><p>閑話休題。ある特定の mongodb コレクションのデータをキャッシュしたい。</p><p>キャッシュの生成。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>cache</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>gcache</span>.<span style=color:#a6e22e>New</span>(<span style=color:#ae81ff>128</span>).<span style=color:#a6e22e>Build</span>()
</span></span></code></pre></div><p>特定の用途で一部の処理だけ使いたいのでこんな感じでキャッシュの処理を実装した。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>value</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>cache</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>id</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>value</span>.(<span style=color:#f92672>*</span><span style=color:#a6e22e>myData</span>), <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>gcache</span>.<span style=color:#a6e22e>KeyNotFoundError</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#e6db74>&#34;failed to get value from cache&#34;</span>, <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>any</span>{
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;key&#34;</span>: <span style=color:#a6e22e>id</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;err&#34;</span>: <span style=color:#a6e22e>err</span>,
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 通常処理
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>cache</span>.<span style=color:#a6e22e>Set</span>(<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>setting</span>)
</span></span></code></pre></div><p>念のため、キャッシュをすべてクリアするときは次を呼ぶ。これをキャッシュ制御 api から呼び出せるようにしておく。何らかの理由やバグなどでキャッシュをクリアする必要もあるだろう。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>cache</span>.<span style=color:#a6e22e>Purge</span>()
</span></span></code></pre></div><p>データを削除したときは id 指定でキャッシュを削除する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>cache</span>.<span style=color:#a6e22e>Remove</span>(<span style=color:#a6e22e>id</span>)
</span></span></code></pre></div><p>キャッシュが使われているかどうかは内部的に統計を取っているのでそれをキャッシュ制御 api から取得することでわかる。
キャッシュが使われていれば HitCount が増え、mongodb にアクセスしていれば MissCount が増える。単体レベルでプログラムのデバッグにはなる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>return</span> <span style=color:#a6e22e>CacheStat</span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>HitCount</span>:    <span style=color:#a6e22e>cache</span>.<span style=color:#a6e22e>HitCount</span>(),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>MissCount</span>:   <span style=color:#a6e22e>cache</span>.<span style=color:#a6e22e>MissCount</span>(),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>LookupCount</span>: <span style=color:#a6e22e>cache</span>.<span style=color:#a6e22e>LookupCount</span>(),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>HitRate</span>:     <span style=color:#a6e22e>cache</span>.<span style=color:#a6e22e>HitRate</span>(),
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0314/>リリース延期</a></h1><div class=post-meta><span class=post-date>2023-03-14 (Tue.)</span></div><span class=post-tags>#<a href=/diary/tags/windows/>windows</a>&nbsp;
#<a href=/diary/tags/project-management/>project management</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#windows-インストーラー開発>windows インストーラー開発</a></li><li><a href=#リリース延期>リリース延期</a></li></ul></nav></div><div class=post-content><p>3時に寝て7時に起きた。昨日は遅くまで確定申告の準備をしてたから寝坊した。その分8時半に申告会場に立ち寄ってからオフィスに出社したので普段よりも朝はゆっくりできた。</p><h2 id=windows-インストーラー開発>windows インストーラー開発</h2><p>windows のインストーラーを作る方法は2-3種類ほどあるそうだけど、もっとも標準的な visual studio に付属しているツールでインストーラーを作っている。特性の違う2つのアプリケーションを1つのインストーラーで扱っていると、アップデートやアンインストールでいろいろ不都合が生じるように思えたのでインストーラーを2つに分割したらよいのではないか？と先週末に助言をしていた。すると、1つのアプリケーションを2つのインストーラーを使ってセットアップするようなものを作ってしまって、複雑さはなにも解消していなくて、全然意図したものではないと訂正して作り直してもらうことになった。</p><p>私の指示が2つに分割すればよいという曖昧な助言だったのもよくないけれど、1つのアプリケーションを2つのインストーラーで操作するという発想が私の中になくて勘違いする余地があったんやと失敗体験となった。</p><p>一方でメンバーが「最初からそう言ってくれればよかったのに、、、」とか言い始めて、この姿勢はよくないなとも感じた。この問題の責任は指示が曖昧だった私にあるのは間違いないが、1つのアプリケーションを2つのインストーラーでインストールするという考え方に疑問を抱かないのは怠慢だし、実際にそのやり方で問題は解決していなかった。なんのために設計するかを当事者意識をもって開発していたら、言ってくれなかったから分からなかったという考え方にはならない。勘違いしていたとか、気付きが足りなかったとか、そういう言葉がほしかった。</p><p>定例会議で、意図しているのは、特性の違う2つのアプリケーションをそれぞれ独立させて制御すればシンプルになるよと説明して、もう一度作り直してもらって、結果として意図した通りシンプルにインストールを扱えるようになった。</p><h2 id=リリース延期>リリース延期</h2><p>昨日書いた通り、基準となる issue をすべて fix できないことが確認できたのでそれを説明して4月末まで延期とした。これにより、遅れていた機能開発には十分な期間を取れるし、QAテストのための準備にも余裕をもてる。インフラやドキュメントを整備する時間もあるだろう。</p><p>今月の私の稼働時間は (契約は160時間だけど) おそらく200時間を余裕で越えるだろうし、記帳していない稼働時間も含めれば230時間ほどはいくのではないかと思う。私の中では納期に間に合わせるためにがんばる意思はあったんだけど、クリティカルパスはすべて私が担当するといった調整をできなかったので仕方ないなといった落とし所で来月への延期を正当化した。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0313/>期日前の敗北</a></h1><div class=post-meta><span class=post-date>2023-03-13 (Mon.)</span></div><span class=post-tags>#<a href=/diary/tags/project-management/>project management</a>&nbsp;
#<a href=/diary/tags/tax/>tax</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#リリース判定前>リリース判定前</a></li><li><a href=#2022年度の個人の確定申告>2022年度の個人の確定申告</a></li></ul></nav></div><div class=post-content><p>0時に寝て6時半に起きた。日曜日に1ヶ月振りのお休みをとったので体力はぐっと回復した。</p><h2 id=リリース判定前>リリース判定前</h2><p>明日をリリース延期を判断する期日としている。明日でリリースまでに対応しないといけない enhance ラベルが付いたタスクを fix できなかったら延期を決定すると先週の定例で基準を決めた。私がやろうと思っていたタスクは今日すべて fix したけれど、全体として fix できそうにないタスクが2つ残っている。さらに今日、検証していてリリースまでにやった方がよい enhance を2つみつけたので1ヶ月延期した上で、この2つも追加でやってしまおうかと考えている。事実上、今日の進捗をみた時点で明日の定例会議では延期の決断をする。がんばったけど、ダメなもんはダメなので潔く敗北を認めて残っている開発課題を今月末までに fix するようにスケジュールを調整していく。その分 QA テストのための工数を多く取れるのでテストツールを作ったり、結合テストを追加したりなど、余裕があれば品質を上げるためにできることも増える。1ヶ月前倒しにしていたから元の計画に戻るだけだし、私が管理対象にしていないモジュール群の開発遅れ (開発は不要と当初言われてた) なのでそもそも計画になかった。計画になかったとはいえ、その対応への気付きが遅れて、担当変更が遅れて、最終的にリリースが遅れたことはマネージャーとしての私の責任なのでシンプルに悔しい。もっとうまいやり方はあったはず。</p><h2 id=2022年度の個人の確定申告>2022年度の個人の確定申告</h2><p><a href=/diary/posts/2022/0206/#2021年度の個人の確定申告>昨年の確定申告はこちら</a> 。</p><p>一旦20時頃に家に帰って晩ご飯を食べてから21時にオフィスに戻ってきて確定申告の作業を始めた。15日(水)までなのでわりとぎりぎり。本当は日曜日にやろうと思っていたのにお休みしてしまったのでこんな時間から始めることになった。確定申告も例年と同じになっていて、且つ、いまは副業を受けていないので特別な売上や経費の登録をすることもない。取引一覧でやることは次の2つ。</p><ul><li>源泉徴収済みの印税収入を、売上と源泉徴収税の2つの明細として登録し直す</li><li>寄付金の明細登録</li></ul><p>これは15分ほどで完了してそれから確定申告書を作る。<a href=https://www.freee.co.jp/accounting/individual/fr-fhrt92en/>freee 確定申告</a> を5年以上使っている。その後の手続きも決まっていてワークフローに従ってこれらの入力を行う。</p><ul><li>源泉徴収票からの転機</li><li>印税売上を源泉徴収済み雑収入として登録</li><li>ふるさと納税と npo 向けの寄付金の登録</li><li>株式の取引報告書の登録 (損益通算)</li><li>小規模企業共済の所得控除の登録</li></ul><p>印税売上は源泉徴収済みなので無視してもよいが、寄付金や共済の所得控除があるので毎年行うことで節税になる。書類はすべて揃っていたので証明書を確認しながらワークフローを進めて3時間もあれば確定申告書を完成した。プリンタで紙に印刷して2箇所にマイナンバーを記載して、台紙に寄付金と共済の証明書を添付する。この証明書の添付をどうやって電子化して申告したらよいかわからないので毎年紙で提出している。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0312/>春休み</a></h1><div class=post-meta><span class=post-date>2023-03-12 (Sun.)</span></div><span class=post-tags>#<a href=/diary/tags/day-off/>day off</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents></nav></div><div class=post-content><p>朝起きたんだけど、なんかしんどくてそのまま寝てだらだらしてた。今日は久しぶりにお休みしてた。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0311/>夕方からお休み</a></h1><div class=post-meta><span class=post-date>2023-03-11 (Sat.)</span></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#ストレッチ>ストレッチ</a></li></ul></nav></div><div class=post-content><p>2時半に寝て8時に起きた。お昼から少し作業して夕方にお蕎麦食べに出掛けてそれから家に戻って休んでたらそのまま寝てた。</p><h2 id=ストレッチ>ストレッチ</h2><p>今日の開脚幅は開始前157cmで、ストレッチ後159cmだった。ここ1ヶ月ほど患っていたすねの外側の筋の張りはまだ残っているものの先週より少しよくなった。復調の兆しがみえてきてよかった。出張戻りはいつも体調が悪めなものの、悪いだろうと予期していたほどは悪くなく、それまでの大量がよくなかった分だけ復調しているようにも感じ取れた。いまの状態は複雑。いつも担当してもらっているトレーナーさんが会社の技能試験のようなイベントの全国大会に出るという。全国で予選を勝ち抜いた人だけが参加できるそうで、200店舗以上ある中での予選を勝ち抜いた数人 (十数人？) が選抜されて全国大会に出れるという。それなりの倍率の予選を勝ち抜いたということなので改めてこのトレーナーさんはすごかったんやと見直した。全国大会もがんばってほしい。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0310/>昔の上長の背中を追う</a></h1><div class=post-meta><span class=post-date>2023-03-10 (Fri.)</span></div><span class=post-tags>#<a href=/diary/tags/team-building/>team building</a>&nbsp;
#<a href=/diary/tags/communication/>communication</a>&nbsp;
#<a href=/diary/tags/project-management/>project management</a>&nbsp;
#<a href=/diary/tags/career/>career</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#伴奏>伴奏</a></li><li><a href=#昔の自分といまの自分>昔の自分といまの自分</a></li></ul></nav></div><div class=post-content><p>2時に寝て7時半に起きた。昨日もWBCをみてから晩ご飯を食べて軽く作業してそのまま寝た。</p><h2 id=伴奏>伴奏</h2><p>ここ2-3日若いメンバーの開発をサポートしている。</p><blockquote><p>「◯◯ができません」</p><p>私が5分ほどでググってできそうなドキュメントや so をみつけてリンクを貼る。</p><p>「できました。」</p></blockquote><p>みたいなやり取りを何度かした。大して難しくない処理を実装できないのは公式ドキュメントをちゃんと読んでいないのと、インターネットの検索方法を習得していないように私からはみえる。一度、定例会議のときに google の言語設定を英語にした方がよい。日本のキュレーションサイトの記事の品質は低いからと伝えたが、まだそれを実践しているようにはみえない。いまや英語は deepl で翻訳すれば大半を斜め読みできる。私も deepl で読んでいると教えたりしているのだけど、日本語の記事しか検索していないから未知のことをできないとなってしまう。</p><p>チャットで困っていることや問題点を整理したり、どういう視点で調べていくかをやり取りしながら本人が理解して作業できるようにサポートしている。私がやれば10分で終わるようなことを2時間ぐらいかけてチャットしている。それで昼間は自分のお仕事をやらずチャットの話し相手を務めている。誰もが最初は初心者なのでそういう時期はある。以前は質問すらできていなかったところを、あれができないとか、これがわからないとか質問できるようになったというのは成長したと受け取れる。わからないことを説明してもらうことで、私も相手のことを理解できて適切な指示や指導ができる。その過程でプログラミングの理解度も測れるので issue をアサインするときの参考にもなる。</p><p>曖昧なことをチャットで聞くのは効率が悪いから、口頭であれこれ質問してくれるようになるのがこの次のステップかな。以前と比べて質問してくれるようになったので信頼関係は少しずつ構築できてきつつあるのかもしれない。</p><h2 id=昔の自分といまの自分>昔の自分といまの自分</h2><p>既存のある java のコードを読んでいて、私の中ではワーストから数えた方が早いほどのひどいコードをみている。java の言語仕様もプログラミングもどちらもよくわかっていない人がキュレーションサイトにあるような記事を読んで動くように作ったようなツールにみえる。アリエルを辞めてからいくつかの会社で働いてきて java のコードも読み書きしてきた。これまでの経験からその職場での java のコードは品質が高かったし、私もその影響で java の設計やアーキテクチャにも関心をもつようになった。私は未熟なので人並み程度のプログラミングしかできないが、そのスキルを底上げしてもらったのはその職場での3年間の java 開発といえる。私にとっての普通が当時の開発体験やチームの同僚になったことでそれ以降に出会った開発者の大半はスキルが低いようにみえてしまう。そして、その後に私がどんなプロダクトを開発しても決して当時の先輩方に敵うことはないと慢心することもない。だからプロダクトの開発を終えて、組織の方向性にあわなければすぐに辞めることもできた。</p><p>いま私がメンバーに教えていることも、メンバーからみたら少し厳しくみえるかもしれない。私にとって先人のような偉大な開発者に自分もなれるんやろか？とか思いながらマネジメントをしていたりする。今週はとくに18時にホテル戻って2-3時間寝て22時頃から2-3時間コードを書いたりしていた。当時の上長もよくそうやって開発していた。当時の私はよく働いたが、そんな私からみてもその上長もよく働いていた。そして上長の生産性は私よりも数倍高かった。お互いに課題管理システム上にいることはわかっていたし、夜中の1時頃にチケット上でやり取りすることもあった。私もいま当時の上長と同じようなことをやっているなと感慨に浸りながら夜中にコードを書いていた。うちのチームのメンバーは誰も夜中に開発していないことだけが当時とは違うことにも気付いた。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0309/>リリース延期の危機</a></h1><div class=post-meta><span class=post-date>2023-03-09 (Thu.)</span></div><span class=post-tags>#<a href=/diary/tags/project-management/>project management</a>&nbsp;
#<a href=/diary/tags/issue-management/>issue management</a>&nbsp;
#<a href=/diary/tags/communication/>communication</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#プロジェクトの進捗報告>プロジェクトの進捗報告</a></li></ul></nav></div><div class=post-content><p>1時に寝て7時に起きた。いつも通り夕方にホテルに戻って2時間ほど寝て起きたらテレビで WBS をやっていてそのままみてた。そしたら晩ご飯食べるタイミングも作業するタイミングも逃して日記を書いたり雑多なことをしていた。</p><h2 id=プロジェクトの進捗報告>プロジェクトの進捗報告</h2><p>出張したときの月例報告の4回目。<a href=/diary/posts/2023/0209/>前回の進捗報告はこちら</a> 。1月にリリース前倒しを提案して颯爽と1ヶ月前倒しをしたのにその翌月に現時点ではまだリリース可能かどうかを判断できないといったことを報告した。まったく情けない。サーバーサイドとフロントエンドの開発はすでに完了しているのに。しかし、もともとこのプロジェクトの開発対象に入っていなかったもので、ほぼ完成していると聞いていたモジュール群の半分が機能不足や低品質で作り直すことになった。残りの半分もそのままでは動かない。</p><p>経験の浅いメンバーに1ヶ月以上の時間を与えて作り直してもらうようにお願いしていたが、うまく進捗せず時間だけが過ぎていって、結果的に2月の半ばから私が引き取って大半の機能を開発している。結果的にそのメンバーにお願いしていた開発の8割を私が2週間でほとんど実装した。2月の中旬から私がずっと休祝日に開発のお仕事をしていたのはこの開発遅れを補填するためだった。チームが fix した2月の issue 数が57でそのうちの30を、enhance ラベルが付いたものは28でそのうちの13を私が担当した。今月の半分の開発を私が代替わりして帳尻を無理やりあわせた。もはや遊撃のレベルではなく、私が本気出して全部作っておきましたみたいなことをした。</p><p>本当はメンバーに開発経験をつけてもらうために私がいるので私が主担当で開発するのはよくない。とはいえ、このままいくと2ヶ月ほど開発遅延する、しかもこのプロジェクトの中核でもない機能のために、それも悔しいし、うちの会社の信頼にも関わるのでズルしてしまいましたと経営陣へ正直に報告した。自分がやるよりも他人に教える方がずっと難しい。先方からは咎めるものではなかったし、私が開発して帳尻をあわせるのを止めるものでもないという承認は得た。</p><p>難しい開発課題を経験の浅いメンバーに担当させてしまった私のマネジメントの誤りであることは、チームのふりかえりでも、経営者への報告でも伝えている。なにが起ころうとプロジェクトの責任はマネージャーの私にあることは理解している。その遅れはマネージャーが責任をもって対応するのだとメンバーが学ぶ機会にもなったんじゃないかという意見も出た。私も過去にそういう上長をみて思うところはあったのでそれはそうかもしれない。なぜ1ヶ月以上も時間を与えているのに芋づる式にスケジュールが遅延するのか。その要因もメンバーの行動や進捗をみていて理解できた。第一に経験が浅いために開発の見通しや見積もりを立てられない。例えば課題が3つあるとして、1つしかみえていないから「できそうです」と言っていても、1つ終えた後にまた1つありましたと報告があり、その1つを終えてもまだもう1つありましたと報告が来る。一定の経験があれば作業を開始する前に3つあることを整理して、その上で納期にあわせて3つを対処する。納期いっぱい使って1つだけやろうとするところの意識の差は大きい。第二に期日までに実装できる一定のスキルをもっていないとコードレビューが1週間とか続いてしまう。そういった開発者にクリティカルパスとなる issue を担当させてはいけないように思えた。</p><p>ある issue がクリティカルパスになってしまった時点で、私かスキルのあるメンバーのどちらかへ引き継ぐように2月中旬に調整していればいまの状況は変わったのではないだろうか。その判断が2週間遅れたことに今回は気付けた。結果論ではあるが、厳しい判断をもう少し早めに下さないといけなかった。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0308/>windows のサービス起動を go から制御する</a></h1><div class=post-meta><span class=post-date>2023-03-08 (Wed.)</span></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/windows/>windows</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#windows-のサービス起動>windows のサービス起動</a></li></ul></nav></div><div class=post-content><p>2時に寝て3回ほど起きて7時に起きた。淡々と自分の機能開発をしていた。ある処理が失敗したときにローカルのファイルシステムに暗号化して書き込み、定期的にそのディレクトリを監視してファイルがあれば読み込んで復号化してリトライをするといった仕組みを実装した。とくに難しくなくすぐにできた。</p><p>晩ご飯に <a href=https://tabelog.com/tokyo/A1316/A131603/13125103/>大衆酒場 PING (ピン)</a> というお店に行ってみた。1人でも入りやすく値段も安く食べ応えもあっても私のイメージする居酒屋さんの印象にぴったりでよかった。また出張したら行こうと思う。そろそろ出張でバテてきたので今日は夜にお仕事せずに晩ご飯食べてからもテレビをみながらだらだらしてた。</p><h2 id=windows-のサービス起動>windows のサービス起動</h2><p>準標準パッケージである <a href=https://pkg.go.dev/golang.org/x/sys/windows/svc/eventlog>golang.org/x/sys</a> パッケージを使ってアプリケーションの起動と停止をサービス管理画面から操作できるようにする。サンプルコードは次の場所にある。</p><ul><li><a href=https://github.com/golang/sys/tree/master/windows/svc/example>https://github.com/golang/sys/tree/master/windows/svc/example</a></li></ul><p>サービスから呼ばれたかどうかを判定をすることでエントリーポイントを切り替えられる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>inService</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>svc</span>.<span style=color:#a6e22e>IsWindowsService</span>()
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>inService</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>runService</span>(<span style=color:#a6e22e>serviceName</span>, <span style=color:#66d9ef>false</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#e6db74>&#34;failed to run service&#34;</span>, <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>any</span>{
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;err&#34;</span>: <span style=color:#a6e22e>err</span>,
</span></span><span style=display:flex><span>        })
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>そして、次のような <code>Execute()</code> メソッドをもつ windows サービスから呼ばれる構造体を定義して、そのメソッド内でサービス管理画面からのステータス変更に対応する状態遷移のコードを実装すればよい。ここではサービス開始してから stop/shutddown で停止するぐらいしか必要ないのでシンプルに実装した。一時停止や再開も必要ならもう少し複雑なコードになる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>myService</span> <span style=color:#66d9ef>struct</span>{}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>myService</span>) <span style=color:#a6e22e>Execute</span>(
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>args</span> []<span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>reqCh</span> <span style=color:#f92672>&lt;-</span><span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>svc</span>.<span style=color:#a6e22e>ChangeRequest</span>, <span style=color:#a6e22e>statusCh</span> <span style=color:#66d9ef>chan</span><span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>svc</span>.<span style=color:#a6e22e>Status</span>,
</span></span><span style=display:flex><span>) (<span style=color:#a6e22e>ssec</span> <span style=color:#66d9ef>bool</span>, <span style=color:#a6e22e>errno</span> <span style=color:#66d9ef>uint32</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>cancel</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>WithCancel</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>())
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ch</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>startMyService</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>getConfig</span>())
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>statusCh</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>svc</span>.<span style=color:#a6e22e>Status</span>{<span style=color:#a6e22e>State</span>: <span style=color:#a6e22e>svc</span>.<span style=color:#a6e22e>Running</span>, <span style=color:#a6e22e>Accepts</span>: <span style=color:#a6e22e>svc</span>.<span style=color:#a6e22e>AcceptStop</span> | <span style=color:#a6e22e>svc</span>.<span style=color:#a6e22e>AcceptShutdown</span>}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>stop</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>c</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>reqCh</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Cmd</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>svc</span>.<span style=color:#a6e22e>Stop</span>, <span style=color:#a6e22e>svc</span>.<span style=color:#a6e22e>Shutdown</span>:
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>stop</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>cancel</span>()
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>stop</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>statusCh</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>svc</span>.<span style=color:#a6e22e>Status</span>{<span style=color:#a6e22e>State</span>: <span style=color:#a6e22e>svc</span>.<span style=color:#a6e22e>StopPending</span>}
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>ch</span> <span style=color:#75715e>// wait until MyService would be completed
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div></div><div class=pagination><div class=pagination__buttons><a href=/diary/page/33/ class="button previous"><span class=button__icon>←</span>
<span class=button__text>最近の日記</span>
</a><a href=/diary/page/35/ class="button next"><span class=button__text>過去の日記</span>
<span class=button__icon>→</span></a></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2024 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>