<!doctype html><html lang=en><head><meta name=generator content="Hugo 0.123.1"><title></title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content="t2y"><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content><meta property="og:description" content><meta property="og:url" content="/diary/"><meta property="og:site_name" content><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/index.xml rel=alternate type=application/rss+xml title></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><div class=posts><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0628/>徳島のコワーキングスペース訪問</a></h1><div class=post-meta><span class=post-date>2023-06-28 (Wed.)</span></div><span class=post-tags>#<a href=/diary/tags/day-off/>day off</a>&nbsp;
#<a href=/diary/tags/coworking/>coworking</a>&nbsp;
#<a href=/diary/tags/workcation/>workcation</a>&nbsp;
#<a href=/diary/tags/management/>management</a>&nbsp;
#<a href=/diary/tags/issue-management/>issue management</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#adliv-さん訪問>ADLIV さん訪問</a></li></ul></nav></div><div class=post-content><p>23時に寝て4時に起きて6時に起きて8時に起きた。今日はお休みをとって徳島のコワーキングスペースの見学へ行くことにした。当初は明日の午前中だけ見学しようかと考えていたけど、宿泊もした方が気付きが多いんじゃないかと思って一昨日に予定変更した。結果的にこれはとてもうまくいった。</p><h2 id=adliv-さん訪問>ADLIV さん訪問</h2><p>以前 <a href=/diary/posts/2022/1116/#コワーキングのオンラインイベント>カフーツさんのオンラインイベント</a> で <a href=https://livinganywherecommons.com/base/mima/>徳島県美馬市脇町</a> のコワーキングの取り組みを伺っていた。機会をみつけて行きたいと考えていたのを今日行くことにした。10時過ぎに実家を出て、途中 <a href=https://www.michinoeki-itano.jp/>道の駅いたの</a> で休憩して、11時45分には <a href=https://www.adliv-tokushima.com/>ADLIV</a> さんに着いた。</p><p>近くのラーメン屋さんでお昼ご飯を食べて12時半過ぎに ADLIV さんに着き、少し待たせてもらう。宿泊は4,500円で13時からチェックインできる。翌日のチェックアウトまでのコワーキングスペースの利用料も込みだという。13時まで待ってスタッフさんが来られて施設を案内してもらうことになった。</p><figure><img src=/diary/img/2023/0628_adliv1.jpg></figure><p>2Fはシェアオフィスになっていて通常コワーキングスペースの利用者には案内しないということなんだけど、他に利用者が少なくて余裕があったのか、私が伊藤さんの紹介だとメモに書いたおかげなのか、2Fも案内してもらえた。ラッキー。外国人が来たときも2Fをみたいという要望も多いと話されていたのでちょくちょく案内しているように聞こえた。</p><p>コワーキングスペースに宿泊できるが、ホテルではないのでスタッフは19時にはいなくなって翌8時ぐらいまでいない。それは全然構わない。チェックアウトもとくにスタッフに声をかけなくても勝手に出ていけばよいらしい。お世話になったので挨拶はして出ようとは思う。</p><figure><img src=/diary/img/2023/0628_adliv2.jpg></figure><p>今日の宿泊者は私だけなので自由に使ってよいとのこと。カプセルのカーテンを締めると暑いから他に宿泊者がいないから開けっ放しの方がよいとお奨めされた。他に誰かいたらコワーキング的な話を聞いてみようかと思っていたが、週の半ばでそれは叶わなかった。</p><p>チェックインして普通に作業していたら、オーナーのなかがわさんが来られて名刺交換して軽くご挨拶した。小さいスペースの方が涼しいからこちらへどうぞとハンモックがあるスペースで作業した。</p><figure><img src=/diary/img/2023/0628_adliv3.jpg></figure><p>その後、18時過ぎから一緒に晩ご飯行きましょうとなかがわさんに声をかけてもらって、自転車も貸してくれて、うだつの街並みの案内を受けながらお好み焼き屋さんへ行った。あとから地元の農家さん夫婦も合流して4人で雑談していた。</p><figure><img src=/diary/img/2023/0628_adliv4.jpg></figure><p>経営者しか経営者の気持ちがわからないとはよく言ったもので本当にその通りだと思う。うちみたいなお気楽な1人会社であっても、経営者という立場にになって初めて考えることや悩むことが多々ある。そして、経営者は会社の中では孤独な役割になる。経営者は経営という共通の話題をもっていて、他社の経営的な話しに共感しやすく、普段相談する相手もいないことから経営者同士は打ち解けやすい。学校で友だちを作る感覚に似ている。徳島県は淡路島から近いし、なかがわさんとはまたなにかの機会で縁があるといいなと思えた。</p><ul><li>プロジェクトを通してそれぞれの専門家が一緒に働く仕組み作り</li><li>寄せ集めのメンバーを統括してプロジェクトを為すマネージャー大事、超大事</li><li>人と人との信頼はアウトソースできない</li><li>コワーキングスペースをやっていると、向こうからおもしろい人がやって来てくれる</li><li>気付きを得て自律的に働く人とそうじゃない人の見極めは難しい</li><li>社員にやってほしいことをやれと指示しても自律的に働くようにならない</li><li>楽しく働く</li></ul><p>18時半から21時までお好み焼き屋さんでわいわい雑談して ADLIV さんに戻って休むことにした。田舎なので閉店も21時半と早めだ。</p><p>寝る前に眠くなるまで、書架にあった <a href=https://www.shogakukan.co.jp/books/volume/13612>史記</a> を読んでいた。歴史好きなので読み始めると止まらなくなる。</p><figure><img src=/diary/img/2023/0628_adliv5.jpg></figure></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0627/>scim 調査に着手</a></h1><div class=post-meta><span class=post-date>2023-06-27 (Tue.)</span></div><span class=post-tags>#<a href=/diary/tags/remote-work/>remote work</a>&nbsp;
#<a href=/diary/tags/scim/>scim</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;
#<a href=/diary/tags/meta-programming/>meta programming</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#リモートワークのタグを新設>リモートワークのタグを新設</a></li><li><a href=#scim-調査>scim 調査</a></li></ul></nav></div><div class=post-content><p>22時に寝て24時に起きて4時に起きて6時に起きた。実家だとやることないので寝るのも早くなる。早く起きているので始業も7時半ぐらいになる。早起きは三文の徳。</p><h2 id=リモートワークのタグを新設>リモートワークのタグを新設</h2><p>神戸のオフィスに行かなかった日は <a href=/diary/tags/day-off/>day off</a> というタグを付けている。名前の通り、お休みしたということを表す。この定義に従うと、実家に帰ってリモートワークをしたときもお休みになってしまうため、それを区別するように <a href=/diary/tags/remote-work/>remote work</a> というタグを作った。</p><h2 id=scim-調査>scim 調査</h2><p>id 連携の文脈で <a href=https://en.wikipedia.org/wiki/System_for_Cross-domain_Identity_Management>System for Cross-domain Identity Management</a>
(頭文字をとって SCIM、すきーむと呼ばれている) という標準がある。基本的には rest api とスキーマを扱うように仕様が決められていて、それに準拠したサービス間で id 連携を標準化する狙いがある。id 連携と同じ用途を表す用語として id プロビジョニングという用語もあるが、多くのクラウドサービスでは id プロビジョニングのために scim 対応していたりする。</p><p>たまたまサイボウズさんが okta と scim 連携に対応しているプレスリリースをみかけた。</p><ul><li><a href=https://www.okta.com/jp/press-room/press-releases/okta-cybozu-scim/>サイボウズの「cybozu.com」がプロビジョニング自動化実現のため、「Okta Integration Network」とのSCIM連携に対応</a></li></ul><p>その延長で調査していたところ、go の scim ツールを提供していることに気付いた。しかもこれを作っているのが <a href=https://lestrrat.github.io/>Maki</a> さん。これはソースを読んでおこうと思った次第。Maki さんはメルカリに所属していたと思うのでこれは副業でやっているのかな？</p><ul><li><a href=https://github.com/cybozu-go/scim>github.com/cybozu-go/scim</a></li><li><a href=https://github.com/cybozu-go/scim-server>github.com/cybozu-go/scim-server</a></li></ul><p>scim-server は scim ライブラリを実際に使うときの参照実装としてアプリケーションの開発者に開発の雰囲気を伝えるための実装になっている。これ自体をプロダクトのサーバーとして使うわけではない。sqlite を使ってユーザー／グループの crud な操作と検索機能を提供している。</p><p>scim ライブラリのソースコードも軽くざっと読んでみた。<a href=https://github.com/lestrrat-go/sketch>github.com/lestrrat-go/sketch</a> という go でスキーマを記述してコード生成する Maki さん製のツールがある。これを起点に scim のプロトコルやリソースの仕様にしたがって go のコードでスキーマを定義し、リソースに関する go のコードと scim スキーマを自動生成している。sketch というツールに関連して他にも Maki 製のメタプログラミングライブラリを多用していて、scim の標準化されている部分のエンドポイントやリソースのインターフェース部分をすべてコード生成している。</p><p>go generate やコード生成の実際の応用例として非常に参考になる。このライブラリは scim のプロトコル仕様に関する開発者と、そのエンドポイントの実際の処理 (バックエンド) の開発者を明確に分離するという開発体制を期待している。scim に関するところは Maki さんが独りでコード生成を多用してオープンなプロトコル仕様の開発を担当し、そのバックエンドをサイボウズさんの開発者が実装するという分業体制を想定しているようにみえる。</p><p>scim 対応のアプリケーション開発のプロトコル部分を外部に委譲するといった設計になっているが、scim が十分に安定していてプロトコルの仕様が変わらないのであれば理に適っているとも考えられる。バックエンドの開発者はいくらか sketch の学習コストを強いることになる。そのため、アプリケーションはその学習コストを支払ってもコード生成のメリットが上回るだけの規模や特性を要求する。おそらく scim はそれだけの価値があると判断されたのだと推測する。</p><p>私はメタプログラミングが好きな方なのでこういうやり方もあるんだなと設計の参考になった。またコード生成の要件があったときにソースを参考にしようと思う。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0626/>実家での初めてのリモートワーク</a></h1><div class=post-meta><span class=post-date>2023-06-26 (Mon.)</span></div><span class=post-tags>#<a href=/diary/tags/remote-work/>remote work</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/network/>network</a>&nbsp;
#<a href=/diary/tags/founding/>founding</a>&nbsp;
#<a href=/diary/tags/coworking/>coworking</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#パスワードの表現の答え合わせ>パスワードの表現の答え合わせ</a></li><li><a href=#実家の離れスペースで働いてみた>実家の離れスペースで働いてみた</a></li></ul></nav></div><div class=post-content><p>23時に寝て2時に起きて4時に起きて6時に起きた。親が4時頃から作業し始めるからそのぐらいからだらだら起きている。その影響で8時前からお仕事を始めた。</p><h2 id=パスワードの表現の答え合わせ>パスワードの表現の答え合わせ</h2><p>先週末に課題としていた <a href=/diary/posts/2023/0623/#パスワードの表現>パスワードの表現</a> になかなか苦労したようで半日ぐらいかかった。私が答えを言うのではなく、本人が自分で考えて、自分で調べて実装できるまで粘り強く待っていた。概ね、私の模範解答に近いものを実装してきて、コードレビューで少し手直しはあったものの、go でコンストラクタに近いものを実装する方法を学んだと思う。</p><h2 id=実家の離れスペースで働いてみた>実家の離れスペースで働いてみた</h2><p>今朝は軽く雨が降っていて、それ以降もずっと曇っていた。天気がどんよりしていたのもあり、エアコンは除湿に設定してソファで働いてみた。数年前から淡路島に帰ってきてリモートワークをしたことは何度かあったが、すべてマクドナルドへ行って電源を借りて作業していた。実家で丸1日リモートワークで働いたのは今回が初めてだと思う。どんな施設でもインターネットとエアコンさえあれば働けるということを改めて実感した。実家なのでお昼になったらおかんがお昼ご飯だと呼びに来る。食べるものも考えなくてよい。</p><p><a href=/diary/posts/2023/0504/#iijmio-と-iphone-で作るモバイル-wifi-ルーター>iphone で作った wifi ルーター</a> の 2GiB プランで契約している。普通に macbook でリポジトリを操作したり、課題管理を使ったり、ブラウザで調べものしたり、slack でやり取りしたりしていたら約9時間で 987 MiB の通信量となった。いまやネットワークの通信量を意識することはないと思うが、普通にお仕事したらいまの時代1日 1GiB ぐらい使うもんなんやと気付いた。</p><p>iijmio の管理画面で日次の通信量を当日分も含めて確認できる。</p><figure><img src=/diary/img/2023/0626_usage.png></figure><p>1週間とか、実家でリモートワークするなら 2GiB プランだと全然足りない。機をみて 5/10 GiB 程度のプランに変更するとよさそう。これでコワーキングスペースにして複数人が使う想定なら光回線をひかないとネットワークが厳しいということも理解できた。光回線をひくと安くても5,000円/月は固定費がかかってくるので維持費の問題は悩ましいことも分かってきた。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0625/>実家でいろいろな一日</a></h1><div class=post-meta><span class=post-date>2023-06-25 (Sun.)</span></div><span class=post-tags>#<a href=/diary/tags/day-off/>day off</a>&nbsp;
#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/agriculture/>agriculture</a>&nbsp;
#<a href=/diary/tags/founding/>founding</a>&nbsp;
#<a href=/diary/tags/coworking/>coworking</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#魂入れのお経>魂入れのお経</a></li><li><a href=#トラクター>トラクター</a></li><li><a href=#海鮮丼とサワラ>海鮮丼とサワラ</a></li><li><a href=#膳先の品物選び>膳先の品物選び</a></li><li><a href=#実家の離れスペースのオフィス化>実家の離れスペースのオフィス化</a></li></ul></nav></div><div class=post-content><p>0時に寝て何度か起きて4時に起きた。親が4時から起きて台所でごそごそしているからつられて起こされる。</p><h2 id=魂入れのお経>魂入れのお経</h2><p>9時から住職が来られて本位牌の <a href=https://www.e-butsudan.com/guide/302/>魂入れ</a> のお経をあげてくれた。法事のときとは少し違うお経を30分ほどあげてくれた。感謝。喪主になってみて実感したことの1つに、死者のためにできることは限られることに気付く。どんな宗教でもよいと思うが、なにかしら死者の供養のために尽力してくれることがありがたい。そのまま白木位牌は住職が持って帰って処分？してくれるみたい。ついでに12月に1回忌をする予定の調整をお願いした。</p><h2 id=トラクター>トラクター</h2><p>10時前から11時半ぐらいまで軽くトラクターで田んぼを耕した。周りの田んぼを耕しているトラクターをみたらエアコンがついていてうちのよりもやや小型にみえる。小さい田んぼならトラクターも小さい方が小回りがきいて端や隅を耕しやすいのかもしれない。うちのトラクターはおそらく中古でもう10年以上は使っているだろうから真面目に農業するときにトラクターを新調してもいいかもしれない。いまどき鍬で田んぼを耕すなんて事実上できないのでトラクターだけは妥協せずお金を払った方がよいと思う。私は鍬仕事を30分やっただけで腰と握力がなくなって大変なことになる。</p><h2 id=海鮮丼とサワラ>海鮮丼とサワラ</h2><p>お昼は <a href=https://tabelog.com/hyogo/A2806/A280602/28052765/>魚魚やす (ととやす)</a> という漁師がお昼だけあけている食堂のようなところに食べに行った。母は何度か行ったことがあったそうだが、私は初めて。ちょうど満席で15分ほど待った。店員さんが愛想なかったり待っている客の対応もよくなかった。田舎の忙しい食堂はサービス精神とかない。</p><p>一番人気の魚魚やす海鮮丼 (1,850円) を注文してみた。普通にはおいしかったが、値段が高いのでコスパという側面からみると普通かな。これが1000円前後だったらもっと印象は変わった気がもする。いろんな魚の刺身を食べられてよいのだけど、やや刺身の切り身が薄い気がしてコストダウンなのかなぁとか思ったのがさらにマイナスだった。魚そのものの鮮度はまぁまぁでした。</p><figure><img src=/diary/img/2023/0625_fish-don.jpg></figure><p><a href=https://awajishima-namasawara.com/>淡路島はサワラ (鰆)</a> もよく漁れるところでサワラ食べるの久しぶりで懐かしかった。個人的に好みではなかったのであまり意識したことがなかった。生サワラ丼があちこちで食べられるみたい。昔はサワラも当たり前だったので特別な魚に思ってなかったけど、淡路島の特産品としてみるとお客さん向けによいかもしれない。次は生サワラ丼を食べてみたい。</p><h2 id=膳先の品物選び>膳先の品物選び</h2><p>法事を終えた後に参加者に渡す手土産のようなものを膳先と呼んでいる。本来の意味もなにかあった気がするのだけど忘れてしまった。一家に1つなので参加者数よりも少なくなる。法事のときは参加人数の食事と家数の膳先の品物を数えて準備しないといけない。言うても49日以降、減ることはあっても参加者が増えることは基本的にあり得ないので最大49日の人数と家数を考慮しておけばよい。膳先の品物選びに大きなホームセンターのギフト売り場へ行ってきた。予算は5千円程度でよさそうな品物を見繕って次の配分になった。</p><ul><li>揖保乃糸: 2千円</li><li>佃煮セット: 2千円</li><li>お菓子: 1千円</li></ul><h2 id=実家の離れスペースのオフィス化>実家の離れスペースのオフィス化</h2><p><a href=/diary/posts/2023/0528/#相続の手続き>出張所作り</a> の続き。夕方から新設したばかりのエアコンをつけて、セカンドモニターに映して、<a href=/diary/posts/2023/0504/#iijmio-と-iphone-で作るモバイル-wifi-ルーター>iphone で作った wifi ルーター</a> に繋いでしばらく作業してみた。あとは作業をするための作業机がない。どこかで作業机を購入しないといけない。いずれコワーキングスペースにすることを考慮すると最初から大きな机を買ってもいいかもしれない。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0624/>お仕事をしない週末</a></h1><div class=post-meta><span class=post-date>2023-06-24 (Sat.)</span></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/founding/>founding</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#ストレッチ>ストレッチ</a></li><li><a href=#合鍵の精度>合鍵の精度</a></li><li><a href=#社用車の半年点検>社用車の半年点検</a></li><li><a href=#実家へ帰る>実家へ帰る</a></li></ul></nav></div><div class=post-content><p>3時に寝て7時頃に起きて8時半に起きた。1時前に帰ってきて軽く夜食を食べてだらだらしてた。</p><h2 id=ストレッチ>ストレッチ</h2><p>今週はそんなに忙しかったわけではないのに疲弊している。気温が上がって暑くなってきている。家でもエアコンをつけるようになってきた。その暑さで夏バテしているのかもしれない。食べるよりも飲む方が多い。ストレッチを受けてみて、腰はそれほど悪くなかったが、右足全般の張りがつよかったように思える。今日の開脚幅は開始前158cmで、ストレッチ後160cmだった。数値はよかった。右股関節の改善のためにスクワットをやるようにしてほしいとトレーナーさんから指導をうけた。続くかどうか、やってみる。</p><h2 id=合鍵の精度>合鍵の精度</h2><p>2-3日前から合鍵がオフィスの扉のシリンダーに入りにくくなった。入らないわけではないが、すっと入っていたのが引っかかりが出るようになった。直感的にいままで使えていた合鍵が悪いとは思わずシリンダー側の原因かな？と運営会社のサポートに連絡したらスタッフの方が来られて、たまたまオリジナルキーをもっているので交換しますよという。そのスタッフさんがオリジナルキーをシリンダーに入れてみるとスムーズに入る。これは合鍵の問題だなとわかって、私も自分のオリジナルキーを家からもってきて試してみたらスムーズに入る。</p><p>この合鍵は作ってから半年ほど使ってきたわけだけど、なにかしら老朽化して変形したのかな？と作ってもらった合鍵屋さんへ行って話しを聞いてみた。</p><ul><li>数千本に1本あるかないかの事例</li><li>(目でみて？) 合鍵とオリジナルキーを比較した限りでは変形や歪みはない</li><li>合鍵屋さんにあるまったく同じシリンダーではスムーズに入る</li><li>オフィスの扉のシリンダーが変化してオリジナルキーの精度を要求するという問題ではないか？</li><li>オリジナルキーと合鍵は 0.03mm 以内の誤差があるのでまったく同じではない</li></ul><p>これまで使っていた合鍵が入りにくくなるといったことは初めてだったので私も驚いた。一方でシリンダーにあわないのであれば、この合鍵を使い続けるのはよくないということで、新しく作り直してもらった。新しい合鍵ではオリジナルキーほどスムーズではないが、すっと入るようにはなった。鍵をシリンダーへ差し込むときの微妙な違いがあるんだなと気付きを得た。</p><h2 id=社用車の半年点検>社用車の半年点検</h2><p>13時からの点検予定をすっかり忘れていて13時ぴったりにスマホの通知で気付いた。こういうのはカレンダーにタスクじゃなくてイベントで住所も登録した方が現在位置から移動時間も考慮して事前に通知がくるのでよさそうだと気付きを得た。</p><p>ディーラーの営業さんに慌てて一報入れて13時半に着く。点検作業は約1時間。そのままディーラーでのほほんと待っていた。エンジンオイル交換してくれて、とくに異常はないとのこと。これから実家へ帰って、来週は四国を横断してくるので安心を手に入れた。次も半年後に1年点検がある。整備士さんにガソリンは半年ほどで劣化しますか？と聞いてみたら半年ぐらいなら大丈夫ではないかと話されていた。車のガソリンタンク内であれば密閉されているのでまだ劣化しにくいという。しかし、ポリタンクや一斗缶などで保管している場合は湿気や空気と触れやすくて半年ぐらいで劣化してしまうかもしれないと話されていた。</p><h2 id=実家へ帰る>実家へ帰る</h2><p>明日、住職が来てくれて白木位牌から本位牌に <a href=https://www.e-butsudan.com/guide/302/>魂入れ</a> のお経をあげてもらう。通常は49日までに行うのが慣習らしいが、うちは段取りが遅れたのか宗派の違いなのかまだ行っていなかった。調べていると49日後から1周忌までに行う場合もあるという。ちょうど来週は四国へ旅行へ行くのもあって、週末から実家に帰って実家の出張所でちょっと働いてみてその後に四国へ行こうと思う。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0623/>トイレにうんこ</a></h1><div class=post-meta><span class=post-date>2023-06-23 (Fri.)</span></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/communication/>communication</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#トイレにうんこを詰まらせた>トイレにうんこを詰まらせた</a></li><li><a href=#隔週の雑談>隔週の雑談</a></li><li><a href=#パスワードの表現>パスワードの表現</a></li></ul></nav></div><div class=post-content><p>0時に寝て4時に起きてドラクエタクトやりながらだらだらしているうちに少し寝て7時に起きた。</p><h2 id=トイレにうんこを詰まらせた>トイレにうんこを詰まらせた</h2><p>いや。正確にはトイレが詰まってうんこを浮かべた。朝トイレへ行ったら洋式トイレにトイレットペーパーが漂っていた。前に使った人が流していないのかな？と考えて気持ち悪いのですぐ流した。これまでも過去にそういうことがたまにあった。あとから考えると、誰かのいたずらでなにかしらトイレに詰まるものがトイレットペーパーの下に隠されていた可能性もある。この時点で次に水が流れるかどうかのチェックをするべきと洞察できていなかった。</p><p>それから、うんこして流したらトイレが詰まったようで流れない。微妙に便器から水が溢れてきた。ぎりぎり溢れ返ることにはならなかったのでトイレの床にうんこが散乱する最悪の状況にはならなかった。しかし、トイレにうんこがぷかぷか浮かんでいる状態になった。べつに私が悪いわけではないと思うのだけど、トイレにうんこが浮かんでいる状態にしてしまったことにとても罪悪感を感じた。</p><p>幸い朝8時からシェアオフィスにいるのは私ぐらいで、多くの利用者は10時前後にならないと出社してこない。いまトイレに誰かが入ってきて犯人扱いされることはなさそう。なんか行き当たりで人を殺めてしまった殺人犯みたいな心境になった。運営会社のサポートは9時から。1階へ降りていって掃除のおばちゃんに尋ねてみたけど、うんこが浮かんだトイレの階は自分たちの管轄じゃないと断られてしまった。(´・ω・｀) 仕方なく、時間を待って9時ぴったりにサポートに電話して聞いてみる。サポートにも断られたらどうしよう？不安と緊張が走る。サポートのお姉さんは (当然ではあると思うけれども) 全然平気ですよーと快く応じてくれて安心した。まぁ、電話しているお姉さんが対応するわけじゃないしね。</p><p>電話で一報を終えて、その後、トイレ業者さんが来るまで自分のうんこを浮かべておいていいのかどうか、すごく悩んだ。かといってうんこを取り出す勇気もなく結果的にそのまま放置した。人間がしょぼい。40年以上も生きてきて自分のうんこの処理もできないのかと思うと本当に情けなくなった。「入るな、危険」ぐらいの張り紙しといてもよかった。本当の犯人だったらここでとんでもないトリックを思いついて実行するところだけど、一報したことでそこまでの切羽詰まった状況でもなくなっていた。もし警察がやってきてもサポートのお姉さんが犯人じゃないと証言してくれるだろう。</p><p>9時から打ち合わせがあって、1時間半後、恐る恐るトイレを見に行ったらすでに詰まりは解消していてうんこもなくなっていた。平和な日常が戻ってきてよかった。</p><p>平安時代とか、都はうんこまみれだったという記事を昔読んだのを思い出した。</p><ul><li><a href=https://locust0138.hatenablog.com/entry/2019/10/18/233617>ドキッ！　死体だらけの平安京！　ポロリもあるよ！　―命の重さの日本史―</a></li></ul><h2 id=隔週の雑談>隔週の雑談</h2><p>顧問のはらさんと隔週の打ち合わせ。今日の議題はこれら。</p><ul><li><a href=/diary/posts/2023/0619/#サイトデザインのサンプルページ>サイトデザインのサンプルページレビュー</a></li><li><a href=/diary/posts/2023/0617/#課題管理の雑談会へ向けての準備>課題管理の雑談会の資料のレビュー</a></li></ul><p>最初の30分でサイトデザインをみながら、はらさんのレビューの視点や背景を教えてもらっていくつか気付きを得た。後半は来月の雑談会へ向けて、課題管理の資料のレビューを始めて、いつもは1時間で打ち合わせを終えるのだけれど、つい課題管理の話しでテンションあがって話し過ぎてしまって30分オーバーした。打ち合わせのような時間を決めている会議で議論に熱くなるのはよくない。失敗したなーと反省した。</p><h2 id=パスワードの表現>パスワードの表現</h2><p>go でパスワードを扱うときに平文をハッシュ化して保持するためのユーザー定義の構造体を作りたい。構造体にハッシュ化した値をもつとしても、プログラマーが誤って任意の値を設定できないように制御したい。ここで go はオブジェクト指向言語ではないのでコンストラクタという概念がない。私が知っているもっともシンプルな方法は interface と private な構造体を組み合わせてコンストラクタに近いものを実装する。コードレビューしていてメンバーにパスワードがハッシュ化されていることを保証する仕組みをお題として指摘してみた。</p><p>今日のところは解決できなくて月曜日に持ち越しになった。私の想定する模範解答は次のようなものだけど、ちゃんと自分で考えて実装できるかなぁ。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Password</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Authenticate</span>(<span style=color:#a6e22e>s</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Get</span>() []<span style=color:#66d9ef>byte</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>String</span>() <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>passwd</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>hashed</span> []<span style=color:#66d9ef>byte</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>passwd</span>) <span style=color:#a6e22e>Authenticate</span>(<span style=color:#a6e22e>s</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bcrypt</span>.<span style=color:#a6e22e>CompareHashAndPassword</span>(<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>hashed</span>, []byte(<span style=color:#a6e22e>s</span>))
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>passwd</span>) <span style=color:#a6e22e>Get</span>() []<span style=color:#66d9ef>byte</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>hashed</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>passwd</span>) <span style=color:#a6e22e>String</span>() <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> string(<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>hashed</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewPassword</span>(<span style=color:#a6e22e>s</span> <span style=color:#66d9ef>string</span>) (<span style=color:#a6e22e>Password</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>h</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bcrypt</span>.<span style=color:#a6e22e>GenerateFromPassword</span>([]byte(<span style=color:#a6e22e>s</span>), <span style=color:#a6e22e>bcrypt</span>.<span style=color:#a6e22e>DefaultCost</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>passwd</span>{<span style=color:#a6e22e>hashed</span>: <span style=color:#a6e22e>h</span>}, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0622/>雨降り後、曇りで散髪</a></h1><div class=post-meta><span class=post-date>2023-06-22 (Thu.)</span></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#散髪>散髪</a></li></ul></nav></div><div class=post-content><p>0時に寝て5時に起きて7時に起きた。朝から雨降りでテンションが低くなった。いろいろマネージャーのお仕事をやってはいるのだけど、これと言って特筆するものがあったわけでもなかった。いろいろ細かい作業して、コードレビューや課題管理して、気付いたら時間経ってた的な1日だった。</p><h2 id=散髪>散髪</h2><p>週末から実家へ帰って来週は実家と四国で作業するのでその前に散髪しておこうと慌てて行ってきた。たまたま予約を取れてよかったが、いつもカットしてもらっている人とは違う人がになってしまった。過去にみたことがない若い人で初めてカットしてもらう。おそらく最近入った新人さんではないかと推測する。隣でどんな感じにカットしたらいいか、いつもやってくれているスタッフがアドバイスしてくれたせいか、大丈夫かな？と思ったものの、いつも通りにカットできて問題はなかった。</p><p>若い人だったから話しするのがあまり上手くなかった。ゴールデンウィーク何してました？とか聞かれた。いま6月下旬だよ。いまさら聞かれても詳細を覚えてないし、私は基本的には法人決算していたんだけど、あまりおもしろい話しもできたのでお仕事忙しくていろいろやってました的に返した。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0621/>厄介なインフラ問題をやっつけた</a></h1><div class=post-meta><span class=post-date>2023-06-21 (Wed.)</span></div><span class=post-tags>#<a href=/diary/tags/infrastructure/>infrastructure</a>&nbsp;
#<a href=/diary/tags/operation/>operation</a>&nbsp;
#<a href=/diary/tags/podman/>podman</a>&nbsp;
#<a href=/diary/tags/event/>event</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#厄介なインフラの問題-解決編>厄介なインフラの問題 解決編</a></li><li><a href=#コワーキングのオンラインイベント>コワーキングのオンラインイベント</a></li></ul></nav></div><div class=post-content><p>2時に寝て6時に起きて7時に起きた。夜に作業していたら遅くなった。</p><h2 id=厄介なインフラの問題-解決編>厄介なインフラの問題 解決編</h2><p><a href=/diary/posts/2023/0619/#運用のトラブルシューティング>運用のトラブルシューティング</a> の続き。アプリケーションアカウントを作って compose 環境を構築したら nginx のコンテナが起動して即時終了する状態になったという。これまで起きていた現象とまた違う問題が発生してさらに混迷をもたらすかに思えたが、私の中では nginx のコンテナでなにかがおかしいと問題の発生箇所を局所化できたのでそこからの調査はそんなに時間を必要としなかった。</p><p>結論からいうと podman の <a href=https://github.com/containers/aardvark-dns>aardvark-dns</a> の不具合だった。なんらかのトリガーでコンテナネットワーク内の名前解決が不整合な状態に陥る。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>vagrant@bookworm:$ podman-compose exec proxy /bin/bash
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>root@3742c45c7c60:/# dig app
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>; &lt;&lt;&gt;&gt; DiG 9.16.37-Debian &lt;&lt;&gt;&gt; app
</span></span><span style=display:flex><span>;; global options: +cmd
</span></span><span style=display:flex><span>;; Got answer:
</span></span><span style=display:flex><span>;; -&gt;&gt;HEADER<span style=color:#e6db74>&lt;&lt;- opco</span>de: QUERY, status: NOERROR, id: <span style=color:#ae81ff>56696</span>
</span></span><span style=display:flex><span>;; flags: qr rd ra ad; QUERY: 1, ANSWER: 8, AUTHORITY: 0, ADDITIONAL: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; OPT PSEUDOSECTION:
</span></span><span style=display:flex><span>; EDNS: version: 0, flags:; udp: <span style=color:#ae81ff>4096</span>
</span></span><span style=display:flex><span>; COOKIE: 37ff0fd63315d70e <span style=color:#f92672>(</span>echoed<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>;; QUESTION SECTION:
</span></span><span style=display:flex><span>;app.				IN	A
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; ANSWER SECTION:
</span></span><span style=display:flex><span>app.			86400	IN	A	10.89.0.36
</span></span><span style=display:flex><span>app.			86400	IN	A	10.89.0.36
</span></span><span style=display:flex><span>app.			86400	IN	A	10.89.0.136
</span></span><span style=display:flex><span>app.			86400	IN	A	10.89.0.136
</span></span><span style=display:flex><span>app.			86400	IN	A	10.89.0.146
</span></span><span style=display:flex><span>app.			86400	IN	A	10.89.0.146
</span></span><span style=display:flex><span>app.			86400	IN	A	10.89.0.156
</span></span><span style=display:flex><span>app.			86400	IN	A	10.89.0.156
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; Query time: <span style=color:#ae81ff>4</span> msec
</span></span><span style=display:flex><span>;; SERVER: 10.89.0.1#53<span style=color:#f92672>(</span>10.89.0.1<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>;; WHEN: Thu Jun <span style=color:#ae81ff>22</span> 02:45:26 UTC <span style=color:#ae81ff>2023</span>
</span></span><span style=display:flex><span>;; MSG SIZE  rcvd: <span style=color:#ae81ff>172</span>
</span></span></code></pre></div><p>podman 4.0 から aardvark-dns がコンテナネットワーク内での dns を提供する。nginx が app を名前解決したときに起動しているコンテナの ip アドレスではなく、削除された過去のコンテナの ip アドレスが返される状況が発生する。app という名前に対して複数の ip アドレスが返る。</p><p>このとき nginx は複数の ip アドレスのうちの1つに接続しようとするが、正しい ip アドレスでない場合、リクエストがタイムアウトする。タイムアウトした後に fallback で他の ip アドレスに接続しにいく。このときに正しい ip アドレスがみつかればクライアントにレスポンスが返る。この fallback のリトライの回数分だけリクエストのレイテンシの時間がかかっていた。</p><pre tabindex=0><code>vagrant@bookworm:$ podman logs -f proxy
...
2023/06/22 02:46:26 [error] 15#15: *41 connect() failed (113: No route to host) while connecting to upstream, client: 10.89.0.38, server: ucidmsv1-app, request: &#34;GET / HTTP/1.1&#34;, upstream: &#34;http://10.89.0.136:3000/&#34;, host: &#34;localhost:4430&#34;
2023/06/22 02:46:29 [error] 15#15: *41 connect() failed (113: No route to host) while connecting to upstream, client: 10.89.0.38, server: ucidmsv1-app, request: &#34;GET / HTTP/1.1&#34;, upstream: &#34;http://10.89.0.156:3000/&#34;, host: &#34;localhost:4430&#34;
2023/06/22 02:46:32 [error] 15#15: *41 connect() failed (113: No route to host) while connecting to upstream, client: 10.89.0.38, server: ucidmsv1-app, request: &#34;GET / HTTP/1.1&#34;, upstream: &#34;http://10.89.0.136:3000/&#34;, host: &#34;localhost:4430&#34;
10.89.0.38 - - [22/Jun/2023:02:46:32 +0000] &#34;GET / HTTP/1.1&#34; 200 2864 &#34;-&#34; &#34;curl/7.88.1&#34;
</code></pre><p>ワークアラウンドとして、次のファイルに複数の app の ip アドレスが登録されていれば不整合な状態なのでネットワークを削除して、このファイルも手動で削除してしまえばよい。</p><pre tabindex=0><code>$ cat /run/user/$(id -u)/containers/networks/aardvark-dns/mynetwork
</code></pre><p>ファイルを監視していると、どうやら mynetwork ファイルから名前と ip アドレスの情報が削除されるのは該当のコンテナが削除されるタイミングになる。なんらかのエラーにより、コンテナ削除時にマッピングの削除が実行されないと、古いコンテナのマッピング設定が残ったままとなり、compose サービスを起動したときに複数の ip アドレスの名前解決できる状態になってしまう。ちょっと調べても aardvark-dns に関する issue はたくさん登録されている。</p><ul><li><a href=https://github.com/containers/podman/issues/18783>https://github.com/containers/podman/issues/18783</a></li><li><a href=https://github.com/containers/podman/issues/18530>https://github.com/containers/podman/issues/18530</a></li><li><a href=https://github.com/containers/podman/issues/17370>https://github.com/containers/podman/issues/17370</a></li></ul><h2 id=コワーキングのオンラインイベント>コワーキングのオンラインイベント</h2><p>月例のカフーツさんのオンラインイベントに参加した。<a href=/diary/posts/2023/0517/#コワーキングのオンラインイベント>先月の所感はここ</a> 。今日はもともと予定していた話しをする参加者が急遽参加できなくなってしまったので他の参加者での雑談会になった。</p><p>いとうさん曰く、これまで外国人のデジタルノマドは自分で業務時間を選べるフリーランスの、さらにお金に余裕をもった人たちが多いと考えられていた。しかし、実際にコワーキングスペースに来られている外国人にキャリアを伺うと、大企業の普通の社員であることがわかってきた。グローバルな会社だと、働く場所に制限のない会社もあって、ただ日本へ行ってみたかった的な理由で日本へ来られて数ヶ月滞在して普通に会社のお仕事をするといったデジタルノマドもいるという。過去に私が働いていた職場の同僚も、コロナのときに会社がフルリモートワークの体制を設けて、airbnb で全国を旅しながら1年ほど働いていた。日本でもそういう社員はいるのだから外国人はなおさらという感じ。</p><p>そういった外国人のデジタルノマドが要求することが3つある。</p><ul><li>24時間利用できること (勤め先の会社と時差があるから)</li><li>セカンドモニターがあること</li><li>・・・ (あともう1つあったが、忘れてしまった)</li></ul><p>コワーキングスペースに外国人のデジタルノマドを呼び込むにはどうすればよいか。実際にコワーキングスペースへ来られた外国人に理由を伺うと英語のホームページをみて来ましたということらしい。至極、当たり前の話し。英語のホームページをちゃんと作ろうねみたいな話題で話していた。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0620/>go の channel 制御の学び</a></h1><div class=post-meta><span class=post-date>2023-06-20 (Tue.)</span></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;
#<a href=/diary/tags/refactoring/>refactoring</a>&nbsp;
#<a href=/diary/tags/rabbitmq/>rabbitmq</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#go-の-channel-とクローズ制御>go の channel とクローズ制御</a></li><li><a href=#マージまで約1ヶ月>マージまで約1ヶ月</a></li></ul></nav></div><div class=post-content><p>0時に寝て2時に起きて5時に起きて6時に起きた。久しぶりに夢をみたような気がする。</p><h2 id=go-の-channel-とクローズ制御>go の channel とクローズ制御</h2><p><a href=https://github.com/rabbitmq/amqp091-go>rabbitmq/amqp091-go</a> を使った pubsub の consumer の実装で次のような for ループでメッセージを取得していた。この場合 <code>deliveries</code> の channel が閉じられると内側の for ループが終了して、外側の for ループの接続処理へ遷移する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// コネクションの接続処理
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>d</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>deliveries</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// メッセージ処理
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>この処理を context を使ってキャンセルできるよう、次に書き換えた。channel の <a href=https://go.dev/ref/spec#Receive_operator>Receive operator</a> のドキュメントによると、channel は2値を返すことができて、戻り値の2番目の <code>ok</code> の値を調べることでその channel がクローズされているかどうかを判定できる。この仕組みを知っていれば select で ok を調べてエラー処理を実装できる。そうしないと <code>deliveries</code> の channel が閉じられれたときに select では常にゼロ値のメッセージが返るようになって意図したメッセージ処理とならない。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// コネクションの接続処理
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Done</span>():
</span></span><span style=display:flex><span>            <span style=color:#75715e>// context がキャンセルされたら終了処理
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>ch</span>.<span style=color:#a6e22e>Cancel</span>(<span style=color:#a6e22e>cid</span>, <span style=color:#66d9ef>false</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to cancel channel: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>d</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>deliveries</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// メッセージ処理
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// エラー処理
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// コネクションが閉じていればループを抜けて再接続
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>IsClosed</span>() <span style=color:#f92672>||</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>ch</span>.<span style=color:#a6e22e>IsClosed</span>() {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Info</span>(<span style=color:#e6db74>&#34;the session was closed, try to reconnect&#34;</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>同じ channel からメッセージを取り出すループ処理でも用途によって使い分けがあるなぁと今更ながら学んだ。というか、自分でバグを埋め込んで自分で直した (´・ω・｀)</p><h2 id=マージまで約1ヶ月>マージまで約1ヶ月</h2><p>先日送った <a href=/diary/posts/2023/0515/#amqp091-go-の-context-制御>amqp091-go の pr</a> が最終的にはほぼそのままマージされた。約1ヶ月ぐらいの議論やレビューがあって取り込まれた。新しいリリースバージョン (次は 1.9.0?) が出たらうちのアプリケーションでもこの新しいメソッドを使うようにして実績を積ませる。この pr は「あったら便利」程度の機能なのでそれほど重要ではない。</p><ul><li><a href=https://github.com/rabbitmq/amqp091-go/pull/192>Add Channel.ConsumeWithContext to be able to cancel delivering #192</a></li></ul><p>この成功体験をもって次は本命の <a href=/diary/posts/2023/0605/#レビュー対応>go-ldap の pr</a> のマージに向けて勢いをつける。こっちの pr は業務に直結しているので本気でやり取りしている。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0619/>運用トラブルの調査</a></h1><div class=post-meta><span class=post-date>2023-06-19 (Mon.)</span></div><span class=post-tags>#<a href=/diary/tags/infrastructure/>infrastructure</a>&nbsp;
#<a href=/diary/tags/operation/>operation</a>&nbsp;
#<a href=/diary/tags/web-design/>web design</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#運用のトラブルシューティング>運用のトラブルシューティング</a></li><li><a href=#サイトデザインのサンプルページ>サイトデザインのサンプルページ</a></li></ul></nav></div><div class=post-content><p>0時に寝て5時に起きて7時に起きた。もう暑くて家でもエアコンを解禁した。エアコンがあると寝心地が違う、快適。</p><h2 id=運用のトラブルシューティング>運用のトラブルシューティング</h2><p><a href=/diary/posts/2023/0613/#厄介なインフラの問題-x-2>厄介なインフラの問題</a> のクリティカルな方から着手し始めた。<a href=https://github.com/containers/podman-compose>podman-compose</a> を使って rootless な環境構築をやってみたところ、nginx を tls 終端としてリバースプロキシとするアプリケーションサーバーとの通信が数回に1回ぐらいの頻度で遅くなる。通常は 100msec 程度でレスポンスが返るのが数秒から数十秒かかる。</p><p>もともと podman-compose はサポート対象外なのでそんながんばる必要はない。しかし、これも調査の過程でコンテナの技術を学ぶ1つだと考え再現環境を構築しようとした。vagrant の debian 12 と podman-compose をインストールして同様に環境構築してみたが、仮想環境では再現しない。どうやら環境要因のようだ。そこで問題が発生しているマシンで私のアカウントで環境構築してみたが、やはり再現しない。なんと個人アカウントの違いによって起きる現象のようだ。また質が悪いのは私のアカウントでは再現しないが、メンバー2人のアカウントでは再現している。一般ユーザーから他人のユーザーのプロセスやコンテナの情報にアクセスできるわけがないので調査ができない。個人アカウントで compose 環境を構築するのは諦めてアプリケーションアカウントを作ってやりましょうという話しにした。アプリケーションアカウントで再現すれば調査するし、再現しなければこんな環境要因のトラブルシューティングの優先度を下げてもいいかなぁとも考えている。どうなるかなぁ。</p><h2 id=サイトデザインのサンプルページ>サイトデザインのサンプルページ</h2><p><a href=/diary/posts/2023/0522/#サイトデザイン打ち合わせ>サイトデザイン打ち合わせ</a> の続き。実際のサンプルが出てきたのでデザインの雰囲気やコードも含めて確認していく。ざっとサンプルページを確認した。デザインはとても気に入っている。あとは私が hugo のテーマとしてテンプレートの組み込めるかどうか次第。今週末には実家帰らないといけないし、毎日やることがいっぱいいっぱい。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0618/>クラウド経由で tapo を制御する方法がわからない</a></h1><div class=post-meta><span class=post-date>2023-06-18 (Sun.)</span></div><span class=post-tags>#<a href=/diary/tags/smartplug/>smartplug</a>&nbsp;
#<a href=/diary/tags/device/>device</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#tp-link-cloud-api-で-tapo-の制御を調べる>tp-link cloud api で tapo の制御を調べる</a></li></ul></nav></div><div class=post-content><p>0時に寝て7時に起きて8時過ぎまでだらだらしてた。オフィスのエアコンの効き具合がよくなくて昼間暑くてやる気にならなかった。</p><h2 id=tp-link-cloud-api-で-tapo-の制御を調べる>tp-link cloud api で tapo の制御を調べる</h2><p>先日 <a href=/diary/posts/2023/0612/>ifttt で tapo p105 の制御</a> を行った。これが動くということはなんらかのクラウドの api 経由で tapo p105 を制御できている。次の記事をみながらやってみようと試してみた。結論から言ってクラウドの api 経由ではできなかった。</p><ul><li><a href=https://zenn.dev/book000/articles/tp-link-cloud-api>TP-Link cloud APIを使ってみる</a></li></ul><p>アクセストークンを取得する。terminalUUID は適当に生成すればよい。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -s -X POST -H <span style=color:#e6db74>&#34;Content-Type: application/json&#34;</span> -d <span style=color:#e6db74>&#39;{&#34;method&#34;: &#34;login&#34;, &#34;params&#34;: {&#34;appType&#34;: &#34;iphone&#34;, &#34;cloudUserName&#34;: &#34;xxx@example.com&#34;, &#34;cloudPassword&#34;: &#34;***&#34;, &#34;terminalUUID&#34;: &#34;bf63e1d0-d5dc-4636-abf1-7eeada585935&#34;}}&#39;</span> https://wap.tplinkcloud.com/ | jq .
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;error_code&#34;</span>: 0,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;result&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;accountId&#34;</span>: <span style=color:#e6db74>&#34;142785160&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;regTime&#34;</span>: <span style=color:#e6db74>&#34;2023-06-11 04:59:43&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;countryCode&#34;</span>: <span style=color:#e6db74>&#34;JP&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;riskDetected&#34;</span>: 0,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;email&#34;</span>: <span style=color:#e6db74>&#34;xxx@example.com&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;token&#34;</span>: <span style=color:#e6db74>&#34;***-***&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>ここで取得したアクセストークンを使ってデバイスの一覧を取得する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -s -X POST -H <span style=color:#e6db74>&#34;Content-Type: application/json&#34;</span> -d <span style=color:#e6db74>&#39;{&#34;method&#34;: &#34;getDeviceList&#34;}&#39;</span> https://wap.tplinkcloud.com/?token<span style=color:#f92672>=</span>***-*** | jq .
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;error_code&#34;</span>: 0,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;result&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;deviceList&#34;</span>: <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;deviceType&#34;</span>: <span style=color:#e6db74>&#34;SMART.TAPOPLUG&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;role&#34;</span>: 0,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;fwVer&#34;</span>: <span style=color:#e6db74>&#34;1.3.6 Build 20230308 Rel. 52591&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;appServerUrl&#34;</span>: <span style=color:#e6db74>&#34;https://aps1-wap.tplinkcloud.com&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;deviceRegion&#34;</span>: <span style=color:#e6db74>&#34;ap-southeast-1&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;deviceId&#34;</span>: <span style=color:#e6db74>&#34;802241DA5175CF114E567DE8D72A3094210CB12D&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;deviceName&#34;</span>: <span style=color:#e6db74>&#34;P105&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;deviceHwVer&#34;</span>: <span style=color:#e6db74>&#34;1.0.0&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;alias&#34;</span>: <span style=color:#e6db74>&#34;U21hcnQgUGx1ZyAoS2F6YW1vcmkgT2ZmaWNlKQ==&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;deviceMac&#34;</span>: <span style=color:#e6db74>&#34;482254AC1D25&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;oemId&#34;</span>: <span style=color:#e6db74>&#34;495AC9D888EB711C42A28BECF62071CF&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;deviceModel&#34;</span>: <span style=color:#e6db74>&#34;P105&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;hwId&#34;</span>: <span style=color:#e6db74>&#34;58070BD9D8ECC915CD3D6F20A2172712&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;fwId&#34;</span>: <span style=color:#e6db74>&#34;1D18AD293A25ABDE41405B20C6F98816&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;isSameRegion&#34;</span>: true,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;status&#34;</span>: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>ここまでは従来のスマートプラグと同様に動く。ここから先の手順は従来の hs105 と tapo p105 では手順が異なるみたい。<code>passthrough</code> というメソッドを呼び出してみてもエラーが返ってくる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -s -X POST -H <span style=color:#e6db74>&#34;Content-Type: application/json&#34;</span> -d <span style=color:#e6db74>&#39;{&#34;method&#34;:&#34;passthrough&#34;, &#34;params&#34;: {&#34;deviceId&#34;: &#34;802241DA5175CF114E567DE8D72A3094210CB12D&#34;, &#34;requestData&#34;: &#34;{\&#34;system\&#34;:{\&#34;get_sysinfo\&#34;:null},\&#34;emeter\&#34;:{\&#34;get_realtime\&#34;:null}}&#34;}}&#39;</span> https://wap.tplinkcloud.com/?token<span style=color:#f92672>=</span>***-*** | jq .
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;error_code&#34;</span>: -20571,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;Device is offline&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>どうやら tapo シリーズはスマートプラグ自体が web api のエンドポイントを提供していて、ローカルからデバイスの web api を呼び出して制御できるらしい。例えば、次の記事でその手順が書いてあって、同様のやり方で実装した野生のライブラリもたくさんみつかる。</p><ul><li><a href=https://guminote.sakura.ne.jp/archives/911>ESP8266 で Tp-Link のスマートプラグ『Tapo P105』を直接操作する</a></li></ul><p>うちのシェアオフィスのネットワークはローカルの ip アドレスへの通信をすべて拒否しているようなのでこのやり方はうちのオフィスでは検証できない。しかし、tp-link 社のスマホアプリと ifttt の webhook 経由で p105 の制御ができているため、おそらくローカルのエンドポイントに接続する以外の別の手段があるのだと推測する。それをインターネット上で数時間探してみたものの、発見できなかった。この前 interop の展示で聞いた話しだと ifttt は非公開 api を使ってインテグレーションを実装しているという話しだったけど、どうやってクラウド経由で通信しているのだろう？と不思議に思った。</p></div></div><div class=pagination><div class=pagination__buttons><a href=/diary/page/40/ class="button previous"><span class=button__icon>←</span>
<span class=button__text>最近の日記</span>
</a><a href=/diary/page/42/ class="button next"><span class=button__text>過去の日記</span>
<span class=button__icon>→</span></a></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2024 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>