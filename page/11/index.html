<!doctype html><html lang=en><head><meta name=generator content="Hugo 0.109.0"><title>forest nook</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content="t2y"><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="forest nook"><meta property="og:description" content><meta property="og:url" content="/diary/"><meta property="og:site_name" content="forest nook"><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/index.xml rel=alternate type=application/rss+xml title="forest nook"></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><div class=posts><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1026/>権限管理ができるようになった</a></h1><div class=post-meta><span class=post-date>2023-10-26 (Thu.)</span></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;
#<a href=/diary/tags/auth/>auth</a>&nbsp;
#<a href=/diary/tags/node.js/>node.js</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#rbac-なミドルウェアの実装>rbac なミドルウェアの実装</a></li><li><a href=#nodejs-のアップグレード>node.js のアップグレード</a></li></ul></nav></div><div class=post-content><p>1時に寝て何度か起きて7時半に起きた。なんかしんどい夢をみたが、もう覚えていない。</p><h2 id=rbac-なミドルウェアの実装>rbac なミドルウェアの実装</h2><p><a href=/diary/posts/2023/1025/#interface-はデシリアライズできない>昨日の続き</a> 。rbac (role-based access control) なライブラリが一通り実装できたのでそれを使って <a href=/diary/posts/2023/1023/>echo のミドルウェア</a> を実装した。やりたいことは次のようなこと。たったこれだけだが、これを実装するために、ここ1週間ほど、あれやこれやの実装をしてきた。ようやくそれが動くようになったというところ。私にとってはミドルウェアの仕組みは過去に何度も実装してきたものだが、頭に描いたイメージのまま、実装できたのがよかったと思う。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>rbacWithConfig</span>(<span style=color:#a6e22e>cfg</span> <span style=color:#a6e22e>rbacConfig</span>) <span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>MiddlewareFunc</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>next</span> <span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>HandlerFunc</span>) <span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>HandlerFunc</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>c</span> <span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>cfg</span>.<span style=color:#a6e22e>Skipper</span>(<span style=color:#a6e22e>c</span>) {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>next</span>(<span style=color:#a6e22e>c</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>req</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Request</span>()
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>Context</span>()
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>sessionStore</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>keySession</span>).(<span style=color:#a6e22e>session</span>.<span style=color:#a6e22e>Store</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>userName</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#e6db74>&#34;username&#34;</span>).(<span style=color:#66d9ef>string</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>s</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>session</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>sessionStore</span>, <span style=color:#a6e22e>userName</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to get session: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Role</span>.<span style=color:#a6e22e>CanAccess</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>URL</span>.<span style=color:#a6e22e>Path</span>, <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>Method</span>) {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>ErrForbidden</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>next</span>(<span style=color:#a6e22e>c</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=nodejs-のアップグレード>node.js のアップグレード</h2><p>ちょうど管理画面も少し触ろうと思って環境を構築し始めた。たまたま node.js のバージョンをみると、ちょうど10月18日で 18 (LTS) の active support 期間が終了していた。security support は2025年4月まであるのでそんな急がなくてもよいが、それに気付いたついでなので 20 (LTS) にアップグレードすることにした。幸い、大半のライブラリは 20 (LTS) でもそのまま動いた。しかし、依存ライブラリのアップデートをしていて、一部 conflict してうまく動かないライブラリもあった。細かい原因調査をしていないが、フロントエンドの方がこまめにバージョンを上げていかないと何が原因でアプリケーションが正常に動かなくなるのか、分からなくなる気がする。</p><ul><li><a href=https://endoflife.date/nodejs>https://endoflife.date/nodejs</a></li></ul></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1025/>非日常を提供するという価値</a></h1><div class=post-meta><span class=post-date>2023-10-25 (Wed.)</span></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;
#<a href=/diary/tags/event/>event</a>&nbsp;
#<a href=/diary/tags/coworking/>coworking</a>&nbsp;
#<a href=/diary/tags/book/>book</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#interface-はデシリアライズできない>interface はデシリアライズできない</a></li><li><a href=#コワーキングのオンラインイベント>コワーキングのオンラインイベント</a></li></ul></nav></div><div class=post-content><p>1時半に寝て3時に起きてもう1回起きて6時半に起きた。</p><h2 id=interface-はデシリアライズできない>interface はデシリアライズできない</h2><p><a href=/diary/posts/2023/1024/#rbac-なライブラリの実装>昨日の続き</a> 。rbac なライブラリを使ってアプリケーションを実装していく。ログイン時にユーザーにロールを割り当ててセッションにロールを保持するのが都合よさそうに思えた。ロールの実装で一部の型は interface にして後から拡張できるような設計にしていた。例えば <a href=https://pkg.go.dev/encoding/json>encoding/json</a> ライブラリだと、Marshaler/Unmarshaler の interface を満たすことで任意の json のシリアライズ/デシリアライズをフックできる。調べたり、実際に動かしていていて気付いたのだけど、interface の場合はシリアライズは任意にできるけど、デシリアライズはできない。当たり前と言えば当たり前だが、interface を満たす複数の型がある中で json ライブラリがどの型でデシリアライズしていいか判別できないからだ。当初の interface を用いた設計が誤りだったことに気付いて、一部の型を汎用の構造体で設計し直すようなことをしていた。</p><p>またデシリアライズするときに一部の値を初期化したいといった要件がある。例えば mutex を初期化したい。このときに処理の内部で派生型を宣言して、それにキャストした上でデシリアライズの処理を実行した上で差分の処理を実装するというテクニックを学んだ。スコープが限定されて、コードがシンプルになって保守性も高い、久しぶりに頭のよいスマートなコードをみた。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Role</span>) <span style=color:#a6e22e>UnmarshalJSON</span>(<span style=color:#a6e22e>b</span> []<span style=color:#66d9ef>byte</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Alias</span> <span style=color:#a6e22e>Role</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Unmarshal</span>(<span style=color:#a6e22e>b</span>, (<span style=color:#f92672>*</span><span style=color:#a6e22e>Alias</span>)(<span style=color:#a6e22e>r</span>)); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>mu</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Mutex</span>{}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li><a href=https://stackoverflow.com/questions/56400734/custom-unmarshalbson-in-mongo-go-driver>Custom UnmarshalBSON in mongo-go-driver</a></li></ul><h2 id=コワーキングのオンラインイベント>コワーキングのオンラインイベント</h2><p>月例のカフーツさんのオンラインイベントに参加した。<a href=/diary/posts/2023/0927/#コワーキングのオンラインイベント>前回の所感はここ</a> 。今日は参加者が2人だけだった。コワーキングスペースを運営するコワーキングスペースマネージャーの連携を強化することで、コワーキングスペースの付加価値が上がったりしないか？といった内容を話したりしていた。コワーキングスペースマネージャーは、普通はお仕事で自分のコワーキングスペースにいないといけないから、なかなか他所のコワーキングスペースへ訪問すること自体が難しい。コワーキングスペース同士の連携により、お仕事でコワーキングスペースマネージャーが自分ところのコワーキングスペースの利用者を連れて、他所のコワーキングスペースへ訪問して、そこでイベントをしたりすればいいんじゃないかという案が出た。</p><p>いとうさんがよく <a href="https://cahootz.jp/?cat=21">コワーキングツアー</a> と称して、全国各地のコワーキングスペースへ訪問して、そこでイベント開催をしたり、その地域の取り組みなどを紹介したりしている。それと全く同じことを、コワーキングスペースの利用者に対してもその付加価値というのはあるかもしれないと私もよいアイディアだと思った。例えば、大阪のコワーキングスペースの利用者を広島へ連れていって、そこでイベントやって交流する。その逆も然り。通常のコワーキングスペースの利用者は自ら広島のコワーキングスペースへ行ってコラボレーションを行ったりしない。いや、いとうさんみたいに自らやる人もいるんだけど、そんな人は対象の利用者ではない。自分からは行かないが、誘われたら行ってもいいかなと考える人 (私もそんな1人だ) を移動させることで、新しい価値やアイディアが生まれるかもしれないと思える。私もいまはフルタイムのお仕事があるから自由に移動はできないが、いずれ会社の投資期間に入って、自分でスケジュールを決められる状況になれば、コワーキングツアーにも出掛けてみようと思う。</p><p>あと勉強会やイベント以外でコワーキングスペースで出来ることはないか？という話題でも盛り上がった。私は主催者の準備が大変だと出来ないから、主催者のコストが低いものという視点から考えて猫コワーキングがいいんじゃないかと提案してみた。ある週だけコワーキングスペースに猫が10匹ぐらいいますといった取り組み。課題は猫をどこから連れてくるかだけだが、そういう機会があれば確かに私も行ってみたい。そのアイディアの発散で非日常の体験ができるような取り組みがよいんじゃないかとまとめられていた。</p><ul><li>猫コワーキング (猫がたくさんいる)</li><li>深夜コワーキング (深夜に開いている)</li></ul><p>深夜コワーキングスペースのモデルとなる <a href=https://20db.stores.jp/>弐拾dB</a> さんというコワーキングスペースが広島の尾道にあるらしい。23-翌5時という営業時間だという。いとうさんが絶賛していたのでおもしろいオーナーが運営されているのだと思う。そのオーナーが執筆したエッセイの <a href=https://20db.stores.jp/items/61869c960548e03fb98a95ac>頁をめくる音で息をする</a> を購入してみた。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1024/>初めて rbac なライブラリを実装した</a></h1><div class=post-meta><span class=post-date>2023-10-24 (Tue.)</span></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/auth/>auth</a>&nbsp;
#<a href=/diary/tags/history/>history</a>&nbsp;
#<a href=/diary/tags/economy/>economy</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#rbac-なライブラリの実装>rbac なライブラリの実装</a></li><li><a href=#変わりゆく世界秩序>変わりゆく世界秩序</a></li></ul></nav></div><div class=post-content><p>22時頃から休んでいて寝たり起きたりで7時に起きた。起きたらネットの記事とかだらだら読んでた。</p><h2 id=rbac-なライブラリの実装>rbac なライブラリの実装</h2><p>昨日から認可のための仕組みを調査している。私の中ではもっとも一般的な rbac (role-based access control) でまずは作ってみようと思う。次の2つのライブラリの利用を検討したが、自分たちのやりたいことにあわない気がして今回は見送ることにした。</p><ul><li><a href=https://github.com/casbin/casbin>https://github.com/casbin/casbin</a><ul><li>モデル定義とポリシー設定が複雑過ぎて設定が難しい、保守が大変になりそう</li></ul></li><li><a href=https://github.com/mikespook/gorbac>https://github.com/mikespook/gorbac</a><ul><li>イメージはあっているが、この程度のライブラリなら自分で作った方が学習コストもなく、拡張にも柔軟に思える</li></ul></li></ul><p>一通り、ライブラリとして使えるように参照実装した。これから実際のアプリケーション要件にあわせてミドルウェアとして rbac な認可処理を作っていく。</p><h2 id=変わりゆく世界秩序>変わりゆく世界秩序</h2><p><a href=https://www3.nhk.or.jp/news/special/international_news_navi/articles/feature/2023/09/26/34645.html>サンフランシスコが陥った負の“スパイラル”</a> の記事にあるような、米国で950ドル以下の窃盗は軽犯罪とするという法律の変更によって、万引きを逮捕しなくなってモラル崩壊が起きて、小売店の商品を普通に盗むという事件が多発しているらしい。fin-py でおがわさんとそんな話しをしていたら次の動画を教えてもらった。私は歴史が好きなので、こういった「歴史は繰り返す」といったものはだいたいみてしまう。厳密な裏付けはわからないが、盛者必衰という言葉もあるように、どんな国でも栄枯盛衰のサイクルはあるだろうというのは大局の視点として同意できる。過去の歴史と国の栄枯盛衰をいくつかの指標とお金の視点から調査したものでおもしろかった。</p><p>日本は80年サイクルで戦争の周期がくるといった説もあるが、この動画でもサイクルの切り替わりのタイミングで平和的にしろ暴力的にしろ、かならず戦争は起きると説明している。もうすでに戦争は始まっている感もあるが、戦争は避けようがないという点も同意するところだ。本も読んでみようと思う。</p><div class=video-container><iframe src=https://www.youtube.com/embed/y3oy8y0EljY allowfullscreen title="レイ・ダリオ著 「変わりゆく世界秩序」"></iframe></div></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1023/>echo のミドルウェア関数のスタイル</a></h1><div class=post-meta><span class=post-date>2023-10-23 (Mon.)</span></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;
#<a href=/diary/tags/code-reading/>code reading</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#echo-のミドルウェア開発>echo のミドルウェア開発</a></li></ul></nav></div><div class=post-content><p>1時に寝て何度か起きて6時半に起きた。起きてから軽く部屋の掃除をした。</p><h2 id=echo-のミドルウェア開発>echo のミドルウェア開発</h2><p>go の api サーバーの開発に <a href=/diary/posts/2022/1122/#echo-を採用>echo</a> という定番のフレームワークを使っている。少し前にメンバーに認証の処理をミドルウェアとして実装してもらった。いま認可の仕組みもミドルウェアで実装しようと、いくつかソースコードを読んでいて、echo のフレームワークが提供しているミドルウェアの関数名や config には共通点があることに気付いた。<a href=https://echo.labstack.com/docs/category/middleware>echo middleware</a> によると、20個ぐらいのミドルウェアが提供されている。例えば、適当にそのうちの3つほどを取り出すが <code>XxxWithConfig</code> という命名規則で config を受けとって echo.MiddlewareFunc を返すというインターフェースになっている。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>HTTPSRedirectWithConfig</span>(<span style=color:#a6e22e>config</span> <span style=color:#a6e22e>RedirectConfig</span>) <span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>MiddlewareFunc</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>LoggerWithConfig</span>(<span style=color:#a6e22e>config</span> <span style=color:#a6e22e>LoggerConfig</span>) <span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>MiddlewareFunc</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>BodyDumpWithConfig</span>(<span style=color:#a6e22e>config</span> <span style=color:#a6e22e>BodyDumpConfig</span>) <span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>MiddlewareFunc</span>
</span></span></code></pre></div><p>また config の中身をみていると、ミドルウェアの処理に必要な関数を渡すような設計になっている。複数のミドルウェアにとって共通なのは、ミドルウェアの処理を迂回する条件を実装するため <code>middleware.Skipper</code> という型が次のように型で定義されている。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>Use</span>(<span style=color:#a6e22e>middleware</span>.<span style=color:#a6e22e>BasicAuthWithConfig</span>(<span style=color:#a6e22e>middleware</span>.<span style=color:#a6e22e>BasicAuthConfig</span>{
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Skipper</span>: <span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Skipper defines a function to skip middleware.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    },
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Validator</span>: <span style=color:#66d9ef>func</span>(<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>Context</span>) (<span style=color:#66d9ef>bool</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Validator is a function to validate BasicAuth credentials.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// Required.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    },
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Realm</span>: <span style=color:#e6db74>&#34;Restricted&#34;</span>,
</span></span><span style=display:flex><span>}))
</span></span></code></pre></div><p>典型的なミドルウェアは次のように実装する。最初に Skipper を呼び出して処理の有無を確認する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>next</span> <span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>HandlerFunc</span>) <span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>HandlerFunc</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>c</span> <span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>Skipper</span>(<span style=color:#a6e22e>c</span>) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>next</span>(<span style=color:#a6e22e>c</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// TODO: ミドルウェア本体の処理
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>next</span>(<span style=color:#a6e22e>c</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>認証のミドルウェアを実装してもらったときに、私がここまでみていなかったなということに気付いて、既存のミドルウェアを echo のそれと同じスタイルにあわせるようにリファクタリングした。自分でソースコードを読んでいるとコードレビューで気付かなかったことに気付くことが多い。自分がコードを書いているときと、コードレビューをしているときでなにかしら視点が違う。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1022/>ほぼ休みに近いオフィスワーク</a></h1><div class=post-meta><span class=post-date>2023-10-22 (Sun.)</span></div><span class=post-tags>#<a href=/diary/tags/noh/>noh</a>&nbsp;
#<a href=/diary/tags/life/>life</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#芦屋能の申込み>芦屋能の申込み</a></li><li><a href=#業務スーパーのナポリタンサラダ>業務スーパーのナポリタンサラダ</a></li></ul></nav></div><div class=post-content><p>3時に寝て何度か起きて8時半に起きた。午前中はだらだらしていた。午後は事務手続きしたり、本を読んだりしていた。</p><h2 id=芦屋能の申込み>芦屋能の申込み</h2><p>昨日 <a href=/diary/posts/2023/1021/>蝉丸の予習</a> をしてきたが、来月に能の「蝉丸」の上演がある。せっかく物語の背景や詞章の勉強したので見に行くことに決めた。<a href=https://yarai-nohgakudo.com/archives/11286>第二十二回芦屋能・狂言鑑賞の会</a> にローソンチケットで申込みした。金曜日の17時と、ちょっとお仕事を早く終えて出掛けないといけない。芦屋ルナ・ホールという、行ったことない会場になる。前の方に座れるなら指定席を選択するのだけど、いま購入しようとすると、チケットが残りわずからしいのであまりよい席は残っていないと推測する。今回は2階席 (自由席) 3,000円 で観ることにした。昨日の能イベントの会場である芦屋能舞台でもいくつかチケットがあると朝原さんが話されていた。そこで買った方がよい席を取ることができたのかもしれない。また次の機会があれば聞いてみようと思う。</p><h2 id=業務スーパーのナポリタンサラダ>業務スーパーのナポリタンサラダ</h2><p>ちょくちょく業務スーパーで買いものする。業務スーパーの惣菜などは国内工場で作っているとあるからなんとなく安心して買っている。いつもは <a href="https://www.gyomusuper.jp/product/detail.php?go_id=2389">マカロニサラダ</a> を買っていて、野菜サラダの付け合わせにしたり、刻みネギを混ぜて食べたりしている。今日は初めてナポリタンサラダというのをみつけた。また業務スーパーのサイトにないのでおそらく新製品なのだろうと思う。私はナポリタンが好きなので買ってみた。よくあるお弁当の付け合わせに入ってそうな風味で300円程度の値段を考えれば十分においしい。単体で食べても小腹を満たせるし、他のものと組み合わせもしやすそうに思う。業務スーパーの買いもの楽しい。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1021/>蝉丸の予習</a></h1><div class=post-meta><span class=post-date>2023-10-21 (Sat.)</span></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/noh/>noh</a>&nbsp;
#<a href=/diary/tags/history/>history</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#ストレッチ>ストレッチ</a></li><li><a href=#能楽の勉強>能楽の勉強</a></li></ul></nav></div><div class=post-content><p>21時頃から休んでいて何度か寝たり起きたりしながら5時に起きた。だらだらして気付いたら8時半だった。</p><h2 id=ストレッチ>ストレッチ</h2><p>今週もとくに本業が忙しかったわけではないが、本業以外のお仕事や作業がたくさんあって、わりと座っている時間が長くて疲れていたのかもしれない。腰は大丈夫かな？と思ったものの、左腰の後ろはかなり張りがあってきつかった。トレーナーさんはあまり気付かなかったみたいだが。あと太ももの後ろの筋が張っていて今日は重点的にそこを伸ばしてもらって気持ちよかった。太ももの後ろの筋って物理的に自分では絶対に伸ばせない位置にあるため、トレーナーが伸ばしてくれることに大きな意義がある。これだけでもドクターストレッチさんに通っていてよいところだと思う。今日の開脚幅は開始前156cmで、ストレッチ後159cmだった。数値はまぁまぁ。</p><h2 id=能楽の勉強>能楽の勉強</h2><p>前に1度行ったことのある「能のことばを読んでみる会」へ行ってきた。<a href=/diary/posts/2023/0716/#能楽の勉強>前回の所感はここ</a> 。参加者は私が数えたところ17名。前回、いつもは10人に満たないと仰っていたが、朝原さんのマーケティングがうまくいっているのか、今回も10人は軽く超えていた。</p><p>このイベントはとてもおもしろい。</p><ul><li><a href=https://nohgaku-kyodo.com/repertoire/yondemiru-semimaru20231021>『百人一首』で知られる蝉丸と、その姉・逆髪が出会い、別れる能《蝉丸》 第36回能のことばを読んでみる会</a></li></ul><p>今日のテーマは「蝉丸 (せみまる) 」だった。国語の授業などで百人一首として習ったことを覚えている人もいるだろうか。</p><blockquote><p>これやこの 行くも帰るも 別れては 知るも知らぬも 逢坂の関</p><p>蝉丸 (せみまる)</p></blockquote><p>有名だし、私も学生の頃は百人一首を覚えていたのでこの歌は覚えている。百人一首の引用元となる <a href=https://ja.wikipedia.org/wiki/%E5%BE%8C%E6%92%B0%E5%92%8C%E6%AD%8C%E9%9B%86>後撰和歌集</a> では次のように収録されている。</p><blockquote><p>これやこの 行くも帰るも 別れつつ 知るも知らぬも 逢坂の関</p></blockquote><p>オリジナルは「別れつつ」だったのが百人一首では「別れては」に改変されている。たまたま調べていると次のような質問をみつけた。</p><blockquote><p>後撰和歌集に収録されている蝉丸の「これやこの 行くも帰るも 別れつつ 知るも知らぬも 逢坂の関」の和歌について、歌集によっては第三句が「別れては」となっている。「別れつつ」と「別れては」では解釈が違うのか、解説が載っている資料が見たい。</p><p><a href="https://crd.ndl.go.jp/reference/modules/d3ndlcrdentry/index.php?page=ref_view&id=1000328600">https://crd.ndl.go.jp/reference/modules/d3ndlcrdentry/index.php?page=ref_view&id=1000328600</a></p></blockquote><p>この回答でも後世の人たちが「別れては」の方がまとまりが良いとか、読みやすいとか、抑揚が利くとか、そんな理由で勝手に改変してそれが有名になった例の1つだという。能の世界でもこういったオリジナルの単語 (漢字) や言い回しが変わってしまうことはちょくちょくあるらしい。それは文書を複写するときに単純に書き間違えたとか、後世の人がこの方がよいと勝手に表現を変えてしまうことがあって、オリジナルよりもそちらが有名になってしまうことがあるらしい。</p><p>日本の歴史を調べるときに最初に調べる辞典として <a href=https://japanknowledge.com/contents/kokushi/>国史大辞典</a> がある。そこに蝉丸の記述がある。平安時代の歌人、音楽家。生没年不詳で、伝説的人物で諸説あるとのことで、本当に伝えられている経歴や逸話が正しいのかはよく分かっていないという。最も確実なのが、後撰和歌集の和歌を詠んだのが蝉丸という人物だという伝承だという。蝉丸を祀った神社は3つあり、現代では諸芸道の神様として祀られている。</p><ul><li><a href=https://ja.wikipedia.org/wiki/%E8%9D%89%E4%B8%B8%E7%A5%9E%E7%A4%BE>蝉丸神社</a></li><li><a href=https://ja.wikipedia.org/wiki/%E9%96%A2%E8%9D%89%E4%B8%B8%E7%A5%9E%E7%A4%BE>関蝉丸神社</a><ul><li>上社</li><li>下社</li></ul></li></ul><p>蝉丸は生まれつき盲目でありながら琵琶の名人として伝わっており「盲琵琶」の祖とされるが、これもよくわかっていない伝承だという。ここまでを能の「蝉丸」を読み始める前の予備知識として、講師の朝原さんがさらっと話すのがこのイベントの醍醐味。私がここに書き残せていない話題もまだいくつかある。一般人はここまででお腹いっぱいになるが、これが能を読み始める前段階である。</p><p><a href=https://www.the-noh.com/jp/plays/data/program_057.html>能の「蝉丸」</a> は、皇子なのに盲目であるために捨てられる蝉丸、皇女なのに逆さまに生い立つ髪をもち狂人であるために捨てられる逆髪の2人が、逢坂山という辺地でたまたま？出会うという物語になっている。朝原さんが天に向かって逆さまに生い立つ髪ってどういうものか現実には想像できないが、少年漫画の世界ではないか？と話されていて、私は <a href=https://www.shonenjump.com/j/rensai/hunter.html>HUNTER×HUNTER</a> のゴンみたいな髪型を連想したw</p><p>蝉丸は盲目なので盲目の人からの視点の表現と、逆髪は目がみえるので (狂人だけど) 健常者からの視点の表現が対比として表されているのもおもしろい。京都から逢坂山の関を超える <a href=https://db2.the-noh.com/jdic/2008/07/post_27.html>道行</a> の表現がまったく異なる。お互い捨てられた先の辺地の藁屋で、蝉丸が琵琶を弾いたことに逆髪が気付いて、藁屋を尋ねる (出会う) と物語が進んでいって、お互いに涙を流して再会に感動するものの、逆髪は「じゃあ、またね」って感じにすぐ？帰ろうとするのに対して、蝉丸は「もう行っちゃうんですか？！」的な名残惜しくて、ただそれだけのやり取りの能となっている。この能はただ姉弟が出会って別れるだけの、なんの事件も起こらないし、なんの因果もない。これは仏教でいう <a href=https://ja.wikipedia.org/wiki/%E4%BC%9A%E8%80%85%E5%AE%9A%E9%9B%A2>会者定離 (えしゃじょうり)</a> を表しているという。出会った者は必ず別れることになるという普遍的な摂理。関西人からみると、オチがないやんとツッコミたくなるところが、哲学的ではまるところなのかもしれない。</p><p>11月に <a href=http://www.ashiya-nohbutai.com/img/kouen/2023/20231117-2.pdf>第二十二回「芦屋能・狂言鑑賞の会」</a> で能の「蝉丸」が演じられるようなので見に行こうと思う。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1020/>相続の手続きを完了した</a></h1><div class=post-meta><span class=post-date>2023-10-20 (Fri.)</span></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/tax/>tax</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#相続税の申告>相続税の申告</a></li><li><a href=#家族信託のススメ>家族信託のススメ</a></li></ul></nav></div><div class=post-content><p>0時に寝て4時に起きて6時前に起きた。最近早起きになってきた。</p><h2 id=相続税の申告>相続税の申告</h2><p>今月に入って、何度か <a href=/diary/posts/2023/1004/#会計士事務所への訪問>会計事務所へ書類をもって訪問</a> したりしていた。昨日ようやく公認会計士の先生から相続税の申告を終えたという連絡をいただいた。父が失くなったのが <a href=/diary/posts/2022/1226/>昨年の12月26日</a> でこの26日が申告期限となっていた。なんでこんなに時間がかかるの？と思いたくもなるが、うちの場合は10ヶ月ぎりぎりで相続税の申告ができた。遅れても延滞税がかかるだけで逮捕されるわけではなさそう。</p><p>ともあれ、相続が無事に終わってよかった。父は交通事故にあって遺言を残せる状態に回復することもなく入院生活を送って亡くなった。相続税の配偶者控除は手厚くて1億6,000万円までは相続税免除となる。なるべく母が相続する方が税金が少なくなるように一見はみえる。しかし、うちは2次相続も考慮して母と姉と私の3者に対して法定相続を採用することに決めた。2次相続のシミュレーション結果がどうであっても、私は母が相続しても詐欺で騙されて失ってしまうことを前提と考えているため、税金を余分に支払ってでも法定相続を採用しようと、もともと考えていた。最終的に母は相続税が不要なため、姉と私の2人が相続税を支払う形になった。それもすべて公認会計士さんが手続きしてくれたのでとくに労力があったわけでもない。</p><ul><li><a href=https://legacy.ne.jp/knowledge/now/souzoku/524-nijisouzoku-ichijisouzoku-chigai-kaisetsu/>なぜ二次相続は重要？一次相続との違いや税額シミュレーションについても解説</a></li></ul><p>相続の手続きで揉めたのが <a href=/diary/posts/2023/0510/>未登記の建物の扱い</a> だった。原則として建物はすべて登記しなければならないという法律はあるものの、過去の建物は未登記のものが多く、うちの実家の建物も大半が未登記だとわかった。そのまま未登記のまま、固定資産税評価額を使って相続税を算出することで問題なく完了できた。</p><h2 id=家族信託のススメ>家族信託のススメ</h2><p>母が一定のお金を相続するにあたり、弁護士さんから <a href=https://kazokushintaku.org/whats/>家族信託</a> を推奨されている。家族信託とは、後見人制度に代わる柔軟な財産管理をするための仕組みらしい。</p><p>うちは交通事故により父が意思疎通を図れない状態となったため、有無を言わさず成年後見人が選任され、その財産管理の在り方に大きな不満をもっている。さらに成年後見人の弁護士さんに少なくない手数料を5年間に渡って支払っている。実際の運用を経験して成年後見人という制度に懐疑的なところがいくつかある。</p><p>家族信託はそういった成年後見人による財産管理に代わるもので、契約時に決めた条件に従って財産の管理を第3者 (たいていは親族？) に委託する仕組みらしい。初期費用として50-100万円ほどかかるが、その後の維持管理のために経費はかからない。うちの場合は年間 627,000 円 (税込) を成年後見人の弁護士さんへ支払っていた。つまり毎月 52,250 円 (税込) を弁護士さんへ支払っていたことになる。この費用が本人が亡くなるまでずっと継続するというのが、成年後見人制度のコストの大きいところ。うちは5年間、さらに他にもいろいろあって、もっと多額の手数料を弁護士さんへ支払っている。もしかしたら財産の多寡によっては、さらに大きな金額を支払うことになるのかもしれない。</p><p>初期費用がかかるのは次の段取りを踏む必要があり、これらの作業に専門家へ依頼することでそのコンサルティング費用や事務手続き費用がかかるとのこと。</p><ul><li>契約書の作成</li><li>公正証書の作成</li><li>信託口座の開設</li></ul><p>これによって、契約書で決めた用途に関しては私や姉がお金を管理をして、母に送金するといったことが可能となる。母は直接、信託口座からお金を引き出すことはできない。運用としては、母から送金依頼があったときに私や姉が手続きをして、年に1回、私や姉から母へ報告をおこなう必要があるといった程度の労力が必要になる。弁護士さんに教えてもらった話しとオンラインの記事をみながらメリットをまとめる。</p><ul><li>成年後見人制度よりも (一般論として) コストが安く、柔軟に財産管理できる</li><li>最初に決めた契約の内容に従って財産を運用できる<ul><li>(元本保証がない) 資産運用もできる (成年後見人は不可、財産が目減りする可能性があるものは一切できない)</li></ul></li><li>親が判断能力を失っても財産管理に影響が出ない<ul><li>認知症になっても子どもが財産を運用できる</li><li>詐欺に騙されてもお金を引き出せない</li></ul></li><li>知的障害のある子どもがいる場合に、親が亡くなった後も財産を子どものために使ってもらうように運用できる</li><li>ハイリスクな不動産の共有をしなくて済む</li></ul><p>家族信託と、家族が勝手に親の通帳を取り上げて、認証情報を秘密にして運用するのと何が違うのかも弁護士さんに聞いてみた。</p><ul><li>本人が金融機関に紛失届を出せば容易に再発行できる</li><li>親のお金を子どもが取り上げているという後ろめたさがある<ul><li>この状態を裁判などで訴えれば親側の主張が正しい</li></ul></li></ul><p>姉とも相談しつつ、母も説得しつつ、家族信託をするのでいいのではないかと、いまのところ、私は考えている。</p></div></div><div class=pagination><div class=pagination__buttons><a href=/diary/page/10/ class="button previous"><span class=button__icon>←</span>
<span class=button__text>最近の日記</span></a>
<a href=/diary/page/12/ class="button next"><span class=button__text>過去の日記</span>
<span class=button__icon>→</span></a></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>© 2021 Tetsuya Morimoto</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>