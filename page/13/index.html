<!doctype html><html lang=en><head><meta name=generator content="Hugo 0.109.0"><title>forest nook</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content="t2y"><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="forest nook"><meta property="og:description" content><meta property="og:url" content="/diary/"><meta property="og:site_name" content="forest nook"><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/index.xml rel=alternate type=application/rss+xml title="forest nook"></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><div class=posts><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1012/>xoauth2 という smtp の認証</a></h1><div class=post-meta><span class=post-date>2023-10-12 (Thu.)</span></div><span class=post-tags>#<a href=/diary/tags/network/>network</a>&nbsp;
#<a href=/diary/tags/auth/>auth</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#oauth-20-で認証して-google-の-smtp-サーバーを使う>oauth 2.0 で認証して google の smtp サーバーを使う</a></li></ul></nav></div><div class=post-content><p>0時に寝て何度か起きて6時に起きた。昨日、凡人が天才に挑むという状況で、キングダムの <a href=https://dic.pixiv.net/a/%E8%92%99%E9%A9%81>蒙驁</a> 将軍が廉頗に挑むみたいな状況を思い出して見返していた。史実では蒙驁が魏を攻めて東郡を置いたというのは事実だが、廉頗と戦ったという記録はなく、おそらくは蒙驁と廉頗に因縁があって雪辱戦としたというのはキングダムの創作だろうと推測される。</p><h2 id=oauth-20-で認証して-google-の-smtp-サーバーを使う>oauth 2.0 で認証して google の smtp サーバーを使う</h2><p>google さんの smtp.gmail.com の smtp サーバーを使ってメールを送信したい。</p><ul><li><a href=https://workspaceupdates.googleblog.com/2019/12/less-secure-apps-oauth-google-username-password-incorrect.html>Turning off less secure app access to G Suite accounts</a></li><li><a href=https://workspaceupdates.googleblog.com/2023/09/winding-down-google-sync-and-less-secure-apps-support.html>Beginning September 30, 2024: third-party apps that use only a password to access Google Accounts and Google Sync will no longer be supported</a></li></ul><p>2019年にパスワード認証は廃止するので oauth 2.0 へ移行してくださいといった、最初のアナウンスが行われて、もうできないかと思ったら2024年9月30日に完全廃止するのかな？まだパスワード認証は動くかもしれない。一方で oauth 2.0 へ移行しないといけないのでその調査をメンバーにしてもらっていた。結局、途中からは私も本気になって調べていた。</p><p>oauth 2.0 で認証してアクセストークンとリフレッシュトークンを取得するためのサンプルコードとして <a href=https://github.com/google/gmail-oauth2-tools/wiki/OAuth2DotPyRunThrough>OAuth2DotPyRunThrough</a> が用意されている。このトークンを取得するときに callback の url にユーザーが明示的にアクセスして同意する必要がある。ここで得たアクセストークンは1時間で有効期限がきれる。しかし、リフレッシュトークンはユーザーが revoke しない限りは永続的に使えるそうで、このリフレッシュトークンを使って必要なときにアクセストークンを取得するというのが google さんの oauth 2.0 のアプリケーションの運用になるみたい。つまりリフレッシュトークンをアプリケーション側で管理することでアクセストークンは何度でも取得できる。</p><p><a href=https://developers.google.com/gmail/imap/xoauth2-protocol>OAuth 2.0 Mechanism</a> によると、取得したアクセストークンを使って <code>XOAUTH2</code> という smtp の認証方式で認証すれば smtp サーバーに対して smtp でメールを送信できる。gmail 以外でメールをやり取りする機会がなくなって数年たつ。smtp の仕組みとか、まったく忘れてしまって関心もない。たったこれだけなんだけど、右往左往してあちこち調べることになった。ややこしいのは google のクラウド api 経由でメールを送ることもできて、そのやり方と混同するとまったく違う方向に行ってしまう。そこだけ注意。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1011/>ステートレスな認証という概念</a></h1><div class=post-meta><span class=post-date>2023-10-11 (Wed.)</span></div><span class=post-tags>#<a href=/diary/tags/auth/>auth</a>&nbsp;
#<a href=/diary/tags/security/>security</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#ステートレスな認証という概念>ステートレスな認証という概念</a></li></ul></nav></div><div class=post-content><p>0時に寝て4時ぐらいに起きてだらだらして7時半に起きた。やっぱりあまり眠れない。</p><h2 id=ステートレスな認証という概念>ステートレスな認証という概念</h2><p>次の開発フェーズが始まっていて、ちょっと時間が経ってしまったが、前開発フェーズのお披露目的な製品紹介をお手伝い先の全社向けに行った。主には直近の開発フェーズで追加した機能などを紹介した。その過程で新たに認証の仕組みを追加して jwt で認証するといった話しをしたところ、それはステートレスなのかどうかといった質問が出た。セキュリティを考慮して、アーキテクチャ的にフロントエンドの認証と api サーバーの認証は分けて実装しているのと、そのために仕組みも複雑になっているのだけど、ステートレスという言葉が指す意図を私がよくわかっていなくて、うまく説明できなかった。説明を終えた後にアーキテクチャのイメージ図と一緒に補足をしながらやり取りして次の記事を教えてもらった。</p><ul><li><a href=https://zenn.dev/ritou/articles/4a5d6597a5f250>&ldquo;JWT=ステートレス"から一歩踏み出すための考え方</a></li></ul><p>jwt は暗号化の技術で認証する仕組みなので有効期限が切れるまでは有効なアクセストークンとなる。そのため、jwt のみだとログアウトという概念はないため、そこをどうしているのか？という質問だった。フロントエンド／api サーバーともに session をオンメモリで保持して、ログインしたユーザーを管理しているため、ログアウトしたら session からレコードを削除することで有効な jwt のアクセストークンが来ても認証エラーにしてしまうことでステートをもった認証方式を実現している。とくまる先生が次のように説明しているところ。</p><blockquote><p>「セッションIDをJWTに内包する」 という考え方です。</p></blockquote><p>うちはこれをセッション ID ではなくユーザー名でやっている。とくに難しいことをやっているわけではなく、普通に実装したらそんな感じかな？と考えていたが、jwt = ステートレス認証だと思い込んでいる人たちがいるから <em>ストートレスな認証</em> というキーワードが出てきたんだなと理解できた。最近のトレンドとしてはログアウトで jwt のアクセストークンを無効にできないと脆弱性と指摘される可能性がありそうとも書いてある。</p><blockquote><p>ログアウト時にJWTを無効化できない実装は今後脆弱性診断で「OWASP Top 10 2021違反」と指摘されるようになりそう(今も個別にされてるかもしれないけど)</p></blockquote><p>私はアーキテクチャ的にブラウザに api サーバーのアクセストークンをみせないというところに注力して認証機能の開発をサポートしていた。それ自体も間違っていないとは思うけど、今回の質問はその工夫とは異なるところの質問だった。認証は難しい。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1010/>珍しく余裕のなかった一日</a></h1><div class=post-meta><span class=post-date>2023-10-10 (Tue.)</span></div><span class=post-tags>#<a href=/diary/tags/founding/>founding</a>&nbsp;
#<a href=/diary/tags/tax/>tax</a>&nbsp;
#<a href=/diary/tags/issue-management/>issue management</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#税理士さんとの打ち合わせ2>税理士さんとの打ち合わせ2</a></li><li><a href=#アーキテクチャの再考>アーキテクチャの再考</a></li></ul></nav></div><div class=post-content><p>0時に寝て何度か起きて7時過ぎに起きた。眠れたような、そうじゃないようなよく分からない起き方をした。お昼ご飯を食べる間もなく、打ち合わせとコードレビューで1日を終えた。連休明けでよい慣らしになった。</p><h2 id=税理士さんとの打ち合わせ2>税理士さんとの打ち合わせ2</h2><p><a href=/diary/posts/2023/1006/#税理士さんとの打ち合わせ1>税理士さん探し</a> の続き。今回話した方は公認会計士だった。監査ができるのが公認会計士で、税務の申告ができるのが税理士という役割の違いになる。会計監査も含めてチェックしてほしかったら公認会計士さんにお願いするといった役割分担になるかもしれない。話してみて、若くて理路整然として悪い印象はなにもなかったのだけど、逆にこの人がうちの会社の会計／税務を親身にやってくれそうにもみえなかったし、ホームページの事業内容をみても公認会計士だから税務のビジネスだけではなく、もっと大きな会計のお仕事の方がを目指しているようにもみえた。同じ質問をして、前回の税理士さんの回答の違いなども考慮しながら選定の判断材料にはなるなと思いながらやり取りしていた。選択する側の打ち合わせはおもしろい。</p><h2 id=アーキテクチャの再考>アーキテクチャの再考</h2><p>お手伝いしているシステム開発で、私の中ではもうアーキテクチャは固まったかな？と考えていたのが、お客さんと話していて、さらなる要件や展望を聞いているとそうじゃなかったことに気付いた。どうやら最初の実装としてはいまのアーキテクチャを堅牢に作って、その次の要件として待っていてくれたようにみえる。</p><p>私の認識を正す意味も含めて、さらにお客さんの要件や世の中の競合製品に対して競争力をもつにはどうするかといった視点をざっくばらんに雑談した。もう1段階アーキテクチャを見直す必要があるなと思えた。開発に着手して今月末でちょうど1年が経つ。これまで大きなアーキテクチャの変更もなく、順調に開発は進んできたものの、ここらで見直しやズレの補正が必要になってきてもなんらおかしくはない。いまの開発フェーズでは対応しないが、次の開発フェーズに向けてのアイディアの1つとしてアーキテクチャの再考が必要なことを認識した。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1009/>秋休み2</a></h1><div class=post-meta><span class=post-date>2023-10-09 (Mon.)</span></div><span class=post-tags>#<a href=/diary/tags/day-off/>day off</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents></nav></div><div class=post-content><p>22時に寝て何度か起きて7時に起きた。一昨日からイスラエルとパレスチナの背景の調査をしていて、だいぶあてられてしんどくなってきた。歳のせいか、誰も幸せにならない難しい問題を調べているとしんどくなる。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1008/>解決すべき難しい問題と戦争</a></h1><div class=post-meta><span class=post-date>2023-10-08 (Sun.)</span></div><span class=post-tags>#<a href=/diary/tags/international/>international</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#イスラエルとハマスの戦争>イスラエルとハマスの戦争</a></li></ul></nav></div><div class=post-content><p>23時頃から寝始めて3時ころに吐き気で苦しんで7時に起きた。寝る前にちょっとお菓子食べたのがよくなかったのかもしれない。</p><h2 id=イスラエルとハマスの戦争>イスラエルとハマスの戦争</h2><p>昨日の夕方からハマス (パレスチナ) がイスラエルにロケッ弾を打ち込んだというニュースをみていろいろ調べていた。ハマスはパレスチナのガザ地区を実効支配するイスラム組織だそうで、からなずしもパレスチナを代表しているわけではないらしい。パレスチナにもファタハと呼ばれる穏健派もあるそうで一枚岩ではないとのこと。経営者になると、こういった世界のニュースに対して経済への影響が気になって情報収集してしまう。イスラエルとパレスチナの2国間の問題はとても難しいものになっているようで、どうやって解決するのか、誰もアイディアのないまま、いまに至っているようにみえる。是非はとまかく、どちらかがどちらかを滅ぼすしかないのかもしれない。いまのところ、イスラエルとパレスチナの紛争は日常と言えるほど起こっていて、その2国間でドンパチするなら世界経済に大きな影響はないだろうとみられている。一方で今回は規模が大きいのと、一般市民への虐殺や犯行もみられることから、もっと大きな戦争に発展する懸念もみられている。ウクライナとロシアの戦争とも影響して台湾有事への懸念も、リスクは低いかもしれないが、ないわけではないとみられている。</p><ul><li><a href=https://www3.nhk.or.jp/news/special/news_seminar/jiji/jiji97/>パレスチナ問題ってなに？ １からわかる！イスラエルとパレスチナ（１）</a></li><li><a href=https://note.com/goto_finance/n/n136b3f1964f8>【現状まとめ】イスラエル「戦争状態」</a></li><li><a href=https://anond.hatelabo.jp/20231007234056>パレスチナとイスラエル、今年だけで200人死んでるよ。</a></li></ul></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1007/>世界観のあう買いもの</a></h1><div class=post-meta><span class=post-date>2023-10-07 (Sat.)</span></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/community/>community</a>&nbsp;
#<a href=/diary/tags/world-view/>world view</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#ストレッチ>ストレッチ</a></li><li><a href=#python-boot-camp>Python Boot Camp</a></li><li><a href=#ヨハクさんのフレークシール>ヨハクさんのフレークシール</a></li></ul></nav></div><div class=post-content><p>0時に寝て何度か起きて7時に起きた。2-3日前から首を寝違えていて違和感がある。課題管理のブログ記事を書こうと思っていたけど、気分がのらなくて遊んでいた。</p><h2 id=ストレッチ>ストレッチ</h2><p>今週も忙しくはなく、のんびり過ごしていたので体調は徐々に復調している。腰の張りは先週に比べてかなりよくなっているように感じた。トレーナーさんによるとふくらはぎの筋の張りがあったそうだけど、私からみたらそんなに気にはならなかった。今日の開脚幅は開始前155cmで、ストレッチ後158cmだった。首を寝違えているのもなにかしらよくなる方法があるかと思って相談してみた。トレーナーさん曰く、首の寝違えだけは自然治癒しか方法がないという。トレーナーさんたちの間でもいろいろ試してみたことがあるらしい。しかし、どれも一時的に痛みを和らげる効果のあるストレッチはあるものの、時間が経つと元に戻るので限定的なものらしい。その一時的に痛みを和らげるのも、脇の下の筋を伸ばすと効果があるらしい。トレーナーさんもなぜその筋を伸ばすと痛みが和らぐのかの理屈はよく分からないそうだが、実際に試してみてそこだけが効果があったと話されていた。</p><h2 id=python-boot-camp>Python Boot Camp</h2><p>来週、徳島の鳴門でイベントがある。いま余裕もあるのでスタッフが足らなかったら手伝ってもいいと、前にてらださんと話していた。ちょっと前まで参加者が1人しかいなかったので手伝う必要ないかと思っていたんだが、ここ数日でいっきに参加者が増えたみたいで助っ人で手伝いに行くことにした。ブートキャンプに参加するのは初めて。チュートリアルやスタッフの要項などのドキュメントを予習として読んでいた。</p><p><a href=https://pyconjp.connpass.com/event/293032/>Python Boot Camp in 徳島2nd</a></p><h2 id=ヨハクさんのフレークシール>ヨハクさんのフレークシール</h2><p>たまたま「余白」というキーワードでインターネットを検索していて次のサイトをみつけた。</p><ul><li><a href=https://yohaku.stores.jp/>https://yohaku.stores.jp/</a></li></ul><p>マスキングテープの専門店らしいが、なんとなく制作物の世界観が私にあうので応援も含めて次のフレークシールを買ってみることにした。</p><ul><li><a href="https://yohaku.stores.jp/?category_id=642bf7f02ce5f6002939cf51">CATEGORY / Flake seal</a></li></ul><p>3種類買ってみて、今日届いたので、試しに一緒に入っていた型紙に貼ってフレームに入れてみた。こういう雰囲気が好き。しばらくオフィスの棚に飾ってみようと思う。</p><ul><li>ツキトホシ</li><li>ダイアリー</li><li>テガミ</li></ul><figure><img src=/diary/img/2023/1007_frake-seal.jpg></figure></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/1006/>税理士さんの選定</a></h1><div class=post-meta><span class=post-date>2023-10-06 (Fri.)</span></div><span class=post-tags>#<a href=/diary/tags/founding/>founding</a>&nbsp;
#<a href=/diary/tags/tax/>tax</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/programming/>programming</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#税理士さんとの打ち合わせ1>税理士さんとの打ち合わせ1</a></li><li><a href=#コードレビュー>コードレビュー</a></li></ul></nav></div><div class=post-content><p>1時に寝て3時頃に吐き気で起きて1時間ぐらい苦しんでた。久しぶりにやばかった。その後なんとか寝て7時半に起きた。</p><h2 id=税理士さんとの打ち合わせ1>税理士さんとの打ち合わせ1</h2><p>うちの会社のイベントとして毎年ワーケーション (開発合宿) をやろうかと考えている。コワーキングやコミュニティの延長上でワーケーションを行うわけだが、いくらかうちの会社の持ち出しで費用負担してよいと考えている。しかし、そのときの支出はどういった建付けで経費として扱えるのかどうか、私は税理士ではないのでよくわかっていない。そういったことを相談するために税理士さんに顧問になってもらおうと考えている。うちから税理士さんへの要件としては freee のデータを正として扱ってくれればそれでいいかな。</p><p>また2021年度は赤字決算になったので2022年度に <a href=/diary/posts/2022/0626/#法人税の修正申告と欠損金の繰り戻し還付の訂正依頼>法人税の欠損金の繰り戻し還付</a> を行った。このお金を2022年度に計上していないため、その分の金額が資産のマイナスとして2023年度の決算に残ってしまっている。法人税の支払いは正しいのだが、還付金を2023年度に雑収入として登録するか、2022年度に遡って未計上の金額を登録するかのどちらかで訂正しないといけない。過去の法人決算の訂正自体も行う仕組みはあるので手続きするだけだが、それも手間暇がかかるのでついでに税理士さんにやってもらうと考えている。</p><ul><li><a href=https://support.freee.co.jp/hc/ja/articles/204403124-%E7%A8%8E%E7%90%86%E5%A3%AB-%E4%BC%9A%E8%A8%88%E5%A3%AB%E3%81%ABfreee%E3%81%AE%E6%83%85%E5%A0%B1%E3%82%92%E5%85%B1%E6%9C%89%E3%81%99%E3%82%8B>税理士・会計士にfreeeの情報を共有する</a></li></ul><p>会計システムに freee を使っているので freee さんの税理士紹介サービスを使って選定する。3事務所ピックアップしてくれたので順番に打ち合わせしていく。今日はその最初の税理事務所の方と打ち合わせした。話した感覚でうちの会社の考え方や規模にあった税理士さんだったのでこの方でいいんじゃないかとも思っているけれど、せっかく他の事務所もピックアップしてくれたので他の税理士さんの話も来週また聞いてみる。</p><h2 id=コードレビュー>コードレビュー</h2><p>まる一日コードレビューをしていた。私もマージリクエストを投げていてレビューしてもらいつつ、メンバーのコードレビューも順番にやっていった。その中で smtp の仕様を把握しておく必要があっていくつかシニアエンジニアの方からもアドバイスをもらって、私もそうだったんだと勉強していた。メールヘッダーのエンコーディング、昔は覚えていたけど、ずっとメールを送るコードを書いてなかったので私も忘れてしまっていた。こういうことをさらっと指摘できるのがシニアエンジニアのすごいところ。</p><ul><li><a href=https://fumiyas.github.io/2014/12/13/sendmail.postfix-advent-calendar.html>sendmail コマンドによるメール発信 - Postfix Advent Calendar 2014 - ダメ出し Blog</a></li></ul><p>go だと標準ライブラリに <a href=https://pkg.go.dev/mime>mime</a> パッケージがある。mime パッケージを使って件名を utf-8 でエンコーディングされた文字列で指定すると次のようになる。q エンコーディングと b エンコーディングの2種類がある。b エンコーディングの方がデータ量が減ってよさそう。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Subject: &#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>mime</span>.<span style=color:#a6e22e>QEncoding</span>.<span style=color:#a6e22e>Encode</span>(<span style=color:#e6db74>&#34;utf-8&#34;</span>, <span style=color:#e6db74>&#34;テスト&#34;</span>))
</span></span><span style=display:flex><span><span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Subject: &#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>mime</span>.<span style=color:#a6e22e>BEncoding</span>.<span style=color:#a6e22e>Encode</span>(<span style=color:#e6db74>&#34;utf-8&#34;</span>, <span style=color:#e6db74>&#34;テスト&#34;</span>))
</span></span></code></pre></div><pre tabindex=0><code>Subject: =?utf-8?q?=E3=83=86=E3=82=B9=E3=83=88?=
Subject: =?UTF-8?b?44OG44K544OI?=
</code></pre><ul><li><a href=https://go.dev/play/p/zQjMMp17bKf>https://go.dev/play/p/zQjMMp17bKf</a></li></ul></div></div><div class=pagination><div class=pagination__buttons><a href=/diary/page/12/ class="button previous"><span class=button__icon>←</span>
<span class=button__text>最近の日記</span></a>
<a href=/diary/page/14/ class="button next"><span class=button__text>過去の日記</span>
<span class=button__icon>→</span></a></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>© 2021 Tetsuya Morimoto</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>