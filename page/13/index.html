<!doctype html><html lang=en><head><meta name=generator content="Hugo 0.101.0"><title>forest nook</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/><link rel=stylesheet href=/diary/assets/style.css><link rel=stylesheet href=/diary/assets/green.css><link rel=stylesheet href=/diary/style.css><link rel=apple-touch-icon href=/diary/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content="t2y"><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="forest nook"><meta property="og:description" content><meta property="og:url" content="/diary/"><meta property="og:site_name" content="forest nook"><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><link href=/diary/index.xml rel=alternate type=application/rss+xml title="forest nook"></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><div class=posts><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0930/>半稼働日</a></h1><div class=post-meta><span class=post-date>2022-09-30</span></div><span class=post-tags>#<a href=/diary/tags/founding/>founding</a>&nbsp;
#<a href=/diary/tags/information-exchange/>information exchange</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#サービス残業>サービス残業</a></li><li><a href=#隔週の雑談>隔週の雑談</a></li></ul></nav></div><div class=post-content><p>0時に寝て2時、3時と起きて5時に起きた。最近は夜に寝ているのか起きているのか、自分で分からなくなってきた。7時過ぎにはオフィスに着いてた。</p><h2 id=サービス残業>サービス残業</h2><p>今日は非稼働日なんだけど、半日ぐらいは開発していた。大掛かりなリファクタリングをするので今日中に主な修正をテスト環境にデプロイしておきたかった。スプリントが水曜日始まりの1週間なので運用に影響がありそうな大掛かりな機能追加やリファクタリングは金曜日中にはテスト環境へデプロイするように私はしている。そうすると、月・火で他のメンバーがテスト環境を触るのでリグレッションがあればバグをみつけやすくなる。さらにお小言を書くと、他の開発メンバーはこういう感覚がまったくない。大きな変更を伴うコミットを火曜日に普通にしようとする。「明日リリースですが、これをマージしてしまって検証できますか？」というツッコミを私が過去に何度もしている。大半は無理だと次スプリントへ持ち越しになる。残業しない開発者はタスクがスプリントをまたぐことになるので見た目以上のロスがある。</p><h2 id=隔週の雑談>隔週の雑談</h2><p>顧問のはらさんと隔週の打ち合わせ。いつも9時から雑談しているけれど、今日はお互いに歯医者があって15時に変更した。直近のお仕事探しの近況から情報共有をした。いまのところ、3社の選考が進んでいて、私の中の優先順位も明確になっていて、あとは実際に契約を締結するまでもっていけるか。ほんの2週間前までお仕事探しの書類審査すら通らない状況だった。最悪のケースとして11月からしばらくお休みすることも想定していた。現時点では3社もあればどこかに決まるだろうという楽観的な展望をもっている。</p><p>ある案件で react から next.js への移行の目的が seo 対策だという話しをしてたら、google のクローラーは spa アプリケーションも扱えるけれど、twitter, facebook のクローラーが全然ダメらしくて sns で記事をシェアするときにプレビューをきれいにみせたいといったときに課題があったりするらしい。spa の後にまた ssr (server-side rendering) やるというのは本当にあほみたいなことをやっていると私からは思えてしまう。</p><p>あと私はもうスクラムの議論には関心がなくなってしまった。昨日の日記にも少し書いた。いまは組織を変えられるかどうかに関心をもっていて、よいプロダクトにはよい開発文化が必要だ。そこで「よい開発文化」とはなにかを体系化しないといけない。そのうちの1つとして書くことをこれまで訴求してきた。その後もずっと考え続けてきて私の中では次の3本柱でいこうと決めた。</p><ul><li>書くこと</li><li>ワークフロー改善</li><li>実践知リーダーシップ</li></ul><p>いまはまだキーワードだけでその意図する具体的な内容は私の頭の中にしかない。この3つを軸に私のスキルと経験を詰め込んだ製品開発をしていく。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0929/>自分で自分を信用しない</a></h1><div class=post-meta><span class=post-date>2022-09-29</span></div><span class=post-tags>#<a href=/diary/tags/scrum/>scrum</a>&nbsp;
#<a href=/diary/tags/event/>event</a>&nbsp;
#<a href=/diary/tags/thought/>thought</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#ふりかえりのフィードバック>ふりかえりのフィードバック</a></li><li><a href=#開発方法論を議論するのに飽きた>開発方法論を議論するのに飽きた</a></li></ul></nav></div><div class=post-content><p>0時に寝て5時に起きた。朝から2時間ほどドラクエタクトしてた。</p><h2 id=ふりかえりのフィードバック>ふりかえりのフィードバック</h2><p>先日 <a href=/diary/posts/2022/0919/#ドキュメントを書き終えた>5日以上かけて非開発者向けのドキュメント</a> を書き終えた。労力をかけてわかりやすいように書いたせいか、評判がよいという噂があり、ふりかえりのときにも先方の社内で共有されていて、他チームでも読まれているといったコメントをいただいた。それ自体は嬉しいことだ。一方で先方の社内に閉じている議論なのでドキュメントを書いた私には一切フィードバックはない。同じチームのメンバーからもほとんどない。</p><p>私はあまり自分自身を信用しない人間で、私が作った成果物はよいものだと考えていない。とくに初期のバージョンはすべてそう。誤り・勘違い・怠惰・抜け・漏れがいくつもあって3世代ぐらいのアップデートをこなさない限り、運用に耐えるものにはならないという考え方をする。書き終えたばかりのドキュメントを褒められても、自分の中ではそれはおかしいと思ってしまう。あんなものがよいはずがない。もっとよくするための取り組みがあるはずで、そのヒントを他者に期待しているところがある。単純に褒められるよりも「どこがわかりやすかった」「どこがわかりにくかった」「ここをもうちょっと詳しく」とか、そういったインタラクティブな議論を他者に求める傾向がある。それは自分自身が欠陥だらけだから。今回はふわっとした手応えで業務を終えることになる。</p><h2 id=開発方法論を議論するのに飽きた>開発方法論を議論するのに飽きた</h2><p><a href=https://distributed-agile-team.connpass.com/event/258562/>エンジニアリングマネージャーのしごと 読んでみたけど、質問ある？（答えられるとは言っていない</a> に参加した。ちゃんとしたイベントじゃなくて、書籍を読んだ感想を discord で気軽に雑談するようなイベントだった。雑談と言っても話していたのは主催者のみで、他のメンバーはチャットにコメントして、それを主催者がみて話題として取り上げるといった進め方だった。悪いイベントではないのだけど、コミュニティの内輪感が強くて初めての人が参加するようなところではないなと思えた。</p><p>この1年、スクラムを実践しながらずっと開発方法論やマネジメント／リーダーシップについて考えてきた。考え抜いた (と言ってもたった1年だけど) 結論として開発方法論そのものはあまり重要ではないと結論づけた。重要なのは、自分たちの開発にとって障害や課題を認識したときに改善していけるか。そんなの当たり前だと思うかもしれない。改善するにあたって組織も含めて変えられるかというところが最も重要だと気付いた。スクラムにおいても、簡単な問題はすぐ解決しようとするのに、複雑で難しい問題はなぜ解決への試みすらやらないのだろう？とずっと不思議に思っていた。それは既存の組織や制度のなにかを変えないといけないとき、それらを改善の対象とみなすか・みなさないかという視点が人によって大きく異なることに気付いた。多くの人はそこまでやろうとしない。それは越権行為かもしれないし、思い付きで組織の決めごとを変えられても困るかもしれない。一方で私は頭がおかしくて組織や制度そのものも変えようとする。まず組織を変えようとするかどうかが最初の分水嶺になる。そして、実際に組織が変われるかという最大の課題もある。開発のためだけに組織を変えてくれと経営者にお願いして「わかった」という経営者は稀かもしれない。組織にも歴史や文化があり、会社には開発以外の様々な業務もある。大規模スクラムが提唱されるようになったのは組織を変えていくアプローチがスクラムには重要になってくるという証左かもしれない。</p><p>組織さえ変えられるのであれば開発はいくらでもよくなる可能性がある。これは小さい組織や若い組織にとってはとくに有利な点と言えるだろう。開発方法論に何を採用するか、初期のチームがうまく開発できないといったことは些事でしかない。自分たちの開発をより良くすることを本当にやろうとしているかどうかが重要だ。そのことに気付いてからゾンビスクラムをみかけたときも、これは組織のこういった課題から派生していると深堀りするようになってきた。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0928/>url エンコーディングと uri の仕様</a></h1><div class=post-meta><span class=post-date>2022-09-28</span></div><span class=post-tags>#<a href=/diary/tags/java/>java</a>&nbsp;
#<a href=/diary/tags/spring-boot/>spring boot</a>&nbsp;
#<a href=/diary/tags/medium/>medium</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#webclient-と-query-string-のエンコーディング>WebClient と query string のエンコーディング</a></li><li><a href=#よいエラーメッセージわるいエラーメッセージ>よいエラーメッセージ、わるいエラーメッセージ</a></li></ul></nav></div><div class=post-content><p>1時に寝ようとして、寝てたか起きてたかわからない時間を過ごして7時に起きた。</p><h2 id=webclient-と-query-string-のエンコーディング>WebClient と query string のエンコーディング</h2><p>以前にも <a href=/diary/posts/2022/0722/#spring-webflux-とプロキシ>WebClient の基本</a> について少し書いた。<code>data={"x": 1, "y": 2}</code> のような json 文字列を query string でリクエストしようとしたときに少しはまったので書いておく。java 標準ライブラリの URLEncoder を使ってエンコードするとスペースが <code>+</code> になる。これは html の仕様として正しいが、uri の仕様としては不正になる。そのため <code>+</code> を <code>%20</code> に置き換える必要がある。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> String <span style=color:#a6e22e>encode</span><span style=color:#f92672>(</span>String data<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> UnsupportedEncodingException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// NOTE: the URI doesn&#39;t allow &#39;+&#39; character
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> URLEncoder<span style=color:#f92672>.</span><span style=color:#a6e22e>encode</span><span style=color:#f92672>(</span>data<span style=color:#f92672>,</span> StandardCharsets<span style=color:#f92672>.</span><span style=color:#a6e22e>UTF_8</span><span style=color:#f92672>).</span><span style=color:#a6e22e>replace</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;+&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;%20&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>このロジックで <code>{"x": 1, "y": 2}</code> を url エンコードすると次の文字列になる。</p><pre tabindex=0><code>%7B%22x%22%3A%201%2C%20%22y%22%3A%202%7D
</code></pre><p>あらかじめ url エンコーディングした文字列を渡すと、今度は WebClient が <code>%</code> を <code>%25</code> にさらにエンコーディングしてしまう。<a href=https://www.baeldung.com/webflux-webclient-parameters#encoding-mode>Spring WebClient Requests with Parameters 6.Encoding Mode</a> によると、次の4つのエンコーディングモードをカスタマイズできる。デフォルトは <em>TEMPLATE_AND_VALUES</em> らしい。</p><ul><li>TEMPLATE_AND_VALUES: Pre-encode the URI template and strictly encode URI variables when expanded</li><li>VALUES_ONLY: Do not encode the URI template, but strictly encode URI variables after expanding them into the template</li><li>URI_COMPONENTS: Encode URI component value after expending URI variables</li><li>NONE: No encoding will be applied</li></ul><p>もとの url エンコード済みの文字列が次のようなものになってしまう。</p><pre tabindex=0><code>%257B%2522x%2522%253A%25...
</code></pre><p>既存の実装をあまり変えたくもなくてやや力技で実装した。局所的な変更だからまぁいっか。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>webClient<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>().</span><span style=color:#a6e22e>uri</span><span style=color:#f92672>(</span>uriBuilder <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  var uriObj <span style=color:#f92672>=</span> uriBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>path</span><span style=color:#f92672>(</span>getControllerBasePath<span style=color:#f92672>()</span> <span style=color:#f92672>+</span> path<span style=color:#f92672>).</span><span style=color:#a6e22e>queryParams</span><span style=color:#f92672>(</span>query<span style=color:#f92672>).</span><span style=color:#a6e22e>build</span><span style=color:#f92672>(</span>pathParams<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>encodedData <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      var uri <span style=color:#f92672>=</span> uriObj<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      var connector <span style=color:#f92672>=</span> uri<span style=color:#f92672>.</span><span style=color:#a6e22e>contains</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;?&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;&amp;&#34;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;?&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      uriObj <span style=color:#f92672>=</span> URI<span style=color:#f92672>.</span><span style=color:#a6e22e>create</span><span style=color:#f92672>(</span>String<span style=color:#f92672>.</span><span style=color:#a6e22e>format</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;%s%sdata=%s&#34;</span><span style=color:#f92672>,</span> uri<span style=color:#f92672>,</span> connector<span style=color:#f92672>,</span> encodedData<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> uriObj<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}).</span><span style=color:#a6e22e>retrieve</span><span style=color:#f92672>()</span>
</span></span></code></pre></div><h2 id=よいエラーメッセージわるいエラーメッセージ>よいエラーメッセージ、わるいエラーメッセージ</h2><p>タイトルに惹かれてちょっと期待外れ。<em>art</em> というと日本人は芸術と高度なものを期待しがちだけど、<em>the art of</em> だと技術の体系といった意味合いもあるのでちょとしたノウハウを解説する技術ブログのようなものでも誤っていない。</p><ul><li><a href=https://medium.com/s/user-friendly/the-art-of-the-error-message-9f878d0bff80>The Art of the Error Message</a></li></ul><p>ユーザー体験をよくするためのエラーメッセージのコツとして次の3つを提案している。</p><ul><li>何が起きたのか、なぜ起きたのかを説明する</li><li>次のステップを提案する</li><li>適切なトーンで書く</li></ul><p>この3つの具体例としてどのようなものかを説明している。私にとってはそう目新しいものではないが、エラーメッセージにトーンという概念はなかったので最近の流行りなのかなと思った。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0927/>そして1年が経った</a></h1><div class=post-meta><span class=post-date>2022-09-27</span></div><span class=post-tags>#<a href=/diary/tags/thought/>thought</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#日記を1年書き続けた>日記を1年書き続けた</a></li></ul></nav></div><div class=post-content><p>2時に寝て7時に起きた。寝付けなくてタイムラインを眺めてた。1日を淡々と開発して淡々と業務を終えた。</p><h2 id=日記を1年書き続けた>日記を1年書き続けた</h2><p>最初に日記を書いたのが 2021-09-26 なのでもう1年経ったことになる。時間というのは過ぎてみればあっという間に感じる。歳を取るごとに人生の生きている時間が長くなって相対的に1年の時間が短くなるという論理的な説明を私は気に入っている。私の記憶では1年も継続して日記を書き続けられたことは過去に1度もない。はてなブログを見返すと、もっとも書いた年でも65日だった。もちろん過去の自分は本気で毎日書こうと思っていなかった。そして、それ以上になんのために書き続けるかという動機もなかった。いま独りでお仕事するようになって「書くこと」の重要性に気付いたことは過去にも書いた。</p><ul><li><a href=https://note.com/t2y1979/n/n84deed5fd934>リモートワークと相談相手</a></li></ul><p>一方で私は平均的な開発者よりも遥かに多くの文章を、日々の業務で書いている。それは課題管理システムに様々なことを記録しているし、チャットでやり取りすることも多いし、1日の半分以上はプログラムを書いている。嗜む程度に sns に投稿したりもする。これだけ書いていて、さらに日記も書くのだから書くスキルが相当に向上している。言い換えれば、毎日日記を書くのが大した労力に感じないぐらいの実務力が上がっているとも言える。日記を書くのは、課題管理システムに日々の積み重ねを書くのとはまた違った様子が伺える。それは1年も書いてみるとその内容から明らかになってくる。人間はわりと自分のことすら分からない。日記にはそのときでしか書けない雑感がある。それはおそらく自分で自分を知る手掛かりになる。</p><p>当初の動機づけは <a href=https://scrapbox.io/kentaro/%E6%97%A5%E8%A8%98>あんちぽさんの日記</a> に影響を受けている。あんちぽさんは20年も日記を書き続けている。どのぐらい続くのかわからないが、5年、10年と続けられるよう、私も書くスキルを磨いていこうと思う。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0926/>postgresql の json データ型</a></h1><div class=post-meta><span class=post-date>2022-09-26</span></div><span class=post-tags>#<a href=/diary/tags/postgresql/>postgresql</a>&nbsp;
#<a href=/diary/tags/java/>java</a>&nbsp;
#<a href=/diary/tags/cli/>cli</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#ロガー向けのログ保存-api-の開発>ロガー向けのログ保存 API の開発</a></li></ul></nav></div><div class=post-content><p>1時に寝て6時半に起きた。連休中に夜更ししてたから生活が乱れた。</p><h2 id=ロガー向けのログ保存-api-の開発>ロガー向けのログ保存 API の開発</h2><p>先週の休暇前にやっていた作業の開発に着手。一通り web api のエンドポイントの実装は終えてテストをあらかた書いたところ。いまのプロジェクトとしても、過去の私の経験としてもやったことのない新しい挑戦の1つとして postgresql の <a href=https://www.postgresql.jp/document/13/html/datatype-json.html>JSONデータ型</a> を使う。具体的には json 型と jsonb 型の2つがある。前者はテキストで保持する型で、後者は内部的にバイナリに変換されてインデックスも使える。バイナリに変換してインデックスを作る分、insert 時にテキストで保存するよりは少し余分なオーバーヘッドを要する。json のデータを参照用途で使うのか、検索するのかでこれらの型を使い分ければいいのかな。</p><p>実際の sql で json データの条件指定は次のようになる。<code>@></code> というみたこともない気持ち悪い演算子を使う。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>select</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> mytable <span style=color:#66d9ef>where</span> <span style=color:#66d9ef>data</span>  <span style=color:#f92672>@&gt;</span> <span style=color:#e6db74>&#39;{&#34;x&#34;: 1, &#34;y&#34;: 2}&#39;</span>;
</span></span></code></pre></div><p>java の jdbc で扱うには <em>PGobject</em> という型に変換して扱う必要がある。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> PGobject <span style=color:#a6e22e>convertData</span><span style=color:#f92672>(</span>String value<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> SQLException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    var data <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> PGobject<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    data<span style=color:#f92672>.</span><span style=color:#a6e22e>setType</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;jsonb&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    data<span style=color:#f92672>.</span><span style=color:#a6e22e>setValue</span><span style=color:#f92672>(</span>value<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> data<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>余談だけど、curl で json 文字列を query string としてリクエストするには url encode しないといけない。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -s --get --data-urlencode <span style=color:#e6db74>&#39;data={&#34;x&#34;: 1, &#34;y&#34;: 2}&#39;</span> http://localhost/path | jq .
</span></span></code></pre></div></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0925/>quarkus のアプリ開発が楽しくなってきた</a></h1><div class=post-meta><span class=post-date>2022-09-25</span></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/java/>java</a>&nbsp;
#<a href=/diary/tags/quarkus/>quarkus</a>&nbsp;
#<a href=/diary/tags/backlog/>backlog</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#ストレッチ>ストレッチ</a></li><li><a href=#quarkus-アプリケーションと認可フロー>quarkus アプリケーションと認可フロー</a></li></ul></nav></div><div class=post-content><p>4時に寝て8時に起きた。昨日は久しぶりに夜更しして quarkus の調べものをしてた。新しいものを学ぶのはおもしろい。</p><h2 id=ストレッチ>ストレッチ</h2><p>今週末は本当は実家に帰る予定だったのが、台風による雨で田んぼのコンディションがよくないので断念した。日曜日の夜、田んぼ仕事を終えて筋肉痛のところにストレッチしてもらう予定は変わってしまった。今日の開脚幅は開始前155cmで、ストレッチ後160cmだった。いつもは朝測っているのが夜になるので数値はよくなかった。とはいえ、あまり規則正しく寝てないわりには体調がよい。気候が涼しいせいかな。トレーナーさんに来週はもう10月ですよと言われて9月は過ぎさるのが早いと改めて思った。</p><h2 id=quarkus-アプリケーションと認可フロー>quarkus アプリケーションと認可フロー</h2><p>昨日の続き。お昼前ぐらいからずっと quarkus のアプリケーション開発をしていた。なんやらかんやらで3日間ずっと bolt や quarkus のソースやドキュメントを読んでいた。徐々に理解度が増えてきて、できることも増えてきて楽しくなってきた。web 系だと di に <a href=https://github.com/google/guice>google/guice</a> を使うものも多いけど、エンタープライズ系だと <a href=https://quarkus.io/guides/cdi>cdi</a> なのかなぁとか思ってた。わからんけど。以前にも cdi のドキュメントを読んで関心があった。cdi は本当によく出来ていると思う。一方で難し過ぎて、そこまでコンテキストを厳密に管理する必要があるアプリケーションもそうないのかもなぁとは思ってた。今日 quarkus でアプリケーション開発していてドキュメントを読みながらやってみたところが次になる。</p><ul><li><a href=https://quarkus.io/guides/cdi-reference>CONTEXTS AND DEPENDENCY INJECTION</a></li><li><a href=https://quarkus.io/guides/rest-client>USING THE REST CLIENT</a></li><li><a href=https://quarkus.io/guides/rest-json>WRITING JSON REST SERVICES</a></li></ul><p>だいたい雰囲気は理解できてきたので backlog の <a href=https://developer.nulab.com/docs/backlog/auth/>Authentication & Authorization</a> に書いてある oauth2 の <em>Authorization Code Grant</em> のフローを実装していた。access token の取得と refresh はできたのでこれを db に保存するのを明日以降にやってみる。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0924/>quarkus のビルド環境に手間取った</a></h1><div class=post-meta><span class=post-date>2022-09-24</span></div><span class=post-tags>#<a href=/diary/tags/java/>java</a>&nbsp;
#<a href=/diary/tags/quarkus/>quarkus</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#bolt-for-java-on-quarkus>bolt for java on quarkus</a></li></ul></nav></div><div class=post-content><p>1時に寝て7時に起きた。休みだとやっぱりだらだらしてしまうな。</p><h2 id=bolt-for-java-on-quarkus>bolt for java on quarkus</h2><p>昨日の続き。スクラッチから quarkus のアプリケーションの設定を gradle で行う。quarkus の上で slack apps としてのコマンドとイベントの振る舞いだけ確認した。</p><ul><li><a href=https://github.com/t2y/bolt-java-sample>https://github.com/t2y/bolt-java-sample</a></li></ul><p>私は新規に開発する java アプリケーションは <a href=https://gradle.org/>gradle</a> を使うようにしている。これは java のよくないところだろうけれど、言語コミュニティが提供するパッケージマネージャやビルドツールがないから複数のツールが乱立している。maven から gradle に緩やかに移行していくのかな？と私は考えていたけれど、昔からあるライブラリのビルドツールを変更するのは労力に見合うメリットがないのか、maven も依然としてずっと使われ続けていくのかもしれない。maven と gradle の両対応という保守コストは、この先しばらく java コミュニティが抱えていく保守コストと言えるのかもしれない。quarkus はさらに独自の <a href=https://quarkus.io/guides/cli-tooling>Quarkus CLI</a> というビルドツールを提供している。そのため、ビルドのための設定だけで quarkus cli, maven, gradle の3つの方法があり、ドキュメントにもそれぞれの設定方法が書いてある。これを保守する方も使う方もややこしくて大変だなぁという印象を受けた。</p><p><a href=https://quarkus.io/guides/gradle-tooling>BUILDING QUARKUS APPS WITH GRADLE</a> をみながら次の maven cli で作った gradle プロジェクトのテンプレートをみながら build.gradle の設定をした。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ mvn io.quarkus.platform:quarkus-maven-plugin:2.12.3.Final:create <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -DprojectGroupId<span style=color:#f92672>=</span>my-groupId <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -DprojectArtifactId<span style=color:#f92672>=</span>my-artifactId <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -Dextensions<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;resteasy-reactive,resteasy-reactive-jackson&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -DbuildTool<span style=color:#f92672>=</span>gradle
</span></span></code></pre></div><p>あと私は設定ファイルを yaml で管理したいので次の拡張も追加した。gradle タスクでも定義されていて次のように実行する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./gradlew addExtension --extensions<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;quarkus-config-yaml&#34;</span>
</span></span></code></pre></div><p>この cli がやっていることは基本的に dependencies に次の1行を追加するだけ。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=display:flex><span>dependencies <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  implementation <span style=color:#e6db74>&#39;io.quarkus:quarkus-config-yaml&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>設定ファイルを yaml から読み込めるようになると初期設定は次のようになる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ vi app/src/main/resources/application.yaml 
</span></span><span style=display:flex><span>quarkus:
</span></span><span style=display:flex><span>  http:
</span></span><span style=display:flex><span>    port: <span style=color:#ae81ff>3000</span>
</span></span><span style=display:flex><span>  log:
</span></span><span style=display:flex><span>    level: INFO
</span></span><span style=display:flex><span>    category:
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;com.slack.api&#34;</span>:
</span></span><span style=display:flex><span>        level: DEBUG
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;tutorial.bolt.sample&#34;</span>:
</span></span><span style=display:flex><span>        level: DEBUG
</span></span><span style=display:flex><span>  package:
</span></span><span style=display:flex><span>    type: uber-jar
</span></span></code></pre></div><p>開発サーバーは次のようにして起動する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ./gradlew quarkusDev
</span></span></code></pre></div><blockquote><p>quarkusDev enables hot deployment with background compilation, which means that when you modify your Java files or your resource files and refresh your browser these changes will automatically take effect. This works too for resource files like the configuration property file. The act of refreshing the browser triggers a scan of the workspace, and if any changes are detected the Java files are compiled, and the application is redeployed, then your request is serviced by the redeployed application. If there are any issues with compilation or deployment an error page will let you know.</p><p><a href=https://quarkus.io/guides/gradle-tooling#dev-mode>https://quarkus.io/guides/gradle-tooling#dev-mode</a></p></blockquote><p>hot deployment 機能のおかげでソースや設定ファイルを変更すると自動的に反映される。他の言語なら普通の機能かもしれないけど、java でもそういう仕組みが普通になったんだなと思って感心した。変化に付いていけない開発者のような気持ちになった。</p></div></div><div class=pagination><div class=pagination__buttons><span class="button previous"><a href=/diary/page/12/><span class=button__icon>←</span>
<span class=button__text>最近の日記</span></a></span>
<span class="button next"><a href=/diary/page/14/><span class=button__text>過去の日記</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>© 2021 Tetsuya Morimoto</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=/diary/assets/main.js></script>
<script src=/diary/assets/prism.js></script></div></body></html>