<!doctype html><html lang=en><head><meta name=generator content="Hugo 0.109.0"><title>forest nook</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content="t2y"><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="forest nook"><meta property="og:description" content><meta property="og:url" content="/diary/"><meta property="og:site_name" content="forest nook"><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/index.xml rel=alternate type=application/rss+xml title="forest nook"></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><div class=posts><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2021/1210/>ワーケーションの思いつき</a></h1><div class=post-meta><span class=post-date>2021-12-10 (Fri.)</span></div><span class=post-tags>#<a href=/diary/tags/morning-activity/>morning activity</a>&nbsp;
#<a href=/diary/tags/book/>book</a>&nbsp;
#<a href=/diary/tags/scrum/>scrum</a>&nbsp;
#<a href=/diary/tags/event/>event</a>&nbsp;
#<a href=/diary/tags/workcation/>workcation</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#朝活-アジャイル開発とスクラム-第2版>朝活: アジャイル開発とスクラム 第2版</a></li><li><a href=#隔週の雑談>隔週の雑談</a></li><li><a href=#忘年会>忘年会</a></li></ul></nav></div><div class=post-content><p>0時に寝て6時に起きた。</p><h2 id=朝活-アジャイル開発とスクラム-第2版>朝活: アジャイル開発とスクラム 第2版</h2><p><a href="https://www.youtube.com/watch?v=MbpX1LF1fto">金朝ツメトギ 2021-12-10 AM 6 金曜朝6時開催のもくもく会</a> に参加した。今回はてらださんも来られていた。第9章を読んだ。KDDI さんの事例紹介で2013年から取り組みしているらしい。<a href=/diary/posts/2021/1029/#フラクタルスプリント>フラクタルスプリント</a> を実際の業務で実践している稀な事例としておもしろかった。1週間のスプリントの中に1日のスプリントが4回あるといったフラクタル構造のスプリント。また金曜日は「仕事をしない日」としてレトロスペクティブと OST (オープンスペーステクノロジー、自由な発表と議論の時間) に割当てている。20%ルールに近いものと言えるかもしれないが、自己研鑽のための時間をスプリントの中に組み込むという、組織の理解があってこそできる取り組みを実践していてすごいなと感心した。</p><figure><img src=/diary/img/2021/1210-weekly-sprint.png></figure><h2 id=隔週の雑談>隔週の雑談</h2><p>顧問のはらさんと隔週の打ち合わせ。スクラムの話題として <a href=https://chatwork.connpass.com/event/231183/>だいくしーのスクラム Bar #1</a> や <a href=https://smn.connpass.com/event/226002/>Scrum Masters Night! Online 〜第10夜〜</a> に参加してやり取りした内容や考察したことなどをいろいろ話してた。そのうちの話題の1つに、スクラムマスターの役割とは何だろうかがある。スクラムマスターはプロダクトをよくすることに責任をもち、メンバーが働きやすいように支えるような役割である。ここまでは共通認識として、その範囲がどこまでかは人によって意見が異なるように思えた。あくまでプロダクトやチームの範囲内で行動するスクラムマスターと、スクラムを組織全体に広めたり、人事・評価制度や経営にも参加していくスクラムマスターがある。スクラムマスターは社外の人間でもできるという考え方があるが、必然的に後者の役割も担うなら社内の人間に限定される。後者の役割は越権行為ではないか、いやいや、チームのために働いたメンバーの評価が下がってしまえば現場でよりよいプロダクト開発はできないから大事ではないかという意見も出た。便宜上、前者を (普通の) スクラムマスター、後者を「意識の高い」スクラムマスターと呼ぶ。私の考えでは、意識の高いスクラムマスターの言わんとしていることはわかるが、それをやりたいなら部長や役員などになってから職責とともに改善すべきであり、スクラムマスターという組織におけるラインではない人が経営に口出ししたりすることによる、組織の歪みはまた別の問題を引き起こすのではないかとも思えた。私も経営をやっていて経営側の視点でみるとやはりおかしい。</p><p>その後にワーケーションについて相談した。城崎温泉にある <a href=https://kinosaki-kinoie.com/>きのいえ</a> でワーケーションをやってみようかと考えている。参加のお誘いややり方についていくつか相談しながら前向きに検討しようということになった。</p><h2 id=忘年会>忘年会</h2><p><a href=https://kobe-sannomiya-dev.connpass.com/event/231602/>【初参加大歓迎】三宮.dev＆bizpy 合同忘年会</a> に参加してきた。忘年会の前に運営に入ってもらった、わたなべさんと軽く bizpy の運営について話してきた。1月はわたなべさんに機械学習の勉強会をやってもらう。私は昨年も三宮.devの忘年会に出てた。昨年は3人だったのが今年は4人になった。名物の大きなポークカツレツ。4人とも勉強会の常連みたいな人たちなのでお酒を飲みながらわいわいやって、コロナ禍になる前のコミュニティの勉強会の飲み会を思い出したりしてた。ワーケーションの話をしたら2人は興味を示してくれて、メンバーが4人集まったので開発合宿の企画をしてみることに決めた。</p><figure><img src=/diary/img/2021/1210-katsu.jpg></figure></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2021/1209/>2年目の創立記念日</a></h1><div class=post-meta><span class=post-date>2021-12-09 (Thu.)</span></div><span class=post-tags>#<a href=/diary/tags/dapr/>dapr</a>&nbsp;
#<a href=/diary/tags/founding/>founding</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#dapr-の分散トレーシングと-w3c-trace-context>dapr の分散トレーシングと W3C trace context</a></li><li><a href=#創立記念日>創立記念日</a></li></ul></nav></div><div class=post-content><p>0時半に寝て6時半に起きた。久しぶりに22時までお仕事やって区切りもよかったからそれからお惣菜を買って23時頃から晩ご飯を食べてた。生活が乱れるなぁ。</p><h2 id=dapr-の分散トレーシングと-w3c-trace-context>dapr の分散トレーシングと W3C trace context</h2><p>お仕事で dapr の分散トレーシングを検証してた。知らない人は <a href=https://cero-t.hatenadiary.jp/entry/2021/12/08/071742>Dapr Advent Calendar 8日目 - DaprとZipkinで分散トレーシング</a> のチュートリアルをお勧めする。dapr は <a href=https://www.w3.org/TR/trace-context/>W3C Trace Context</a> を使って分散トレーシングを扱う。rest api では、具体的には <code>traceparent</code> と <code>tracestore</code> という http ヘッダーにトレース用途の情報を付けて転送する。すごいところは pubsub のメッセージングを経由してもそれらの情報を転送できる。pubsub 間でこれらの情報は <a href=https://github.com/cloudevents/spec>CloudEvents</a> という標準化されたデータのフォーマットでやり取りされる。実際には CloudEvents の中に <code>traceparent</code> と <code>tracestore</code> の値を含めて通信するけれど、外部からみたら http ヘッダーを転送できているようにみえる。しかし、http ヘッダーの任意の値を転送したい場合、それができない。<code>tracestore</code> はトレースのためのベンダー独自情報を付与できるとあったので、ここに任意の値をセットして送ってみたけど、http ヘッダーの付け替えは行われなかった。あとで dapr のソースを読んだら publish するときはそのまま送っているけど、subscribe するときに <code>tracestore</code> の仕様を満たしているか検証しながらパースしていて、任意の値を送っても仕様に沿っていなければ捨てられてしまうことがわかった。dapr の issue でも要望として登録されてた。誰もやってないならコントリビュートするチャンスかもしれない。</p><ul><li><a href=https://github.com/dapr/dapr/issues/3642>Propagate arbitrary/configurable http headers from publisher to subscribers #3642</a></li></ul><h2 id=創立記念日>創立記念日</h2><p>今日が会社の創立記念日。無事に2周年を迎えた。創立記念日をお休みにするしないを考えたのだけど、いま休日も普通に働いている状況で、且つ役員は勤怠管理をする必要はないので平日になんの意味もなく休むメリットが何もないということに行き着いた。創立記念日だから休むのではなく、いつでも必要なときに休めばいい。もっと言うと、休む理由がなければ働くという逆転現象が生じていて、休む理由は私用か疲労ぐらいしかなくて、基本的に疲れてない限りはずっと働くみたいな理屈になってしまっている。社員が増えて会社に余裕が出てから創立記念日は休みみたいな制度を作ればいい。それまではたぶん来年もそれ以降も普通に働いていると思う。</p><p>1年目は訳分からず働いていたから経営的なことは全くわからなかったけど、2年目は経営上の諸問題が出てきて、経営的な意思決定や考察も増えてきて、行政手続きも熟れて、会社の実績も増えていっていて、会社を育てるという意識もかなり出てきた。率直に言えば、いまの経営状態は可もなく不可もなくといったものなので何もアピールすることはない。しかし、経営したことない人間が経営というキャリアを積み重ねていることには大きな意義があって、自身のキャリアアップには確かな手応えも感じつつある。これからもがんばっていこう。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2021/1208/>整理・整頓・清掃・清潔・躾</a></h1><div class=post-meta><span class=post-date>2021-12-08 (Wed.)</span></div><span class=post-tags>#<a href=/diary/tags/scrum/>scrum</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#トヨタの5s>トヨタの5S</a></li></ul></nav></div><div class=post-content><p>0時に寝て5時に起きた。今日はがんばって起きた！久しぶりに7時半から始業してた。</p><h2 id=トヨタの5s>トヨタの5S</h2><p>スクラムイベントのふりかえりをしていて <a href=https://circu.co.jp/pro-sharing/mag/article/2964/>トヨタの5S</a> の話題が出た。聞いたことがあるようないような、スクラムを勉強しているいま見返すとじわじわ聞いてくる。玄人ぶって「そうそう、こういうのが大事なんだよ」とか言いたくなりそうな雰囲気がある。普通にやっていたら当たり前のことなのに、忙しかったり複雑な問題に対応してたりすると、普通の状態を維持できなくなって混沌がもたらされる気がする。そういう状況のときに初心に戻るにはこういった原則や標榜を使って啓蒙することに意義があるんだと、いまは思うようになってきた。これ自体をよいとかわるいとか言うのは適切ではなくて、うまくいっていない状態からより戻すときに活用するといった考え方の方が正しいのかもしれない。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2021/1207/>クロスデフォルト</a></h1><div class=post-meta><span class=post-date>2021-12-07 (Tue.)</span></div><span class=post-tags>#<a href=/diary/tags/economy/>economy</a>&nbsp;
#<a href=/diary/tags/java/>java</a>&nbsp;
#<a href=/diary/tags/logging/>logging</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#恒大集団のデフォルト>恒大集団のデフォルト</a></li><li><a href=#アプリケーションログの調査>アプリケーションログの調査</a></li></ul></nav></div><div class=post-content><p>0時に寝て6時半に起きた。5時台には起きているんだけど、起き上がるところまではなかなかいけない。</p><h2 id=恒大集団のデフォルト>恒大集団のデフォルト</h2><p>11月から利払の期日の日はチェックしていて、支払うときは2-3日前には支払いを完了したというニュースが出ていたように思う。今日の支払いは前日に支払いしたというニュースが出ないからダメなんだろうなと様子をみていた。</p><ul><li><a href=https://jp.reuters.com/article/evergrande-idJPKBN2IM0F0>中国恒大、猶予期間終了までにオフショア債利払いできず＝関係筋</a></li></ul><p>1つの債務がデフォルトした場合、残りの債務も一括返済しないといけないことを <a href=https://www.ifinance.ne.jp/glossary/loan/loa259.html>クロスデフォルト</a> と呼ぶらしい。契約書にクロスデフォルト条項として書いてあるらしい。記事によると、クロスデフォルトによって約190億ドル (約2.1兆円) のオフショア債の返済を一括でしないといけないらしい。リーマンショックのようなことは起きないという見通しだけど、うちみたいな零細企業は世の中の影響を諸に受けるのでお仕事に影響がでなければいいなぁといったところ。</p><h2 id=アプリケーションログの調査>アプリケーションログの調査</h2><p>昨日の続き。ecs-logging-java で JSON Lines でログを制御するところで spring-boot の設定で tomcat のアクセスログの設定ができる。tomcat のアクセスログを log4j のレイアウトの仕組みを使って ecs-logging-java が提供する EcsLayout に変更できないかを3時間ほど調査して、どうもできないようだというのを教えてもらった。tomcat は apache のログを出力するという目的で実装されているから log4j の柔軟なログに対応していないという理屈。</p><p>じゃあ、どうやって apache のアクセスログを JSON Lines にするかというと、PatternLayout のパターンに json のフォーマットを直書きしてしまうというやり方がある。なんかプログラミングでスマートに解決したいところだけど、その仕組みがないなら仕方ないかって感じでこれでやろうと思う。</p><ul><li><a href=https://ogugu.hateblo.jp/entry/2018/08/03/153930>apacheのaccess_logをjson化しtd-agentで集約サーバへ収集する</a></li></ul></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2021/1206/>アプリケーションログの調査</a></h1><div class=post-meta><span class=post-date>2021-12-06 (Mon.)</span></div><span class=post-tags>#<a href=/diary/tags/java/>java</a>&nbsp;
#<a href=/diary/tags/logging/>logging</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#アプリケーションログの調査>アプリケーションログの調査</a></li></ul></nav></div><div class=post-content><p>1時に寝て7時に起きた。</p><h2 id=アプリケーションログの調査>アプリケーションログの調査</h2><p>お仕事でログの整理をやろうとしていて、そのためのライブラリとして ecs-logging-java を調べてた。</p><ul><li><a href=https://www.elastic.co/guide/en/ecs-logging/java/current/setup.html>ECS Logging Java Reference 1.x » Get started</a></li><li><a href=https://speakerdeck.com/shibadog/ecs-logging-javatukatutemita>ecs-logging-javaつかってみた</a></li></ul><p>一番のモチベーションは <a href=https://jsonlines.org/>JSON Lines</a> でログを管理したいというところ。この手の実装や読み込んでログ分析したりとかはあちこちでやってきたので親近感はある。既存のログからの移行も含めていろいろ設計していかないといけない。私の感覚だとアプリケーションの開発初期にログの設計や出力周りを作り込むものだけど、そうじゃない文化の開発もあるんだなという印象。あとからログ設計するとか、移行や既存のコードに手を入れたり、開発初期に作り込むより手間暇かかる気がするんだけど、そんな時間もなく開発してたってことなのかなぁ。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2021/1205/>頭文字Dを読了</a></h1><div class=post-meta><span class=post-date>2021-12-05 (Sun.)</span></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/commic/>commic</a>&nbsp;
#<a href=/diary/tags/tax/>tax</a>&nbsp;
#<a href=/diary/tags/dapr/>dapr</a>&nbsp;
#<a href=/diary/tags/kubernetes/>kubernetes</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#頭文字d>頭文字D</a></li><li><a href=#ふるさと納税>ふるさと納税</a></li><li><a href=#dapr-の-api-トークンを使った認証>dapr の api トークンを使った認証</a></li></ul></nav></div><div class=post-content><p>0時に寝て7時に起きてだらだらやってて午前中は <a href=https://ja.wikipedia.org/wiki/%E9%A0%AD%E6%96%87%E5%AD%97D>頭文字D</a> のアニメをみてた。漫画 (アニメも？) はすでに完結しているのでいつか読もうと思いつつ最後まで読んでいない。ゴッドフットやゴッドアームが出てくるぐらいまでは読んだ気がする。その後どうなったのかを知らない。イニシャルDをみていると、ストーリーも絵も演出もまったく派手さはなくて普通なんだけど、なぜかおもしろくて続きをみてしまうという人間の娯楽の本質をついている気がしてくる。なんでなんだろうなぁ。</p><h2 id=頭文字d>頭文字D</h2><p>たまたま思い出したので夜に漫画喫茶行って頭文字Dを最後まで読んできた。全48巻で、31巻ぐらいから読み始めて3-4時間ぐらいで読み終えた。漫画なので仕方ないけど、対戦相手がどんどん強くなっていって勝ち方が玄人好みというのか、単純に抜いた・抜かれたの話しではなく、タイヤマネージメントがどうこうとか、恐怖に対する心理がどうこうとか、ドライバーと車のセッティングも含めた駆け引きが強くなっていって、どちらが速いかというよりは戦略通りの展開にもっていって最後はそれがうまくはまるみたいな、これまでもずっとそうだったんだけど、ここからはよりトップレベルのほんの僅かな差が勝敗を分けるといった描き方になっていったように思う。それはそれで現実に近い気はするけど、漫画的には派手な演出にならないので玄人好みなストーリーになっていった気がする。但し、そこまでやってきて最後の対戦相手だけは、個人的には納得感がなくて、ここまで緻密に作り上げてきた理論や個々のドライバーの修練の積み重ねが圧倒的天才の前にひれ伏すみたいな切り口が急展開していて、頭の切り替えができなかった感じがした。とはいえ、最後まで読み終えられてよかったし、作品としてはすごくおもしろかった。作者はモータースポーツが本当に好きなんだろうなというのが伝わってくる漫画だと思う。</p><h2 id=ふるさと納税>ふるさと納税</h2><p>あまり欲しいものもないし、ふるさと納税の行政手続きも一通り理解したから今年はやらなくてもいいかとも思っていた。しかし、<a href=https://www.satofull.jp/static/campaign/202112_pcp.php>paypayボーナスキャンペーン</a> をみてやってみるかという気になった。paypay はいろんなものと連携していて見かけるたびにすごいなと思う。お得だからと必要もないものを買うことはないけど、ふるさと納税はやらなかったとしても、どのみち納税は必要なものなので還元があるということは節税につながるのかな？理屈はよくわからないけど、言いたいことは paypay はすごいという話でした。</p><h2 id=dapr-の-api-トークンを使った認証>dapr の api トークンを使った認証</h2><p><a href=https://docs.dapr.io/operations/security/api-token/>Enable API token authentication in Dapr</a> を一通り読んだ。内容はとくに難しくなく、こんな風に dapr の manifest を書けば <a href=https://jwt.io/>JWT</a> トークンを設定できますということを書いてある。私はずっとサーバーサイドばっかりやってきたからフロントエンドで使われる技術や仕組みに弱い。JWT トークンもその1つで、自分でちゃんと実装したことがないからちゃんとよく分かってない。これが OAuth2 なら provider を実装したこともあるからその仕組みも意図も理解できる。一度どこかで自分で JWT も実装してみないといけないのだろうな。</p><p>少し前にお仕事で kubernetes の secret の移行作業をやった。既存の secret にキーバリューを追加するときは patch を使う。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl patch secret mydata -p<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;{&#34;stringData&#34;:{&#34;mykey&#34;: &#34;myvalue&#34;}}&#39;</span>
</span></span></code></pre></div><p>secret の内容を確認するときも2つのやり方がある。キーだけを確認するならこれでよい。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl describe secrets mydata
</span></span></code></pre></div><p>キーに対応する値もデコードして確認するならこうする。但し、閲覧注意。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl get secret mydata -o json | jq <span style=color:#e6db74>&#39;.data | map_values(@base64d)&#39;</span>
</span></span></code></pre></div></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2021/1204/>github actions のビルドキャッシュ運用</a></h1><div class=post-meta><span class=post-date>2021-12-04 (Sat.)</span></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/github/>github</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#ストレッチ>ストレッチ</a></li><li><a href=#actionscache-の-exclude-設定>actions/cache の exclude 設定</a></li></ul></nav></div><div class=post-content><p>23時に寝て5時に起きてちょっと作業してまた寝て7時に起きた。お仕事も働き始めて1ヶ月が経過して、だいぶチームの雰囲気や業務に慣れてきたところ。稼働日の18日間で作成した pr が16件。入ったときに割当てられた3つの課題から10数件の issue を派生させてちょうどすべて fix した。来週から新しい課題に取り組む。</p><h2 id=ストレッチ>ストレッチ</h2><p>今週もお仕事に注力してたらストレッチは2日/週とあまりできなかった。ウォーキングもやってない。今日の開脚幅は開始前165cmで、ストレッチ後167cmだった。さぼってたせいか、数値が悪くなってしまった。右股関節の関節の可動域がよくないところは少しずつまがるようになってきてよくなってきている実感がある。一方で右太ももの後ろの筋が張りが大きいことに気付いた。トレーナーさんに聞くと、この筋は椅子に座っていると張りやすいという話しなので、最近はお仕事に注力して椅子に座っている時間が以前より伸びているせいだと思う。あと会議に出席している時間も増えているため、その時間は椅子に座っておかないといけないという制約も増えている。</p><h2 id=actionscache-の-exclude-設定>actions/cache の exclude 設定</h2><p>github actions でビルドキャッシュを扱う方法は <a href=https://docs.github.com/ja/actions/advanced-guides/caching-dependencies-to-speed-up-workflows>Caching dependencies to speed up workflows</a> に書いてあって、それは <a href=https://github.com/actions/cache>actions/cache</a> という github actions がキャッシュ機能を提供している。ここでドキュメントにはキャッシュの除外設定については何も書かれていないが、リポジトリに含まれる <code>examples.md</code> には次のような説明と設定例が出てくる。</p><blockquote><p>Depending on the environment, huge packages might be pre-installed in the global cache folder. With actions/cache@v2 you can now exclude unwanted packages with <a href=https://github.com/actions/toolkit/tree/main/packages/glob#exclude-patterns>exclude pattern</a></p><p><a href=https://github.com/actions/cache/blob/main/examples.md#c---nuget>https://github.com/actions/cache/blob/main/examples.md#c---nuget</a></p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span>- <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>actions/cache@v2</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>with</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>path</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      ~/.nuget/packages
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      !~/.nuget/packages/unwanted</span>      
</span></span><span style=display:flex><span>    <span style=color:#f92672>key</span>: <span style=color:#ae81ff>${{ runner.os }}-nuget-${{ hashFiles(&#39;**/packages.lock.json&#39;) }}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restore-keys</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      </span>      <span style=color:#ae81ff>${{ runner.os }}-nuget-</span>
</span></span></code></pre></div><p><code>!</code> を入れるだけかと思って検証してみたらどうも意図した振る舞いにならない。実はこの設定はバグっていて実際には動かない。なぜ動かないかを追いかけてないけど、issue にも登録されている。<code>path</code> の記述方法によって動いたり動かなかったりするというのが現状の振る舞いになるらしい。</p><ul><li><a href=https://github.com/actions/cache/issues/494>Excluded sub directory not working #494</a></li><li><a href=https://github.com/actions/toolkit/issues/713>Cache - excluding files or folders with ! not working #713</a></li></ul><p>ちなみに正しい動く設定は次になる。ワイルドカードを使わないといけないらしい。ドキュメントに除外設定について書いていないのはバグってて中途半端な振る舞いをしているからかもしれない。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span>- <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>actions/cache@v2</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>with</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>path</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      ~/.nuget/packages/*
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      !~/.nuget/packages/unwanted</span>      
</span></span><span style=display:flex><span>    <span style=color:#f92672>key</span>: <span style=color:#ae81ff>${{ runner.os }}-nuget-${{ hashFiles(&#39;**/packages.lock.json&#39;) }}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restore-keys</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      </span>      <span style=color:#ae81ff>${{ runner.os }}-nuget-</span>
</span></span></code></pre></div><p>あとビルドキャッシュのキーにパッケージ管理のファイルのハッシュ値を取るようになっている。この背景も github actions がキャッシュをクリアする機能を提供していないからであろう。<a href=https://github.com/actions/cache/issues/2>Clear cache #2</a> でも議論されているが、キャッシュをクリアできないため、同じキーにパッケージが溜まり続けるような運用は開発者にとっても github 社にとってもリソースを浪費するので好ましくない。いまは7日以上アクセスされていないキャッシュを削除する運用になっているため、なるべくフレッシュなキャッシュが生成されるような運用となるよう、ハッシュ値を取得するようなキーの運用が行われているように推測される。</p></div></div><div class=pagination><div class=pagination__buttons><a href=/diary/page/105/ class="button previous"><span class=button__icon>←</span>
<span class=button__text>最近の日記</span></a>
<a href=/diary/page/107/ class="button next"><span class=button__text>過去の日記</span>
<span class=button__icon>→</span></a></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>© 2021 Tetsuya Morimoto</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>