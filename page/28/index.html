<!doctype html><html lang=en><head><meta name=generator content="Hugo 0.109.0"><title>forest nook</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content="t2y"><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="forest nook"><meta property="og:description" content><meta property="og:url" content="/diary/"><meta property="og:site_name" content="forest nook"><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/index.xml rel=alternate type=application/rss+xml title="forest nook"></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><div class=posts><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0423/>ゆとりのある休日</a></h1><div class=post-meta><span class=post-date>2023-04-23 (Sun.)</span></div><span class=post-tags>#<a href=/diary/tags/book/>book</a>&nbsp;
#<a href=/diary/tags/issue-management/>issue management</a>&nbsp;
#<a href=/diary/tags/event/>event</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#いまがわかる地政学>いまがわかる地政学</a></li><li><a href=#もくもく会>もくもく会</a></li></ul></nav></div><div class=post-content><p>0時に寝て6時に起きた。午前中は掃除したり買いものへ出掛けたりムック本を買って読んだりして午後からもくもく会に参加してきた。昨日から休日って心地よくて素晴らしい時間だということに改めて気付いた。</p><h2 id=いまがわかる地政学>いまがわかる地政学</h2><p>やぎさんからおすすめされて <a href=https://one-publishing.co.jp/books/9784651203294/>オールカラー図解 いまがわかる地政学</a> を読んだ。ちょうど余裕もあったので読んでみることにした。私も過去に地政学の雑誌を気分で買って読んだことがあった。教えてもらってなければいまは買ってなかったと思うが、関心のある分野ではある。</p><p>見開きの2ページで左ページを地図で図解しながら右ページにその説明が書いてある。読み始めてすぐにドキュメントランドスケープを構築できるので読みやすい。地政学なので地図で説明するのがわかりやすいのと、特定の地域の限られた国で、且つ話題を限定して説明するから簡潔でわかりやすい。過去にはアメリカ／イギリス系統とドイツ系統の2つの地政学があり、地政学はナチスドイツの御用学問となり、ドイツが敗戦したことによりドイツ系統の地政学は封印指定された。日本で学ばれていた地政学もドイツ系統だったようで、戦後 GHQ により封印指定されていまに至るらしい。</p><p>地政学の解説を読んでいて、なにかを分類して、そこから得られる知見に方向性や解釈を与えて、さらに歴史が積み重なると立派な研究や学問になるという印象を受けた。観察して分類して仮説を立てて記録を取り続けるとそれはもう科学である。課題管理につながるヒントもありそうな気がしている。課題管理は事象が発生した記録を取り続けて、ある程度溜まったところで分類したり分析したりできる。</p><h2 id=もくもく会>もくもく会</h2><p><a href=https://kobe-sannomiya-dev.connpass.com/event/277856/>【三宮.dev オフライン】もくもく会</a> に参加した。昨日の続きでプロダクトのドキュメントを2時間ほど書いてた。集中してドキュメントと mermaid のフローチャートを書いた。初めて参加された方も何人かいたのでいろんな人の話しを聞くこともできてよい機会だった。参加者の1人から <a href=https://tabelog.com/hyogo/A2801/A280101/28055400/>芋屋HUG</a> のスィートポテトをもらった。お店の存在は知っていたが、1度も買ったことがなくて初めて食べておいしかった。調べてたら神戸発祥のお店っぽいので東京出張するときのお土産に買って行ってもよさそう。よいお土産を知ることができてよかった。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0422/>のびのびと働く土曜日</a></h1><div class=post-meta><span class=post-date>2023-04-22 (Sat.)</span></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/writing/>writing</a>&nbsp;
#<a href=/diary/tags/food/>food</a>&nbsp;
#<a href=/diary/tags/founding/>founding</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#ストレッチ>ストレッチ</a></li><li><a href=#プロダクトのドキュメント>プロダクトのドキュメント</a></li><li><a href=#きんとん>きんとん</a></li><li><a href=#第4期のふりかえり>第4期のふりかえり</a></li></ul></nav></div><div class=post-content><p>昨日は夜に晩ご飯の買い出しにオフィスを出てから、また戻って作業して22時頃に帰ってきて0時に寝て7時に起きた。今日はここ1-2ヶ月では久しぶりにプロジェクトの締め切りに追われずに落ち着いてやりたいことができた。</p><h2 id=ストレッチ>ストレッチ</h2><p>先週に比べれば負荷は減っていたので右腰の張りは少しよくなった。むしろ先週が悪過ぎた。いつも通り右足全般は張りがあるのと、お尻と太ももの境界のツボもいつもより効く感じがして辛かった。今日の開脚幅は開始前155cmで、ストレッチ後158cmだった。リリースに向けての根を詰めてやってきた作業も一段落したのでこれからは体調をよくする方向に意識を向けていけるかもしれない。</p><h2 id=プロダクトのドキュメント>プロダクトのドキュメント</h2><p>追われてないので余裕をもって昨日の続きで2時間ほど書いてた。3 (ページ) ファイルを追加した。ドキュメントは一気に書くとしんどい。少しずつ書いていけば徐々に文量が増えてさらに内容も洗練されていく。休日にドキュメントを書いていると途中で割り込みが入らないから集中できて効率がよい。ソースコードにしろ、文章にしろ、書くときに割り込みが入らない状況は重要なことに最近気付いた。この日記もまとめて数日分を (下書きから) 書くときがあるが、それは集中して書ける時間を取れそうと見計らって書いている気がする。どうやら私は割り込みの有無と書くときのモチベーションに相関関係があるように思える。</p><h2 id=きんとん>きんとん</h2><p>夕方にたまたま出掛けて、よく行くお店で晩ご飯食べようと思ったら開店の20分前で諦めて帰ろうとしていたときにたまたま目にとまった。以前から人気のあるお店であることは知っていたし、いつか入りたいと思っていたお店で、中途半端な時間帯だからお客さんも少なくて、いまがその「いつか」だと気付いて <a href=https://tabelog.com/hyogo/A2801/A280101/28049009/>きんとん 神戸店</a> に入ってみた。後で食べログのとんかつ百名店2022の1つであることを知った。昔からあるから古いお店だと思い込んでいたけど、実際はそうでもなく、店内はオープンでモダンな佇まいで少し驚いた。特選ロースかつ定食が1900円。ちょっと高め。おいしかったので十分に満足した。タレもとんかつソース、わさび醤油、ヒマラヤ岩塩があって、それぞれに味わいがあってよかったし、キャベツにかけるドレッシングもオリジナルでおいしかった。接待にもよさそう。</p><figure><img src=/diary/img/2023/0422_tonkatsu.jpg></figure><h2 id=第4期のふりかえり>第4期のふりかえり</h2><p>年度が変わって1ヶ月が経とうとしている中、ようやく昨年度のふりかえりができる状況になってきた。今年は3月に余裕がなくて少し後ろにずれ込んでいる。この年度ふりかえりも毎年やっているから知見も溜まっていくし、新しい発見もある。来週の雑談に向けてまずは叩き台を作った。もう2-3日ほどかけて資料を洗練させていく。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0421/>1日中ドキュメントを書いていた</a></h1><div class=post-meta><span class=post-date>2023-04-21 (Fri.)</span></div><span class=post-tags>#<a href=/diary/tags/mdbook/>mdbook</a>&nbsp;
#<a href=/diary/tags/document/>document</a>&nbsp;
#<a href=/diary/tags/event/>event</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#プロダクトのドキュメント>プロダクトのドキュメント</a></li><li><a href=#チーム勉強会>チーム勉強会</a></li></ul></nav></div><div class=post-content><p>一昨日あまり寝てなかったので昨日は早く帰ってきて20時から22時ぐらいまで寝て、その後0時ぐらいから寝て何度か起きて7時に起きた。久しぶりによく寝た。</p><h2 id=プロダクトのドキュメント>プロダクトのドキュメント</h2><p>プロダクトのインストールや設定のドキュメントを <a href=https://rust-lang.github.io/mdBook/>mdBook</a> で書いている。チームのメンバーが reStructuredText を知らないというので markdown で書ける方がいいかと思って採用した。<a href=/diary/posts/2023/0403/#mdbook-の初期設定>4月上旬から環境作り</a> して時間のあるときに少しずつ書き足したり、メンバーにも書いてもらうように促したりしていた。情報としてはだいたい半分ぐらい書けたかなぁといったところ。まだまだ内容は足りていない。</p><p>内容とは別に、ある程度まとまったドキュメントとしてのわかりやすさを、例えば <a href=https://www.sphinx-doc.org/ja/master/>Sphinx</a> のようなツールと比較してどうかというのを書き終えたら比較してみようと思う。1つ懸念点としてわかったことに SUMMARY.md からリンクされていない md ファイルはレンダリングされないという仕様になっていて、この仕様の是非や目次の作り方の構成に制約が課せられることへの懸念がある。次の issue でも議論されている。</p><ul><li><a href=https://github.com/rust-lang/mdBook/issues/830>It is recommended that all md files in the directory be converted to html #830</a></li><li><a href=https://github.com/rust-lang/mdBook/issues/702>Files not in SUMMARY.md are not parsed #702</a></li></ul><p>mdbook は私が想定したほど普通のドキュメントツールが備えているような機能を実装していなくて、それは markdown を独自拡張したくないという意志なのかもしれないけれど、本当に最低限の体裁だけでドキュメントのようにみえるようにするといったところしか関心がないのかもしれない。ちょっと触った雰囲気でも本格的なドキュメントを書くツールではないと感じている。私がまだわかっていないだけかもしれないのでもうちょっと触ってみてまた所感をまとめる。</p><h2 id=チーム勉強会>チーム勉強会</h2><p>2週間ぶりのチーム勉強会。メンバーが <a href=https://en.wikipedia.org/wiki/Stable_Diffusion>Stable Diffusion</a> の話しをしてくれた。学生時代に関連する研究をしていたらしい。本人は研究していたから内容を理解しているのだろうけど、一般人の私には全然ついていけなくて説明そのものが難しいなと思いながら聞いていた。そして、最近の研究成果などを紹介しながら15分ぐらいで終わった。論文の内容を理解できているのなら、その内容を解説してもよかったのでは？と思ったりもした。1時間の枠があるのだからもっと話してもらってよかったのだけど、準備も大変だったのかもしれない。時間が余っていたので私がモデレーターとして質問したり、他の参加者に質問を促したりしながら残り時間の40分ほど雑談していた。そういう意味では雑談会としては多くの質問やコメントが出てよかったと思う。意図的に発表時間を短くして雑談会にもっていくというやり方もあるのかな？と勉強会の運営の学びにもなった。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0420/>git コマンドでアーカイブ</a></h1><div class=post-meta><span class=post-date>2023-04-20 (Thu.)</span></div><span class=post-tags>#<a href=/diary/tags/rpm/>rpm</a>&nbsp;
#<a href=/diary/tags/git/>git</a>&nbsp;
#<a href=/diary/tags/packaging/>packaging</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#rpm-パッケージングのためのアーカイブ>rpm パッケージングのためのアーカイブ</a></li></ul></nav></div><div class=post-content><p>2時に寝て7時に起きた。昨日も遅かったので0時ぐらいに晩ご飯を食べてうまく眠れなかった。体調が悪かったので今日は早めにお仕事を終えて帰って寝てた。</p><h2 id=rpm-パッケージングのためのアーカイブ>rpm パッケージングのためのアーカイブ</h2><p>プロダクトは docker compose を使ってデプロイするので docker-compose.yml と関連する設定などのサンプルファイルをパッケージングして rpm として提供する。ビルドは必要なく、初期は数ファイルだったので rpm の SOURCES ディレクトリに直接配置して個別に SourceXx と指定してパッケージングしていた。設定のサンプルファイルが増えてくると1つずつ指定するのが面倒になってきてアーカイブすることにした。rpm を作るための Makefile で次のように git コマンドからアーカイブを作ることができる。このやり方のメリットの1つは git でアーカイブすることでリポジトリにコミットされているものだけが使われるため、対象ディレクトリに中間ファイルなどが散らかっていても無視してくれて都合がよい。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-makefile data-lang=makefile><span style=display:flex><span>VERSION          <span style=color:#f92672>=</span> 1.0.0
</span></span><span style=display:flex><span>SRC_PREFIX       <span style=color:#f92672>=</span> my-product-<span style=color:#66d9ef>$(</span>VERSION<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>SRC_ARCHIVE      <span style=color:#f92672>=</span> <span style=color:#66d9ef>$(</span>SRC_PREFIX<span style=color:#66d9ef>)</span>.tar.bz2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>SOURCES/$(SRC_ARCHIVE)</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>	git -C ../my-src archive HEAD --prefix <span style=color:#66d9ef>$(</span>SRC_PREFIX<span style=color:#66d9ef>)</span>/ -o <span style=color:#66d9ef>$(</span>SRC_ARCHIVE<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>	mv ../my-src/<span style=color:#66d9ef>$(</span>SRC_ARCHIVE<span style=color:#66d9ef>)</span> $@
</span></span></code></pre></div><p>make したときに my-product-1.0.0.tar.bz のようなアーカイブが rpm パッケージングするときの SOURCES 配下に置かれる。そして rpm の spec ファイルでこのアーカイブを <code>Source0</code> として指定して %prep で %setup マクロを呼び出すと展開される。</p><pre tabindex=0><code>Source0: my-product-%{version}.tar.bz2
...
%prep
%setup
</code></pre><p>たったこれだけで spec ファイルの Source 管理をシンプルにできて保守コストが下がるのでうまいやり方だなと学びになった。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0419/>リリース前テストを完了</a></h1><div class=post-meta><span class=post-date>2023-04-19 (Wed.)</span></div><span class=post-tags>#<a href=/diary/tags/project-management/>project management</a>&nbsp;
#<a href=/diary/tags/testing/>testing</a>&nbsp;
#<a href=/diary/tags/docker/>docker</a>&nbsp;
#<a href=/diary/tags/shell/>shell</a>&nbsp;
#<a href=/diary/tags/event/>event</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#リリース前テスト>リリース前テスト</a></li><li><a href=#docker-hub-のプライベートリポジトリ>docker hub のプライベートリポジトリ</a></li><li><a href=#コワーキングのオンラインイベント>コワーキングのオンラインイベント</a></li></ul></nav></div><div class=post-content><p>0時に寝て6時に起きた。昨日は晩ご飯の買いものに行こうと早めに帰ろうとしたら雨降りでそのまま帰って家でだらだらしてた。</p><h2 id=リリース前テスト>リリース前テスト</h2><p>来週の火曜日がリリース日になる。4月から3週間ほどかけて行ってきたテストケースを完了した。致命的な不具合もなく、テストの過程でみつかった不具合も修正済みで予定していたテストが完了となった。ここ2週間ほど、テストして issue が登録されると、私が細心の注意を払って内容を精査して、即日で fix して検証したりしていた。それもあってテストでみつけた不具合はほとんど fix した。あとはリリースのためのパッケージングやドキュメント作成、インフラ作業などへ移っていく。アプリケーションの振る舞いに影響を与えるものではないので私の中では肩の荷がおりてプレッシャーも軽減されて少し安心できた。よかった。よかった。</p><h2 id=docker-hub-のプライベートリポジトリ>docker hub のプライベートリポジトリ</h2><p>先日 <a href=/diary/posts/2023/0407/#docker-hub-の-pull-制限>docker hub の rate limit</a> に引っかかったこともあり、docker hub の有償アカウントを使うことになった。team プランは5人以上必要らしいので pro アカウントで契約してもらった。有償アカウントなら無制限のプライベートリポジトリを提供できる。docker hub でリポジトリを作成していて、いまさらながらにリポジトリ名にスラッシュを含められないことに気付いた。基本的にはハイフン区切りでスラッシュの代替する名前になっていた。これまで自分で docker image を扱ってこなかったので今更ながらに気付いた。</p><p>社内のコンテナレジストリから docker hub のプライベートリポジトリへの promotion のスクリプトを書いていた。bash の連想配列を使ってコンテナレジストリのマッピングを定義してあとは pull/push するコードを書くだけ。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>declare -A repos
</span></span><span style=display:flex><span>repos<span style=color:#f92672>[</span><span style=color:#e6db74>&#34;internal-my-repo1&#34;</span><span style=color:#f92672>]=</span><span style=color:#e6db74>&#34;external/my-repo1&#34;</span>
</span></span><span style=display:flex><span>repos<span style=color:#f92672>[</span><span style=color:#e6db74>&#34;internal-my-repo2&#34;</span><span style=color:#f92672>]=</span><span style=color:#e6db74>&#34;external/my-repo2&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> internal in <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>!repos[@]<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  external<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>repos[$key]<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>  echo <span style=color:#e6db74>&#34;pull from: </span>$internal<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>  echo <span style=color:#e6db74>&#34;push to  : </span>$external<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>done</span>
</span></span></code></pre></div><h2 id=コワーキングのオンラインイベント>コワーキングのオンラインイベント</h2><p>月例のカフーツさんのオンラインイベントに参加した。<a href=/diary/posts/2023/0322/#コワーキングのオンラインイベント>先月の所感はここ</a> 。promotion のスクリプトを書いていたら20分ほど遅れてから参加。今日の話題は chatgpt だった。少し前に <a href=/diary/posts/2023/0331/#chatgpt-勉強会>雑談会</a> したので歴史や原理的な仕組みなど、調べたことを参加者と共有しながら今後の社会の変化などを議論していた。私も関心のある内容なのでおもしろかった。いまや私は日々の開発業務にも chatgpt を使って調べものをしたりサンプルコードを書いてもらうのが普通になりつつある。そのうち ide と連携してテストコードの叩き台なども書かせるようにしてみたい。</p><p>いとうさんは chatgpt をみて、人間は働く意欲がなくなるのではないかといった懸念を表明されていた。いまのところ、ドメイン知識をもっている人がより効率よく働けるようになるツールでしかないという私の認識だが、あと3年ぐらいしたら人間を遥かに超えていって、chatgpt の出力をそのまま業務に応用する日も来るかもしれない。llm というのは次にくるもっともらしい単語を膨大な学習データから統計的に選択しているだけで、実際には内容を理解していないし、人間のように創造的な行為もできない。大雑把に言えば、インターネットの空気を読んで発言すれば人間っぽいというのはすごいことだし、便利で役に立つし、働き方も変わっていくだろうけれど、その延長上で変わる世の中が、私の人生における行動に影響を与えるほどではないと考えている。そういった話をする過程であんちぽさんの言う「価値観を育てる」という文脈が頭の中に残っていて、llm ぐらいでは揺らぎそうにはない気がしている。</p><blockquote class=twitter-tweet><p lang=ja dir=ltr>40代で大した強みもなくて不安みたいなのは共感はするけど、一方で、何歳であっても、他人との比較で生きている限り、一生不安は消えない。どんな年代であっても、自分の正しいと信じることをすればいい。もしそれがないのなら、問題の本質は年齢ではなく、価値観を育てやれてないことの方である。</p>&mdash; 栗林健太郎 (@kentaro) <a href="https://twitter.com/kentaro/status/1647770907581239299?ref_src=twsrc%5Etfw">April 17, 2023</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script><p>ただ it 業界以外にもこんなに話題が拡散しているプロダクトはそうそうないので世の中をどんどん変革していくのだろうというのは、異業種の人たちと話していても実感できた。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0418/>unix crypt(3) をよくわかってなかった</a></h1><div class=post-meta><span class=post-date>2023-04-18 (Tue.)</span></div><span class=post-tags>#<a href=/diary/tags/auth/>auth</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#unix-の-crypt3-というライブラリ実装>unix の crypt(3) というライブラリ実装</a><ul><li><a href=#リファレンス>リファレンス</a></li></ul></li></ul></nav></div><div class=post-content><p>0時に寝て2回ほど起きて7時に起きた。わりと気分がよい方。</p><h2 id=unix-の-crypt3-というライブラリ実装>unix の crypt(3) というライブラリ実装</h2><p>google の Admin console の api の <a href="https://developers.google.com/admin-sdk/directory/reference/rest/v1/users?hl=ja">REST Resource: users</a> で <code>hashFunction</code> として crypt を選択してハッシュ化したパスワードを連携できる。</p><blockquote><p>crypt - C crypt ライブラリに準拠しています。DES、MD5（ハッシュ プレフィックス $1$）、SHA-256（ハッシュ プレフィックス $5$）、SHA-512（ハッシュ プレフィックス $6$）ハッシュ アルゴリズムをサポートします。</p></blockquote><p>この crypt というのは単純に sha256 や sha512 でハッシュ化すればよいわけではなく、歴史的経緯でそれぞれの os ごとにある crypt ライブラリの実装に依存しているらしい。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ man <span style=color:#ae81ff>3</span> crypt
</span></span></code></pre></div><p>おそらく google のドキュメントがいう C crypt ライブラリというのは glibc のことを指していると考えてよいと思うが、go の準標準パッケージである <a href=https://pkg.go.dev/golang.org/x/crypto>golang.org/x/crypto</a> を探してもその実装は存在しない。これも推測だが、仕様が曖昧なものを go の開発者は実装しようとしないのだと思う。とはいえ、c の crypt ライブラリをラップして go から使うのも面倒と言えば面倒なので誰かが crypt ライブラリを真似て野良実装して、それが一部で使われていたりするようにみえる。しかし、なぜかそのオリジナルを作った開発者はそのコードのリポジトリを削除していて、ソースコードのコピーがまわりまわって、いま <a href=https://github.com/GehirnInc/crypt>github.com/GehirnInc/crypt</a> で保守されているらしい。このライブラリを使ってエンコードすると c の crypt ライブラリの出力と一致することは確認できた。この実装をみれば、単純にエンコードすればよいといったものではないことが伺えるので pure go のライブラリとして共有されているのは有り難い。</p><p>このライブラリを使ってハッシュ化した文字列と c 言語のコードも chatgpt に書いてもらっていくつか一致することは検証できた。デバッグしていて、もう1つ salt を生成も特定の文字しか使えないのでうっかり乱数を使って文字列生成していると間違ってしまう。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>saltChars</span> = []byte(<span style=color:#e6db74>&#34;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789./&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>GenerateSalt</span>(<span style=color:#a6e22e>method</span> <span style=color:#a6e22e>Method</span>) []<span style=color:#66d9ef>byte</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>b</span> = make([]<span style=color:#66d9ef>byte</span>, <span style=color:#ae81ff>16</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>charsLength</span> <span style=color:#f92672>:=</span> len(<span style=color:#a6e22e>saltChars</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>b</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>b</span>[<span style=color:#a6e22e>i</span>] = <span style=color:#a6e22e>saltChars</span>[<span style=color:#a6e22e>rand</span>.<span style=color:#a6e22e>Intn</span>(<span style=color:#a6e22e>charsLength</span>)]
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>salt</span> []<span style=color:#66d9ef>byte</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>method</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>SHA256</span>:
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>salt</span> = append([]byte(<span style=color:#e6db74>&#34;$5$&#34;</span>), <span style=color:#a6e22e>b</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>SHA512</span>:
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>salt</span> = append([]byte(<span style=color:#e6db74>&#34;$6$&#34;</span>), <span style=color:#a6e22e>b</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>		panic(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;unsupported salt method: %s&#34;</span>, <span style=color:#a6e22e>method</span>))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>salt</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ここで生成した salt を使って github.com/GehirnInc/crypt を使うとこんな感じで crypt を使って google のユーザーアカウント連携ができる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Crypt</span>(<span style=color:#a6e22e>password</span>, <span style=color:#a6e22e>salt</span> []<span style=color:#66d9ef>byte</span>) (<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>error</span>) {                              
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>salt</span>) &lt; <span style=color:#ae81ff>3</span> {                                                           
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;invalid salt: %s&#34;</span>, string(<span style=color:#a6e22e>salt</span>))                  
</span></span><span style=display:flex><span>    }                                                                            
</span></span><span style=display:flex><span>                                                                                 
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>crypter</span> <span style=color:#a6e22e>crypt</span>.<span style=color:#a6e22e>Crypter</span>                                                    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> string(<span style=color:#a6e22e>salt</span>[<span style=color:#ae81ff>0</span>:<span style=color:#ae81ff>3</span>]) {                                                   
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;$5$&#34;</span>:                                                                  
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>crypter</span> = <span style=color:#a6e22e>crypt</span>.<span style=color:#a6e22e>SHA256</span>.<span style=color:#a6e22e>New</span>()                                             
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;$6$&#34;</span>:                                                                  
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>crypter</span> = <span style=color:#a6e22e>crypt</span>.<span style=color:#a6e22e>SHA512</span>.<span style=color:#a6e22e>New</span>()                                             
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>default</span>:                                                                     
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;unsupported salt prefix: %s&#34;</span>, string(<span style=color:#a6e22e>salt</span>[<span style=color:#ae81ff>0</span>:<span style=color:#ae81ff>3</span>]))  
</span></span><span style=display:flex><span>    }                                                                            
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>hashed</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>crypter</span>.<span style=color:#a6e22e>Generate</span>(<span style=color:#a6e22e>password</span>, <span style=color:#a6e22e>salt</span>)                                
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>crypter</span>.<span style=color:#a6e22e>Verify</span>(<span style=color:#a6e22e>hashed</span>, <span style=color:#a6e22e>password</span>)                                      
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>hashed</span>, <span style=color:#a6e22e>err</span>                                                           
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ハッシュ化した文字列が正しいかどうかは実際に google にログインしてみないと判別できないのでわりとデバッグや検証に時間がかかった。</p><h3 id=リファレンス>リファレンス</h3><ul><li><a href=https://blog.amedama.jp/entry/unix-crypt-3>色々な Unix 系 OS の crypt(3) について調べたら面白かった話</a></li><li><a href=https://yosida95.com/2015/07/25/120000.html>/etc/shadow などで使われるハッシュ関数、 crypt(3) を Go 言語で実装しました</a></li></ul></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0417/>カスタム overlay モジュールを完全にマスターした</a></h1><div class=post-meta><span class=post-date>2023-04-17 (Mon.)</span></div><span class=post-tags>#<a href=/diary/tags/ldap/>ldap</a>&nbsp;
#<a href=/diary/tags/debug/>debug</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#openldap-のカスタム-overlay-モジュールのデバッグ>openldap のカスタム overlay モジュールのデバッグ</a></li></ul></nav></div><div class=post-content><p>0時に寝て何度か起きて7時に起きた。変な夢をみた気がするが、どんな夢だったかは思い出せない。</p><h2 id=openldap-のカスタム-overlay-モジュールのデバッグ>openldap のカスタム overlay モジュールのデバッグ</h2><p>先週末から <a href=/diary/posts/2023/0414/#chatgpt-と一緒にデバッグ>openldap のカスタム overlay モジュール</a> の開発やデバッグをしている。openldap のソースコードや gdb のデバッグのやり方にも慣れてきて私の中でも理解度が増してきた。</p><p>openldap サーバーのデバッグログは次のコードが設定されている。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#define LDAP_DEBUG_TRACE  0x0001
</span></span></span></code></pre></div><p>このコードを slapd.conf の loglevel に設定するとデバッグログを出力できるようになる。</p><pre tabindex=0><code>loglevel stats 0x0001 ...
</code></pre><p>このときに ppolicy の overlay モジュールがどのタイミングで呼ばれるかをデバッグログを確認しながら検証した。</p><pre tabindex=0><code>overlay ppolicy
ppolicy_hash_cleartext on
</code></pre><p>結論から言うと次の2点になる。</p><ul><li>overlay は slapd.conf の後ろに書いた方のカスタムモジュールが先に実行される</li><li>ppolicy_hash_cleartext は ppolicy_add のタイミングで平文パスワードをハッシュ化している<ul><li>gdb でデバッグすると op->o_request->oq_add->rs_modlist も op->o_request->oq_add->rs_e->e_attrs も同じアドレスを指す</li><li>overlay の処理は db に書き込む前と後の2つのタイミングがある</li></ul></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#a6e22e>slap_passwd_hash</span>( <span style=color:#f92672>&amp;</span>(pa<span style=color:#f92672>-&gt;</span>a_vals[<span style=color:#ae81ff>0</span>]), <span style=color:#f92672>&amp;</span>hpw, <span style=color:#f92672>&amp;</span>txt );
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>pa<span style=color:#f92672>-&gt;</span>a_vals[<span style=color:#ae81ff>0</span>].bv_val <span style=color:#f92672>=</span> hpw.bv_val;
</span></span><span style=display:flex><span>pa<span style=color:#f92672>-&gt;</span>a_vals[<span style=color:#ae81ff>0</span>].bv_len <span style=color:#f92672>=</span> hpw.bv_len;
</span></span></code></pre></div><p>カスタム overlay モジュールを使って openldap からパスワードを取得するには次の順番で処理が行われることを理解しておく必要がある。</p><ol><li>mycustom_add &lt;= このタイミングで平文パスワードを取得しないといけない</li><li>ppolicy_add &lt;= このタイミングで平文のパスワードをハッシュ化する</li><li>mycustom_add_response &lt;= このタイミングではすでにパスワードがハッシュ化されている</li></ol><p>openldap のことを何も知らない素人が chatgpt と一緒にデバッグしてこのことを2日で理解できた。開発のやり方が変わっていく予兆を感じた。</p></div></div><div class=pagination><div class=pagination__buttons><a href=/diary/page/27/ class="button previous"><span class=button__icon>←</span>
<span class=button__text>最近の日記</span></a>
<a href=/diary/page/29/ class="button next"><span class=button__text>過去の日記</span>
<span class=button__icon>→</span></a></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>© 2021 Tetsuya Morimoto</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>