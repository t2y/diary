<!doctype html><html lang=en><head><meta name=generator content="Hugo 0.109.0"><title>forest nook</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content="t2y"><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="forest nook"><meta property="og:description" content><meta property="og:url" content="/diary/"><meta property="og:site_name" content="forest nook"><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/index.xml rel=alternate type=application/rss+xml title="forest nook"></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><div class=posts><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0228/>開発の追い込みに集中</a></h1><div class=post-meta><span class=post-date>2023-02-28 (Tue.)</span></div><span class=post-tags>#<a href=/diary/tags/project-management/>project management</a>&nbsp;
#<a href=/diary/tags/phronesis/>phronesis</a>&nbsp;
#<a href=/diary/tags/book/>book</a>&nbsp;
#<a href=/diary/tags/event/>event</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#開発の追い込み>開発の追い込み</a></li><li><a href=#上司道-野村監督から学ぶリーダーの器のつくり方>上司道 野村監督から学ぶリーダーの器のつくり方</a></li></ul></nav></div><div class=post-content><p>23時に寝て2回ほど起きて7時に起きた。土日コードを書いて疲れていたので月曜日は早めに業務を切り上げて実家のいろいろをやっていた。</p><h2 id=開発の追い込み>開発の追い込み</h2><p>サーバーサイドとフロントエンドはほぼ開発が完了し、これからテストするだけといきたいところが、想定外のことがあってまだそうはなっていない。</p><blockquote><p>予想外のことは起こるものだ。ガトーは良くやっている by <a href=https://ja.wikipedia.org/wiki/%E3%82%A8%E3%82%AE%E3%83%BC%E3%83%A6%E3%83%BB%E3%83%87%E3%83%A9%E3%83%BC%E3%82%BA>エギーユ・デラーズ</a></p></blockquote><p>と言っているほどの、予想外というわけでもないが、思った通りに進捗しなくてリリースの危機を迎えている。なにが起ころうとプロジェクトの全責任はマネージャーにある。いま溜まっている issue をメンバーに再分配して乗り切ろうと定例会議で話した。私が2人分ぐらいの作業をすれば1週間もあれば取り戻せる程度の遅れではある。ただ残り時間が1ヶ月しかないだけ。また週末働いてその足で東京に行くのだろうなと直近の未来を想像していた。</p><h2 id=上司道-野村監督から学ぶリーダーの器のつくり方>上司道 野村監督から学ぶリーダーの器のつくり方</h2><p>お仕事にテンパっているものの <a href=https://www.facebook.com/events/1384533265732797>第86回上司道 野村監督から学ぶリーダーの器のつくり方</a> に参加した。<a href=/diary/posts/2022/1019/#上司道-リーダーはレジリエンスを高める自己肯定感を学ぼう>上司道</a> に参加するのは2回目。</p><p>以前 <a href=https://www.shogakukan.co.jp/books/09387604>野村ノート</a> を読んだことがある。
野村監督は言語化にこだわりのある方で選手としても監督としても一流だった氏の実践知の言語化は参考になるかもしれないと思って読んだ。本書は期待した通りでプロ野球に限らず、一般のビジネスパーソンにとっても汎用的に役に立つアイディアがいくつもあったように思う。</p><p>例えば、野村監督が捕手に求めるものとして次がある。判断というのは知識と経験を根拠になんらかの基準をもってくだすといったことが書いてあった。判断の前に分析と観察と洞察の3つの段階を語れる人がどのぐらいいるのだろうか。</p><ol><li>分析</li><li>観察 (目に見えるものをみる)</li><li>洞察 (目に見えないもの = 心理を読む)</li><li>判断</li><li>記憶</li></ol><blockquote><p>今思うのは、小さいことを重ねることが、とんでもないところに行くただ一つの道だと感じている。</p></blockquote><p>これはイチローのコメントだが、この言葉は野村監督の野球観に通じていて感銘を受けたと書いてあった。そんな風に野村ノートがおもしろかったので、その延長上で野村監督に関するイベントなら参加してみようと思った次第。</p><p>実際のイベントについては、期待値も高かったのかもしれないが、私の求めていたイベントの内容ではなかった。野村監督と付き合いの長い番記者が野球人としての野村監督というよりも、一般人としての野村監督の在り方を伝えるような著書やそのイベント内容だったと思う。あと野村監督の話しを聞きに行ったのだけど、半分以上は講師が自分のことを多く話すのでその点もアンマッチだったと言える。上司道のイベントは2回目なんだけど、これまでどちらも私の求めていたものではなかった。もしかしたらマネジメントやリーダーシップのイベントで話すのはなかなか難しいのかもしれない。それはいろんな業界・業種の人たちにとって参考になるリーダーシップのようなものはないのかもしれないなと感じた。ドメイン知識も含めてのリーダーシップの話しをしないと、宗教のような徳を積んで治めなさいといったありがたい話しの一般化になってしまう気がする。</p><p>人間力は定性的なもので言語化が難しい。それよりも実践知はもう少しスキル寄りなものだと私は考えていて、習慣だったり洞察だったりなら誰でも訓練すれば身につけられるのではないかと思う。少なくとも野村ノートからはそういった片鱗が私には読み取れた。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0227/>go 1.20.1 を使い始めた</a></h1><div class=post-meta><span class=post-date>2023-02-27 (Mon.)</span></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/linux/>linux</a>&nbsp;
#<a href=/diary/tags/network/>network</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#go-1201-へのアップグレード>go 1.20.1 へのアップグレード</a></li><li><a href=#rocky-linux-のネットワーク設定>rocky linux のネットワーク設定</a></li></ul></nav></div><div class=post-content><p>0時に寝て何度か起きて7時半に起きた。あまりうまく眠れなかった。</p><h2 id=go-1201-へのアップグレード>go 1.20.1 へのアップグレード</h2><p>リファクタリングの区切りがついたらやろうと思っていて遅れた。すでに 1.20.1 がリリースされている。先日 <a href=https://gocon.connpass.com/event/273096/>Go 1.20 リリースパーティ</a> に参加して、いろいろ聞いていると改善されているところや新しい機能を試してみたいものがいくつかみつかった。単純にアップグレードするだけでも最大でビルド時間が10%短縮される可能性がある。1.18 と 1.19 で generics 対応でビルド時間が遅くなっていたのが 1.17 相当に改善されたらしい。やっぱり generics はコンパイラを複雑にするものなのでコンパイル時間が長くなる傾向があるんやなと話しを聞いていて思ったりもした。ついでに依存ライブラリなどのバージョンアップもまとめてやった。単体テストと結合テストが普通には揃ってきたのでバージョンアップなども安心して実行できる。</p><iframe class=speakerdeck-iframe frameborder=0 src="https://speakerdeck.com/player/b76374a32d394b66afdfea89da855927?slide=1" title="What's new in Go 1.20?" allowfullscreen style="border:0;background:padding-box padding-box rgba(0,0,0,.1);margin:0;padding:0;border-radius:6px;box-shadow:rgba(0,0,0,.2)0 5px 40px;width:600px;height:auto;aspect-ratio:560/314" data-ratio=1.78343949044586></iframe><h2 id=rocky-linux-のネットワーク設定>rocky linux のネットワーク設定</h2><p>テスト環境に使っている rocky linux の ip アドレスを変更する必要があったので調べてみた。ちゃんとした公式のガイドが出てきてすごいなと感心した。</p><ul><li><a href=https://docs.rockylinux.org/guides/network/basic_network_configuration/>Network Configuration - Rocky Linux 9</a></li></ul><p>ip アドレスを確認するコマンドが ifconfig から ip に変わっていたり、ネットワーク設定のためのツールも私が知っているものとは全然変わってしまっている。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ip addr
</span></span></code></pre></div><p>Network Manager のサービスで設定されているようでそのための設定ファイルは次の場所に保存されていた。</p><pre tabindex=0><code>/etc/NetworkManager/system-connections/my-device.nmconnection 
</code></pre><p>これを書き換えるツールとして nmtui という tui ツールと nmcli という cli ツールの2つがある。tui とか懐かしいなとか思いながら操作していた。ssh 経由で設定していたので cli でいきなり設定を反映するよりも tui で設定ファイルを書き換えて os を再起動するのがよいだろうと考えてやってみた。ドキュメントに書いてある通りに操作したら意図した ip アドレスを設定して変更できた。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0226/>コードを書いていると後から改善点に気づく</a></h1><div class=post-meta><span class=post-date>2023-02-26 (Sun.)</span></div><span class=post-tags>#<a href=/diary/tags/refactoring/>refactoring</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#リファクタリングのリファクタリング>リファクタリングのリファクタリング</a></li></ul></nav></div><div class=post-content><p>1時に寝て7時に起きた。起きてからドラクエタクトをだらだらやってて10時前に起き上がってそれからオフィスへ行って活動してた。</p><h2 id=リファクタリングのリファクタリング>リファクタリングのリファクタリング</h2><p>昨日書いたマージリクエストの変更点についてドキュメントの更新だけしようと作業していたら、その後、一緒に修正した方がよい追加の機能拡張に気付いて3時間ほど追加の実装をしていた。その後、お昼ご飯を食べているときに午前中に書いた実装を改善した方がよいところに気付いて、さらに追加で1時間ほどリファクタリングしていた。コードを書いていて、一旦はできたつもりになってその時点ではよさそうに思うのだけど、時間が経ってから考え直すと考慮漏れやもっとよい実装のアイディアを思い付いたりする。私の頭が悪いだけかもしれないが、最初からよい実装や設計を行うことは多くの人にとって難しいことだと思いたい。何度も考えて作り直したり改善したりしているうちにもっとよい方法に気付く。</p><p>多くの開発者はもっとよいアイディアを思い付いたとしても実際にリファクタリングをしようとしない。動いているコードを修正して壊れるリスクや他に優先度の高い作業があるとか、いろいろやらない理由を言う人たちもいる。私はそのやらない理由を議論している合間にリファクタリングしてしまう。というのは、誇張した比喩で実際にはもっと時間がかかることもあるけど、設計も見直す数千行レベルの変更を気軽に行う。もしそれで壊れたらどうすると聞かれてもシンプルに謝るだけ。謝ってから直す、テストを書く、再発防止のための仕組みを考える。やることはそれだけ。問題のあるコードを見て見ぬ振りをする開発者の方が普通という感覚がある。10年以上開発をやってきて思うこととして、そういう価値観を上位の開発者が壊していって模範を示すことがよい開発文化への第一歩となる。しんどいことに対して口だけでは人は動かない。個々の開発者が問題だと思ったらどんどん書き直していく、リファクタリングしていくという文化は一朝一夕ではできない。そういう開発文化を醸成していくと大きな技術的負債が溜まるといったことはなくなるのではないかと考えている。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0225/>リファクタリング一段落</a></h1><div class=post-meta><span class=post-date>2023-02-25 (Sat.)</span></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;
#<a href=/diary/tags/refactoring/>refactoring</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#ストレッチ>ストレッチ</a></li><li><a href=#機能拡張とリファクタリング>機能拡張とリファクタリング</a></li></ul></nav></div><div class=post-content><p>1時に寝て7時に起きた。前日も21時頃までオフィスにいて、今日も午後からコードを書いていて22時ぐらいまでやってた。コードを書いていると時間がどんどんなくなる。本当は三宮.dev の勉強会があったんだけど、このリファクタリングは週末にやってしまわないとやばいという野生の勘でキャンセルした。</p><h2 id=ストレッチ>ストレッチ</h2><p>今日の開脚幅は開始前156cmで、ストレッチ後160cmだった。だいたいいつも通り。先週から右すねの外側の筋に張りがある。先週よりちょっとよくなった気もするけれど、まだ張りが継続している。あと今週は右腰に張りがあった。今週はリファクタリングしていて座ってきる時間がいつもより長かったためだろうと推測する。どんなに忙しくてもストレッチだけは休まないようにしている。ストレッチに通い始めて2年以上経つが身体的に体調が悪いということは記憶にほぼない。日記にはその週のどこそこに張りがあるとか調子が悪いといったことを書いたりしているが、それは日常生活を送る上で支障が出るようなレベルではない。そうならないように予防している。健康を維持する上でストレッチは大きな影響を与えているため、中長期の展望から忙しくても継続するようにしている。</p><h2 id=機能拡張とリファクタリング>機能拡張とリファクタリング</h2><p>今日は休日出勤して go のコードを書いていた。ある機能を作るときに内部的には汎用の api にしてしまって他のコレクションのデータ型でも再利用できるようにしたい。先週ずっと go の generics を使って mongodb 周りのコレクションとそのクライアントのリファクタリングをしていた。go の generics の理解も進んで crud なインターフェースを generics でどのように定義して実装すればいいかわかってきた。その過程で web api のアプリケーション層と mongodb のインフラ層 (データ層) の役割分担も明確になりつつある。どちらも generics を駆使して型チェックされた上でソースコードを共通化し、汎用 api としてリファクタリングしながら設計している。その集大成としてアプリケーション側で汎用的な機能を追加するときに、理想的には1つのコードを追加・変更すれば、別のデータ型でもすべて同じように動くといった機能として実装した。4つのコレクションのデータ型で同じ振る舞い (機能) を共通化する。その実装も丸1日やれば完了できるぐらいに設計の効率化ができてきた。</p><p>go はオブジェクト指向言語ではないので generics を駆使しても、java でいうところの抽象既定クラスを用いたテンプレートパターンの実装ができない。それぞれの構造体で基本的にはコピペとなる構造体のメソッドを定義しないといけない。もちろん別のヘルパーに移譲するといったことはできるけど、状態をもっていないコードの再利用はたしかに安全ではあるけれど、状態を参照できないからそのために値をコピーするといった整合性の懸念やボイラープレート的なコードを書く必要がある。これは設計におけるトレードオフになるので go の処理系の設計に不満があるわけではない。但し、generics でできることにはまだ機能不足がある。とくに直和型の扱い。できないのかな？とググると proposal の issue がみつかるので今後の機能拡張に期待したい。</p><p>正直マネージャーが開発に工数使っていて何やってるんだとみられているかもしれない。1-2週間集中してリファクタリングしてみて、いまのアプリケーションの設計の勘所が以前よりも理解が進んだ。コードレビューだけではわからないフィードバックがある。結合テストもいくつか追加したので今後の開発で役に立つはず。これで私の (リファクタリング) 開発は終了しようと思う。</p><p>今日作ったマージリクエストの diff が次になる。</p><pre tabindex=0><code>51 files +1314 -648
</code></pre><p>diff の行数だけ数えると今週だけで1万行近くは変更したと思う。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0224/>mongodb のトランザクションの考え方</a></h1><div class=post-meta><span class=post-date>2023-02-24 (Fri.)</span></div><span class=post-tags>#<a href=/diary/tags/mongodb/>mongodb</a>&nbsp;
#<a href=/diary/tags/database/>database</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#mongodb-のトランザクション管理>mongodb のトランザクション管理</a></li></ul></nav></div><div class=post-content><p>1時に寝て8時に起きた。3時頃に気分悪くて起きて少し吐いてそれからまた寝た。丸1日機能拡張とリファクタリングのために go のコードを書いていた。</p><h2 id=mongodb-のトランザクション管理>mongodb のトランザクション管理</h2><p>2つの web api から同じコレクションの異なるフィールドを更新したい。mongodb で厳密なトランザクションを管理するようなアプリケーションではないけど、なるべく整合性を維持できるように努めることはやっておきたい。mongodb でトランザクションに近いことを実現する方法として次の記事が参考になった。</p><ul><li><a href=https://www.mongodb.com/blog/post/how-to-select--for-update-inside-mongodb-transactions>How To SELECT &mldr; FOR UPDATE inside MongoDB Transactions</a></li></ul><p>この記事では <code>findOneAndUpdate()</code> という api を使って、更新時に必ず変更されるフィールドを含めることで find したときのそのフィールドの値が変わっていればエラーになってくれることでトランザクション相当の機能が提供されると書いてある。必ず変更されるフィールドとして <a href=https://www.mongodb.com/docs/manual/reference/method/ObjectId/>ObjectId</a> を使えば他の更新処理を検出するのに役立つだろうとある。いま私が開発しているアプリケーションでは同じフィールドを複数の web api から更新するわけではないのでここまで厳密なトランザクション管理は必要にない。</p><p>既存の処理が <a href=https://www.mongodb.com/docs/drivers/go/current/usage-examples/replaceOne/>Replace</a> を使って実装されていたのを <a href=https://www.mongodb.com/docs/drivers/go/current/usage-examples/updateOne/>Update</a> を使うように変更する。Replace と Update の違いはドキュメント全体を更新するのか、一部のフィールドのみを更新するのかの違いになる。具体的には go のドライバーにおいて次のメソッドの使い分けになる。</p><ul><li><a href=https://pkg.go.dev/go.mongodb.org/mongo-driver/mongo#Collection.FindOneAndReplace>FindOneAndReplace</a></li><li><a href=https://pkg.go.dev/go.mongodb.org/mongo-driver/mongo#Collection.FindOneAndUpdate>FindOneAndUpdate</a></li></ul><p>これらのメソッドを使うことで find と replace/update の操作を1回の処理でできるから効率もよいらしい。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0223/>結合テストのリファクタリング</a></h1><div class=post-meta><span class=post-date>2023-02-23 (Thu.)</span></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/testing/>testing</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#go-のテストにおける-setupteardown-関数の実装>go のテストにおける setup/teardown 関数の実装</a></li></ul></nav></div><div class=post-content><p>0時に寝て7時に起きた。前日は久しぶりに飲んでいい気分で寝てた。朝コンビニ寄ったらいつもほぼ満席のイートインが閑散としているなと思いつつ、オフィスへ行って始業報告して、今日祝日だよとツッコミもらった。全然気付いていなかった。まだ新しい天皇誕生日に慣れてない。</p><h2 id=go-のテストにおける-setupteardown-関数の実装>go のテストにおける setup/teardown 関数の実装</h2><p>昨日から結合テストのリファクタリングをしていてせっかくオフィスに行ったので続きをする。結合テストだとデータを作ったり削除したりをテスト単位にやりたい。例えば、ユーザーを作成してテスト実行し、終わったら作成したユーザーを削除したい。次のように setup 関数を書き、返り値として teardown の関数を返す。このときに <code>t.Helper()</code> を呼び出しておくと、エラーがあったときにどの呼び出し元のテストでエラーが発生したかがわかる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>setupUsers</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>, <span style=color:#a6e22e>users</span> []<span style=color:#a6e22e>mongodb</span>.<span style=color:#a6e22e>User</span>) <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Helper</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>user</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>mongodb</span>.<span style=color:#a6e22e>NewUserCollection</span>(<span style=color:#a6e22e>url</span>, <span style=color:#a6e22e>username</span>, <span style=color:#a6e22e>password</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>u</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>users</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>Save</span>(<span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>ID</span>, <span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>Attributes</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Fatalf</span>(<span style=color:#e6db74>&#34;failed to create a user: %s&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Helper</span>()
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>Truncate</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Fatalf</span>(<span style=color:#e6db74>&#34;failed to truncate the user collection: %s&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>使い方は簡単で setup 関数を呼び出すと teardown 関数が返ってくるのでそれを defer で呼び出すとよい。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>teardown</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>setupUsers</span>(<span style=color:#a6e22e>t</span>, <span style=color:#a6e22e>usersTestData</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>teardown</span>()
</span></span></code></pre></div><p>しかし、この setup 関数をサブテストと一緒に並行実行すると意図したように動かない。どうやらサブテストを並行実行すると親テストが呼ばれた後に呼び出されるという仕組みになっていて、サブテストを実行する前に teardown が呼ばれてしまうので意図した制御にならない。<a href=https://stackoverflow.com/a/53950628>How to handle parent test teardown with parallel subtests in golang の回答</a> によると、サブテストからさらにサブテストを実行するとよいとある。この場合、親テストとサブテストは同期的に実行され、サブテストの中でさらにサブテストを並行実行するという考え方で意図した振る舞いになる。並行実行するときは次のようなコードになる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>TestMy</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>tests</span> <span style=color:#f92672>:=</span> []<span style=color:#66d9ef>struct</span>{
</span></span><span style=display:flex><span>        <span style=color:#75715e>// test cases
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>teardown</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>setupUsers</span>(<span style=color:#a6e22e>t</span>, <span style=color:#a6e22e>usersTestData</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>teardown</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#e6db74>&#34;wrap for setup process&#34;</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>tt</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>tests</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>tt</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>tt</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>tt</span>.<span style=color:#a6e22e>name</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Parallel</span>()
</span></span><span style=display:flex><span>                <span style=color:#75715e>// do test
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            })
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0222/>zeromq の多言語対応がすごい</a></h1><div class=post-meta><span class=post-date>2023-02-22 (Wed.)</span></div><span class=post-tags>#<a href=/diary/tags/zeromq/>zeromq</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;
#<a href=/diary/tags/drinking/>drinking</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#エレベーター点検の間違い>エレベーター点検の間違い</a></li><li><a href=#zeromq-の調査>zeromq の調査</a></li><li><a href=#近況報告の雑談>近況報告の雑談</a></li></ul></nav></div><div class=post-content><p>1時に寝て7時に起きた。昨晩は食べ過ぎて気分が悪かった。</p><h2 id=エレベーター点検の間違い>エレベーター点検の間違い</h2><p>朝オフィスの入っているビルへ着くと、エレベーターに張り紙があって使えないことが書いてある。問題があれば、エレベーターの保守会社へ連絡してくださいとある。その張り紙をみて、エレベーターが故障したのかな？と勘違いした。その横でオフィスの利用者が10人ほど復旧を待っていた。仕方ないから一旦、家に戻って午前中は家からお仕事することにした。これはこれで docker で開発環境を作っていると、普段使っていないマシンでもすぐに開発環境を構築できることのメリットを実感する機会となった。11時頃に再訪したら普通にエレベーターが動いていて、あれ！？と思って、そのときに初めてビルの掲示板を見に行ったら、7:30 - 8:30 の時間帯でエレベーター点検だと書いてあった。私は8時前後に出社するのでこの時間帯は厳しい。エレベーターが動いていなかったらまず点検を疑うことにするのを学んだ。</p><h2 id=zeromq-の調査>zeromq の調査</h2><p>昨日から <a href=https://zeromq.org/>zeromq</a> の調査をしていた。ネットワークの通信におけるプラクティスとも言える、<a href=https://zguide.zeromq.org/>ØMQ - The Guide</a> というごっついガイドもあって学びが多い。少し古いバージョンなら翻訳版も <a href=https://www.cuspy.org/diary/2015-05-07-zmq/>ØMQガイドブック(日本語版)</a> にある。英語が苦手な方はまずこれを読んで概要を掴むのもよいかもしれない。ちなみにこの翻訳者の方といま一緒に働いていて設計のレビューをお願いして教えていただいている。感謝。</p><p>zeromq を使うときの注意点の1つとして、バックグラウンドで i/o スレッドが動いていて
<a href=http://api.zeromq.org/master:zmq-send>zmq_send()</a>
は実際に通信しているのではなく、バックグラウンドの i/o スレッドにメッセージを渡すだけになる。そのため、i/o スレッドが実際にノード間の通信を非同期で行う。これは接続先の相手がダウンしていても送信バッファにメッセージを溜めておいて再送してくれるので都合がよい。ちなみに送信バッファのサイズは
<a href=http://api.zeromq.org/master:zmq-setsockopt>zmq_setsockopt()</a>
に <code>ZMQ_SNDHWM</code> を指定して調整できる。ソケットが常時接続されていれば、メッセージの順序は維持されるらしいが、ソケットを接続／切断するような使い方をすると <code>zmq_send()</code> が呼ばれたメッセージの順序は保証されない。一般の queue をイメージしてメッセージの順序が保証されることを前提に開発すると落とし穴があるので注意しておく必要がある。そういう so や issue も登録されているのを確認した。</p><ul><li><a href=https://stackoverflow.com/questions/36977508/0mq-push-pull-ordering-broken-if-no-pull-sockets-connected>0MQ PUSH/PULL Ordering Broken if no PULL Sockets connected</a></li><li><a href=https://github.com/zeromq/libzmq/issues/3057>Out-of-order message and slow performance when closing and reconnecting socket #3057</a></li></ul><h2 id=近況報告の雑談>近況報告の雑談</h2><p>約1年ぶりにやすだ先生と大阪でオフライン飲み会をした。毎年2-3月頃に近況報告して経営のアドバイスなどをいただいたりしている。今回で3回目。今年は私がいま実家のいろいろとリファクタリングなどでいっぱいっぱいなのでとくに近況報告の資料を作る余裕がなくて、普通に飲み会しながらその場での近況報告となった。昨今の web 開発の当たり前として ci/cd や k8s のことを共有しながら、大学のシステムはどうこうみたいな話しもした。やすだ先生も副業が好調らしく、東京に出張する機会も多いとご活躍されているそうだ。</p><p>今回 <a href=https://molto-umeda.com/>クラフトビアハウスモルト 梅田店</a> というお店に初めて行った。私のような普段着の人間でも気軽に入ってよいようなお店であることもわかった。また接待で使おうと思う。食べものはちょっと上等なおつまみがある程度なのでビールを飲むのをメインとする相手がよいだろう。飲み放題コースにしたので、食べものの選択やビールの値段を気にせず注文できたのも接待としては考えることが減ってよかったと思う。阪急グランドビルの31Fという最上階にあって、あまり広いお店ではないが、気軽に夜景をみながらクラフトビールを飲める。早めに予約したおかげだと推測するが、カウンター席の一番端だったので座席もよかった。その横におそらく VIP ルームがあって、個室かどうかよりも店内が広くないので広いスペースを使う意図で VIP ルームもよさそうにみえた。追加料金なく借りれるのかな？2人で借りるのは難しいかもしれないが、4人ほどいれば借りてみたいと思う。</p></div></div><div class=pagination><div class=pagination__buttons><a href=/diary/page/17/ class="button previous"><span class=button__icon>←</span>
<span class=button__text>最近の日記</span></a>
<a href=/diary/page/19/ class="button next"><span class=button__text>過去の日記</span>
<span class=button__icon>→</span></a></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>© 2021 Tetsuya Morimoto</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>