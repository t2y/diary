<!doctype html><html lang=en><head><meta name=generator content="Hugo 0.123.1"><title></title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content="t2y"><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content><meta property="og:description" content><meta property="og:url" content="/diary/"><meta property="og:site_name" content><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/index.xml rel=alternate type=application/rss+xml title></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><div class=posts><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0416/>yubikey bio を購入してみた</a></h1><div class=post-meta><span class=post-date>2023-04-16 (Sun.)</span></div><span class=post-tags>#<a href=/diary/tags/auth/>auth</a>&nbsp;
#<a href=/diary/tags/device/>device</a>&nbsp;
#<a href=/diary/tags/project-management/>project management</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#yubikey-bio-の購入>yubikey bio の購入</a></li><li><a href=#自分たちでやろうとしないことを他人は助けられない>自分たちでやろうとしないことを他人は助けられない</a></li></ul></nav></div><div class=post-content><p>0時に寝て7時に起きた。午前中は洗濯して、昨日届いたお肉を焼いて朝ご飯にしながらドラクエタクトやってた。</p><h2 id=yubikey-bio-の購入>yubikey bio の購入</h2><p>デスクトップマシンが不調だった1-2ヶ月ほど <a href=/diary/posts/2022/1004/#m2-macbook-air-購入>m2 macbook air</a> でお仕事をしていた。デスクトップマシンと比べて明らかに便利だったことがある。<a href=https://1password.com/jp/>1password</a> にログインするときに os のシステムアカウントも利用できて、具体的には指紋認証によりパスワード入力を必要としなかった。デフォルトでは2週間ごとにパスワード入力を必要とする設定になっているが、これも無効にすることもできる。パスワードを忘れないように1ヶ月に1回ぐらいは手入力してもよいかもしれない。生体認証はその精度にまだ懸念はあるそうだけど、こういった日常的な認証における用途ならそれほど高い精度を要求しないことに気付いた。私は個人でお仕事しているから日常でオフィスに保管している物理的なデバイスを盗むのは難しい。他にも linux で使える指紋認証のデバイスを探してみた。しかし、現時点では usb の指紋認証デバイスは windows 一択になっていて linux はサポートされていない。YubiKey ぐらいしか、私はみつけることができなかった。</p><p><a href=https://www.yubico.com/jp/product/yubikey-bio-series/yubikey-bio/>YubiKey Bio - FIDO Edition</a> をオンラインストアで購入した。船便で購入したので届くまで1ヶ月ほどかかる。急ぐものではないので気長に待つ。</p><pre tabindex=0><code>YubiKey Bio - FIDO Edition
$90

Shipping &amp; handling
Economy - 10-20 Working Days - No tracking available
$5

Duties, taxes and/or carrier subcharges
$14.68 USD
</code></pre><p>日本にお店がないので輸入扱いで関税がかかるのかな？また会計システムに登録するときに税金の計上方法を調べる必要がありそう。</p><h2 id=自分たちでやろうとしないことを他人は助けられない>自分たちでやろうとしないことを他人は助けられない</h2><p>他社のプロジェクト開発のお手伝いでプロジェクトマネージャーとしてこの半年をマネジメントしてきて分かるようになったことが1つある。米軍がアフガニスタンから撤退するときの方便のようにみかけ、ロシアのウクライナ侵攻のときにウクライナ軍が善戦して西側諸国の支持を得たことでその正しさを再確認できた言葉がある。</p><blockquote><p>バイデン大統領は演説で「当事国の軍隊が戦う意思がないのにアメリカが戦うわけにはいかない」という趣旨を繰り返した。</p><p><a href=https://www.jfss.gr.jp/article/1569>アフガニスタン崩壊と日本への教訓</a></p></blockquote><p>2月からプロジェクトの開発遅れがみえていてスケジュール調整している。プロジェクトの開発がうまくいかないことの全責任は私にあることは間違いない。その点には一切の懸念も疑問もない。昨今の働き方改革で有休取得が大事なことも理解していて、平均して取得するなら毎月1-2日休むことになる。それは理解できるが、開発が遅延していても有休で休み、その遅延をマネージャである私が休出して開発を肩代わりするという調整を1ヶ月以上続けてきて、この歪みは開発やプロジェクトにとってよくないということもわかってきた。</p><p>私個人のモチベーション管理にも多少の影響はあるが、私は指示されて休出しているわけではなく、自分の目的のためにやっているのでこの影響はそれほど重要ではない。</p><p>なにが問題かというとプロダクトオーナーシップを開発者がもたないという点にある。私はお手伝いであるから、いずれいなくなる。周りからどうみえようと最終的にプロダクトオーナーシップは契約形態としてもてない。そして、お手伝い先の開発メンバーがもつようになるのが望ましい。しかし、そういう雰囲気はみえない。これまで他社の人間がマネージャーをやっているようなプロジェクトに私が参加したことがなかったためにそういった視点がなかった。そして、私は自分がイニシアティブをもって開発するプロダクトはすべてプロダクトオーナーシップをもって臨んできた。そのため、開発者に裁量を与えることで必然的にプロダクトオーナーシップをもつようになると信じてきたが、いまのやり方だとそうならない気がしている。なぜならば、放っておいても問題になる前に私が勝手に対応してしまうために開発者のインセンティブやモチベーションを阻害してしまうからだ。</p><p>プロジェクトにおけるスケジュールや品質を担保するためにはマネージャーである私が一定の尽力をするのは合理的ではある。一方でそれをやり過ぎることで開発メンバーのプロダクトオーナーシップを遠ざけてしまう。プロダクトオーナーシップをもっていない開発者が休出してまで開発に尽力する意味など普通にはない。仮に私が開発メンバーでもそう思うだろう。<a href=/diary/posts/2023/0310/>昔の上長</a> がやっていたことをみて私が学んだことを、外部の人間として開発メンバーに教えることはとても難しいことを理解できた。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0415/>休出デバッグ</a></h1><div class=post-meta><span class=post-date>2023-04-15 (Sat.)</span></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/gpt/>gpt</a>&nbsp;
#<a href=/diary/tags/debug/>debug</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#ストレッチ>ストレッチ</a></li><li><a href=#淡路牛の受け取り>淡路牛の受け取り</a></li><li><a href=#openldap-の-overlay-のデバッグ>openldap の overlay のデバッグ</a></li></ul></nav></div><div class=post-content><p>昨日は久しぶりに飲みに行っきて1時に寝て8時に起きた。</p><h2 id=ストレッチ>ストレッチ</h2><p>外がだいぶ暖かくなってきて散歩に行く機会も増えてきた気がする。今日の開脚幅は開始前157cmで、ストレッチ後159cmだった。先週と違って今週は忙しくて座っている時間が大幅に増えた。そして、その分の右腰の張りは強かった。腰の張り具合はその週の忙しさや労働時間で推測できるぐらいにはわかってきた。それ以外はだいたい可もなく不可もなくな感じだったと思う。</p><h2 id=淡路牛の受け取り>淡路牛の受け取り</h2><p>姉からお肉が届くという連絡があったので日時を調整して受け取った。<a href=https://www.awajikoku.com/shimasalad/2022/12/04/20221204094613/>島サラダフェア2022</a> という懸賞に応募していたのが当たったらしい。5000円相当の淡路牛らしい。お正月に食べるようなお肉だと言えば伝わるかな。A賞の5名のうちの1人がここにいるので総応募数は推して知るべし。姉が言うには全然応募ないらしい。こういうの調べて真面目に応募してメルカリで売るみたいなことやったらそれなりに儲かるのかもしれない。運営はマーケティングのやり方を変えた方がいいんじゃないかとか心配になって話していた。</p><figure><img src=/diary/img/2023/0415_awaji-beef.jpg></figure><h2 id=openldap-の-overlay-のデバッグ>openldap の overlay のデバッグ</h2><p>午後から昨日の続き。<a href=https://openai.com/blog/chatgpt>chatgpt</a> と一緒に openldap サーバーのカスタム overlay モジュールのデバッグをしていた。昨日の時点では2つの問題があることを確認できていた。今日は個々の問題の詳細をデバッグしながらワークアラウンドとして動かすためのコードを書いた。1つはビルドの問題じゃないかと思える不可思議な現象が起きていて、もう1つは openldap の ppolicy の仕様とカスタム overlay モジュールの仕様のどちらが正しいのかを設計者に確認する必要がある。15年ぶりぐらいに c 言語のコードを書いている。かなり怪しいけど、gdb をインタラクティブな repl のようにして振る舞いを確認しながら書いている。カスタム overlay モジュールでエラーが発生すると openldap はその処理をスキップするようにみえて、なんのログも出ない。細かくログ出力してどこまで動いたのかを確認しながら開発するとよさそうな雰囲気がわかった。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0414/>oss な開発は chatgpt が猛威を振るう予感</a></h1><div class=post-meta><span class=post-date>2023-04-14 (Fri.)</span></div><span class=post-tags>#<a href=/diary/tags/ldap/>ldap</a>&nbsp;
#<a href=/diary/tags/gpt/>gpt</a>&nbsp;
#<a href=/diary/tags/debug/>debug</a>&nbsp;
#<a href=/diary/tags/tax/>tax</a>&nbsp;
#<a href=/diary/tags/drinking/>drinking</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#chatgpt-と一緒にデバッグ>chatgpt と一緒にデバッグ</a></li><li><a href=#近況報告>近況報告</a></li></ul></nav></div><div class=post-content><p>2時に寝て6時半に起きた。開発の追い込みが佳境に入ってきて集中力が増してきた。</p><h2 id=chatgpt-と一緒にデバッグ>chatgpt と一緒にデバッグ</h2><p>openldap サーバーの拡張の仕組みに <a href=https://www.openldap.org/doc/admin24/overlays.html>Overlays</a> がある。c 言語でカスタム overlay を実装することで openldap サーバーに任意のフック処理を実装できる。いまやっていることはパスワードの追加や更新をフックしてそのパスワードを id 連携するためのモジュールを開発している。というか、開発済みだと聞いていたモジュールが意図したように動かないのでデバッグしている。例えば <code>ppolicy</code> という overlay を使って次のように設定すると、平文で送ったパスワードをディレクトリサービスの db へ格納する前に平文からパスワードをハッシュ化してくれる。この変換はパスワード変更を overlay でフックして実装されている。</p><pre tabindex=0><code>overlay ppolicy
ppolicy_hash_cleartext on
</code></pre><p>overlay は slapd.conf に設定した順番に実行されるようで、それぞれの overlay に依存関係がある場合は実際の処理にも影響がある。そんな openldap サーバーの拡張モジュールの開発を引き継ぐことになったが、私がまったく openldap サーバーのことをわかっていないので <a href=https://openai.com/blog/chatgpt>chatgpt</a> を使って理解しながらデバッグしている。これがそれなりにうまくいっていて調査が捗った。但し、chatgpt が教えてくれたことなので完全に正しいかどうかの保証がない。振る舞いで検証できるものはともかく、そうじゃないものは最後に有識者に正しいかどうかを確認する必要がある。</p><p>例えば、次のような ldif エントリーをサンプルとして、パスワードは <code>userPassword</code> という属性で扱う。ここで <code>userPassword</code> だけコロンが2重 (<code>::</code>) になっていることがわかる。これは属性の値が base64 でエンコーディングされていることを意味している。こういった2重コロンのような短いキーワードを検索で調べるのは難しい。chatgpt ならピンポイントに答えてくれる。</p><pre tabindex=0><code>dn: uid=jdoe,ou=users,dc=example,dc=com
objectClass: top
objectClass: person
objectClass: organizationalPerson
objectClass: inetOrgPerson
uid: jdoe
cn: John Doe
givenName: John
sn: Doe
mail: jdoe@example.com
userPassword:: e1NTSEF9bm9ZMU5kdzN3WUdSbFhpdDJUaTY5UW9SeXpXaklEeXc=
</code></pre><p>openldap は oss だし、ドキュメントもインターネット上にあるので構造体の定義や c 言語のサンプルコードも書いてくれる。それらが完全に正しいか、私には判断できないが、openldap のソースコードで調査するところの当たりをつけるには十分な情報を返してくれる。カスタム overlay を開発するときの主要なエントリーポイントと ldap 操作のタグ名は次になる。</p><ul><li>bi_op_bind: バインド（認証）操作に対応するエントリーポイント、LDAP_REQ_BIND</li><li>bi_op_search: 検索操作に対応するエントリーポイント、LDAP_REQ_SEARCH</li><li>bi_op_compare: 比較操作に対応するエントリーポイント、LDAP_REQ_COMPARE</li><li>bi_op_modify: 修正（属性の追加、削除、変更）操作に対応するエントリーポイント、LDAP_REQ_MODIFY</li><li>bi_op_modrdn: エントリ名の変更 (MODIFY RDN) 操作に対応するエントリーポイント、LDAP_REQ_MODRDN</li><li>bi_op_add: エントリの追加操作に対応するエントリーポイント、LDAP_REQ_ADD</li><li>bi_op_delete: エントリの削除操作に対応するエントリーポイント、LDAP_REQ_DELETE</li><li>bi_op_abandon: 中止操作に対応するエントリーポイント、LDAP_REQ_ABANDON</li><li>bi_op_extended: 拡張操作に対応するエントリーポイント、LDAP_REQ_EXTENDED</li></ul><p>例えば、LDAP_REQ_ADD は ldap.h で次のように定義されている。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#define LDAP_REQ_ADD        ((ber_tag_t) 0x68U) </span><span style=color:#75715e>/* application + constructed */</span><span style=color:#75715e>
</span></span></span></code></pre></div><p>これを gdb でデバッグしてタグを確認するときは次のように Operation 構造体内の o_tag をチェックすればよい。gdb で16進数表示するときは <code>/x</code> を指定する。</p><pre tabindex=0><code>(gdb) print /x op-&gt;o_tag
$8 = 0x68
</code></pre><p>ppolicy よりも前にカスタム overlay を設定すれば平文のパスワードにアクセスできそうにみえるのだけど、gdb でデバッグしているとハッシュ化済みのパスワードになっていた。</p><p>あと稼働している openldap サーバーに gdb で attach してデバッグする方法も chatgpt に聞きながら行った。やりたい操作に対して gdb のコマンドを教えてもらってすぐに検証してフィードバックからさらに質問できるのでインタラクティブな repl のような環境と chatgpt は相性がよいように思えた。gdb のコマンドを覚えておく必要も、ググる必要もないことに気付いた。</p><h2 id=近況報告>近況報告</h2><p>元同僚と <a href=/diary/posts/2022/0311/#近況報告>約1年ぶりの近況報告</a> の雑談会をしてきた。これで3回目かな。毎年の恒例行事のようになってきた。兵庫県の住みたい街ランキングでいつも上位にある <a href=https://www.nishi.or.jp/>西宮市</a> でカレーを食べて、バーで飲んできた。三ノ宮から西宮は快速で15分程度の距離。すぐ行ける場所なんだが、とくに行く機会がなかったので神戸に引っ越してきて5年以上経つのに電車で行ったのは今回が初めてになる。いつも通り近況を聞きながら、みんな私と同じぐらいの世代なので今後のキャリアの方向性などを話していた。</p><p>私は起業して税金やその仕組みに関心をもつようになり、起業する前より少し詳しくなった。知人から節税相談を受けることもある。税金の基本的な考え方として、1つの大きな収入に対して節税することはできない。自由に使えるお金がほしかったら基本的に節税できない。税金をたくさん払って貯金するしかない。一方で個人と会社に資産を分割したり、共済や基金を活用することで手取りの収入は減るが、支払う税金は少なくなって中長期でみると資産が増える。例えば、共済や基金に積み立てたお金は原則としては退職所得で戻ってくるので、ずっと優遇された <a href=https://www.nta.go.jp/taxes/shiraberu/taxanswer/shotoku/1420.htm>退職所得の所得税</a> により、最終的に支払う税金が少なくなるからである。これが税金を支払う基本的な考え方。自分の手元にお金を残した上で税金を払いたくないが、どうすればよいか？とよく聞かれるが、そんなことはできないというのが模範回答になる。元同僚も私もそうなのだが、もはや自分の生活にお金をあまり必要としていない。私が節税の仕組みを調べたり実践したりするのは、税金の仕組みを学ぶために過ぎない。ただ知識として学ぶよりも、実際に実践して運用してみる方が学びになる。</p><p>以前の <a href=/diary/posts/2023/0408/#もくもく会>出張もくもく会</a> の後で懇親会のときにそのうち資本主義は新しい制度にとって変わられるのではないかという話題があった。それは行き過ぎた資本主義の弊害と、資本主義である限り40時間/週の労働時間から抜け出すには資本家になるしかなくて、人類はすでにこれだけ技術があるのだからもっと多くの人が今よりも働かずに食べていけるのではないかと多くの人が考えている。私の場合も、実質は自分のやりたいことしかやってなくて、自分のために働きながらも、老後のために一応はお金をもらっておくみたいな働き方になっている。この考え方は資本主義の次の制度へ移行するときに活きてくればいいなと思う。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0413/>rpm のパッケージングを作り直す</a></h1><div class=post-meta><span class=post-date>2023-04-13 (Thu.)</span></div><span class=post-tags>#<a href=/diary/tags/linux/>linux</a>&nbsp;
#<a href=/diary/tags/rpm/>rpm</a>&nbsp;
#<a href=/diary/tags/packaging/>packaging</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#rpm-パッケージング再び>rpm パッケージング再び</a></li></ul></nav></div><div class=post-content><p>1時に寝て何度か起きてあまり眠れなかった。昨日は遅くに帰ってきて晩ご飯を遅くに食べたので寝ていて吐き気がしてうまく眠れなかった。寝る前に食べることはできないみたい。</p><h2 id=rpm-パッケージング再び>rpm パッケージング再び</h2><p><a href=/diary/posts/2023/0411/#ビルド問題の解決>ビルドができるようになったモジュール</a> を rpm でパッケージングする。rpm でのビルドもできる状態で渡してもらえたので私が開発したモジュールを追加してパッケージングを修正する。rpm のパッケージングを行うのも5年ぶりといったところ。コンテナに慣れてしまって rpm を使うことはもうないと思っていたけれど、まだまだ現役であることを実感する。spec ファイルは普通に読めるので既存の設定や、他の rpm パッケージの spec ファイルの記述などもみながら、自分のモジュールで必要な設定を追加していく。久しぶりだったわりには順調に作業が進捗して2-3時間もやっていて追加の修正をして、実際にインストールして動作確認もできた。</p><p>rpm のマクロを確認する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ rpm --eval <span style=color:#e6db74>&#34;%{_libdir}&#34;</span>
</span></span><span style=display:flex><span>/usr/lib64
</span></span></code></pre></div><p>あるサーバーサービスを systemd 経由で実行させる。内部的に環境変数を使っている。systemd の EnvironmentFile で環境変数を設定したファイルへのパスを指定できる。例えば、次のように EnvironmentFile にパスを設定する。</p><pre tabindex=0><code>[Service]
Type=simple
EnvironmentFile=/opt/path/to/my.env
ExecStart=/opt/path/to/bin/my-service
KillMode=process
StartLimitBurst=2
Restart=on-abnormal
User=ldap
Group=ldap
</code></pre><p>この環境変数にはパスワードのような機密情報も含むので rpm の %files で root 権限でのみ読めるようにアクセス制限を設定する。systemd 自体は root 権限で動くので環境変数の設定は root が行って my-service は ldap のユーザー／グループ権限で動く。</p><pre tabindex=0><code>%attr(600,root,root) %config(noreplace) %{_sysconfdir}/path/to/my.env
</code></pre><blockquote class=twitter-tweet><p lang=ja dir=ltr>もう rpm なんか古の技術で自分で作ることなんか今後はないやろと思っていた。5年ぶりぐらいに、いま rpm でパッケージングしていて、spec ファイルを普通に読めるので簡単なパッケージングぐらいはすぐできる。なんでもやっといたら役に立つもんやと思ったりもする。</p>&mdash; Tetsuya Morimoto (@t2y) <a href="https://twitter.com/t2y/status/1646540939740213248?ref_src=twsrc%5Etfw">April 13, 2023</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0412/>ローカルのゲスト os に開発環境を作る</a></h1><div class=post-meta><span class=post-date>2023-04-12 (Wed.)</span></div><span class=post-tags>#<a href=/diary/tags/virtualization/>virtualization</a>&nbsp;
#<a href=/diary/tags/cli/>cli</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#vagrant-再び>vagrant 再び</a><ul><li><a href=#vagrant-にポートフォワーディングの設定を追加>vagrant にポートフォワーディングの設定を追加</a></li><li><a href=#scp-でファイルを転送>scp でファイルを転送</a></li></ul></li></ul></nav></div><div class=post-content><p>0時に寝て7時に起きた。いろいろうまくいってない。</p><h2 id=vagrant-再び>vagrant 再び</h2><p>rpm でパッケージングされた openldap サーバーの動作検証をするために vagrant で <a href=https://app.vagrantup.com/rockylinux/boxes/8>rockylinux/8 Vagrant box</a> の環境を構築する。 rockylinux 8 だと次のようなエラーが発生した。</p><pre tabindex=0><code>VBoxManage: error: Failed to open OVF file &#39;path/to/.vagrant.d/boxes/rockylinux-VAGRANTSLASH-8/7.0.0/virtualbox/box.ovf&#39; (VERR_FILE_NOT_FOUND)
</code></pre><p>既知のバグとして次の forum にワークアラウンドが書かれている。</p><ul><li><a href=https://forums.rockylinux.org/t/vagrant-box-rockylinux-8-fails-for-virtualbox-provider-with-error-vbox-e-object-not-found/8228/4>Vagrant box rockylinux/8 fails for virtualbox provider with error VBOX_E_OBJECT_NOT_FOUND</a></li></ul><p>uefi なマシンのせいなのかな？詳細を理解していないけど Vagrantfile を次のようにする。</p><pre tabindex=0><code>Vagrant.configure(&#34;2&#34;) do |config|
  config.vm.box = &#34;rockylinux/8&#34;
  config.vm.provider &#34;virtualbox&#34; do |domain|
    domain.customize [&#34;modifyvm&#34;, :id, &#34;--firmware&#34;, &#34;efi&#34;]
  end
end
</code></pre><p>修正済みのイメージをダウンロードするようにメタデータを作成する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ vi box-metadata.json
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;name&#34;</span> : <span style=color:#e6db74>&#34;rockylinux/8&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;description&#34;</span> : <span style=color:#e6db74>&#34;Rocky Linux 8 7.0.0 Bugfix&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;versions&#34;</span> : [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;version&#34;</span> : <span style=color:#e6db74>&#34;7.0.1-20221213.0&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;providers&#34;</span> : [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;name&#34;</span> : <span style=color:#e6db74>&#34;virtualbox&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;url&#34;</span> : <span style=color:#e6db74>&#34;http://dl.rockylinux.org/pub/rocky/8/images/x86_64/Rocky-8-Vagrant-Vbox-8.7-20221213.0.x86_64.box&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      ]
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>再度 vagrant の環境を作り直す。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ vagrant box add box-metadata.json
</span></span><span style=display:flex><span>$ rm -rf .vagrant/  <span style=color:#75715e># 古い設定を削除</span>
</span></span><span style=display:flex><span>$ vagrant up
</span></span></code></pre></div><p>vagrant を使うのも4年ぶりになるかな。コンテナに慣れてしまうと久しぶり感がある。使い方を忘れていて調べながらやってた。</p><h3 id=vagrant-にポートフォワーディングの設定を追加>vagrant にポートフォワーディングの設定を追加</h3><pre tabindex=0><code>$ vi Vagrantfile
...
  config.vm.network &#34;forwarded_port&#34;, guest: 389, host: 1389   # ldap
  config.vm.network &#34;forwarded_port&#34;, guest: 636, host: 1636   # ldaps
...
</code></pre><p>これでホスト os からゲスト os へ接続できる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>==&gt; default: Forwarding ports...
</span></span><span style=display:flex><span>    default: 389 (guest) =&gt; 1389 (host) (adapter 1)
</span></span><span style=display:flex><span>    default: 636 (guest) =&gt; 1636 (host) (adapter 1)
</span></span><span style=display:flex><span>    default: 22 (guest) =&gt; 2222 (host) (adapter 1)
</span></span></code></pre></div><p>ここでは ldap サーバーに対して <a href=https://directory.apache.org/studio/>Apache Directory Studio</a> で接続できるように ssh のポートフォワーディングを設定している。</p><h3 id=scp-でファイルを転送>scp でファイルを転送</h3><p>config を出力する。ssh の秘密鍵へのパス設定をしてくれるので scp のオプションに指定しなくて済む。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ vagrant ssh-config &gt; ssh.config
</span></span></code></pre></div><p>ポート番号も config に記載されているけれど、それは指定しないと scp できなかった。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ scp -P <span style=color:#ae81ff>2200</span> -F ssh.config path/to/myfile vagrant@localhost:
</span></span></code></pre></div><p>vagrant ユーザーのパスワードも聞かれて vagrant を指定すればコピーできた。config を作ってもあまり便利ではなかった。</p><p><a href=https://github.com/invernizzi/vagrant-scp>vagrant-scp</a> というプラグインがあるのでインストールしてみる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ vagrant plugin install vagrant-scp
</span></span></code></pre></div><p>次のようにして使う。この方が簡単。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ vagrant scp path/to/myfile ./  <span style=color:#75715e># 仮想マシンのホームディレクトリにコピーされる</span>
</span></span></code></pre></div></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0411/>リリースまで残り2週間</a></h1><div class=post-meta><span class=post-date>2023-04-11 (Tue.)</span></div><span class=post-tags>#<a href=/diary/tags/project-management/>project management</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#ビルド問題の解決>ビルド問題の解決</a></li></ul></nav></div><div class=post-content><p>0時に寝て4時に起きて6時半に起きた。最近は以前より眠れるようになりつつある。今日は定例会議とバグ調査とコードレビューと検証をしていたらすぐに1日終わってしまった。</p><h2 id=ビルド問題の解決>ビルド問題の解決</h2><p><a href=/diary/posts/2023/0309/>2月の上旬</a> から問題を認識していて、ある c 言語のモジュールが正常にビルドできない問題がようやく解決されてビルドできるようになった。<a href=https://www.gnu.org/software/libtool/>libtool</a> を使ってライブラリをビルドしていて、歴史的経緯からシンボル名の書き換えが必要だったみたい。2週間後にリリースされるモジュールの開発前の状態でビルドが通ったのがいまという状況。ここから私がそのモジュールに対して追加の開発を行う。本来の私のお仕事ではないけど、このモジュール開発の私が負う方がチームとしての成果が大きいと判断した。</p><p>ビルドができるようになるまで2ヶ月程待ったことになる。普通に考えたらリリース延期だが、担当者の割り当ての課題もあって、もうこれは不可抗力としてそのままリリースしようと思う。おそらく誰もこの件に関して本来の開発の在り方についての言及しないと私は考えている。おそらく品質も信頼できないものだと推測する。残りの2週間で追加の開発を一目散に駆けて成るように成るのを私も受け入れることにしようと思う。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0410/>サーバーサイド開発とセマフォ</a></h1><div class=post-meta><span class=post-date>2023-04-10 (Mon.)</span></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/rabbitmq/>rabbitmq</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#web-api-サーバーへの負荷テスト>web api サーバーへの負荷テスト</a></li></ul></nav></div><div class=post-content><p>0時に寝て7時に起きた。</p><h2 id=web-api-サーバーへの負荷テスト>web api サーバーへの負荷テスト</h2><p>web api サーバーへ数百から数千件の同時リクエストを送ってエラーが発生しないことを確認する。チームのメンバーがテストを実施していたら producer がメッセージを送信するときに rabbitmq との接続エラーがいくつか発生した。いくつか対応方法を考えられるが、既存のコードを大きく変更せず解決するものとしてセマフォを導入してみた。自分で作っても難しいものではないが、<a href=https://pkg.go.dev/golang.org/x/sync/semaphore>golang.org/x/sync/semaphore</a> で準標準パッケージとして提供されている。次のように簡単に使える。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>sem</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>semaphore</span>.<span style=color:#a6e22e>NewWeighted</span>(<span style=color:#a6e22e>maxConcurrentSessions</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ctx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>()
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sem</span>.<span style=color:#a6e22e>Acquire</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#ae81ff>1</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>sem</span>.<span style=color:#a6e22e>Release</span>(<span style=color:#ae81ff>1</span>)
</span></span></code></pre></div><p>これで rabbitmq との同時接続数を制御する。rabbitmq 側もどのぐらいの接続を受け付けるかは <a href=https://www.rabbitmq.com/networking.html>Networking and RabbitMQ</a> を参照して設定で制御できる。デフォルトは 128 となっているので 1024 ぐらいまで増やしてみた。</p><p>サーバーサイド開発のおもしろさの1つとしてボトルネックは移動するという概念がある。必ずどこかにニーポイント (ボトルネック) は現れるので意図したパフォーマンスや負荷を耐えるようにリソース制限をしてサーバーが堅牢になるよう調整する。この手の作業はサーバーサイドエンジニアをやってきた私の得意とするところ。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0409/>ubuntu の環境構築</a></h1><div class=post-meta><span class=post-date>2023-04-09 (Sun.)</span></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/linux/>linux</a>&nbsp;
#<a href=/diary/tags/device/>device</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#ストレッチ>ストレッチ</a></li><li><a href=#ubuntu-2204-lts-の環境構築>ubuntu 22.04 lts の環境構築</a></li></ul></nav></div><div class=post-content><p>0時に寝て8時に起きた。昨日は出張から遅くに帰ってきたのでバテた。</p><h2 id=ストレッチ>ストレッチ</h2><p>昨日はもくもく会で遅くに帰ってきたので毎週のストレッチを土曜日から日曜日に変更していた。ここ1-2ヶ月ほどでは最も調子がよかった。今週は出張していて普段より健康的な生活をしていた。というのは、お手伝い先のオフィスでは原則として私は9-18時でしか働けないため、業務の都合でずっと座りっぱなしにならない。例えば、自社のオフィスだとだいたい8時から始業して遅いと23時ぐらいまでずっと座りっぱなしになってしまう。たまたまホテルもいつもよりも離れた場所にとり、10分ほど歩く距離だったのでちょうどよかった。帰ってからホテルで2-3時間作業していたりもするのだが、それでも同じ姿勢でずっと座り続けている方が体にとってはよくないことがわかる。今日の開脚幅は開始前152cmで、ストレッチ後156cmだった。座っている時間が短かったために腰の張りはほとんどなかった。</p><h2 id=ubuntu-2204-lts-の環境構築>ubuntu 22.04 lts の環境構築</h2><p>先日 <a href=/diary/posts/2023/0325/#dell-マシンに-ubuntu-をインストール>マシンに ubuntu をインストールした</a> 続きの話し。東京出張があったり、開発の終盤でいろいろやっている中で開発環境を作り直すインセンティブが低かったので環境構築が遅くなった。過去の環境構築の issue が残っているのでそれをみながらやれば5-6時間もあれば作り直せた。結論から言って、マシンスペックが上がって、os も新しいものに変わったので開発環境としてはめちゃくちゃ快適になった。好みだが、私はリソースの潤沢なデスクトップマシンに linux をインストールして開発するのが一番しっくりくる。主観的に感情的にその構成が好きだというもの。</p><p>realforce の bluetooth キーボードの設定をするのにもう1つキーボードが必要なことに気付いた。私は <a href=http://www.bluez.org/>bluez</a> というツールを使って bluetooth キーボードのペアリングをしている。ペアリングするためには bluez の bluetoothctl という cli から操作してペアリングを行う。realforce のキーボードは有線/bluetooth 接続を両方同時につなぐことはできないため、bluetooth 接続するためには別のキーボードを接続して cli 操作しないといけない。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ bluetoothctl
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>bluetooth<span style=color:#f92672>]</span><span style=color:#75715e># power on</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>bluetooth<span style=color:#f92672>]</span><span style=color:#75715e># agent on</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>bluetooth<span style=color:#f92672>]</span><span style=color:#75715e># scan on</span>
</span></span></code></pre></div><p>bluetooth キーボードから接続要求を送る。</p><pre tabindex=0><code>...
[NEW] Device F6:9D:A5:41:B7:1F REALFORCE_2
...
[bluetooth]# info F6:9D:A5:41:B7:1F
Device F6:9D:A5:41:B7:1F (random)
	Name: REALFORCE_2
	Alias: REALFORCE_2
	Appearance: 0x03c1
	Icon: input-keyboard
	Paired: no
	Trusted: no
	Blocked: no
	Connected: no
	LegacyPairing: no
	UUID: Human Interface Device    (00001812-0000-1000-8000-00805f9b34fb)
	RSSI: -51
</code></pre><p>マシンからデバイスを検出したらデバイス情報を確認してペアリングを実行する。</p><pre tabindex=0><code>[bluetooth]# pair F6:9D:A5:41:B7:1F
Attempting to pair with F6:9D:A5:41:B7:1F
[CHG] Device F6:9D:A5:41:B7:1F Connected: yes
[agent] Passkey: ***
</code></pre><p>これでペアリングが実行されて bluetooth 接続できるようになる。ubuntu 20.04 lts の頃より進化しているのは接続／切断時に電池の残量も表示されるようになった。キーボードには充電池を使っているので地味に嬉しい。残量が少なくなってきたら帰るときに充電を仕掛けて帰れる。</p><p>今回の環境構築で1つはまったものがある。vagrant の仮想環境として virtualbox を使う。<a href=https://wiki.ubuntu.com/UEFI/SecureBoot>secure boot</a> のために virtualbox をインストールするときにパスワードを mok (Machine-Owner Key) に登録しないといけない。この作業手順が分からなくて右往左往していた。インストール時に mok のダイアログが表示されてパスワードを登録するが、この後に os を再起動して bios 起動時に特別なダイアログが表示されて mok に登録したいパスワードを入力する。アプリケーションのインストール時に bios の設定が必要という概念が私の頭の中になくて分からなかった。これをやらないと virtualbox サービスが正常に起動しない。調べていると ubuntu 標準の virtualbox は壊れていて 3rd party の contrib なパッケージを使えという古い記事も出てくる。22.04 なら ubuntu 標準の virtualbox でも問題なく、mok の登録後に systemd から virtualbox サービスが起動することを確認した。再起動後の mok のダイアログは1度しか出てこないのでうっかり見逃してしまったら再設定しないといけない。次の cli で再設定できる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo dpkg-reconfigure virtualbox-dkms
</span></span></code></pre></div><blockquote class=twitter-tweet><p lang=ja dir=ltr>dell の xps 8950 に ubuntu 22.04 lts をインストールして開発環境を一通り構築した。ほとんどトラブルなく構築できた。いろいろ快適になったので集中力が上がる。開発の追い込みなのでちょうどよい。</p>&mdash; Tetsuya Morimoto (@t2y) <a href="https://twitter.com/t2y/status/1646055812224417792?ref_src=twsrc%5Etfw">April 12, 2023</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0408/>気分転換のもくもく会</a></h1><div class=post-meta><span class=post-date>2023-04-08 (Sat.)</span></div><span class=post-tags>#<a href=/diary/tags/event/>event</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#the-b-水道橋>the b 水道橋</a></li><li><a href=#もくもく会>もくもく会</a></li></ul></nav></div><div class=post-content><p>0時に寝て4時に起きて6時に起きてだらだらして7時半から広いお風呂入ってきた。</p><h2 id=the-b-水道橋>the b 水道橋</h2><p>昨日は <a href=https://www.theb-hotels.com/theb/suidobashi>the b 水道橋</a> に宿泊した。the b というホテルブランドらしい。初めて宿泊した。あまり新しい施設ではないし、部屋も狭かったけれど、受付でアイスクリームが無料というサービスをしていたり、大浴場があったりと限られたリソースでがんばろうとしている雰囲気がみえておもしろいホテルだと思う。値段も他のビジネスホテルより少し割安だった。水道橋駅から10分ほどだとは思うが、微妙に歩く立地が割安にしているのではないかと思う。水道橋はどこに行くにもアクセスがよいのでよい場所だと思う。晩ご飯に近くの <a href=https://tabelog.com/tokyo/A1310/A131003/13213953/>つどい酒場えすと。</a> という居酒屋にふらっと入ったらよいお店だった。お店もほぼ満席だった。部屋は普通もしくは手狭なのだけど、全体としてはよい宿泊体験だったと思う。また機会があったら泊まるかもしれない。</p><h2 id=もくもく会>もくもく会</h2><p><a href=https://kazamori.connpass.com/event/277481/>出張もくもく会</a> を開催した。3月は週末にお仕事していなければバテて家で寝ているといった、あまりよくない状態だったので気分転換も兼ねてのもくもく会だった。いつもと違う場所、違う人たちとやり取りすることそのものがマンネリを解消する上でもよかったように思う。12人が参加してくれた。20人ぐらいが入れる広い場所を借りてみたものの、思ったより集まらなかった。前回来てくれた方たちも何人かいた。レンタルスペースなので参加費いらないですか？と問い合わせしてくれた方もいた。もくもく会イベントはうちの会社の交際費を使う手段の1つでもある。</p><p>会場は <a href=https://www.instabase.jp/space/2544621780>VILLENT 秋葉原</a> というレンタルスペースを借りた。10時00分から17時30分まで7.5時間を借りて税込20,988円。<a href=/diary/posts/2023/0109/#もくもく会>前回の会場</a> は定員が10人なものの、窮屈で狭かったため、今度は広い場所を借りることにした。定員は24人なものの参加者は私を含めて13人だった。だいたい4人座れる机に2人ずつ、たすきに座ってスペース的には余裕があってちょうどよかった。次回またもくもく会をやるときは20人ぐらいのスペースに対して10人程度の募集にしようと思う。</p><p>会場はサイトの写真をみて想像したよりも汚い (古い) 施設だった。あとで参加者と話していて借りるときに google map でビルの外観をみればいいと教えてもらった。電源タップはないと書いてあったが棚を探すと3つほど見つけた。インターネット接続にちょっとしたトラブルがあった。wifi ルーターには接続できるけど、インターネットにアクセスできない。あれー？と思って問い合わせしたら自動音声でルーターの電源の on/off を試せと流れて、wifi ルーターを探してみたら、その後ろに置いてあった onu (光回線終端装置) の電源が入ってなかった。wifi ルーターだけ電源が入っていて onu だけ電源を切ることはないと思うので前に使った人たちのいたずらかもしれない。くそーって気分だった。wifi 速度は7人接続している状態で240Mbpsほどあったので十分に速かった。</p><p>あとで施設のレビューをみてみると「清潔感」が 4.0 と低くはないけれど、他の項目に比べて明らかに低い点数となっている。私ならこの項目に 3.0 をつけるかなと思う。価格が割安なのでそんなものと言えるが、特定の項目だけ統計の値が低いのならなにか理由があると考えてよいということを学んだ。ちなみにそれでも 4.0 と点数が高いのはすべての項目を 5.0 に付けているレビューアがいるためだと考えられる。ちゃんと点数を付けているレビューアは 2.0-4.0 を付けていたようにみえる。</p><figure><img src=/diary/img/2023/0408_review.png></figure><p>午前中に10人ほど参加して、午後から2人参加して、参加者の大半は web 系の人たちにみえた。午後から来た2人組は期待したものと違ったのか1-2時間作業してすぐに帰られた。窓を開けておくと周りの工事の音が少し騒々しい。途中で少し寒いということで窓を閉めたら騒音はそれほど気にならなくなった。私は日記を書いたり、お仕事のドキュメントを書いたりしていた。図書館で勉強するような雰囲気になっていて作業に集中できてよかった。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0407/>一日中リファクタリング</a></h1><div class=post-meta><span class=post-date>2023-04-07 (Fri.)</span></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/docker/>docker</a>&nbsp;
#<a href=/diary/tags/mongodb/>mongodb</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#mongodb-のコネクションプール>mongodb のコネクションプール</a></li><li><a href=#docker-hub-の-pull-制限>docker hub の pull 制限</a></li></ul></nav></div><div class=post-content><p>0時に寝て7時に起きた。昨日は夜にホテルで作業しようと思いながらテレビをみているうちに寝落ちしてた。朝から夜までずっとリファクタリングのためにコードを書いたり、コンテナ環境の設定を変更したりしていた。</p><h2 id=mongodb-のコネクションプール>mongodb のコネクションプール</h2><p>MongoDB Drivers の <a href=https://www.mongodb.com/docs/drivers/go/current/fundamentals/connection/#connection-example>Connection Example</a> に次のようなことが書いてある。</p><blockquote><p>Reuse Your Client</p><p>We recommend that you reuse your client across sessions and operations. You can use the same Client instance to perform multiple tasks, instead of creating a new one each time. The Client type is safe for concurrent use by multiple goroutines. To learn more about how connection pools work in the driver, see the <a href=https://www.mongodb.com/docs/drivers/go/current/faq/#std-label-golang-faq-connection-pool>FAQ</a> page.</p></blockquote><p>mongodb drivers の client は goroutine safe なので再利用することを推奨している。内部的にはコネクションプールをもっていて mongodb とのコネクションを再利用できる。具体的にはライブラリ内部に次のようなコードがみつかる。context にセッション情報があればそれを使い、なければクライアントの sessionPool (コネクションプール) を使ってセッションを取得して mongodb にアクセスする関数の終わりで終了処理を行う。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>sess</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sessionFromContext</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sess</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>coll</span>.<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>sessionPool</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sess</span> = <span style=color:#a6e22e>session</span>.<span style=color:#a6e22e>NewImplicitClientSession</span>(<span style=color:#a6e22e>coll</span>.<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>sessionPool</span>, <span style=color:#a6e22e>coll</span>.<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>id</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>sess</span>.<span style=color:#a6e22e>EndSession</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>既存のコードはコネクションプールのことを考慮していないコードになっていたので大きくリファクタリングして効率化した。</p><h2 id=docker-hub-の-pull-制限>docker hub の pull 制限</h2><p>午前中はリファクタリング、午後は docker compose 環境の変更と再構築、午後はバグ修正と一日中 docker image を取得する作業をしていた。gitlab ci/cd が動くとテストと docker image 生成の処理が動くのでその過程で関連する docker image を pull する。夕方になって gitlab ci/cd で初めて次のエラーが発生することに気付いた。前にお手伝いしていた職場でもそういう現象が起こると聞いて、docker login するコードを github actions のスクリプトに追加していたので、rate limit がかかることは知っていた。</p><pre tabindex=0><code>You have reached your pull rate limit. You may increase the limit by authenticating and upgrading: https://www.docker.com/increase-rate-limits.
</code></pre><p><a href=https://www.docker.com/increase-rate-limits/>Understanding Your Docker Hub Rate Limit</a> によると、6時間あたり匿名アクセスは100、
free ユーザーは200を上限としているらしい。匿名アクセスは ip アドレスでカウントしているのだろうから場合によっては会社内からのアクセスをすべてカウントされたりするかもしれない。課金するとこの上限が24時間あたり5000になる。docker hub のプライベートリポジトリを利用する意図で team プランの課金を検討していたが、docker hub のアクセス制限を緩和するために課金する必要があるかもしれない。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0406/>リリース後の展望</a></h1><div class=post-meta><span class=post-date>2023-04-06 (Thu.)</span></div><span class=post-tags>#<a href=/diary/tags/project-management/>project management</a>&nbsp;
#<a href=/diary/tags/issue-management/>issue management</a>&nbsp;
#<a href=/diary/tags/communication/>communication</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#プロジェクトの進捗報告>プロジェクトの進捗報告</a></li></ul></nav></div><div class=post-content><p>0時に寝て7時半に起きた。そろそろ出張バテしてきた。</p><h2 id=プロジェクトの進捗報告>プロジェクトの進捗報告</h2><p>出張したときの月例報告の5回目。<a href=/diary/posts/2023/0309/>前回の進捗報告はこちら</a> 。私のマネジメントの不手際で1ヶ月延期 (元の計画通り) して、未だに開発は完了していないものの、今月末にリリースできる見通しでプロジェクトを進めている。おそらくあと1-2回は私が休出するのだろう。これからメンバーにはできる限りの QA テストを3週間に渡って行ってもらう。</p><p>チームが fix した3月の issue 数は47、そのうちの34を、enhance ラベルが付いたものは12でそのうちの9を私が担当した。クリティカルパスになりそうなものは、一旦はメンバーにアサインするものの、進捗をみて遅れていれば私が issue を引き取って対応している。先月から引き続き、やばそうな芽が出てきたら私が本気出して対応する。見た目上のスケジュールには影響を与えないようにしている。先月の反省で早めに引き取ることにしたのでずるずる後ろへ延びることはない。このやり方をすると、私がボトルネックになりかねないが、私の工数は調整次第でメンバーよりも大きくできるのでいまのところ問題ない。リリースまで1ヶ月を切った中で取り得る手段は限られてくる。</p><p>2月から <a href=/diary/posts/2023/0202/#ハドルと雑談>ハドルと雑談</a> の試験運用をしていた。ほぼ毎日午前中は私が slack のハドルに在籍 (オフィスアワーに近い取り組み) するようにして、メンバーから雑談する機会は増えるかどうかを試していた。約2ヶ月やって結果は次の通りとなった。</p><ul><li>対象日数: 34日</li><li>雑談人数: 10人</li><li>雑談時間: 5.75時間</li></ul><p>3日に1日ぐらい軽く雑談するといった結果になった。おそらく私がハドルにいなかったら話す機会はなかったのでこの価値をどう見積もるかは人によって分かれると思う。うちのチームはリモートワークが中心なので雑談する機会があるほど望ましい。それほど強く提案するわけではないが、slack のハドル活用をもっと展開してもよいのではないかと経営者に推奨した。</p><p>聞いた話では着任前にこのプロダクト開発は2年近く迷走していたらしい。それによって要件は整理されていたと言える。私がこの半年でリリース (予定) できる状態にしたのを評価してもらえているようにはみえる。余談だが、自分のスキルを社会の役に立てられるのがいまは嬉しい。前職では、誰でもできる簡単なお仕事しかできず、開発もあまりつまらなかった。いまは自分がよいと思うものを一定の裁量で判断し、さらにマネージャー経験も積めて、今回のお仕事は私の中でも達成感は高い方でもある。</p><p>あとは今後の開発の話し、販売戦略の話しなどもしていた。4月末で初期開発の区切りもつく。今後は毎月1週間も出張しなくてよいのではないかという話しもして、5月は会議を2-3日に集中してやったらいいんじゃないかということになった。出張はそろそろ疲れてきたのと、私がオフィスにいてもメンバーは半分以上リモートワークなのでオフィスに来る意義があまりない。うちのチームはリモートワークで開発に支障が出ない仕組みを構築できているとは思う。</p></div></div><div class=pagination><div class=pagination__buttons><a href=/diary/page/43/ class="button previous"><span class=button__icon>←</span>
<span class=button__text>最近の日記</span>
</a><a href=/diary/page/45/ class="button next"><span class=button__text>過去の日記</span>
<span class=button__icon>→</span></a></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2024 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>