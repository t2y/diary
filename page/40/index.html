<!doctype html><html lang=en><head><meta name=generator content="Hugo 0.109.0"><title>forest nook</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content="t2y"><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="forest nook"><meta property="og:description" content><meta property="og:url" content="/diary/"><meta property="og:site_name" content="forest nook"><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/index.xml rel=alternate type=application/rss+xml title="forest nook"></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><div class=posts><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0726/>ストーリーポイントの運用と現実</a></h1><div class=post-meta><span class=post-date>2022-07-26 (Tue.)</span></div><span class=post-tags>#<a href=/diary/tags/scrum/>scrum</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#ストーリーポイント再考>ストーリーポイント再考</a></li></ul></nav></div><div class=post-content><p>0時に寝て6時に起きた。</p><h2 id=ストーリーポイント再考>ストーリーポイント再考</h2><p>スクラムのふりかえりイベントでストーリーポイントの見直しをしようという話題が出た。この半年ほどストーリーポイントを使って実際に開発をやった事実から整理してみる。</p><ul><li>開発者のタスクも非開発者のタスクも同じ尺度のストーリーポイントを設定していた</li><li>あるチケットのタスクをやっていてチケット分割すると、最低でもストーリーポイントが1増えていた<ul><li>元チケットと分割したチケットのストーリーポイントの総数が同じであれば問題はないが、ストーリーポイント1が設定されたチケットを2つに分割するとそれぞれにストーリーポイント1をセットしても2倍になってしまう。タスク分割したのにストーリーポイントをゼロにセットするのもなんか違う</li></ul></li><li>ストーリーポイントの数値からバーンダウンチャートを生成した (みえる化)<ul><li>このバーンダウンチャートで運用して実際に2回の延期が発生し精度が低いことがわかった<ul><li>納期の2週間前に延期することがわかった</li><li>シニア開発者の勘と経験の方が精度が高かった</li></ul></li></ul></li></ul><p>これらの事実から私の所感をまとめてみる。</p><ul><li>開発者と非開発者 (プロダクトオーナー) の業務を同じ数値で表して合算するのは論理的におかしい</li><li>複雑な業務の開発プロジェクトでストーリーポイントの数値を設定するのは難しい<ul><li>複数のマイクロサービスを担当</li><li>複数の技術領域を担当 (インフラ、フロントエンド、バックエンド、要件定義)</li></ul></li><li>チケット駆動開発と相性が悪い<ul><li>チケット分割は担当者がタスクを完了させやすい粒度や内容で分割すればよかったのがストーリーポイントを考慮すると複雑さが増す</li><li>チケットの粒度はチームで統一されているのが理想的ではあるが、現実的にそのような運用の統制が取れているのを私はみたことがない<ul><li>チケットの粒度とストーリーポイントの合計に相関が出てしまい、それは個人差 (属人化) が生じやすい</li></ul></li></ul></li><li>安易なみえる化による弊害がある<ul><li>ストーリーポイントは開発の状況を表す指標の1つではあるが、現実をすべて表しているわけではない</li><li>多次元的なパラメーターからストーリーポイントというただ1つの指標を用いて2次元にすることで他の情報が欠落する<ul><li>偏ったデータによる意思決定に使われる懸念がある (その情報を外部に発信していればとくに)</li></ul></li></ul></li></ul><p>ストーリーポイントによる運用をうまくまわすにはいくつか制約があるように私からは思えた。</p><ul><li>開発プロジェクトのスコープや業務内容が一定の複雑さにおさめられる<ul><li>一定の制約や制限がないと論理的に説明可能な適切な数値を割り当てられない</li><li>例) 外部要因に影響をうけない1つのマイクロサービスを開発する</li><li>例) 開発者はフロントエンドだけの開発をする</li></ul></li><li>開発者と非開発者のタスクは別で管理する (合算しない)</li></ul></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0725/>メンテンナンス切り替えの設計</a></h1><div class=post-meta><span class=post-date>2022-07-25 (Mon.)</span></div><span class=post-tags>#<a href=/diary/tags/cdk/>cdk</a>&nbsp;
#<a href=/diary/tags/infrastructure/>infrastructure</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#waf-のカスタムレスポンス>waf のカスタムレスポンス</a></li></ul></nav></div><div class=post-content><p>0時に寝て6時に起きた。</p><h2 id=waf-のカスタムレスポンス>waf のカスタムレスポンス</h2><p>メンテンナンス時にエンドユーザーがアプリケーションにアクセスできないようにしたい。いろんなやり方があるけど、どういった手段で対応するのが最もシンプルで運用も容易かを少し前から頭を悩ませていた。</p><p>当初は cloudfront のディストリビューションをアプリケーションの assets とメンテナンスページの html の2つを作って、cdk のデプロイで切り替えできないかと考えた。cloudfront はドメイン名と密接に紐付いていて、同じドメイン名を2つのディストリビューションに設定することはできないようにみえる。あらかじめそれぞれのディストリビューションを2つ作っておいて route53 で必要に応じて向き先を切り替えるといった構成はできなかった。その次に waf について調べていたら waf がルールでカスタムレスポンスを返すことができることに気付いた。</p><ul><li><a href=https://aws.amazon.com/jp/blogs/news/customize-requests-and-responses-with-aws-waf/>AWS WAFによるリクエストとレスポンスのカスタマイズ</a></li></ul><p>ちょうどいまエンドユーザーからのアクセスは ipSet で許可し、それ以外のネットワークからのアクセスをブロックしていた。そのルールを更新して、メンテナンス時はエンドユーザーからのリクエストのみをブロックに変更してカスタムレスポンスを返せることに気付いた。waf を管理するスタックなら cdk デプロイで1分ぐらいで更新できた。このやり方のよいところの1つに開発者の ip アドレスを許可することで開発者だけはアクセスできるようにもできる。あと具体的に cdk でカスタムレスポンスをどう実装するかのドキュメントがわかりにくい。サンプルとしてはこんな感じ。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>acl</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>wafv2</span>.<span style=color:#a6e22e>CfnWebACL</span>(<span style=color:#66d9ef>this</span>, <span style=color:#e6db74>&#39;MyAcl&#39;</span>, {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>defaultAction</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>block</span><span style=color:#f92672>:</span> {} },
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;my-acl&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>scope</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;CLOUDFRONT&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>customResponseBodies</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>maintenanceInProgress</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>content</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;&lt;html lang=&#34;en&#34;&gt;Maintenance in progress&lt;/html&gt;&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>contentType</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;TEXT_HTML&#39;</span>,
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>rules</span><span style=color:#f92672>:</span> [{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>action</span><span style=color:#f92672>:</span> { 
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>block</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>customResponse</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>responseCode</span>: <span style=color:#66d9ef>503</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>customResponseBodyKey</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;maintenanceInProgress&#39;</span>,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>statement</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>ipSetReferenceStatement</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>arn</span>: <span style=color:#66d9ef>ipSet.attrArn</span>,
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }],
</span></span><span style=display:flex><span>});
</span></span></code></pre></div></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0724/>ホテル経営の本を読み終えた</a></h1><div class=post-meta><span class=post-date>2022-07-24 (Sun.)</span></div><span class=post-tags>#<a href=/diary/tags/book/>book</a>&nbsp;
#<a href=/diary/tags/founding/>founding</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#もてなしだけではもう食えない>もてなしだけではもう食えない</a><ul><li></li></ul></li></ul></nav></div><div class=post-content><p>0時に寝て7時に起きた。</p><h2 id=もてなしだけではもう食えない>もてなしだけではもう食えない</h2><p>読み終えた。あとで総評を書く。</p><h4 id=第10章-不動産屋の悪知恵>第10章 不動産屋の悪知恵</h4><p>2000年に改正された借地借家法38条の「定期借家」の条項から賃貸契約には2種類あるらしい。</p><ul><li>普通借家</li><li>定期借家</li></ul><p>普通借家は契約期間更新の概念があり、借り主が契約更新を拒否するには「正当な事由」が必要になる。一般的な賃貸マンションなどの契約も多くのケースでこちらの契約になる。ここでいう正当な事由とは、建物が老朽化して立て直す必要があるとか、貸し主がそこに住むといったものらしい。一方で定期借家は契約期間が終了すれば、一旦契約は終了してから新たに再契約するといった段取りになる。この定期賃貸借契約の条件を満たすには、契約期間更新の定めがないことを説明した書面を交付する必要がある。その書面がない場合はすべて普通借家とみなされるという。その是非を巡って争った最高裁の判例があるらしくググるとすぐに出てくる。当事者同士で双方の合意があったとしても説明書面がない場合は無効とするような判例となっている。これを逆手に取れば、普通借家として契約更新を主張できるというストーリー展開になっている。</p><ul><li><a href=https://hibiya-law.jp/posts/post2.html>■Q&A不動産の豆知識（定期建物賃貸借）－弁護士伊藤</a></li></ul><p>あとは PDCA サイクルのうち、日本の会社で一番弱いところはどこ？という話題が出てくる。Check だろう？という主人公の答えに、アドバイザーは Plan じゃないかと返す。Plan が曖昧だから Check できないという背景になっているのではないかと。一理あるかもしれない。日本人は気質として誰か1人が責任を担うのを嫌う文化があるように思う。個人の責任にしたくない・されたくないという空気から Check を曖昧にしたがる傾向があると私は考えている。</p><h4 id=第11章-エピローグ>第11章 エピローグ</h4><p>タイトルのままの章でホテル経営についてのアドバイスがあるわけではなく、ストーリ仕立てで展開してきた物語の結末や登場人物たちのその後のキャリアや展望などを紹介している。総じてハッピーエンドと言えるし、総じて人生の中のスナップショットとしてこんなもんとも言える。区切りがきてなんらかの結果が出たとしても、さらに人生は続くので日常が少し変わっていくだけといった展開になっていた。</p><h4 id=あとがき>あとがき</h4><p>著名なホテルの総支配人と著者との対談がある。読んでいて関心をもてたところは Job Description (職務分掌記述書) の重要性が説かれている。適正な評価、公平な人事、採用にも必要とされる。この考え方はメンバーシップ雇用を長く続けてきた日本の会社の年功序列とは大きな違いがあるため、制度設計の見直しは時間がかかるのだろうと思える。過去のしがらみがない新興企業が新たに制度設計して台頭していくのがよいのだろう。</p><p>また外資系という言葉に抵抗感のあるスタッフに対して「トヨタやファーストリテイリングは外資系ですか？日系ですか？」と尋ねるという話題も出てくる。そうすると、外資系や日系というグルーピングに意味がないことに気付く。その違いを対談の中ではグローバルかノングローバルかの違いでしかないと説明されている。ビジネスの規模や競合をグローバルの視野で考える必要があるかどうかによって変わってくるという。</p><blockquote><p>勝てる能力があってもその素地となる基礎体力がないと発揮できない。野球でも基礎体力があるから速い球を投げられる。</p></blockquote><p>これもホテル経営に限った話しではないなと思えた。私自身、昨今の開発チームをみていて感じることでもある。クラウドでアプリケーション開発が簡単になったがために基礎がなく、スキルが低い開発者もメンバーの一員として働けるようになった。もちろん最初は誰もがそうだけど、適切な指導や教育を受けないとそのまま経験年数だけが経ってしまう。さらにそんな人が偶然リーダーになってしまうと <a href=https://yshibata.blog.ss-blog.jp/2016-07-01>許される無知の範囲は開発経験年数に反比例する</a> という現象が起きる。一定の水準を超えていない開発者がなにを作ってもうまくいかないのではないかと私は感じるようになってきた。私はそういったプロダクトを「ただ動くだけ」と呼んでいる。その後の拡張や保守に必要以上にコストがかかり、それが原因で将来の開発計画に支障をきたすこともある。そして、多くのケースでその状況を作った人はその後いないことが多い。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0723/>コーポレートファイナンスの入門</a></h1><div class=post-meta><span class=post-date>2022-07-23 (Sat.)</span></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/book/>book</a>&nbsp;
#<a href=/diary/tags/finance/>finance</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#ストレッチ>ストレッチ</a></li><li><a href=#もてなしだけではもう食えない>もてなしだけではもう食えない</a><ul><li></li></ul></li></ul></nav></div><div class=post-content><p>0時に寝て6時に起きて7時半に起きた。</p><h2 id=ストレッチ>ストレッチ</h2><p>今日の開脚幅は開始前158cmで、ストレッチ後162cmだった。まだ右腰と右股関節、両腕の張りは少し残っているものの、先週末の田んぼ仕事の疲労はかなり抜けた。今週は暑くて家に帰ってきたらエアコンをつけてだらだらしていたのであまり数値はよくならないんじゃないかと思っていて、実際に開始前の数値はいま一つだったんだけど、ストレッチを受けたらいつも通りに戻った。トレーナーさんと雑談しているときにふと「毎日パソコンを使いますか？」と質問を受けた。トレーナーさんからプログラマーの自分にとってそんな質問をされるとは予想外で思わず吹き出して笑ってしまった。その質問は「毎日水を飲みますか？」と私にとっては同じですよと答えた。トレーナーさんも愚問だったと理解して一緒に笑ってた。</p><h2 id=もてなしだけではもう食えない>もてなしだけではもう食えない</h2><h4 id=第7章-ホテルが客を動かせ>第7章 ホテルが客を動かせ</h4><p>ホテル側が自分たちの問題を解決するために客の行動を制御するといった展開になっている。米国のスーパーマーケットでは Express Lane という、購入品目が少ない客向けに手早く決済するためのレジが設けられているらしい。日本にはないのかな？この運用には客に学習コストを強いるのが欠点となる。キャパシティ問題の問題解決のアプローチは次の3つになる。</p><ol><li>キャパシティを増やす</li><li>供給を変える</li><li>需要を変える</li></ol><p>本章の展開としては3番目の客側の導線や行動を変えてしまう方法で需要を変える手法が説明されている。本題ではないけど、さらっと出てくる説明にも納得感がある。ダメなホテルの共通点として、他社でうまくいった改善策、ベストプラクティスに飛びつき、それ以上考えようとせず、問題の本質を理解しようとしない。そういうホテルはコンサルタントが去ってしまうといずれでダメな経営に陥るとある。ホテルに限らず、ダメな会社の特徴だと思う。</p><p>客にピーク時の利用を避けてもらうための施策として次の2つがある。</p><ul><li>混雑することをあらかじめ伝えておく</li><li>混雑を避けることのインセンティブをつける</li></ul><p>ホテル側が客の行動をコントロールするのは構わないが、客にとってそれが不利益にならないように配慮する必要がある。人間の心理として混雑することがあらかじめわかっていればクレームにならず許容できたりする。人は不意に混雑に出くわして不満をもつことが多いという。そういった人の心理を利用して人の行動を制御して経営に生かすという考え方は比較的新しい研究領域である。行動経済学などもその分野の1つで、古典経済学では人は合理的に行動するとされてきた。しかし、現実では必ずしもそうではないことも行動経済学によってわかってきた。</p><h4 id=第8章-リスクを知らないリスク>第8章 リスクを知らないリスク</h4><p>親会社の不動産会社からリスク管理報告書を提出しろという業務に沿ってリスクマネジメントについての話題が出てくる。契約の話しだったり、建築に関する話しだったり、あまり一般的な経営とは異なる内容にみえる。余談だけど、過去にうちの会社で業務内容が変わったにも関わらず、契約内容を更新せずに更新された新たな業務を継続してうまくいかなかった経験がある。うまくいかなかったときに原点に立ち戻る場所が契約であり、契約を曖昧に扱うと後でしっぺ返しがあるという失敗をまさに経験した。ふりかえりをするときにそもそもの基準が適切でないとその反省や改善点も曖昧になってしまうという話し。</p><p>さて、リスク管理報告書のアウトラインとして次の用語が出てくる。</p><ul><li>ハザードコントロール<ul><li>ハザードとは危険を生じさせるもののこと</li><li>ホテル経営だと、食中毒を防ぐ施策とか、横領できないように決済承認に2名以上必要とか</li></ul></li><li>ペリルコントロール<ul><li>ペリルとは事件・事故のこと</li><li>起きてしまった事件・事故から最小限の損害・被害に食い止める施策</li></ul></li><li>ロスコントロール<ul><li>ロスとは事故発生時に発生してしまった経済的損失のこと</li><li>具体的には保険購入であり、どんな保険にどのぐらいの補償額で加入するかになるが、これがなかなか難しい</li></ul></li></ul><p>peril という英単語の辞書を引くと、差し迫った危険という意味が出てくる。リスク管理の文脈の用語と英語の意味はやや違うのかもしれない。</p><h4 id=第9章-タイムバリューを理解せよ>第9章 タイムバリューを理解せよ</h4><p>親会社に投資ファンドからホテルの買収提案があり、ホテルの事業価値を測るコーポレートファイナンスの話題が出てくる。上場企業であれば株価 x 発行済株式数で時価総額がすぐにわかるが、未上場企業の価値を査定するのは難しいという説明からその手法が紹介される。</p><ul><li>類似業種比準方式<ul><li>上場している同業者の株価を参考にする</li><li>但し、ビジネスモデルを無視して業種だけで比較しようとしても単純比較はできない</li></ul></li></ul><p>不動産を所有しているかどうかで株式評価は大きく異なる。単純に不動産をもっていればよいというわけでもなく、資産と負債のバランスが取れているかが大事。「また貸し」のことを業界用語で転貸 (サブリース) と呼ぶ。</p><ul><li>純資産方式<ul><li>会社のもっているものを全部売って借金を返した残りのお金という評価方法</li><li>貸借対照表の資本がマイナスになっているとすべてを換金しても負債が残る = 債務超過</li></ul></li></ul><p>株価の利回りを株価収益率 (Price Earnings Ratio: PER) と呼ぶ。時価総額 / 純利益で計算される。この計算式から時価総額を知りたければ、純利益 x PER で計算できる。比較可能な会社の PER がわかれば未上場会社の株価を計算できる。但し、PER は会社が未来永劫事業を継続させることを前提としている。会社の継続性に疑義があると PER を用いる根拠がなくなる。株主に説明するときの利益とは、正式には <strong>税引き後当期利益</strong> になる。この金額から配当がなされる。うちの会社だとざっくり粗利から20-30%ほど (法人税 + 消費税) 引いたものが税引き後当期利益になる。会社が予定する配当額は同じだが、株価をディスカウントすることで配当の利回りをよくするという考え方を <strong>リスクプレミアム</strong> と呼ぶ。会社の展望や事業の不確実性を数値化したとみなすことができる。</p><ul><li>株価1000円で配当額が20円だと、利回りは2.0%</li><li>株価500円で配当額が20円だと、利回りは4.0% (この 2.0% の差がリスクプレミアム)</li></ul><p>いま現在もらえる現金の1万円は1年後もらえる1万円よりも価値が高いと言える。それは1年後にはもらえないかもしれないリスクや運用機会損失リスクが含まれるから。その価値をどの程度低く見積もるかを <strong>割引率</strong> と言う。この割引率を用いて将来の現金をいまの現金価値に置き換える評価方法を <strong>DCF (Discounted Cash Flow) 法</strong> と呼ぶ。仮に割引率を10%とすると、1年後の100万円をいまの価値にすると、100 / (1 + 0.1) = 90.9 万円になる。2年後の100万円だと 100 / (1 + 0.1)^2 = 82.6 万円になる。</p><figure><img src=/diary/img/2022/0723_dcf-expression.png></figure><p>本文中ではこの計算式を使って年間の利益と割引率を考慮した現在価値をエクセルでモデル化している。python で書くと次のようになる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>f</span>(profit, discount_rate, year):
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>   <span style=color:#66d9ef>return</span> profit <span style=color:#f92672>/</span> pow((<span style=color:#ae81ff>1</span> <span style=color:#f92672>+</span> discount_rate), year)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#66d9ef>for</span> i, profit <span style=color:#f92672>in</span> enumerate([<span style=color:#ae81ff>100</span>, <span style=color:#ae81ff>120</span>, <span style=color:#ae81ff>125</span>, <span style=color:#ae81ff>130</span>, <span style=color:#ae81ff>135</span>, <span style=color:#ae81ff>140</span>, <span style=color:#ae81ff>145</span>, <span style=color:#ae81ff>150</span>, <span style=color:#ae81ff>155</span>, <span style=color:#ae81ff>160</span>, <span style=color:#ae81ff>165</span>], <span style=color:#ae81ff>1</span>): i, round(f(profit, <span style=color:#ae81ff>0.1</span>, i), <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>...</span> 
</span></span><span style=display:flex><span>(<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>90.9</span>)
</span></span><span style=display:flex><span>(<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>99.2</span>)
</span></span><span style=display:flex><span>(<span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>93.9</span>)
</span></span><span style=display:flex><span>(<span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>88.8</span>)
</span></span><span style=display:flex><span>(<span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>83.8</span>)
</span></span><span style=display:flex><span>(<span style=color:#ae81ff>6</span>, <span style=color:#ae81ff>79.0</span>)
</span></span><span style=display:flex><span>(<span style=color:#ae81ff>7</span>, <span style=color:#ae81ff>74.4</span>)
</span></span><span style=display:flex><span>(<span style=color:#ae81ff>8</span>, <span style=color:#ae81ff>70.0</span>)
</span></span><span style=display:flex><span>(<span style=color:#ae81ff>9</span>, <span style=color:#ae81ff>65.7</span>)
</span></span><span style=display:flex><span>(<span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>61.7</span>)
</span></span><span style=display:flex><span>(<span style=color:#ae81ff>11</span>, <span style=color:#ae81ff>57.8</span>)
</span></span></code></pre></div><p>例えば、割引率が10%で5年後の利益が135万円ならば、その現在価値は83.8万円になる。本文の中ではこの金額が投資ファンドが提示している金額だとだいたい一致していることから、これ以上の精度の高いモデルを作らないといけないみたいなストーリー展開になっている。いずれにしてもパラメーターの変数の精度が高くないと適切なモデルとは言えない。割引率を用いた現在価値を計算する考え方を <strong>タイムバリュー (時間の価値)</strong> と呼ぶ。意思決定が遅れるほどプロジェクトの収益化も遅れるため、割引率を計算する現在価値が小さくなっていくという考え方ができる。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0722/>リアクティブプログラミングと WebClient</a></h1><div class=post-meta><span class=post-date>2022-07-22 (Fri.)</span></div><span class=post-tags>#<a href=/diary/tags/java/>java</a>&nbsp;
#<a href=/diary/tags/spring-boot/>spring boot</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#spring-webflux-とプロキシ>spring-webflux とプロキシ</a></li></ul></nav></div><div class=post-content><p>0時に寝て6時に起きた。金曜日は非稼働日だけど、今週は月曜日が祝日だったから普通に働いてた。</p><h2 id=spring-webflux-とプロキシ>spring-webflux とプロキシ</h2><p>たまたま api client 周りを触っている。それらは spring の <em>WebClient</em> で実装されている。WebClient は spring-webflux プロジェクトが提供している http リクエストを扱うためのクライアントでリアクティブプログラミングを用いた設計になっている。リアクティブという言葉がピンとこなければ非同期フレームワークを用いた http クライアントと言い換えても大枠ではあっているのではないかと思う。spring-webflux プロジェクトそのものはノンブロッキング、バックプレッシャーといった機能をサポートする web アプリケーションフレームワークを提供するもの。</p><ul><li><a href=https://docs.spring.io/spring-framework/docs/current/reference/html/web-reactive.html>Web on Reactive Stack</a></li></ul><p><a href=https://github.com/reactor/reactor>Reactor</a> というコアライブラリを使って spring-webflux のフレームワークは実装されている。このデータ構造の1つに <em>Mono</em> と <em>Flux</em> が出てくる。初見の開発者はこの名前のデータ構造がよくわからんというところから始まる。私がそうだった。ドキュメントの説明によると、Mono は0から1、Flux は0からNまでのデータ列の概念を扱うという。おそらく json のようなレスポンスを返す場合は Mono を使い、ストリームを返すレスポンスは Flux を使えばいいんじゃないかと思う。</p><blockquote><p>Reactor is the reactive library of choice for Spring WebFlux. It provides the Mono and Flux API types to work on data sequences of 0..1 (Mono) and 0..N (Flux) through a rich set of operators aligned with the ReactiveX vocabulary of operators. Reactor is a Reactive Streams library and, therefore, all of its operators support non-blocking back pressure. Reactor has a strong focus on server-side Java. It is developed in close collaboration with Spring.</p><p>WebFlux requires Reactor as a core dependency but it is interoperable with other reactive libraries via Reactive Streams. As a general rule, a WebFlux API accepts a plain Publisher as input, adapts it to a Reactor type internally, uses that, and returns either a Flux or a Mono as output. So, you can pass any Publisher as input and you can apply operations on the output, but you need to adapt the output for use with another reactive library. Whenever feasible (for example, annotated controllers), WebFlux adapts transparently to the use of RxJava or another reactive library. See Reactive Libraries for more details.</p><p><a href=https://docs.spring.io/spring-framework/docs/current/reference/html/web-reactive.html#webflux-reactive-api>https://docs.spring.io/spring-framework/docs/current/reference/html/web-reactive.html#webflux-reactive-api</a></p></blockquote><p>いまローカルの開発環境では vpn 接続をしてプロキシ経由でアクセスするサーバーがいる。WebClient のプロキシ経由で通信できないという問題があることを同僚から教えてもらった。プロキシ経由でアクセスしようとすると認可エラーになってしまう。なにかしらプロキシ経由の接続に問題がある。</p><pre tabindex=0><code>Caused by: io.netty.handler.proxy.HttpProxyHandler$HttpProxyConnectException: http, none, /10.100.101.10:8080 =&gt; /192.168.201.35:18980, status: 403 Forbidden
</code></pre><p>同僚は WebClient のデフォルトでは http の <a href=https://developer.mozilla.org/ja/docs/Web/HTTP/Methods/CONNECT>CONNECT</a> メソッドを使って通信しようとするが、それを <a href=http://www.squid-cache.org/>squid</a> がサポートしていないか、設定を変更しないとダメなんじゃないかと話していた。その内容が正しいかどうか、私は未検証だけどデフォルト設定では通信できないことがわかった。ここで WebClient の設定の1つに <a href=https://docs.spring.io/spring-framework/docs/current/reference/html/web-reactive.html#webflux-client-builder>ClientHttpConnector</a> があり、任意の http client ライブラリに置き換えられる。ソースをみると次の4つの ClientHttpConnector が使えるらしい。デフォルトが ReactorClientHttpConnector になる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>  <span style=color:#66d9ef>private</span> ClientHttpConnector <span style=color:#a6e22e>initConnector</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>reactorClientPresent<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ReactorClientHttpConnector<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>jettyClientPresent<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> JettyClientHttpConnector<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>httpComponentsClientPresent<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> HttpComponentsClientHttpConnector<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> JdkClientHttpConnector<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>試しに <a href=https://github.com/jetty-project/jetty-reactive-httpclient>jetty-reactive-httpclient</a> を使って JettyClientHttpConnector に置き換えてみたところ、プロキシサーバー経由のアクセスができるようになった。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> WebClient <span style=color:#a6e22e>create</span><span style=color:#f92672>(</span>String proxyIp<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> proxyPort<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    var httpClient <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HttpClient<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    httpClient<span style=color:#f92672>.</span><span style=color:#a6e22e>setFollowRedirects</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    httpClient<span style=color:#f92672>.</span><span style=color:#a6e22e>getProxyConfiguration</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getProxies</span><span style=color:#f92672>().</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> HttpProxy<span style=color:#f92672>(</span>proxyIp<span style=color:#f92672>,</span> proxyPort<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    var connector <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> JettyClientHttpConnector<span style=color:#f92672>(</span>httpClient<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> WebClient<span style=color:#f92672>.</span><span style=color:#a6e22e>builder</span><span style=color:#f92672>().</span><span style=color:#a6e22e>clientConnector</span><span style=color:#f92672>(</span>connector<span style=color:#f92672>).</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0721/>シュレッダーを壊した</a></h1><div class=post-meta><span class=post-date>2022-07-21 (Thu.)</span></div><span class=post-tags>#<a href=/diary/tags/device/>device</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#シュレッダーの解体結果から>シュレッダーの解体結果から</a></li></ul></nav></div><div class=post-content><p>23時に寝て6時に起きた。今日は淡々と web api の実装をしてた。</p><h2 id=シュレッダーの解体結果から>シュレッダーの解体結果から</h2><p>少し前に誤った書類を裁断していて用紙を3-4枚を一度にやろうとして力いっぱいまわしたら空回りするようになってしまった。メーカーのために取説には1-2枚とあるのでキャパシティ以上の負荷をかけた私が悪い。シュレッダーの刃は頑強だと実感していた分だけ別のところに弱点があることを失念していた。分解して歯車の部分をみてみると、歯車の一部が欠けていることがわかった。刃は頑強だが、どうやら歯車はそうではなかった。こんな小さい歯車が欠けるんだということがわかった。</p><figure><img src=/diary/img/2022/0721_shredder.jpg></figure><p>このシュレッダーは2020年1月25日に購入してもう2年以上使っていて、手動で手回ししながら裁断する。ぷちぷちをやるような気持ちになるのでちょっとしたストレス解消にもなってた。購入時に amazon の悪いレビューには空回りするようになるみたいなコメントもあったんだけど、私はこれまで2年以上問題なく使えてきた。裁断するものの量と負荷が蓄積していくうちに歯車が壊れて空回りするようになるのだろうなと、今回の失敗から理解できた。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0720/>ノードグループと nodeSelector</a></h1><div class=post-meta><span class=post-date>2022-07-20 (Wed.)</span></div><span class=post-tags>#<a href=/diary/tags/kubernetes/>kubernetes</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#eks-クラスターのノードグループと-k8s-の-nodeselector>EKS クラスターのノードグループと k8s の nodeSelector</a></li></ul></nav></div><div class=post-content><p>1時に寝て6時に起きた。</p><h2 id=eks-クラスターのノードグループと-k8s-の-nodeselector>EKS クラスターのノードグループと k8s の nodeSelector</h2><p>先日 <a href=/diary/posts/2022/0711/>k8s の nodeSelector</a> の調査について書いた。いまテスト環境でその調査結果の運用検証中。当初は k8s の機能だけを使いたいと考えていたが、いま eksctl コマンドで EKS クラスターを管理していて、k8s ノードの実体である ec2 のプロビジョニングはノードグループがもつ起動テンプレートとオートスケールポリシーにより制御される。そのため、ノードグループを分割してそれぞれにノードラベルが必ず付与されるように管理する方が簡単だとわかってきた。要はアプリケーションサーバー向けのノードグループとバッチ処理向けのノードグループの2つを作った。あと覚えておくとよいのが、<a href=https://eksctl.io/usage/iam-policies/#adding-a-custom-instance-role>Adding a custom instance role</a> で任意のポリシーもノードグループの iam ロールに追加できる。設定例としてはこんな感じ。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span>  <span style=color:#f92672>iam</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>attachPolicyARNs</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>arn:aws:iam::${accountId}:policy/my-custom-policy</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>arn:aws:iam::aws:policy/AmazonEKSWorkerNodePolicy</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore</span>
</span></span></code></pre></div><p>ノードグループの準備が整ったら nodeSelector を指定した pod をデプロイするだけ。k8s ノードがどんなノードラベルをもっているかは次のようにして確認できる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl get node --show-labels
</span></span></code></pre></div><p>意図したノードラベルが付与された k8s ノードに pod がデプロイされたかどうかは次のようにして確認できる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl get pod --output wide --field-selector spec.nodeName<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>ノードラベルをもつノード名<span style=color:#e6db74>}</span>
</span></span></code></pre></div><p>これらの環境構築、検証、wiki にドキュメントを書いて本番作業手順もまとめた。一通りきれいにまとまったインフラ作業を完遂できて気分がよい。</p></div></div><div class=pagination><div class=pagination__buttons><a href=/diary/page/39/ class="button previous"><span class=button__icon>←</span>
<span class=button__text>最近の日記</span></a>
<a href=/diary/page/41/ class="button next"><span class=button__text>過去の日記</span>
<span class=button__icon>→</span></a></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>© 2021 Tetsuya Morimoto</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>