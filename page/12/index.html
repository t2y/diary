<!doctype html><html lang=en>
<head>
<meta name=generator content="Hugo 0.88.1">
<title>forest nook</title>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content>
<meta name=keywords content>
<meta name=robots content="noodp">
<link rel=canonical href=/diary/>
<link rel=stylesheet href=/diary/assets/style.css>
<link rel=stylesheet href=/diary/assets/green.css>
<link rel=stylesheet href=/diary/style.css>
<link rel=apple-touch-icon href=/diary/img/apple-touch-icon-192x192.png>
<link rel="shortcut icon" href=/diary/favicon.ico>
<meta name=twitter:card content="summary">
<meta name=twitter:site content="t2y">
<meta name=twitter:creator content="t2y">
<meta property="og:locale" content="en">
<meta property="og:type" content="website">
<meta property="og:title" content="forest nook">
<meta property="og:description" content>
<meta property="og:url" content="/diary/">
<meta property="og:site_name" content="forest nook">
<meta property="og:image" content="/diary/favicon.ico">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">
<link href=/diary/index.xml rel=alternate type=application/rss+xml title="forest nook">
</head>
<body class=green>
<div class="container full headings--one-size">
<header class=header>
<div class=header__inner>
<div class=header__logo>
<a href=/diary>
<div class=logo>
forest nook
</div>
</a>
</div>
<div class=menu-trigger>menu</div>
</div>
<nav class=menu>
<ul class="menu__inner menu__inner--desktop">
<li><a href=/diary/about>自己紹介</a></li>
<li><a href=/diary/dates>月別一覧</a></li>
<li><a href=/diary/tags>タグ一覧</a></li>
</ul>
<ul class="menu__inner menu__inner--mobile">
<li><a href=/diary/about>自己紹介</a></li>
<li><a href=/diary/dates>月別一覧</a></li>
<li><a href=/diary/tags>タグ一覧</a></li>
</ul>
</nav>
</header>
<div class=content>
<div class=posts>
<div class="post on-list">
<h1 class=post-title>
<a href=/diary/posts/2021/1019/>改正法人税法等の説明会</a>
</h1>
<div class=post-meta>
<span class=post-date>
2021-10-19
</span>
</div>
<span class=post-tags>
#<a href=/diary/tags/book/>book</a>&nbsp;
#<a href=/diary/tags/tax/>tax</a>&nbsp;
</span>
<img src=/diary/img/2021/1019_water-spout.jpg class=post-cover alt=改正法人税法等の説明会>
<div class=table-of-contents>
<h2>
目次
</h2>
<nav id=TableOfContents>
<ul>
<li><a href=#データ指向アプリケーションデザイン>データ指向アプリケーションデザイン</a>
<ul>
<li></li>
</ul>
</li>
<li><a href=#改正法人税法等の説明会>改正法人税法等の説明会</a></li>
</ul>
</nav>
</div>
<div class=post-content>
<p>0-1時ぐらいに寝て7時半に起きた。よく眠れたか眠れてないかもわからないような目覚め方をして少しぼおっとしてた。朝ゆっくりしてもいいかと思いつつ準備して移動したら9時前にはオフィスにいたので普通の日とそう変わらない一日の始めだった。夜にジョギング行こうかと思ってたけど、ちょうど通り雨が降ったりやんだりしててやめた。代わりに雨やんでからオフィス行って調べてものしてた。</p>
<h2 id=データ指向アプリケーションデザイン>データ指向アプリケーションデザイン</h2>
<p>7.3を読んで7章トランザクションを読み終えた。トランザクションの章は言葉も知らないし、あまりクリティカルなアプリケーションの開発に関わってこなかったのでそこまで意識したことがなかった。トランザクションで問題が発生する分離レベルと典型的なパターンが体系的に整理されていてすごく勉強になった。結果的にトランザクションを使わないとしても、トランザクションの要否や起きうる整合性の問題を理解しておくとデータ定義やアプリケーションの設計にも活かせる気がする。7章まで読んだ中でもっとも知らないことが多かった。約300ページなのでだいたい半分読み終えた。まだまだ先は長い。</p>
<p>トランザクションの開始時点でロックをかけるべきオブジェクトが存在せず、あるトランザクションでの書き込みが他のトランザクションの検索クエリの結果を変化させてしまう問題を <strong>ファントム</strong> と呼ぶ。ファントムの対策の1つとして、あらかじめそのデータを作っておき <code>SELECT FOR UPDATE</code> でロックを取得するやり方を <strong>衝突の実体化 (materializing conflicts)</strong> と呼ぶらしい。グループウェアの開発をしていた頃、1つのスレッドしかトランザクションを実行できないことを保証するための切り札として、ロック用途のテーブルを設けておき、そのロックを獲得したスレッドだけ処理できるようにしていた。当時はわからなかったけど、あれは衝突の実体化という手法だったんだといま気付いた。</p>
<blockquote>
<p>データベースのクラッシュや整合性に関する問題に対する信頼性を保つために、それらの問題を単純化するために、この数十年にわたって選択されてきた仕組みが <strong>トランザクション</strong> である。トランザクションは、アプリケーションが複数の読み書きを論理的な単位としてまとめる方法である。概念的には、トランザクション中のすべての読み書きは1つの操作として実行される。トランザクションは抽象化のレイヤーであり、アプリケーションはある種の並行性の問題や、ある種のハードウェアやソフトウェアの問題が存在しないかのように振る舞えるようになる。</p>
<p>トランザクションは全体として成功（ <strong>コミット（commit）</strong> ）もしくは失敗（ <strong>中断（abort）</strong> 、 <strong>ロールバック（rollback）</strong> ）する。トランザクションが失敗した場合には、アプリケーションは安全にリトライできる。トランザクションは自然法則ではなく、データベースにアクセスするアプリケーションのためのプログラミングモデルをシンプルにするという目的を持って生み出された。トランザクションを利用すれば、ある種の潜在的なエラーの状況や並行性の問題はデータベースが面倒を見てくれるので、アプリケーションはそれらを気にしなくてよくなる（このことは <strong>安全性の保証</strong> と呼ばれる）。</p>
<p>トランザクションが提供する安全性の保証は <strong>ACID</strong> で示される。</p>
<h5 id=原子性-atomicity>原子性 (Atomicity)</h5>
<ul>
<li><strong>原子（アトミック）</strong> はそれ以上小さな部分に分割できないものを指して使われる言葉</li>
<li>マルチスレッドのプログラミングにおいては、あるスレッドがアトミックな処理を実行しているというなら、それは他のスレッドからはその処理の半分だけ完了した途中の状態を見る方法が存在しないことを意味する。システムが取りえる状態は、その処理が始まる前と終わった後の状態だけであり、その中間の状態になることはない
<ul>
<li>前にメモリモデルの文脈で、あるプロセスが書き込み完了したデータが、他のプロセスからも確実に読めることをアトミックな操作と習ったことがある</li>
</ul>
</li>
<li>原子性と並行性は関係がない</li>
<li>エラーの際にトランザクションを中断し、そのトランザクションのすべての書き込みを破棄できることが、 ACID の原子性を決定づける特徴と言える
<ul>
<li>アプリケーションがリトライしても安全であることを保証する</li>
<li><strong>中断可能性（abortability）</strong> の方が原子性よりも良い言葉だったと思われる</li>
</ul>
</li>
</ul>
<h4 id=一貫性-consistency>一貫性 (Consistency)</h4>
<ul>
<li>一貫性は多くの意味で使われる
<ul>
<li>とくに日本語では整合性とも訳される</li>
</ul>
</li>
<li>非同期のレプリケーションシステムでは結果整合性の問題が発生する (5章)</li>
<li>コンシステントハッシュ法は、リバランシングのためにいくつかのシステムで利用されているパーティショニングのアプローチ</li>
<li>CAP 定理では、一貫性という言葉は線形化可能性の意味で使われる (9章)</li>
<li>ACID の文脈における一貫性は、データベースが「良い状態」にあることを示すアプリケーション固有の概念を指す</li>
</ul>
<p>同じ言葉を少なくとも4つの異なる意味で使われている。ACID における一貫性という概念は、データについて常に真でなければならない何らかの言明（ <strong>不変性</strong> ）があることを指す。たとえば、会計システムの場合、すべてのアカウントでまとめれば常に貸方と借方は等しくならなければならない。この一貫性の概念はアプリケーション固有の不変性の概念に依存しており、一貫性を保つようにトランザクションを適切に定義することはアプリケーションの責任となる。原子性、分離性、永続性はデータベースの特性だが、一貫性は（ ACID という考え方においては）アプリケーションの特性である。したがって、 C は実際には ACID に属していない。</p>
<h4 id=分離性-isolation>分離性 (Isolation)</h4>
<p>多くのデータベースは、同時に複数のクライアントからアクセスされる。データベース中の同じレコードにアクセスするときに並行性の問題（レース条件［ race condition ］）が生じる可能性がある。データベース中に保存されているカウンタを、2つのクライアントが同時にインクリメントすると仮定する。それぞれのクライアントは現在の値を読み取り、1を加え、新しい値を書き戻す。ACID における分離性とは、並行して実行されたトランザクションがお互いから分離されており、お互いのつま先を踏みつけあうようなことがないという意味である。実際の運用では、パフォーマンスの制約から分離レベルによって保証される分離性が変わってくる。</p>
<h4 id=永続性-durability>永続性 (Durability)</h4>
<p>データベースシステムが目的とするのは、データを失う恐れなく保存できる安全な場所を提供すること。永続性は、トランザクションのコミットが成功したら、仮にハードウェアの障害やデータベースのクラッシュがあったとしても、そのトランザクションで書き込まれたすべてのデータは失われないことを約束する。</p>
<h4 id=用語の整理>用語の整理</h4>
<p>トランザクションはデータモデルがどういったものであるかにかかわらず、価値あるデータベースの機能と言える。並行に実行されたトランザクションがお互いに影響しあわない分離性における保証を <strong>分離レベル</strong> と呼ぶ。</p>
<ul>
<li>read committed</li>
<li>スナップショット分離（repeatable read とも呼ばれる）</li>
<li>直列化可能</li>
</ul>
<p>これらの分離レベルに対してトランザクションで発生する様々なレース条件がある。</p>
<ul>
<li>ダーティリード
<ul>
<li>あるクライアントが他のクライアントのまだコミットされていない書き込みを読める</li>
<li>read committed 分離レベル及びそれ以上に強い分離レベルはダーティリードは生じない</li>
</ul>
</li>
<li>ダーティライト
<ul>
<li>あるクライアントが他のクライアントによるまだコミットされていない書き込みの内容を上書きしてしまう</li>
<li>ほぼすべてのトランザクションの実装は、ダーティライトを生じない</li>
</ul>
</li>
<li>読み取りスキュー（nonrepeatable read）
<ul>
<li>クライアントが異なる時刻にデータベースの異なる部分を見ること</li>
<li>この問題の最も一般的な回避策はスナップショット分離によるもので、これはトランザクションがある時点での一貫したスナップショットから読み取りを行えるようにする</li>
<li>通常、MVCC（multi-version concurrency control）を利用して実装される</li>
</ul>
</li>
<li>更新のロスト
<ul>
<li>2つのクライアントが並行して read-modify-write サイクルを実行するとき、片方が他方の書き込みをその変更内容を考慮せずに上書きしてしまい、データが失われること</li>
<li>スナップショット分離レベルの実装にはこの異常を自動的に回避してくれるものもあるが、明示的なロック（ SELECT FOR UPDATE ）をしなければならない実装もある</li>
</ul>
</li>
<li>書き込みスキュー
<ul>
<li>トランザクションが何かを読み取り、その値に基づいて判断を下し、その結果をデータベースに書き込む</li>
<li>この状況で、書き込みが行われた時点で判断の根拠となったプレミスが真ではなくなっている場合を指す</li>
<li>直列化可能分離レベルのみがこの異常を回避できる</li>
</ul>
</li>
<li>ファントムリード
<ul>
<li>トランザクションが何らかの検索条件にマッチするオブジェクトを読み取り、他のクライアントはその検索結果に影響する書き込みを行う</li>
<li>スナップショット分離レベルは単純なファントムリードを回避してくれるが、書き込みスキューを伴うファントムに対してはインデックス範囲ロックのような特別な対応が必要となる</li>
</ul>
</li>
</ul>
<p>弱い分離レベルは、これらの異常のいくつかを防いでくれるが、それ以外はアプリケーション開発者に対処する必要がある（たとえば明示的なロックなど）。すべての問題に対する保護を提供してくれるのは直列化可能分離レベルのみ。直列化可能なトランザクションの実装方法は、3 種類ある。</p>
<ul>
<li>トランザクションを順次実行する
<ul>
<li>それぞれのトランザクションをきわめて高速に実行でき、加えて単一の CPU コアで十分処理できる程度にトランザクションのスループットが低いのであれば、これはシンプルで効果的な選択肢となる</li>
</ul>
</li>
<li>ツーフェーズロック
<ul>
<li>数十年にわたって直列化可能分離レベルの実装において標準的な方法であった</li>
<li>パフォーマンス上の特性から多くのアプリケーションがツーフェーズロックの利用は避けている</li>
</ul>
</li>
<li>直列化可能スナップショット分離（SSI、serializable snapshot isolation）
<ul>
<li>新しいアルゴリズムであり、これまでのアプローチが持つ欠点のほとんどを回避している</li>
<li>SSI は楽観的アプローチを取っており、トランザクションはブロックされることなく処理を進められる</li>
<li>トランザクションはコミットの時点でチェックされ、その実行が直列化可能になっていなければ中断される</li>
</ul>
</li>
</ul>
</blockquote>
<h2 id=改正法人税法等の説明会>改正法人税法等の説明会</h2>
<p><a href=https://www.nk-net.co.jp/kobe/assets/files/schedule/2021/211019.pdf>改正法人税法等の説明会</a> に参加してきた。所感からまとめるとこんな感じ。</p>
<ul>
<li>神戸文化ホールについて
<ul>
<li>電源がない</li>
<li>FREESPOT が提供されていてフリー wifi として利用できるが、通信品質は不安定
<ul>
<li>スマホでテザリングもやってみたが、電波状態がよくなくてもっと不安定</li>
</ul>
</li>
<li>ラップトップ向きの場所ではない</li>
</ul>
</li>
<li>税制を身近にするイベントとしては参加してもよい</li>
<li>もらった資料をたんたんと説明するだけなのでイベントに参加することで得られる付加価値はとくにない</li>
<li>気分転換や時間があれば参加すればいい、忙しかったら参加しなくてもよさそう</li>
</ul>
<p><a href=https://www.nk-net.co.jp/kobe/index.html>公益社団法人 神戸納税協会</a> という組織がある。年会費 (うちの会社だと7,800円) がいるのでいまは入らないけど、無料税務相談があるので余裕ができたら困ったときの相談相手になってもらう意図で入会してもよいかもしれない。冒頭の神戸税務署長の挨拶で法人税の申告における e-tax の利用率は 88.4% だと話してた。うちは紙で申請しているので意外とみんな e-tax 使っているんだなと自社を恥じた。だって Windows マシンないとできへんねんもん。参加したことによる学びとして書いていくとこれらかな。</p>
<ul>
<li>「研究開発費」は会計上の用語、「試験研究費」は税法上の用語</li>
<li>DX 投資促進税制の創設</li>
</ul>
<p>内容は基本知らないことなので、知らないことに触れるイベントという点では斬新ではあった。ほうほうと聞いてただけなんだけど。直接うちの会社に影響を与える税法の改正はインボイス制度ぐらいかな。</p>
</div>
</div>
<div class="post on-list">
<h1 class=post-title>
<a href=/diary/posts/2021/1018/>とくに何もない一日</a>
</h1>
<div class=post-meta>
<span class=post-date>
2021-10-18
</span>
</div>
<span class=post-tags>
#<a href=/diary/tags/gig/>gig</a>&nbsp;
#<a href=/diary/tags/book/>book</a>&nbsp;
</span>
<div class=table-of-contents>
<h2>
目次
</h2>
<nav id=TableOfContents>
<ul>
<li><a href=#エージェント面談>エージェント面談</a></li>
<li><a href=#データ指向アプリケーションデザイン>データ指向アプリケーションデザイン</a></li>
</ul>
</nav>
</div>
<div class=post-content>
<p>いつ寝たのか覚えてないけど、スマホをみたら1時過ぎに寝て6時に起きたことになっている。だいたいいつも5-6時には一度目が覚める。そのまま起きるときもあれば起きないときもある。今日はちゃんと起き上がったのは7-8時ぐらいだった気がする。夜にジョギング行こうかとも考えていただけど、帰って先に晩ご飯食べたら疲れてそのままだらだらしてた。</p>
<h2 id=エージェント面談>エージェント面談</h2>
<p>そろそろ次のお仕事を探す準備のために <a href=https://www.engineer-factory.com/>エンジニアファクトリー</a> というサービスに登録してみた。<a href=https://www.city.kobe.lg.jp/life/livelihood/kobejobport/index.html>KOBE JOB PORT</a> で紹介されていたのをみつけた。<a href=/diary/posts/2021/0930/#カジュアル面談準備>前に Remogu さんで探していた</a> ように、プロジェクトマネージャー案件か、リモートワークの開発者案件を探している。マネージャーだと常駐系の方が多かったり、実務経験必須だったりすることが多いため、神戸から通える範囲の案件も探してみようという意図になる。だいたいこんな内容を話してた。</p>
<ul>
<li>職務経歴の内容から個人を特定できないよう、エージェントがブラインド化した資料を企業に公開する</li>
<li>単価が高い案件は東京の会社のリモートワークに多い</li>
<li>契約は準委任契約がほとんどである</li>
<li>法人として契約もできる</li>
<li>6ヶ月や1年といった短期開発案件も多い</li>
</ul>
<p>求職者の情報を匿名化する背景は、企業が直接交渉するのを避けるためなのかな？求人プラットフォームごとに情報入力しないといけないのが面倒なところ。</p>
<h2 id=データ指向アプリケーションデザイン>データ指向アプリケーションデザイン</h2>
<p>7章トランザクションのうち、7.1と7.2を読んだ。トランザクションの章は内容も難しく量も多いので2日にかけて読むことにする。昔、業務アプリケーションやグループウェアを開発していたときはトランザクションを意識してコードを書いていたけど、Web アプリケーションを開発していると、あまりクリティカルな処理を実装することが少ないせいか、トランザクションをそんな意識しなくなったなと漠然と思えた。Cassandra だとトランザクションもないし。非同期 + 結果整合性で運用できるアプリケーションであればトランザクションいらないというのはそうなのかもしれない。</p>
</div>
</div>
<div class="post on-list">
<h1 class=post-title>
<a href=/diary/posts/2021/1017/>豆苗再生</a>
</h1>
<div class=post-meta>
<span class=post-date>
2021-10-17
</span>
</div>
<span class=post-tags>
#<a href=/diary/tags/food/>food</a>&nbsp;
#<a href=/diary/tags/book/>book</a>&nbsp;
</span>
<div class=table-of-contents>
<h2>
目次
</h2>
<nav id=TableOfContents>
<ul>
<li><a href=#豆苗の再生栽培>豆苗の再生栽培</a></li>
<li><a href=#データ指向アプリケーションデザイン>データ指向アプリケーションデザイン</a></li>
</ul>
</nav>
</div>
<div class=post-content>
<p>3時に寝て8時半に起きた。夜眠れなくて、野菜サラダに目玉焼きをのせて食べたり、お茶をわかしてボトルに入れ替えたりしてた。休日だと時間に余裕があるせいか、空き時間に自炊してなにか作ることが多い。</p>
<h2 id=豆苗の再生栽培>豆苗の再生栽培</h2>
<p>朝ご飯は野菜サラダと納豆を、お昼ご飯は豚肉としめじと2回目の豆苗を炒めたものを目玉焼きでとじたものを食べた。豆苗のパッケージに食べた後の根を水に浸しておけばまた生えてくるとあったので試しにやってみた。キッチンという日当たりのよくない場所で育てたせいか、薄い緑色の苗が生えてきた。</p>
<p><figure><img src=/diary/img/2021/1017_pea-sprout1.jpg alt=水に浸して2日目><figcaption>
<p>水に浸して2日目</p>
</figcaption>
</figure>
<figure><img src=/diary/img/2021/1017_pea-sprout2.jpg alt=水に浸して6日目><figcaption>
<p>水に浸して6日目</p>
</figcaption>
</figure>
</p>
<p>今回は適当に育てた。<a href=https://www.murakamifarm.com/myouken/grow/technique/#where>再生栽培のコツ</a> を読んで次はもうちょっとちゃんと育ててみよう。</p>
<h2 id=データ指向アプリケーションデザイン>データ指向アプリケーションデザイン</h2>
<p>6章パーティショニングを読んだ。昔からパーティショニングとシャーディングの違いはなんだろう？と漠然と思っていた。<a href=https://docs.microsoft.com/ja-jp/azure/architecture/best-practices/data-partitioning#designing-partitions>パーティションの設計</a> を読むと、3つのパーティション分割があげられている。</p>
<ul>
<li>水平的パーティション分割 (シャーディング)</li>
<li>列方向のパーティション分割</li>
<li>機能的パーティション分割</li>
</ul>
<p>パーティショニングは大規模なデータセットをデータ分割するための手法または概念として広い意味をもって使われるように読める。一方でシャーディングと呼ばれるものは水平パーティショニングのことを指している。いま分散データベースで一般的に使われている仕組みがそうなのかもしれない。本書では水平・垂直のパーティショニングの定義は行われていないが、次の説明が出てくる。おそらく主に水平パーティショニングを意図しているのではないかと思う。まとめはこんな感じ。</p>
<blockquote>
<p>用語の混乱</p>
<p>ここで パーティション と呼んでいるものは、 MongoDB 、 Elasticsearch 、 SolrCloud では <strong>シャード</strong> と呼ばれています。これは HBase では <strong>リージョン</strong> 、 Bigtable では <strong>タブレット</strong> 、Cassandra や Riak では <strong>vnode</strong> 、 Couchbase では <strong>vBucket</strong> と呼ばれています。とはいえ最も確立されている用語は <strong>パーティショニング</strong> なので、本書ではこの呼び方を使っていきます。</p>
</blockquote>
<p>パーティショニングも普通に開発をしていたらデータベースの設計で必要になるので身近な概念と言える。だいたいは知っている内容ではあったけど、パーティショニングとセカンダリインデックスの仕組みとか考えたことがなかった。Cassandra ではセカンダリインデックスをうまく設計しないとパフォーマンスに影響を与えることからあまり使われない傾向にあると思う。</p>
<blockquote>
<p>大規模なデータセットを小さな部分集合にデータ分割することをパーティショニングと呼ぶ。パーティショニングが必要になるのは、単一のマシンで保存や処理をするのが現実的ではないほどのデータがある場合になる。パーティショニングが目標とするのは、データやクエリの負荷を複数のマシン間で均等に分配し、<strong>ホットスポット</strong>（不均衡に高い負荷がかかるノード）が生じないようにすること。パーティショニングが均等になっておらず、一部のパーティションが他に比べて多くのデータやクエリを受け持っているような状態は <strong>スキュー（skew）</strong> と呼ばれる。そのためには、データに適したパーティショニングのスキームを選択し、クラスタへのノードの追加やクラスタからのノードの削除が生じたときにパーティション群をリバランシングする。</p>
<p>パーティショニングのアプローチとして主に2つがある。</p>
<ul>
<li><strong>キーの範囲によるパーティショニング</strong>
<ul>
<li>キーはソートされ、1つのパーティションには何らかの最小値と最大値の間にあるすべてのキーが保存される</li>
<li>キーをソートすることで、範囲に対するクエリが効率的に処理できるというメリットがある</li>
<li>アプリケーションが頻繁にアクセスするキーがソート順の中で近接していると、ホットスポットが生じるリスクがある</li>
<li>通常このアプローチでは、パーティションのリバランシングはパーティションが大きくなりすぎたときにその範囲を2つに分割することによって動的に行われる</li>
</ul>
</li>
<li><strong>ハッシュパーティショニング</strong>
<ul>
<li>ハッシュ関数がそれぞれのキーに対して適用され、1つのパーティションにはハッシュの一定の範囲を保存される</li>
<li>この方法ではキーの順序が失われるので範囲に対するクエリは非効率になるが、負荷分散より均等にしやすい</li>
<li>ハッシュによってパーティショニングを行う場合は、事前に固定数のパーティションを作成し、各ノードに複数のパーティションを割り当てておき、ノードの追加や削除が行われた場合にはパーティションをそのままあるノードから他のノードに移動させるのが一般的となる。また、動的パーティショニングも利用できる</li>
</ul>
</li>
</ul>
<p>ハイブリッドなアプローチを取ることもできる。たとえば複合キーを使い、キーの一部でパーティションを決め、他の部分でソート順を決めるといったやり方がある。Cassandra のプライマリーキーはこのアプローチを採用している。また、セカンダリインデックスもパーティショニングする方法が2つある。</p>
<ul>
<li><strong>ドキュメントによってパーティショニングされたインデックス（ローカルインデックス）</strong>
<ul>
<li>セカンダリインデックスをプライマリキー及び値と同じパーティションに保存する</li>
<li>書き込みの際に更新しなければならないパーティションが1つですむ</li>
<li>セカンダリインデックスの読み取りにはすべてのパーティションに対する <strong>スキャッタ/ギャザー</strong> が必要となる</li>
</ul>
</li>
<li><strong>語によってパーティショニングされたインデックス（グローバルインデックス）</strong>
<ul>
<li>セカンダリインデックスはインデックスが張られた値を使って独立にパーティショニングされる</li>
<li>セカンダリインデックスのエントリには、プライマリキーのあらゆるパーティションのレコード群が含まれる</li>
<li>ドキュメントが書き込まれる際には、セカンダリインデックスの複数のパーティションを更新しなければならない</li>
<li>読み取りは単一のパーティションだけで処理できる</li>
</ul>
</li>
</ul>
<p>クエリを適切なパーティションにルーティングする手法は、データベースに限った話題ではなく、<strong>サービスディスカバリ</strong> と呼ばれる一般的な問題である。有名な OSS として <a href=https://zookeeper.apache.org/>ZooKeeper</a> がある。これにはシンプルなパーティションを認識するロードバランシングから、洗練された並列クエリ実行エンジンまで様々である。すべてのパーティションは、ほぼ独立に動作できるように設計されている。パーティショニングされたデータベースが複数のマシンにまでスケールできるのはそのおかげである。</p>
</blockquote>
</div>
</div>
<div class="post on-list">
<h1 class=post-title>
<a href=/diary/posts/2021/1016/>閃光のハサウェイ見直し</a>
</h1>
<div class=post-meta>
<span class=post-date>
2021-10-16
</span>
</div>
<span class=post-tags>
#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/xr/>xr</a>&nbsp;
#<a href=/diary/tags/slack/>slack</a>&nbsp;
</span>
<div class=table-of-contents>
<h2>
目次
</h2>
<nav id=TableOfContents>
<ul>
<li><a href=#ストレッチ>ストレッチ</a></li>
<li><a href=#vr-イベント参加>VR イベント参加</a></li>
<li><a href=#slack-apps-の調査>Slack apps の調査</a></li>
</ul>
</nav>
</div>
<div class=post-content>
<p>2時に寝て6時半に起きた。連日ジョギングして体を動かしたせいか、よく眠れて体調がよい気がした。<a href="http://gundam-hathaway.net/news.php?id=19157">機動戦士ガンダム 閃光のハサウェイ</a> が今日からオンライン配信を開始した。私は載っているどの動画配信プラットフォームも使ってないが、iTunes Store で普通に購入できるようになっているのに気付いた。昨日の夜は閃光のハサウェイをみながら寝落ちしたので朝起きてから途中から見直した。映画館でみてたけど、戦闘のシーンは暗くてよくわからなかったので何回かみた方が発見もあるかもしれない。市街地の降ってくる炎を避けて逃げるシーンが好き。</p>
<h2 id=ストレッチ>ストレッチ</h2>
<p>一昨日、昨日と連日でジョギングしたせいか、右股関節からお尻と右ももにかけて筋肉痛で張りがあった。そのせいかもしれないけど、今日の開脚幅は開始前168cmで、ストレッチ後170cmだった。先週とほぼ変わらないので股関節の可動域は現状維持だった。それでもトレーナーさんに筋肉痛だったところをストレッチしてもらってかなり楽になった。ジョギングして痛くなる内容が、最近は関節の痛みから筋肉の張りになっている気がしてこれはよい傾向かもしれない。前は腰にも負担がきていたけど、それも少しましになった。今日は可もなく不可もなくといったところか。</p>
<h2 id=vr-イベント参加>VR イベント参加</h2>
<p><a href=https://kobe-sannomiya-dev.connpass.com/event/225590/>【三宮.dev オンライン】３周年記念交流会</a> に参加した。<a href=https://cluster.mu/>cluster</a> のイベントを開いた。Oculus Quest で VR 参加できるのは Windows 向けのアプリだけっぽく macOS では VR 参加できなかった。</p>
<p>オープンなイベントとして開催したので誰でも参加することができて、途中で子どもが入ってきて参加者に無邪気に質問して微笑ましいカオスをもたらしていた。大人はよく知らないイベントに入って、なんの前提知識もなく参加者に話しかけたりしないだろう。そういうやり取りをみていて、子どものときから VR 空間でいろんな人と接すると子どもたちはどんな大人になるんだろう？私では想像もつかないイノベーションを起こすんだろうな。</p>
<p>1.5年前に1度だけ macOS のアプリで cluster イベント参加したことがあった。アプリは3回ぐらい落ちて不安定なので途中で Web でみたりしてた。そのときに比べたら今日は1度も落ちなかったので安定していた。参加者数の違いによるものかもしれないけど。前回から1.5年も経っているのに機能的なものは何も変わってないようにみえてあんまり流行ってないのかな？とも思えた。</p>
<p>参加者にたぬきのアバターがいて「たぬきさん、いますね」みたいな感じで和んでた。動物のアバターいいなと思って、カスタムアバターに興味がでた。<a href=https://vroid.com/en/studio>VRoidStudio</a> を使えば作れるらしい。また <a href=https://reality.app/>REALITY</a> で作ったアバターを cluster で <a href=https://clusterhelp.zendesk.com/hc/ja/articles/360044037491-REALITY-%E9%80%A3%E6%90%BA%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6>REALITY 連携</a> して使うこともできるらしい。<a href=https://www.oculus.com/blog/new-day-new-you-avatars-are-more-expressive-and-customizable-starting-today/>Oculus ブログの記事</a> をみてたら Oculus は Oculus で独自のアバターの仕組みになるのかな。外部のツールで作ったカスタムアバターを持ち込めるようにはみえない。</p>
<h2 id=slack-apps-の調査>Slack apps の調査</h2>
<p><a href=https://www.wrangle.io/>Wrangle</a> を試してみた。</p>
<blockquote>
<p>Approval and Ticketing Workflows in Slack</p>
</blockquote>
<p>3つの機能をもっている。</p>
<ul>
<li>ちょっとした ToDo リスト管理</li>
<li>承認依頼を管理</li>
<li>ステップと承認のワークフローを管理</li>
</ul>
<p>とくに SaaS 型の Web アプリケーションもなく Slack app 単体で完結するアプリケーションにみえる。組織として承認履歴を残したいといったときにチャットツール上でワークフローを定義してちゃちゃっとできるといったところが売りなのではないかと推測する。課題管理として使うアプリケーションではなかった。</p>
</div>
</div>
<div class="post on-list">
<h1 class=post-title>
<a href=/diary/posts/2021/1015/>日本酒いただきもの</a>
</h1>
<div class=post-meta>
<span class=post-date>
2021-10-15
</span>
</div>
<span class=post-tags>
#<a href=/diary/tags/morning-activity/>morning activity</a>&nbsp;
#<a href=/diary/tags/book/>book</a>&nbsp;
#<a href=/diary/tags/slack/>slack</a>&nbsp;
</span>
<img src=/diary/img/2021/1015_sake.jpg class=post-cover alt=日本酒いただきもの>
<div class=table-of-contents>
<h2>
目次
</h2>
<nav id=TableOfContents>
<ul>
<li><a href=#朝活>朝活</a></li>
<li><a href=#データ指向アプリケーションデザイン>データ指向アプリケーションデザイン</a></li>
<li><a href=#slack-apps-の調査>Slack apps の調査</a></li>
<li><a href=#ジョギング>ジョギング</a></li>
</ul>
</nav>
</div>
<div class=post-content>
<p>0時に寝て6時に起きた。だいたい夜中に2-3回は起きるのが普通になりつつあって、前日ジョギングしてたせいか腰やお尻の筋肉に張りがあったので3時頃起きてストレッチして張りの箇所を伸ばしたりしながら寝てた。午前中、いけさんから上等なお酒をいただいた。造り酒屋の一族らしい。感謝。</p>
<h2 id=朝活>朝活</h2>
<p>朝起きる目的にいいかも？と思って <a href=https://www.youtube.com/channel/UC1rVx0vAg66su1WvH3X-RJg>Webデザイントレンドのよりみち</a> の金朝つめとぎに参加してみた。やっぱり目的があれば6時に起きれる。でも、終わってから1時間ほど寝てたので今日はプラスマイナスゼロ。<a href=/diary/posts/2021/1013/#朝活>前回の朝活</a> と同様、ミクロ経済学の入門書を読んでた。第2章の予算線と最適化を読んだ。経済学とはこういうものだという説明が腑におちた。当たるかどうかよりも考え方を理解しておく方が大事なように思えた。</p>
<blockquote>
<p>ときどき経済学に対して「経済学が想定するほど実際の消費者は懸命に選択しているとは限らない」といった批判がなされることがある。でもこれまでの説明から明らかなように、その批判は勘違いにもとづくものだ。批判したいなら「経済学は、消費者がはたから見て確実に愚かな選択をしても、それを非難しない傾向が強い」というほうが適切だろう。</p>
</blockquote>
<p>もう1つおもしろかったのがこの一節。</p>
<blockquote>
<p>予算線と選好を用いたミクロ経済学的分析は、現金給付のよさを指摘する。ただし、制度の悪用、人々の支持、必要原理といったことを考えると、現物給付のほうが好ましいとなる。現金給付と現物給付のどちらが総合的によいのか、これらの話だけで結論づけることはできない。とはいえここで、ミクロ経済学が有用な政策分析ツールたりえること、またミクロ経済学だけで政策を論じるのは不十分ということが分かったのは十分な収穫である。</p>
</blockquote>
<p>人間の活動を予測するような学問の便宜上、前提条件や制約を課している。経済という人間にとって重要な社会システムを扱う経済学への期待値が大き過ぎるがために経済学の言うことが当たった・当たってないといった議論になりがちなのかもしれないと思えた。</p>
<h2 id=データ指向アプリケーションデザイン>データ指向アプリケーションデザイン</h2>
<p>5章レプリケーションを読んだ。200ページ超えたことで1/3を読み終えた。まだまだ先は長い。</p>
<p>シングルリーダーレプリケーションは一般的なものだし、Cassandra の運用をしていたのでリーダーレスレプリケーションもだいたいは知っていた。並行書き込みの問題は意識したことがなかった。そういう状況が発生するアプリケーションにおいてはとても難しい問題なことが理解できた。Cassandra で採用されている衝突解決アルゴリズムは <strong>最後の書き込みを勝たせる（last write wins、LWW）</strong> というものであり、これで十分なように考えていたけど、不十分なケースもあることがわかった。</p>
<blockquote>
<p>レプリケーションとは、ネットワークで接続された複数のマシンに同じデータのコピーを保持しておくこと。</p>
<ul>
<li>データを地理的にユーザーの近くで保持しておく => レイテンシを下げる</li>
<li>一部に障害があってもシステムが動作し続けられる => 可用性を高める</li>
<li>読み取りクエリを処理するマシンをスケールアウトする => スループットを高める</li>
</ul>
<p>レプリケーションはいくつかの目的で使われる。</p>
<ul>
<li>高可用性/耐障害性</li>
<li>レイテンシ</li>
<li>スケーラビリティ</li>
</ul>
<p>対象のデータが時間が経っても変化しないのであれば、レプリケーションは容易。単にデータのコピーを各ノードに一度だけコピーすれば完了するから。レプリケーションの難しさは、すべてレプリケーションされたデータへの変更の扱いから生じる。変更をノード間でレプリケーションするのに広く使われているアルゴリズムは次の3つになる。</p>
<ul>
<li>シングルリーダーレプリケーション
<ul>
<li>クライアントはすべての書き込みを1つのノード（リーダー）に送り、リーダーはデータ変更イベントのストリームを他のレプリカ（フォロワー）に送る</li>
<li>読み取りは任意のレプリカから行えるが、フォロワーから読み取るデータは古い可能性がある</li>
</ul>
</li>
<li>マルチリーダーレプリケーション
<ul>
<li>クライアント群は、それぞれの書き込みを複数あるリーダーノードのいずれかに送信する</li>
<li>これらのリーダーノードはどれも書き込みを受け付ける</li>
<li>リーダー群は、データ変更イベントのストリームをお互いに、そしてすべてのフォロワーノードに送信する</li>
</ul>
</li>
<li>リーダーレスレプリケーション
<ul>
<li>クライアントは、それぞれの書き込みを複数のノードに送信し、古いデータを持つノードを修正するために読み取りを複数のノードから並列に行う</li>
</ul>
</li>
</ul>
<p>データベースのレプリケーションの原理は1970年代から研究されていてそれほど変わっていない。とはいえ、分散データベースがメインストリームで利用されるようになったのは最近のこと。アプリケーション開発者の経験不足により <strong>結果整合性</strong> のような問題に関しては多くの誤解が生じた。いずれのレプリケーションのアプローチにもメリットとデメリットがある。シングルリーダーレプリケーションは理解しやすく、衝突解決を気にする必要がないことから、広く使われている。マルチリーダーとリーダーレスのレプリケーションは、ノードの障害、ネットワークの障害、レイテンシのスパイクがあっても頑健になる。しかし障害の理由を説明するのが難しく、一貫性についても弱い保証しか示せない。</p>
<p>レプリケーションは、 <strong>同期</strong> で行うことも <strong>非同期</strong> で行うこともできる。どちらにするのかは、障害があったときのシステムの振る舞いに大きく影響する。非同期のレプリケーションは、システムがスムーズに動作しているときには高速に動作するが、重要なのはレプリケーションのラグが大きくなったり、サーバーに障害が生じたりしたときに何が起こるのかを理解しておくことになる。リーダーに障害が発生し、非同期に更新されていたフォロワーを新しいリーダーに昇格させたら、直前にコミットされたデータは失われてしまう可能性がある。</p>
<p>レプリケーションラグが生じている状況下でアプリケーションがどのように振る舞うべきなのかを決める際に役立つ一貫性モデル。</p>
<ul>
<li><strong>書き込み後読み取り (read-your-writes)</strong>
<ul>
<li>ユーザーは、自分自身が投入したデータを常に見れる</li>
</ul>
</li>
<li><strong>モノトニック読み取り (monotonic reads)</strong>
<ul>
<li>ある時点のデータをユーザーが一度見たら、それ以前の時点のデータは見れない</li>
</ul>
</li>
<li><strong>一貫性のあるプレフィックス読み取り</strong>
<ul>
<li>ユーザーは、たとえば質問とその質問への回答を適切な順序でといったように、適切な因果関係を保持した状態でデータを見れる</li>
</ul>
</li>
</ul>
<p>マルチリーダーとリーダーレスのアプローチは本質的に並行性の問題を抱えている。複数の書き込みが並列に行われることがあるので、衝突が生じる場合がある。ある操作が他の操作よりも先に行われたのか、あるいはそれらが並行して行われたかを判断するためのアルゴリズムについて説明されている。</p>
</blockquote>
<h2 id=slack-apps-の調査>Slack apps の調査</h2>
<p><a href=https://www.instagram.com/workstreams.ai/>Workstreams.ai</a> を試してみた。</p>
<blockquote>
<p>Results-driven task management for Slack, Microsoft Teams and Google</p>
</blockquote>
<p>結果駆動タスクマネジメントという聞いたことない用語が書いてある。SaaS 型の Web アプリケーションとしての課題管理システムとチャットツールとの連携が密になったプロダクトにみえる。UI もよく作り込まれている。Workstreams.ai のアカウント管理は <a href=https://api.slack.com/authentication/sign-in-with-slack>Sign in with Slack</a> を使っている。ドキュメントによると openid connect と oauth 2.0 の仕組みを組み合わせているのかな。認証よくわかってないので背景も勉強しないといけない。簡単にタスク作成やコメント、更新などを Slack クライアントと Web アプリケーション上で触ってみた。</p>
<p>もう1つ <a href=https://slack.com/app-pages/google-sheets>Google Sheets for Workflow Builder</a> というのも試してみた。ワークフロービルダーのステップに簡単に Google Sheet との連携を実装できるのでめっちゃ簡単。ワークフロービルダーは本当によくできているな。</p>
<h2 id=ジョギング>ジョギング</h2>
<p>今日は調子はよかったけど、お仕事の区切りがよかったので19時に終えて近所の公園にジョギングしてきた。昨日も走ってたのでやや筋肉痛が残りつつ、走り始めは筋肉がきしむ感じだったけど、走っているうちに体があたたまってきて気にならなくなった。時間帯は同じだけど、昨日より陸上部の人たちが半分ぐらい少なかった。曜日によって違うのかなぁ。</p>
</div>
</div>
<div class="post on-list">
<h1 class=post-title>
<a href=/diary/posts/2021/1014/>霖</a>
</h1>
<div class=post-meta>
<span class=post-date>
2021-10-14
</span>
</div>
<span class=post-tags>
#<a href=/diary/tags/book/>book</a>&nbsp;
#<a href=/diary/tags/naming/>naming</a>&nbsp;
</span>
<div class=table-of-contents>
<h2>
目次
</h2>
<nav id=TableOfContents>
<ul>
<li><a href=#データ指向アプリケーションデザイン>データ指向アプリケーションデザイン</a></li>
<li><a href=#霖-ながめ>霖 (ながめ)</a></li>
<li><a href=#ジョギング>ジョギング</a></li>
</ul>
</nav>
</div>
<div class=post-content>
<p>0時過ぎに寝て7時に起きた。けれど、なんかしんどくて起き上がれなくてそのまま2度寝した。1時間ほど寝たらすぐに起きれた。あのしんどさは何だったのか。とはいえ、気付いたら8時半にはオフィスにいたので普段の仕事始めと変わらない見た目になった。お昼に体温を測っていたら37.1℃になってたので熱っぽい雰囲気。日中は特にしんどくはないんだけど。</p>
<h2 id=データ指向アプリケーションデザイン>データ指向アプリケーションデザイン</h2>
<p>4章エンコーディングと進化を読んだ。だんだん内容が難しくなってきて読むのに時間がかかる。これで第一部のデータシステムの基礎を読了した。4章のまとめ。</p>
<blockquote>
<p>データシステムの変更のしやすさ、アジリティのことを本書では <strong>進化性</strong> を呼んでいる。</p>
<p>進化性を高めるには、システムのバージョンアップが容易にできなくてはならない。このとき、サーバーサイドアプリケーションは、大抵の場合、一度にすべてのノードをのバージョンアップができないことから、 <strong>ローリングアップグレード</strong> という手法を用いる。ローリングアップグレードを可能にするには、データフォーマットやスキーマの変更に対して、新旧どちらのフォーマットも、新旧どちらのコードからも扱えないといけない。データフォーマットやスキーマの <strong>前方/後方互換性</strong> を維持することが進化性を高めることに大きく影響する。</p>
<p>メモリを共有していないプロセス間でデータを渡すとき、そのデータをバイト列へエンコードしないといけない。通常プログラムはデータを (少なくとも) 2つの異なる表現で扱う。</p>
<ol>
<li>CPU によるアクセスや操作が効率的になるよう最適化されてメモリ内で表現される</li>
<li>ファイルやネットワーク経由でデータをやり取りするにはバイト列にエンコードしないといけない<br>
この表現はメモリ内のデータ構造とはまったく異なる</li>
</ol>
<p>この2つの表現の間で何らかの変換が必要になる。インメモリの表現からバイトの並びへの変換は <strong>エンコーディング</strong> (シリアライゼーション、マーシャリングとも呼ぶ) 、その逆は <strong>デコーディング</strong> (パース、デシリアライぜーション、アンマーシャリングとも呼ぶ) と呼ぶ。</p>
<p>データエンコーディングフォーマットと、それらの互換性に関する特性。</p>
<ul>
<li>プログラミング言語固有のエンコーディングは1つのプログラミング言語に限定され、しばしば前方及び後方互換性を欠く</li>
<li>JSON, XML, CSV といったテキストフォーマットは広く利用されており、その互換性は利用の方法に依存する
<ul>
<li>オプションのスキーマ言語はあるが、それらは助けになることもあればむしろ障害になることもある</li>
<li>これらのフォーマットはデータ型について多少の曖昧さがあるので、数値やバイナリ文字列などについては注意が必要</li>
</ul>
</li>
<li>thrift, protocol buﬀers, aro といったスキーマを持つバイナリフォーマットではコンパクトで効率的なエンコーディングが可能であり、前方及び後方互換性のセマンティクスも明確に定義されている
<ul>
<li>これらのスキーマは、ドキュメンテーションと静的型付き言語でのコード生成に役立つ</li>
<li>ただし、バイナリフォーマットにはデコードしなければ人にはデータが読めないという欠点もある</li>
</ul>
</li>
</ul>
<p>データフローの形態とエンコーディング。</p>
<ul>
<li>データベースでは、データベースへの書き込みを行うプロセスがデータをエンコードし、データベースからの読み取りを行うプロセスがそのデータをデコードする</li>
<li>RPC と REST API では、クライアントがリクエストをエンコードし、サーバーはそのリクエストをデコードしてレスポンスをエンコードする。そして最後にクライアントがレスポンスをデコードする</li>
<li>非同期のメッセージパッシング（メッセージブローカーあるいはアクター）では、ノードはお互いにメッセージを送信することによって通信し、送信側がメッセージをエンコードし、受信側がそのメッセージをデコードする
<ul>
<li>kafka などを使ったイベント駆動アーキテクチャはこの形態になる</li>
</ul>
</li>
</ul>
<p>多少の注意を払うことで前方/後方互換性やローリングアップグレードは十分に実現可能となる。</p>
</blockquote>
<h2 id=霖-ながめ>霖 (ながめ)</h2>
<p>プロダクトの名前を考えるために万葉集を眺めてた。ふとみつけた <strong>霖</strong> ということばを気に入った。一文字だと「ながめ」または「ながあめ」と読む。霖雨と書くと「りんう」と読むらしい。万葉集では次の和歌で詠まれている。和歌では「長雨」と「眺め」をかけて使うのが常套句らしい。また古文でいうところの眺めはぼんやり見ながら物思いに耽るという意味になるそうだ。</p>
<blockquote>
<p>4217 卯(う)の花を　腐(くた)す霖雨(ながめ)の　始水(みずはな)に　寄るこつみなす　寄らむ児(こ)もがも　大伴家持</p>
<p>(現代語訳) 卯の花を腐らせるほどに痛めつける長雨、この雨のせいで流れ出す大水の鼻先に寄りつく木っ端のように、私に寄り添ってくれる娘でもいてくれたらなあ</p>
<p><a href=https://www.kadokawa.co.jp/product/200803000453/>新版　万葉集　四　現代語訳付き</a></p>
</blockquote>
<blockquote class=twitter-tweet><p lang=ja dir=ltr>この季節の長雨には「卯の花腐し」という別名があります。画像は改元でも話題となった『万葉集』より「卯の花を腐す霖雨の…」という大伴家持の和歌。初夏の卯の花が枯れてしまうような長雨の表現です。詳しくは7月から始まる企画展「雨に詠えば―空模様の古典文学―」にて！ <a href=https://t.co/ZyU1h8TyNv>https://t.co/ZyU1h8TyNv</a> <a href=https://t.co/VaXKX0FGEI>pic.twitter.com/VaXKX0FGEI</a></p>&mdash; 国立公文書館 (@JPNatArchives) <a href="https://twitter.com/JPNatArchives/status/1130805663444213760?ref_src=twsrc%5Etfw">May 21, 2019</a></blockquote>
<script async src=https://platform.twitter.com/widgets.js></script>
<h2 id=ジョギング>ジョギング</h2>
<p>あまり調子がよくなかったので19時にお仕事を終えて近所の公園にジョギングに行ってきた。ワクチンを接種してから運動を控えていたのでジョギングしたのは初めてかな。2-3日に1回ぐらいの頻度でジョギングしている。ワクチン接種した週はウォーキングに留め、次の週は実家で田んぼ仕事でバテてて、今週は初めて行ってきた。ちょっと早い時間帯だったせいか、2つの陸上部が練習していてやや人が多かった。400m級のトラックがあって陸上部の人たちが練習している。練習の邪魔にならないよう、トラックの内側を20-30分とぼとぼジョギングしている。疲れたら歩きながらなのでそんなに距離は走ってない。ジョギング終えてから30分ぐらいストレッチをした。</p>
</div>
</div>
<div class="post on-list">
<h1 class=post-title>
<a href=/diary/posts/2021/1013/>vimgrep 検索の嬉しさ</a>
</h1>
<div class=post-meta>
<span class=post-date>
2021-10-13
</span>
</div>
<span class=post-tags>
#<a href=/diary/tags/morning-activity/>morning activity</a>&nbsp;
#<a href=/diary/tags/book/>book</a>&nbsp;
#<a href=/diary/tags/event/>event</a>&nbsp;
</span>
<img src=/diary/img/2021/1013_vimgrep.png class=post-cover alt="vimgrep 検索の嬉しさ">
<div class=table-of-contents>
<h2>
目次
</h2>
<nav id=TableOfContents>
<ul>
<li><a href=#朝活>朝活</a></li>
<li><a href=#youtube-配信と集中力>YouTube 配信と集中力</a></li>
<li><a href=#データ指向アプリケーションデザイン>データ指向アプリケーションデザイン</a></li>
</ul>
</nav>
</div>
<div class=post-content>
<p>2時頃に寝て6時に起きる。普段、日記は vim で書いている。ちょっとした過去の日記の検索に <code>vimgrep</code> でこと足りるのが嬉しい。テキストで日記を書いていることの利点かな。夜に <a href=https://fin-py.connpass.com/event/226933/>fin-pyコードリーディング会#4</a> に参加した。事前に <a href=https://hackmd.io/bFBFaPbYS1Kqfc97HMlp7Q?view>hackmd</a> に発表内容のメモを書いてた。いろんな発表者の視点があってコードリーディングのイベントはおもしろかった。</p>
<h2 id=朝活>朝活</h2>
<p><a href=https://kobe-sannomiya-dev.connpass.com/event/227678/>【三宮.dev オンライン】リモート朝活もくもく会</a> に参加してみた。何もなかったらだいたい7時頃に起きるのがなにか目的があると6時に起きれる。人体の不思議。せっかく起きたので <a href=/diary/posts/2021/0929/#joel-on-software>前に More Joel on Software を読んだとき</a> に学生向けのアドバイスにあったミクロ経済学の勉強のためにその入門書を読み始めた。参加者が勉強会の常連ばかりだったので朝からわりと雑談してた。2人転職するという話で2人とも東京の会社でフルリモートワークで働くらしい。働き方が変わったなと感じる。その後、第1章の無差別曲線を読んだ。</p>
<h2 id=youtube-配信と集中力>YouTube 配信と集中力</h2>
<p>あんちぽさんの <a href=https://kentarokuribayashi.com/journal/2021/10/09/2021%e5%b9%b410%e6%9c%889%e6%97%a5>2021年10月9日</a> の日記でスライド作成の興がのらないので YouTube 配信しながらやったら集中できてよかったと書いてあったのでちょっと眺めてみた。なんかスライドの作成のやり方とか、自分と違うのかな？とか思いながらみたけど、やり方自体は普通だった。ただ集中できてよかったとあるので普段のやり方とは異なることをすることに意義があるのかな？とも思えた。試しに YouTube Live やってみようとしたら初期設定？に24時間かかるとのこと。代わりに <a href=https://launchpad.net/kazam>kazam</a> というスクリーンリコーダーの使い方を調べてた。勉強会で作業したログとかを録画しておいてなにかに使えたりするかもしれない。</p>
<h2 id=データ指向アプリケーションデザイン>データ指向アプリケーションデザイン</h2>
<p>半日ほどかかって3章ストレージと抽出を読んだ。読みながら書いているので時間がかかる。今日はこれだけ。まとめはこんな感じ。</p>
<blockquote>
<p>データベースのシステムには2つの用途があり、その特性やパフォーマンスを最適化するためにストレージエンジンやデータ構造が異なるもので運用されるようになってきた。</p>
<ul>
<li>オンライントランザクション処理 (OLTP)
<ul>
<li>行指向、トランザクション処理</li>
</ul>
</li>
<li>オンライン分析処理 (OLAP)
<ul>
<li>列指向、分析クエリ</li>
</ul>
</li>
</ul>
<p>OLTP には2つの主要なストレージエンジンがある。</p>
<ul>
<li>B ツリー
<ul>
<li>1970年代からあり、成熟していて且つ効率的なインデックスのデータ構造</li>
</ul>
</li>
<li>LSM ツリー
<ul>
<li>比較的最近開発された、ディスク上でのランダムアクセスをシステム的にシーケンシャルアクセスに変換して、書き込みのスループットを高める手法。もとは Google の BigTable の論文？</li>
</ul>
</li>
</ul>
<p>OLAP の典型的なデータウェアハウスの高レベルでのアーキテクチャでは、大量の行をシーケンシャルにスキャンしなければならないクエリの場合、インデックスはあまり関係なく、データを非常にコンパクトにエンコードし、クエリがディスクから読まなければならないデータの量を最小限にとどめることが重要となる。この目標を達成するのに列指向のストレージが役立つ。</p>
</blockquote>
<p>過去に Cassandra を使ったプロダクトの開発に関わっていたから B ツリーと LSM ツリーの概要は知っていて3章で書いてあることはだいたい理解できた。データウェアハウスに関しては、前にお手伝いしていた会社で普通のログを Amazon Athena で処理すると1時間とかかかって分析クエリが Parquet に変換すると数分で完了したりするのを目の当たりにしてた。分析処理で読み込むデータ量を削減する列指向の考え方は理解しておく必要がある。行指向のデータを列指向フォーマットである <a href=https://parquet.apache.org/>Parquet</a> に変換する <a href=https://github.com/reproio/columnify>columnify</a> のコードも読んだことがあったので内容のイメージはできるけど、実務経験が少ないと全体像がわかっておらず、本書を読みながら学び直ししてた。</p>
</div>
</div>
<div class=pagination>
<div class=pagination__buttons>
<span class="button previous">
<a href=/diary/page/11/>
<span class=button__icon>←</span>
<span class=button__text>最近の日記</span>
</a>
</span>
<span class="button next">
<a href=/diary/page/13/>
<span class=button__text>過去の日記</span>
<span class=button__icon>→</span>
</a>
</span>
</div>
</div>
</div>
</div>
<footer class=footer>
<div class=footer__inner>
<div class="copyright copyright--user">
<span>© 2021 Tetsuya Morimoto</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span>
</div>
</div>
</footer>
<script src=/diary/assets/main.js></script>
<script src=/diary/assets/prism.js></script>
</div>
</body>
</html>