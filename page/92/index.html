<!doctype html><html lang=en><head><meta name=generator content="Hugo 0.109.0"><title>forest nook</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content="t2y"><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="forest nook"><meta property="og:description" content><meta property="og:url" content="/diary/"><meta property="og:site_name" content="forest nook"><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/index.xml rel=alternate type=application/rss+xml title="forest nook"></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><div class=posts><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0416/>病み上がり</a></h1><div class=post-meta><span class=post-date>2022-04-16 (Sat.)</span></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#ストレッチ>ストレッチ</a></li></ul></nav></div><div class=post-content><p>半日寝込んでいて3時に起きて7時に起きた。午後から、昨日寝込んでいたときに届いていたレビュー依頼の内容をレビューして、コードのリファクタリングをした。その後、病み上がりで調子が出ないので今日は気分転換しようと決めた。ストレッチを受けているときの、トレーナーさんの同じ体勢でいるのはよくないという言葉を思い出して、自転車でちょっとサイクリングして、その後、漫画喫茶に行って漫画読んでた。</p><h2 id=ストレッチ>ストレッチ</h2><p>今日の開脚幅は開始前158cmで、ストレッチ後160cmだった。昨日は発熱でずっと寝込んでいたせいか、体が硬くなってしまっていていつもよりストレッチを受けていて辛い部位が多かった。トレーナーさん曰く、ずっと同じ体勢でいるのが体にとってよくないとのこと。普段よりも肩甲骨まわりの筋肉が硬くなってしまっていたらしい。病み上がりで体調が整っていないときにストレッチを受けるのも復調させるための準備としてちょうどよかったのかもしれない。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0415/>ワクチンの副反応でダウン</a></h1><div class=post-meta><span class=post-date>2022-04-15 (Fri.)</span></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/founding/>founding</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#隔週の雑談>隔週の雑談</a></li><li><a href=#ワクチンの副反応>ワクチンの副反応</a></li></ul></nav></div><div class=post-content><p>3時に寝て6時に起きた。1時までインフラ作業して帰ってきて、ワクチン接種のせいか、あまりうまく眠れなかった。朝に熱を測ったら37.2℃だったのでぎりぎり平熱だった。</p><h2 id=隔週の雑談>隔週の雑談</h2><p>顧問のはらさんと隔週の打ち合わせ。今日の議題は次の通り。徐々に熱が出てきてしんどかったせいか、情報共有の報告程度で終えた。</p><ul><li>今期の予算策定</li><li>次のお仕事を探す段取りの見通し<ul><li>現プロジェクトの区切りが5月末にあることから次の契約更新のタイミング (7月末) で契約終了する可能性がある</li></ul></li><li><a href=/diary/posts/2022/0115/#ワーケーション延期>延期したワーケーション</a> の再計画<ul><li>6月か7月ぐらいがよさそう</li></ul></li></ul><h2 id=ワクチンの副反応>ワクチンの副反応</h2><p>朝オフィスで測ったときは37.2℃でこのぐらいなら普通にお仕事できるかなと始めたんだけど、段々体温が上がってきて10時ぐらいには37.9℃になって、しんどいから一旦家に帰って横になって、デイリースクラムだけ家から参加した。その後もずっと寝込んでた。何回か起きて熱を測ったら最高38.5℃まで上がった。厚労省のサイトによると、3回目の副反応は2回目と同等とある。私は2回目の副反応はここまでひどくなかったのでこの差はファイザーとモデルナの違いなのかもしれない。熱が出て寝込むとか、数年に1回ぐらいの頻度でしか起きない。病気になったらこのぐらいしんどいんだなという、しんどさを思い出すのにちょうどよかったのかもしれない。</p><ul><li><a href=https://www.cov19-vaccine.mhlw.go.jp/qa/0101.html>追加（3回目）接種ではどのような副反応がありますか。2回目より重いのでしょうか。</a></li></ul></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0414/>コロナワクチン3回目</a></h1><div class=post-meta><span class=post-date>2022-04-14 (Thu.)</span></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/infrastructure/>infrastructure</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#ワクチン3回目接種>ワクチン3回目接種</a></li><li><a href=#インフラ移行作業>インフラ移行作業</a></li></ul></nav></div><div class=post-content><p>22時に寝て3時に起きた6時に起きた。季節の変わり目のせいか、いつも眠い。</p><h2 id=ワクチン3回目接種>ワクチン3回目接種</h2><p><a href=/diary/posts/2021/0927/#コロナワクチン2回目摂取>2回目は昨年の9月27日</a> に接種した。6ヶ月以上経たないといけないので3月27日以降に接種資格を得て、実際に接種券が届いたのが4月7日だった。神戸市は初回のときにまごまごしたので他の自治体よりも遅れている。これまでファイザーを2回接種したので今回はモデルナを受けてみることにした。モデルナを扱っていてネット予約できるもっとも近くの診療所を予約した。オフィスから自転車で15分ぐらいのところ。16:30の予約なのに16時過ぎぐらいに行ったら普通に受け付けしてくれてすぐに接種もできた。16:05に接種終えて16:20まで待機してオフィスに戻ってきて普通にお仕事してた。その1時間半後に熱を測ったら37.0℃だった。その後もやや熱っぽいけど、平気とは言えば平気。</p><h2 id=インフラ移行作業>インフラ移行作業</h2><p>昨日の続き。フロントエンドのテスト環境が壊れる可能性があるため、他メンバーが使っていない夜に移行作業を行う。POの人たちがQA検証を19-21時ぐらいにやっていることが多いので21時以降に作業すると連絡しておいた。なかなか大変だった。最悪の場合、数時間テスト環境を使えませんと伝えていたものの、その通りで4時間ぐらい検証作業をしていた。cloudfront の distribution 設定を CloudFrontWebDistribution から Distribution へ移行して、新しいやり方であるマネージドポリシーを使うようにした。この設定が意図した振る舞いにならなくて検証作業に時間を割いた。</p><p>cloudfront 経由で web api を呼び出すルートがあってキャッシュを無効にしたいのだが、無効にしたキャッシュポリシー (ttl をゼロにする) を作るとヘッダーの設定ができない。次のようなエラーになる。</p><pre tabindex=0><code>The parameter HeaderBehavior is invalid for policy with caching disabled.
</code></pre><p><a href=https://github.com/aws/aws-cdk/issues/13441>(cloudfront): Cache Policy cannot forward Authorization header. #13441</a> によると、maxTTL を1秒にして <code>Authorization</code> ヘッダーをオリジンに転送するようには設定できる。キャッシュメソッドは GET と HEAD なので実運用上は問題ないとは思うが、この回避策がないかどうかを調べて検証していた。結果としてはなかった。<a href=https://docs.amazonaws.cn/en_us/AmazonCloudFront/latest/DeveloperGuide/add-origin-custom-headers.html#add-origin-custom-headers-forward-authorization>Configuring CloudFront to forward the Authorization header</a> には <code>Authorization</code> ヘッダーを転送する方法は次の2通りとある。</p><ol><li>cache key に含める</li><li>Managed-AllViewer という origin request policy をすべての viewer requests に含める</li></ol><p>最終的には1番目のやり方で対応はしたが、2番目のオリジンリクエストポリシーを設定する方法も検証してみた。オリジンリクエストポリシーを単体で設定することはできなくて、キャッシュポリシーも一緒に設定しないといけないことからキャッシュポリシーの設定の影響を受けて意図したように <code>Authorization</code> ヘッダーの転送はできなかった。</p><ul><li>cache policy: Managed-CachingDisabled</li><li>origin request policy: Managed-AllViewer</li></ul></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0413/>cdk の cloudfront の distribution 設定の移行</a></h1><div class=post-meta><span class=post-date>2022-04-13 (Wed.)</span></div><span class=post-tags>#<a href=/diary/tags/cdk/>cdk</a>&nbsp;
#<a href=/diary/tags/infrastructure/>infrastructure</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#フロントエンドのインフラ作業の続き>フロントエンドのインフラ作業の続き</a></li></ul></nav></div><div class=post-content><p>0時に寝て5時過ぎに起きた。</p><h2 id=フロントエンドのインフラ作業の続き>フロントエンドのインフラ作業の続き</h2><p>昨日、cloudfront の distribution 設定のビヘイビアのキャッシュ設定が誤っていることに気付いたので cdk のコードを修正していく。<a href=https://aws.amazon.com/jp/blogs/news/amazon-cloudfront-announces-cache-and-origin-request-policies/>Amazon CloudFront キャッシュポリシーとオリジンリクエストポリシーを発表</a> によると、2020年ぐらいに distribution ごとに個別設定していたのをマネージドポリシーというリソースを参照することで一元管理できるようになったらしい。cdk のコードで言えば、次の issue で対応されているが、これらの機能は <a href=https://docs.aws.amazon.com/cdk/api/v2/docs/aws-cdk-lib.aws_cloudfront.Distribution.html>aws_cloudfront.Distribution</a> のみに追加されている。従来の CloudFrontWebDistribution では使えないので distribution 設定そのものを新しいやり方に移行する必要がある。</p><ul><li><a href=https://github.com/aws/aws-cdk/issues/9644>https://github.com/aws/aws-cdk/issues/9644</a></li><li><a href=https://github.com/aws/aws-cdk/issues/9647>https://github.com/aws/aws-cdk/issues/9647</a></li></ul><p>基本的には同じ設定を行うので新しいクラスのメンバーや構造にあわせて移行するだけなので難しくはないけれど、1つずつ設定内容の移行方法を確認していかないといけないから手間暇はかかる。cdk のドキュメントをみると、型に対してどういった設定をすればよいかが書いてあって、あとはメソッドの定義などもみながら自分たちの設定に近いものを選択していくといった作業になる。難しくはないけど時間はかかる。半日ほどやって移行のための pr を作成した。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0412/>cloudfront のキャッシュ設定</a></h1><div class=post-meta><span class=post-date>2022-04-12 (Tue.)</span></div><span class=post-tags>#<a href=/diary/tags/infrastructure/>infrastructure</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#フロントエンドのインフラ作業>フロントエンドのインフラ作業</a></li></ul></nav></div><div class=post-content><p>1時に寝て5時に起きた。</p><h2 id=フロントエンドのインフラ作業>フロントエンドのインフラ作業</h2><p>これまでバックエンドのインフラ作業をしてきたが、そちらの移行作業は完了した。フロントエンドのインフラも積み残しが多々あるのでこの機にリファクタリングする。差分が出ないことを確認して cf のテンプレートのドリフト結果を解消したものをデプロイしたらフロントエンドが壊れた。具体的には xhr の web api 呼び出しに対して認可エラーが返るようになった。数時間ほどの調査の結果、cloudfront の distribution 設定のビヘイビアのキャッシュ設定で web api 呼び出しのときに authorization ヘッダーを転送するための設定が漏れていることがわかった。cdk のコードにはそんな設定がどこにもなく差分も表示されないことから、フロントエンドの cdk コードも全く保守されていないことがわかった。デプロイするときに前回のデプロイが半年前だったのでなんか悪い予感はしたんよね。インフラ担当者の怠慢が度を越し過ぎてもう何が起きても私は驚かないけど。設定に漏れがある前提でフロントエンドのインフラをリファクタリングしていかないといけない。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0411/>cdk/cf の Stack とライフサイクル</a></h1><div class=post-meta><span class=post-date>2022-04-11 (Mon.)</span></div><span class=post-tags>#<a href=/diary/tags/cdk/>cdk</a>&nbsp;
#<a href=/diary/tags/infrastructure/>infrastructure</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#インフラ変更の本番作業>インフラ変更の本番作業</a></li></ul></nav></div><div class=post-content><p>0時に寝て5時に起きた。</p><h2 id=インフラ変更の本番作業>インフラ変更の本番作業</h2><p>先週やっていた様々なインフラ構築の改善を本番環境に適用する。cf の changeset は23とかになっていた気がする。大きな括りで次の3つの移行作業をした。</p><ul><li>rds をスタックから切り離す</li><li>cdk の v1 から v2 へのアップグレード</li><li>ポリシーとセキュリティグループのドリフト解消</li></ul><p>私は本番環境へのアクセス権限をもっていないので社員さんの作業内容を伝えてやってもらう。cf のテンプレートの更新やドリフトの解消など、テスト環境で10時間以上は費やした検証結果が功を奏して、本番作業は想定外の事象も発生せず1.5時間で完了した。cdk のコードも意図した設定になるように修正済みだし、なにも問題は発生しない。cdk のコードを書くときは cf のイベントログやドリフト結果と実際のインフラの振る舞いを確認するといった検証には時間がかかるが、それができてしまえば本番環境の構築はうまくできる。それがわかっているインフラ担当者がいなくなると、また1から担当者が検証する必要があって保守は大変かもしれないけど。</p><p>同じ Stack でどういったリソースを管理するかというライフサイクルは難しい問題かもしれない。今回 rds を削除したのは、なんらかの理由で手動運用で rds を変更することがあって、アプリケーション Stack から外してしまった方が保守しやすいのではないかという意見が出たため。それが正しいかどうかはわからないが、一度作ったリソースを削除しないもの (vpc や s3 bucket など) をアプリケーション Stack で管理すると、再作成できなくて面倒くさいことがある。というのは、再作成は新規に作成 → 古いリソースを削除の順番で処理されるため、一意な名前をもつリソースは基本的に再作成できない。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2022/0410/>お花見リハーサル</a></h1><div class=post-meta><span class=post-date>2022-04-10 (Sun.)</span></div><span class=post-tags>#<a href=/diary/tags/event/>event</a>&nbsp;
#<a href=/diary/tags/day-off/>day off</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#お花見-at-生田川公園>お花見 at 生田川公園</a><ul><li></li></ul></li></ul></nav></div><div class=post-content><p>0時に寝て6時に起きた。たぶん休暇をとったのはお正月以来かな。今日はオフィス行かなかった。</p><h2 id=お花見-at-生田川公園>お花見 at 生田川公園</h2><p>三ノ宮.devとbizpyの合同イベントとしてお花見を開催した。とはいっても、イベントページも作らず内輪で募集したので参加者は4人と小さく開いた。私もお花見やってもいいかと思いつつ、<a href=/diary/posts/2022/0401/#生田川公園の桜>準備に着手するのが遅れた</a> ので今回はリハーサルと称して来年の本番のための布石と位置付けた。たぶんもう1-2週間早く準備に着手していればもっとできたこともあったとは思うけど、まぁ最初はこんなもんか。</p><p><figure><img src=/diary/img/2022/0410_hanami1.jpg></figure><figure><img src=/diary/img/2022/0410_hanami2.jpg></figure></p><h4 id=準備したこと>準備したこと</h4><p>私が事前に準備したのはこのぐらい。労力にして数時間といったところか。</p><ul><li>事前に桜の開花状況を確認して日程調整</li><li>ほとんどの必需品はダイソーで購入</li><li>参加者と連絡をとるためのプライベートチャンネル開設</li></ul><h4 id=実際にやってみてわかったこと>実際にやってみてわかったこと</h4><p>ダイソーで売っているこのサイズのレジャーシートが食べものを並べて4人で囲むのにちょうどよいサイズだった。</p><blockquote><p>レジャーシート約4.5畳サイズ （ブルー、約270×270cm）：300円</p><p><a href=https://www.daiso-sangyo.co.jp/item/12550>https://www.daiso-sangyo.co.jp/item/12550</a></p></blockquote><p>各自一品は食べものか飲みものを持ち込みと呼びかけていたら次のものが集まった。事前に何をもってくるか示し合わせたわけでもないのに、みんなバラバラになってちょうどよかった。次回は示し合わせをしようとは思うが、意外とかぶらないものだなと感心した。</p><ul><li>手羽元</li><li>唐揚げ</li><li>カルボナーラ</li><li>ピザ</li><li>551のシュウマイ</li><li>ミートボール</li><li>いなり寿司</li><li>ビール</li><li>日本酒</li><li>ワイン</li></ul><p>天気もよくて11-16時という昼間の開催で直射日光を浴び過ぎたせいか、帰ってから熱気があってバテてた。4月になって日差しも強くなっているので直射日光を遮るなにかを用意してもよかった。大きな桜の木があればそれでもよかったんだけど、そうでもなく、地球が自転するので最初は陰になっていた場所も移動してしまった。わりと4人でわいわい話せたので小さい勉強会やイベントの方が距離感の近いイベントになってよかったりもする。たぶん10人とかいたらまた違う距離感のイベントになっていたんじゃないかと推測する。</p><h4 id=ふりかえり>ふりかえり</h4><p><a href=https://www.kobe-park.or.jp/kouen_keikaku/2018/11/05/%E7%94%9F%E7%94%B0%E5%B7%9D%E5%85%AC%E5%9C%92/>生田川公園</a> は住んでいるところから15分ぐらい歩けば行ける場所で花見イベントができることがわかって収穫だった。桜の木がたくさんあるというわけでもないので近所の人が集まるぐらいで、わざわざ外部の地域からくるほどのスポットではない。そのため、混雑していないというのが大きな訴求点と言える。バーベキューは禁止と書いてあったけど、他にも野外イベントに使えるかもしれない。河川沿いにある公園だし、夏に花火大会とか、秋にお月見とかやれそうな気はした。</p></div></div><div class=pagination><div class=pagination__buttons><a href=/diary/page/91/ class="button previous"><span class=button__icon>←</span>
<span class=button__text>最近の日記</span></a>
<a href=/diary/page/93/ class="button next"><span class=button__text>過去の日記</span>
<span class=button__icon>→</span></a></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>© 2021 Tetsuya Morimoto</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>