<!doctype html><html lang=en><head><meta name=generator content="Hugo 0.109.0"><title>forest nook</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content="t2y"><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="forest nook"><meta property="og:description" content><meta property="og:url" content="/diary/"><meta property="og:site_name" content="forest nook"><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/index.xml rel=alternate type=application/rss+xml title="forest nook"></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><div class=posts><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0829/>コンテナー間のデータ通信と named pipe</a></h1><div class=post-meta><span class=post-date>2023-08-29 (Tue.)</span></div><span class=post-tags>#<a href=/diary/tags/container/>container</a>&nbsp;
#<a href=/diary/tags/linux/>linux</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#コンテナー間のデータのやり取り>コンテナー間のデータのやり取り</a></li></ul></nav></div><div class=post-content><p>22時頃から寝ていて2回起きて3時に起き出して、4時までネットみたりしていて、また寝て6時に起きた。生活のリズムがおかしい。</p><h2 id=コンテナー間のデータのやり取り>コンテナー間のデータのやり取り</h2><p>昨日 <a href=/diary/posts/2023/0828/>モジュール分割</a> したことにより、いままで1つのモジュールで管理していたが、モジュールを分割したのでそれぞれのバージョンを取得できるとよいという話題が出た。コンテナー内にアプリケーションのバイナリがあり、バイナリを実行するとバージョン情報を取得できる。それぞれのモジュールは独立したコンテナで動いてるため、コンテナー間でその情報を受け渡す方法が必要になる。ググってみると次の so がヒットして named pipe がプラクティスだという。</p><ul><li><a href=https://stackoverflow.com/questions/32163955/how-to-run-shell-script-on-host-from-docker-container>How to run shell script on host from docker container?</a></li></ul><p>ホスト os 上の named pipe をコンテナーの volumes でマウントして、それぞれのコンテナーが読み書きすればよい。構築時に named pipe さえ作ったらコンテナー内での読み書きでデータ通信を実現できるため、シンプルでよいんじゃないかと思えた。</p><p>mypipe という named pipe を作る。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ mkfifo mypipe
</span></span></code></pre></div><p>読み込み用コンテナーのための read-Dockerfile を作る。tail コマンドで named pipe を読む。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ vi read-Dockerfile
</span></span><span style=display:flex><span>From bash:latest
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ENTRYPOINT <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;tail&#34;</span>, <span style=color:#e6db74>&#34;-f&#34;</span>, <span style=color:#e6db74>&#34;/app/mypipe&#34;</span> <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>$ docker build -t mypipe-read:latest -f read-Dockerfile .
</span></span></code></pre></div><p>named pipe をマウントして読み込み用コンテナーを起動する。</p><pre tabindex=0><code>$ docker run --rm --mount type=bind,source=&#34;$(pwd)&#34;/mypipe,target=/app/mypipe,readonly mypipe-read
</code></pre><p>書き込み用のエントリーポイントのスクリプトはちょっと工夫がいる。おそらく Dockerfile 内で直接リダイレクトの操作ができない (やり方がわからなかった) 。シェルスクリプトを呼び出す形にして、シェルスクリプト内部でリダイレクトにより、named pipe に書き込みする。</p><p>エントリーポイントのスクリプトは次のような感じ。<code>eval "$@"</code> で任意のコード実行できるようにちょっと細工。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ vi myentrypoint.sh
</span></span><span style=display:flex><span><span style=color:#75715e>#!/bin/sh</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cleanup<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;cleanup ...&#34;</span>
</span></span><span style=display:flex><span>    exit <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>trap cleanup INT TERM
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>while</span> true
</span></span><span style=display:flex><span><span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>date<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    eval <span style=color:#e6db74>&#34;</span>$@<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    sleep <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>done</span>
</span></span></code></pre></div><p>書き込み用コンテナーのための write-Dockerfile を作る。先の myentrypoint.sh を <code>ENTRYPOINT</code> として起動させる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ vi write-Dockerfile
</span></span><span style=display:flex><span>From bash:latest
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>COPY myentrypoint.sh /app/
</span></span><span style=display:flex><span>RUN chmod +x /app/myentrypoint.sh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ENTRYPOINT <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;/app/myentrypoint.sh&#34;</span> <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>$ docker build -t mypipe-write:latest -f write-Dockerfile .
</span></span></code></pre></div><p>適当に乱数を生成する cli を eval 実行させる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ docker run --rm --mount type<span style=color:#f92672>=</span>bind,source<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>pwd<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>/mypipe,target<span style=color:#f92672>=</span>/app/mypipe mypipe-write <span style=color:#e6db74>&#34;tr -dc 0-9 &lt; /dev/urandom | fold -w 8 | head -1  &gt; /app/mypipe&#34;</span>
</span></span></code></pre></div><p>読み込み用コンテナーで乱数を表示できるはず。</p><p>なにも難しくなく、linux の標準の機能を使ってコンテナー間のデータ通信を実現できたことにちょっと驚いた。</p><p>go で named pipe を読むときは linux ならば <code>syscall.O_NONBLOCK</code> を指定することで書き込みしていなくてもブロックせずに読める。値を取得できない可能性はあるけど、それが許される要件ならこれで済む。またテックブログにまとめたい。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>readNamedPipe</span>(<span style=color:#a6e22e>path</span> <span style=color:#66d9ef>string</span>) ([]<span style=color:#66d9ef>byte</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>flag</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>O_RDONLY</span> | <span style=color:#a6e22e>syscall</span>.<span style=color:#a6e22e>O_NONBLOCK</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>pipe</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>OpenFile</span>(<span style=color:#a6e22e>path</span>, <span style=color:#a6e22e>flag</span>, <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>ModeNamedPipe</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to open path: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>pipe</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>reader</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bufio</span>.<span style=color:#a6e22e>NewReader</span>(<span style=color:#a6e22e>pipe</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>b</span>, <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>reader</span>.<span style=color:#a6e22e>ReadLine</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to read line: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>b</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0828/>go の処理系も驚く sdk のコード生成</a></h1><div class=post-meta><span class=post-date>2023-08-28 (Mon.)</span></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/design/>design</a>&nbsp;
#<a href=/diary/tags/openapi/>openapi</a>&nbsp;
#<a href=/diary/tags/ci/cd/>ci/cd</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#msgraph-sdk-go-のサイズ問題>msgraph-sdk-go のサイズ問題</a></li></ul></nav></div><div class=post-content><p>0時に寝て何度か起きて6時に起きた。そのまま7時過ぎまでだらだらしてた。しんどい。</p><h2 id=msgraph-sdk-go-のサイズ問題>msgraph-sdk-go のサイズ問題</h2><p>先週 <a href=/diary/posts/2023/0825/#msgraph-sdk-go-を使った開発>msgraph-sdk-go を使った開発</a> を終えてデプロイする段階になってライブラリのサイズが大きくて、コンパイル速度が遅くなったり、バイナリサイズが大きくなったりする弊害があることに気付いた。コンパイル速度は2-3倍遅くなり (3分が7-10分ぐらい)、バイナリサイズも2-3倍大きくなる (30 MiB が 100 MiB とか) 。たまたまこのリポジトリは他のツール類からも依存パッケージとして使われるものなので想定よりも影響が大きいことに気付いた。</p><p>朝からチームのメンバーとミーティングして、本来は qa に入ったこの時期にこんな変更をすべきではないが、これは放置するデメリットが大きいのでリポジトリ分割 (モジュール分割) しようと提案して了承を得た。私がやれば作業は1日もあれば完了するだろうと見積もって、見積もり通り、夕方には分割したモジュールをテスト環境にデプロイして当面の解決を得た。アプリケーションのモジュール構造をちゃんとレイヤー化して作ってあるから、今回みたいに急遽、モジュール分割が必要になってもほぼ変更する必要はなかった (たった1箇所だけ) 。</p><p>この本質的な問題は次の issue のコメントで説明されている。</p><ul><li><a href=https://github.com/microsoftgraph/msgraph-sdk-go/issues/129#issuecomment-1098028043>Issue with the size of the API surface of the models package #129</a></li></ul><p>ざっと機械翻訳してみる。</p><blockquote><p><strong>コンテキスト</strong></p><p>この SDK は <a href=https://github.com/microsoft/kiota>kiota</a> を使用してメタデータから自動的に生成されます。オリジナルのメタデータは、Microsoft Graph の配下にあるすべてのサービスチーム（v1用とベータ用）によって入力された CSDL です。この CSDL は最終的に OpenAPI のフォーマットに変換されますが、これは非常に大きなものです（1k 以上のエンドポイント、1.5k のモデル &mldr;）。API のサイズが大きいため、完全な API surface の SDK を手作りすることは実現不可能でしょう。</p><p>私たちは、SDK を複数のサブモジュール（ファイル用、メール用など）に &ldquo;スライス&rdquo; して、人々が関心のあるものだけを簡単に入手できるようにすることをしばらく考えてきました。実際、私たちは PowerShell でこれを実現しました。しかし、&ldquo;グラフ&rdquo; の性質（すべてのモデルは互いにある程度関連している）と構築されるアプリケーションの多様性により、スライスは誰にとっても &ldquo;正しい&rdquo; ものにはならない（大きすぎたり、小さすぎたり、モデルの重複につながったり&mldr;）。</p><p>そのような理由から、私たちは「完全なSDK」を提供することにしました。すべての人にとって理想的とは言えないかもしれませんが、Go開発者の中には「アプリケーションを作るためのSDKが欲しいだけ」という人もいると感じています（以下で説明する2つ目のオプションとは対照的です）。</p></blockquote><blockquote><p><strong>Go の欠点</strong></p><p>Go の探求を通して、いくつかの欠点に気づいた。現時点では、私たちのプロジェクトやパッケージが適切にセットアップされていないせいなのか、Go や大規模プロジェクトの制限のせいなのかはわからない：</p><p>go build は、変更されておらず、依存関係も変更されていないサブパッケージをリビルドすることが多い。go build が直前に実行されていても、go test がリビルドすることがよくあります。なぜある種のキャッシュに頼らないのでしょうか？同じ問題が go lint にもある。<br>私には、たくさんのサブパッケージがある大きなプロジェクトをビルドするコストは、依存関係が更新されたり、キャッシュが削除されたり、コードが変更されたりしない限り、「セッションごとに一度」だけ支払われるべきだと感じます。</p><p>私たちのプロジェクト構成／構造において、そのような状況を改善するための最適化について、自由に概説してください。また、Goコミュニティ（Goコンパイラを開発している人たちなど）と関わって、そのようなフィードバックを提供する方法があれば、喜んでそうします。私たちのプロジェクトは、その規模の大きさから、世の中にあるほとんどのGoパッケージと比べると、ちょっと変わり者だとわかっています。</p></blockquote><blockquote><p><strong>適切なサイズの SDK</strong></p><p>最後に、すべてのエンドポイントを備えた完全な SDK を持つことは、様々な理由からすべての人に適しているわけではないことを認識しています。私たちは新しい &ldquo;適切なサイズのセルフサービスSDKエクスペリエンス&rdquo; を可能にするために取り組んでいます。そこでは、APIユーザーは誰でも、この SDK と同じように見え、同じように感じる SDK を生成することができますが、完全な API サーフェスの代わりに、彼らのアプリケーションのために彼らが気にするエンドポイント/モデルのみが含まれています。
私たちは今、そのような取り組みに本当に早くから取り組んでいますが、それでもフィードバックをいただけるとうれしいです。大まかな手順はこんな感じだ：</p><ol><li>新しいgoプロジェクトを作成するか、既存のプロジェクトを特定する。</li><li>kiotaの依存関係を追加するか、msgraph-sdk-go-coreを追加します（これはKiotaの依存関係をプルし、いくつか追加します）。</li><li>グラフエクスプローラで必要なリソースを選択（左パネル、2番目のタブ、&mldr;、&ldquo;コレクションに追加&rdquo;）。</li><li>コレクションをプレビューをクリックし、postmanコレクションとしてエクスポートします。</li><li>hidi を postmanコレクションと先ほど共有したOpenAPIの完全な説明文と一緒に使って、&ldquo;フィルタリングされた&rdquo; OpenAPI フォーマットを生成する。</li><li>kiotaを使って、プロジェクトにMicrosoft Graph用のGoクライアントを生成する。</li><li>APIの呼び出しを開始する。</li></ol><p>この時点で、私たちはこれらのステップをすべて文書化し、効率化するために取り組んでいます（おそらくステップ4～5を圧縮しています）。このアプローチの素晴らしいところは、ステップ5から7までが、Microsoft Graphだけでなく、呼び出したいOpenAPIで記述されたAPIで動作することだ。<br>繰り返しますが、この最後の提案はまだ初期段階です。自由に試して、様々な場所でフィードバックを提供してください。</p><p>この長い投稿で、私たちがどこに向かっているのかが明らかになり、Goコミュニティからこれらの側面すべてについてさらにフィードバックが得られると本当に助かる！</p></blockquote><p>簡単に言えば、ms graph api の体系が巨大過ぎて、その定義は <a href=https://raw.githubusercontent.com/microsoftgraph/msgraph-metadata/master/openapi/v1.0/openapi.yaml>openapi.yaml</a> にあるが、この定義からすべてコード生成すると巨大なモデル定義をもつ sdk が出来上がってしまったという話しである。後半に書いてあるワークアラウンドとして kiota で必要なモデルだけを選択して専用 sdk を生成すればサイズを小さくできるとある。しかし、それはそれで <a href=https://developer.microsoft.com/en-us/graph/graph-explorer>graph explorer</a> で選択しないといけなかったりして面倒そうではある。次のドキュメントでもその手順について書いてある。</p><ul><li><a href=https://devblogs.microsoft.com/microsoft365dev/building-go-applications-with-the-microsoft-graph-go-sdk/#create-a-smaller-and-tailored-microsoft-graph-go-client-library>Create a smaller and tailored Microsoft Graph Go client library</a></li></ul><p>うちの用途ではモジュール分割により、局所化したのでひとまずこの問題は大きな影響をもたないようになった。また余裕があるときにモデルを選択して専用 sdk を自動的に生成する仕組みを構築できるならそれに挑戦してもよいかもしれない。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0827/>気分転換に開発はお休み</a></h1><div class=post-meta><span class=post-date>2023-08-27 (Sun.)</span></div><span class=post-tags>#<a href=/diary/tags/founding/>founding</a>&nbsp;
#<a href=/diary/tags/career/>career</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#マイクロ法人のススメ>マイクロ法人のススメ</a></li></ul></nav></div><div class=post-content><p>0時に寝て3時5時7時と起きて8時に起きた。起きてからネットの記事を読みながらしばらくだらだらしていた。11時ぐらいにはオフィスへ行って今月分の請求書を発行して、9月のイベントで発表するネタの調査、三ノ宮.dev の slack で <a href=/diary/posts/2023/0815/#課題管理とプロジェクトマネージメントの話を熱く語る>課題管理について話した podcast</a> を紹介してもらったお礼を述べたりとか、いろいろ自社のお仕事をしていた。</p><h2 id=マイクロ法人のススメ>マイクロ法人のススメ</h2><p>たまたまだが、私がよく行くお店でマスターが1人でやり繰りしている飲食店が増えてきた。またコワーキングスペースなどへ行くと、マイクロ法人でがんばっている人たちと交流する機会も増えてきた。私自身マイクロ法人として1人で会社や事業を経営している立場なのでそういった似たもの同士な人たちとよく気があう。同じような人たちをみていて、マイクロ法人のなにが楽しいのかを、いずれちゃんとしたブログの記事にしたいと思う。外から観察していても働き方に共通点がある。</p><p>よいところを述べる前に、わるいところも言うべきだと思う。</p><ul><li>(サラリーマンと比較して) 会計や税制といった財務知識が必要になる</li><li>(サラリーマンと比較して) 書類などの事務手続き作業は増える</li><li>(サラリーマンと比較して) 短期的な安定や信頼を得にくい</li><li>自分で営業しないといけない</li><li>自分で事業を設計しないといけない</li><li>同僚と雑談できない、困ったときに助けてもらえない</li><li>複数人で対応するような規模の大きな仕事はできない</li></ul><p>たくさんわるいところもある。これらのわるいところを受け入れた上でよいところもある。</p><ul><li>お仕事はすべて自分で決められる</li><li>目標設定をしなくて済む (他者評価もされなくて済む)</li><li>(サラリーマンと比較して) 事業がうまくいけばより大きな対価を得られやすい</li></ul><p>デメリットよりもメリットが上回るのならマイクロ法人がいいと私は思う。もちろん若い人には勧めない。経験のある人が評価されずにつまらない組織の仕事で残りの余生を過ごすぐらいなら、自分で思うよう好き勝手働いた方が人生としては楽しいのではないかと思ったりする。もちろんそれで失敗する人もいるだろうし、私も今後失敗するかもしれない。失敗したときに会社を辞めずにサラリーマンをしておけばよかったと後悔する日が来るかもしれない。仮に失敗したとしても、その瞬間までのマイクロ法人で働いてきた日々に価値を見出せればそれだけでよかったと思えるかどうか、と言い換えられるかもしれない。</p><blockquote><p>楽しく働く</p></blockquote><p>うちの会社の価値観の1つにしようと考えている。歳をとってシニア社員になるほど、楽しく働いている人は少なくなっていくように傍からはみえる。会社から評価されず、おもしろい仕事も任されず、ただ生活のために働いている人は多いのだろう。状況が許せば、そんな人がマイクロ法人になると、働く楽しさを取り戻せるかもしれない。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0826/>全身疲労と気分転換</a></h1><div class=post-meta><span class=post-date>2023-08-26 (Sat.)</span></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/founding/>founding</a>&nbsp;
#<a href=/diary/tags/accounting/>accounting</a>&nbsp;
#<a href=/diary/tags/drinking/>drinking</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#ストレッチ>ストレッチ</a></li><li><a href=#請求書のテンプレート作り>請求書のテンプレート作り</a></li><li><a href=#立ち呑み屋-本番>立ち呑み屋 本番</a></li></ul></nav></div><div class=post-content><p>23時に寝て何度か起きて6時に起きた。疲労でバテバテ。</p><h2 id=ストレッチ>ストレッチ</h2><p>先週もあまりよい状態ではなかったけれど、今日はことさら悪かった。疲労は着実に蓄積するんやと実感する。左足は筋肉痛やなって感じだけど、右足はそのうち足が動かなくなるんじゃないかとすら思えた。ふくらはぎは左右ともにパンパンだし、右の股関節の部位はピキッて感じで痛みが出たりするから根本的に悪そう。足全体が硬かったように思える。腰もいくつか張りがあって、特定のツボはかなり痛くてなにかが悪いのだと思えた。臀部のツボも一部だけすごく効いて痛かった。肩周りも凝りや張りはいつもより大きかったように思う。今日の開脚幅は開始前154cmで、ストレッチ後156cmだった。久しぶりにこんな調子の悪いのも珍しいなと思えた。あと2週間ぐらいがお仕事のピークだと思うのでもう少しだけもてばよい。</p><h2 id=請求書のテンプレート作り>請求書のテンプレート作り</h2><p>10月から施行されるインボイス対応の請求書として 10%, 8% の消費税の税率を明記して別々に小計を記載しなければならない。そろそろ個々の企業でも運用が始まるところ。うちの会社が扱う商品は10%のみだが、請求書のフォーマットそのものを変更しないといけない。ちょうど freee 側でもその対応で6-7月に新しい帳票管理の機能をリリースしていた。8月から順次切り替えとなっていた。私は開発にいっぱいいっぱいだったからベータ版は見送って正式リリース後に対応することにしていた。それが今日だ。今月分の請求書はインボイス対応の新しいフォーマットで作る。</p><p>その移行をしていて、この機会に会社のロゴや角印も請求書に載せることにした。はらさんに角印をどうやってデータ化したらよいかを尋ねたら、普通に白い紙に押印してスキャナで取り込んで、白色を透過処理して使っているとのこと。</p><p>オフィスの複合機で白い紙で押印した角印をスキャンする。pdf でダウンロードできる。pdftoppm で pdf を png に変換する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pdftoppm -png corporate-seal-square.pdf corporate-seal-square
</span></span><span style=display:flex><span>$ ls corporate-seal-square-*
</span></span><span style=display:flex><span>corporate-seal-square-1.png  corporate-seal-square-2.png
</span></span></code></pre></div><p>あとは白い背景を透過処理するだけ。pinta, incscape とやってみたけど、どうもうまくできない。最終的に次の記事を参考にしながら gimp を使って「ファジー選択」で透過処理したいところをちょこちょこ選択しながら変換していくのがもっとも私にとって簡単だった。</p><ul><li><a href=https://howpon.com/1450>GIMP – 画像を切り抜き背景を透明・透過して保存する方法</a></li></ul><p>請求書のテンプレートに対して角印を読み込んで、社名に重なるように配置するのが慣習らしい。なぜ社名に角印を重ねるかというと偽造や改ざんを防止するという意図になる。電子データの請求書に角印を載せる意味はないけれど、紙の慣習にあわせるという意図なら重ねた方がよいだろうと考えて社名に角印を重なるようにして作成した。請求書に角印とロゴが入って見栄えもよくなった。</p><h2 id=立ち呑み屋-本番>立ち呑み屋 本番</h2><p><a href=/diary/posts/2023/0819/#立ち呑み屋>先週行った立ち呑み屋</a> さんにコミュニティのメンバーと一緒に行ってきた。ずっと休日も開発してきて疲労困憊ないので気分転換しようという思いつき。</p><p>19時開始でたまたまオフィスを出たときに雷が鳴り始めて、私がお店に付いたすぐ後に豪雨になった。今日はついている。豪雨は1-2時間で止んでいたと思う。その後、さなださんとすみよしさんと合流して飲んでた。わいわい雑談できて楽しかった。いくつか始めて注文してみた料理もおいしかった。このお店の料理は何を頼んでもおいしい気がする。お酒も料理もマスターが1人で運営しているせいか、非常に良心的な価格設定になっている。もう1.5倍ぐらい値上げしたらいいんじゃないかと思う。それでも安い方だけど。立ち呑みだとしんどいので22時前にはお開きになった。長居せずに帰りやすいのも立ち呑みのよいところだと思う。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0825/>msgraph-sdk-go のビルド問題</a></h1><div class=post-meta><span class=post-date>2023-08-25 (Fri.)</span></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/ci/cd/>ci/cd</a>&nbsp;
#<a href=/diary/tags/infrastructure/>infrastructure</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#msgraph-sdk-go-を使った開発>msgraph-sdk-go を使った開発</a></li></ul></nav></div><div class=post-content><p>1時に寝て何度か起きて7時に起きた。昨日は少し早めにお仕事を終えて家で休んでいたので少し回復した。</p><h2 id=msgraph-sdk-go-を使った開発>msgraph-sdk-go を使った開発</h2><p><a href=/diary/posts/2023/0824/#msgraph-sdk-go-を使った開発>昨日の続き</a> 。前日に作ったマージリクエストをチームのメンバーにレビューしてもらっていくつか修正して、マージを終えた。一段落。</p><p>さらにこの sdk を使うことで8月の前半に開発していた差分比較のところも変更しないといけないことに気付いた。public な構造体のメンバーにアクセスして差分比較する処理を実装していたが、この sdk は getter で構造体のメンバーにアクセスしないといけないことに気付いた。reflectoin の処理に追加で実装を入れるだけなのでそんなに難しくはない。そういった修正をしていたら1日終わってしまった。開発していると時間が過ぎるのは早い。</p><p>たまたま ci/cd ジョブの実行時間の上限を10分にしていて超えるときがあってジョブが失敗した。
調べてみると、msgraph-sdk-go の api が巨大過ぎてメモリを浪費したりコンパイルに時間がかかったりするという issue をみつけた。</p><ul><li><a href=https://github.com/microsoftgraph/msgraph-sdk-go/issues/436>Memory Leak when creating msgraph client #436</a></li></ul><p>私のローカル環境で測ってみると、約36秒で完了していたテストが2分23秒かかるようになっていた。テストの実行が4-5倍ぐらい遅くなった。さらにコンテナイメージのサイズは 36 MiB から 109 MiB と3倍ほど増えた。無駄に開発を遅らせる環境要因になっているのでこれは別途調査して対応しないといけないことに気付いた。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0824/>開発の瞬発力が足りない</a></h1><div class=post-meta><span class=post-date>2023-08-24 (Thu.)</span></div><span class=post-tags>#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/project-management/>project management</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#msgraph-sdk-go-を使った開発>msgraph-sdk-go を使った開発</a></li></ul></nav></div><div class=post-content><p>最終の新幹線で帰ってきて、2時に寝て2回ぐらい起きて8時前に起きた。寝坊した。7時頃に起きてない時点で疲れているんやろなと思えた。</p><h2 id=msgraph-sdk-go-を使った開発>msgraph-sdk-go を使った開発</h2><p><a href=/diary/posts/2023/0823/#msgraph-sdk-go-を使った開発>昨日の続き</a> 。ライセンスやグループのメンバーを扱うときの特殊な処理を実装してからマージリクエストを送った。本当は火曜日の時点でできたらよかったことが2日遅れになった。モチベーションがあれば、日曜日や月曜日の夜にできたことかもしれない。加齢のせいかもしれないし、私の中でまだ開発になにかが足りない。誰かから責められるわけではないが、自分で自分に嘘をつかないために自分なら間に合わせられたものが2日遅れになっているという事実にだけは気付いている。id 連携のビジネスロジックに相当するところの置き換えに4日かかったというのはノウハウがなかったらそんなもんという気もせんでもない。一通り実装できたのであとは qa テストで複雑なテストケースのバグ出しをすればよいだろう。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0823/>年度末打ち上げ</a></h1><div class=post-meta><span class=post-date>2023-08-23 (Wed.)</span></div><span class=post-tags>#<a href=/diary/tags/biztrip/>biztrip</a>&nbsp;
#<a href=/diary/tags/go/>go</a>&nbsp;
#<a href=/diary/tags/food/>food</a>&nbsp;
#<a href=/diary/tags/management/>management</a>&nbsp;
#<a href=/diary/tags/team-building/>team building</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#msgraph-sdk-go-を使った開発>msgraph-sdk-go を使った開発</a></li><li><a href=#年度末打ち上げ>年度末打ち上げ</a></li></ul></nav></div><div class=post-content><p>22時に寝て何度か起きて6時に起きた。カプセルホテルに泊まるときにいつも忘れることで、下の方のカプセルにしてもらうのをお願いすべき。おっさんには上のカプセルによじ登るのが辛い。カプセルホテルに泊まるので盗難防止を考慮して着替え以外はもっていなかった。パソコンがないので朝からやることもなくてお風呂入って、休憩スペースでのんびりしていた。</p><h2 id=msgraph-sdk-go-を使った開発>msgraph-sdk-go を使った開発</h2><p><a href=/diary/posts/2023/0821/#最後のリファクタリング課題>azure との id 連携のリファクタリング</a> の続き。</p><p>microsoft 社のシステムの仕様が直感的でなかったり、sdk の api が使いにくかったり、この sdk を使うことの学習コストがやや高い。一方でドキュメントを読めば仕様はちゃんと書いてあるのでドキュメントを読みながら開発していくのがよさそうに思える。当たり前と言えば当たり前だが、ドキュメントを読まないと絶対に分からない仕様が多いという意味で学習コストが高い。</p><p>例えば businessPhones というプロパティはリストで設定するけれど、これは1つしか設定できないという仕様になる。2つ値を設定しようとするとエラーになる。</p><blockquote><p>businessPhones String collection The telephone numbers for the user.<br>NOTE: Although this is a string collection, only one number can be set for this property.<br><a href="https://learn.microsoft.com/en-us/graph/api/user-update?view=graph-rest-1.0&tabs=http#request-body">https://learn.microsoft.com/en-us/graph/api/user-update?view=graph-rest-1.0&tabs=http#request-body</a></p></blockquote><p>だいぶ sdk に慣れてきて、あともうちょっとのところだったが、今晩は予定があるので切り上げとなった。</p><h2 id=年度末打ち上げ>年度末打ち上げ</h2><p>お手伝いしているお客さんが8月が年度末になる。年度末の会社の打ち上げをやるのでよかったらどうぞとお声がけをいただいていた。うちのプロジェクトのスケジュールにあわせると定例を行う週の火・水の2日間だけ参加可能として予定を提出していた。他の社員さんの予定と調整して2週間もあるからそんなあわないだろう？と思っていたらあってしまって出張するしかないかと今回の出張が決まった次第だ。</p><p>17時半から東銀座へ移動して、ホテルの地下にあるちょっとよい雰囲気のレストランでお食事をいただいた。立派な陶磁器に芸術的な料理が添えられていて、おいしかったし、みて楽しむこともできて、会社で来ないと食べられないような内容で私はよかったと思う。食べものはコースだったが、若い人向けにはもっと量がないとお腹が空くだろうから追加でいくつか料理を頼んだりしていた。行ったことないレストランの量はわからないのでコースの選択は難しいと思う。</p><p><figure><img src=/diary/img/2023/0823_food1.jpg></figure><figure><img src=/diary/img/2023/0823_food2.jpg></figure><figure><img src=/diary/img/2023/0823_food3.jpg></figure></p><p>約55%の社員 (+お手伝い) が参加していた。欠席者の半分以上はリモートワークだったり業務都合で参加できなかったのを考慮すると、私用で欠席している社員は少数派にみえる。私用で欠席できるというのも多様性の文脈では大事だと思えるし、それでも7割ぐらいは参加する意志があるというのは組織としてのまとわりを表す指標の1つに思える。</p><p>私自身、昔はあまり会社の全体飲み会が好きではなく、チームや部署単位なら行くが、全社となると欠席する方が多かった。会社の中のよく知らない人たちと親睦を図ることにあまり価値を見出していなかった。しかし、いまマネジメントの立場で考えると、一定の理解はできるようになった。マネジメントとして社員に平等に報いる方法はかなり限定的であること。個別の社員ごとに好ましい方法で対応することはできないという現実がある。したがって、こういった全社的な催しもしかたないと言える。</p><p>そして、こういった場で人と人の結びつきや人間関係を良好に保つように、社員みんなが努力して組織が成り立っているのだとわかるようになってきた。
私は直接部門だから売上を上げてれば文句ないだろうとずっと思ってきたけれど、必ずしもそういった見た目の数字だけが会社を維持させているわけではない。目にみえない価値もたしかに組織にはある。
若い頃の私はその努力に欠けていた、もっというとフリーライドしていたという見方もできることに気付けるようになった。</p><p>その価値をいま風に言えばチームビルディングといったラベルがついている。それをどうやってうまく成し遂げるか、こういう場で見聞きすることの大事さもわかるようになってきた。だから、いまの私は自身にとって重要ではないイベントも後学のために役に立つかもしれないと前向きに参加するようになった。結局のところ、イベントを楽しむのもそうじゃないのも自分次第である。どんなことからも学べる。その学びがあるのならきっと楽しいと言えるかもしれない。<a href=/diary/posts/2023/0707/>社員旅行へ同行しての学び</a> も大いにあった。</p><p>18時から始めて21時前でお開きになった。それから東銀座を出て9時24分の新大阪行きの最終新幹線に乗れた。新大阪に23時48分頃に付いて23時55分発の新快速に乗った。新幹線が2分遅れたことで新快速も2分出発を遅らせて57分発になった。その後、他にも神戸線で事故があった影響か、信号待ちがどうこうで芦屋あたりからずっと低速運行していた。最終的に三ノ宮には到着予定から17分遅れになった。疲れて早く帰りたいなと思っているときほど、こんなもんという印象。考え方を変えれば、いろいろあったのに、ちゃんと三ノ宮まで帰れてよかったと思えばそんなに気も悪くない。</p></div></div><div class=pagination><div class=pagination__buttons><a href=/diary/page/5/ class="button previous"><span class=button__icon>←</span>
<span class=button__text>最近の日記</span></a>
<a href=/diary/page/7/ class="button next"><span class=button__text>過去の日記</span>
<span class=button__icon>→</span></a></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>© 2021 Tetsuya Morimoto</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>