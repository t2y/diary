<!doctype html><html lang=en><head><meta name=generator content="Hugo 0.109.0"><title>forest nook</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/diary/><link rel=stylesheet href=/diary/styles.css><link rel=stylesheet href=/diary/style.css><link rel="shortcut icon" href=/diary/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content="t2y"><meta name=twitter:creator content="t2y"><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="forest nook"><meta property="og:description" content><meta property="og:url" content="/diary/"><meta property="og:site_name" content="forest nook"><meta property="og:image" content="/diary/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><link href=/diary/index.xml rel=alternate type=application/rss+xml title="forest nook"></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/diary><div class=logo>forest nook</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/diary/about>自己紹介</a></li><li><a href=/diary/dates>月別一覧</a></li><li><a href=/diary/tags>タグ一覧</a></li></ul></nav></header><div class=content><div class=posts><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0503/>第4期の法人決算に着手</a></h1><div class=post-meta><span class=post-date>2023-05-03 (Wed.)</span></div><span class=post-tags>#<a href=/diary/tags/founding/>founding</a>&nbsp;
#<a href=/diary/tags/tax/>tax</a>&nbsp;
#<a href=/diary/tags/career/>career</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#法人決算>法人決算</a></li><li><a href=#消費税の申告>消費税の申告</a></li><li><a href=#パワーランチ>パワーランチ</a></li></ul></nav></div><div class=post-content><p>0時に寝て何度か起きて7時に起きてドラクエタクトのランクマッチやってた。</p><h2 id=法人決算>法人決算</h2><p>朝から着手した。過去の日記から <a href=/diary/posts/2022/0505/>第3期の法人決算に着手した</a> のは5月5日だったらしい。この情報だけでも昨年よりは体調がよく、いまの業務に集中できていることが伺える。過去3回分の法人決算のノウハウがあるから私にとって法人決算はなんら難しくない、ただの作業になる。しかし、こういった面倒なだけの事務手続きをいつ取り組めるかというのはモチベーション管理の視点からはとても大きな意味をもつように、年齢を重ねてから思うようになった。というのは本気を出せば数時間で終えるものの、あまり楽しい作業ではないので、他の楽しい開発や調べものに心を奪われがちになる。たった数時間なのだから先に事務手続きをやってから他の楽しいことやればいいやんと頭ではわかっているものの、それができるかどうかがモチベーション管理の難しいところ。連休の初日からそれができるのだから調子がよいのだろうと考えられる。</p><h2 id=消費税の申告>消費税の申告</h2><p>法人決算と消費税の申告は同じタイミングで行うものの、それぞれの申告は独立している。消費税は未払金として決算書には記載する必要があるので普通にやると、法人決算の前に消費税の申告をやるという手順になるはず。昨年は3期目で免税事業者から課税事業者へと移り、初めての消費税申告でやや手間取ったが、今回は2回目なので昨年のノウハウがあって1.5時間もあれば完了した。昨年のメモを見返しながら課題管理システムに手順や要項をメモしながらやっているので実質1時間もあればできる。こうやって作業手順を洗練させていくのが課題管理的なやり方。昨年は消費税の算出と申告と会計処理を2日に分けて別々のタイミングで行っていた。会計システムに振替伝票を登録するやり方なども初めてでよくわからなかった。しかし、今年は全体像も手順もわかっているのでこれらの作業をまとめて完了できた。よい感じ。</p><h2 id=パワーランチ>パワーランチ</h2><p>大学の同級生の友だちが実家に戻ってきた機会にオフィスを案内してお昼ご飯を食べて雑談してきた。本当は昨年末に予定していたが、年末休み前に <a href=/diary/posts/2022/1226/>父の訃報</a> があって先送りしていた。引っ越してから知人がオフィスへ来た機会は初めてかな。お昼ご飯食べてカフェで雑談してなんやらかんやらで3時間ほど話していた。ざっくばらんに近況やキャリアや起業についての話しをしていた。友だちの会社は外資系なのでリストラが敢行されているが、その友だちはビジネスに近い方の業務をやっていて、そういう人たちはリストラされていないらしい。リストラされているのは新しいビジネスの種としてやってたプロジェクトのメンバーでそれはベテラン／新参に関係なくリストラされているそうなので外資の厳しさを伺える。あとはお仕事のパフォーマンスがよくない新参者がリストラされているのはそうらしい。</p><p>50歳のキャリアどうするといった話しをしていて、いまの会社でずっと働くという選択肢もある。一方で40歳を超えると転職はとても選択肢が限られるというのは私の経験からもそうで、おそらく50歳はさらに転職の選択肢が限定されるだろうと推測する。そうなると、起業するという選択肢もあるが、そういった将来のキャリア観をお互いに話していた。私からは誰にでも言っていることだけど、知り合いのスタートアップに転職するよりも自分で会社を作って好き勝手やるのが楽しいよとお奨めしておいた。</p><p><a href=https://tonkatsu-kinton.business.site/>きんとん</a> さんでシャトーブリアン定食 (2,600円) を食べた。ヒレの中心部分の柔らかい部分をシャトーブリアンと呼ぶらしい。とんかつの種類で言えばヒレカツに分類される。前から気になっていたメニューだったので祝日だし接待だしと良縁も重なって食べてきた。岩塩、わさび醤油、とんかつソースという3つのタレを使い分けられるところもよい。値が張るし、おいしかったし、見栄えもよいので接待にもよいメニューだと思う。食べログのとんかつ百名店[2022]の1つ。</p><figure><img src=/diary/img/2023/0503_kinton.jpg></figure><p>これまで私はロースカツ派でヒレカツというのをあまり食べてこなかった。カツ丼も好きだが、通常はロースカツだと思う。東京へ出張したときに <a href=https://tabelog.com/tokyo/A1316/A131603/13025438/>とん金</a> さんで食べたヒレカツがおいしかった。金曜日のランチがヒレカツ定食 (1,200円) になる。肉の暑さと柔らかさではきんとんさんのヒレカツに負けないインパクトがあったように思う。食べログの定食百名店[2021]の1つ。それ以来ヒレカツもおいしいなと思うようになってきた。加齢によって脂身をあまり食べられなくなったのもあるのかもしれない。</p><figure><img src=/diary/img/2023/0503_tonkin.jpg></figure></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0502/>飛び石のお仕事</a></h1><div class=post-meta><span class=post-date>2023-05-02 (Tue.)</span></div><span class=post-tags>#<a href=/diary/tags/docker/>docker</a>&nbsp;
#<a href=/diary/tags/infrastructure/>infrastructure</a>&nbsp;
#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/career/>career</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#docker-エコシステムの調査>docker エコシステムの調査</a></li><li><a href=#しくじり先生>しくじり先生</a></li></ul></nav></div><div class=post-content><p>0時に寝て何度か起きて7時に起きた。休んでもよかったんだけど、休む理由がないので飛び石でお仕事することにした。</p><h2 id=docker-エコシステムの調査>docker エコシステムの調査</h2><p>少し前に <a href=/diary/posts/2023/0327/>docker をライブラリとして使って運用ツールを作った</a> 。その内容をテックブログに書こうと思って docker のソフトウェアスタックやアーキテクチャの背景を調べ直していた。もっとたくさんいろんな記事を読んだのだけど、次の記事とそこから辿れるものを読むとよいだろうと思う。</p><ul><li><a href=https://blog.inductor.me/entry/2019/11/22/072353>Docker社がエンタープライズ事業を譲渡した今、Dockerの父が思うこと</a></li><li><a href=https://www.tutorialworks.com/difference-docker-containerd-runc-crio-oci/>The differences between Docker, containerd, CRI-O and runc</a><ul><li><a href=https://thenewstack.io/oci-building-way-kubernetes-run-containers-without-docker/>Red Hat, Google Engineers Work on a Way for Kubernetes to Run Containers Without Docker</a></li></ul></li></ul><p>コンテナに関して cri と oci という2つの標準化があることを学び、その実装として docker 社が使っているツールに関係があるのが次の3つになる。おもしろいことにすべて docker 社のリポジトリにはなく、oss として然るべき所管の organization にリポジトリがある。</p><ul><li><a href=https://github.com/moby/moby>https://github.com/moby/moby</a></li><li><a href=https://github.com/opencontainers/runc>https://github.com/opencontainers/runc</a></li><li><a href=https://github.com/containerd/containerd>https://github.com/containerd/containerd</a></li></ul><p>すべて docker 社がオリジナルを作って、いまも moby は docker 社が主体となって開発を継続しているだろうけれど、コンテナの実行環境のプラットフォームは k8s に取って変わられ、cri のコンテナランタイムとしての containerd があれば moby は docker daemon や docker engine のためのツールでしかなくなっている。当初 docker と moby を分割したのは、docker を開発ツール、moby を infrastructure にするという判断の下、moby を k8s のようなプラットフォームにしたかったはずである。しかし、結果的にその標準化競争に破れ containerd があれば dockerd daemon は不要になったとも解釈できる。docker という名前はコンテナのエコシステムにおいて docker 社が提供するコマンドラインやプロダクトの総称としての名前でしかなくなってしまっていて、一世を風靡した docker というパッケージングシステムの開発元に同情してしまう感もある。いまの docker engine は docker daemon と containerd の2つの daemon を起動していて docker 社としては微妙なアーキテクチャになっているのではないかと推測する。とくに swarm なんか最早削除したいだろう。</p><p>こういった docker を取り巻くエコシステムやツールの背景を説明するだけでも1つの記事になりそうなことが1日調べていてわかった。</p><h2 id=しくじり先生>しくじり先生</h2><p>たまたま <a href=https://www.tv-asahi.co.jp/shikujiri/backnumber2/0099/>竹原慎二先生「５０歳過ぎてもケンカを売られ続けてバリしんどい先生」</a> をみたらおもしろかった。ガチンコをリアルタイムでみていた世代なので竹原氏には好感をもっている。少し前に <a href=https://www.nhk.or.jp/kenko/atc_731.html>【あの人の健康法】元プロボクサー・竹原慎二の膀胱（ぼうこう）がんとの闘い</a> のような、闘病生活の記事もみかけていた。病気は克服してがんばっているといるようにみえる。よかった。もう51歳なのか。</p><p>この番組の中で若い頃に上京してボクシングジムへ通ったときに根性の定義が変わったという話しが出てくる。</p><blockquote><p>殴られても耐えることを根性だと思っていた。そのときに初めて殴られようが何しようが毎日辛い練習を重ねるのが根性だと気付かされた。</p></blockquote><p>地元で最強だったのが、ボクシングジムのヤンキーでもない先輩にまったく太刀打ちできなかったという。そのとき1番違うのはスタミナだったらしく、竹原氏は1分で息がきれるのに相手は軽く流すといった様相だった。この先輩にボコボコにされた経験を経てそれから心を改めて真面目になったと言う。その後ボクシングと真剣に向き合い、1995年に日本人初のミドル級世界チャンピオンになる。おそらく番組の主旨的に若ものへのメッセージとして「強さ」について話されていた。</p><blockquote><p>「ケンカに強い」だけが「強さ」じゃない、「強さ」の意味を履き違えずに生きよう。大人になると、いろんな強さを知る。大切な人のために仕事をどれだけ頑張れるか、辛い状況でもじっと耐えることができるか。そういう強さもある。</p></blockquote><p>私は誰かのために仕事をがんばったことないし、辛い状況を耐えるみたいなこともほぼやってなくて、嫌になったら仕事を辞めてて、こういう言葉にあうと自分を恥じてしまう。その後、喧嘩自慢で youtube 動画を検索していたらまさにそういうのがあった。竹原氏が「勝てるはずねぇだろ、お前らこんな茶番なことすんなよ」とぼやいていた。先の番組の中でも触れていたが、本当に真剣勝負したいと思って来ているのではなく、記念に戦ってみたいという不純な動機でやってくる人が多いらしい。たしかにそれは相手するのがしんどそう。</p><div class=video-container><iframe src=https://www.youtube.com/embed/O2rjpxf9W7U allowfullscreen title=懲りない喧嘩自慢に終止符を打ってみた></iframe></div></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0501/>対外的なお仕事をお休みしてドライブ</a></h1><div class=post-meta><span class=post-date>2023-05-01 (Mon.)</span></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/tax/>tax</a>&nbsp;</span>
<img src=/diary/img/2023/0501_anago-don.jpg class=post-cover alt=対外的なお仕事をお休みしてドライブ><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#明石までドライブ>明石までドライブ</a></li><li><a href=#弁護士さんと相続打ち合わせ>弁護士さんと相続打ち合わせ</a></li><li><a href=#自動車税の支払い>自動車税の支払い</a></li></ul></nav></div><div class=post-content><p>3時に寝て7時に起きた。翌日がお休みだと思うとはしゃいでうまく眠れなかった。午前中と夕方にオフィスへ行って作業していたので今日は day off じゃないけど、お出掛けする私用もあったのでお手伝い先のお仕事はお休みした。</p><h2 id=明石までドライブ>明石までドライブ</h2><p>11時半から車で明石市にある弁護士さんの事務所まで行ってきた。高速道路をわーっと走って明石市へ。ついでに明石市周辺も軽くドライブして浜辺なども走ってきた。毎週のように天気がよかったら車に乗ろうと思うものの、立体駐車場から車を出すのが面倒なのでなにか目的がないとなかなか乗る機会にならない。電車で明石へ行ってもほとんど時間は変わらないものの、ちょうどよい車を動かす機会だったのでドライブしてきた。昼間は天候もよくて気持ちよかった。戻ってきてから急に天気が崩れてちょうど雨が振り始める前のよい時間帯に走れた。たまにしか乗らないからかドライブするのもなかなか楽しい。お昼に焼き穴子丼定食を食べた。地元の食べものって感じで心地よかった。</p><h2 id=弁護士さんと相続打ち合わせ>弁護士さんと相続打ち合わせ</h2><p>3-4月と私がいっぱいいっぱいで忙しいから相続の打ち合わせを遅らせてもらっていた。相続税を10カ月以内に支払わないと追徴課税になる。弁護士さんから直接会って話したいということで明石の事務所まで行ってきた。私との会話の雰囲気から温度感をみたかったと弁護士さんは話されていた。</p><p>母・姉・私の3人で法定相続を行う。表現はよくないが、うちの家族は相続なんかどうでもよくて誰も関心をもっていない。一方で弁護士さんは利害関係の調整人になるので細かい数字の詳細確認やところどころで経費がかかることへの承諾を求めてくる。税理士さん、司法書士さん、弁護士さんと士業揃い踏みで相続の書類を作ってもらっている。田舎なので相続する建てものが登記されていませんとか普通に起きる。3月の時点で私が大きな方針だけ伝えて詳細はすべて専門家に委譲して経費も然るべきものはすべて言い値でよいから勝手に進めてみたいな指示を出していた。弁護士さんからしたら本当にそんな投げやりでいいのか？みたいな最終確認に face to face で打ち合わせしたかったんだと思う。私がメールのやり取りでそっけない対応をし過ぎたのかもしれない。</p><p>例えば、不動産の価値を評価するにも3つの価格がある。</p><ul><li>固定資産税評価額<ul><li>自治体が決める</li><li>弁護士はこの金額を使いたい</li></ul></li><li><a href=https://www.rosenka.nta.go.jp/>路線価</a><ul><li>国税庁が決める</li><li>税理士はこの金額を使いたい</li></ul></li><li>不動産屋さんの評価額<ul><li>市場が決める</li></ul></li></ul><p>不動産を評価するときに弁護士と税理士で扱う価格が異なると金額も変わってきてそれぞれの金額を、、、と話そうとするところで、私は複数の金額を調整とかしなくてよいので、シンプルでわかりやすい形でどれか1つの価格で評価してもらったらそれでよいですと突っ込む。母も姉も私も金額を計算し直すとかやらないし、それによる多少の損得があってもそんなのどうでもよいと弁護士さんへ伝える。家によっては、お墓や法事にかかる費用を誰が出すかで、相続とは別にその費用を相続のタイミングで多めにもらっておくといった手続きをすることもあるという。なるほど。うちは母がすべて出している。母が支払うので問題ないし、わざわざそんなことを文書で残さなくても大丈夫ですみたいなやり取りが必要になる。いまから書類を作って相続人にハンコを押してもらって手続きをを終えるのが9月頃の見込み。期限は10月中なのでいまからやってちょうどよい時期らしい。相続の手続きは大変。</p><h2 id=自動車税の支払い>自動車税の支払い</h2><p>4月1日に自動車をもっていると5月末までに自動車税を納めないといけない。自動車税は県に対して支払う。社用車の初めての自動車税なので毎年の手続きを忘れないための社内手続きをしていた。言うても google カレンダーと jira に issue 登録するだけなんやけど。送られてきた納付書から pay-easy で即時支払い手続きをした。自動車税の勘定科目は租税公課か車両費のどちらかで会計システムに登録すればよいらしい。うちは租税公課で自動車税という品目を割り当てて会計処理している。また1つ税金について学びを得た。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0430/>輸入した機器の会計処理</a></h1><div class=post-meta><span class=post-date>2023-04-30 (Sun.)</span></div><span class=post-tags>#<a href=/diary/tags/founding/>founding</a>&nbsp;
#<a href=/diary/tags/accounting/>accounting</a>&nbsp;
#<a href=/diary/tags/tax/>tax</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#海外から輸入したときの会計処理と税金>海外から輸入したときの会計処理と税金</a></li></ul></nav></div><div class=post-content><p>昨日は夕方から天気が崩れるという話しを聞いて夕方から家に戻ってゆっくり過ごしていた。ドラクエタクトやったりアニメの Dr.ストーンを見返したりしていた。</p><h2 id=海外から輸入したときの会計処理と税金>海外から輸入したときの会計処理と税金</h2><p>昨日に引き続き、yubikey bio の設定や検証を一通りやって issue や記事にまとめていた。それが終わった後に会計処理についても調べていた。yubico 社の日本代理店はあるものの、指紋認証ができる yubikey bio の在庫を取り扱っていなかった。そのため、直接 yubico のオンラインストアで購入して日本へ発送した。インターネットで買いものをしているとあまり実感がないけれど、この場合は輸入手続きをして税関で関税を支払わないといけない。一方で用途が個人使用か商用利用かで関税がかかる基準額が変わってくる。これまでも個人使用で輸入して関税を支払ったことがなかったのは1.6万円以下のものは関税がかからないからだったんだと理解した。技術書ぐらいしか買ったことないけど。</p><ul><li><a href=https://www.customs.go.jp/tsukan/kanizeiritsu.htm>少額輸入貨物の簡易税率</a></li><li><a href=https://www.customs.go.jp/tetsuzuki/c-answer/imtsukan/1006_jr.htm>1006 課税価格の合計額が１万円以下の物品の免税適用について（カスタムスアンサー）</a></li></ul><p>1万円以下の輸入については関税がかからない、且つ個人使用のものは商品代金の0.6掛けで金額を算出するという2つの法律の合わせ技で1.6万円みたいな中途半端な金額が基準になるらしい。当初は商用利用というのは自社ビジネスや転売のようなものを指すのかと考えいた。yubikey bio はうちの会社内で主に調査目的で使う。会社の経費で購入しているが、これは個人使用の範疇かと勘違いしていた。調べているとそれは誤りで <a href=https://hunade.com/yunyu-kojin-senbiki>【輸入】個人使用と商用の線引き 法人輸入との違いは？</a> によると、業務やオフィスで使うことを前提にしているものは商用利用となるらしい。商用利用の場合は0.6掛けで金額を算定できない。yubikey bio は1万円ちょっと超えているので関税を支払わないといけない。</p><p>オンラインストアでの決済時に yubico 社は関税や輸送費を徴収しないと書いてあって本体価格しか支払っていない。調べていると、郵便局または輸送業者が関税を立替ているので商品を受け取るときに支払うという記事が出てくる。しかし、うちの郵便受けに商品がレターボックスで届いていたので私は関税と輸送費をまだ支払っていない。あれー？と思ってなにか手続きを誤ったのかどうかを調べ直したりしていた。おそらく輸送業者からまた後日、関税と消費税と輸送費の支払いに関する請求書が送られてくるはず。まだ届いていないだけなんだと推測する。もう少し待ってみる。</p><ul><li><a href=https://www.customs.go.jp/tsukan/kojinyunyu.htm>個人輸入通関手続</a></li></ul><p>輸入したときの会計処理も通常の取引登録とはまったく異なっていてまた1つ税金の勉強になるなと分かって楽しみにしている。また後日、輸送業者から請求書が届いたときに輸入したときの税金を精査してみる。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0429/>yubikey bio を触ってみた</a></h1><div class=post-meta><span class=post-date>2023-04-29 (Sat.)</span></div><span class=post-tags>#<a href=/diary/tags/life/>life</a>&nbsp;
#<a href=/diary/tags/device/>device</a>&nbsp;
#<a href=/diary/tags/pam/>pam</a>&nbsp;
#<a href=/diary/tags/auth/>auth</a>&nbsp;
#<a href=/diary/tags/security/>security</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#ストレッチ>ストレッチ</a></li><li><a href=#yubikey-bio-を触ってみた>yubikey bio を触ってみた</a></li></ul></nav></div><div class=post-content><p>3時半に寝て7時に起きた。リリース終えたので晩ご飯を食べてから自分の会社のお仕事をしていたら遅くなった。</p><h2 id=ストレッチ>ストレッチ</h2><p>今週もリリース明けでそれほど座っている時間が長かったわけでもないため、腰の張りはあまりなく、負荷は低くなっているのではないかと推測する。今日の開脚幅は開始前156cmで、ストレッチ後158cmだった。右股関節周りの硬さは相変わらず大きく変化はないが、他がよくなった分、右ふともも前の筋を伸ばすと張りがきつくてしんどいように感じた。しばらく余裕のある生活ができるので歩いたりストレッチしたりする余裕が出てくるかもしれない。</p><h2 id=yubikey-bio-を触ってみた>yubikey bio を触ってみた</h2><p>先日 <a href=/diary/posts/2023/0416/#yubikey-bio-の購入>yubikey bio をオンラインストアで購入</a> した。会社の経費で業務で使うことを目的に購入したのでこの場合は商用利用の輸入にあたる。また別途、輸入についての会計処理を書く。yubico はスウェーデンの会社でどうやら日本向けはスウェーデンの首都ストックホルムから発送されてきたらしい。安いエコノミープランで注文していた。発送メールを受け取ったのが 4/17 でオフィスの郵便受けに入っていることに気付いたのが 4/29 になる。12日で届いたことになる。船便にしては早いからなにかしら航空便の安いプランで届いたのだと推測する。</p><blockquote><p>Economy - 10-20 Working Days - No tracking available</p></blockquote><p>早速、接続していろいろ触ってみた。結論から言って ubuntu 22.04 で fido2 pin を設定して u2f を使って2要素認証のメソッドとして pam や web アプリケーションから問題なく使えた。ubuntu 向けのアプリケーションも ppa のリポジトリを追加して apt からインストールできる。</p><ul><li><a href=https://support.yubico.com/hc/en-us/articles/360016649039-Installing-Yubico-Software-on-Linux>Installing Yubico Software on Linux</a></li></ul><p>このドキュメントには次の4つのアプリケーションのインストールが書いてある。</p><ul><li>YubiKey Manager (CLI): <code>sudo apt install yubikey-manager</code></li><li>YubiKey Personalization Tool: <code>sudo apt install yubikey-personalization-gui</code></li><li>libpam-yubico: <code>sudo apt install libpam-yubico</code></li><li>libpam-u2f: <code>sudo apt install libpam-u2f</code></li></ul><p>yubikey は他にもいろいろな認証の用途に使えるらしい。今回は fido2 の設定のみを紹介する。fido2 pin を登録するには YubiKey Manager の GUI を使った方が簡単なので次のアプリケーションも一緒にインストールするとよい。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sudo apt install -y yubikey-manager-qt
</span></span><span style=display:flex><span>$ ykman-gui
</span></span></code></pre></div><p>おそらく ykman の cli でも登録できると思うけど、yubikey や認証設定に慣れていない初心者は gui のナビゲーションに従って作業して結果を確認した方が安心だと思う。fido2 pin は ssh でいうところのパスフレーズのようなものなのかな？デバイスが盗まれるのを防ぐために pin があるという。一方で web アプリケーションが fido2 で認証するときに pin を要求するかどうかは任意になるらしい。よくあるパターンは初めて使うときは pin を要求して2回目以降はスキップするといった用途が多いのではないかと推測する。</p><figure><img src=/diary/img/2023/0429_ykman-gui1.png></figure><p>この fido2 pin を使って <a href=https://en.wikipedia.org/wiki/Universal_2nd_Factor>Universal 2nd Factor (u2f)</a> の設定を行う。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ mkdir -p ~/.config/Yubico
</span></span><span style=display:flex><span>$ pamu2fcfg &gt; ~/.config/Yubico/u2f_keys
</span></span><span style=display:flex><span>Enter PIN <span style=color:#66d9ef>for</span> /dev/hidraw3: ***  &lt;<span style=color:#f92672>=</span> このときに yubikey manager で設定した fido2 pin を入力
</span></span></code></pre></div><p>この後 yubikey デバイスが点滅するので丸いセンサー部分を指でタッチすると完了する。このときに指紋登録しているのか、物理的にタッチすることを要求しているだけなのか、よくわかっていない。この前に <a href=https://www.yubico.com/setup/yubikey-bio-series/>chrome で指紋登録</a> をしていたのでそれが使われているのかもしれない。いま ykman で設定をみたら <code>Fingerprints registered</code> とあるのでどこかしらに指紋登録されているらしい。おそらく chrome じゃないかと推測する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ykman fido info
</span></span><span style=display:flex><span>WARNING: PC/SC not available. Smart card <span style=color:#f92672>(</span>CCID<span style=color:#f92672>)</span> protocols will not <span style=color:#66d9ef>function</span>.
</span></span><span style=display:flex><span>PIN is set, with <span style=color:#ae81ff>8</span> attempt<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span> remaining.
</span></span><span style=display:flex><span>Fingerprints registered, with <span style=color:#ae81ff>3</span> attempt<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span> remaining.
</span></span><span style=display:flex><span>Always Require User Verification is turned on.
</span></span></code></pre></div><p>linux で認証時に u2f を使いたいときは <code>pam_u2f.so</code> を使って pam の設定をするとよい。ubuntu だと <code>/etc/pam.d/</code> 配下にいろんな認証設定がある。例えば login 時に2要素認証をしたい場合は次のようにフックする。パスワード入力した後に yubikey のセンサーを物理的にタッチして指紋認証を行える。セキュリティに厳しい会社はこういった運用をしているのかもしれない。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sudo vi /etc/pam.d/login
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span><span style=color:#75715e># Standard Un*x authentication.</span>
</span></span><span style=display:flex><span>@include common-auth
</span></span><span style=display:flex><span>auth       required    pam_u2f.so
</span></span></code></pre></div><p>パスワード認証の代替として使いたい場合は通常の認証の前に <code>sufficient</code> として呼び出せば指紋認証が成功したときにそれ以降の処理がスキップされる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>auth       sufficient    pam_u2f.so
</span></span><span style=display:flex><span>@include common-auth
</span></span></code></pre></div><p>これらの設定を確認にするには <a href=https://pamtester.sourceforge.net/>pamtester</a> というツールを使うと簡単にできる。認証の設定を誤るとログインできなくなってしまうので慎重にテストして振る舞いを確認した上で実際の運用を行うとよい。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pamtester login t2y authenticate  &lt;<span style=color:#f92672>=</span> このときに yubikey デバイスが点滅するので指紋認証する
</span></span><span style=display:flex><span>pamtester: successfully authenticated
</span></span></code></pre></div><p>せっかく購入したので 1password アカウントや github の2要素認証に設定してみた。ワンタイムパスワードの otp の代替として使える。ワンタイムパスワードを入力するより yubikey のセンサーをタッチする方が日々の運用としては少しお手軽と言える。設定していて otp と yubikey でお互いに2要素認証のバックアップを兼ねることに気付いた。認証方法が増えるのでセキュリティ的には脆弱になるけれど、サービスとセキュリティのトレードオフの考え方から、yubikey の分だけ脆弱になっても物理的なセキュリティを担保できるのであれば利便性を考慮してよいように私には思えた。</p></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0428/>第4期のふりかえり</a></h1><div class=post-meta><span class=post-date>2023-04-28 (Fri.)</span></div><span class=post-tags>#<a href=/diary/tags/founding/>founding</a>&nbsp;
#<a href=/diary/tags/postmortem/>postmortem</a>&nbsp;
#<a href=/diary/tags/workcation/>workcation</a>&nbsp;
#<a href=/diary/tags/camp/>camp</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#隔週の雑談>隔週の雑談</a></li><li><a href=#開発合宿の計画づくり>開発合宿の計画づくり</a></li></ul></nav></div><div class=post-content><p>今週は19時に帰ってきてそれから晩ご飯を食べて家でくつろぐという生活に戻ってきた。生活に余裕をもてるようになってきた。</p><h2 id=隔週の雑談>隔週の雑談</h2><p>顧問のはらさんと隔週の打ち合わせ。先週はリリース前の余裕の無さからお休みしたので1ヶ月ぶり。今日の議題はこれら。</p><ul><li>第4期のふりかえり</li><li>デザイナーさん向けの発注や契約の話し</li></ul><p>先週末にふりかえり資料の叩き台を作って洗練させた資料を説明していたら1時間ほどかかった。もう3年会社を経営したので財務や経営についてわかったことがたくさんある。会社の貯金もある程度貯まって財務が安定してきた。無知の無知が怖かったので創業以来、財務に注意を払ってきた。しかし、これから業務がプロダクト開発へ移行していくに当たって財務のことを気にかける必要はないと私は考えている。そんな油断をしていると足元をすくわれるのかもしれないが。</p><p>業務委託の契約の話をしていて、請負契約と準委任契約の違いについて話題になった。うちは創業以来、準委任契約でしか働いてきていない。ipa が公開している <a href=https://www.ipa.go.jp/digital/model/agile20200331.html>情報システム・モデル取引・契約書（アジャイル開発版）</a> でもアジャイル開発は準委任契約を推奨している。私も開発プロジェクトに入って柔軟に開発するスタイルを好むことから相性がよかった。うちの会社は準委任契約のメリットを十分に理解できている。</p><p>準委任契約のメリット</p><ul><li>成果物の取り決めがないので納期へのストレスや開発遅れに対するリスクが小さい</li><li>がんばって働けば人月単価の金額が毎月売上としてあがる</li></ul><p>準委任契約のデメリット</p><ul><li>普通のサラリーマンと働き方がほぼ変わらない</li></ul><p>はらさんと話していてとして請負契約の特徴として次のようなことが上がった。</p><p>請負契約のメリット</p><ul><li>請負契約の方が儲かる可能性がある</li><li>自分たちが実際に作業しなくても協力会社に発注できる</li></ul><p>請負契約のデメリット</p><ul><li>成果物ができないと売上が上がらず利益率が悪化したり、赤字になるリスクがある</li><li>納品しないと売上が立たないので資金繰りが難しい</li></ul><p>私の基本的な姿勢として協力会社に開発の業務を発注したくない。とくに品質レベルを知らない協力会社に発注することは100%ない。それは私が sier 出身なので他社へ開発を発注するときの難しさや管理のしんどさをよく知っているからだ。私が sier を辞めた理由の1つに自分がミスしたわけでもないのにお客さんに謝り続けるのが嫌になった。開発を他社へ依頼するとそこで発生した不具合やトラブルのすべての責任をもたないといけない。自分がミスして迷惑をかけて謝るのはなにも苦にならないが、他人がミスしたものを自分の責任として謝るのが当たり前の生活をやっていると、私の方がもっとうまくやれんじゃないかと考えてしまったりした。1人だと開発はスケールしないが、他人が品質の低いもの作ってしまうのと比べて開発の満足感が違う。</p><p>いずれにしても請負契約は双方に体力がないと資金繰りが厳しくなってお互いにリスクがある。</p><p>また資金調達の手段としてのクラウドファンディングは複数の側面があっていいんじゃないかという話題も少し盛り上がった。少し前に私もいとうさんのプロジェクトの応援のために支援した。800,000円という目標金額に対して残念ながら665,540円と未達ではあったものの、76人もの支援者がいることがわかる。私がクラウドファンディングのプロジェクトを作ってもおそらく支援者はよくて数人といったところだろう。いとうさんのメディア力であったり信用のすごさがわかる。クラウドファンディングやってますというのが支援することに関心がなくてもシェアするだけで開始前からマーケティングメッセージになる。そんなプロジェクトがあるんだというのを知ってもらうだけでも大きなことだと思う。</p><ul><li><a href=https://camp-fire.jp/projects/view/650475>全国のコワーキングをネットワーク化しイベント情報の共有と収益の分配を実現したい！</a></li></ul><h2 id=開発合宿の計画づくり>開発合宿の計画づくり</h2><p>昨年度に <a href=/diary/tags/workcation/>workcation</a> と称して行ってきたイベントを今年度も行う。いとうさんから2泊3日のようなちゃっちいイベントをワーケーションと呼んだりしないと教えてもらったので今年は開発合宿と呼ぶことにする。タグも新規に <a href=/diary/tags/camp/>camp</a> に付け替える。前回は6月という閑散期に行って空いててよかったのだけど、今年は最も賑わうという冬の繁忙期に行ってみたい。夏と冬だと情緒も変わるはずなので私にとってどちらがよいかも判断してみたい。身近な人たちから声をかけて、昨年は4人だったが、最大13名泊まれるそうなのでもう2-3人ほど増えてもいいんじゃないかと思ったりしている。まずは日程調整からしていかないといけない。</p><ul><li><a href=https://kinosaki-spa.gr.jp/do/13871/>冬の城崎温泉へようこそ！</a></li></ul></div></div><div class="post on-list"><h1 class=post-title><a href=/diary/posts/2023/0427/>docker image のマルチプラットフォーム対応</a></h1><div class=post-meta><span class=post-date>2023-04-27 (Thu.)</span></div><span class=post-tags>#<a href=/diary/tags/docker/>docker</a>&nbsp;
#<a href=/diary/tags/ci/cd/>ci/cd</a>&nbsp;</span><div class=table-of-contents><h2>目次</h2><nav id=TableOfContents><ul><li><a href=#docker-image-のマルチプラットフォーム対応>docker image のマルチプラットフォーム対応</a></li></ul></nav></div><div class=post-content><p>22時に寝て0時に起きてやや吐き気で苦しんで4時に起きて7時に起きた。夜遅くに食べてないのに調子悪かった。</p><h2 id=docker-image-のマルチプラットフォーム対応>docker image のマルチプラットフォーム対応</h2><p>やぎさんが <a href=https://blog.ayakumo.net/entry/2023/04/21/004712>docker buildx でマルチプラットフォームのイメージを作成する</a> の記事を書いてて <a href=https://github.com/docker/buildx>buildx</a> プラグインがあることを知った。ちょうどいまお仕事でコンテナベースのプロダクトを開発している。まずはオンプレミス向けが対象なので amd64 でビルドしていた。今後はクラウド向けにも提供していくので arm64 ビルドもいずれ追加しないといけないと考えていた。ちょうどリリースを終えて調査時間の余裕があるのでこの機会に buildx について調べてみることにした。</p><p><a href=https://docs.docker.com/engine/release-notes/23.0/>Docker Engine 23.0 release notes</a> をみると次のように書いてある。</p><blockquote><ul><li>Set Buildx and BuildKit as the default builder on Linux. moby/moby#43992<ul><li>Alias docker build to docker buildx build. docker/cli#3314</li><li>The legacy builder can still be used by explicitly setting DOCKER_BUILDKIT=0.</li><li>There are differences in how BuildKit and the legacy builder handle multi-stage builds. For more information, see Multi-stage builds.</li></ul></li></ul></blockquote><p>23 からデフォルトのビルダーとして buildx が使われるようになっているらしい。<a href=https://github.com/docker/buildx#building-multi-platform-images>Building multi-platform images</a> を一通り読んで試してみた。</p><p>buildx ではカスタムビルダーを定義して複数プラットフォーム向けの docker image を一緒にビルドできる。このとき個々のビルド環境を <em>builder instance</em> と呼び、ビルド環境を抽象した概念として扱われている。マルチプラットフォーム対応の文脈で言えば amd64 や arm64 のビルド環境をそれぞれに作る。例えば amd64 のマシン上で arm64 のビルド環境を作るときは <a href=https://www.qemu.org/>qemu</a> を使ってエミュレーションしたビルド環境を用意したりもできる。builder instance はカスタムビルダーで制御する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ docker buildx create --name mybuilder --platform linux/amd64,linux/arm64
</span></span><span style=display:flex><span>$ docker buildx ls
</span></span><span style=display:flex><span>NAME/NODE    DRIVER/ENDPOINT             STATUS   BUILDKIT PLATFORMS
</span></span><span style=display:flex><span>mybuilder    docker-container
</span></span><span style=display:flex><span>  mybuilder0 unix:///var/run/docker.sock inactive          linux/amd64*, linux/arm64*
</span></span></code></pre></div><p>ここで作ったカスタムビルダーの driver は、デフォルトビルダーの <code>docker</code> ではなく、<code>docker-container</code> になる。おそらく builder instance の実体であるビルド環境がコンテナ上に構築されるのだと思う。これらの builder instance を使ってビルドされる。カスタムビルダーをデフォルトで使うには次のように実行する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ docker buildx use mybuilder
</span></span></code></pre></div><p>このカスタムビルダーを使って docker image をビルドする。カスタムビルダー側にプラットフォームの設定をもっているので <code>--platform</code> は指定しなくてもよいけど、明示した方がわかりやすいだろう。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ docker buildx build --platform linux/amd64,linux/arm64 -t myimage:latest .
</span></span></code></pre></div><p>ビルドの処理は進んでいたが、正常終了しなかったので途中でやめた。なにか設定の漏れがあるかもしれないが、だいたいの雰囲気はつかめた。</p><p>ここでいま gitlab ci/cd 環境では <a href=https://github.com/GoogleContainerTools/kaniko>kaniko</a> というツールを使って docker image をビルドしている。そもそも kaniko と buildx の違いもわからなくなって README を読み返すと次のようなことが書いてあった。</p><blockquote><p>kaniko は Docker デーモンに依存せず、Dockerfile 内の各コマンドを完全にユーザースペースで実行します。これにより、標準的な Kubernetes クラスタのように、Docker デーモンを簡単かつ安全に実行できない環境でもコンテナイメージを構築することができます。</p></blockquote><p>ローカルで検証しているとしばしば忘れてしまうが、docker cli を使うには docker daemon を起動しておかないといけない。ci/cd におけるビルド環境がそもそも dokcer で動いていたりすると docker daemon を使えるかどうか (dind: docker in docker) はセキュリティ上の大きな違いになってくる。ci/cd 環境によっては docker daemon が使えないという状況はありえる。そういった環境でも docker image をビルドできるのが kaniko のメリットと言える。</p><p>kaniko はマルチプラットフォーム対応なビルドができるのかどうか？issue でもそういった質問がいくつかみつかる。</p><ul><li><a href=https://github.com/GoogleContainerTools/kaniko/issues/786>how to build multi-arch image using kaniko #786</a></li><li><a href=https://github.com/GoogleContainerTools/kaniko/issues/1746>Multi architecture build with only Kaniko #1746</a></li></ul><p>結論から言うと、kaniko そのものはマルチプラットフォーム対応のビルド機能をもっていない。アーキテクチャごとのビルド環境があればそれぞれビルドするだけになる。しかし、マルチプラットフォーム対応の docker image というのは <a href=https://docs.docker.com/engine/reference/commandline/manifest/>manifest list</a> というのを作ってコンテナレジストリに push すればよいという仕組みらしい。この manifest を作るためのツールとして <a href=https://github.com/estesp/manifest-tool>manifest-tool</a> というのがある。このツールと組み合わせれば、kaniko でもマルチプラットフォーム対応の docker image をコンテナレジストリに登録できる。実際に試したわけではないので想像で書くが次のような手順だと推測する。</p><ol><li>kaniko でそれぞれのプラットフォームの docker image をビルドする<ol><li>amd64 向けにビルドする => latest-amd64</li><li>arm64 向けにビルドする => latest-arm64</li></ol></li><li>ビルドされた複数プラットフォームの docker image に対して manifest-tool でコンテナレジストリに push する<ol><li><code>latest-</code> prefix のタグをもつ docker image の manifest list を作る</li><li>manifest list を使ってコンテナレジストリへ push する</li></ol></li></ol><p>ci/cd 環境でこういった手順のパイプライン処理やジョブを定義して実行すれば kaniko でもマルチプラットフォーム対応な docker image を push できると思う。</p></div></div><div class=pagination><div class=pagination__buttons><a href=/diary/page/5/ class="button previous"><span class=button__icon>←</span>
<span class=button__text>最近の日記</span></a>
<a href=/diary/page/7/ class="button next"><span class=button__text>過去の日記</span>
<span class=button__icon>→</span></a></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>© 2021 Tetsuya Morimoto</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script type=text/javascript src=/diary/bundle.min.js></script></div></body></html>